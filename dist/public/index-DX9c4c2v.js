import{c as Vt,b as ms}from"./index-D11QYvEb.js";import"./vue-ByDctM7J.js";import"./bootstrap-Bqj8QN9l.js";var Mi={};var xi;function Gs(){if(xi)return Mi;xi=1;var p;return(function(e){(function(t){var n=typeof globalThis=="object"?globalThis:typeof Vt=="object"?Vt:typeof self=="object"?self:typeof this=="object"?this:o(),i=r(e);typeof n.Reflect<"u"&&(i=r(n.Reflect,i)),t(i,n),typeof n.Reflect>"u"&&(n.Reflect=e);function r(c,u){return function(l,h){Object.defineProperty(c,l,{configurable:!0,writable:!0,value:h}),u&&u(l,h)}}function s(){try{return Function("return this;")()}catch{}}function a(){try{return(0,eval)("(function() { return this; })()")}catch{}}function o(){return s()||a()}})(function(t,n){var i=Object.prototype.hasOwnProperty,r=typeof Symbol=="function",s=r&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",a=r&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",o=typeof Object.create=="function",c={__proto__:[]}instanceof Array,u=!o&&!c,l={create:o?function(){return x(Object.create(null))}:c?function(){return x({__proto__:null})}:function(){return x({})},has:u?function(T,A){return i.call(T,A)}:function(T,A){return A in T},get:u?function(T,A){return i.call(T,A)?T[A]:void 0}:function(T,A){return T[A]}},h=Object.getPrototypeOf(Function),m=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:d(),y=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:f(),g=typeof WeakMap=="function"?WeakMap:w(),b=r?Symbol.for("@reflect-metadata:registry"):void 0,R=rt(),P=st(R);function M(T,A,O,j){if(H(O)){if(!me(T))throw new TypeError;if(!Re(A))throw new TypeError;return L(T,A)}else{if(!me(T))throw new TypeError;if(!ye(A))throw new TypeError;if(!ye(j)&&!H(j)&&!we(j))throw new TypeError;return we(j)&&(j=void 0),O=he(O),D(T,A,O,j)}}t("decorate",M);function U(T,A){function O(j,G){if(!ye(j))throw new TypeError;if(!H(G)&&!ke(G))throw new TypeError;W(T,A,j,G)}return O}t("metadata",U);function F(T,A,O,j){if(!ye(O))throw new TypeError;return H(j)||(j=he(j)),W(T,A,O,j)}t("defineMetadata",F);function J(T,A,O){if(!ye(A))throw new TypeError;return H(O)||(O=he(O)),q(T,A,O)}t("hasMetadata",J);function K(T,A,O){if(!ye(A))throw new TypeError;return H(O)||(O=he(O)),_(T,A,O)}t("hasOwnMetadata",K);function re(T,A,O){if(!ye(A))throw new TypeError;return H(O)||(O=he(O)),I(T,A,O)}t("getMetadata",re);function $(T,A,O){if(!ye(A))throw new TypeError;return H(O)||(O=he(O)),B(T,A,O)}t("getOwnMetadata",$);function Y(T,A){if(!ye(T))throw new TypeError;return H(A)||(A=he(A)),ee(T,A)}t("getMetadataKeys",Y);function S(T,A){if(!ye(T))throw new TypeError;return H(A)||(A=he(A)),ie(T,A)}t("getOwnMetadataKeys",S);function V(T,A,O){if(!ye(A))throw new TypeError;if(H(O)||(O=he(O)),!ye(A))throw new TypeError;H(O)||(O=he(O));var j=E(A,O,!1);return H(j)?!1:j.OrdinaryDeleteMetadata(T,A,O)}t("deleteMetadata",V);function L(T,A){for(var O=T.length-1;O>=0;--O){var j=T[O],G=j(A);if(!H(G)&&!we(G)){if(!Re(G))throw new TypeError;A=G}}return A}function D(T,A,O,j){for(var G=T.length-1;G>=0;--G){var le=T[G],ue=le(A,O,j);if(!H(ue)&&!we(ue)){if(!ye(ue))throw new TypeError;j=ue}}return j}function q(T,A,O){var j=_(T,A,O);if(j)return!0;var G=Ae(A);return we(G)?!1:q(T,G,O)}function _(T,A,O){var j=E(A,O,!1);return H(j)?!1:ge(j.OrdinaryHasOwnMetadata(T,A,O))}function I(T,A,O){var j=_(T,A,O);if(j)return B(T,A,O);var G=Ae(A);if(!we(G))return I(T,G,O)}function B(T,A,O){var j=E(A,O,!1);if(!H(j))return j.OrdinaryGetOwnMetadata(T,A,O)}function W(T,A,O,j){var G=E(O,j,!0);G.OrdinaryDefineOwnMetadata(T,A,O,j)}function ee(T,A){var O=ie(T,A),j=Ae(T);if(j===null)return O;var G=ee(j,A);if(G.length<=0)return O;if(O.length<=0)return G;for(var le=new y,ue=[],de=0,z=O;de<z.length;de++){var X=z[de],Z=le.has(X);Z||(le.add(X),ue.push(X))}for(var te=0,pe=G;te<pe.length;te++){var X=pe[te],Z=le.has(X);Z||(le.add(X),ue.push(X))}return ue}function ie(T,A){var O=E(T,A,!1);return O?O.OrdinaryOwnMetadataKeys(T,A):[]}function ce(T){if(T===null)return 1;switch(typeof T){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return T===null?1:6;default:return 6}}function H(T){return T===void 0}function we(T){return T===null}function Oe(T){return typeof T=="symbol"}function ye(T){return typeof T=="object"?T!==null:typeof T=="function"}function qe(T,A){switch(ce(T)){case 0:return T;case 1:return T;case 2:return T;case 3:return T;case 4:return T;case 5:return T}var O="string",j=je(T,s);if(j!==void 0){var G=j.call(T,O);if(ye(G))throw new TypeError;return G}return Ne(T)}function Ne(T,A){var O,j,G;{var le=T.toString;if(fe(le)){var j=le.call(T);if(!ye(j))return j}var O=T.valueOf;if(fe(O)){var j=O.call(T);if(!ye(j))return j}}throw new TypeError}function ge(T){return!!T}function ae(T){return""+T}function he(T){var A=qe(T);return Oe(A)?A:ae(A)}function me(T){return Array.isArray?Array.isArray(T):T instanceof Object?T instanceof Array:Object.prototype.toString.call(T)==="[object Array]"}function fe(T){return typeof T=="function"}function Re(T){return typeof T=="function"}function ke(T){switch(ce(T)){case 3:return!0;case 4:return!0;default:return!1}}function Me(T,A){return T===A||T!==T&&A!==A}function je(T,A){var O=T[A];if(O!=null){if(!fe(O))throw new TypeError;return O}}function ze(T){var A=je(T,a);if(!fe(A))throw new TypeError;var O=A.call(T);if(!ye(O))throw new TypeError;return O}function Ke(T){return T.value}function Ue(T){var A=T.next();return A.done?!1:A}function Te(T){var A=T.return;A&&A.call(T)}function Ae(T){var A=Object.getPrototypeOf(T);if(typeof T!="function"||T===h||A!==h)return A;var O=T.prototype,j=O&&Object.getPrototypeOf(O);if(j==null||j===Object.prototype)return A;var G=j.constructor;return typeof G!="function"||G===T?A:G}function Qe(){var T;!H(b)&&typeof n.Reflect<"u"&&!(b in n.Reflect)&&typeof n.Reflect.defineMetadata=="function"&&(T=tn(n.Reflect));var A,O,j,G=new g,le={registerProvider:ue,getProvider:z,setProvider:Z};return le;function ue(te){if(!Object.isExtensible(le))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case T===te:break;case H(A):A=te;break;case A===te:break;case H(O):O=te;break;case O===te:break;default:j===void 0&&(j=new y),j.add(te);break}}function de(te,pe){if(!H(A)){if(A.isProviderFor(te,pe))return A;if(!H(O)){if(O.isProviderFor(te,pe))return A;if(!H(j))for(var Ce=ze(j);;){var Ie=Ue(Ce);if(!Ie)return;var Je=Ke(Ie);if(Je.isProviderFor(te,pe))return Te(Ce),Je}}}if(!H(T)&&T.isProviderFor(te,pe))return T}function z(te,pe){var Ce=G.get(te),Ie;return H(Ce)||(Ie=Ce.get(pe)),H(Ie)&&(Ie=de(te,pe),H(Ie)||(H(Ce)&&(Ce=new m,G.set(te,Ce)),Ce.set(pe,Ie))),Ie}function X(te){if(H(te))throw new TypeError;return A===te||O===te||!H(j)&&j.has(te)}function Z(te,pe,Ce){if(!X(Ce))throw new Error("Metadata provider not registered.");var Ie=z(te,pe);if(Ie!==Ce){if(!H(Ie))return!1;var Je=G.get(te);H(Je)&&(Je=new m,G.set(te,Je)),Je.set(pe,Ce)}return!0}}function rt(){var T;return!H(b)&&ye(n.Reflect)&&Object.isExtensible(n.Reflect)&&(T=n.Reflect[b]),H(T)&&(T=Qe()),!H(b)&&ye(n.Reflect)&&Object.isExtensible(n.Reflect)&&Object.defineProperty(n.Reflect,b,{enumerable:!1,configurable:!1,writable:!1,value:T}),T}function st(T){var A=new g,O={isProviderFor:function(X,Z){var te=A.get(X);return H(te)?!1:te.has(Z)},OrdinaryDefineOwnMetadata:ue,OrdinaryHasOwnMetadata:G,OrdinaryGetOwnMetadata:le,OrdinaryOwnMetadataKeys:de,OrdinaryDeleteMetadata:z};return R.registerProvider(O),O;function j(X,Z,te){var pe=A.get(X),Ce=!1;if(H(pe)){if(!te)return;pe=new m,A.set(X,pe),Ce=!0}var Ie=pe.get(Z);if(H(Ie)){if(!te)return;if(Ie=new m,pe.set(Z,Ie),!T.setProvider(X,Z,O))throw pe.delete(Z),Ce&&A.delete(X),new Error("Wrong provider for target.")}return Ie}function G(X,Z,te){var pe=j(Z,te,!1);return H(pe)?!1:ge(pe.has(X))}function le(X,Z,te){var pe=j(Z,te,!1);if(!H(pe))return pe.get(X)}function ue(X,Z,te,pe){var Ce=j(te,pe,!0);Ce.set(X,Z)}function de(X,Z){var te=[],pe=j(X,Z,!1);if(H(pe))return te;for(var Ce=pe.keys(),Ie=ze(Ce),Je=0;;){var Ri=Ue(Ie);if(!Ri)return te.length=Je,te;var Ws=Ke(Ri);try{te[Je]=Ws}catch(Hs){try{Te(Ie)}finally{throw Hs}}Je++}}function z(X,Z,te){var pe=j(Z,te,!1);if(H(pe)||!pe.delete(X))return!1;if(pe.size===0){var Ce=A.get(Z);H(Ce)||(Ce.delete(te),Ce.size===0&&A.delete(Ce))}return!0}}function tn(T){var A=T.defineMetadata,O=T.hasOwnMetadata,j=T.getOwnMetadata,G=T.getOwnMetadataKeys,le=T.deleteMetadata,ue=new g,de={isProviderFor:function(z,X){var Z=ue.get(z);return!H(Z)&&Z.has(X)?!0:G(z,X).length?(H(Z)&&(Z=new y,ue.set(z,Z)),Z.add(X),!0):!1},OrdinaryDefineOwnMetadata:A,OrdinaryHasOwnMetadata:O,OrdinaryGetOwnMetadata:j,OrdinaryOwnMetadataKeys:G,OrdinaryDeleteMetadata:le};return de}function E(T,A,O){var j=R.getProvider(T,A);if(!H(j))return j;if(O){if(R.setProvider(T,A,P))return P;throw new Error("Illegal state.")}}function d(){var T={},A=[],O=(function(){function de(z,X,Z){this._index=0,this._keys=z,this._values=X,this._selector=Z}return de.prototype["@@iterator"]=function(){return this},de.prototype[a]=function(){return this},de.prototype.next=function(){var z=this._index;if(z>=0&&z<this._keys.length){var X=this._selector(this._keys[z],this._values[z]);return z+1>=this._keys.length?(this._index=-1,this._keys=A,this._values=A):this._index++,{value:X,done:!1}}return{value:void 0,done:!0}},de.prototype.throw=function(z){throw this._index>=0&&(this._index=-1,this._keys=A,this._values=A),z},de.prototype.return=function(z){return this._index>=0&&(this._index=-1,this._keys=A,this._values=A),{value:z,done:!0}},de})(),j=(function(){function de(){this._keys=[],this._values=[],this._cacheKey=T,this._cacheIndex=-2}return Object.defineProperty(de.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),de.prototype.has=function(z){return this._find(z,!1)>=0},de.prototype.get=function(z){var X=this._find(z,!1);return X>=0?this._values[X]:void 0},de.prototype.set=function(z,X){var Z=this._find(z,!0);return this._values[Z]=X,this},de.prototype.delete=function(z){var X=this._find(z,!1);if(X>=0){for(var Z=this._keys.length,te=X+1;te<Z;te++)this._keys[te-1]=this._keys[te],this._values[te-1]=this._values[te];return this._keys.length--,this._values.length--,Me(z,this._cacheKey)&&(this._cacheKey=T,this._cacheIndex=-2),!0}return!1},de.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=T,this._cacheIndex=-2},de.prototype.keys=function(){return new O(this._keys,this._values,G)},de.prototype.values=function(){return new O(this._keys,this._values,le)},de.prototype.entries=function(){return new O(this._keys,this._values,ue)},de.prototype["@@iterator"]=function(){return this.entries()},de.prototype[a]=function(){return this.entries()},de.prototype._find=function(z,X){if(!Me(this._cacheKey,z)){this._cacheIndex=-1;for(var Z=0;Z<this._keys.length;Z++)if(Me(this._keys[Z],z)){this._cacheIndex=Z;break}}return this._cacheIndex<0&&X&&(this._cacheIndex=this._keys.length,this._keys.push(z),this._values.push(void 0)),this._cacheIndex},de})();return j;function G(de,z){return de}function le(de,z){return z}function ue(de,z){return[de,z]}}function f(){var T=(function(){function A(){this._map=new m}return Object.defineProperty(A.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),A.prototype.has=function(O){return this._map.has(O)},A.prototype.add=function(O){return this._map.set(O,O),this},A.prototype.delete=function(O){return this._map.delete(O)},A.prototype.clear=function(){this._map.clear()},A.prototype.keys=function(){return this._map.keys()},A.prototype.values=function(){return this._map.keys()},A.prototype.entries=function(){return this._map.entries()},A.prototype["@@iterator"]=function(){return this.keys()},A.prototype[a]=function(){return this.keys()},A})();return T}function w(){var T=16,A=l.create(),O=j();return(function(){function z(){this._key=j()}return z.prototype.has=function(X){var Z=G(X,!1);return Z!==void 0?l.has(Z,this._key):!1},z.prototype.get=function(X){var Z=G(X,!1);return Z!==void 0?l.get(Z,this._key):void 0},z.prototype.set=function(X,Z){var te=G(X,!0);return te[this._key]=Z,this},z.prototype.delete=function(X){var Z=G(X,!1);return Z!==void 0?delete Z[this._key]:!1},z.prototype.clear=function(){this._key=j()},z})();function j(){var z;do z="@@WeakMap@@"+de();while(l.has(A,z));return A[z]=!0,z}function G(z,X){if(!i.call(z,O)){if(!X)return;Object.defineProperty(z,O,{value:l.create()})}return z[O]}function le(z,X){for(var Z=0;Z<X;++Z)z[Z]=Math.random()*255|0;return z}function ue(z){if(typeof Uint8Array=="function"){var X=new Uint8Array(z);return typeof crypto<"u"?crypto.getRandomValues(X):typeof msCrypto<"u"?msCrypto.getRandomValues(X):le(X,z),X}return le(new Array(z),z)}function de(){var z=ue(T);z[6]=z[6]&79|64,z[8]=z[8]&191|128;for(var X="",Z=0;Z<T;++Z){var te=z[Z];(Z===4||Z===6||Z===8)&&(X+="-"),te<16&&(X+="0"),X+=te.toString(16).toLowerCase()}return X}}function x(T){return T.__=void 0,delete T.__,T}})})(p||(p={})),Mi}Gs();class Ft{static getInheritanceTree(e){const t=[e],n=i=>{const r=Object.getPrototypeOf(i);r&&r.name&&(t.push(r),n(r))};return n(e),t}static isInherited(e,t){return e.prototype instanceof t}static filterByTarget(e,t){return t?e.filter(n=>n.target&&t.indexOf(n.target)!==-1):e}}class fs{constructor(){this.tables=[],this.trees=[],this.entityRepositories=[],this.transactionEntityManagers=[],this.transactionRepositories=[],this.namingStrategies=[],this.entitySubscribers=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.columns=[],this.generations=[],this.relations=[],this.joinColumns=[],this.joinTables=[],this.entityListeners=[],this.relationCounts=[],this.relationIds=[],this.embeddeds=[],this.inheritances=[],this.discriminatorValues=[]}filterTables(e){return this.filterByTarget(this.tables,e)}filterColumns(e){return this.filterByTargetAndWithoutDuplicateProperties(this.columns,e)}findGenerated(e,t){return this.generations.find(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.propertyName===t)}findTree(e){return this.trees.find(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterRelations(e){return this.filterByTargetAndWithoutDuplicateRelationProperties(this.relations,e)}filterRelationIds(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationIds,e)}filterRelationCounts(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationCounts,e)}filterIndices(e){return this.indices.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterForeignKeys(e){return this.foreignKeys.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterUniques(e){return this.uniques.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterChecks(e){return this.checks.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterExclusions(e){return this.exclusions.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterListeners(e){return this.filterByTarget(this.entityListeners,e)}filterEmbeddeds(e){return this.filterByTargetAndWithoutDuplicateEmbeddedProperties(this.embeddeds,e)}findJoinTable(e,t){return this.joinTables.find(n=>n.target===e&&n.propertyName===t)}filterJoinColumns(e,t){return this.joinColumns.filter(n=>n.target===e&&n.propertyName===t)}filterSubscribers(e){return this.filterByTarget(this.entitySubscribers,e)}filterNamingStrategies(e){return this.filterByTarget(this.namingStrategies,e)}filterTransactionEntityManagers(e,t){return this.transactionEntityManagers.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterTransactionRepository(e,t){return this.transactionRepositories.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterSingleTableChildren(e){return this.tables.filter(t=>typeof t.target=="function"&&typeof e=="function"&&Ft.isInherited(t.target,e)&&t.type==="entity-child")}findInheritanceType(e){return this.inheritances.find(t=>t.target===e)}findDiscriminatorValue(e){return this.discriminatorValues.find(t=>t.target===e)}filterByTarget(e,t){return e.filter(n=>Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)}filterByTargetAndWithoutDuplicateProperties(e,t){const n=[];return e.forEach(i=>{(Array.isArray(t)?t.indexOf(i.target)!==-1:i.target===t)&&(n.find(s=>s.propertyName===i.propertyName)||n.push(i))}),n}filterByTargetAndWithoutDuplicateRelationProperties(e,t){const n=[];return e.forEach(i=>{if(Array.isArray(t)?t.indexOf(i.target)!==-1:i.target===t){const s=n.findIndex(a=>a.propertyName===i.propertyName);if(Array.isArray(t)&&s!==-1&&t.indexOf(i.target)<t.indexOf(n[s].target)){const a=Object.create(n[s]);a.type=i.type,n[s]=a}else s===-1&&n.push(i)}}),n}filterByTargetAndWithoutDuplicateEmbeddedProperties(e,t){const n=[];return e.forEach(i=>{(Array.isArray(t)?t.indexOf(i.target)!==-1:i.target===t)&&(n.find(a=>a.prefix===i.prefix&&a.propertyName===i.propertyName)||n.push(i))}),n}}var nn={},At={},vi;function zs(){if(vi)return At;vi=1,At.byteLength=a,At.toByteArray=c,At.fromByteArray=h;for(var p=[],e=[],t=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,r=n.length;i<r;++i)p[i]=n[i],e[n.charCodeAt(i)]=i;e[45]=62,e[95]=63;function s(m){var y=m.length;if(y%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var g=m.indexOf("=");g===-1&&(g=y);var b=g===y?0:4-g%4;return[g,b]}function a(m){var y=s(m),g=y[0],b=y[1];return(g+b)*3/4-b}function o(m,y,g){return(y+g)*3/4-g}function c(m){var y,g=s(m),b=g[0],R=g[1],P=new t(o(m,b,R)),M=0,U=R>0?b-4:b,F;for(F=0;F<U;F+=4)y=e[m.charCodeAt(F)]<<18|e[m.charCodeAt(F+1)]<<12|e[m.charCodeAt(F+2)]<<6|e[m.charCodeAt(F+3)],P[M++]=y>>16&255,P[M++]=y>>8&255,P[M++]=y&255;return R===2&&(y=e[m.charCodeAt(F)]<<2|e[m.charCodeAt(F+1)]>>4,P[M++]=y&255),R===1&&(y=e[m.charCodeAt(F)]<<10|e[m.charCodeAt(F+1)]<<4|e[m.charCodeAt(F+2)]>>2,P[M++]=y>>8&255,P[M++]=y&255),P}function u(m){return p[m>>18&63]+p[m>>12&63]+p[m>>6&63]+p[m&63]}function l(m,y,g){for(var b,R=[],P=y;P<g;P+=3)b=(m[P]<<16&16711680)+(m[P+1]<<8&65280)+(m[P+2]&255),R.push(u(b));return R.join("")}function h(m){for(var y,g=m.length,b=g%3,R=[],P=16383,M=0,U=g-b;M<U;M+=P)R.push(l(m,M,M+P>U?U:M+P));return b===1?(y=m[g-1],R.push(p[y>>2]+p[y<<4&63]+"==")):b===2&&(y=(m[g-2]<<8)+m[g-1],R.push(p[y>>10]+p[y>>4&63]+p[y<<2&63]+"=")),R.join("")}return At}var It={};var Pi;function Ks(){return Pi||(Pi=1,It.read=function(p,e,t,n,i){var r,s,a=i*8-n-1,o=(1<<a)-1,c=o>>1,u=-7,l=t?i-1:0,h=t?-1:1,m=p[e+l];for(l+=h,r=m&(1<<-u)-1,m>>=-u,u+=a;u>0;r=r*256+p[e+l],l+=h,u-=8);for(s=r&(1<<-u)-1,r>>=-u,u+=n;u>0;s=s*256+p[e+l],l+=h,u-=8);if(r===0)r=1-c;else{if(r===o)return s?NaN:(m?-1:1)*(1/0);s=s+Math.pow(2,n),r=r-c}return(m?-1:1)*s*Math.pow(2,r-n)},It.write=function(p,e,t,n,i,r){var s,a,o,c=r*8-i-1,u=(1<<c)-1,l=u>>1,h=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,m=n?0:r-1,y=n?1:-1,g=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=u):(s=Math.floor(Math.log(e)/Math.LN2),e*(o=Math.pow(2,-s))<1&&(s--,o*=2),s+l>=1?e+=h/o:e+=h*Math.pow(2,1-l),e*o>=2&&(s++,o/=2),s+l>=u?(a=0,s=u):s+l>=1?(a=(e*o-1)*Math.pow(2,i),s=s+l):(a=e*Math.pow(2,l-1)*Math.pow(2,i),s=0));i>=8;p[t+m]=a&255,m+=y,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;p[t+m]=s&255,m+=y,s/=256,c-=8);p[t+m-y]|=g*128}),It}var Oi;function ys(){return Oi||(Oi=1,(function(p){const e=zs(),t=Ks(),n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;p.Buffer=a,p.SlowBuffer=P,p.INSPECT_MAX_BYTES=50;const i=2147483647;p.kMaxLength=i,a.TYPED_ARRAY_SUPPORT=r(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function r(){try{const E=new Uint8Array(1),d={foo:function(){return 42}};return Object.setPrototypeOf(d,Uint8Array.prototype),Object.setPrototypeOf(E,d),E.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function s(E){if(E>i)throw new RangeError('The value "'+E+'" is invalid for option "size"');const d=new Uint8Array(E);return Object.setPrototypeOf(d,a.prototype),d}function a(E,d,f){if(typeof E=="number"){if(typeof d=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return l(E)}return o(E,d,f)}a.poolSize=8192;function o(E,d,f){if(typeof E=="string")return h(E,d);if(ArrayBuffer.isView(E))return y(E);if(E==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof E);if(Ae(E,ArrayBuffer)||E&&Ae(E.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Ae(E,SharedArrayBuffer)||E&&Ae(E.buffer,SharedArrayBuffer)))return g(E,d,f);if(typeof E=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const w=E.valueOf&&E.valueOf();if(w!=null&&w!==E)return a.from(w,d,f);const x=b(E);if(x)return x;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof E[Symbol.toPrimitive]=="function")return a.from(E[Symbol.toPrimitive]("string"),d,f);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof E)}a.from=function(E,d,f){return o(E,d,f)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function c(E){if(typeof E!="number")throw new TypeError('"size" argument must be of type number');if(E<0)throw new RangeError('The value "'+E+'" is invalid for option "size"')}function u(E,d,f){return c(E),E<=0?s(E):d!==void 0?typeof f=="string"?s(E).fill(d,f):s(E).fill(d):s(E)}a.alloc=function(E,d,f){return u(E,d,f)};function l(E){return c(E),s(E<0?0:R(E)|0)}a.allocUnsafe=function(E){return l(E)},a.allocUnsafeSlow=function(E){return l(E)};function h(E,d){if((typeof d!="string"||d==="")&&(d="utf8"),!a.isEncoding(d))throw new TypeError("Unknown encoding: "+d);const f=M(E,d)|0;let w=s(f);const x=w.write(E,d);return x!==f&&(w=w.slice(0,x)),w}function m(E){const d=E.length<0?0:R(E.length)|0,f=s(d);for(let w=0;w<d;w+=1)f[w]=E[w]&255;return f}function y(E){if(Ae(E,Uint8Array)){const d=new Uint8Array(E);return g(d.buffer,d.byteOffset,d.byteLength)}return m(E)}function g(E,d,f){if(d<0||E.byteLength<d)throw new RangeError('"offset" is outside of buffer bounds');if(E.byteLength<d+(f||0))throw new RangeError('"length" is outside of buffer bounds');let w;return d===void 0&&f===void 0?w=new Uint8Array(E):f===void 0?w=new Uint8Array(E,d):w=new Uint8Array(E,d,f),Object.setPrototypeOf(w,a.prototype),w}function b(E){if(a.isBuffer(E)){const d=R(E.length)|0,f=s(d);return f.length===0||E.copy(f,0,0,d),f}if(E.length!==void 0)return typeof E.length!="number"||Qe(E.length)?s(0):m(E);if(E.type==="Buffer"&&Array.isArray(E.data))return m(E.data)}function R(E){if(E>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return E|0}function P(E){return+E!=E&&(E=0),a.alloc(+E)}a.isBuffer=function(d){return d!=null&&d._isBuffer===!0&&d!==a.prototype},a.compare=function(d,f){if(Ae(d,Uint8Array)&&(d=a.from(d,d.offset,d.byteLength)),Ae(f,Uint8Array)&&(f=a.from(f,f.offset,f.byteLength)),!a.isBuffer(d)||!a.isBuffer(f))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(d===f)return 0;let w=d.length,x=f.length;for(let T=0,A=Math.min(w,x);T<A;++T)if(d[T]!==f[T]){w=d[T],x=f[T];break}return w<x?-1:x<w?1:0},a.isEncoding=function(d){switch(String(d).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(d,f){if(!Array.isArray(d))throw new TypeError('"list" argument must be an Array of Buffers');if(d.length===0)return a.alloc(0);let w;if(f===void 0)for(f=0,w=0;w<d.length;++w)f+=d[w].length;const x=a.allocUnsafe(f);let T=0;for(w=0;w<d.length;++w){let A=d[w];if(Ae(A,Uint8Array))T+A.length>x.length?(a.isBuffer(A)||(A=a.from(A)),A.copy(x,T)):Uint8Array.prototype.set.call(x,A,T);else if(a.isBuffer(A))A.copy(x,T);else throw new TypeError('"list" argument must be an Array of Buffers');T+=A.length}return x};function M(E,d){if(a.isBuffer(E))return E.length;if(ArrayBuffer.isView(E)||Ae(E,ArrayBuffer))return E.byteLength;if(typeof E!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof E);const f=E.length,w=arguments.length>2&&arguments[2]===!0;if(!w&&f===0)return 0;let x=!1;for(;;)switch(d){case"ascii":case"latin1":case"binary":return f;case"utf8":case"utf-8":return je(E).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return f*2;case"hex":return f>>>1;case"base64":return Ue(E).length;default:if(x)return w?-1:je(E).length;d=(""+d).toLowerCase(),x=!0}}a.byteLength=M;function U(E,d,f){let w=!1;if((d===void 0||d<0)&&(d=0),d>this.length||((f===void 0||f>this.length)&&(f=this.length),f<=0)||(f>>>=0,d>>>=0,f<=d))return"";for(E||(E="utf8");;)switch(E){case"hex":return W(this,d,f);case"utf8":case"utf-8":return D(this,d,f);case"ascii":return I(this,d,f);case"latin1":case"binary":return B(this,d,f);case"base64":return L(this,d,f);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ee(this,d,f);default:if(w)throw new TypeError("Unknown encoding: "+E);E=(E+"").toLowerCase(),w=!0}}a.prototype._isBuffer=!0;function F(E,d,f){const w=E[d];E[d]=E[f],E[f]=w}a.prototype.swap16=function(){const d=this.length;if(d%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let f=0;f<d;f+=2)F(this,f,f+1);return this},a.prototype.swap32=function(){const d=this.length;if(d%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let f=0;f<d;f+=4)F(this,f,f+3),F(this,f+1,f+2);return this},a.prototype.swap64=function(){const d=this.length;if(d%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let f=0;f<d;f+=8)F(this,f,f+7),F(this,f+1,f+6),F(this,f+2,f+5),F(this,f+3,f+4);return this},a.prototype.toString=function(){const d=this.length;return d===0?"":arguments.length===0?D(this,0,d):U.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(d){if(!a.isBuffer(d))throw new TypeError("Argument must be a Buffer");return this===d?!0:a.compare(this,d)===0},a.prototype.inspect=function(){let d="";const f=p.INSPECT_MAX_BYTES;return d=this.toString("hex",0,f).replace(/(.{2})/g,"$1 ").trim(),this.length>f&&(d+=" ... "),"<Buffer "+d+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(d,f,w,x,T){if(Ae(d,Uint8Array)&&(d=a.from(d,d.offset,d.byteLength)),!a.isBuffer(d))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof d);if(f===void 0&&(f=0),w===void 0&&(w=d?d.length:0),x===void 0&&(x=0),T===void 0&&(T=this.length),f<0||w>d.length||x<0||T>this.length)throw new RangeError("out of range index");if(x>=T&&f>=w)return 0;if(x>=T)return-1;if(f>=w)return 1;if(f>>>=0,w>>>=0,x>>>=0,T>>>=0,this===d)return 0;let A=T-x,O=w-f;const j=Math.min(A,O),G=this.slice(x,T),le=d.slice(f,w);for(let ue=0;ue<j;++ue)if(G[ue]!==le[ue]){A=G[ue],O=le[ue];break}return A<O?-1:O<A?1:0};function J(E,d,f,w,x){if(E.length===0)return-1;if(typeof f=="string"?(w=f,f=0):f>2147483647?f=2147483647:f<-2147483648&&(f=-2147483648),f=+f,Qe(f)&&(f=x?0:E.length-1),f<0&&(f=E.length+f),f>=E.length){if(x)return-1;f=E.length-1}else if(f<0)if(x)f=0;else return-1;if(typeof d=="string"&&(d=a.from(d,w)),a.isBuffer(d))return d.length===0?-1:K(E,d,f,w,x);if(typeof d=="number")return d=d&255,typeof Uint8Array.prototype.indexOf=="function"?x?Uint8Array.prototype.indexOf.call(E,d,f):Uint8Array.prototype.lastIndexOf.call(E,d,f):K(E,[d],f,w,x);throw new TypeError("val must be string, number or Buffer")}function K(E,d,f,w,x){let T=1,A=E.length,O=d.length;if(w!==void 0&&(w=String(w).toLowerCase(),w==="ucs2"||w==="ucs-2"||w==="utf16le"||w==="utf-16le")){if(E.length<2||d.length<2)return-1;T=2,A/=2,O/=2,f/=2}function j(le,ue){return T===1?le[ue]:le.readUInt16BE(ue*T)}let G;if(x){let le=-1;for(G=f;G<A;G++)if(j(E,G)===j(d,le===-1?0:G-le)){if(le===-1&&(le=G),G-le+1===O)return le*T}else le!==-1&&(G-=G-le),le=-1}else for(f+O>A&&(f=A-O),G=f;G>=0;G--){let le=!0;for(let ue=0;ue<O;ue++)if(j(E,G+ue)!==j(d,ue)){le=!1;break}if(le)return G}return-1}a.prototype.includes=function(d,f,w){return this.indexOf(d,f,w)!==-1},a.prototype.indexOf=function(d,f,w){return J(this,d,f,w,!0)},a.prototype.lastIndexOf=function(d,f,w){return J(this,d,f,w,!1)};function re(E,d,f,w){f=Number(f)||0;const x=E.length-f;w?(w=Number(w),w>x&&(w=x)):w=x;const T=d.length;w>T/2&&(w=T/2);let A;for(A=0;A<w;++A){const O=parseInt(d.substr(A*2,2),16);if(Qe(O))return A;E[f+A]=O}return A}function $(E,d,f,w){return Te(je(d,E.length-f),E,f,w)}function Y(E,d,f,w){return Te(ze(d),E,f,w)}function S(E,d,f,w){return Te(Ue(d),E,f,w)}function V(E,d,f,w){return Te(Ke(d,E.length-f),E,f,w)}a.prototype.write=function(d,f,w,x){if(f===void 0)x="utf8",w=this.length,f=0;else if(w===void 0&&typeof f=="string")x=f,w=this.length,f=0;else if(isFinite(f))f=f>>>0,isFinite(w)?(w=w>>>0,x===void 0&&(x="utf8")):(x=w,w=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const T=this.length-f;if((w===void 0||w>T)&&(w=T),d.length>0&&(w<0||f<0)||f>this.length)throw new RangeError("Attempt to write outside buffer bounds");x||(x="utf8");let A=!1;for(;;)switch(x){case"hex":return re(this,d,f,w);case"utf8":case"utf-8":return $(this,d,f,w);case"ascii":case"latin1":case"binary":return Y(this,d,f,w);case"base64":return S(this,d,f,w);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return V(this,d,f,w);default:if(A)throw new TypeError("Unknown encoding: "+x);x=(""+x).toLowerCase(),A=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function L(E,d,f){return d===0&&f===E.length?e.fromByteArray(E):e.fromByteArray(E.slice(d,f))}function D(E,d,f){f=Math.min(E.length,f);const w=[];let x=d;for(;x<f;){const T=E[x];let A=null,O=T>239?4:T>223?3:T>191?2:1;if(x+O<=f){let j,G,le,ue;switch(O){case 1:T<128&&(A=T);break;case 2:j=E[x+1],(j&192)===128&&(ue=(T&31)<<6|j&63,ue>127&&(A=ue));break;case 3:j=E[x+1],G=E[x+2],(j&192)===128&&(G&192)===128&&(ue=(T&15)<<12|(j&63)<<6|G&63,ue>2047&&(ue<55296||ue>57343)&&(A=ue));break;case 4:j=E[x+1],G=E[x+2],le=E[x+3],(j&192)===128&&(G&192)===128&&(le&192)===128&&(ue=(T&15)<<18|(j&63)<<12|(G&63)<<6|le&63,ue>65535&&ue<1114112&&(A=ue))}}A===null?(A=65533,O=1):A>65535&&(A-=65536,w.push(A>>>10&1023|55296),A=56320|A&1023),w.push(A),x+=O}return _(w)}const q=4096;function _(E){const d=E.length;if(d<=q)return String.fromCharCode.apply(String,E);let f="",w=0;for(;w<d;)f+=String.fromCharCode.apply(String,E.slice(w,w+=q));return f}function I(E,d,f){let w="";f=Math.min(E.length,f);for(let x=d;x<f;++x)w+=String.fromCharCode(E[x]&127);return w}function B(E,d,f){let w="";f=Math.min(E.length,f);for(let x=d;x<f;++x)w+=String.fromCharCode(E[x]);return w}function W(E,d,f){const w=E.length;(!d||d<0)&&(d=0),(!f||f<0||f>w)&&(f=w);let x="";for(let T=d;T<f;++T)x+=rt[E[T]];return x}function ee(E,d,f){const w=E.slice(d,f);let x="";for(let T=0;T<w.length-1;T+=2)x+=String.fromCharCode(w[T]+w[T+1]*256);return x}a.prototype.slice=function(d,f){const w=this.length;d=~~d,f=f===void 0?w:~~f,d<0?(d+=w,d<0&&(d=0)):d>w&&(d=w),f<0?(f+=w,f<0&&(f=0)):f>w&&(f=w),f<d&&(f=d);const x=this.subarray(d,f);return Object.setPrototypeOf(x,a.prototype),x};function ie(E,d,f){if(E%1!==0||E<0)throw new RangeError("offset is not uint");if(E+d>f)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(d,f,w){d=d>>>0,f=f>>>0,w||ie(d,f,this.length);let x=this[d],T=1,A=0;for(;++A<f&&(T*=256);)x+=this[d+A]*T;return x},a.prototype.readUintBE=a.prototype.readUIntBE=function(d,f,w){d=d>>>0,f=f>>>0,w||ie(d,f,this.length);let x=this[d+--f],T=1;for(;f>0&&(T*=256);)x+=this[d+--f]*T;return x},a.prototype.readUint8=a.prototype.readUInt8=function(d,f){return d=d>>>0,f||ie(d,1,this.length),this[d]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(d,f){return d=d>>>0,f||ie(d,2,this.length),this[d]|this[d+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(d,f){return d=d>>>0,f||ie(d,2,this.length),this[d]<<8|this[d+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(d,f){return d=d>>>0,f||ie(d,4,this.length),(this[d]|this[d+1]<<8|this[d+2]<<16)+this[d+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(d,f){return d=d>>>0,f||ie(d,4,this.length),this[d]*16777216+(this[d+1]<<16|this[d+2]<<8|this[d+3])},a.prototype.readBigUInt64LE=st(function(d){d=d>>>0,fe(d,"offset");const f=this[d],w=this[d+7];(f===void 0||w===void 0)&&Re(d,this.length-8);const x=f+this[++d]*2**8+this[++d]*2**16+this[++d]*2**24,T=this[++d]+this[++d]*2**8+this[++d]*2**16+w*2**24;return BigInt(x)+(BigInt(T)<<BigInt(32))}),a.prototype.readBigUInt64BE=st(function(d){d=d>>>0,fe(d,"offset");const f=this[d],w=this[d+7];(f===void 0||w===void 0)&&Re(d,this.length-8);const x=f*2**24+this[++d]*2**16+this[++d]*2**8+this[++d],T=this[++d]*2**24+this[++d]*2**16+this[++d]*2**8+w;return(BigInt(x)<<BigInt(32))+BigInt(T)}),a.prototype.readIntLE=function(d,f,w){d=d>>>0,f=f>>>0,w||ie(d,f,this.length);let x=this[d],T=1,A=0;for(;++A<f&&(T*=256);)x+=this[d+A]*T;return T*=128,x>=T&&(x-=Math.pow(2,8*f)),x},a.prototype.readIntBE=function(d,f,w){d=d>>>0,f=f>>>0,w||ie(d,f,this.length);let x=f,T=1,A=this[d+--x];for(;x>0&&(T*=256);)A+=this[d+--x]*T;return T*=128,A>=T&&(A-=Math.pow(2,8*f)),A},a.prototype.readInt8=function(d,f){return d=d>>>0,f||ie(d,1,this.length),this[d]&128?(255-this[d]+1)*-1:this[d]},a.prototype.readInt16LE=function(d,f){d=d>>>0,f||ie(d,2,this.length);const w=this[d]|this[d+1]<<8;return w&32768?w|4294901760:w},a.prototype.readInt16BE=function(d,f){d=d>>>0,f||ie(d,2,this.length);const w=this[d+1]|this[d]<<8;return w&32768?w|4294901760:w},a.prototype.readInt32LE=function(d,f){return d=d>>>0,f||ie(d,4,this.length),this[d]|this[d+1]<<8|this[d+2]<<16|this[d+3]<<24},a.prototype.readInt32BE=function(d,f){return d=d>>>0,f||ie(d,4,this.length),this[d]<<24|this[d+1]<<16|this[d+2]<<8|this[d+3]},a.prototype.readBigInt64LE=st(function(d){d=d>>>0,fe(d,"offset");const f=this[d],w=this[d+7];(f===void 0||w===void 0)&&Re(d,this.length-8);const x=this[d+4]+this[d+5]*2**8+this[d+6]*2**16+(w<<24);return(BigInt(x)<<BigInt(32))+BigInt(f+this[++d]*2**8+this[++d]*2**16+this[++d]*2**24)}),a.prototype.readBigInt64BE=st(function(d){d=d>>>0,fe(d,"offset");const f=this[d],w=this[d+7];(f===void 0||w===void 0)&&Re(d,this.length-8);const x=(f<<24)+this[++d]*2**16+this[++d]*2**8+this[++d];return(BigInt(x)<<BigInt(32))+BigInt(this[++d]*2**24+this[++d]*2**16+this[++d]*2**8+w)}),a.prototype.readFloatLE=function(d,f){return d=d>>>0,f||ie(d,4,this.length),t.read(this,d,!0,23,4)},a.prototype.readFloatBE=function(d,f){return d=d>>>0,f||ie(d,4,this.length),t.read(this,d,!1,23,4)},a.prototype.readDoubleLE=function(d,f){return d=d>>>0,f||ie(d,8,this.length),t.read(this,d,!0,52,8)},a.prototype.readDoubleBE=function(d,f){return d=d>>>0,f||ie(d,8,this.length),t.read(this,d,!1,52,8)};function ce(E,d,f,w,x,T){if(!a.isBuffer(E))throw new TypeError('"buffer" argument must be a Buffer instance');if(d>x||d<T)throw new RangeError('"value" argument is out of bounds');if(f+w>E.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(d,f,w,x){if(d=+d,f=f>>>0,w=w>>>0,!x){const O=Math.pow(2,8*w)-1;ce(this,d,f,w,O,0)}let T=1,A=0;for(this[f]=d&255;++A<w&&(T*=256);)this[f+A]=d/T&255;return f+w},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(d,f,w,x){if(d=+d,f=f>>>0,w=w>>>0,!x){const O=Math.pow(2,8*w)-1;ce(this,d,f,w,O,0)}let T=w-1,A=1;for(this[f+T]=d&255;--T>=0&&(A*=256);)this[f+T]=d/A&255;return f+w},a.prototype.writeUint8=a.prototype.writeUInt8=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,1,255,0),this[f]=d&255,f+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,2,65535,0),this[f]=d&255,this[f+1]=d>>>8,f+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,2,65535,0),this[f]=d>>>8,this[f+1]=d&255,f+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,4,4294967295,0),this[f+3]=d>>>24,this[f+2]=d>>>16,this[f+1]=d>>>8,this[f]=d&255,f+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,4,4294967295,0),this[f]=d>>>24,this[f+1]=d>>>16,this[f+2]=d>>>8,this[f+3]=d&255,f+4};function H(E,d,f,w,x){me(d,w,x,E,f,7);let T=Number(d&BigInt(4294967295));E[f++]=T,T=T>>8,E[f++]=T,T=T>>8,E[f++]=T,T=T>>8,E[f++]=T;let A=Number(d>>BigInt(32)&BigInt(4294967295));return E[f++]=A,A=A>>8,E[f++]=A,A=A>>8,E[f++]=A,A=A>>8,E[f++]=A,f}function we(E,d,f,w,x){me(d,w,x,E,f,7);let T=Number(d&BigInt(4294967295));E[f+7]=T,T=T>>8,E[f+6]=T,T=T>>8,E[f+5]=T,T=T>>8,E[f+4]=T;let A=Number(d>>BigInt(32)&BigInt(4294967295));return E[f+3]=A,A=A>>8,E[f+2]=A,A=A>>8,E[f+1]=A,A=A>>8,E[f]=A,f+8}a.prototype.writeBigUInt64LE=st(function(d,f=0){return H(this,d,f,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=st(function(d,f=0){return we(this,d,f,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(d,f,w,x){if(d=+d,f=f>>>0,!x){const j=Math.pow(2,8*w-1);ce(this,d,f,w,j-1,-j)}let T=0,A=1,O=0;for(this[f]=d&255;++T<w&&(A*=256);)d<0&&O===0&&this[f+T-1]!==0&&(O=1),this[f+T]=(d/A>>0)-O&255;return f+w},a.prototype.writeIntBE=function(d,f,w,x){if(d=+d,f=f>>>0,!x){const j=Math.pow(2,8*w-1);ce(this,d,f,w,j-1,-j)}let T=w-1,A=1,O=0;for(this[f+T]=d&255;--T>=0&&(A*=256);)d<0&&O===0&&this[f+T+1]!==0&&(O=1),this[f+T]=(d/A>>0)-O&255;return f+w},a.prototype.writeInt8=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,1,127,-128),d<0&&(d=255+d+1),this[f]=d&255,f+1},a.prototype.writeInt16LE=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,2,32767,-32768),this[f]=d&255,this[f+1]=d>>>8,f+2},a.prototype.writeInt16BE=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,2,32767,-32768),this[f]=d>>>8,this[f+1]=d&255,f+2},a.prototype.writeInt32LE=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,4,2147483647,-2147483648),this[f]=d&255,this[f+1]=d>>>8,this[f+2]=d>>>16,this[f+3]=d>>>24,f+4},a.prototype.writeInt32BE=function(d,f,w){return d=+d,f=f>>>0,w||ce(this,d,f,4,2147483647,-2147483648),d<0&&(d=4294967295+d+1),this[f]=d>>>24,this[f+1]=d>>>16,this[f+2]=d>>>8,this[f+3]=d&255,f+4},a.prototype.writeBigInt64LE=st(function(d,f=0){return H(this,d,f,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=st(function(d,f=0){return we(this,d,f,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Oe(E,d,f,w,x,T){if(f+w>E.length)throw new RangeError("Index out of range");if(f<0)throw new RangeError("Index out of range")}function ye(E,d,f,w,x){return d=+d,f=f>>>0,x||Oe(E,d,f,4),t.write(E,d,f,w,23,4),f+4}a.prototype.writeFloatLE=function(d,f,w){return ye(this,d,f,!0,w)},a.prototype.writeFloatBE=function(d,f,w){return ye(this,d,f,!1,w)};function qe(E,d,f,w,x){return d=+d,f=f>>>0,x||Oe(E,d,f,8),t.write(E,d,f,w,52,8),f+8}a.prototype.writeDoubleLE=function(d,f,w){return qe(this,d,f,!0,w)},a.prototype.writeDoubleBE=function(d,f,w){return qe(this,d,f,!1,w)},a.prototype.copy=function(d,f,w,x){if(!a.isBuffer(d))throw new TypeError("argument should be a Buffer");if(w||(w=0),!x&&x!==0&&(x=this.length),f>=d.length&&(f=d.length),f||(f=0),x>0&&x<w&&(x=w),x===w||d.length===0||this.length===0)return 0;if(f<0)throw new RangeError("targetStart out of bounds");if(w<0||w>=this.length)throw new RangeError("Index out of range");if(x<0)throw new RangeError("sourceEnd out of bounds");x>this.length&&(x=this.length),d.length-f<x-w&&(x=d.length-f+w);const T=x-w;return this===d&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(f,w,x):Uint8Array.prototype.set.call(d,this.subarray(w,x),f),T},a.prototype.fill=function(d,f,w,x){if(typeof d=="string"){if(typeof f=="string"?(x=f,f=0,w=this.length):typeof w=="string"&&(x=w,w=this.length),x!==void 0&&typeof x!="string")throw new TypeError("encoding must be a string");if(typeof x=="string"&&!a.isEncoding(x))throw new TypeError("Unknown encoding: "+x);if(d.length===1){const A=d.charCodeAt(0);(x==="utf8"&&A<128||x==="latin1")&&(d=A)}}else typeof d=="number"?d=d&255:typeof d=="boolean"&&(d=Number(d));if(f<0||this.length<f||this.length<w)throw new RangeError("Out of range index");if(w<=f)return this;f=f>>>0,w=w===void 0?this.length:w>>>0,d||(d=0);let T;if(typeof d=="number")for(T=f;T<w;++T)this[T]=d;else{const A=a.isBuffer(d)?d:a.from(d,x),O=A.length;if(O===0)throw new TypeError('The value "'+d+'" is invalid for argument "value"');for(T=0;T<w-f;++T)this[T+f]=A[T%O]}return this};const Ne={};function ge(E,d,f){Ne[E]=class extends f{constructor(){super(),Object.defineProperty(this,"message",{value:d.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${E}]`,this.stack,delete this.name}get code(){return E}set code(x){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:x,writable:!0})}toString(){return`${this.name} [${E}]: ${this.message}`}}}ge("ERR_BUFFER_OUT_OF_BOUNDS",function(E){return E?`${E} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ge("ERR_INVALID_ARG_TYPE",function(E,d){return`The "${E}" argument must be of type number. Received type ${typeof d}`},TypeError),ge("ERR_OUT_OF_RANGE",function(E,d,f){let w=`The value of "${E}" is out of range.`,x=f;return Number.isInteger(f)&&Math.abs(f)>2**32?x=ae(String(f)):typeof f=="bigint"&&(x=String(f),(f>BigInt(2)**BigInt(32)||f<-(BigInt(2)**BigInt(32)))&&(x=ae(x)),x+="n"),w+=` It must be ${d}. Received ${x}`,w},RangeError);function ae(E){let d="",f=E.length;const w=E[0]==="-"?1:0;for(;f>=w+4;f-=3)d=`_${E.slice(f-3,f)}${d}`;return`${E.slice(0,f)}${d}`}function he(E,d,f){fe(d,"offset"),(E[d]===void 0||E[d+f]===void 0)&&Re(d,E.length-(f+1))}function me(E,d,f,w,x,T){if(E>f||E<d){const A=typeof d=="bigint"?"n":"";let O;throw d===0||d===BigInt(0)?O=`>= 0${A} and < 2${A} ** ${(T+1)*8}${A}`:O=`>= -(2${A} ** ${(T+1)*8-1}${A}) and < 2 ** ${(T+1)*8-1}${A}`,new Ne.ERR_OUT_OF_RANGE("value",O,E)}he(w,x,T)}function fe(E,d){if(typeof E!="number")throw new Ne.ERR_INVALID_ARG_TYPE(d,"number",E)}function Re(E,d,f){throw Math.floor(E)!==E?(fe(E,f),new Ne.ERR_OUT_OF_RANGE("offset","an integer",E)):d<0?new Ne.ERR_BUFFER_OUT_OF_BOUNDS:new Ne.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${d}`,E)}const ke=/[^+/0-9A-Za-z-_]/g;function Me(E){if(E=E.split("=")[0],E=E.trim().replace(ke,""),E.length<2)return"";for(;E.length%4!==0;)E=E+"=";return E}function je(E,d){d=d||1/0;let f;const w=E.length;let x=null;const T=[];for(let A=0;A<w;++A){if(f=E.charCodeAt(A),f>55295&&f<57344){if(!x){if(f>56319){(d-=3)>-1&&T.push(239,191,189);continue}else if(A+1===w){(d-=3)>-1&&T.push(239,191,189);continue}x=f;continue}if(f<56320){(d-=3)>-1&&T.push(239,191,189),x=f;continue}f=(x-55296<<10|f-56320)+65536}else x&&(d-=3)>-1&&T.push(239,191,189);if(x=null,f<128){if((d-=1)<0)break;T.push(f)}else if(f<2048){if((d-=2)<0)break;T.push(f>>6|192,f&63|128)}else if(f<65536){if((d-=3)<0)break;T.push(f>>12|224,f>>6&63|128,f&63|128)}else if(f<1114112){if((d-=4)<0)break;T.push(f>>18|240,f>>12&63|128,f>>6&63|128,f&63|128)}else throw new Error("Invalid code point")}return T}function ze(E){const d=[];for(let f=0;f<E.length;++f)d.push(E.charCodeAt(f)&255);return d}function Ke(E,d){let f,w,x;const T=[];for(let A=0;A<E.length&&!((d-=2)<0);++A)f=E.charCodeAt(A),w=f>>8,x=f%256,T.push(x),T.push(w);return T}function Ue(E){return e.toByteArray(Me(E))}function Te(E,d,f,w){let x;for(x=0;x<w&&!(x+f>=d.length||x>=E.length);++x)d[x+f]=E[x];return x}function Ae(E,d){return E instanceof d||E!=null&&E.constructor!=null&&E.constructor.name!=null&&E.constructor.name===d.name}function Qe(E){return E!==E}const rt=(function(){const E="0123456789abcdef",d=new Array(256);for(let f=0;f<16;++f){const w=f*16;for(let x=0;x<16;++x)d[w+x]=E[f]+E[x]}return d})();function st(E){return typeof BigInt>"u"?tn:E}function tn(){throw new Error("BigInt not supported")}})(nn)),nn}var gs=ys();class Ee{static getGlobalVariable(){return typeof window<"u"?window:typeof globalThis<"u"?globalThis:global}static load(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: require("${e}").`);return""}static pathNormalize(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.normalize("${e}").`);return""}static pathExtname(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.extname("${e}").`);return""}static pathResolve(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.resolve("${e}").`);return""}static fileExist(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.existsSync("${e}").`);return!1}static dotenv(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: dotenv.config({ path: "${e}" }).`)}static getEnvVariable(e){}static readFileSync(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.readFileSync("${e}").`);return null}static appendFileSync(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.appendFileSync("${e}").`)}static writeFile(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.writeFile("${e}").`);return Promise.reject(null)}static highlightSql(e){return e}static logInfo(e,t){console.info(e+" ",t)}static logError(e,t){console.error(e+" ",t)}static logWarn(e,t){console.warn(e+" ",t)}static log(e){console.log(e)}static warn(e){return e}}Ee.type="browser";typeof window<"u"&&(window.Buffer=gs.Buffer);typeof globalThis<"u"&&(globalThis.Buffer=gs.Buffer);typeof global<"u"&&typeof require<"u"&&(global.Buffer=require("buffer/").Buffer);class oe{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(const n of t)for(const i of Object.getOwnPropertyNames(n))e[i]=n[i]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}}class C extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class Dt extends C{constructor(e){super(`Internal error. Subject ${e.metadata.targetName} must have an identifier to perform operation.`)}}class Js extends C{constructor(e){super(`Cannot create a "${e}" connection because connection to the database already established.`)}}class gt extends C{constructor(){super("Locking not supported on given driver.")}}class Ys extends C{constructor(e,t){super();const n=e.primaryColumns.reduce((i,r,s)=>(r.setEntityValue(i,s+1),i),{});this.message=`Cannot use given entity id "${t}" because "${e.targetName}" contains multiple primary columns, you must provide object in following form: ${JSON.stringify(n)} as an id.`}}class Xs extends C{constructor(e){super(`Cannot ${e}, given value must be instance of entity class, instead object literal is given. Or you must specify an entity target to method call.`)}}class gi extends C{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class Zs extends C{constructor(e){super(`Tree repositories are not supported in ${e.options.type} driver.`)}}class Es extends C{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} was not found. Did you forgot to put @EntityRepository decorator on it?`)}}class He extends C{constructor(){super("Transaction is not started yet, start transaction before committing or rolling it back.")}}class ea extends C{constructor(){super("Transaction already started for the given connection, commit current transaction before starting a new one.")}}class v{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}}class Ei extends C{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return v.isEntitySchema(e)?e.options.name:typeof e=="function"||oe.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class ta extends C{constructor(e){super(),this.message=`No metadata for "${this.stringifyTarget(e)}" was found.`}stringifyTarget(e){return v.isEntitySchema(e)?e.options.name:typeof e=="function"||oe.isObject(e)&&"name"in e?e.name:e}}class na extends C{constructor(e,t){super(`Cannot ${e}, given value must be an entity, instead "${t}" is given.`)}}class Ii extends C{constructor(e,t,n){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${n}.`)}}class Ts extends C{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class ia extends C{constructor(e){super(`Custom entity repository ${typeof e=="function"?e.name:e.constructor.name}  cannot inherit Repository class without entity being set in the @EntityRepository decorator.`)}}class bs extends C{constructor(){super("Database connection provided by a query runner was already released, cannot continue to use its querying methods anymore.")}}class Di extends C{constructor(e){super(`Cannot attach entity "${e}" to its parent. Please make sure parent is saved in the database before saving children nodes.`)}}class rn extends C{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} does not have managed entity. Did you forget to specify entity for it @EntityRepository(MyEntity)? `)}}class ra extends C{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class sa extends C{constructor(e){super(`Circular relations detected: ${e}. To resolve this issue you need to set nullable: true somewhere in this dependency structure.`)}}class Kt extends C{constructor(){super("OUTPUT or RETURNING clause only supported by PostgreSQL, MariaDB, Microsoft SqlServer or Google Spanner.")}}class aa extends C{constructor(e){super(`Entity "${e.name}" does not have a primary column. Primary column is required to have in all your entities. Use @PrimaryColumn decorator to add a primary column to your entity.`)}}class Ze extends C{constructor(e,t){super(e),Object.setPrototypeOf(this,Ze.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}}class oa extends C{constructor(e,t=[]){super(`Wrong driver: "${e}" given. Supported drivers are: ${t.map(n=>`"${n}"`).join(", ")}.`)}}class Tt extends C{constructor(e,t){super(`${e} package has not been found installed. Please run "npm install ${t}".`)}}class ca extends C{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class ua extends C{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class Ct extends C{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class la extends C{constructor(e){super(`Driver option (${e}) is not set. Please set it to perform connection to the database.`)}}class ha extends C{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class da extends C{constructor(){super("An open transaction is required for pessimistic lock.")}}class pa extends C{constructor(e,t,n){super();const i=typeof t=="string"?t:t.name;this.message=`Data type "${i}" in "${e.entityMetadata.targetName}.${e.propertyName}" is not supported by "${n}" database.`}}class ma extends C{constructor(e){super(`Array initializations are not allowed in entity relations. Please remove array initialization (= []) from "${e.entityMetadata.targetName}#${e.propertyPath}". This is ORM requirement to make relations to work properly. Refer docs for more information.`)}}class et extends C{constructor(e,t,n){if(super(n.toString().replace(/^error: /,"").replace(/^Error: /,"").replace(/^Request/,"")),this.query=e,this.parameters=t,this.driverError=n,n){const{name:i,...r}=n;oe.assign(this,{...r})}}}class fa extends C{constructor(){super("Entity manager is not using single database connection and cannot be released. Only entity managers created by connection#createEntityManagerWithSingleDatabaseConnection methods have a single database connection and they should be released.")}}class ya extends C{constructor(e){super(`Removed entity "${e.metadata.name}" is also scheduled for update operation. Make sure you are not updating and removing same object (note that update or remove may be executed by cascade operations).`)}}class Be extends C{constructor(){super("Query runner already released. Cannot run queries anymore.")}}class ga extends C{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class St extends C{constructor(e){super(`Cannot execute operation on "${e}" connection because connection is not yet established.`)}}class Ea extends C{constructor(e){super(`Option "${e}" is not set in your connection options, please define "${e}" option in your connection options or ormconfig.json`)}}class Ta extends C{constructor(e){const t=e.map(n=>`"${n.name}"`);super(`Migrations ${t.join(", ")} override the transaction mode, but the global transaction mode is "all"`)}}class qi{constructor(e){oe.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new C(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class at{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[t,n]=e.split(".");return!(!t||!n||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var sn={exports:{}},qt={exports:{}},$i;function bt(){return $i||($i=1,typeof Object.create=="function"?qt.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:qt.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}),qt.exports}var $t={exports:{}};var _i;function pt(){return _i||(_i=1,(function(p,e){var t=ys(),n=t.Buffer;function i(s,a){for(var o in s)a[o]=s[o]}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?p.exports=t:(i(t,e),e.Buffer=r);function r(s,a,o){return n(s,a,o)}r.prototype=Object.create(n.prototype),i(n,r),r.from=function(s,a,o){if(typeof s=="number")throw new TypeError("Argument must not be a number");return n(s,a,o)},r.alloc=function(s,a,o){if(typeof s!="number")throw new TypeError("Argument must be a number");var c=n(s);return a!==void 0?typeof o=="string"?c.fill(a,o):c.fill(a):c.fill(0),c},r.allocUnsafe=function(s){if(typeof s!="number")throw new TypeError("Argument must be a number");return n(s)},r.allocUnsafeSlow=function(s){if(typeof s!="number")throw new TypeError("Argument must be a number");return t.SlowBuffer(s)}})($t,$t.exports)),$t.exports}var an,Li;function ba(){if(Li)return an;Li=1;var p={}.toString;return an=Array.isArray||function(e){return p.call(e)=="[object Array]"},an}var on,Bi;function Mt(){return Bi||(Bi=1,on=TypeError),on}var cn,Ui;function ws(){return Ui||(Ui=1,cn=Object),cn}var un,Fi;function wa(){return Fi||(Fi=1,un=Error),un}var ln,ji;function Na(){return ji||(ji=1,ln=EvalError),ln}var hn,Qi;function Aa(){return Qi||(Qi=1,hn=RangeError),hn}var dn,ki;function Ca(){return ki||(ki=1,dn=ReferenceError),dn}var pn,Vi;function Ns(){return Vi||(Vi=1,pn=SyntaxError),pn}var mn,Wi;function Sa(){return Wi||(Wi=1,mn=URIError),mn}var fn,Hi;function Ra(){return Hi||(Hi=1,fn=Math.abs),fn}var yn,Gi;function Ma(){return Gi||(Gi=1,yn=Math.floor),yn}var gn,zi;function xa(){return zi||(zi=1,gn=Math.max),gn}var En,Ki;function va(){return Ki||(Ki=1,En=Math.min),En}var Tn,Ji;function Pa(){return Ji||(Ji=1,Tn=Math.pow),Tn}var bn,Yi;function Oa(){return Yi||(Yi=1,bn=Math.round),bn}var wn,Xi;function Ia(){return Xi||(Xi=1,wn=Number.isNaN||function(e){return e!==e}),wn}var Nn,Zi;function Da(){if(Zi)return Nn;Zi=1;var p=Ia();return Nn=function(t){return p(t)||t===0?t:t<0?-1:1},Nn}var An,er;function qa(){return er||(er=1,An=Object.getOwnPropertyDescriptor),An}var Cn,tr;function xt(){if(tr)return Cn;tr=1;var p=qa();if(p)try{p([],"length")}catch{p=null}return Cn=p,Cn}var Sn,nr;function Jt(){if(nr)return Sn;nr=1;var p=Object.defineProperty||!1;if(p)try{p({},"a",{value:1})}catch{p=!1}return Sn=p,Sn}var Rn,ir;function As(){return ir||(ir=1,Rn=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var e={},t=Symbol("test"),n=Object(t);if(typeof t=="string"||Object.prototype.toString.call(t)!=="[object Symbol]"||Object.prototype.toString.call(n)!=="[object Symbol]")return!1;var i=42;e[t]=i;for(var r in e)return!1;if(typeof Object.keys=="function"&&Object.keys(e).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(e).length!==0)return!1;var s=Object.getOwnPropertySymbols(e);if(s.length!==1||s[0]!==t||!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var a=Object.getOwnPropertyDescriptor(e,t);if(a.value!==i||a.enumerable!==!0)return!1}return!0}),Rn}var Mn,rr;function $a(){if(rr)return Mn;rr=1;var p=typeof Symbol<"u"&&Symbol,e=As();return Mn=function(){return typeof p!="function"||typeof Symbol!="function"||typeof p("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:e()},Mn}var xn,sr;function Cs(){return sr||(sr=1,xn=typeof Reflect<"u"&&Reflect.getPrototypeOf||null),xn}var vn,ar;function Ss(){if(ar)return vn;ar=1;var p=ws();return vn=p.getPrototypeOf||null,vn}var Pn,or;function _a(){if(or)return Pn;or=1;var p="Function.prototype.bind called on incompatible ",e=Object.prototype.toString,t=Math.max,n="[object Function]",i=function(o,c){for(var u=[],l=0;l<o.length;l+=1)u[l]=o[l];for(var h=0;h<c.length;h+=1)u[h+o.length]=c[h];return u},r=function(o,c){for(var u=[],l=c,h=0;l<o.length;l+=1,h+=1)u[h]=o[l];return u},s=function(a,o){for(var c="",u=0;u<a.length;u+=1)c+=a[u],u+1<a.length&&(c+=o);return c};return Pn=function(o){var c=this;if(typeof c!="function"||e.apply(c)!==n)throw new TypeError(p+c);for(var u=r(arguments,1),l,h=function(){if(this instanceof l){var R=c.apply(this,i(u,arguments));return Object(R)===R?R:this}return c.apply(o,i(u,arguments))},m=t(0,c.length-u.length),y=[],g=0;g<m;g++)y[g]="$"+g;if(l=Function("binder","return function ("+s(y,",")+"){ return binder.apply(this,arguments); }")(h),c.prototype){var b=function(){};b.prototype=c.prototype,l.prototype=new b,b.prototype=null}return l},Pn}var On,cr;function vt(){if(cr)return On;cr=1;var p=_a();return On=Function.prototype.bind||p,On}var In,ur;function Ti(){return ur||(ur=1,In=Function.prototype.call),In}var Dn,lr;function bi(){return lr||(lr=1,Dn=Function.prototype.apply),Dn}var qn,hr;function La(){return hr||(hr=1,qn=typeof Reflect<"u"&&Reflect&&Reflect.apply),qn}var $n,dr;function Rs(){if(dr)return $n;dr=1;var p=vt(),e=bi(),t=Ti(),n=La();return $n=n||p.call(t,e),$n}var _n,pr;function wi(){if(pr)return _n;pr=1;var p=vt(),e=Mt(),t=Ti(),n=Rs();return _n=function(r){if(r.length<1||typeof r[0]!="function")throw new e("a function is required");return n(p,t,r)},_n}var Ln,mr;function Ba(){if(mr)return Ln;mr=1;var p=wi(),e=xt(),t;try{t=[].__proto__===Array.prototype}catch(s){if(!s||typeof s!="object"||!("code"in s)||s.code!=="ERR_PROTO_ACCESS")throw s}var n=!!t&&e&&e(Object.prototype,"__proto__"),i=Object,r=i.getPrototypeOf;return Ln=n&&typeof n.get=="function"?p([n.get]):typeof r=="function"?function(a){return r(a==null?a:i(a))}:!1,Ln}var Bn,fr;function Ms(){if(fr)return Bn;fr=1;var p=Cs(),e=Ss(),t=Ba();return Bn=p?function(i){return p(i)}:e?function(i){if(!i||typeof i!="object"&&typeof i!="function")throw new TypeError("getProto: not an object");return e(i)}:t?function(i){return t(i)}:null,Bn}var Un,yr;function Ua(){if(yr)return Un;yr=1;var p=Function.prototype.call,e=Object.prototype.hasOwnProperty,t=vt();return Un=t.call(p,e),Un}var Fn,gr;function xs(){if(gr)return Fn;gr=1;var p,e=ws(),t=wa(),n=Na(),i=Aa(),r=Ca(),s=Ns(),a=Mt(),o=Sa(),c=Ra(),u=Ma(),l=xa(),h=va(),m=Pa(),y=Oa(),g=Da(),b=Function,R=function(ge){try{return b('"use strict"; return ('+ge+").constructor;")()}catch{}},P=xt(),M=Jt(),U=function(){throw new a},F=P?(function(){try{return arguments.callee,U}catch{try{return P(arguments,"callee").get}catch{return U}}})():U,J=$a()(),K=Ms(),re=Ss(),$=Cs(),Y=bi(),S=Ti(),V={},L=typeof Uint8Array>"u"||!K?p:K(Uint8Array),D={__proto__:null,"%AggregateError%":typeof AggregateError>"u"?p:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?p:ArrayBuffer,"%ArrayIteratorPrototype%":J&&K?K([][Symbol.iterator]()):p,"%AsyncFromSyncIteratorPrototype%":p,"%AsyncFunction%":V,"%AsyncGenerator%":V,"%AsyncGeneratorFunction%":V,"%AsyncIteratorPrototype%":V,"%Atomics%":typeof Atomics>"u"?p:Atomics,"%BigInt%":typeof BigInt>"u"?p:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?p:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?p:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?p:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":t,"%eval%":eval,"%EvalError%":n,"%Float16Array%":typeof Float16Array>"u"?p:Float16Array,"%Float32Array%":typeof Float32Array>"u"?p:Float32Array,"%Float64Array%":typeof Float64Array>"u"?p:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?p:FinalizationRegistry,"%Function%":b,"%GeneratorFunction%":V,"%Int8Array%":typeof Int8Array>"u"?p:Int8Array,"%Int16Array%":typeof Int16Array>"u"?p:Int16Array,"%Int32Array%":typeof Int32Array>"u"?p:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":J&&K?K(K([][Symbol.iterator]())):p,"%JSON%":typeof JSON=="object"?JSON:p,"%Map%":typeof Map>"u"?p:Map,"%MapIteratorPrototype%":typeof Map>"u"||!J||!K?p:K(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":e,"%Object.getOwnPropertyDescriptor%":P,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?p:Promise,"%Proxy%":typeof Proxy>"u"?p:Proxy,"%RangeError%":i,"%ReferenceError%":r,"%Reflect%":typeof Reflect>"u"?p:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?p:Set,"%SetIteratorPrototype%":typeof Set>"u"||!J||!K?p:K(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?p:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":J&&K?K(""[Symbol.iterator]()):p,"%Symbol%":J?Symbol:p,"%SyntaxError%":s,"%ThrowTypeError%":F,"%TypedArray%":L,"%TypeError%":a,"%Uint8Array%":typeof Uint8Array>"u"?p:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?p:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?p:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?p:Uint32Array,"%URIError%":o,"%WeakMap%":typeof WeakMap>"u"?p:WeakMap,"%WeakRef%":typeof WeakRef>"u"?p:WeakRef,"%WeakSet%":typeof WeakSet>"u"?p:WeakSet,"%Function.prototype.call%":S,"%Function.prototype.apply%":Y,"%Object.defineProperty%":M,"%Object.getPrototypeOf%":re,"%Math.abs%":c,"%Math.floor%":u,"%Math.max%":l,"%Math.min%":h,"%Math.pow%":m,"%Math.round%":y,"%Math.sign%":g,"%Reflect.getPrototypeOf%":$};if(K)try{null.error}catch(ge){var q=K(K(ge));D["%Error.prototype%"]=q}var _=function ge(ae){var he;if(ae==="%AsyncFunction%")he=R("async function () {}");else if(ae==="%GeneratorFunction%")he=R("function* () {}");else if(ae==="%AsyncGeneratorFunction%")he=R("async function* () {}");else if(ae==="%AsyncGenerator%"){var me=ge("%AsyncGeneratorFunction%");me&&(he=me.prototype)}else if(ae==="%AsyncIteratorPrototype%"){var fe=ge("%AsyncGenerator%");fe&&K&&(he=K(fe.prototype))}return D[ae]=he,he},I={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},B=vt(),W=Ua(),ee=B.call(S,Array.prototype.concat),ie=B.call(Y,Array.prototype.splice),ce=B.call(S,String.prototype.replace),H=B.call(S,String.prototype.slice),we=B.call(S,RegExp.prototype.exec),Oe=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,ye=/\\(\\)?/g,qe=function(ae){var he=H(ae,0,1),me=H(ae,-1);if(he==="%"&&me!=="%")throw new s("invalid intrinsic syntax, expected closing `%`");if(me==="%"&&he!=="%")throw new s("invalid intrinsic syntax, expected opening `%`");var fe=[];return ce(ae,Oe,function(Re,ke,Me,je){fe[fe.length]=Me?ce(je,ye,"$1"):ke||Re}),fe},Ne=function(ae,he){var me=ae,fe;if(W(I,me)&&(fe=I[me],me="%"+fe[0]+"%"),W(D,me)){var Re=D[me];if(Re===V&&(Re=_(me)),typeof Re>"u"&&!he)throw new a("intrinsic "+ae+" exists, but is not available. Please file an issue!");return{alias:fe,name:me,value:Re}}throw new s("intrinsic "+ae+" does not exist!")};return Fn=function(ae,he){if(typeof ae!="string"||ae.length===0)throw new a("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof he!="boolean")throw new a('"allowMissing" argument must be a boolean');if(we(/^%?[^%]*%?$/,ae)===null)throw new s("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var me=qe(ae),fe=me.length>0?me[0]:"",Re=Ne("%"+fe+"%",he),ke=Re.name,Me=Re.value,je=!1,ze=Re.alias;ze&&(fe=ze[0],ie(me,ee([0,1],ze)));for(var Ke=1,Ue=!0;Ke<me.length;Ke+=1){var Te=me[Ke],Ae=H(Te,0,1),Qe=H(Te,-1);if((Ae==='"'||Ae==="'"||Ae==="`"||Qe==='"'||Qe==="'"||Qe==="`")&&Ae!==Qe)throw new s("property names with quotes must have matching quotes");if((Te==="constructor"||!Ue)&&(je=!0),fe+="."+Te,ke="%"+fe+"%",W(D,ke))Me=D[ke];else if(Me!=null){if(!(Te in Me)){if(!he)throw new a("base intrinsic for "+ae+" exists, but the property is not available.");return}if(P&&Ke+1>=me.length){var rt=P(Me,Te);Ue=!!rt,Ue&&"get"in rt&&!("originalValue"in rt.get)?Me=rt.get:Me=Me[Te]}else Ue=W(Me,Te),Me=Me[Te];Ue&&!je&&(D[ke]=Me)}}return Me},Fn}var jn,Er;function vs(){if(Er)return jn;Er=1;var p=xs(),e=wi(),t=e([p("%String.prototype.indexOf%")]);return jn=function(i,r){var s=p(i,!!r);return typeof s=="function"&&t(i,".prototype.")>-1?e([s]):s},jn}var Qn,Tr;function Fa(){if(Tr)return Qn;Tr=1;var p=Function.prototype.toString,e=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,t,n;if(typeof e=="function"&&typeof Object.defineProperty=="function")try{t=Object.defineProperty({},"length",{get:function(){throw n}}),n={},e(function(){throw 42},null,t)}catch(P){P!==n&&(e=null)}else e=null;var i=/^\s*class\b/,r=function(M){try{var U=p.call(M);return i.test(U)}catch{return!1}},s=function(M){try{return r(M)?!1:(p.call(M),!0)}catch{return!1}},a=Object.prototype.toString,o="[object Object]",c="[object Function]",u="[object GeneratorFunction]",l="[object HTMLAllCollection]",h="[object HTML document.all class]",m="[object HTMLCollection]",y=typeof Symbol=="function"&&!!Symbol.toStringTag,g=!(0 in[,]),b=function(){return!1};if(typeof document=="object"){var R=document.all;a.call(R)===a.call(document.all)&&(b=function(M){if((g||!M)&&(typeof M>"u"||typeof M=="object"))try{var U=a.call(M);return(U===l||U===h||U===m||U===o)&&M("")==null}catch{}return!1})}return Qn=e?function(M){if(b(M))return!0;if(!M||typeof M!="function"&&typeof M!="object")return!1;try{e(M,null,t)}catch(U){if(U!==n)return!1}return!r(M)&&s(M)}:function(M){if(b(M))return!0;if(!M||typeof M!="function"&&typeof M!="object")return!1;if(y)return s(M);if(r(M))return!1;var U=a.call(M);return U!==c&&U!==u&&!/^\[object HTML/.test(U)?!1:s(M)},Qn}var kn,br;function ja(){if(br)return kn;br=1;var p=Fa(),e=Object.prototype.toString,t=Object.prototype.hasOwnProperty,n=function(o,c,u){for(var l=0,h=o.length;l<h;l++)t.call(o,l)&&(u==null?c(o[l],l,o):c.call(u,o[l],l,o))},i=function(o,c,u){for(var l=0,h=o.length;l<h;l++)u==null?c(o.charAt(l),l,o):c.call(u,o.charAt(l),l,o)},r=function(o,c,u){for(var l in o)t.call(o,l)&&(u==null?c(o[l],l,o):c.call(u,o[l],l,o))};function s(a){return e.call(a)==="[object Array]"}return kn=function(o,c,u){if(!p(c))throw new TypeError("iterator must be a function");var l;arguments.length>=3&&(l=u),s(o)?n(o,c,l):typeof o=="string"?i(o,c,l):r(o,c,l)},kn}var Vn,wr;function Qa(){return wr||(wr=1,Vn=["Float16Array","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"]),Vn}var Wn,Nr;function ka(){if(Nr)return Wn;Nr=1;var p=Qa(),e=typeof globalThis>"u"?Vt:globalThis;return Wn=function(){for(var n=[],i=0;i<p.length;i++)typeof e[p[i]]=="function"&&(n[n.length]=p[i]);return n},Wn}var Hn={exports:{}},Gn,Ar;function Va(){if(Ar)return Gn;Ar=1;var p=Jt(),e=Ns(),t=Mt(),n=xt();return Gn=function(r,s,a){if(!r||typeof r!="object"&&typeof r!="function")throw new t("`obj` must be an object or a function`");if(typeof s!="string"&&typeof s!="symbol")throw new t("`property` must be a string or a symbol`");if(arguments.length>3&&typeof arguments[3]!="boolean"&&arguments[3]!==null)throw new t("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&typeof arguments[4]!="boolean"&&arguments[4]!==null)throw new t("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&typeof arguments[5]!="boolean"&&arguments[5]!==null)throw new t("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&typeof arguments[6]!="boolean")throw new t("`loose`, if provided, must be a boolean");var o=arguments.length>3?arguments[3]:null,c=arguments.length>4?arguments[4]:null,u=arguments.length>5?arguments[5]:null,l=arguments.length>6?arguments[6]:!1,h=!!n&&n(r,s);if(p)p(r,s,{configurable:u===null&&h?h.configurable:!u,enumerable:o===null&&h?h.enumerable:!o,value:a,writable:c===null&&h?h.writable:!c});else if(l||!o&&!c&&!u)r[s]=a;else throw new e("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.")},Gn}var zn,Cr;function Wa(){if(Cr)return zn;Cr=1;var p=Jt(),e=function(){return!!p};return e.hasArrayLengthDefineBug=function(){if(!p)return null;try{return p([],"length",{value:1}).length!==1}catch{return!0}},zn=e,zn}var Kn,Sr;function Ha(){if(Sr)return Kn;Sr=1;var p=xs(),e=Va(),t=Wa()(),n=xt(),i=Mt(),r=p("%Math.floor%");return Kn=function(a,o){if(typeof a!="function")throw new i("`fn` is not a function");if(typeof o!="number"||o<0||o>4294967295||r(o)!==o)throw new i("`length` must be a positive 32-bit integer");var c=arguments.length>2&&!!arguments[2],u=!0,l=!0;if("length"in a&&n){var h=n(a,"length");h&&!h.configurable&&(u=!1),h&&!h.writable&&(l=!1)}return(u||l||!c)&&(t?e(a,"length",o,!0,!0):e(a,"length",o)),a},Kn}var Jn,Rr;function Ga(){if(Rr)return Jn;Rr=1;var p=vt(),e=bi(),t=Rs();return Jn=function(){return t(p,e,arguments)},Jn}var Mr;function za(){return Mr||(Mr=1,(function(p){var e=Ha(),t=Jt(),n=wi(),i=Ga();p.exports=function(s){var a=n(arguments),o=s.length-(arguments.length-1);return e(a,1+(o>0?o:0),!0)},t?t(p.exports,"apply",{value:i}):p.exports.apply=i})(Hn)),Hn.exports}var Yn,xr;function Ka(){if(xr)return Yn;xr=1;var p=As();return Yn=function(){return p()&&!!Symbol.toStringTag},Yn}var Xn,vr;function Ja(){if(vr)return Xn;vr=1;var p=ja(),e=ka(),t=za(),n=vs(),i=xt(),r=Ms(),s=n("Object.prototype.toString"),a=Ka()(),o=typeof globalThis>"u"?Vt:globalThis,c=e(),u=n("String.prototype.slice"),l=n("Array.prototype.indexOf",!0)||function(b,R){for(var P=0;P<b.length;P+=1)if(b[P]===R)return P;return-1},h={__proto__:null};a&&i&&r?p(c,function(g){var b=new o[g];if(Symbol.toStringTag in b&&r){var R=r(b),P=i(R,Symbol.toStringTag);if(!P&&R){var M=r(R);P=i(M,Symbol.toStringTag)}h["$"+g]=t(P.get)}}):p(c,function(g){var b=new o[g],R=b.slice||b.set;R&&(h["$"+g]=t(R))});var m=function(b){var R=!1;return p(h,function(P,M){if(!R)try{"$"+P(b)===M&&(R=u(M,1))}catch{}}),R},y=function(b){var R=!1;return p(h,function(P,M){if(!R)try{P(b),R=u(M,1)}catch{}}),R};return Xn=function(b){if(!b||typeof b!="object")return!1;if(!a){var R=u(s(b),8,-1);return l(c,R)>-1?R:R!=="Object"?!1:y(b)}return i?m(b):null},Xn}var Zn,Pr;function Ya(){if(Pr)return Zn;Pr=1;var p=Ja();return Zn=function(t){return!!p(t)},Zn}var ei,Or;function Xa(){if(Or)return ei;Or=1;var p=Mt(),e=vs(),t=e("TypedArray.prototype.buffer",!0),n=Ya();return ei=t||function(r){if(!n(r))throw new p("Not a Typed Array");return r.buffer},ei}var ti,Ir;function Za(){if(Ir)return ti;Ir=1;var p=pt().Buffer,e=ba(),t=Xa(),n=ArrayBuffer.isView||function(o){try{return t(o),!0}catch{return!1}},i=typeof Uint8Array<"u",r=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",s=r&&(p.prototype instanceof Uint8Array||p.TYPED_ARRAY_SUPPORT);return ti=function(o,c){if(p.isBuffer(o))return o.constructor&&!("isBuffer"in o)?p.from(o):o;if(typeof o=="string")return p.from(o,c);if(r&&n(o)){if(o.byteLength===0)return p.alloc(0);if(s){var u=p.from(o.buffer,o.byteOffset,o.byteLength);if(u.byteLength===o.byteLength)return u}var l=o instanceof Uint8Array?o:new Uint8Array(o.buffer,o.byteOffset,o.byteLength),h=p.from(l);if(h.length===o.byteLength)return h}if(i&&o instanceof Uint8Array)return p.from(o);var m=e(o);if(m)for(var y=0;y<o.length;y+=1){var g=o[y];if(typeof g!="number"||g<0||g>255||~~g!==g)throw new RangeError("Array items must be numbers in the range 0-255.")}if(m||p.isBuffer(o)&&o.constructor&&typeof o.constructor.isBuffer=="function"&&o.constructor.isBuffer(o))return p.from(o);throw new TypeError('The "data" argument must be a string, an Array, a Buffer, a Uint8Array, or a DataView.')},ti}var ni,Dr;function wt(){if(Dr)return ni;Dr=1;var p=pt().Buffer,e=Za();function t(n,i){this._block=p.alloc(n),this._finalSize=i,this._blockSize=n,this._len=0}return t.prototype.update=function(n,i){n=e(n,i||"utf8");for(var r=this._block,s=this._blockSize,a=n.length,o=this._len,c=0;c<a;){for(var u=o%s,l=Math.min(a-c,s-u),h=0;h<l;h++)r[u+h]=n[c+h];o+=l,c+=l,o%s===0&&this._update(r)}return this._len+=a,this},t.prototype.digest=function(n){var i=this._len%this._blockSize;this._block[i]=128,this._block.fill(0,i+1),i>=this._finalSize&&(this._update(this._block),this._block.fill(0));var r=this._len*8;if(r<=4294967295)this._block.writeUInt32BE(r,this._blockSize-4);else{var s=(r&4294967295)>>>0,a=(r-s)/4294967296;this._block.writeUInt32BE(a,this._blockSize-8),this._block.writeUInt32BE(s,this._blockSize-4)}this._update(this._block);var o=this._hash();return n?o.toString(n):o},t.prototype._update=function(){throw new Error("_update must be implemented by subclass")},ni=t,ni}var ii,qr;function eo(){if(qr)return ii;qr=1;var p=bt(),e=wt(),t=pt().Buffer,n=[1518500249,1859775393,-1894007588,-899497514],i=new Array(80);function r(){this.init(),this._w=i,e.call(this,64,56)}p(r,e),r.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function s(c){return c<<5|c>>>27}function a(c){return c<<30|c>>>2}function o(c,u,l,h){return c===0?u&l|~u&h:c===2?u&l|u&h|l&h:u^l^h}return r.prototype._update=function(c){for(var u=this._w,l=this._a|0,h=this._b|0,m=this._c|0,y=this._d|0,g=this._e|0,b=0;b<16;++b)u[b]=c.readInt32BE(b*4);for(;b<80;++b)u[b]=u[b-3]^u[b-8]^u[b-14]^u[b-16];for(var R=0;R<80;++R){var P=~~(R/20),M=s(l)+o(P,h,m,y)+g+u[R]+n[P]|0;g=y,y=m,m=a(h),h=l,l=M}this._a=l+this._a|0,this._b=h+this._b|0,this._c=m+this._c|0,this._d=y+this._d|0,this._e=g+this._e|0},r.prototype._hash=function(){var c=t.allocUnsafe(20);return c.writeInt32BE(this._a|0,0),c.writeInt32BE(this._b|0,4),c.writeInt32BE(this._c|0,8),c.writeInt32BE(this._d|0,12),c.writeInt32BE(this._e|0,16),c},ii=r,ii}var ri,$r;function to(){if($r)return ri;$r=1;var p=bt(),e=wt(),t=pt().Buffer,n=[1518500249,1859775393,-1894007588,-899497514],i=new Array(80);function r(){this.init(),this._w=i,e.call(this,64,56)}p(r,e),r.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function s(u){return u<<1|u>>>31}function a(u){return u<<5|u>>>27}function o(u){return u<<30|u>>>2}function c(u,l,h,m){return u===0?l&h|~l&m:u===2?l&h|l&m|h&m:l^h^m}return r.prototype._update=function(u){for(var l=this._w,h=this._a|0,m=this._b|0,y=this._c|0,g=this._d|0,b=this._e|0,R=0;R<16;++R)l[R]=u.readInt32BE(R*4);for(;R<80;++R)l[R]=s(l[R-3]^l[R-8]^l[R-14]^l[R-16]);for(var P=0;P<80;++P){var M=~~(P/20),U=a(h)+c(M,m,y,g)+b+l[P]+n[M]|0;b=g,g=y,y=o(m),m=h,h=U}this._a=h+this._a|0,this._b=m+this._b|0,this._c=y+this._c|0,this._d=g+this._d|0,this._e=b+this._e|0},r.prototype._hash=function(){var u=t.allocUnsafe(20);return u.writeInt32BE(this._a|0,0),u.writeInt32BE(this._b|0,4),u.writeInt32BE(this._c|0,8),u.writeInt32BE(this._d|0,12),u.writeInt32BE(this._e|0,16),u},ri=r,ri}var si,_r;function Ps(){if(_r)return si;_r=1;var p=bt(),e=wt(),t=pt().Buffer,n=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],i=new Array(64);function r(){this.init(),this._w=i,e.call(this,64,56)}p(r,e),r.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function s(h,m,y){return y^h&(m^y)}function a(h,m,y){return h&m|y&(h|m)}function o(h){return(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10)}function c(h){return(h>>>6|h<<26)^(h>>>11|h<<21)^(h>>>25|h<<7)}function u(h){return(h>>>7|h<<25)^(h>>>18|h<<14)^h>>>3}function l(h){return(h>>>17|h<<15)^(h>>>19|h<<13)^h>>>10}return r.prototype._update=function(h){for(var m=this._w,y=this._a|0,g=this._b|0,b=this._c|0,R=this._d|0,P=this._e|0,M=this._f|0,U=this._g|0,F=this._h|0,J=0;J<16;++J)m[J]=h.readInt32BE(J*4);for(;J<64;++J)m[J]=l(m[J-2])+m[J-7]+u(m[J-15])+m[J-16]|0;for(var K=0;K<64;++K){var re=F+c(P)+s(P,M,U)+n[K]+m[K]|0,$=o(y)+a(y,g,b)|0;F=U,U=M,M=P,P=R+re|0,R=b,b=g,g=y,y=re+$|0}this._a=y+this._a|0,this._b=g+this._b|0,this._c=b+this._c|0,this._d=R+this._d|0,this._e=P+this._e|0,this._f=M+this._f|0,this._g=U+this._g|0,this._h=F+this._h|0},r.prototype._hash=function(){var h=t.allocUnsafe(32);return h.writeInt32BE(this._a,0),h.writeInt32BE(this._b,4),h.writeInt32BE(this._c,8),h.writeInt32BE(this._d,12),h.writeInt32BE(this._e,16),h.writeInt32BE(this._f,20),h.writeInt32BE(this._g,24),h.writeInt32BE(this._h,28),h},si=r,si}var ai,Lr;function no(){if(Lr)return ai;Lr=1;var p=bt(),e=Ps(),t=wt(),n=pt().Buffer,i=new Array(64);function r(){this.init(),this._w=i,t.call(this,64,56)}return p(r,e),r.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},r.prototype._hash=function(){var s=n.allocUnsafe(28);return s.writeInt32BE(this._a,0),s.writeInt32BE(this._b,4),s.writeInt32BE(this._c,8),s.writeInt32BE(this._d,12),s.writeInt32BE(this._e,16),s.writeInt32BE(this._f,20),s.writeInt32BE(this._g,24),s},ai=r,ai}var oi,Br;function Os(){if(Br)return oi;Br=1;var p=bt(),e=wt(),t=pt().Buffer,n=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],i=new Array(160);function r(){this.init(),this._w=i,e.call(this,128,112)}p(r,e),r.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function s(g,b,R){return R^g&(b^R)}function a(g,b,R){return g&b|R&(g|b)}function o(g,b){return(g>>>28|b<<4)^(b>>>2|g<<30)^(b>>>7|g<<25)}function c(g,b){return(g>>>14|b<<18)^(g>>>18|b<<14)^(b>>>9|g<<23)}function u(g,b){return(g>>>1|b<<31)^(g>>>8|b<<24)^g>>>7}function l(g,b){return(g>>>1|b<<31)^(g>>>8|b<<24)^(g>>>7|b<<25)}function h(g,b){return(g>>>19|b<<13)^(b>>>29|g<<3)^g>>>6}function m(g,b){return(g>>>19|b<<13)^(b>>>29|g<<3)^(g>>>6|b<<26)}function y(g,b){return g>>>0<b>>>0?1:0}return r.prototype._update=function(g){for(var b=this._w,R=this._ah|0,P=this._bh|0,M=this._ch|0,U=this._dh|0,F=this._eh|0,J=this._fh|0,K=this._gh|0,re=this._hh|0,$=this._al|0,Y=this._bl|0,S=this._cl|0,V=this._dl|0,L=this._el|0,D=this._fl|0,q=this._gl|0,_=this._hl|0,I=0;I<32;I+=2)b[I]=g.readInt32BE(I*4),b[I+1]=g.readInt32BE(I*4+4);for(;I<160;I+=2){var B=b[I-30],W=b[I-30+1],ee=u(B,W),ie=l(W,B);B=b[I-4],W=b[I-4+1];var ce=h(B,W),H=m(W,B),we=b[I-14],Oe=b[I-14+1],ye=b[I-32],qe=b[I-32+1],Ne=ie+Oe|0,ge=ee+we+y(Ne,ie)|0;Ne=Ne+H|0,ge=ge+ce+y(Ne,H)|0,Ne=Ne+qe|0,ge=ge+ye+y(Ne,qe)|0,b[I]=ge,b[I+1]=Ne}for(var ae=0;ae<160;ae+=2){ge=b[ae],Ne=b[ae+1];var he=a(R,P,M),me=a($,Y,S),fe=o(R,$),Re=o($,R),ke=c(F,L),Me=c(L,F),je=n[ae],ze=n[ae+1],Ke=s(F,J,K),Ue=s(L,D,q),Te=_+Me|0,Ae=re+ke+y(Te,_)|0;Te=Te+Ue|0,Ae=Ae+Ke+y(Te,Ue)|0,Te=Te+ze|0,Ae=Ae+je+y(Te,ze)|0,Te=Te+Ne|0,Ae=Ae+ge+y(Te,Ne)|0;var Qe=Re+me|0,rt=fe+he+y(Qe,Re)|0;re=K,_=q,K=J,q=D,J=F,D=L,L=V+Te|0,F=U+Ae+y(L,V)|0,U=M,V=S,M=P,S=Y,P=R,Y=$,$=Te+Qe|0,R=Ae+rt+y($,Te)|0}this._al=this._al+$|0,this._bl=this._bl+Y|0,this._cl=this._cl+S|0,this._dl=this._dl+V|0,this._el=this._el+L|0,this._fl=this._fl+D|0,this._gl=this._gl+q|0,this._hl=this._hl+_|0,this._ah=this._ah+R+y(this._al,$)|0,this._bh=this._bh+P+y(this._bl,Y)|0,this._ch=this._ch+M+y(this._cl,S)|0,this._dh=this._dh+U+y(this._dl,V)|0,this._eh=this._eh+F+y(this._el,L)|0,this._fh=this._fh+J+y(this._fl,D)|0,this._gh=this._gh+K+y(this._gl,q)|0,this._hh=this._hh+re+y(this._hl,_)|0},r.prototype._hash=function(){var g=t.allocUnsafe(64);function b(R,P,M){g.writeInt32BE(R,M),g.writeInt32BE(P,M+4)}return b(this._ah,this._al,0),b(this._bh,this._bl,8),b(this._ch,this._cl,16),b(this._dh,this._dl,24),b(this._eh,this._el,32),b(this._fh,this._fl,40),b(this._gh,this._gl,48),b(this._hh,this._hl,56),g},oi=r,oi}var ci,Ur;function io(){if(Ur)return ci;Ur=1;var p=bt(),e=Os(),t=wt(),n=pt().Buffer,i=new Array(160);function r(){this.init(),this._w=i,t.call(this,128,112)}return p(r,e),r.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},r.prototype._hash=function(){var s=n.allocUnsafe(48);function a(o,c,u){s.writeInt32BE(o,u),s.writeInt32BE(c,u+4)}return a(this._ah,this._al,0),a(this._bh,this._bl,8),a(this._ch,this._cl,16),a(this._dh,this._dl,24),a(this._eh,this._el,32),a(this._fh,this._fl,40),s},ci=r,ci}var Fr;function ro(){return Fr||(Fr=1,(function(p){p.exports=function(t){var n=t.toLowerCase(),i=p.exports[n];if(!i)throw new Error(n+" is not supported (we accept pull requests)");return new i},p.exports.sha=eo(),p.exports.sha1=to(),p.exports.sha224=no(),p.exports.sha256=Ps(),p.exports.sha384=io(),p.exports.sha512=Os()})(sn)),sn.exports}var so=ro();const ao=ms(so);function ui(p,e=!1){return e&&(p=" "+p),p.replace(/^([A-Z])|[\s-_](\w)/g,function(t,n,i){return i?i.toUpperCase():n.toLowerCase()})}function jr(p){return p.replace(/([A-Z])([A-Z])([a-z])/g,"$1_$2$3").replace(/([a-z0-9])([A-Z])/g,"$1_$2").toLowerCase()}function oo(p){return p.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}function Is(p,e={}){const{segmentLength:t=4,separator:n="__",termLength:i=2}=e;return p.split(n).reduce((a,o)=>{const c=o.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),u=c.length>1?i:t,l=c.map(h=>h.substr(0,u)).join("");return a.push(l),a},[]).join(n)}function co(p,e={}){const t=ao("sha1");t.update(p,"utf8");const n=t.digest("hex");return e.length&&e.length>0?n.slice(0,e.length):n}class uo{static isGreaterOrEqual(e,t){if(!e)return!1;const n=Qr(e),i=Qr(t);for(let r=0;r<n.length&&r<i.length;r++){if(n[r]>i[r])return!0;if(n[r]<i[r])return!1}return!0}}function Qr(p){return p.split(".").map(e=>parseInt(e,10))}class k{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return uo.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){const n=this.parseConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const i of Object.keys(n))typeof n[i]>"u"&&delete n[i];return Object.assign({},e,n)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){const n=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const i of Object.keys(n))typeof n[i]>"u"&&delete n[i];return Object.assign({},e,n)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...n){const i=t&&t.joiner?t.joiner:"_",r=n.length===1?n[0]:n.join(i);if(e&&e>0&&r.length>e){if(t&&t.shorten===!0){const s=Is(r);if(s.length<e)return s}return co(r,{length:e})}return r}static buildColumnAlias({maxAliasLength:e},t,...n){return typeof t=="string"?(n.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...n)}static parseConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),i=e.substr(n+2),r=i.indexOf("/"),s=r!==-1?i.substr(0,r):i;let a=r!==-1?i.substr(r+1):void 0;a&&a.indexOf("?")!==-1&&(a=a.substr(0,a.indexOf("?")));const o=s.lastIndexOf("@"),c=s.substr(0,o),u=s.substr(o+1);let l=c,h="";const m=c.indexOf(":");m!==-1&&(l=c.substr(0,m),h=c.substr(m+1));const[y,g]=u.split(":");return{type:t,host:y,username:decodeURIComponent(l),password:decodeURIComponent(h),port:g?parseInt(g):void 0,database:a||void 0}}static parseMongoDBConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),i=e.substr(n+2),r=i.indexOf("/"),s=r!==-1?i.substr(0,r):i;let a=r!==-1?i.substr(r+1):void 0,o="",c,u,l,h;const m={};if(a&&a.indexOf("?")!==-1){o=a.substr(a.indexOf("?")+1,a.length);const F=o.split("&");let J,K;F.forEach(re=>{J=re.split("=")[0],K=re.split("=")[1],m[J]=K}),h=m.replicaSet,a=a.substr(0,a.indexOf("?"))}const y=s.lastIndexOf("@"),g=s.substr(0,y),b=s.substr(y+1);let R=g,P="";const M=g.indexOf(":");M!==-1&&(R=g.substr(0,M),P=g.substr(M+1)),h?l=b:[c,u]=b.split(":");const U={type:t,host:c,hostReplicaSet:l,username:decodeURIComponent(R),password:decodeURIComponent(P),port:u?parseInt(u):void 0,database:a||void 0};for(const[F,J]of Object.entries(m))U[F]=J;return U}}class Ds{constructor(e,t,n){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,n&&oe.assign(this,n)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){const e=()=>{for(const t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(n=>t.selection===this.alias.name+"."+n.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(at.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(at.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){const e=()=>{if(!at.isAliasProperty(this.entityOrProperty))return;const t=this.queryExpressionMap.findAliasByName(this.parentAlias);let n=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(n||t.metadata.parentEntityMetadata&&(n=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),n))return n;throw new C(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new C("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new C("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?k.buildAlias(this.connection.driver,void 0,e,this.alias.name):k.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class Ni{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,oe.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!at.isAliasProperty(this.relationName))throw new C("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!at.isAliasProperty(this.relationName))throw new C("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!at.isAliasProperty(this.relationName))throw new C("Given value must be a string representation of alias property");const t=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!t)throw new C(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return t}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class Ai{constructor(e,t){this.expressionMap=e,oe.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!at.isAliasProperty(this.relationName))throw new C("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!at.isAliasProperty(this.relationName))throw new C("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!at.isAliasProperty(this.relationName))throw new C("Given value is a string representation of alias property");const[e,t]=this.relationName.split("."),i=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!i)throw new C(`Relation with property path ${t} in entity was not found.`);return i}get metadata(){if(!at.isAliasProperty(this.relationName))throw new C("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class Ci{constructor(e){this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=e.options?.timeTravelQueries||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,n)=>(t[this.mainAlias.name+"."+n]=e[n],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);const n=new qi;return n.type=e.type,t&&(n.name=t),e.metadata&&(n.metadata=e.metadata),e.target&&!n.hasMetadata&&(n.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(n.tablePath=e.tablePath),e.subQuery&&(n.subQuery=e.subQuery),this.aliases.push(n),n}findAliasByName(e){const t=this.aliases.find(n=>n.name===e);if(!t)throw new C(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){const[t,n]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(n)}get relationMetadata(){if(!this.mainAlias)throw new C("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new C(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new Ci(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new qi(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new Ds(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new Ni(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new Ai(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.useIndex=this.useIndex,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}}class Wt{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class De{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((i,r)=>r.from(i),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((n,i)=>i.to(n),t):e.to(t)}}class Pt{constructor(e,t,n=!0,i=!1,r,s){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=n,this._multipleParameters=i,this._getSql=r,this._objectLiteralParameters=s}get useParameter(){return v.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return v.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return v.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return v.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(v.isFindOperator(this._value))return this._value}get getSql(){return v.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof Pt?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&De.transformTo(e,t)):De.transformTo(e,this._value)}}function lo(p){return new Pt("in",p,!0,!0)}const ho=/[.*+\-?^${}()|[\]\\]/g,po=p=>p.replace(ho,"\\$&");class ve{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,v.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new Ci(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){ve.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new C("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(n=>({selection:n})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),v.isSelectQueryBuilder(this)?this:ve.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",v.isInsertQueryBuilder(this)?this:ve.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){const n=t||e;if(e=v.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const i=this.createFromAlias(e);this.expressionMap.setMainAlias(i)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=n,v.isUpdateQueryBuilder(this)?this:ve.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",v.isDeleteQueryBuilder(this)?this:ve.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",v.isSoftDeleteQueryBuilder(this)?this:ve.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",v.isSoftDeleteQueryBuilder(this)?this:ve.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){const n=arguments.length===2?e:void 0,i=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=i,n){const r=this.createFromAlias(n);this.expressionMap.setMainAlias(r)}return v.isRelationQueryBuilder(this)?this:ve.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){const n=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(r=>!!n.findRelationWithPropertyPath(r))}hasParameter(e){return this.parentQueryBuilder?.hasParameter(e)||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new C(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new C("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(const[t,n]of Object.entries(e))this.setParameter(t,n);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){const n=t.childEntityMetadatas.filter(i=>i.discriminatorColumn).map(i=>i.discriminatorValue);n.push(t.discriminatorValue),e.discriminatorColumnValues=n}}return e}printSql(){const[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();try{return await n.query(e,t)}finally{n!==this.queryRunner&&await n.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,n){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:n||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new C('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){const n=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:n.tablePath})}else{if(typeof e=="string"){const r=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:r?void 0:e,subQuery:r?e:void 0})}const n=e(this.subQuery());this.setParameters(n.getParameters());const i=n.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:i})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const t={};for(const r of this.expressionMap.aliases){if(!r.hasMetadata)continue;const s=this.expressionMap.aliasNamePrefixingEnabled&&r.name?`${r.name}.`:"";t[s]||(t[s]={});for(const a of r.metadata.relations)a.joinColumns.length>0&&(t[s][a.propertyPath]=a.joinColumns[0].databaseName);for(const a of r.metadata.relations){const o=[...a.joinColumns,...a.inverseJoinColumns];for(const c of o){const u=`${a.propertyPath}.${c.referencedColumn.propertyPath}`;t[s][u]=c.databaseName}}for(const a of r.metadata.columns)t[s][a.databaseName]=a.databaseName;for(const a of r.metadata.columns)t[s][a.propertyName]=a.databaseName;for(const a of r.metadata.columns)t[s][a.propertyPath]=a.databaseName}const n=Object.keys(t),i=n.map(r=>po(r)).join("|");return n.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${i?"("+i+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...r)=>{let s,a,o;if(i){if(s=r[0],a=r[1],o=r[3],t[r[2]][o])return`${a}${this.escape(r[2].substring(0,r[2].length-1))}.${this.escape(t[r[2]][o])}`}else if(s=r[0],a=r[1],o=r[2],t[""][o])return`${a}${this.escape(t[""][o])}`;return s})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){const i=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&i.deleteDateColumn){const r=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.deleteDateColumn.propertyName:i.deleteDateColumn.propertyName,s=`${this.replacePropertyNames(r)} IS NULL`;e.push(s)}if(i.discriminatorColumn&&i.parentEntityMetadata){const r=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.discriminatorColumn.databaseName:i.discriminatorColumn.databaseName,s=`${this.replacePropertyNames(r)} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){const i=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(i)}let n="";return n+=this.createTimeTravelQuery(),e.length?e.length===1?n+=` WHERE ${e[0]}`:n+=` WHERE ( ${e.join(" ) AND ( ")} )`:n+="",n}createReturningExpression(e){const t=this.getReturningColumns(),n=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&n.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(i=>t.indexOf(i)===-1)),t.length){let i=t.map(r=>{const s=this.escape(r.databaseName);return n.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+s:this.escape(this.getMainTableName())+"."+s:s}).join(", ");return n.options.type==="oracle"&&(i+=" INTO "+t.map(r=>this.createParameter({type:n.columnTypeToNativeParameter(r.type),dir:n.oracle.BIND_OUT})).join(", ")),n.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(i+=" INTO @OutputTable"),i}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,n)=>{const i=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(n>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(n>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`}return i}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:n}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return n.options.type==="postgres"||n.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return n.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${Pt.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(n=>{let i=typeof n.queryBuilder=="string"?n.queryBuilder:"";if(typeof n.queryBuilder!="string"){if(n.queryBuilder.hasCommonTableExpressions())throw new C(`Nested CTEs aren't supported (CTE: ${n.alias})`);if(i=n.queryBuilder.getQuery(),!this.connection.driver.cteCapabilities.writable&&!v.isSelectQueryBuilder(n.queryBuilder))throw new C(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${n.alias})`);this.setParameters(n.queryBuilder.getParameters())}let r=this.escape(n.alias);if(n.options.columnNames){const o=n.options.columnNames.map(c=>this.escape(c));if(v.isSelectQueryBuilder(n.queryBuilder)&&n.queryBuilder.expressionMap.selects.length&&n.options.columnNames.length!==n.queryBuilder.expressionMap.selects.length)throw new C(`cte.options.columnNames length (${n.options.columnNames.length}) doesn't match subquery select list length ${n.queryBuilder.expressionMap.selects.length} (CTE: ${n.alias})`);r+=`(${o.join(", ")})`}const s=n.options.recursive&&e?"RECURSIVE":"";let a="";return this.connection.driver.cteCapabilities.materializedHint&&n.options.materialized!==void 0&&(a=n.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[s,r,"AS",a,`(${i})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const t=this.expressionMap.mainAlias.metadata,n=(Array.isArray(e)?e:[e]).map(i=>t.ensureEntityIdMap(i));if(!t.hasMultiplePrimaryKeys){const i=t.primaryColumns[0];if(!i.transformer&&!i.relationMetadata&&!i.embeddedMetadata)return{[i.propertyName]:lo(n.map(r=>i.getEntityValue(r,!1)))}}return new Wt(i=>{for(const r of n)i.orWhere(new Wt(s=>s.where(r)))})}getExistsCondition(e){const t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias;const n=[],i=e.split(".");for(;i.length>1;){const a=i[0];if(!t?.hasMetadata)break;if(t.metadata.hasEmbeddedWithPropertyPath(a)){i.unshift(`${i.shift()}.${i.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(a)){const o=this.expressionMap.joinAttributes.find(c=>c.relationPropertyPath===a);if(!o?.alias){const c=n.length>0?`${n.join(".")}.${a}`:a;throw new Error(`Cannot find alias for relation at ${c}`)}t=o.alias,n.push(...a.split(".")),i.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);const r=i.join("."),s=t.metadata.findColumnsWithPropertyPath(r);if(!s.length)throw new Ze(e,t.metadata);return[t,n,s]}createPropertyPath(e,t,n=""){const i=[];for(const r of Object.keys(t)){const s=n?`${n}.${r}`:r;if(t[r]===null||typeof t[r]!="object"||v.isFindOperator(t[r])){i.push(s);continue}if(e.hasEmbeddedWithPropertyPath(s)){const a=this.createPropertyPath(e,t[r],s);i.push(...a);continue}if(e.hasRelationWithPropertyPath(s)){const a=e.findRelationWithPropertyPath(s);if(a.relationType==="one-to-one"||a.relationType==="many-to-one"){const l=a.joinColumns.map(m=>m.referencedColumn).filter(m=>!!m);if(l.length>0&&l.every(m=>m.getEntityValue(t[r],!1))){i.push(s);continue}}if(a.relationType==="one-to-many"||a.relationType==="many-to-many")throw new Error(`Cannot query across ${a.relationType} for property ${s}`);const o=a.inverseEntityMetadata.primaryColumns;if(o.length>0&&o.every(l=>l.getEntityValue(t[r],!1))){const l=o.map(h=>`${s}.${h.propertyPath}`);i.push(...l);continue}const u=this.createPropertyPath(a.inverseEntityMetadata,t[r]).map(l=>`${s}.${l}`);i.push(...u);continue}i.push(s)}return i}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const n of t){const[i,r,s]=this.findColumnsForPropertyPath(n);for(const a of s){let o=e;for(const l of r){if(!o||!(l in o)){o={};break}o=o[l]}const c=this.expressionMap.aliasNamePrefixingEnabled?`${i.name}.${a.propertyPath}`:a.propertyPath,u=a.getEntityValue(o,!0);yield[c,u]}}}else for(const t of Object.keys(e)){const n=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,n]}}getWherePredicateCondition(e,t){if(v.isFindOperator(t)){const n=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(const i of t.value)n.push(this.createParameter(i));else n.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...n]};if(t.type==="and"){const i=t.value;return{operator:t.type,parameters:i.map(r=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,r)))}}else if(t.type==="or"){const i=t.value;return{operator:t.type,parameters:i.map(r=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,r)))}}else return{operator:t.type,parameters:[e,...n]}}else if(t===null){const n=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(n==="sql-null")return{operator:"isNull",parameters:[e]};if(n==="throw")throw new C(`Null value encountered in property '${e}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}else if(t===void 0&&(this.connection.options.invalidWhereValuesBehavior?.undefined||"ignore")==="throw")throw new C(`Undefined value encountered in property '${e}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(v.isBrackets(e)){const i=this.createQueryBuilder();return i.parentQueryBuilder=this,i.expressionMap.mainAlias=this.expressionMap.mainAlias,i.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,i.expressionMap.parameters=this.expressionMap.parameters,i.expressionMap.nativeParameters=this.expressionMap.nativeParameters,i.expressionMap.wheres=[],e.whereFactory(i),{operator:v.isNotBrackets(e)?"not":"brackets",condition:i.expressionMap.wheres}}if(typeof e=="function")return e(this);const t=Array.isArray(e)?e:[e],n=[];for(const i of t){const r=[];for(const[s,a]of this.getPredicates(i))r.push({type:"and",condition:this.getWherePredicateCondition(s,a)});n.push({type:"or",condition:r})}return n.length===1?n[0].condition:n}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}ve.queryBuilderRegistry={};class mo{static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class fo extends ve{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),i=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const r=await n.query(e,t,!0),s=mo.from(r);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),i&&await n.commitTransaction(),s}catch(r){if(i)try{await n.rollbackTransaction()}catch{}throw r}finally{n!==this.queryRunner&&await n.release()}}from(e,t){e=v.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new Kt;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),n=this.createReturningExpression("delete");return n===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${n}${t}`:this.connection.driver.options.type==="spanner"?`DELETE FROM ${e}${t} THEN RETURN ${n}`:`DELETE FROM ${e}${t} RETURNING ${n}`}}const $e=[];for(let p=0;p<256;++p)$e.push((p+256).toString(16).slice(1));function yo(p,e=0){return($e[p[e+0]]+$e[p[e+1]]+$e[p[e+2]]+$e[p[e+3]]+"-"+$e[p[e+4]]+$e[p[e+5]]+"-"+$e[p[e+6]]+$e[p[e+7]]+"-"+$e[p[e+8]]+$e[p[e+9]]+"-"+$e[p[e+10]]+$e[p[e+11]]+$e[p[e+12]]+$e[p[e+13]]+$e[p[e+14]]+$e[p[e+15]]).toLowerCase()}let li;const go=new Uint8Array(16);function Eo(){if(!li){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");li=crypto.getRandomValues.bind(crypto)}return li(go)}const To=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),kr={randomUUID:To};function qs(p,e,t){if(kr.randomUUID&&!p)return kr.randomUUID();p=p||{};const n=p.random??p.rng?.()??Eo();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,yo(n)}class Ge{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class Vr{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.raw,t}}class Si{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){const n=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(i,r)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((o,c,u)=>(o[this.expressionMap.extraReturningColumns[u].databaseName]=c[0],o),{}));const s=Array.isArray(e.raw)?e.raw[r]:e.raw,a=this.queryRunner.connection.driver.createGeneratedMap(n,s);a&&(this.queryRunner.manager.merge(n.target,i,a),e.generatedMaps.push(a))}else{const s=this.expressionMap.extraReturningColumns;if(s.length>0){const a=this.expressionMap.mainAlias.metadata.getEntityIdMap(i);if(!a)throw new C("Cannot update entity because entity id is not set in the entity.");const o=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(c=>n.targetName+"."+c.propertyPath)).addSelect(s.map(c=>n.targetName+"."+c.propertyPath)).from(n.target,n.targetName).where(a).withDeleted().setOption("create-pojo").getOne();o&&(this.queryRunner.manager.merge(n.target,i,o),e.generatedMaps.push(o))}}}))}async insert(e,t){const n=this.expressionMap.mainAlias.metadata;let i=n.getInsertionReturningColumns();const r=this.queryRunner.connection.driver.isReturningSqlSupported("insert");i=i.filter(a=>a.isGenerated?r===!0:!0);const s=t.map((a,o)=>{Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(this.queryRunner.connection.driver.options.type==="oracle"?e.raw=e.raw.reduce((l,h,m)=>(l[this.expressionMap.extraReturningColumns[m].databaseName]=h[0],l),{}):this.queryRunner.connection.driver.options.type==="spanner"&&(e.raw=e.raw[0]));const c=Array.isArray(e.raw)?e.raw[o]:e.raw,u=this.queryRunner.connection.driver.createGeneratedMap(n,c,o,t.length)||{};return o in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(n.target,u,this.expressionMap.locallyGenerated[o]),this.queryRunner.manager.merge(n.target,a,u),u});if(i.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const a=t.map(c=>{const u=n.getEntityIdMap(c);if(!u)throw new C("Cannot update entity because entity id is not set in the entity.");return u}),o=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(c=>n.targetName+"."+c.propertyPath)).addSelect(i.map(c=>n.targetName+"."+c.propertyPath)).from(n.target,n.targetName).where(a).setOption("create-pojo").getMany();t.forEach((c,u)=>{this.queryRunner.manager.merge(n.target,s[u],o[u]),this.queryRunner.manager.merge(n.target,c,o[u])})}t.forEach((a,o)=>{const c=n.getEntityIdMap(a);e.identifiers.push(c),e.generatedMaps.push(s[o])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class bo extends ve{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new Vr;const t=this.obtainQueryRunner();let n=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const y=new Ge;e.forEach(g=>{t.broadcaster.broadcastBeforeInsertEvent(y,this.expressionMap.mainAlias.metadata,g)}),await y.wait()}let i=null,r=null;const s=new Si(t,this.expressionMap),a=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const y of this.expressionMap.returning)a.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(y));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),a.push(...this.expressionMap.extraReturningColumns.filter(y=>!a.includes(y)))),a.length>0&&this.connection.driver.options.type==="mssql"&&(i=this.connection.driver.buildTableVariableDeclaration("@OutputTable",a),r="SELECT * FROM @OutputTable");const[o,c]=this.getQueryAndParameters(),l=[i,o,r].filter(y=>y!=null).join(`;

`),h=await t.query(l,c,!0),m=Vr.from(h);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.insert(m,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const y=new Ge;e.forEach(g=>{t.broadcaster.broadcastAfterInsertEvent(y,this.expressionMap.mainAlias.metadata,g)}),await y.wait()}return n&&await t.commitTransaction(),m}catch(i){if(n)try{await t.rollbackTransaction()}catch{}throw i}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=v.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e);return this.expressionMap.setMainAlias(n),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new Kt;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,n){const{where:i,parameters:r}=n?.overwriteCondition??{};let s;if(i){const a=this.getWhereCondition(i);(Array.isArray(a)?a.length!==0:a)&&(s=[{type:"simple",condition:a}])}return r&&this.setParameters(r),Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:n?.skipUpdateIfNoValuesChanged,indexPredicate:n?.indexPredicate,upsertType:n?.upsertType,overwriteCondition:s},this):(this.expressionMap.onUpdate={conflict:e?.conflict_target,columns:e?.columns,overwrite:e?.overwrite,skipUpdateIfNoValuesChanged:n?.skipUpdateIfNoValuesChanged,upsertType:n?.upsertType,overwriteCondition:s},this)}createInsertExpression(){if((this.expressionMap.onUpdate||this.expressionMap.onIgnore)&&(this.expressionMap.onUpdate?.upsertType??"merge-into")==="merge-into"&&this.connection.driver.supportedUpsertTypes.includes("merge-into"))return this.createMergeExpression();const e=this.getTableName(this.getMainTableName()),t=this.alias!==this.getMainTableName()?this.escape(this.alias):e,n=this.createValuesExpression(),i=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),r=this.createColumnNamesExpression();let s="INSERT ";if(this.expressionMap.onUpdate?.upsertType==="primary-key"&&(s="UPSERT "),(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),s+=`INTO ${e}`,this.alias!==this.getMainTableName()&&k.isPostgresFamily(this.connection.driver)&&(s+=` AS "${this.alias}"`),r?s+=`(${r})`:!n&&(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s+="()"),i&&this.connection.driver.options.type==="mssql"&&(s+=` OUTPUT ${i}`),n?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?s+=` ${n}`:s+=` VALUES ${n}`:k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?s+=" VALUES ()":s+=" DEFAULT VALUES",this.expressionMap.onUpdate?.upsertType!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)s+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)s+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:a,columns:o,conflict:c,skipUpdateIfNoValuesChanged:u,indexPredicate:l}=this.expressionMap.onUpdate;let h="ON CONFLICT";if(Array.isArray(c)){if(h+=` ( ${c.map(y=>this.escape(y)).join(", ")} )`,l&&!k.isPostgresFamily(this.connection.driver))throw new C("indexPredicate option is not supported by the current database driver");l&&k.isPostgresFamily(this.connection.driver)&&(h+=` WHERE ( ${l} )`)}else c&&(h+=` ON CONSTRAINT ${this.escape(c)}`);const m=[];if(Array.isArray(a)?m.push(...a.map(y=>`${this.escape(y)} = EXCLUDED.${this.escape(y)}`)):o&&m.push(...o.map(y=>`${this.escape(y)} = :${y}`)),m.length>0&&(s+=` ${h} DO UPDATE SET `,m.push(...this.expressionMap.mainAlias.metadata.columns.filter(y=>y.isUpdateDate&&!a?.includes(y.databaseName)&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||k.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(y=>`${this.escape(y.databaseName)} = DEFAULT`)),s+=m.join(", ")),Array.isArray(a)&&u){this.expressionMap.onUpdate.overwriteCondition??=[];const y=a.map(g=>({type:"or",condition:`${t}.${this.escape(g)} IS DISTINCT FROM EXCLUDED.${this.escape(g)}`}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:y})}k.isPostgresFamily(this.connection.driver)&&this.expressionMap.onUpdate.overwriteCondition&&this.expressionMap.onUpdate.overwriteCondition.length>0&&(s+=` WHERE ${this.createUpsertConditionExpression()}`)}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:a,columns:o}=this.expressionMap.onUpdate;Array.isArray(a)?(s+=" ON DUPLICATE KEY UPDATE ",s+=a.map(c=>`${this.escape(c)} = VALUES(${this.escape(c)})`).join(", "),s+=" "):Array.isArray(o)&&(s+=" ON DUPLICATE KEY UPDATE ",s+=o.map(c=>`${this.escape(c)} = :${c}`).join(", "),s+=" ")}}else if(this.expressionMap.onUpdate)throw new C("onUpdate is not supported by the current database driver")}return i&&(k.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||k.isMySQLFamily(this.connection.driver))&&(s+=` RETURNING ${i}`),i&&this.connection.driver.options.type==="spanner"&&(s+=` THEN RETURN ${i}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(a=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(a.propertyPath)!==-1:a.isInsert).some(a=>this.isOverridingAutoIncrementBehavior(a))&&(s=`SET IDENTITY_INSERT ${e} ON; ${s}; SET IDENTITY_INSERT ${e} OFF`),s}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!k.isSQLiteFamily(this.connection.driver)&&!k.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(n=>this.escape(n)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){const e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let n="";return e.forEach((i,r)=>{t.forEach((s,a)=>{a===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?n+=" SELECT ":n+="("),n+=this.createColumnValueExpression(e,r,s),a===t.length-1?r===e.length-1?["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?n+=" FROM "+this.connection.driver.dummyTableName:n+=")":["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?n+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":n+="), ":n+=", "})}),n==="()"?"":n}else{let n="";return e.forEach((i,r)=>{Object.keys(i).forEach((a,o)=>{o===0&&(n+="(");const c=i[a];typeof c=="function"?n+=c():c===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||k.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n+="NULL":n+="DEFAULT":c===null&&this.connection.driver.options.type==="spanner"||(n+=this.createParameter(c)),o===Object.keys(i).length-1?r===e.length-1?n+=")":n+="), ":n+=", "})}),n==="()"?"":n}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(oe.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new ua}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}createMergeExpression(){if(!this.connection.driver.supportedUpsertTypes.includes("merge-into"))throw new C('Upsert type "merge-into" is not supported by current database driver');if(this.expressionMap.onUpdate?.upsertType&&this.expressionMap.onUpdate.upsertType!=="merge-into")throw new C(`Upsert type "${this.expressionMap.onUpdate.upsertType}" is not supported by current database driver`);const e=this.getTableName(this.getMainTableName()),t=this.escape(this.alias),n=this.getInsertedColumns(),i=this.createColumnNamesExpression();let r=`MERGE INTO ${e} ${this.escape(this.alias)}`;const s=this.escape("mergeIntoSource"),a=this.createMergeIntoSourceExpression(s);if(r+=` ${a}`,this.expressionMap.onIgnore){const u=n.find(l=>l.isPrimary);u?r+=` ON (${t}.${this.escape(u.databaseName)} = ${s}.${this.escape(u.databaseName)})`:r+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(l=>`(${l.columns.map(h=>`${t}.${this.escape(h.databaseName)} = ${s}.${this.escape(h.databaseName)}`).join(" AND ")})`).join(" OR ")})`}else if(this.expressionMap.onUpdate){const{conflict:u,indexPredicate:l}=this.expressionMap.onUpdate;if(l)throw new C('indexPredicate option is not supported by upsert type "merge-into"');Array.isArray(u)?r+=` ON (${u.map(h=>`${t}.${this.escape(h)} = ${s}.${this.escape(h)}`).join(" AND ")})`:u?r+=` ON (${t}.${this.escape(u)} = ${s}.${this.escape(u)})`:r+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(h=>`(${h.columns.map(m=>`${t}.${this.escape(m.databaseName)} = ${s}.${this.escape(m.databaseName)}`).join(" AND ")})`).join(" OR ")})`}if(this.expressionMap.onUpdate){const{overwrite:u,columns:l,conflict:h,skipUpdateIfNoValuesChanged:m}=this.expressionMap.onUpdate;let y="";if(Array.isArray(u)&&(y+=(u||l)?.filter(b=>!h?.includes(b)).map(b=>`${t}.${this.escape(b)} = ${s}.${this.escape(b)}`).join(", ")),Array.isArray(u)&&m){this.expressionMap.onUpdate.overwriteCondition??=[];const b=u.map(R=>({type:"or",condition:{operator:"notEqual",parameters:[`${t}.${this.escape(R)}`,`${s}.${this.escape(R)}`]}}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:b})}const g=this.createUpsertConditionExpression();y.trim()&&((this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap")&&g!=""?r+=` WHEN MATCHED AND ${g} THEN UPDATE SET ${y}`:(r+=` WHEN MATCHED THEN UPDATE SET ${y}`,g!=""&&(r+=` WHERE ${g}`)))}const o=this.createMergeIntoInsertValuesExpression(s),c=this.connection.driver.options.type==="mssql"?this.createReturningExpression("insert"):null;return r+=" WHEN NOT MATCHED THEN INSERT",i&&(r+=`(${i})`),o&&(r+=` VALUES ${o}`),c&&this.connection.driver.options.type==="mssql"&&(r+=` OUTPUT ${c}`),this.connection.driver.options.type==="mssql"&&(r+=";"),r}createMergeIntoSourceExpression(e){const t=this.getValueSets(),n=this.getInsertedColumns();let i="USING (";if(n.length>0)this.connection.driver.options.type==="mssql"&&(i+="VALUES "),t.forEach((r,s)=>{n.forEach((a,o)=>{o===0&&(this.connection.driver.options.type==="mssql"?i+="(":i+="SELECT ");const c=a.getEntityValue(r);c===void 0&&!(a.isGenerated&&a.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported())?a.default!==void 0&&a.default!==null?i+=this.connection.driver.normalizeDefault(a):i+="NULL":c===null?i+="NULL":i+=this.createColumnValueExpression(t,s,a),this.connection.driver.options.type!=="mssql"&&(i+=` AS ${this.escape(a.databaseName)}`),o===n.length-1?s===t.length-1?["oracle","sap"].includes(this.connection.driver.options.type)?i+=" FROM "+this.connection.driver.dummyTableName:this.connection.driver.options.type==="mssql"&&(i+=")"):["oracle","sap"].includes(this.connection.driver.options.type)&&t.length>1?i+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":this.connection.driver.options.type==="mssql"?i+="), ":i+=" UNION ALL ":i+=", "})});else throw new C('Upsert type "merge-into" is not supported without metadata tables');return i+=`) ${e}`,this.connection.driver.options.type==="mssql"&&(i+=` (${n.map(r=>this.escape(r.databaseName)).join(", ")})`),i}createMergeIntoInsertValuesExpression(e){const t=this.getInsertedColumns();let n="";if(t.length>0)t.forEach((i,r)=>{r===0&&(n+="("),i.isGenerated&&i.generationStrategy==="uuid"&&this.connection.driver.isUUIDGenerationSupported()||i.isGenerated&&i.generationStrategy!=="uuid"?n+="DEFAULT":n+=`${e}.${this.escape(i.databaseName)}`,r===t.length-1?n+=")":n+=", "});else throw new C('Upsert type "merge-into" is not supported without metadata tables');return n==="()"?"":n}createUpsertConditionExpression(){if(!this.expressionMap.onUpdate.overwriteCondition)return"";const e=[],t=this.createWhereClausesExpression(this.expressionMap.onUpdate.overwriteCondition);if(t.length>0&&t!=="1=1"&&e.push(t),this.expressionMap.mainAlias.hasMetadata){const i=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&i.deleteDateColumn){const s=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.deleteDateColumn.propertyName:i.deleteDateColumn.propertyName} IS NULL`;e.push(s)}if(i.discriminatorColumn&&i.parentEntityMetadata){const s=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.discriminatorColumn.databaseName:i.discriminatorColumn.databaseName} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){const i=this.expressionMap.extraAppendedAndWhereCondition;e.push(i)}let n="";return e.length?e.length===1?n+=`${e[0]}`:n+=`( ${e.join(" ) AND ( ")} )`:n+="",n}createColumnValueExpression(e,t,n){const i=e[t];let r="",s=n.getEntityValue(i);if(typeof s!="function"&&(s=this.connection.driver.preparePersistentValue(s,n)),n.isVersion&&s===void 0)r+="1";else if(n.isDiscriminator)r+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(n.isGenerated&&n.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&s===void 0)s=qs(),r+=this.createParameter(s),t in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[t]={}),n.setEntityValue(this.expressionMap.locallyGenerated[t],s);else if(s===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||k.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n.default!==void 0&&n.default!==null?r+=this.connection.driver.normalizeDefault(n):this.connection.driver.options.type==="spanner"&&n.isGenerated&&n.generationStrategy==="uuid"?r+="GENERATE_UUID()":r+="NULL":r+="DEFAULT";else if(s===null&&(this.connection.driver.options.type==="spanner"||this.connection.driver.options.type==="oracle"))r+="NULL";else if(typeof s=="function")r+=s();else{this.connection.driver.options.type==="mssql"&&(s=this.connection.driver.parametrizeValue(n,s));const a=this.createParameter(s);if((k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.includes(n.type)){const c=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";n.srid!=null?r+=`${c}(${a}, ${n.srid})`:r+=`${c}(${a})`}else k.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.includes(n.type)?n.srid!=null?r+=`ST_SetSRID(ST_GeomFromGeoJSON(${a}), ${n.srid})::${n.type}`:r+=`ST_GeomFromGeoJSON(${a})::${n.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.includes(n.type)?r+=n.type+"::STGeomFromText("+a+", "+(n.srid||"0")+")":r+=a}return r}}class Wr{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){const t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){const n=t.joinColumns.reduce((i,r)=>{const s=oe.isObject(e)?r.referencedColumn.getEntityValue(e):e;return r.setEntityValue(i,s),i},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(n).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){const n={};t.inverseRelation.joinColumns.forEach(o=>{n[o.propertyName]=null});const i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],r={},s=[];i.forEach((o,c)=>{t.inverseRelation.joinColumns.map((u,l)=>{const h="joinColumn_"+c+"_"+l;r[h]=oe.isObject(o)?u.referencedColumn.getEntityValue(o):o,s.push(`${u.propertyPath} = :${h}`)})});const a=s.map(o=>"("+o+")").join(" OR ");if(!a)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).where(a).setParameters(r).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new C("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const n=this.expressionMap.of,i=t.inverseRelation.joinColumns.reduce((r,s)=>{const a=oe.isObject(n)?s.referencedColumn.getEntityValue(n):n;return s.setEntityValue(r,a),r},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).whereInIds(e).execute()}else{const n=t.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],r=Array.isArray(e)?e:[e],s=t.isManyToManyOwner?i:r,a=t.isManyToManyOwner?r:i,o=[];if(s.forEach(c=>{a.forEach(u=>{const l={};n.ownerColumns.forEach(h=>{l[h.databaseName]=oe.isObject(c)?h.referencedColumn.getEntityValue(c):c}),n.inverseColumns.forEach(h=>{l[h.databaseName]=oe.isObject(u)?h.referencedColumn.getEntityValue(u):u}),o.push(l)})}),!o.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(o.map(c=>this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(c).execute())):await this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(o).execute()}}}class wo{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){const t=this.expressionMap.relationMetadata;if(t.isOneToMany){const n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],r={};t.inverseRelation.joinColumns.forEach(c=>{r[c.propertyName]=null});const s={},a=[];n.forEach((c,u)=>{a.push(...i.map((l,h)=>[...t.inverseRelation.joinColumns.map((m,y)=>{const g="joinColumn_"+u+"_"+h+"_"+y;return s[g]=oe.isObject(c)?m.referencedColumn.getEntityValue(c):c,`${m.propertyPath} = :${g}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((m,y)=>{const g="primaryColumn_"+h+"_"+h+"_"+y;return s[g]=oe.isObject(l)?m.getEntityValue(l):l,`${m.propertyPath} = :${g}`})].join(" AND ")))});const o=a.map(c=>"("+c+")").join(" OR ");if(!o)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(r).where(o).setParameters(s).execute()}else{const n=t.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],r=Array.isArray(e)?e:[e],s=t.isManyToManyOwner?i:r,a=t.isManyToManyOwner?r:i,o={},c=[];s.forEach((l,h)=>{c.push(...a.map((m,y)=>[...n.ownerColumns.map((g,b)=>{const R="firstValue_"+h+"_"+y+"_"+b;return o[R]=oe.isObject(l)?g.referencedColumn.getEntityValue(l):l,`${g.databaseName} = :${R}`}),...n.inverseColumns.map((g,b)=>{const R="secondValue_"+h+"_"+y+"_"+b;return o[R]=oe.isObject(m)?g.referencedColumn.getEntityValue(m):m,`${g.databaseName} = :${R}`})].join(" AND ")))});const u=c.map(l=>"("+l+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(n.tableName).where(u).setParameters(o).execute()}}}class No extends ve{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new C("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new C(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!oe.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new C('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Wr(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new C("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new C(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!oe.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new C('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Wr(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new C("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new C(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new wo(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!oe.isObject(e)){const t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new C("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class Q{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(n,i)=>e.slice(i*t,i*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((n,i)=>{const r=t(i);let s=n.find(a=>a.id===r);return s||(s={id:r,items:[]},n.push(s)),s.items.push(i),n},[])}static uniq(e,t){return e.reduce((n,i)=>{let r=!1;if(typeof t=="function"){const s=t(i);r=!!n.find(a=>t(a)===s)}else typeof t=="string"?r=!!n.find(s=>s[t]===i[t]):r=n.indexOf(i)!==-1;return r||n.push(i),n},[])}static mergeDeep(e,...t){if(!t.length)return e;for(const n of t)Q.merge(e,n);return e}static cloneObject(e){return e==null?e:Object.assign(Object.create(Object.getPrototypeOf(e)),e)}static deepCompare(...e){let t,n,i,r;if(e.length<1)return!0;for(t=1,n=e.length;t<n;t++)if(i=[],r=[],!Q.compare2Objects(i,r,e[0],e[t]))return!1;return!0}static deepValue(e,t){const n=t.split(".");for(let i=0,r=n.length;i<r;i++)e=e[n[i]];return e}static replaceEmptyObjectsWithBooleans(e){for(const t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:Q.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){const t={};for(const n of e){const i=n.split(".");if(!i.length)continue;(!t[i[0]]||t[i[0]]===!0)&&(t[i[0]]={});let r=t[i[0]];for(const[s,a]of i.entries())s!==0&&(r[a]?r=r[a]:s===i.length-1?(r[a]={},r=null):(r[a]={},r=r[a]))}return Q.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:Q.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(n=>t.includes(n))}static areMutuallyExclusive(...e){return!e.some(n=>{const i=e.filter(r=>r!==n);return n.some(r=>i.some(s=>s.includes(r)))})}static parseSqlCheckExpression(e,t){const n=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(n&&n.index){const r=e.substring(n.index+n[0].length);let s="",a="";const o=[];for(let c=0;c<r.length;c++){const u=r[c];switch(u){case",":s==""?(o.push(a),a=""):a+=u;break;case"'":s==u?r[c+1]===u?(a+=u,c+=1):s="":s=u;break;case")":if(s=="")return o.push(a),o;a+=u;break;default:s!=""&&(a+=u)}}}}static isCriteriaNullOrEmpty(e){return e==null||e===""||Array.isArray(e)&&e.length===0||Q.isPlainObject(e)&&Object.keys(e).length===0}static isSinglePrimitiveCriteria(e){return typeof e=="string"||typeof e=="number"||e instanceof Date}static isPrimitiveCriteria(e){return Array.isArray(e)?e.every(t=>Q.isSinglePrimitiveCriteria(t)):Q.isSinglePrimitiveCriteria(e)}static compare2Objects(e,t,n,i){let r;if(Number.isNaN(n)&&Number.isNaN(i)||n===i)return!0;if(n===null||i===null||n===void 0||i===void 0)return!1;if((typeof n.equals=="function"||typeof n.equals=="function")&&n.equals(i))return!0;if(typeof n=="function"&&typeof i=="function"||n instanceof Date&&i instanceof Date||n instanceof RegExp&&i instanceof RegExp||typeof n=="string"&&typeof i=="string"||typeof n=="number"&&typeof i=="number")return n.toString()===i.toString();if(!(typeof n=="object"&&typeof i=="object")||Object.prototype.isPrototypeOf.call(n,i)||Object.prototype.isPrototypeOf.call(i,n)||n.constructor!==i.constructor||n.prototype!==i.prototype||e.indexOf(n)>-1||t.indexOf(i)>-1)return!1;for(r in i){if(i.hasOwnProperty(r)!==n.hasOwnProperty(r))return!1;if(typeof i[r]!=typeof n[r])return!1}for(r in n){if(i.hasOwnProperty(r)!==n.hasOwnProperty(r))return!1;if(typeof i[r]!=typeof n[r])return!1;switch(typeof n[r]){case"object":case"function":if(e.push(n),t.push(i),!Q.compare2Objects(e,t,n[r],i[r]))return!1;e.pop(),t.pop();break;default:if(n[r]!==i[r])return!1;break}}return!0}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,n,i){if(i.has(n)){e[t]=i.get(n);return}if(!(n instanceof Promise)){if(!Q.isPlainObject(n)&&!Array.isArray(n)){e[t]=n;return}e[t]||(e[t]=Array.isArray(n)?[]:{}),i.set(n,e[t]),Q.merge(e[t],n,i),i.delete(n)}}static mergeObjectKey(e,t,n,i){if(i.has(n)){Object.assign(e,{[t]:i.get(n)});return}if(!(n instanceof Promise)){if(!Q.isPlainObject(n)&&!Array.isArray(n)){Object.assign(e,{[t]:n});return}e[t]||Object.assign(e,{[t]:Array.isArray(n)?[]:{}}),i.set(n,e[t]),Q.merge(e[t],n,i),i.delete(n)}}static merge(e,t,n=new Map){if(Q.isPlainObject(e)&&Q.isPlainObject(t))for(const[i,r]of Object.entries(t))i!=="__proto__"&&Q.mergeObjectKey(e,i,r,n);if(Array.isArray(e)&&Array.isArray(t))for(let i=0;i<t.length;i++)Q.mergeArrayKey(e,i,t[i],n)}}class Ao{constructor(e,t,n,i,r){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=n,this.rawRelationCountResults=i,this.queryRunner=r,this.pojo=this.expressionMap.options.includes("create-pojo"),this.selections=new Set(this.expressionMap.selects.map(s=>s.selection)),this.aliasCache=new Map,this.columnsCache=new Map}transform(e,t){const n=this.group(e,t),i=[];for(const r of n.values()){const s=this.transformRawResultsGroup(r,t);s!==void 0&&i.push(s)}return i}buildAlias(e,t){let n=this.aliasCache.get(e);n||(n=new Map,this.aliasCache.set(e,n));let i=n.get(t);return i||(i=k.buildAlias(this.driver,void 0,e,t),n.set(t,i)),i}group(e,t){const n=new Map,i=[];t.metadata.tableType==="view"?i.push(...t.metadata.columns.map(r=>this.buildAlias(t.name,r.databaseName))):i.push(...t.metadata.primaryColumns.map(r=>this.buildAlias(t.name,r.databaseName)));for(const r of e){const s=i.map(o=>{const c=r[o];return Buffer.isBuffer(c)?c.toString("hex"):oe.isObject(c)?JSON.stringify(c):c}).join("_"),a=n.get(s);a?a.push(r):n.set(s,[r])}return n}transformRawResultsGroup(e,t){let n=t.metadata;if(n.discriminatorColumn){const u=e.map(h=>h[this.buildAlias(t.name,t.metadata.discriminatorColumn.databaseName)]),l=n.childEntityMetadatas.find(h=>typeof u.find(m=>m===h.discriminatorValue)<"u");l&&(n=l)}const i=n.create(this.queryRunner,{fromDeserializer:!0,pojo:this.pojo}),r=this.transformColumns(e,t,i,n),s=this.transformJoins(e,i,t,n),a=this.transformRelationIds(e,t,i,n),o=this.transformRelationCounts(e,t,i);if(r||n.primaryColumns.every(u=>u.isVirtual===!0)&&(s||a||o))return i}transformColumns(e,t,n,i){let r=!1;const s=e[0];for(const[a,o]of this.getColumnsToProcess(t.name,i)){const c=s[a];c!==void 0&&(c!==null&&!o.isVirtualProperty&&(r=!0),o.setEntityValue(n,this.driver.prepareHydratedValue(c,o)))}return r}transformJoins(e,t,n,i){let r=!1;for(const s of this.expressionMap.joinAttributes){if(!s.metadata||!s.isSelected||s.relation&&!i.relations.find(o=>o===s.relation))continue;if(s.mapToProperty){if(s.mapToPropertyParentAlias!==n.name)continue}else if(!s.relation||s.parentAlias!==n.name||s.relationPropertyPath!==s.relation.propertyPath)continue;let a=this.transform(e,s.alias);a=s.isMany?a:a[0],a=!s.isMany&&a===void 0?null:a,a!==void 0&&(s.mapToPropertyPropertyName?t[s.mapToPropertyPropertyName]=a:s.relation.setEntityValue(t,a),r=!0)}return r}transformRelationIds(e,t,n,i){let r=!1;for(const[s,a]of this.rawRelationIdResults.entries()){if(a.relationIdAttribute.parentAlias!==t.name)continue;const o=a.relationIdAttribute.relation,c=this.createValueMapFromJoinColumns(o,a.relationIdAttribute.parentAlias,e);if(c==null)continue;this.prepareDataForTransformRelationIds();const u=this.hashEntityIds(o,c),l=this.relationIdMaps[s][u]||[],h=a.relationIdAttribute.mapToPropertyPropertyPath.split("."),m=(y,g,b)=>{const R=y.shift();if(R&&y.length===0)return g[R]=b,g;if(R&&y.length>0)m(y,g[R],b);else return g};o.isOneToOne||o.isManyToOne?l[0]!==void 0&&(m(h,n,l[0]),r=!0):(m(h,n,l),r=r||l.length>0)}return r}transformRelationCounts(e,t,n){let i=!1;for(const r of this.rawRelationCountResults){if(r.relationCountAttribute.parentAlias!==t.name)continue;const s=r.relationCountAttribute.relation;let a;s.isOneToMany?a=s.inverseRelation.joinColumns[0].referencedColumn.databaseName:a=s.isOwning?s.joinColumns[0].referencedColumn.databaseName:s.inverseRelation.joinColumns[0].referencedColumn.databaseName;const o=e[0][this.buildAlias(t.name,a)];if(o!=null){n[r.relationCountAttribute.mapToPropertyPropertyName]=0;for(const c of r.results)c.parentId===o&&(n[r.relationCountAttribute.mapToPropertyPropertyName]=parseInt(c.cnt),i=!0)}}return i}getColumnsToProcess(e,t){let n=this.columnsCache.get(e);n||(n=new Map,this.columnsCache.set(e,n));let i=n.get(t);return i||(i=t.columns.filter(r=>!r.isVirtual&&(this.selections.has(e)||this.selections.has(`${e}.${r.propertyPath}`))&&!t.childEntityMetadatas.some(s=>s.target===r.target)).map(r=>[this.buildAlias(e,r.databaseName),r]),n.set(t,i)),i}createValueMapFromJoinColumns(e,t,n){let i;return e.isManyToOne||e.isOneToOneOwner?i=e.entityMetadata.primaryColumns.map(r=>r):e.isOneToMany||e.isOneToOneNotOwner?i=e.inverseRelation.joinColumns.map(r=>r):e.isOwning?i=e.joinColumns.map(r=>r):i=e.inverseRelation.inverseJoinColumns.map(r=>r),i.reduce((r,s)=>{for(const a of n)e.isManyToOne||e.isOneToOneOwner?r[s.databaseName]=this.driver.prepareHydratedValue(a[this.buildAlias(t,s.databaseName)],s):r[s.databaseName]=this.driver.prepareHydratedValue(a[this.buildAlias(t,s.referencedColumn.databaseName)],s.referencedColumn);return r},{})}extractEntityPrimaryIds(e,t){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?n=e.joinColumns.map(i=>i):n=e.inverseRelation.inverseJoinColumns.map(i=>i),n.reduce((i,r)=>(i[r.databaseName]=t[r.databaseName],i),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const t=e.relationIdAttribute.relation;let n;return t.isManyToOne||t.isOneToOneOwner?n=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?n=t.inverseEntityMetadata.primaryColumns:t.isOwning?n=t.inverseJoinColumns:n=t.inverseRelation.joinColumns,e.results.reduce((i,r)=>{let s=n.reduce((a,o)=>{let c=r[o.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(o.isVirtual&&o.referencedColumn&&o.referencedColumn.propertyName!==o.propertyName&&(c=o.referencedColumn.createValueMap(c)),Q.mergeDeep(a,o.createValueMap(c))):(!o.isPrimary&&o.referencedColumn.referencedColumn&&(c=o.referencedColumn.referencedColumn.createValueMap(c)),Q.mergeDeep(a,o.referencedColumn.createValueMap(c)))},{});if(n.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?s=n[0].getEntityValue(s):s=n[0].referencedColumn.getEntityValue(s)),s!==void 0){const a=this.hashEntityIds(t,r);i[a]?i[a].push(s):i[a]=[s]}return i},{})}))}hashEntityIds(e,t){const n=this.extractEntityPrimaryIds(e,t);return JSON.stringify(n)}}let Co=class{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationIdAttributes=n}async load(e){const t=this.relationIdAttributes.map(async n=>{if(n.relation.isManyToOne||n.relation.isOneToOneOwner){if(n.queryBuilderFactory)throw new C("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const i={},r=e.map(s=>{const a={},o=[];n.relation.joinColumns.forEach(u=>{a[u.databaseName]=this.connection.driver.prepareHydratedValue(s[k.buildAlias(this.connection.driver,void 0,n.parentAlias,u.databaseName)],u.referencedColumn);const l=`${u.databaseName}:${a[u.databaseName]}`;o.indexOf(l)===-1&&o.push(l)}),n.relation.entityMetadata.primaryColumns.forEach(u=>{a[u.databaseName]=this.connection.driver.prepareHydratedValue(s[k.buildAlias(this.connection.driver,void 0,n.parentAlias,u.databaseName)],u);const l=`${u.databaseName}:${a[u.databaseName]}`;o.indexOf(l)===-1&&o.push(l)}),o.sort();const c=o.join("::");return i[c]?null:(i[c]=!0,a)}).filter(s=>s);return{relationIdAttribute:n,results:r}}else if(n.relation.isOneToMany||n.relation.isOneToOneNotOwner){const i=n.relation,r=i.isOwning?i.joinColumns:i.inverseRelation.joinColumns,s=i.inverseEntityMetadata.target,a=i.inverseEntityMetadata.tableName,o=n.alias||a,c={},u={},l=e.map((g,b)=>{const R=[],P={},M=r.map(F=>{const J=F.databaseName+b,K=g[k.buildAlias(this.connection.driver,void 0,n.parentAlias,F.referencedColumn.databaseName)],re=`${o}:${F.propertyPath}:${K}`;return R.indexOf(re)!==-1?"":(R.push(re),P[J]=K,o+"."+F.propertyPath+" = :"+J)}).filter(F=>F).join(" AND ");R.sort();const U=R.join("::");return c[U]?"":(c[U]=!0,Object.assign(u,P),M)}).filter(g=>g).map(g=>"("+g+")").join(" OR ");if(!l)return{relationIdAttribute:n,results:[]};const h=this.connection.createQueryBuilder(this.queryRunner);Q.uniq([...r,...i.inverseRelation.entityMetadata.primaryColumns],g=>g.propertyPath).forEach(g=>{h.addSelect(o+"."+g.propertyPath,g.databaseName)}),h.from(s,o).where("("+l+")").setParameters(u),n.queryBuilderFactory&&n.queryBuilderFactory(h);const y=await h.getRawMany();return y.forEach(g=>{r.forEach(b=>{g[b.databaseName]=this.connection.driver.prepareHydratedValue(g[b.databaseName],b.referencedColumn)}),i.inverseRelation.entityMetadata.primaryColumns.forEach(b=>{g[b.databaseName]=this.connection.driver.prepareHydratedValue(g[b.databaseName],b)})}),{relationIdAttribute:n,results:y}}else{const i=n.relation,r=i.isOwning?i.joinColumns:i.inverseRelation.inverseJoinColumns,s=i.isOwning?i.inverseJoinColumns:i.inverseRelation.joinColumns,a=n.junctionAlias,o=n.joinInverseSideMetadata.tableName,c=n.alias||o,u=i.isOwning?i.junctionEntityMetadata.tableName:i.inverseRelation.junctionEntityMetadata.tableName,l=e.map(M=>r.reduce((U,F)=>(U[F.propertyPath]=M[k.buildAlias(this.connection.driver,void 0,n.parentAlias,F.referencedColumn.databaseName)],U),{}));if(l.length===0)return{relationIdAttribute:n,results:[]};const h={},m={},y=l.map((M,U)=>{const F=[],J={},K=Object.keys(M).map($=>{const Y=$+U,S=M[$],V=`${a}:${$}:${S}`;return F.indexOf(V)!==-1?"":(F.push(V),J[Y]=S,a+"."+$+" = :"+Y)}).filter($=>$).join(" AND ");F.sort();const re=F.join("::");return m[re]?"":(m[re]=!0,Object.assign(h,J),K)}).filter(M=>M),g=s.map(M=>a+"."+M.propertyPath+" = "+c+"."+M.referencedColumn.propertyPath).join(" AND "),b=y.map(M=>"("+M+" AND "+g+")").join(" OR "),R=this.connection.createQueryBuilder(this.queryRunner);s.forEach(M=>{R.addSelect(a+"."+M.propertyPath,M.databaseName).addOrderBy(a+"."+M.propertyPath)}),r.forEach(M=>{R.addSelect(a+"."+M.propertyPath,M.databaseName).addOrderBy(a+"."+M.propertyPath)}),R.from(o,c).innerJoin(u,a,b).setParameters(h),n.queryBuilderFactory&&n.queryBuilderFactory(R);const P=await R.getRawMany();return P.forEach(M=>{[...r,...s].forEach(U=>{M[U.databaseName]=this.connection.driver.prepareHydratedValue(M[U.databaseName],U.referencedColumn)})}),{relationIdAttribute:n,results:P}}});return Promise.all(t)}};class $s{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,n){const i=Array.isArray(t)?t:[t],r=Array.isArray(n)?n:n?[n]:void 0;return e.isManyToMany?this.loadForManyToMany(e,i,r):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,i,r):this.loadForOneToManyAndOneToOneNotOwner(e,i,r)}async loadManyToManyRelationIdsAndGroup(e,t,n,i){const r=e.isManyToMany||e.isOneToMany,s=Array.isArray(t)?t:[t];if(!n&&(n=await this.connection.relationLoader.load(e,t,this.queryRunner,i),!n.length))return s.map(l=>({entity:l,related:r?[]:void 0}));const a=await this.load(e,t,n),o=Array.isArray(n)?n:[n];let c=[],u=[];return e.isManyToManyOwner?(c=e.junctionEntityMetadata.inverseColumns.map(l=>l.referencedColumn),u=e.junctionEntityMetadata.ownerColumns.map(l=>l.referencedColumn)):e.isManyToManyNotOwner?(c=e.junctionEntityMetadata.ownerColumns.map(l=>l.referencedColumn),u=e.junctionEntityMetadata.inverseColumns.map(l=>l.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(c=e.joinColumns.map(l=>l.referencedColumn),u=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(c=e.inverseRelation.entityMetadata.primaryColumns,u=e.inverseRelation.joinColumns.map(l=>l.referencedColumn)),s.map(l=>{const h={entity:l,related:r?[]:void 0},m=a.filter(y=>u.every(g=>g.compareEntityValue(l,y[g.entityMetadata.name+"_"+g.propertyAliasName])));return m.length&&o.forEach(y=>{m.forEach(g=>{c.every(R=>R.compareEntityValue(y,g[k.buildAlias(this.connection.driver,void 0,R.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+R.propertyPath.replace(".","_"))]))&&(r?h.related.push(y):h.related=y)})}),h})}loadForManyToMany(e,t,n){const i=e.junctionEntityMetadata,r=i.name,s=e.isOwning?i.ownerColumns:i.inverseColumns,a=e.isOwning?i.inverseColumns:i.ownerColumns,o=this.connection.createQueryBuilder(this.queryRunner);s.forEach(h=>{const m=k.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+h.referencedColumn.propertyPath.replace(".","_"));o.addSelect(r+"."+h.propertyPath,m)}),a.forEach(h=>{const m=k.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_"));o.addSelect(r+"."+h.propertyPath,m)});let c="";if(s.length===1){const h=t.map(y=>s[0].referencedColumn.getEntityValue(y));h.every(y=>typeof y=="number")?c=`${r}.${s[0].propertyPath} IN (${h.join(", ")})`:(o.setParameter("values1",h),c=r+"."+s[0].propertyPath+" IN (:...values1)")}else c="("+t.map((h,m)=>s.map(y=>{const g="entity1_"+m+"_"+y.propertyName;return o.setParameter(g,y.referencedColumn.getEntityValue(h)),r+"."+y.propertyPath+" = :"+g}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";let u="";if(n)if(a.length===1){const h=n.map(y=>a[0].referencedColumn.getEntityValue(y));h.every(y=>typeof y=="number")?u=`${r}.${a[0].propertyPath} IN (${h.join(", ")})`:(o.setParameter("values2",h),u=r+"."+a[0].propertyPath+" IN (:...values2)")}else u="("+n.map((h,m)=>a.map(y=>{const g="entity2_"+m+"_"+y.propertyName;return o.setParameter(g,y.referencedColumn.getEntityValue(h)),r+"."+y.propertyPath+" = :"+g}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";const l=[c,u].filter(h=>h.length>0).join(" AND ");return o.from(i.target,r).where(l).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,n){const i=e.entityMetadata.targetName,r=e.joinColumns.every(o=>!!e.entityMetadata.nonVirtualColumns.find(c=>c===o));if(n&&r){const o=[];if(t.forEach(c=>{const u={};e.entityMetadata.primaryColumns.forEach(l=>{const h=l.entityMetadata.name+"_"+l.propertyPath.replace(".","_");u[h]=l.getEntityValue(c)}),n.forEach(l=>{e.joinColumns.forEach(h=>{const m=h.getEntityValue(c),y=h.referencedColumn.getEntityValue(l);if(!(m===void 0||y===void 0)&&m===y){const g=h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_");u[g]=y}})}),Object.keys(u).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&o.push(u)}),o.length===t.length)return Promise.resolve(o)}const s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(o=>{const c=k.buildAlias(this.connection.driver,void 0,o.entityMetadata.name+"_"+o.propertyPath.replace(".","_"));s.addSelect(i+"."+o.propertyPath,c)}),e.joinColumns.forEach(o=>{const c=k.buildAlias(this.connection.driver,void 0,o.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+o.referencedColumn.propertyPath.replace(".","_"));s.addSelect(i+"."+o.propertyPath,c)});let a="";if(e.entityMetadata.primaryColumns.length===1){const o=t.map(u=>e.entityMetadata.primaryColumns[0].getEntityValue(u));o.every(u=>typeof u=="number")?a=`${i}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${o.join(", ")})`:(s.setParameter("values",o),a=i+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else a=t.map((o,c)=>e.entityMetadata.primaryColumns.map((u,l)=>{const h="entity"+c+"_"+l;return s.setParameter(h,u.getEntityValue(o)),i+"."+u.propertyPath+" = :"+h}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return s.from(e.entityMetadata.target,i).where(a).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,n){const i=e;if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(c=>e.joinColumns.indexOf(c)!==-1))return Promise.resolve(t.map(c=>{const u={};return e.joinColumns.forEach(function(l){const h=l.referencedColumn.getEntityValue(c),m=l.referencedColumn.entityMetadata.name+"_"+l.referencedColumn.propertyPath.replace(".","_"),y=l.entityMetadata.name+"_"+i.propertyPath.replace(".","_")+"_"+l.propertyPath.replace(".","_");u[m]=h,u[y]=h}),u}));const r=e.entityMetadata.targetName,s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(o=>{const c=k.buildAlias(this.connection.driver,void 0,o.entityMetadata.name+"_"+i.propertyPath.replace(".","_")+"_"+o.propertyPath.replace(".","_"));s.addSelect(r+"."+o.propertyPath,c)}),e.joinColumns.forEach(o=>{const c=k.buildAlias(this.connection.driver,void 0,o.referencedColumn.entityMetadata.name+"_"+o.referencedColumn.propertyPath.replace(".","_"));s.addSelect(r+"."+o.propertyPath,c)});let a="";if(e.joinColumns.length===1){const o=t.map(u=>e.joinColumns[0].referencedColumn.getEntityValue(u));o.every(u=>typeof u=="number")?a=`${r}.${e.joinColumns[0].propertyPath} IN (${o.join(", ")})`:(s.setParameter("values",o),a=r+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else a=t.map((o,c)=>e.joinColumns.map((u,l)=>{const h="entity"+c+"_"+l;return s.setParameter(h,u.referencedColumn.getEntityValue(o)),r+"."+u.propertyPath+" = :"+h}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return s.from(e.entityMetadata.target,r).where(a).getRawMany()}}class So{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(n)})})}metadataToAttribute(e,t){return new Ni(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class Ro{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationCountAttributes=n}async load(e){const t=(i,r,s)=>s.indexOf(i)===r,n=this.relationCountAttributes.map(async i=>{if(i.relation.isOneToMany){const r=i.relation,s=r.inverseRelation,a=s.joinColumns[0].referencedColumn.propertyName,o=r.inverseEntityMetadata.target,c=r.inverseEntityMetadata.tableName,u=i.alias||c,l=s.propertyName;let h=e.map(y=>y[i.parentAlias+"_"+a]).filter(y=>!!y);if(h=h.filter(t),h.length===0)return{relationCountAttribute:i,results:[]};const m=this.connection.createQueryBuilder(this.queryRunner);return m.select(u+"."+l,"parentId").addSelect("COUNT(*)","cnt").from(o,u).where(u+"."+l+" IN (:...ids)").addGroupBy(u+"."+l).setParameter("ids",h),i.queryBuilderFactory&&i.queryBuilderFactory(m),{relationCountAttribute:i,results:await m.getRawMany()}}else{let r,s,a,o;i.relation.isOwning?(r=i.relation.joinColumns[0].referencedColumn.databaseName,s=i.relation.inverseJoinColumns[0].referencedColumn.databaseName,a=i.relation.junctionEntityMetadata.columns[0],o=i.relation.junctionEntityMetadata.columns[1]):(r=i.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,s=i.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,a=i.relation.junctionEntityMetadata.columns[1],o=i.relation.junctionEntityMetadata.columns[0]);let c=e.map(b=>b[i.parentAlias+"_"+r]).filter(b=>!!b);if(c=c.filter(t),c.length===0)return{relationCountAttribute:i,results:[]};const u=i.junctionAlias,l=i.joinInverseSideMetadata.tableName,h=i.alias||l,m=i.relation.junctionEntityMetadata.tableName,y=u+"."+a.propertyName+" IN ("+c.map(b=>isNaN(b)?"'"+b+"'":b)+") AND "+u+"."+o.propertyName+" = "+h+"."+s,g=this.connection.createQueryBuilder(this.queryRunner);return g.select(u+"."+a.propertyName,"parentId").addSelect("COUNT("+g.escape(h)+"."+g.escape(s)+")","cnt").from(l,h).innerJoin(m,u,y).addGroupBy(u+"."+a.propertyName),i.queryBuilderFactory&&i.queryBuilderFactory(g),{relationCountAttribute:i,results:await g.getRawMany()}}});return Promise.all(n)}}class Mo{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(n)})})}metadataToAttribute(e,t){return new Ai(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class _e{static isFindOneOptions(e){const t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){const t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t?.relations){const n=[...t.relations];if(_e.applyRelationsRecursively(e,n,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),n.length>0)throw new ha(n)}return e}static applyRelationsRecursively(e,t,n,i,r){let s=[];if(r){const a=new RegExp("^"+r.replace(".","\\.")+"\\.");s=t.filter(o=>o.match(a)).map(o=>i.findRelationWithPropertyPath(o.replace(a,""))).filter(o=>o)}else s=t.map(a=>i.findRelationWithPropertyPath(a)).filter(a=>a);s.forEach(a=>{const o=k.buildAlias(e.connection.driver,{joiner:"__"},n,a.propertyPath),c=n+"."+a.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(a):e.leftJoinAndSelect(c,o),t.splice(t.indexOf(r?r+"."+a.propertyPath:a.propertyPath),1);let u,l;if(e.expressionMap.relationLoadStrategy==="query")u=a.inverseEntityMetadata,l=o;else{const h=e.expressionMap.joinAttributes.find(m=>m.entityOrProperty===c);u=h.metadata,l=h.alias.name}if(!l||!u)throw new Ze(a.propertyPath,i);if(this.applyRelationsRecursively(e,t,l,u,r?r+"."+a.propertyPath:a.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const h=i.relations.find(m=>m.propertyName===a.propertyPath);h&&this.joinEagerRelations(e,o,h.inverseEntityMetadata)}})}static joinEagerRelations(e,t,n){n.eagerRelations.forEach(i=>{let r=k.buildAlias(e.connection.driver,{joiner:"__"},t,i.propertyName),s=!0;for(const c of e.expressionMap.joinAttributes)if(!(c.condition!==void 0||c.mapToProperty!==void 0||c.isMappingMany!==void 0||c.direction!=="LEFT"||c.entityOrProperty!==`${t}.${i.propertyPath}`)){s=!1,r=c.alias.name;break}const a=!!e.expressionMap.joinAttributes.find(c=>c.alias.name===r);s&&!a&&e.leftJoin(t+"."+i.propertyPath,r);let o=!0;for(const c of e.expressionMap.selects)if(!(c.aliasName!==void 0||c.virtual!==void 0||c.selection!==r)){o=!1;break}o&&e.addSelect(r),this.joinEagerRelations(e,r,i.inverseEntityMetadata)})}}class Rt extends ve{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(n=>({selection:n}));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(n=>({selection:n})));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}addFrom(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(n),this}innerJoin(e,t,n,i){return this.join("INNER",e,t,n,i),this}leftJoin(e,t,n,i){return this.join("LEFT",e,t,n,i),this}innerJoinAndSelect(e,t,n,i){return this.addSelect(t),this.innerJoin(e,t,n,i),this}leftJoinAndSelect(e,t,n,i){return this.addSelect(t),this.leftJoin(e,t,n,i),this}innerJoinAndMapMany(e,t,n,i,r){return this.addSelect(n),this.join("INNER",t,n,i,r,e,!0),this}innerJoinAndMapOne(e,t,n,i,r,s){return this.addSelect(n),this.join("INNER",t,n,i,r,e,!1,s),this}leftJoinAndMapMany(e,t,n,i,r){return this.addSelect(n),this.join("LEFT",t,n,i,r,e,!0),this}leftJoinAndMapOne(e,t,n,i,r,s){return this.addSelect(n),this.join("LEFT",t,n,i,r,e,!1,s),this}loadRelationIdAndMap(e,t,n,i){const r=new Ni(this.expressionMap);return r.mapToProperty=e,r.relationName=t,typeof n=="string"&&(r.alias=n),typeof n=="object"&&n.disableMixedMap&&(r.disableMixedMap=!0),r.queryBuilderFactory=i,this.expressionMap.relationIdAttributes.push(r),r.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:r.junctionAlias,metadata:r.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,n,i){const r=new Ai(this.expressionMap);return r.mapToProperty=e,r.relationName=t,r.alias=n,r.queryBuilderFactory=i,this.expressionMap.relationCountAttributes.push(r),this.expressionMap.createAlias({type:"other",name:r.junctionAlias}),r.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:r.junctionAlias,metadata:r.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new C('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new C('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new C('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new C('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new C('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new C('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new C('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new C('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,n){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=n,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new Ct;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);const n=await this.loadRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const t=(await this.getRawAndEntities()).entities[0];if(t&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const i=n.updateDateColumn.getEntityValue(t);if(i.getTime()!==this.expressionMap.lockVersion.getTime())throw new Ii(n.name,this.expressionMap.lockVersion,i)}else{const i=n.versionColumn.getEntityValue(t);if(i!==this.expressionMap.lockVersion)throw new Ii(n.name,this.expressionMap.lockVersion,i)}}return t===void 0?null:t}async getOneOrFail(){const e=await this.getOne();if(!e)throw new Ei(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new Ct;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new Ct;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeCountQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new Ct;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new Ct;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;let i=this.lazyCount(n);if(i===void 0){const s=this.expressionMap.cacheId;s&&(this.expressionMap.cacheId=`${s}-count`),i=await this.executeCountQuery(e)}const r=[n.entities,i];return t&&await e.commitTransaction(),r}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}lazyCount(e){const t=this.expressionMap.limit!==void 0&&this.expressionMap.limit!==null;if(this.expressionMap.joinAttributes.length>0&&t)return;const n=this.expressionMap.take!==void 0&&this.expressionMap.take!==null,i=t?this.expressionMap.limit:n?this.expressionMap.take:void 0;if(i!==void 0&&e.entities.length===i)return;const r=this.expressionMap.skip!==void 0&&this.expressionMap.skip!==null&&this.expressionMap.skip>0,s=this.expressionMap.offset!==void 0&&this.expressionMap.offset!==null&&this.expressionMap.offset>0;if(e.entities.length===0&&(r||s))return;const a=s?this.expressionMap.offset:r?this.expressionMap.skip:0;return e.entities.length+a}async stream(){this.expressionMap.queryEntity=!1;const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),i=!0);const r=()=>{if(n!==this.queryRunner)return n.release()},s=n.stream(e,t,r,r);return i&&await n.commitTransaction(),s}catch(r){if(i)try{await n.rollbackTransaction()}catch{}throw r}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,n,i,r,s,a,o){r&&this.setParameters(r);const c=new Ds(this.connection,this.expressionMap);c.direction=e,c.mapAsEntity=o,c.mapToProperty=s,c.isMappingMany=a,c.entityOrProperty=t,c.condition=i,this.expressionMap.joinAttributes.push(c);const u=c.metadata;if(u){if(u.deleteDateColumn&&!this.expressionMap.withDeleted){const l=`${n}.${u.deleteDateColumn.propertyName} IS NULL`;c.condition=c.condition?` ${c.condition} AND ${l}`:`${l}`}c.alias=this.expressionMap.createAlias({type:"join",name:n,metadata:u}),c.relation&&c.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:c.junctionAlias,metadata:c.relation.junctionEntityMetadata})}else{let l="";if(typeof t=="function"){const m=t(this.subQuery());this.setParameters(m.getParameters()),l=m.getQuery()}else l=t;const h=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";c.alias=this.expressionMap.createAlias({type:"join",name:n,tablePath:h===!1?t:void 0,subQuery:h===!0?l:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new C("Cannot build query because main alias is not set (call qb#from method)");const e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){const a=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,a)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,a))}this.expressionMap.joinAttributes.forEach(a=>{if(a.metadata)e.push(...this.buildEscapedEntityColumnSelects(a.alias.name,a.metadata)),t.push(...this.findEntityColumnSelects(a.alias.name,a.metadata));else if(this.expressionMap.selects.some(c=>c.selection===a.alias.name)){e.push({selection:this.escape(a.alias.name)+".*"});const c=this.expressionMap.selects.find(u=>u.selection===a.alias.name);t.push(c)}}),this.expressionMap.selects.filter(a=>t.indexOf(a)===-1).forEach(a=>e.push({selection:this.replacePropertyNames(a.selection),aliasName:a.aliasName})),e.length===0&&e.push({selection:"*"});let n="";this.expressionMap.useIndex&&k.isMySQLFamily(this.connection.driver)&&(n=` USE INDEX (${this.expressionMap.useIndex})`);const i=this.expressionMap.aliases.filter(a=>a.type==="from"&&(a.tablePath||a.subQuery)).map(a=>a.subQuery?a.subQuery+" "+this.escape(a.name):this.getTableName(a.tablePath)+" "+this.escape(a.name)),r=this.createSelectDistinctExpression(),s=e.map(a=>a.selection+(a.aliasName?" AS "+this.escape(a.aliasName):"")).join(", ");return r+s+" FROM "+i.join(", ")+this.createTableLockExpression()+n}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:n}=this.expressionMap,{driver:i}=this.connection;let r="SELECT ";return n>0&&k.isMySQLFamily(i)&&(r+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),k.isPostgresFamily(i)&&t.length>0?r=`SELECT DISTINCT ON (${t.map(a=>this.replacePropertyNames(a)).join(", ")}) `:e&&(r="SELECT DISTINCT "),r}createJoinExpression(){return this.expressionMap.joinAttributes.map(t=>{const n=t.relation,i=t.tablePath,r=t.alias.name;let s=t.condition?" AND ("+t.condition+")":"";const a=t.parentAlias;if(!a||!n){const o=t.alias.subQuery?t.alias.subQuery:this.getTableName(i);return" "+t.direction+" JOIN "+o+" "+this.escape(r)+this.createTableLockExpression()+(t.condition?" ON "+this.replacePropertyNames(t.condition):"")}if(n.isManyToOne||n.isOneToOneOwner){const o=n.joinColumns.map(c=>r+"."+c.referencedColumn.propertyPath+"="+a+"."+n.propertyPath+"."+c.referencedColumn.propertyPath).join(" AND ");return" "+t.direction+" JOIN "+this.getTableName(i)+" "+this.escape(r)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+s)}else if(n.isOneToMany||n.isOneToOneNotOwner){const o=n.inverseRelation.joinColumns.map(c=>(n.inverseEntityMetadata.tableType==="entity-child"&&n.inverseEntityMetadata.discriminatorColumn&&(s+=" AND "+r+"."+n.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+n.inverseEntityMetadata.discriminatorValue+"'"),r+"."+n.inverseRelation.propertyPath+"."+c.referencedColumn.propertyPath+"="+a+"."+c.referencedColumn.propertyPath)).join(" AND ");if(!o)throw new C(`Relation ${n.entityMetadata.name}.${n.propertyName} does not have join columns.`);return" "+t.direction+" JOIN "+this.getTableName(i)+" "+this.escape(r)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+s)}else{const o=n.junctionEntityMetadata.tablePath,c=t.junctionAlias;let u="",l="";return n.isOwning?(u=n.joinColumns.map(h=>c+"."+h.propertyPath+"="+a+"."+h.referencedColumn.propertyPath).join(" AND "),l=n.inverseJoinColumns.map(h=>r+"."+h.referencedColumn.propertyPath+"="+c+"."+h.propertyPath).join(" AND ")):(u=n.inverseRelation.inverseJoinColumns.map(h=>c+"."+h.propertyPath+"="+a+"."+h.referencedColumn.propertyPath).join(" AND "),l=n.inverseRelation.joinColumns.map(h=>r+"."+h.referencedColumn.propertyPath+"="+c+"."+h.propertyPath).join(" AND "))," "+t.direction+" JOIN "+this.getTableName(o)+" "+this.escape(c)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(u)+" "+t.direction+" JOIN "+this.getTableName(i)+" "+this.escape(r)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l+s)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{const n=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,i=this.expressionMap.selects.find(r=>r.selection===t);if(i&&!i.aliasName&&t.indexOf(".")!==-1){const r=t.split("."),s=r[0],a=r.slice(1).join("."),o=this.expressionMap.aliases.find(c=>c.name===s);if(o){const c=o.metadata.findColumnWithPropertyPath(a);if(c){const u=k.buildAlias(this.connection.driver,void 0,s,c.databaseName);return this.escape(u)+" "+n}}}return this.replacePropertyNames(t)+" "+n}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;e===void 0&&t===void 0&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take);const n=t!=null,i=e!=null;if(this.connection.driver.options.type==="mssql"){let r="";if((n||i)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(r=" ORDER BY (SELECT NULL)"),n&&i)return r+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return r+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(i)return r+" OFFSET "+e+" ROWS"}else if(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(n&&i)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(i)throw new ga}else if(k.isSQLiteFamily(this.connection.driver)){if(n&&i)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(i)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(n&&i)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return" FETCH NEXT "+t+" ROWS ONLY";if(i)return" OFFSET "+e+" ROWS"}else{if(n&&i)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(i)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let t="";if(this.expressionMap.lockTables){if(!(k.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new C("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new C("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let n="";switch(this.expressionMap.onLocked==="nowait"?n=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(n=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return k.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+n:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(k.isPostgresFamily(e))return" FOR SHARE"+t+n;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new gt;case"pessimistic_write":if(k.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+n;if(k.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+n;if(e.options.type==="mssql")return"";throw new gt;case"pessimistic_partial_write":if(k.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(k.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new gt;case"pessimistic_write_or_fail":if(k.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(k.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new gt;case"for_no_key_update":if(k.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+n;throw new gt;case"for_key_share":if(k.isPostgresFamily(e))return" FOR KEY SHARE"+t+n;throw new gt;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((t,n)=>{switch(t.type){case"and":return(n>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(n>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){const n=this.expressionMap.selects.some(c=>c.selection===e),i=[];if(n&&i.push(...t.columns.filter(c=>c.isSelect===!0)),i.push(...t.columns.filter(c=>this.expressionMap.selects.some(u=>u.selection===e+"."+c.propertyPath))),i.length===0)return[];const r=this.expressionMap.queryEntity?t.primaryColumns.filter(c=>i.indexOf(c)===-1):[],s=[...i,...r],a=[],o=this.escape(e);return s.forEach(c=>{let u=o+"."+this.escape(c.databaseName);c.isVirtualProperty&&c.query&&(u=`(${c.query(o)})`),this.connection.driver.spatialTypes.indexOf(c.type)!==-1&&((k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(u=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${u})`),k.isPostgresFamily(this.connection.driver)&&(c.precision?u=`ST_AsGeoJSON(${u}, ${c.precision})::json`:u=`ST_AsGeoJSON(${u})::json`),this.connection.driver.options.type==="mssql"&&(u=`${u}.ToString()`));const l=this.expressionMap.selects.filter(h=>h.selection===e+"."+c.propertyPath);l.length?l.forEach(h=>{a.push({selection:u,aliasName:h.aliasName?h.aliasName:k.buildAlias(this.connection.driver,void 0,e,c.databaseName),virtual:h.virtual})}):a.push({selection:u,aliasName:k.buildAlias(this.connection.driver,void 0,e,c.databaseName),virtual:n})}),a}findEntityColumnSelects(e,t){return this.expressionMap.selects.filter(n=>n.selection===e||t.columns.some(i=>n.selection===e+"."+i.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,n=this.expressionMap.mainAlias.metadata.primaryColumns,i=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||k.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+n.map(r=>`${i}.${this.escape(r.databaseName)}`).join(", ")+"))";if(k.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+n.map(r=>`${i}.${this.escape(r.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const r=n.map(s=>`${i}.${this.escape(s.databaseName)}`).join(", '|;|', ");return n.length===1?`COUNT(DISTINCT(${r}))`:`COUNT(DISTINCT(CONCAT(${r})))`}return this.connection.driver.options.type==="spanner"?n.length===1?`COUNT(DISTINCT(${i}.${this.escape(n[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${n.map(s=>`CAST(${i}.${this.escape(s.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+n.map(r=>`${i}.${this.escape(r.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const t=this.computeCountExpression(),n=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!n||!n[0]||!n[0].cnt?0:parseInt(n[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?Q.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?Q.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{const n=this.expressionMap.aliases.find(i=>i.metadata.tableNameWithoutPrefix===t);if(!n)throw new C(`"${t}" is not part of this query`);return this.escape(n.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&_e.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new C('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new da;if(this.expressionMap.lockMode==="optimistic"){const o=this.expressionMap.mainAlias.metadata;if(!o.versionColumn&&!o.updateDateColumn)throw new ca(o.name)}const t=new Co(this.connection,e,this.expressionMap.relationIdAttributes),n=new Ro(this.connection,e,this.expressionMap.relationCountAttributes);new So(this.expressionMap).transform(),new Mo(this.expressionMap).transform();let s=[],a=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[o,c]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),u=this.expressionMap.mainAlias.metadata,l=this.expressionMap.mainAlias.name,h=u.primaryColumns.map(g=>{const b=this.escape("distinctAlias"),R=this.escape(k.buildAlias(this.connection.driver,void 0,l,g.databaseName));c[R]||(c[R]="ASC");const P=k.buildAlias(this.connection.driver,void 0,"ids_"+l,g.databaseName);return`${b}.${R} AS ${this.escape(P)}`}),m=this.clone(),y=m.expressionMap.timeTravel;if(s=await new Rt(this.connection,e).select(`DISTINCT ${h.join(", ")}`).addSelect(o).from(`(${m.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(y).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(c).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),s.length>0){let g="";const b={};if(u.hasMultiplePrimaryKeys)g=s.map((R,P)=>u.primaryColumns.map(M=>{const U=`orm_distinct_ids_${P}_${M.databaseName}`,F=k.buildAlias(this.connection.driver,void 0,"ids_"+l,M.databaseName);return b[U]=R[F],`${l}.${M.propertyPath}=:${U}`}).join(" AND ")).join(" OR ");else{const R=k.buildAlias(this.connection.driver,void 0,"ids_"+l,u.primaryColumns[0].databaseName),P=s.map(U=>U[R]);P.every(U=>typeof U=="number")?g=`${l}.${u.primaryColumns[0].propertyPath} IN (${P.join(", ")})`:(b.orm_distinct_ids=P,g=l+"."+u.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}s=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:g}).setParameters(b).loadRawResults(e)}}else s=await this.loadRawResults(e);if(s.length>0){const o=await t.load(s),c=await n.load(s);a=new Ao(this.expressionMap,this.connection.driver,o,c,this.queryRunner).transform(s,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,a)}if(this.expressionMap.relationLoadStrategy==="query"){const o=new $s(this.connection,e);await Promise.all(this.relationMetadatas.map(async c=>{const u=c.inverseEntityMetadata.target,l=c.inverseEntityMetadata.targetName,h=Array.isArray(this.findOptions.select)?Q.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,m=Array.isArray(this.findOptions.relations)?Q.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,y=this.createQueryBuilder(e).select(l).from(u,l).setFindOptions({select:h?Q.deepValue(h,c.propertyPath):void 0,order:this.findOptions.order?Q.deepValue(this.findOptions.order,c.propertyPath):void 0,relations:m?Q.deepValue(m,c.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(a.length>0){const g=await o.loadManyToManyRelationIdsAndGroup(c,a,void 0,y);a.forEach(b=>{const R=g.find(P=>P.entity===b);if(R){const P=R.related===void 0?null:R.related;c.setEntityValue(b,P)}})}}))}return{raw:s,entities:a}}createOrderByCombinedWithSelectExpression(e){const t=this.expressionMap.allOrderBys,n=Object.keys(t).map(r=>{if(r.indexOf(".")!==-1){const s=r.split("."),a=s[0],o=s.slice(1).join("."),u=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(o);return this.escape(e)+"."+this.escape(k.buildAlias(this.connection.driver,void 0,a,u.databaseName))}else return this.expressionMap.selects.find(s=>s.selection===r||s.aliasName===r)?this.escape(e)+"."+this.escape(r):""}).join(", "),i={};return Object.keys(t).forEach(r=>{if(r.indexOf(".")!==-1){const s=r.split("."),a=s[0],o=s.slice(1).join("."),u=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(o);i[this.escape(e)+"."+this.escape(k.buildAlias(this.connection.driver,void 0,a,u.databaseName))]=t[r]}else this.expressionMap.selects.find(s=>s.selection===r||s.aliasName===r)?i[this.escape(e)+"."+this.escape(r)]=t[r]:i[r]=t[r]}),[n,i]}async loadRawResults(e){const[t,n]=this.getQueryAndParameters(),i=t+" -- PARAMETERS: "+JSON.stringify(n,(u,l)=>typeof l=="bigint"?l.toString():l),r=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let s;const a=r.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let o=!1;if(this.connection.queryResultCache&&a)try{if(s=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:i,duration:this.expressionMap.cacheDuration||r.duration||1e3},e),s&&!this.connection.queryResultCache.isExpired(s))return JSON.parse(s.result)}catch(u){if(!r.ignoreErrors)throw u;o=!0}const c=await e.query(t,n,!0);if(!o&&this.connection.queryResultCache&&a)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:i,time:Date.now(),duration:this.expressionMap.cacheDuration||r.duration||1e3,result:JSON.stringify(c.records)},s,e)}catch(u){if(!r.ignoreErrors)throw u}return c.records}mergeExpressionMap(e){return oe.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,n,i){for(const r in e){if(e[r]===void 0||e[r]===!1)continue;const s=i?i+"."+r:r,a=t.findColumnWithPropertyPathStrict(s),o=t.findEmbeddedWithPropertyPath(s),c=t.findRelationWithPropertyPath(s);if(!o&&!a&&!c)throw new Ze(s,t);a?this.selects.push(n+"."+s):o&&this.buildSelect(e[r],t,n,s)}}buildRelations(e,t,n,i,r){e&&Object.keys(e).forEach(s=>{const a=e[s],o=r?r+"."+s:s,c=n.findEmbeddedWithPropertyPath(o),u=n.findRelationWithPropertyPath(o);if(!c&&!u)throw new Ze(o,n);if(c)this.buildRelations(a,typeof t=="object"?Q.deepValue(t,c.propertyPath):void 0,n,i,o);else if(u){let l=i+"_"+o.replace(".","_");l=k.buildAlias(this.connection.driver,{joiner:"__"},i,l),(a===!0||typeof a=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(u):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[s]=="object"?t[s]:void 0,alias:l,parentAlias:i,relationMetadata:u}),t&&typeof t[s]=="object"&&this.buildSelect(t[s],u.inverseEntityMetadata,l))),typeof a=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(a,typeof t=="object"?Q.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,l,void 0)}})}buildEagerRelations(e,t,n,i,r){e&&Object.keys(e).forEach(s=>{const a=e[s],o=r?r+"."+s:s,c=n.findEmbeddedWithPropertyPath(o),u=n.findRelationWithPropertyPath(o);if(!c&&!u)throw new Ze(o,n);if(c)this.buildEagerRelations(a,typeof t=="object"?Q.deepValue(t,c.propertyPath):void 0,n,i,o);else if(u){let l=i+"_"+o.replace(".","_");l=k.buildAlias(this.connection.driver,{joiner:"__"},i,l),(a===!0||typeof a=="object")&&u.inverseEntityMetadata.eagerRelations.forEach(h=>{let m=l+"_"+h.propertyPath.replace(".","_");m=k.buildAlias(this.connection.driver,{joiner:"__"},l,m),this.joins.find(g=>g.alias===m)||this.joins.push({type:"left",select:!0,alias:m,parentAlias:l,selection:void 0,relationMetadata:h}),t&&typeof t[s]=="object"&&this.buildSelect(t[s],u.inverseEntityMetadata,l)}),typeof a=="object"&&this.buildEagerRelations(a,typeof t=="object"?Q.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,l,void 0)}})}buildOrder(e,t,n,i){for(const r in e){if(e[r]===void 0)continue;const s=i?i+"."+r:r,a=t.findColumnWithPropertyPathStrict(s),o=t.findEmbeddedWithPropertyPath(s),c=t.findRelationWithPropertyPath(s);if(!o&&!a&&!c)throw new Ze(s,t);if(a){let u=typeof e[r]=="object"?e[r].direction:e[r];u=u==="DESC"||u==="desc"||u===-1?"DESC":"ASC";let l=typeof e[r]=="object"?e[r].nulls:void 0;l=l?.toLowerCase()==="first"?"NULLS FIRST":l?.toLowerCase()==="last"?"NULLS LAST":void 0;const h=`${n}.${s}`;this.addOrderBy(h,u,l)}else if(o)this.buildOrder(e[r],t,n,s);else if(c){let u=n+"_"+s.replace(".","_");u=k.buildAlias(this.connection.driver,{joiner:"__"},n,u),this.joins.find(h=>h.alias===u)||this.joins.push({type:"left",select:!1,alias:u,parentAlias:n,selection:void 0,relationMetadata:c}),this.buildOrder(e[r],c.inverseEntityMetadata,u)}}}buildWhere(e,t,n,i){let r="";if(Array.isArray(e))e.length&&(r=e.map(s=>this.buildWhere(s,t,n,i)).filter(s=>!!s).map(s=>"("+s+")").join(" OR "));else{const s=[];for(const a in e){let o=e[a];const c=i?i+"."+a:a,u=t.findColumnWithPropertyPathStrict(c),l=t.findEmbeddedWithPropertyPath(c),h=t.findRelationWithPropertyPath(c);if(!l&&!u&&!h)throw new Ze(c,t);if(o===void 0){if((this.connection.options.invalidWhereValuesBehavior?.undefined||"ignore")==="throw")throw new C(`Undefined value encountered in property '${n}.${a}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);continue}if(o===null){const m=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(m==="ignore")continue;if(m==="throw")throw new C(`Null value encountered in property '${n}.${a}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}if(u){let m=`${n}.${c}`;if(u.isVirtualProperty&&u.query&&(m=`(${u.query(this.escape(n))})`),o===null){s.push(`${m} IS NULL`);continue}v.isEqualOperator(e[a])&&(o=e[a].value),u.transformer&&(o instanceof Pt?o.transformValue(u.transformer):o=De.transformTo(u.transformer,o)),this.connection.driver.options.type==="mssql"&&(o=this.connection.driver.parametrizeValues(u,o)),s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(m,o)))}else if(l){const m=this.buildWhere(e[a],t,n,c);m&&s.push(m)}else if(h){if(e[a]===null){const m=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(m==="sql-null")s.push(`${n}.${c} IS NULL`);else if(m==="throw")throw new C(`Null value encountered in property '${n}.${a}' of a where condition. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`);continue}if(typeof e[a]=="object"&&Object.keys(e[a]).every(y=>e[a][y]===void 0))continue;if(v.isFindOperator(e[a]))if(e[a].type==="moreThan"||e[a].type==="lessThan"||e[a].type==="moreThanOrEqual"||e[a].type==="lessThanOrEqual"){let m="";e[a].type==="moreThan"?m=">":e[a].type==="lessThan"?m="<":e[a].type==="moreThanOrEqual"?m=">=":e[a].type==="lessThanOrEqual"&&(m="<=");const y=this.subQuery();if(h.isManyToManyOwner)y.select("COUNT(*)").from(h.joinTableName,h.joinTableName).where(h.joinColumns.map(g=>`${h.joinTableName}.${g.propertyName} = ${n}.${g.referencedColumn.propertyName}`).join(" AND "));else if(h.isManyToManyNotOwner)y.select("COUNT(*)").from(h.inverseRelation.joinTableName,h.inverseRelation.joinTableName).where(h.inverseRelation.inverseJoinColumns.map(g=>`${h.inverseRelation.joinTableName}.${g.propertyName} = ${n}.${g.referencedColumn.propertyName}`).join(" AND "));else if(h.isOneToMany)y.select("COUNT(*)").from(h.inverseEntityMetadata.target,h.inverseEntityMetadata.tableName).where(h.inverseRelation.joinColumns.map(g=>`${h.inverseEntityMetadata.tableName}.${g.propertyName} = ${n}.${g.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(y.getSql()+" "+m+" "+parseInt(e[a].value))}else if(h.isManyToOne||h.isOneToOne&&h.isOneToOneOwner){const m=`${n}.${c}`;s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(m,e[a])))}else throw new Error("This relation isn't supported by given find operator");else{let m=n+"_"+h.propertyPath.replace(".","_");m=k.buildAlias(this.connection.driver,{joiner:"__"},n,m),this.joins.find(b=>b.alias===m)||this.joins.push({type:"left",select:!1,selection:void 0,alias:m,parentAlias:n,relationMetadata:h});const g=this.buildWhere(e[a],h.inverseEntityMetadata,m);g&&s.push(g)}}}r=s.length?"("+s.join(") AND (")+")":s.join(" AND ")}return r.length?"("+r+")":r}}class _s{constructor(){this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class xo extends ve{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const n=new Si(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=n.getSoftDeletionReturningColumns());const[i,r]=this.getQueryAndParameters(),s=await e.query(i,r,!0),a=_s.from(s);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await n.update(a,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),a}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=v.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Kt;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new C(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!i)throw new C("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new C(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new ra(e);const t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new C('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new gi;const n=this.createWhereExpression(),i=this.createReturningExpression("update");return i===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${i}${n}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n} RETURNING ${i}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){const e=this.expressionMap.limit;if(e){if(k.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new Ts}return""}}class vo extends ve{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let n=null,i=null;const r=new Si(e,this.expressionMap),s=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const h of this.expressionMap.returning)s.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(h));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=r.getUpdationReturningColumns(),s.push(...this.expressionMap.extraReturningColumns.filter(h=>!s.includes(h)))),s.length>0&&this.connection.driver.options.type==="mssql"&&(n=this.connection.driver.buildTableVariableDeclaration("@OutputTable",s),i="SELECT * FROM @OutputTable");const[a,o]=this.getQueryAndParameters(),c=[n,a,i],u=await e.query(c.filter(h=>h!=null).join(`;

`),o,!0),l=_s.from(u);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await r.update(l,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),l}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Kt;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new C(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!i)throw new C("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,n={};for(const o in e)e[o]!==void 0&&(n[o]=e[o]);const i=[],r=[];if(t?(this.createPropertyPath(t,n).forEach(o=>{const c=t.findColumnsWithPropertyPath(o);if(c.length<=0)throw new Ze(o,t);c.forEach(u=>{if(!u.isUpdate||r.includes(u))return;r.push(u);let l=u.getEntityValue(n);if(u.referencedColumn&&typeof l=="object"&&!(l instanceof Date)&&l!==null&&!Buffer.isBuffer(l)?l=u.referencedColumn.getEntityValue(l):typeof l!="function"&&(l=this.connection.driver.preparePersistentValue(l,u)),typeof l=="function")i.push(this.escape(u.databaseName)+" = "+l());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&l===null)i.push(this.escape(u.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(l=this.connection.driver.parametrizeValue(u,l));const h=this.createParameter(l);let m=null;if((k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1){const g=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";u.srid!=null?m=`${g}(${h}, ${u.srid})`:m=`${g}(${h})`}else k.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?u.srid!=null?m=`ST_SetSRID(ST_GeomFromGeoJSON(${h}), ${u.srid})::${u.type}`:m=`ST_GeomFromGeoJSON(${h})::${u.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?m=u.type+"::STGeomFromText("+h+", "+(u.srid||"0")+")":m=h;i.push(this.escape(u.databaseName)+" = "+m)}})}),(i.length>0||Object.keys(n).length===0)&&(t.versionColumn&&r.indexOf(t.versionColumn)===-1&&i.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&r.indexOf(t.updateDateColumn)===-1&&i.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(n).map(o=>{const c=n[o];if(typeof c=="function")i.push(this.escape(o)+" = "+c());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&c===null)i.push(this.escape(o)+" = NULL");else{const u=this.createParameter(c);i.push(this.escape(o)+" = "+u)}}),i.length<=0)throw new gi;const s=this.createWhereExpression(),a=this.createReturningExpression("update");return a===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${s}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")} OUTPUT ${a}${s}`:this.connection.driver.options.type==="spanner"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${s} THEN RETURN ${a}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${s} RETURNING ${a}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){const e=this.expressionMap.limit;if(e){if(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new Ts}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new gi}}function Ls(){ve.registerQueryBuilderClass("DeleteQueryBuilder",p=>new fo(p)),ve.registerQueryBuilderClass("InsertQueryBuilder",p=>new bo(p)),ve.registerQueryBuilderClass("RelationQueryBuilder",p=>new No(p)),ve.registerQueryBuilderClass("SelectQueryBuilder",p=>new Rt(p)),ve.registerQueryBuilderClass("SoftDeleteQueryBuilder",p=>new xo(p)),ve.registerQueryBuilderClass("UpdateQueryBuilder",p=>new vo(p))}class ht{static sha1(e){const t=function(F,J){return F<<J|F>>>32-J},n=function(F){let J="",K,re;for(K=7;K>=0;K--)re=F>>>K*4&15,J+=re.toString(16);return J};let i,r,s;const a=new Array(80);let o=1732584193,c=4023233417,u=2562383102,l=271733878,h=3285377520,m,y,g,b,R,P;e=encodeURIComponent(e);const M=e.length,U=[];for(r=0;r<M-3;r+=4)s=e.charCodeAt(r)<<24|e.charCodeAt(r+1)<<16|e.charCodeAt(r+2)<<8|e.charCodeAt(r+3),U.push(s);switch(M%4){case 0:r=2147483648;break;case 1:r=e.charCodeAt(M-1)<<24|8388608;break;case 2:r=e.charCodeAt(M-2)<<24|e.charCodeAt(M-1)<<16|32768;break;case 3:r=e.charCodeAt(M-3)<<24|e.charCodeAt(M-2)<<16|e.charCodeAt(M-1)<<8|128;break}for(U.push(r);U.length%16!==14;)U.push(0);for(U.push(M>>>29),U.push(M<<3&4294967295),i=0;i<U.length;i+=16){for(r=0;r<16;r++)a[r]=U[i+r];for(r=16;r<=79;r++)a[r]=t(a[r-3]^a[r-8]^a[r-14]^a[r-16],1);for(m=o,y=c,g=u,b=l,R=h,r=0;r<=19;r++)P=t(m,5)+(y&g|~y&b)+R+a[r]+1518500249&4294967295,R=b,b=g,g=t(y,30),y=m,m=P;for(r=20;r<=39;r++)P=t(m,5)+(y^g^b)+R+a[r]+1859775393&4294967295,R=b,b=g,g=t(y,30),y=m,m=P;for(r=40;r<=59;r++)P=t(m,5)+(y&g|y&b|g&b)+R+a[r]+2400959708&4294967295,R=b,b=g,g=t(y,30),y=m,m=P;for(r=60;r<=79;r++)P=t(m,5)+(y^g^b)+R+a[r]+3395469782&4294967295,R=b,b=g,g=t(y,30),y=m,m=P;o=o+m&4294967295,c=c+y&4294967295,u=u+g&4294967295,l=l+b&4294967295,h=h+R&4294967295}return P=n(o)+n(c)+n(u)+n(l)+n(h),P.toLowerCase()}}class Po{constructor(){this.nestedSetColumnNames={left:"nsleft",right:"nsright"},this.materializedPathColumnName="mpath"}getTableName(e){return typeof e!="string"&&(e=e.name),e.split(".").pop()}tableName(e,t){return t||jr(e)}closureJunctionTableName(e){return e+"_closure"}columnName(e,t,n){const i=t||e;return n.length?ui(n.join("_"))+oo(i):i}relationName(e){return e}primaryKeyName(e,t){const n=[...t];n.sort();const s=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"PK_"+ht.sha1(s).substr(0,27)}uniqueConstraintName(e,t){const n=[...t];n.sort();const s=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"UQ_"+ht.sha1(s).substr(0,27)}relationConstraintName(e,t,n){const i=[...t];i.sort();let a=`${this.getTableName(e).replace(".","_")}_${i.join("_")}`;return n&&(a+=`_${n}`),"REL_"+ht.sha1(a).substr(0,26)}defaultConstraintName(e,t){const r=`${this.getTableName(e).replace(".","_")}_${t}`;return"DF_"+ht.sha1(r).substr(0,27)}foreignKeyName(e,t,n,i){const r=[...t];r.sort();const o=`${this.getTableName(e).replace(".","_")}_${r.join("_")}`;return"FK_"+ht.sha1(o).substr(0,27)}indexName(e,t,n){const i=[...t];i.sort();let a=`${this.getTableName(e).replace(".","_")}_${i.join("_")}`;return n&&(a+=`_${n}`),"IDX_"+ht.sha1(a).substr(0,26)}checkConstraintName(e,t,n){const s=`${this.getTableName(e).replace(".","_")}_${t}`,a="CHK_"+ht.sha1(s).substr(0,26);return n?`${a}_ENUM`:a}exclusionConstraintName(e,t){const r=`${this.getTableName(e).replace(".","_")}_${t}`;return"XCL_"+ht.sha1(r).substr(0,26)}joinColumnName(e,t){return ui(e+"_"+t)}joinTableName(e,t,n,i){return jr(e+"_"+n.replace(/\./gi,"_")+"_"+t)}joinTableColumnDuplicationPrefix(e,t){return e+"_"+t}joinTableColumnName(e,t,n){return ui(e+"_"+(n||t))}joinTableInverseColumnName(e,t,n){return this.joinTableColumnName(e,t,n)}prefixTableName(e,t){return e+t}}class Fe{constructor(e){this["@instanceof"]=Symbol.for("TableColumn"),this.isNullable=!1,this.isGenerated=!1,this.isPrimary=!1,this.isUnique=!1,this.isArray=!1,this.length="",this.zerofill=!1,this.unsigned=!1,e&&(this.name=e.name,this.type=e.type||"",this.length=e.length||"",this.width=e.width,this.charset=e.charset,this.collation=e.collation,this.precision=e.precision,this.scale=e.scale,this.zerofill=e.zerofill||!1,this.unsigned=this.zerofill?!0:e.unsigned||!1,this.default=e.default,this.onUpdate=e.onUpdate,this.isNullable=e.isNullable||!1,this.isGenerated=e.isGenerated||!1,this.generationStrategy=e.generationStrategy,this.generatedIdentity=e.generatedIdentity,this.isPrimary=e.isPrimary||!1,this.isUnique=e.isUnique||!1,this.isArray=e.isArray||!1,this.comment=e.comment,this.enum=e.enum,this.enumName=e.enumName,this.primaryKeyConstraintName=e.primaryKeyConstraintName,this.asExpression=e.asExpression,this.generatedType=e.generatedType,this.spatialFeatureType=e.spatialFeatureType,this.srid=e.srid)}clone(){return new Fe({name:this.name,type:this.type,length:this.length,width:this.width,charset:this.charset,collation:this.collation,precision:this.precision,scale:this.scale,zerofill:this.zerofill,unsigned:this.unsigned,enum:this.enum,enumName:this.enumName,primaryKeyConstraintName:this.primaryKeyConstraintName,asExpression:this.asExpression,generatedType:this.generatedType,default:this.default,onUpdate:this.onUpdate,isNullable:this.isNullable,isGenerated:this.isGenerated,generationStrategy:this.generationStrategy,generatedIdentity:this.generatedIdentity,isPrimary:this.isPrimary,isUnique:this.isUnique,isArray:this.isArray,comment:this.comment,spatialFeatureType:this.spatialFeatureType,srid:this.srid})}}class Pe{constructor(e){this["@instanceof"]=Symbol.for("TableIndex"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.isUnique=!!e.isUnique,this.isSpatial=!!e.isSpatial,this.isConcurrent=!!e.isConcurrent,this.isFulltext=!!e.isFulltext,this.isNullFiltered=!!e.isNullFiltered,this.parser=e.parser,this.where=e.where?e.where:""}clone(){return new Pe({name:this.name,columnNames:[...this.columnNames],isUnique:this.isUnique,isSpatial:this.isSpatial,isConcurrent:this.isConcurrent,isFulltext:this.isFulltext,isNullFiltered:this.isNullFiltered,parser:this.parser,where:this.where})}static create(e){return new Pe({name:e.name,columnNames:e.columns.map(t=>t.databaseName),isUnique:e.isUnique,isSpatial:e.isSpatial,isConcurrent:e.isConcurrent,isFulltext:e.isFulltext,isNullFiltered:e.isNullFiltered,parser:e.parser,where:e.where})}}class We{constructor(e){this["@instanceof"]=Symbol.for("TableForeignKey"),this.columnNames=[],this.referencedColumnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.referencedColumnNames=e.referencedColumnNames,this.referencedDatabase=e.referencedDatabase,this.referencedSchema=e.referencedSchema,this.referencedTableName=e.referencedTableName,this.onDelete=e.onDelete,this.onUpdate=e.onUpdate,this.deferrable=e.deferrable}clone(){return new We({name:this.name,columnNames:[...this.columnNames],referencedColumnNames:[...this.referencedColumnNames],referencedDatabase:this.referencedDatabase,referencedSchema:this.referencedSchema,referencedTableName:this.referencedTableName,onDelete:this.onDelete,onUpdate:this.onUpdate,deferrable:this.deferrable})}static create(e,t){return new We({name:e.name,columnNames:e.columnNames,referencedColumnNames:e.referencedColumnNames,referencedDatabase:e.referencedEntityMetadata.database,referencedSchema:e.referencedEntityMetadata.schema,referencedTableName:e.referencedTablePath,onDelete:e.onDelete,onUpdate:e.onUpdate,deferrable:e.deferrable})}}class jt{static createTableColumnOptions(e,t){return{name:e.databaseName,length:t.getColumnLength(e),width:e.width,charset:e.charset,collation:e.collation,precision:e.precision,scale:e.scale,zerofill:e.zerofill,unsigned:e.unsigned,asExpression:e.asExpression,generatedType:e.generatedType,default:t.normalizeDefault(e),onUpdate:e.onUpdate,comment:e.comment,isGenerated:e.isGenerated,generationStrategy:e.generationStrategy,generatedIdentity:e.generatedIdentity,isNullable:e.isNullable,type:t.normalizeType(e),isPrimary:e.isPrimary,isUnique:t.normalizeIsUnique(e),isArray:e.isArray||!1,enum:e.enum?e.enum.map(n=>n+""):e.enum,enumName:e.enumName,primaryKeyConstraintName:e.primaryKeyConstraintName,spatialFeatureType:e.spatialFeatureType,srid:e.srid}}}class Le{constructor(e){this["@instanceof"]=Symbol.for("TableUnique"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.deferrable=e.deferrable}clone(){return new Le({name:this.name,columnNames:[...this.columnNames],deferrable:this.deferrable})}static create(e){return new Le({name:e.name,columnNames:e.columns.map(t=>t.databaseName),deferrable:e.deferrable})}}class tt{constructor(e){this["@instanceof"]=Symbol.for("TableCheck"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.expression=e.expression}clone(){return new tt({name:this.name,columnNames:this.columnNames?[...this.columnNames]:[],expression:this.expression})}static create(e){return new tt({name:e.name,expression:e.expression})}}class ft{constructor(e){this["@instanceof"]=Symbol.for("TableExclusion"),this.name=e.name,this.expression=e.expression}clone(){return new ft({name:this.name,expression:this.expression})}static create(e){return new ft({name:e.name,expression:e.expression})}}class Se{constructor(e){this["@instanceof"]=Symbol.for("Table"),this.columns=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.justCreated=!1,this.withoutRowid=!1,e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,e.columns&&(this.columns=e.columns.map(t=>new Fe(t))),e.indices&&(this.indices=e.indices.map(t=>new Pe(t))),e.foreignKeys&&(this.foreignKeys=e.foreignKeys.map(t=>new We({...t,referencedDatabase:t?.referencedDatabase||e.database,referencedSchema:t?.referencedSchema||e.schema}))),e.uniques&&(this.uniques=e.uniques.map(t=>new Le(t))),e.checks&&(this.checks=e.checks.map(t=>new tt(t))),e.exclusions&&(this.exclusions=e.exclusions.map(t=>new ft(t))),e.justCreated!==void 0&&(this.justCreated=e.justCreated),e.withoutRowid&&(this.withoutRowid=e.withoutRowid),this.engine=e.engine,this.comment=e.comment)}get primaryColumns(){return this.columns.filter(e=>e.isPrimary)}clone(){return new Se({schema:this.schema,database:this.database,name:this.name,columns:this.columns.map(e=>e.clone()),indices:this.indices.map(e=>e.clone()),foreignKeys:this.foreignKeys.map(e=>e.clone()),uniques:this.uniques.map(e=>e.clone()),checks:this.checks.map(e=>e.clone()),exclusions:this.exclusions.map(e=>e.clone()),justCreated:this.justCreated,withoutRowid:this.withoutRowid,engine:this.engine,comment:this.comment})}addColumn(e){this.columns.push(e)}removeColumn(e){const t=this.columns.find(n=>n.name===e.name);t&&this.columns.splice(this.columns.indexOf(t),1)}addUniqueConstraint(e){if(this.uniques.push(e),e.columnNames.length===1){const t=this.columns.find(n=>n.name===e.columnNames[0]);t&&(t.isUnique=!0)}}removeUniqueConstraint(e){const t=this.uniques.find(n=>n.name===e.name);if(t&&(this.uniques.splice(this.uniques.indexOf(t),1),t.columnNames.length===1)){const n=this.columns.find(i=>i.name===t.columnNames[0]);n&&(n.isUnique=!1)}}addCheckConstraint(e){this.checks.push(e)}removeCheckConstraint(e){const t=this.checks.find(n=>n.name===e.name);t&&this.checks.splice(this.checks.indexOf(t),1)}addExclusionConstraint(e){this.exclusions.push(e)}removeExclusionConstraint(e){const t=this.exclusions.find(n=>n.name===e.name);t&&this.exclusions.splice(this.exclusions.indexOf(t),1)}addForeignKey(e){this.foreignKeys.push(e)}removeForeignKey(e){const t=this.foreignKeys.find(n=>n.name===e.name);t&&this.foreignKeys.splice(this.foreignKeys.indexOf(t),1)}addIndex(e,t=!1){if(this.indices.push(e),e.columnNames.length===1&&e.isUnique&&t){const n=this.columns.find(i=>i.name===e.columnNames[0]);n&&(n.isUnique=!0)}}removeIndex(e,t=!1){const n=this.indices.find(i=>i.name===e.name);if(n&&(this.indices.splice(this.indices.indexOf(n),1),n.columnNames.length===1&&n.isUnique&&t)){const i=this.columns.find(r=>r.name===n.columnNames[0]);i&&(i.isUnique=this.indices.some(r=>r.columnNames.length===1&&r.columnNames[0]===i.name&&!!n.isUnique))}}findColumnByName(e){return this.columns.find(t=>t.name===e)}findColumnIndices(e){return this.indices.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnForeignKeys(e){return this.foreignKeys.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnUniques(e){return this.uniques.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnChecks(e){return this.checks.filter(t=>!!t.columnNames.find(n=>n===e.name))}static create(e,t){const n=e.database===t.database?void 0:e.database,i=e.schema===t.options.schema?void 0:e.schema,r={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,i,n),withoutRowid:e.withoutRowid,engine:e.engine,columns:e.columns.filter(s=>s&&!s.isVirtualProperty).map(s=>jt.createTableColumnOptions(s,t)),indices:e.indices.filter(s=>s.synchronize===!0).map(s=>Pe.create(s)),uniques:e.uniques.map(s=>Le.create(s)),checks:e.checks.map(s=>tt.create(s)),exclusions:e.exclusions.map(s=>ft.create(s)),comment:e.comment};return new Se(r)}}class Hr{constructor(e,t,n,i,r){this.id=e,this.timestamp=t,this.name=n,this.instance=i,this.transaction=r}}class Ye{constructor(e,t,...n){this.value=e,this.type=t,this["@instanceof"]=Symbol.for("MssqlParameter"),this.params=[],this.params=n||[]}}class hi{constructor(e,t){this.connection=e,this.queryRunner=t,this.transaction="all";const{schema:n}=this.connection.driver.options,i=this.connection.driver.database;this.migrationsDatabase=i,this.migrationsSchema=n,this.migrationsTableName=e.options.migrationsTableName||"migrations",this.migrationsTable=this.connection.driver.buildTableName(this.migrationsTableName,n,i)}async executeMigration(e){return this.withQueryRunner(async t=>{await this.createMigrationsTableIfNotExist(t);const n=this.connection.driver.createSchemaBuilder();return v.isRdbmsSchemaBuilder(n)&&await n.createMetadataTableIfNecessary(t),await t.beforeMigration(),await e.instance.up(t),await t.afterMigration(),await this.insertExecutedMigration(t,e),e})}async getAllMigrations(){return Promise.resolve(this.getMigrations())}async getExecutedMigrations(){return this.withQueryRunner(async e=>(await this.createMigrationsTableIfNotExist(e),await this.loadExecutedMigrations(e)))}async getPendingMigrations(){const e=await this.getAllMigrations(),t=await this.getExecutedMigrations();return e.filter(n=>!t.find(i=>i.name===n.name))}insertMigration(e){return this.withQueryRunner(t=>this.insertExecutedMigration(t,e))}deleteMigration(e){return this.withQueryRunner(t=>this.deleteExecutedMigration(t,e))}async showMigrations(){let e=!1;const t=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(t);const n=await this.loadExecutedMigrations(t),i=this.getMigrations();for(const r of i){const s=n.find(a=>a.name===r.name);s?this.connection.logger.logSchemaBuild(`[X] ${s.id} ${r.name}`):(e=!0,this.connection.logger.logSchemaBuild(`[ ] ${r.name}`))}return this.queryRunner||await t.release(),e}async executePendingMigrations(){const e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);const t=this.connection.driver.createSchemaBuilder();v.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);const n=await this.loadExecutedMigrations(e),i=this.getLatestTimestampMigration(n),r=this.getMigrations(),s=[],a=r.filter(u=>!n.find(h=>h.name===u.name));if(!a.length)return this.connection.logger.logSchemaBuild("No migrations are pending"),this.queryRunner||await e.release(),[];if(this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${r.length} migrations were found in the source code.`),i&&this.connection.logger.logSchemaBuild(`${i.name} is the last executed migration. It was executed on ${new Date(i.timestamp).toString()}.`),this.connection.logger.logSchemaBuild(`${a.length} migrations are new migrations must be executed.`),this.transaction==="all"){const u=a.filter(l=>l.instance?.transaction!==void 0);if(u.length>0){const l=new Ta(u);throw this.connection.logger.logMigration(`Migrations failed, error: ${l.message}`),l}}const o={each:!0,none:!1,all:!1}[this.transaction];for(const u of a)if(u.instance){const l=u.instance.transaction;l===void 0?u.transaction=o:u.transaction=l}let c=!1;this.transaction==="all"&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),c=!0);try{for(const u of a){if(this.fake){await this.insertExecutedMigration(e,u);continue}u.transaction&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),c=!0),await u.instance.up(e).catch(l=>{throw this.connection.logger.logMigration(`Migration "${u.name}" failed, error: ${l?.message}`),l}).then(async()=>{await this.insertExecutedMigration(e,u),u.transaction&&c&&(await e.commitTransaction(),await e.afterMigration())}).then(()=>{s.push(u),this.connection.logger.logSchemaBuild(`Migration ${u.name} has been ${this.fake?"(fake) ":""}executed successfully.`)})}this.transaction==="all"&&c&&(await e.commitTransaction(),await e.afterMigration())}catch(u){if(c)try{await e.rollbackTransaction()}catch{}throw u}finally{this.queryRunner||await e.release()}return s}async undoLastMigration(){const e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);const t=this.connection.driver.createSchemaBuilder();v.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);const n=await this.loadExecutedMigrations(e),i=this.getLatestExecutedMigration(n);if(!i){this.connection.logger.logSchemaBuild("No migrations were found in the database. Nothing to revert!");return}const s=this.getMigrations().find(o=>o.name===i.name);if(!s)throw new C(`No migration ${i.name} was found in the source code. Make sure you have this migration in your codebase and its included in the connection options.`);this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${i.name} is the last executed migration. It was executed on ${new Date(i.timestamp).toString()}.`),this.connection.logger.logSchemaBuild("Now reverting it...");let a=!1;this.transaction!=="none"&&!e.isTransactionActive&&(await e.startTransaction(),a=!0);try{this.fake||(await e.beforeMigration(),await s.instance.down(e),await e.afterMigration()),await this.deleteExecutedMigration(e,s),this.connection.logger.logSchemaBuild(`Migration ${s.name} has been ${this.fake?"(fake) ":""}reverted successfully.`),a&&await e.commitTransaction()}catch(o){if(a)try{await e.rollbackTransaction()}catch{}throw o}finally{this.queryRunner||await e.release()}}async createMigrationsTableIfNotExist(e){if(this.connection.driver.options.type==="mongodb")return;await e.hasTable(this.migrationsTable)||await e.createTable(new Se({database:this.migrationsDatabase,schema:this.migrationsSchema,name:this.migrationsTable,columns:[{name:"id",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationId}),isGenerated:!0,generationStrategy:"increment",isPrimary:!0,isNullable:!1},{name:"timestamp",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp}),isPrimary:!1,isNullable:!1},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}),isNullable:!1}]}))}async loadExecutedMigrations(e){return this.connection.driver.options.type==="mongodb"?e.cursor(this.migrationsTableName,{}).sort({_id:-1}).toArray():(await this.connection.manager.createQueryBuilder(e).select().orderBy(this.connection.driver.escape("id"),"DESC").from(this.migrationsTable,this.migrationsTableName).getRawMany()).map(n=>new Hr(parseInt(n.id),parseInt(n.timestamp),n.name))}getMigrations(){const e=this.connection.migrations.map(t=>{const n=t.name||t.constructor.name,i=parseInt(n.substr(-13),10);if(!i||isNaN(i))throw new C(`${n} migration name is wrong. Migration class name should have a JavaScript timestamp appended.`);return new Hr(void 0,i,n,t)});return this.checkForDuplicateMigrations(e),e.sort((t,n)=>t.timestamp-n.timestamp)}checkForDuplicateMigrations(e){const t=e.map(i=>i.name),n=Array.from(new Set(t.filter((i,r)=>t.indexOf(i)<r)));if(n.length>0)throw Error(`Duplicate migrations: ${n.join(", ")}`)}getLatestTimestampMigration(e){const t=e.map(n=>n).sort((n,i)=>(n.timestamp-i.timestamp)*-1);return t.length>0?t[0]:void 0}getLatestExecutedMigration(e){return e.length>0?e[0]:void 0}async insertExecutedMigration(e,t){const n={};this.connection.driver.options.type==="mssql"?(n.timestamp=new Ye(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),n.name=new Ye(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb"?await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).insertOne(n):await e.manager.createQueryBuilder().insert().into(this.migrationsTable).values(n).execute()}async deleteExecutedMigration(e,t){const n={};if(this.connection.driver.options.type==="mssql"?(n.timestamp=new Ye(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),n.name=new Ye(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb")await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).deleteOne(n);else{const i=e.manager.createQueryBuilder();await i.delete().from(this.migrationsTable).where(`${i.escape("timestamp")} = :timestamp`).andWhere(`${i.escape("name")} = :name`).setParameters(n).execute()}}async withQueryRunner(e){const t=this.queryRunner||this.connection.createQueryRunner();try{return await e(t)}finally{this.queryRunner||await t.release()}}}function _t(p,e,t){const n=[],i={};return function r(s){i[s]=!0,n.push(s),p[s].forEach(function(a){if(!i[a])r(a);else if(n.indexOf(a)>=0)throw n.push(a),new C(`Dependency Cycle Found: ${n.join(" -> ")}`)}),n.pop(),(!e||p[s].length===0)&&t.indexOf(s)===-1&&t.push(s)}}class Oo{constructor(){this.nodes={},this.outgoingEdges={},this.incomingEdges={}}addNode(e,t){this.hasNode(e)||(arguments.length===2?this.nodes[e]=t:this.nodes[e]=e,this.outgoingEdges[e]=[],this.incomingEdges[e]=[])}removeNode(e){this.hasNode(e)&&(delete this.nodes[e],delete this.outgoingEdges[e],delete this.incomingEdges[e],[this.incomingEdges,this.outgoingEdges].forEach(function(t){Object.keys(t).forEach(function(n){const i=t[n].indexOf(e);i>=0&&t[n].splice(i,1)})}))}hasNode(e){return this.nodes.hasOwnProperty(e)}getNodeData(e){if(this.hasNode(e))return this.nodes[e];throw new C(`Node does not exist: ${e}`)}setNodeData(e,t){if(this.hasNode(e))this.nodes[e]=t;else throw new C(`Node does not exist: ${e}`)}addDependency(e,t){if(!this.hasNode(e))throw new C(`Node does not exist: ${e}`);if(!this.hasNode(t))throw new C(`Node does not exist: ${t}`);return this.outgoingEdges[e].indexOf(t)===-1&&this.outgoingEdges[e].push(t),this.incomingEdges[t].indexOf(e)===-1&&this.incomingEdges[t].push(e),!0}removeDependency(e,t){let n;this.hasNode(e)&&(n=this.outgoingEdges[e].indexOf(t),n>=0&&this.outgoingEdges[e].splice(n,1)),this.hasNode(t)&&(n=this.incomingEdges[t].indexOf(e),n>=0&&this.incomingEdges[t].splice(n,1))}dependenciesOf(e,t){if(this.hasNode(e)){const n=[];_t(this.outgoingEdges,t,n)(e);const r=n.indexOf(e);return r>=0&&n.splice(r,1),n}else throw new C(`Node does not exist: ${e}`)}dependantsOf(e,t){if(this.hasNode(e)){const n=[];_t(this.incomingEdges,t,n)(e);const r=n.indexOf(e);return r>=0&&n.splice(r,1),n}else throw new C(`Node does not exist: ${e}`)}overallOrder(e){const t=this,n=[],i=Object.keys(this.nodes);if(i.length===0)return n;{const r=_t(this.outgoingEdges,!1,[]);i.forEach(function(a){r(a)});const s=_t(this.outgoingEdges,e,n);return i.filter(function(a){return t.incomingEdges[a].length===0}).forEach(function(a){s(a)}),n}}}class Io{validateMany(e,t){e.forEach(n=>this.validate(n,e,t)),this.validateDependencies(e),this.validateEagerRelations(e)}validate(e,t,n){if(!e.primaryColumns.length&&!e.isJunction)throw new aa(e);if(e.primaryColumns.length>1&&!e.primaryColumns.every((s,a,o)=>s.primaryKeyConstraintName===o[0].primaryKeyConstraintName))throw new C(`Entity ${e.name} has multiple primary columns with different constraint names. Constraint names should be the equal.`);if(e.inheritancePattern==="STI"||e.tableType==="entity-child"){if(!e.discriminatorColumn)throw new C(`Entity ${e.name} using single-table inheritance, it should also have a discriminator column. Did you forget to put discriminator column options?`);if(typeof e.discriminatorValue>"u")throw new C(`Entity ${e.name} has an undefined discriminator value. Discriminator value should be defined.`);const r=t.find(s=>s!==e&&(s.inheritancePattern==="STI"||s.tableType==="entity-child")&&s.tableName===e.tableName&&s.discriminatorValue===e.discriminatorValue&&s.inheritanceTree.some(a=>e.inheritanceTree.indexOf(a)!==-1));if(r)throw new C(`Entities ${e.name} and ${r.name} have the same discriminator values. Make sure they are different while using the @ChildEntity decorator.`)}if(e.relationCounts.forEach(r=>{if(r.relation.isManyToOne||r.relation.isOneToOne)throw new C("Relation count can not be implemented on ManyToOne or OneToOne relations.")}),n.options.type!=="mongodb"&&e.columns.filter(r=>!r.isVirtualProperty).forEach(r=>{const s=n.normalizeType(r);if(!n.supportedDataTypes.includes(s))throw new pa(r,s,n.options.type);if(r.length&&!n.withLengthColumnTypes.includes(s))throw new C(`Column ${r.propertyName} of Entity ${e.name} does not support length property.`);if(r.type==="enum"&&!r.enum&&!r.enumName)throw new C(`Column "${r.propertyName}" of Entity "${e.name}" is defined as enum, but missing "enum" or "enumName" properties.`)}),(k.isMySQLFamily(n)||n.options.type==="aurora-mysql")&&e.columns.filter(s=>s.isGenerated&&s.generationStrategy!=="uuid").length>1)throw new C(`Error in ${e.name} entity. There can be only one auto-increment column in MySql table.`);if(k.isMySQLFamily(n)&&t.filter(s=>s.database).length===0&&!n.database)throw new Ea("database");if(n.options.type==="mssql"&&e.columns.filter(s=>s.charset).length>1)throw new C("Character set specifying is not supported in Sql Server");if(n.options.type==="postgres"){const r=e.columns.find(s=>s.asExpression&&(!s.generatedType||s.generatedType==="VIRTUAL"));if(r)throw new C(`Column "${r.propertyName}" of Entity "${e.name}" is defined as VIRTUAL, but Postgres supports only STORED generated columns.`)}const i=e.create(void 0,{fromDeserializer:!0});e.relations.forEach(r=>{if(r.isManyToMany||r.isOneToMany){if(r.persistenceEnabled===!1)return;const s=r.getEntityValue(i);if(Array.isArray(s))throw new ma(r)}}),e.relations.forEach(r=>{if(n.supportedOnDeleteTypes&&r.onDelete&&!n.supportedOnDeleteTypes.includes(r.onDelete))throw new C(`OnDeleteType "${r.onDelete}" is not supported for ${n.options.type}!`);if(n.supportedOnUpdateTypes&&r.onUpdate&&!n.supportedOnUpdateTypes.includes(r.onUpdate))throw new C(`OnUpdateType "${r.onUpdate}" is not valid for ${n.options.type}!`)}),e.relations.forEach(r=>{if(r.isCascadeRemove&&r.inverseRelation&&r.inverseRelation.isCascadeRemove)throw new C(`Relation ${e.name}#${r.propertyName} and ${r.inverseRelation.entityMetadata.name}#${r.inverseRelation.propertyName} both has cascade remove set. This may lead to unexpected circular removals. Please set cascade remove only from one side of relationship.`)})}validateDependencies(e){const t=new Oo;e.forEach(n=>{t.addNode(n.name)}),e.forEach(n=>{n.relationsWithJoinColumns.filter(i=>!i.isNullable).forEach(i=>{t.addDependency(n.name,i.inverseEntityMetadata.name)})});try{t.overallOrder()}catch(n){throw new sa(n.toString().replace("Error: Dependency Cycle Found: ",""))}}validateEagerRelations(e){e.forEach(t=>{t.eagerRelations.forEach(n=>{if(n.inverseRelation&&n.inverseRelation.isEager)throw new C(`Circular eager relations are disallowed. ${t.targetName}#${n.propertyPath} contains "eager: true", and its inverse side ${n.inverseEntityMetadata.targetName}#${n.inverseRelation.propertyPath} contains "eager: true" as well. Remove "eager: true" from one side of the relation.`)})})}}class Do{}class qo{}class $o{}class Bs{}class _o{}class Lo{}class Bo{}class Gr{}class Uo{}class Fo{}class jo{}class mt{static createRelationMaps(e,t,n,i){return i.map(r=>{const s=t.treeParentRelation.joinColumns[0],a=s.referencedColumn??t.primaryColumns[0],o=s.givenDatabaseName||s.databaseName,c=a.givenDatabaseName||a.databaseName,u=r[n+"_"+c],l=r[n+"_"+o];return{id:e.connection.driver.prepareHydratedValue(u,a),parentId:e.connection.driver.prepareHydratedValue(l,s)}})}static buildChildrenEntityTree(e,t,n,i,r){const s=e.treeChildrenRelation.propertyName;if(r.depth===0){t[s]=[];return}const o=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],c=o.getEntityValue(t),u=i.filter(h=>h.parentId===c),l=new Set(u.map(h=>h.id));t[s]=n.filter(h=>l.has(o.getEntityValue(h))),t[s].forEach(h=>{mt.buildChildrenEntityTree(e,h,n,i,{...r,depth:r.depth-1})})}static buildParentEntityTree(e,t,n,i){const r=e.treeParentRelation.propertyName,a=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],o=a.getEntityValue(t),c=i.find(l=>l.id===o),u=n.find(l=>c?a.getEntityValue(l)===c.parentId:!1);u&&(t[r]=u,mt.buildParentEntityTree(e,t[r],n,i))}}function zr(p,e){var t=Object.keys(p);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(p);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(p,i).enumerable})),t.push.apply(t,n)}return t}function Kr(p){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zr(Object(t),!0).forEach(function(n){Qo(p,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(t)):zr(Object(t)).forEach(function(n){Object.defineProperty(p,n,Object.getOwnPropertyDescriptor(t,n))})}return p}function Qo(p,e,t){return e=ko(e),e in p?Object.defineProperty(p,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):p[e]=t,p}function ko(p){var e=Vo(p,"string");return typeof e=="symbol"?e:String(e)}function Vo(p,e){if(typeof p!="object"||p===null)return p;var t=p[Symbol.toPrimitive];if(t!==void 0){var n=t.call(p,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(p)}const Wo=Us({});function Us(p){return e.withOptions=t=>Us(Kr(Kr({},p),t)),e;function e(t,...n){const i=typeof t=="string"?[t]:t.raw,{alignValues:r=!1,escapeSpecialCharacters:s=Array.isArray(t),trimWhitespace:a=!0}=p;let o="";for(let l=0;l<i.length;l++){let h=i[l];if(s&&(h=h.replace(/\\\n[ \t]*/g,"").replace(/\\`/g,"`").replace(/\\\$/g,"$").replace(/\\\{/g,"{")),o+=h,l<n.length){const m=r?Ho(n[l],o):n[l];o+=m}}const c=o.split(`
`);let u=null;for(const l of c){const h=l.match(/^(\s+)\S+/);if(h){const m=h[1].length;u?u=Math.min(u,m):u=m}}if(u!==null){const l=u;o=c.map(h=>h[0]===" "||h[0]==="	"?h.slice(l):h).join(`
`)}return a&&(o=o.trim()),s&&(o=o.replace(/\\n/g,`
`)),o}}function Ho(p,e){if(typeof p!="string"||!p.includes(`
`))return p;const n=e.slice(e.lastIndexOf(`
`)+1).match(/^(\s+)/);if(n){const i=n[1];return p.replace(/\n/g,`
${i}`)}return p}function Yt({driver:p,strings:e,expressions:t}){let n="";const i=[];let r=0;for(const[s,a]of t.entries()){if(n+=e[s],a===null){n+="NULL";continue}if(typeof a=="function"){const o=a();if(typeof o=="string"){n+=o;continue}if(Array.isArray(o)){if(o.length===0)throw new Error(`Expression ${s} in this sql tagged template is a function which returned an empty array. Empty arrays cannot safely be expanded into parameter lists.`);const c=o.map(()=>p.createParameter(`param_${r+1}`,r++));n+=c.join(", "),i.push(...o);continue}throw new Error(`Expression ${s} in this sql tagged template is a function which returned a value of type "${o===null?"null":typeof o}". Only array and string types are supported as function return values in sql tagged template expressions.`)}n+=p.createParameter(`param_${r+1}`,r++),i.push(a)}return n+=e[e.length-1],n=Wo(n),{query:n,parameters:i}}class Fs{get metadata(){return this.manager.connection.getMetadata(this.target)}constructor(e,t,n){this.target=e,this.manager=t,this.queryRunner=n}createQueryBuilder(e,t){return this.manager.createQueryBuilder(this.metadata.target,e||this.metadata.targetName,t||this.queryRunner)}hasId(e){return this.manager.hasId(this.metadata.target,e)}getId(e){return this.manager.getId(this.metadata.target,e)}create(e){return this.manager.create(this.metadata.target,e)}merge(e,...t){return this.manager.merge(this.metadata.target,e,...t)}preload(e){return this.manager.preload(this.metadata.target,e)}save(e,t){return this.manager.save(this.metadata.target,e,t)}remove(e,t){return this.manager.remove(this.metadata.target,e,t)}softRemove(e,t){return this.manager.softRemove(this.metadata.target,e,t)}recover(e,t){return this.manager.recover(this.metadata.target,e,t)}insert(e){return this.manager.insert(this.metadata.target,e)}update(e,t){return this.manager.update(this.metadata.target,e,t)}updateAll(e){return this.manager.updateAll(this.metadata.target,e)}upsert(e,t){return this.manager.upsert(this.metadata.target,e,t)}delete(e){return this.manager.delete(this.metadata.target,e)}deleteAll(){return this.manager.deleteAll(this.metadata.target)}softDelete(e){return this.manager.softDelete(this.metadata.target,e)}restore(e){return this.manager.restore(this.metadata.target,e)}exist(e){return this.manager.exists(this.metadata.target,e)}exists(e){return this.manager.exists(this.metadata.target,e)}existsBy(e){return this.manager.existsBy(this.metadata.target,e)}count(e){return this.manager.count(this.metadata.target,e)}countBy(e){return this.manager.countBy(this.metadata.target,e)}sum(e,t){return this.manager.sum(this.metadata.target,e,t)}average(e,t){return this.manager.average(this.metadata.target,e,t)}minimum(e,t){return this.manager.minimum(this.metadata.target,e,t)}maximum(e,t){return this.manager.maximum(this.metadata.target,e,t)}async find(e){return this.manager.find(this.metadata.target,e)}async findBy(e){return this.manager.findBy(this.metadata.target,e)}findAndCount(e){return this.manager.findAndCount(this.metadata.target,e)}findAndCountBy(e){return this.manager.findAndCountBy(this.metadata.target,e)}async findByIds(e){return this.manager.findByIds(this.metadata.target,e)}async findOne(e){return this.manager.findOne(this.metadata.target,e)}async findOneBy(e){return this.manager.findOneBy(this.metadata.target,e)}async findOneById(e){return this.manager.findOneById(this.metadata.target,e)}async findOneOrFail(e){return this.manager.findOneOrFail(this.metadata.target,e)}async findOneByOrFail(e){return this.manager.findOneByOrFail(this.metadata.target,e)}query(e,t){return this.manager.query(e,t)}async sql(e,...t){const{query:n,parameters:i}=Yt({driver:this.manager.connection.driver,strings:e,expressions:t});return await this.query(n,i)}clear(){return this.manager.clear(this.metadata.target)}increment(e,t,n){return this.manager.increment(this.metadata.target,e,t,n)}decrement(e,t,n){return this.manager.decrement(this.metadata.target,e,t,n)}extend(e){const t=this.constructor,{target:n,manager:i,queryRunner:r}=this,s=class extends t{constructor(a,o,c){super(a,o,c)}};for(const a in e)s.prototype[a]=e[a];return new s(n,i,r)}}class Go extends Fs{async findTrees(e){const t=await this.findRoots(e);return await Promise.all(t.map(n=>this.findDescendantsTree(n,e))),t}findRoots(e){const t=a=>this.manager.connection.driver.escape(a),n=a=>this.manager.connection.driver.escape(a),i=this.metadata.treeParentRelation.joinColumns[0],r=i.givenDatabaseName||i.databaseName,s=this.createQueryBuilder("treeEntity");return _e.applyOptionsToTreeQueryBuilder(s,e),s.where(`${t("treeEntity")}.${n(r)} IS NULL`).getMany()}findDescendants(e,t){const n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);return _e.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findDescendantsTree(e,t){const n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);_e.applyOptionsToTreeQueryBuilder(n,t);const i=await n.getRawAndEntities(),r=mt.createRelationMaps(this.manager,this.metadata,"treeEntity",i.raw);return mt.buildChildrenEntityTree(this.metadata,e,i.entities,r,{depth:-1,...t}),e}countDescendants(e){return this.createDescendantsQueryBuilder("treeEntity","treeClosure",e).getCount()}createDescendantsQueryBuilder(e,t,n){const i=r=>this.manager.connection.driver.escape(r);if(this.metadata.treeType==="closure-table"){const r=this.metadata.closureJunctionTable.descendantColumns.map(o=>i(t)+"."+i(o.propertyPath)+" = "+i(e)+"."+i(o.referencedColumn.propertyPath)).join(" AND "),s={},a=this.metadata.closureJunctionTable.ancestorColumns.map(o=>(s[o.referencedColumn.propertyName]=o.referencedColumn.getEntityValue(n),i(t)+"."+i(o.propertyPath)+" = :"+o.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,r).where(a).setParameters(s)}else if(this.metadata.treeType==="nested-set"){const r=e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN joined."+this.metadata.nestedSetLeftColumn.propertyPath+" AND joined."+this.metadata.nestedSetRightColumn.propertyPath,s={},a=this.metadata.treeParentRelation.joinColumns.map(o=>{const c=o.referencedColumn.propertyPath.replace(".","_");return s[c]=o.referencedColumn.getEntityValue(n),"joined."+o.referencedColumn.propertyPath+" = :"+c}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",r).where(a,s)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(r=>{const s=r.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return k.isSQLiteFamily(this.manager.connection.driver)?`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE ${s.getQuery()} || '%'`:`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE NULLIF(CONCAT(${s.getQuery()}, '%'), '%')`});throw new C("Supported only in tree entities")}findAncestors(e,t){const n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);return _e.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findAncestorsTree(e,t){const n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);_e.applyOptionsToTreeQueryBuilder(n,t);const i=await n.getRawAndEntities(),r=mt.createRelationMaps(this.manager,this.metadata,"treeEntity",i.raw);return mt.buildParentEntityTree(this.metadata,e,i.entities,r),e}countAncestors(e){return this.createAncestorsQueryBuilder("treeEntity","treeClosure",e).getCount()}createAncestorsQueryBuilder(e,t,n){if(this.metadata.treeType==="closure-table"){const i=this.metadata.closureJunctionTable.ancestorColumns.map(a=>t+"."+a.propertyPath+" = "+e+"."+a.referencedColumn.propertyPath).join(" AND "),r={},s=this.metadata.closureJunctionTable.descendantColumns.map(a=>(r[a.referencedColumn.propertyName]=a.referencedColumn.getEntityValue(n),t+"."+a.propertyPath+" = :"+a.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,i).where(s).setParameters(r)}else if(this.metadata.treeType==="nested-set"){const i="joined."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN "+e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" AND "+e+"."+this.metadata.nestedSetRightColumn.propertyPath,r={},s=this.metadata.treeParentRelation.joinColumns.map(a=>{const o=a.referencedColumn.propertyPath.replace(".","_");return r[o]=a.referencedColumn.getEntityValue(n),"joined."+a.referencedColumn.propertyPath+" = :"+o}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",i).where(s,r)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(i=>{const r=i.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return k.isSQLiteFamily(this.manager.connection.driver)?`${r.getQuery()} LIKE ${e}.${this.metadata.materializedPathColumn.propertyPath} || '%'`:`${r.getQuery()} LIKE CONCAT(${e}.${this.metadata.materializedPathColumn.propertyPath}, '%')`});throw new C("Supported only in tree entities")}}class zo{transform(e,t,n,i=!1){return this.groupAndTransform(e,t,n,i),e}groupAndTransform(e,t,n,i=!1){n.nonVirtualColumns.forEach(r=>{const s=r.getEntityValue(t);s!==void 0&&r.setEntityValue(e,s)}),n.relations.length&&n.relations.forEach(r=>{let s=r.getEntityValue(e);const a=r.getEntityValue(t,i);if(a!==void 0)if(r.isOneToMany||r.isManyToMany){if(!Array.isArray(a))return;s||(s=[],r.setEntityValue(e,s)),a.forEach(o=>{let c=s.find(l=>r.inverseEntityMetadata.compareEntities(o,l));const u=r.inverseEntityMetadata.findInheritanceMetadata(o);c||(c=u.create(void 0,{fromDeserializer:!0}),s.push(c)),this.groupAndTransform(c,o,u,i)})}else{if(!oe.isObject(a)){oe.isObject(s)||r.setEntityValue(e,a);return}const o=r.inverseEntityMetadata.findInheritanceMetadata(a);s||(s=o.create(void 0,{fromDeserializer:!0}),r.setEntityValue(e,s)),this.groupAndTransform(s,a,o,i)}})}}class Ko{constructor(e,t,n,i){this.plainEntity=e,this.metadata=t,this.parentLoadMapItem=n,this.relation=i}get target(){return this.metadata.target}get id(){return this.metadata.getEntityIdMixedMap(this.plainEntity)}}class Jo{constructor(){this.loadMapItems=[]}get mainLoadMapItem(){return this.loadMapItems.find(e=>!e.relation&&!e.parentLoadMapItem)}addLoadMap(e){this.loadMapItems.find(n=>n.target===e.target&&n.id===e.id)||this.loadMapItems.push(e)}fillEntities(e,t){t.forEach(n=>{const i=this.loadMapItems.find(r=>r.target===e&&r.metadata.compareEntities(n,r.plainEntity));i&&(i.entity=n)})}groupByTargetIds(){const e=[];return this.loadMapItems.forEach(t=>{let n=e.find(i=>i.target===t.target);n||(n={target:t.target,ids:[]},e.push(n)),n.ids.push(t.id)}),e}}class Yo{constructor(e){this.manager=e}async transform(e,t){if(!t.hasAllPrimaryKeys(e))return Promise.reject("Given object does not have a primary column, cannot transform it to database entity.");const n=new Jo,i=(r,s,a,o)=>{const c=new Ko(r,s,a,o);n.addLoadMap(c),s.extractRelationValuesFromEntity(r,t.relations).filter(u=>u!=null).forEach(([u,l,h])=>i(l,h,c,u))};return i(e,t),await Promise.all(n.groupByTargetIds().map(r=>this.manager.findByIds(r.target,r.ids).then(s=>n.fillEntities(r.target,s)))),n.loadMapItems.forEach(r=>{!r.relation||!r.entity||!r.parentLoadMapItem||!r.parentLoadMapItem.entity||(r.relation.isManyToMany||r.relation.isOneToMany?(r.parentLoadMapItem.entity[r.relation.propertyName]||(r.parentLoadMapItem.entity[r.relation.propertyName]=[]),r.parentLoadMapItem.entity[r.relation.propertyName].push(r.entity)):r.parentLoadMapItem.entity[r.relation.propertyName]=r.entity)}),n.mainLoadMapItem?n.mainLoadMapItem.entity:void 0}}class Xo{get repository(){const e=this.getCustomRepositoryTarget(this);if(!e)throw new rn(this.constructor);return this.manager.getRepository(e)}get treeRepository(){const e=this.getCustomRepositoryTarget(this);if(!e)throw new rn(this.constructor);return this.manager.getTreeRepository(e)}createQueryBuilder(e){const t=this.getCustomRepositoryTarget(this.constructor);if(!t)throw new rn(this.constructor);return this.manager.getRepository(t).createQueryBuilder(e)}createQueryBuilderFor(e,t){return this.getRepositoryFor(e).createQueryBuilder(t)}getRepositoryFor(e){return this.manager.getRepository(e)}getTreeRepositoryFor(e){return this.manager.getTreeRepository(e)}getCustomRepositoryTarget(e){const t=Gt().entityRepositories.find(n=>n.target===(typeof e=="function"?e:e.constructor));if(!t)throw new Es(e);return t.entity}}class Jr{constructor(e){this.subjects=[...e],this.metadatas=this.getUniqueMetadatas(this.subjects)}sort(e){if(!this.metadatas.length)return this.subjects;const t=[];if(e==="delete"){const a=this.subjects.filter(o=>!o.entity&&!o.databaseEntity);t.push(...a),this.removeAlreadySorted(a)}const n=this.getNonNullableDependencies();let i=this.toposort(n);e==="insert"&&(i=i.reverse()),i.forEach(a=>{const o=this.subjects.filter(c=>c.metadata.targetName===a||c.metadata.inheritanceTree.some(u=>u.name===a));t.push(...o),this.removeAlreadySorted(o)});const r=this.getDependencies();let s=this.toposort(r);return e==="insert"&&(s=s.reverse()),s.forEach(a=>{const o=this.subjects.filter(c=>c.metadata.targetName===a);t.push(...o),this.removeAlreadySorted(o)}),t.push(...this.subjects),t}removeAlreadySorted(e){e.forEach(t=>{this.subjects.splice(this.subjects.indexOf(t),1)})}getUniqueMetadatas(e){const t=[];return e.forEach(n=>{t.indexOf(n.metadata)===-1&&t.push(n.metadata)}),t}getNonNullableDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.isNullable||e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}getDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.inverseEntityMetadata!==t&&e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}toposort(e){function t(c){const u=[];for(let l=0,h=c.length;l<h;l++){const m=c[l];u.indexOf(m[0])<0&&u.push(m[0]),u.indexOf(m[1])<0&&u.push(m[1])}return u}const n=t(e);let i=n.length,r=i;const s=new Array(i),a=new Set;for(;r--;)a.has(r)||o(n[r],r,[]);function o(c,u,l){if(l.indexOf(c)>=0)throw new C("Cyclic dependency: "+JSON.stringify(c));if(!~n.indexOf(c))throw new C("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(c));if(a.has(u))return;a.add(u);const h=e.filter(function(m){return m[0]===c});if(u=h.length){const m=l.concat(c);do{const y=h[--u][1];o(y,n.indexOf(y),m)}while(u)}s[--i]=c}return s}}var Qt={exports:{}},Zo=Qt.exports,Yr;function ec(){return Yr||(Yr=1,(function(p,e){(function(t,n){p.exports=n()})(Zo,(function(){var t=1e3,n=6e4,i=36e5,r="millisecond",s="second",a="minute",o="hour",c="day",u="week",l="month",h="quarter",m="year",y="date",g="Invalid Date",b=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,R=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,P={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(D){var q=["th","st","nd","rd"],_=D%100;return"["+D+(q[(_-20)%10]||q[_]||q[0])+"]"}},M=function(D,q,_){var I=String(D);return!I||I.length>=q?D:""+Array(q+1-I.length).join(_)+D},U={s:M,z:function(D){var q=-D.utcOffset(),_=Math.abs(q),I=Math.floor(_/60),B=_%60;return(q<=0?"+":"-")+M(I,2,"0")+":"+M(B,2,"0")},m:function D(q,_){if(q.date()<_.date())return-D(_,q);var I=12*(_.year()-q.year())+(_.month()-q.month()),B=q.clone().add(I,l),W=_-B<0,ee=q.clone().add(I+(W?-1:1),l);return+(-(I+(_-B)/(W?B-ee:ee-B))||0)},a:function(D){return D<0?Math.ceil(D)||0:Math.floor(D)},p:function(D){return{M:l,y:m,w:u,d:c,D:y,h:o,m:a,s,ms:r,Q:h}[D]||String(D||"").toLowerCase().replace(/s$/,"")},u:function(D){return D===void 0}},F="en",J={};J[F]=P;var K="$isDayjsObject",re=function(D){return D instanceof V||!(!D||!D[K])},$=function D(q,_,I){var B;if(!q)return F;if(typeof q=="string"){var W=q.toLowerCase();J[W]&&(B=W),_&&(J[W]=_,B=W);var ee=q.split("-");if(!B&&ee.length>1)return D(ee[0])}else{var ie=q.name;J[ie]=q,B=ie}return!I&&B&&(F=B),B||!I&&F},Y=function(D,q){if(re(D))return D.clone();var _=typeof q=="object"?q:{};return _.date=D,_.args=arguments,new V(_)},S=U;S.l=$,S.i=re,S.w=function(D,q){return Y(D,{locale:q.$L,utc:q.$u,x:q.$x,$offset:q.$offset})};var V=(function(){function D(_){this.$L=$(_.locale,null,!0),this.parse(_),this.$x=this.$x||_.x||{},this[K]=!0}var q=D.prototype;return q.parse=function(_){this.$d=(function(I){var B=I.date,W=I.utc;if(B===null)return new Date(NaN);if(S.u(B))return new Date;if(B instanceof Date)return new Date(B);if(typeof B=="string"&&!/Z$/i.test(B)){var ee=B.match(b);if(ee){var ie=ee[2]-1||0,ce=(ee[7]||"0").substring(0,3);return W?new Date(Date.UTC(ee[1],ie,ee[3]||1,ee[4]||0,ee[5]||0,ee[6]||0,ce)):new Date(ee[1],ie,ee[3]||1,ee[4]||0,ee[5]||0,ee[6]||0,ce)}}return new Date(B)})(_),this.init()},q.init=function(){var _=this.$d;this.$y=_.getFullYear(),this.$M=_.getMonth(),this.$D=_.getDate(),this.$W=_.getDay(),this.$H=_.getHours(),this.$m=_.getMinutes(),this.$s=_.getSeconds(),this.$ms=_.getMilliseconds()},q.$utils=function(){return S},q.isValid=function(){return this.$d.toString()!==g},q.isSame=function(_,I){var B=Y(_);return this.startOf(I)<=B&&B<=this.endOf(I)},q.isAfter=function(_,I){return Y(_)<this.startOf(I)},q.isBefore=function(_,I){return this.endOf(I)<Y(_)},q.$g=function(_,I,B){return S.u(_)?this[I]:this.set(B,_)},q.unix=function(){return Math.floor(this.valueOf()/1e3)},q.valueOf=function(){return this.$d.getTime()},q.startOf=function(_,I){var B=this,W=!!S.u(I)||I,ee=S.p(_),ie=function(ge,ae){var he=S.w(B.$u?Date.UTC(B.$y,ae,ge):new Date(B.$y,ae,ge),B);return W?he:he.endOf(c)},ce=function(ge,ae){return S.w(B.toDate()[ge].apply(B.toDate("s"),(W?[0,0,0,0]:[23,59,59,999]).slice(ae)),B)},H=this.$W,we=this.$M,Oe=this.$D,ye="set"+(this.$u?"UTC":"");switch(ee){case m:return W?ie(1,0):ie(31,11);case l:return W?ie(1,we):ie(0,we+1);case u:var qe=this.$locale().weekStart||0,Ne=(H<qe?H+7:H)-qe;return ie(W?Oe-Ne:Oe+(6-Ne),we);case c:case y:return ce(ye+"Hours",0);case o:return ce(ye+"Minutes",1);case a:return ce(ye+"Seconds",2);case s:return ce(ye+"Milliseconds",3);default:return this.clone()}},q.endOf=function(_){return this.startOf(_,!1)},q.$set=function(_,I){var B,W=S.p(_),ee="set"+(this.$u?"UTC":""),ie=(B={},B[c]=ee+"Date",B[y]=ee+"Date",B[l]=ee+"Month",B[m]=ee+"FullYear",B[o]=ee+"Hours",B[a]=ee+"Minutes",B[s]=ee+"Seconds",B[r]=ee+"Milliseconds",B)[W],ce=W===c?this.$D+(I-this.$W):I;if(W===l||W===m){var H=this.clone().set(y,1);H.$d[ie](ce),H.init(),this.$d=H.set(y,Math.min(this.$D,H.daysInMonth())).$d}else ie&&this.$d[ie](ce);return this.init(),this},q.set=function(_,I){return this.clone().$set(_,I)},q.get=function(_){return this[S.p(_)]()},q.add=function(_,I){var B,W=this;_=Number(_);var ee=S.p(I),ie=function(we){var Oe=Y(W);return S.w(Oe.date(Oe.date()+Math.round(we*_)),W)};if(ee===l)return this.set(l,this.$M+_);if(ee===m)return this.set(m,this.$y+_);if(ee===c)return ie(1);if(ee===u)return ie(7);var ce=(B={},B[a]=n,B[o]=i,B[s]=t,B)[ee]||1,H=this.$d.getTime()+_*ce;return S.w(H,this)},q.subtract=function(_,I){return this.add(-1*_,I)},q.format=function(_){var I=this,B=this.$locale();if(!this.isValid())return B.invalidDate||g;var W=_||"YYYY-MM-DDTHH:mm:ssZ",ee=S.z(this),ie=this.$H,ce=this.$m,H=this.$M,we=B.weekdays,Oe=B.months,ye=B.meridiem,qe=function(ae,he,me,fe){return ae&&(ae[he]||ae(I,W))||me[he].slice(0,fe)},Ne=function(ae){return S.s(ie%12||12,ae,"0")},ge=ye||function(ae,he,me){var fe=ae<12?"AM":"PM";return me?fe.toLowerCase():fe};return W.replace(R,(function(ae,he){return he||(function(me){switch(me){case"YY":return String(I.$y).slice(-2);case"YYYY":return S.s(I.$y,4,"0");case"M":return H+1;case"MM":return S.s(H+1,2,"0");case"MMM":return qe(B.monthsShort,H,Oe,3);case"MMMM":return qe(Oe,H);case"D":return I.$D;case"DD":return S.s(I.$D,2,"0");case"d":return String(I.$W);case"dd":return qe(B.weekdaysMin,I.$W,we,2);case"ddd":return qe(B.weekdaysShort,I.$W,we,3);case"dddd":return we[I.$W];case"H":return String(ie);case"HH":return S.s(ie,2,"0");case"h":return Ne(1);case"hh":return Ne(2);case"a":return ge(ie,ce,!0);case"A":return ge(ie,ce,!1);case"m":return String(ce);case"mm":return S.s(ce,2,"0");case"s":return String(I.$s);case"ss":return S.s(I.$s,2,"0");case"SSS":return S.s(I.$ms,3,"0");case"Z":return ee}return null})(ae)||ee.replace(":","")}))},q.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},q.diff=function(_,I,B){var W,ee=this,ie=S.p(I),ce=Y(_),H=(ce.utcOffset()-this.utcOffset())*n,we=this-ce,Oe=function(){return S.m(ee,ce)};switch(ie){case m:W=Oe()/12;break;case l:W=Oe();break;case h:W=Oe()/3;break;case u:W=(we-H)/6048e5;break;case c:W=(we-H)/864e5;break;case o:W=we/i;break;case a:W=we/n;break;case s:W=we/t;break;default:W=we}return B?W:S.a(W)},q.daysInMonth=function(){return this.endOf(l).$D},q.$locale=function(){return J[this.$L]},q.locale=function(_,I){if(!_)return this.$L;var B=this.clone(),W=$(_,I,!0);return W&&(B.$L=W),B},q.clone=function(){return S.w(this.$d,this)},q.toDate=function(){return new Date(this.valueOf())},q.toJSON=function(){return this.isValid()?this.toISOString():null},q.toISOString=function(){return this.$d.toISOString()},q.toString=function(){return this.$d.toUTCString()},D})(),L=V.prototype;return Y.prototype=L,[["$ms",r],["$s",s],["$m",a],["$H",o],["$W",c],["$M",l],["$y",m],["$D",y]].forEach((function(D){L[D[1]]=function(q){return this.$g(q,D[0],D[1])}})),Y.extend=function(D,q){return D.$i||(D(q,V,Y),D.$i=!0),Y},Y.locale=$,Y.isDayjs=re,Y.unix=function(D){return Y(1e3*D)},Y.en=J[F],Y.Ls=J,Y.p={},Y}))})(Qt)),Qt.exports}var tc=ec();const nc=ms(tc);class ne{static normalizeHydratedDate(e){return e&&(typeof e=="string"?new Date(e):e)}static mixedDateToDateString(e){return e instanceof Date?this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate()):e}static mixedDateToDate(e,t=!1,n=!0){let i=typeof e=="string"?nc(e).toDate():e;return t&&(i=new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds())),n||i.setUTCMilliseconds(0),i}static mixedDateToTimeString(e,t=!1){return e instanceof Date?this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+(t?"":":"+this.formatZerolessValue(e.getSeconds())):e}static mixedTimeToDate(e){if(typeof e=="string"){const[t,n,i]=e.split(":"),r=new Date;return t&&r.setHours(parseInt(t)),n&&r.setMinutes(parseInt(n)),i&&r.setSeconds(parseInt(i)),r}return e}static mixedTimeToString(e,t=!1){return e=e instanceof Date?e.getHours()+":"+e.getMinutes()+(t?"":":"+e.getSeconds()):e,typeof e=="string"?e.split(":").map(n=>n.length===1?"0"+n:n).join(":"):e}static mixedDateToDatetimeString(e,t){if(typeof e=="string"&&(e=new Date(e)),e instanceof Date){let n=this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate())+" "+this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+":"+this.formatZerolessValue(e.getSeconds());t&&(n+=`.${this.formatMilliseconds(e.getMilliseconds())}`),e=n}return e}static mixedDateToUtcDatetimeString(e){return typeof e=="string"&&(e=new Date(e)),e instanceof Date?this.formatZerolessValue(e.getUTCFullYear(),4)+"-"+this.formatZerolessValue(e.getUTCMonth()+1)+"-"+this.formatZerolessValue(e.getUTCDate())+" "+this.formatZerolessValue(e.getUTCHours())+":"+this.formatZerolessValue(e.getUTCMinutes())+":"+this.formatZerolessValue(e.getUTCSeconds())+"."+this.formatMilliseconds(e.getUTCMilliseconds()):e}static simpleArrayToString(e){return Array.isArray(e)?e.map(t=>String(t)).join(","):e}static stringToSimpleArray(e){return typeof e=="string"?e.length>0?e.split(","):[]:e}static simpleJsonToString(e){return JSON.stringify(e)}static stringToSimpleJson(e){return typeof e=="string"?JSON.parse(e):e}static simpleEnumToString(e){return""+e}static stringToSimpleEnum(e,t){return t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0&&(e=parseInt(e)),e}static formatZerolessValue(e,t=2){return`${"0".repeat(t)}${e}`.slice(-t)}static formatMilliseconds(e){return e<10?"00"+e:e<100?"0"+e:String(e)}}class ic{compute(e){e.forEach(t=>{this.computeDiffColumns(t),this.computeDiffRelationalColumns(e,t)})}computeDiffColumns(e){e.entity&&e.metadata.columns.forEach(t=>{if(t.isVirtual||t.isDiscriminator)return;const n=e.changeMaps.find(r=>r.column===t);n&&e.changeMaps.splice(e.changeMaps.indexOf(n),1);const i=t.getEntityValue(e.entity);if(i!==void 0){if(e.databaseEntity){const r=t.type!=="json"&&t.type!=="jsonb";let s=t.getEntityValue(e.databaseEntity,r);if(t.relationMetadata){const o=t.relationMetadata.getEntityValue(e.entity);if(o!=null)return}let a=i;if(i!==null&&s!==null){switch(t.type){case"date":a=t.isArray?i.map(o=>ne.mixedDateToDateString(o)):ne.mixedDateToDateString(i),s=t.isArray?s.map(o=>ne.mixedDateToDateString(o)):ne.mixedDateToDateString(s);break;case"time":case"time with time zone":case"time without time zone":case"timetz":a=t.isArray?i.map(o=>ne.mixedDateToTimeString(o)):ne.mixedDateToTimeString(i),s=t.isArray?s.map(o=>ne.mixedDateToTimeString(o)):ne.mixedDateToTimeString(s);break;case"datetime":case"datetime2":case Date:case"timestamp":case"timestamp without time zone":case"timestamp with time zone":case"timestamp with local time zone":case"timestamptz":a=t.isArray?i.map(o=>ne.mixedDateToUtcDatetimeString(o)):ne.mixedDateToUtcDatetimeString(i),s=t.isArray?s.map(o=>ne.mixedDateToUtcDatetimeString(o)):ne.mixedDateToUtcDatetimeString(s);break;case"json":case"jsonb":if(Q.deepCompare(i,s))return;break;case"simple-array":a=ne.simpleArrayToString(i),s=ne.simpleArrayToString(s);break;case"simple-enum":a=ne.simpleEnumToString(i),s=ne.simpleEnumToString(s);break;case"simple-json":a=ne.simpleJsonToString(i),s=ne.simpleJsonToString(s);break}t.transformer&&(a=De.transformTo(t.transformer,i))}if(t.isArray){if(Q.deepCompare(a,s))return}else if(Buffer.isBuffer(a)&&Buffer.isBuffer(s)){if(a.equals(s))return}else if(a===s)return}e.diffColumns.includes(t)||e.diffColumns.push(t),e.changeMaps.push({column:t,value:i})}})}computeDiffRelationalColumns(e,t){t.entity&&t.metadata.relationsWithJoinColumns.forEach(n=>{let i=n.getEntityValue(t.entity);if(i===void 0)return;if(t.databaseEntity){let a=i;a!==null&&oe.isObject(a)&&(a=n.getRelationIdMap(a));const o=n.getEntityValue(t.databaseEntity);if(Q.compareIds(a,o))return;t.diffRelations.push(n)}const r=e.find(a=>a.mustBeInserted&&a.entity===i);r&&(i=r);const s=t.changeMaps.find(a=>a.relation===n);s?s.value=i:t.changeMaps.push({relation:n,value:i})})}}class Xr extends C{constructor(){super("Nested sets do not support multiple root entities.")}}class di{constructor(e){this.queryRunner=e}async insert(e){const t=c=>this.queryRunner.connection.driver.escape(c),n=this.getTableName(e.metadata.tablePath),i=t(e.metadata.nestedSetLeftColumn.databaseName),r=t(e.metadata.nestedSetRightColumn.databaseName);let s=e.metadata.treeParentRelation.getEntityValue(e.entity);!s&&e.parentSubject&&e.parentSubject.entity&&(s=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);const a=e.metadata.getEntityIdMap(s);let o;if(a&&(o=await this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.nestedSetRightColumn.propertyPath,"right").from(e.metadata.target,e.metadata.targetName).whereInIds(a).getRawOne().then(c=>{const u=c?c.right:void 0;return typeof u=="string"?parseInt(u):u})),o!==void 0)await this.queryRunner.query(`UPDATE ${n} SET ${i} = CASE WHEN ${i} > ${o} THEN ${i} + 2 ELSE ${i} END,${r} = ${r} + 2 WHERE ${r} >= ${o}`),Q.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(o),e.metadata.nestedSetRightColumn.createValueMap(o+1));else{if(!await this.isUniqueRootEntity(e,s))throw new Xr;Q.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(1),e.metadata.nestedSetRightColumn.createValueMap(2))}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(a=>Object.entries(e.identifier).every(([o,c])=>a[o]===c))),n===void 0||t===void 0)return;const i=e.metadata.treeParentRelation.getEntityValue(n),r=e.metadata.getEntityIdMap(i),s=e.metadata.getEntityIdMap(t);if(!Q.compareIds(r,s)){if(t){const a=y=>this.queryRunner.connection.driver.escape(y),o=this.getTableName(e.metadata.tablePath),c=a(e.metadata.nestedSetLeftColumn.databaseName),u=a(e.metadata.nestedSetRightColumn.databaseName),l=e.metadata.getEntityIdMap(n);let h;l&&(h=(await this.getNestedSetIds(e.metadata,l))[0]);let m;if(s&&(m=(await this.getNestedSetIds(e.metadata,s))[0]),h!==void 0&&m!==void 0){const y=m.left>h.left,g=h.right-h.left+1;let b;y?b=m.left-h.right:b=m.right-h.left;const R=`WHEN ${c} >= ${h.left} AND ${c} < ${h.right} THEN ${c} + ${b} `,P=`WHEN ${u} > ${h.left} AND ${u} <= ${h.right} THEN ${u} + ${b} `;y?await this.queryRunner.query(`UPDATE ${o} SET ${c} = CASE WHEN ${c} > ${h.right} AND ${c} <= ${m.left} THEN ${c} - ${g} `+R+`ELSE ${c} END, ${u} = CASE WHEN ${u} > ${h.right} AND ${u} < ${m.left} THEN ${u} - ${g} `+P+`ELSE ${u} END`):await this.queryRunner.query(`UPDATE ${o} SET ${c} = CASE WHEN ${c} < ${h.left} AND ${c} > ${m.right} THEN ${c} + ${g} `+R+`ELSE ${c} END, ${u} = CASE WHEN ${u} < ${h.left} AND ${u} >= ${m.right} THEN ${u} + ${g} `+P+`ELSE ${u} END`)}}else if(!await this.isUniqueRootEntity(e,t))throw new Xr}}async remove(e){Array.isArray(e)||(e=[e]);const t=e[0].metadata,n=c=>this.queryRunner.connection.driver.escape(c),i=this.getTableName(t.tablePath),r=n(t.nestedSetLeftColumn.databaseName),s=n(t.nestedSetRightColumn.databaseName),a=[];for(const c of e){const u=t.getEntityIdMap(c.entity);u&&a.push(u)}const o=await this.getNestedSetIds(t,a);for(const c of o){const u=c.right-c.left+1;await this.queryRunner.query(`UPDATE ${i} SET ${r} = CASE WHEN ${r} > ${c.left} THEN ${r} - ${u} ELSE ${r} END, ${s} = CASE WHEN ${s} > ${c.right} THEN ${s} - ${u} ELSE ${s} END`)}}getNestedSetIds(e,t){const n={left:`${e.targetName}.${e.nestedSetLeftColumn.propertyPath}`,right:`${e.targetName}.${e.nestedSetRightColumn.propertyPath}`},i=this.queryRunner.manager.createQueryBuilder();return Object.entries(n).forEach(([r,s])=>{i.addSelect(s,r)}),i.from(e.target,e.targetName).whereInIds(t).orderBy(n.right,"DESC").getRawMany().then(r=>{const s=[];for(const a of r){const o={};for(const c of Object.keys(n)){const u=a?a[c]:void 0;o[c]=typeof u=="string"?parseInt(u):u}s.push(o)}return s})}async isUniqueRootEntity(e,t){const n=c=>this.queryRunner.connection.driver.escape(c),i=this.getTableName(e.metadata.tablePath),r=[],s=e.metadata.treeParentRelation.joinColumns.map(c=>{const u=n(c.databaseName),l=c.getEntityValue(t);if(l==null)return`${u} IS NULL`;r.push(l);const h=this.queryRunner.connection.driver.createParameter("entity_"+c.databaseName,r.length-1);return`${u} = ${h}`}).join(" AND "),a="count",o=await this.queryRunner.query(`SELECT COUNT(1) AS ${n(a)} FROM ${i} WHERE ${s}`,r,!0);return parseInt(o.records[0][a])===0}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}}class pi{constructor(e){this.queryRunner=e}async insert(e){const t={};e.metadata.closureJunctionTable.ancestorColumns.forEach(i=>{t[i.databaseName]=e.identifier}),e.metadata.closureJunctionTable.descendantColumns.forEach(i=>{t[i.databaseName]=e.identifier}),await this.queryRunner.manager.createQueryBuilder().insert().into(e.metadata.closureJunctionTable.tablePath).values(t).updateEntity(!1).callListeners(!1).execute();let n=e.metadata.treeParentRelation.getEntityValue(e.entity);if(!n&&e.parentSubject&&e.parentSubject.entity&&(n=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity),n){const i=l=>this.queryRunner.connection.driver.escape(l),r=this.getTableName(e.metadata.closureJunctionTable.tablePath),s=[],a=e.metadata.closureJunctionTable.ancestorColumns.map(l=>i(l.databaseName)),o=e.metadata.closureJunctionTable.descendantColumns.map(l=>i(l.databaseName)),c=e.metadata.primaryColumns.map(l=>(s.push(l.getEntityValue(e.insertedValueSet?e.insertedValueSet:e.entity)),this.queryRunner.connection.driver.createParameter("child_entity_"+l.databaseName,s.length-1))),u=e.metadata.closureJunctionTable.descendantColumns.map(l=>{const h=i(l.databaseName),m=l.referencedColumn.getEntityValue(n);if(!m)throw new Di(e.metadata.name);s.push(m);const y=this.queryRunner.connection.driver.createParameter("parent_entity_"+l.referencedColumn.databaseName,s.length-1);return`${h} = ${y}`});await this.queryRunner.query(`INSERT INTO ${r} (${[...a,...o].join(", ")}) SELECT ${a.join(", ")}, ${c.join(", ")} FROM ${r} WHERE ${u.join(" AND ")}`,s)}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(m=>Object.entries(e.identifier).every(([y,g])=>m[y]===g))),n===void 0||t===void 0)return;const i=e.metadata.treeParentRelation.getEntityValue(n),r=e.metadata.getEntityIdMap(i),s=e.metadata.getEntityIdMap(t);if(Q.compareIds(r,s))return;const a=m=>this.queryRunner.connection.driver.escape(m),o=e.metadata.closureJunctionTable,c=o.ancestorColumns.map(m=>a(m.databaseName)),u=o.descendantColumns.map(m=>a(m.databaseName)),l=(m,y)=>{const g=`sub${y}`,b=m.createQueryBuilder().select(u.join(", ")).from(o.tablePath,g);for(const R of o.ancestorColumns)b.andWhere(`${a(g)}.${a(R.databaseName)} = :value_${R.referencedColumn.databaseName}`);return m.createQueryBuilder().select(u.join(", ")).from(`(${b.getQuery()})`,y).setParameters(b.getParameters()).getQuery()},h={};for(const m of e.metadata.primaryColumns)h[`value_${m.databaseName}`]=n[m.databaseName];if(await this.queryRunner.manager.createQueryBuilder().delete().from(o.tablePath).where(m=>`(${u.join(", ")}) IN (${l(m,"descendant")})`).andWhere(m=>`(${c.join(", ")}) NOT IN (${l(m,"ancestor")})`).setParameters(h).execute(),t){const m=[],y=this.getTableName(o.tablePath),g=a("supertree"),b=a("subtree"),R=[...c.map(U=>`${g}.${U}`),...u.map(U=>`${b}.${U}`)],P=e.metadata.closureJunctionTable.ancestorColumns.map(U=>{const F=a(U.databaseName),J=U.referencedColumn.getEntityValue(n);m.push(J);const K=this.queryRunner.connection.driver.createParameter("entity_"+U.referencedColumn.databaseName,m.length-1);return`${b}.${F} = ${K}`}),M=e.metadata.closureJunctionTable.descendantColumns.map(U=>{const F=a(U.databaseName),J=U.referencedColumn.getEntityValue(t);if(!J)throw new Di(e.metadata.name);m.push(J);const K=this.queryRunner.connection.driver.createParameter("parent_entity_"+U.referencedColumn.databaseName,m.length-1);return`${g}.${F} = ${K}`});await this.queryRunner.query(`INSERT INTO ${y} (${[...c,...u].join(", ")}) SELECT ${R.join(", ")} FROM ${y} AS ${g}, ${y} AS ${b} WHERE ${[...P,...M].join(" AND ")}`,m)}}async remove(e){if(this.queryRunner.connection.driver.options.type!=="mssql")return;Array.isArray(e)||(e=[e]);const t=o=>this.queryRunner.connection.driver.escape(o),n=e.map(o=>o.identifier),i=e[0].metadata.closureJunctionTable,r=o=>o.map(c=>{const u=n.map(l=>l[c.referencedColumn.databaseName]);return`${t(c.databaseName)} IN (${u.join(", ")})`}).join(" AND "),s=r(i.ancestorColumns),a=r(i.descendantColumns);await this.queryRunner.manager.createQueryBuilder().delete().from(i.tablePath).where(s).orWhere(a).execute()}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}}class nt{constructor(e){this["@instanceof"]=Symbol.for("EntityMetadata"),this.childEntityMetadatas=[],this.inheritanceTree=[],this.tableType="regular",this.withoutRowid=!1,this.synchronize=!0,this.hasNonNullableRelations=!1,this.isJunction=!1,this.isAlwaysUsingConstructor=!0,this.isClosureJunction=!1,this.hasMultiplePrimaryKeys=!1,this.hasUUIDGeneratedColumns=!1,this.ownColumns=[],this.columns=[],this.ancestorColumns=[],this.descendantColumns=[],this.nonVirtualColumns=[],this.ownerColumns=[],this.inverseColumns=[],this.generatedColumns=[],this.primaryColumns=[],this.ownRelations=[],this.relations=[],this.eagerRelations=[],this.lazyRelations=[],this.oneToOneRelations=[],this.ownerOneToOneRelations=[],this.oneToManyRelations=[],this.manyToOneRelations=[],this.manyToManyRelations=[],this.ownerManyToManyRelations=[],this.relationsWithJoinColumns=[],this.relationIds=[],this.relationCounts=[],this.foreignKeys=[],this.embeddeds=[],this.allEmbeddeds=[],this.ownIndices=[],this.indices=[],this.uniques=[],this.ownUniques=[],this.checks=[],this.exclusions=[],this.ownListeners=[],this.listeners=[],this.afterLoadListeners=[],this.beforeInsertListeners=[],this.afterInsertListeners=[],this.beforeUpdateListeners=[],this.afterUpdateListeners=[],this.beforeRemoveListeners=[],this.beforeSoftRemoveListeners=[],this.beforeRecoverListeners=[],this.afterRemoveListeners=[],this.afterSoftRemoveListeners=[],this.afterRecoverListeners=[],this.connection=e.connection,this.inheritanceTree=e.inheritanceTree||[],this.inheritancePattern=e.inheritancePattern,this.treeType=e.tableTree?e.tableTree.type:void 0,this.treeOptions=e.tableTree?e.tableTree.options:void 0,this.parentClosureEntityMetadata=e.parentClosureEntityMetadata,this.tableMetadataArgs=e.args,this.target=this.tableMetadataArgs.target,this.tableType=this.tableMetadataArgs.type,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid,this.dependsOn=this.tableMetadataArgs.dependsOn}create(e,t){const n=!!(t&&t.pojo===!0);let i;return typeof this.target=="function"&&!n?!t?.fromDeserializer||this.isAlwaysUsingConstructor?i=new this.target:i=Object.create(this.target.prototype):i={},this.connection.options.typename&&(i[this.connection.options.typename]=this.targetName),this.lazyRelations.forEach(r=>this.connection.relationLoader.enableLazyLoad(r,i,e)),i}hasId(e){return e?this.primaryColumns.every(t=>{const n=t.getEntityValue(e);return n!=null&&n!==""}):!1}hasAllPrimaryKeys(e){return this.primaryColumns.every(t=>{const n=t.getEntityValue(e);return n!=null})}ensureEntityIdMap(e){if(oe.isObject(e))return e;if(this.hasMultiplePrimaryKeys)throw new Ys(this,e);return this.primaryColumns[0].createValueMap(e)}getEntityIdMap(e){if(e)return nt.getValueMap(e,this.primaryColumns,{skipNulls:!0})}getEntityIdMixedMap(e){if(!e)return e;const t=this.getEntityIdMap(e);return this.hasMultiplePrimaryKeys?t:t&&this.primaryColumns[0].getEntityValue(t)}compareEntities(e,t){const n=this.getEntityIdMap(e);if(!n)return!1;const i=this.getEntityIdMap(t);return i?Q.compareIds(n,i):!1}findColumnWithPropertyName(e){return this.columns.find(t=>t.propertyName===e)}findColumnWithDatabaseName(e){return this.columns.find(t=>t.databaseName===e)}hasColumnWithPropertyPath(e){return this.columns.some(n=>n.propertyPath===e)||this.hasRelationWithPropertyPath(e)}findColumnWithPropertyPath(e){const t=this.columns.find(i=>i.propertyPath===e);if(t)return t;const n=this.relations.find(i=>i.propertyPath===e);if(n&&n.joinColumns.length===1)return n.joinColumns[0]}findColumnWithPropertyPathStrict(e){return this.columns.find(t=>t.propertyPath===e)}findColumnsWithPropertyPath(e){const t=this.columns.find(i=>i.propertyPath===e);if(t)return[t];const n=this.findRelationWithPropertyPath(e);return n&&n.joinColumns?n.joinColumns:[]}hasRelationWithPropertyPath(e){return this.relations.some(t=>t.propertyPath===e)}findRelationWithPropertyPath(e){return this.relations.find(t=>t.propertyPath===e)}hasEmbeddedWithPropertyPath(e){return this.allEmbeddeds.some(t=>t.propertyPath===e)}findEmbeddedWithPropertyPath(e){return this.allEmbeddeds.find(t=>t.propertyPath===e)}mapPropertyPathsToColumns(e){return e.map(t=>{const n=this.findColumnWithPropertyPath(t);if(n==null)throw new Ze(t,this);return n})}extractRelationValuesFromEntity(e,t){const n=[];return t.forEach(i=>{const r=i.getEntityValue(e);Array.isArray(r)?r.forEach(s=>n.push([i,s,nt.getInverseEntityMetadata(s,i)])):r&&n.push([i,r,nt.getInverseEntityMetadata(r,i)])}),n}findInheritanceMetadata(e){if(this.inheritancePattern==="STI"&&this.childEntityMetadatas.length>0){let t;return this.discriminatorColumn&&(t=e[this.discriminatorColumn.propertyName]),this.childEntityMetadatas.find(n=>t===n.discriminatorValue||e.constructor===n.target)||this}return this}static getInverseEntityMetadata(e,t){return t.inverseEntityMetadata.findInheritanceMetadata(e)}static createPropertyPath(e,t,n=""){const i=[];return Object.keys(t).forEach(r=>{const s=n?n+"."+r:r;if(e.hasEmbeddedWithPropertyPath(s)){const a=this.createPropertyPath(e,t[r],s);i.push(...a)}else{const a=n?n+"."+r:r;i.push(a)}}),i}static difference(e,t){return e.filter(n=>!t.find(i=>Q.compareIds(n,i)))}static getValueMap(e,t,n){return t.reduce((i,r)=>{const s=r.getEntityValueMap(e,n);if(!(i===void 0||s===null||s===void 0))return Q.mergeDeep(i,s)},{})}build(){const e=this.connection.namingStrategy,t=this.connection.options.entityPrefix,n=this.connection.options.entitySkipConstructor;this.engine=this.tableMetadataArgs.engine,this.database=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.database:this.tableMetadataArgs.database,this.tableMetadataArgs.schema?this.schema=this.tableMetadataArgs.schema:this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.schema=this.parentEntityMetadata.schema:this.connection.options?.hasOwnProperty("schema")&&(this.schema=this.connection.options.schema),this.givenTableName=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.givenTableName:this.tableMetadataArgs.name,this.synchronize=this.tableMetadataArgs.synchronize!==!1,this.targetName=typeof this.tableMetadataArgs.target=="function"?this.tableMetadataArgs.target.name:this.tableMetadataArgs.target,this.tableMetadataArgs.type==="closure-junction"?this.tableNameWithoutPrefix=e.closureJunctionTableName(this.givenTableName):this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.tableNameWithoutPrefix=e.tableName(this.parentEntityMetadata.targetName,this.parentEntityMetadata.givenTableName):(this.tableNameWithoutPrefix=e.tableName(this.targetName,this.givenTableName),this.tableMetadataArgs.type==="junction"&&this.connection.driver.maxAliasLength&&this.connection.driver.maxAliasLength>0&&this.tableNameWithoutPrefix.length>this.connection.driver.maxAliasLength&&(this.tableNameWithoutPrefix=Is(this.tableNameWithoutPrefix,{separator:"_",segmentLength:3}))),this.tableName=t?e.prefixTableName(t,this.tableNameWithoutPrefix):this.tableNameWithoutPrefix,this.target=this.target?this.target:this.tableName,this.name=this.targetName?this.targetName:this.tableName,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid===!0,this.tablePath=this.connection.driver.buildTableName(this.tableName,this.schema,this.database),this.orderBy=typeof this.tableMetadataArgs.orderBy=="function"?this.tableMetadataArgs.orderBy(this.propertiesMap):this.tableMetadataArgs.orderBy,n!==void 0&&(this.isAlwaysUsingConstructor=!n),this.isJunction=this.tableMetadataArgs.type==="closure-junction"||this.tableMetadataArgs.type==="junction",this.isClosureJunction=this.tableMetadataArgs.type==="closure-junction",this.comment=this.tableMetadataArgs.comment}registerColumn(e){this.ownColumns.indexOf(e)===-1&&(this.ownColumns.push(e),this.columns=this.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),this.ownColumns),this.primaryColumns=this.columns.filter(t=>t.isPrimary),this.hasMultiplePrimaryKeys=this.primaryColumns.length>1,this.hasUUIDGeneratedColumns=this.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,this.propertiesMap=this.createPropertiesMap(),this.childEntityMetadatas&&this.childEntityMetadatas.forEach(t=>t.registerColumn(e)))}createPropertiesMap(){const e={};return this.columns.forEach(t=>Q.mergeDeep(e,t.createValueMap(t.propertyPath))),this.relations.forEach(t=>Q.mergeDeep(e,t.createValueMap(t.propertyPath))),e}getInsertionReturningColumns(){return this.columns.filter(e=>e.default!==void 0||e.asExpression!==void 0||e.isGenerated||e.isCreateDate||e.isUpdateDate||e.isDeleteDate||e.isVersion)}}class Zr{constructor(e){this.queryRunner=e}async insert(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);const n=e.metadata.getEntityIdMap(t);let i="";n&&(i=await this.getEntityPath(e,n));const r=e.metadata.treeParentRelation.joinColumns.map(s=>s.referencedColumn.getEntityValue(e.insertedValueSet)).join("_");await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[e.metadata.materializedPathColumn.propertyPath]:i+r+"."}).where(e.identifier).execute()}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(l=>Object.entries(e.identifier).every(([h,m])=>l[h]===m)));const i=e.metadata.treeParentRelation.getEntityValue(n),r=this.getEntityParentReferencedColumnMap(e,i),s=this.getEntityParentReferencedColumnMap(e,t);if(Q.compareIds(r,s))return;let a="";s&&(a=await this.getEntityPath(e,s));let o="";r&&(o=await this.getEntityPath(e,r)||"");const c=e.metadata.treeParentRelation.joinColumns.map(l=>l.referencedColumn.getEntityValue(n)).join("_"),u=e.metadata.materializedPathColumn.propertyPath;await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[u]:()=>`REPLACE(${this.queryRunner.connection.driver.escape(u)}, '${o}${c}.', '${a}${c}.')`}).where(`${u} LIKE :path`,{path:`${o}${c}.%`}).execute()}getEntityParentReferencedColumnMap(e,t){if(t)return nt.getValueMap(t,e.metadata.treeParentRelation.joinColumns.map(n=>n.referencedColumn).filter(n=>n!=null),{skipNulls:!0})}getEntityPath(e,t){const n=e.metadata,i=(Array.isArray(t)?t:[t]).map(r=>n.ensureEntityIdMap(r));return this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.materializedPathColumn.propertyPath,"path").from(e.metadata.target,e.metadata.targetName).where(new Wt(r=>{for(const s of i)r.orWhere(new Wt(a=>a.where(s)))})).getRawOne().then(r=>r?r.path:"")}}class rc{constructor(e,t,n){this.hasExecutableOperations=!1,this.insertSubjects=[],this.updateSubjects=[],this.removeSubjects=[],this.softRemoveSubjects=[],this.recoverSubjects=[],this.queryRunner=e,this.allSubjects=t,this.options=n,this.validate(),this.recompute()}async execute(){let e;(!this.options||this.options.listeners!==!1)&&(e=this.broadcastBeforeEventsForAll(),e.promises.length>0&&await Promise.all(e.promises)),e&&e.count>0&&(this.insertSubjects.forEach(t=>t.recompute()),this.updateSubjects.forEach(t=>t.recompute()),this.removeSubjects.forEach(t=>t.recompute()),this.softRemoveSubjects.forEach(t=>t.recompute()),this.recoverSubjects.forEach(t=>t.recompute()),this.recompute()),this.insertSubjects=new Jr(this.insertSubjects).sort("insert"),await this.executeInsertOperations(),this.updateSubjects=this.allSubjects.filter(t=>t.mustBeUpdated),await this.executeUpdateOperations(),this.removeSubjects=new Jr(this.removeSubjects).sort("delete"),await this.executeRemoveOperations(),this.softRemoveSubjects=this.allSubjects.filter(t=>t.mustBeSoftRemoved),await this.executeSoftRemoveOperations(),this.recoverSubjects=this.allSubjects.filter(t=>t.mustBeRecovered),await this.executeRecoverOperations(),this.updateSpecialColumnsInPersistedEntities(),(!this.options||this.options.listeners!==!1)&&(e=this.broadcastAfterEventsForAll(),e.promises.length>0&&await Promise.all(e.promises))}validate(){this.allSubjects.forEach(e=>{if(e.mustBeUpdated&&e.mustBeRemoved)throw new ya(e)})}recompute(){new ic().compute(this.allSubjects),this.insertSubjects=this.allSubjects.filter(e=>e.mustBeInserted),this.updateSubjects=this.allSubjects.filter(e=>e.mustBeUpdated),this.removeSubjects=this.allSubjects.filter(e=>e.mustBeRemoved),this.softRemoveSubjects=this.allSubjects.filter(e=>e.mustBeSoftRemoved),this.recoverSubjects=this.allSubjects.filter(e=>e.mustBeRecovered),this.hasExecutableOperations=this.insertSubjects.length>0||this.updateSubjects.length>0||this.removeSubjects.length>0||this.softRemoveSubjects.length>0||this.recoverSubjects.length>0}broadcastBeforeEventsForAll(){const e=new Ge;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeInsertEvent(e,t.metadata,t.entity)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}broadcastAfterEventsForAll(){const e=new Ge;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterInsertEvent(e,t.metadata,t.entity,t.identifier)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}async executeInsertOperations(){const[e,t]=this.groupBulkSubjects(this.insertSubjects,"insert");for(const n of t){const i=e[n],r=[],s=[],a=[];if(this.queryRunner.connection.driver.options.type==="mongodb"?i.forEach(o=>{o.metadata.createDateColumn&&o.entity&&(o.entity[o.metadata.createDateColumn.databaseName]=new Date),o.metadata.updateDateColumn&&o.entity&&(o.entity[o.metadata.updateDateColumn.databaseName]=new Date),o.createValueSetAndPopChangeMap(),s.push(o),r.push(o.entity)}):this.queryRunner.connection.driver.options.type==="oracle"?i.forEach(o=>{a.push(o)}):i.forEach(o=>{o.changeMaps.length===0||o.metadata.treeType||this.queryRunner.connection.driver.options.type==="oracle"||this.queryRunner.connection.driver.options.type==="sap"?a.push(o):(s.push(o),r.push(o.createValueSetAndPopChangeMap()))}),v.isMongoEntityManager(this.queryRunner.manager)){const o=await this.queryRunner.manager.insert(i[0].metadata.target,r);i.forEach((c,u)=>{c.identifier=o.identifiers[u],c.generatedMap=o.generatedMaps[u],c.insertedValueSet=r[u]})}else{if(r.length>0){const o=await this.queryRunner.manager.createQueryBuilder().insert().into(i[0].metadata.target).values(r).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute();s.forEach((c,u)=>{c.identifier=o.identifiers[u],c.generatedMap=o.generatedMaps[u],c.insertedValueSet=r[u]})}if(a.length>0)for(const o of a)o.insertedValueSet=o.createValueSetAndPopChangeMap(),o.metadata.treeType==="nested-set"&&await new di(this.queryRunner).insert(o),await this.queryRunner.manager.createQueryBuilder().insert().into(o.metadata.target).values(o.insertedValueSet).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute().then(c=>{o.identifier=c.identifiers[0],o.generatedMap=c.generatedMaps[0]}),o.metadata.treeType==="closure-table"?await new pi(this.queryRunner).insert(o):o.metadata.treeType==="materialized-path"&&await new Zr(this.queryRunner).insert(o)}i.forEach(o=>{o.generatedMap&&o.metadata.columns.forEach(c=>{const u=c.getEntityValue(o.generatedMap);if(u!=null){const l=this.queryRunner.connection.driver.prepareHydratedValue(u,c);c.setEntityValue(o.generatedMap,l)}})})}}async executeUpdateOperations(){const e=async r=>{if(!r.identifier)throw new Dt(r);if(v.isMongoEntityManager(this.queryRunner.manager)){const s=this.cloneMongoSubjectEntity(r);r.metadata.objectIdColumn&&r.metadata.objectIdColumn.propertyName&&delete s[r.metadata.objectIdColumn.propertyName],r.metadata.createDateColumn&&r.metadata.createDateColumn.propertyName&&delete s[r.metadata.createDateColumn.propertyName],r.metadata.updateDateColumn&&r.metadata.updateDateColumn.propertyName&&(s[r.metadata.updateDateColumn.propertyName]=new Date),await this.queryRunner.manager.update(r.metadata.target,r.identifier,s)}else{const s=r.createValueSetAndPopChangeMap();switch(r.metadata.treeType){case"nested-set":await new di(this.queryRunner).update(r);break;case"closure-table":await new pi(this.queryRunner).update(r);break;case"materialized-path":await new Zr(this.queryRunner).update(r);break}const a=this.queryRunner.manager.createQueryBuilder().update(r.metadata.target).set(s).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);r.entity?a.whereEntity(r.identifier):a.where(r.identifier);const c=(await a.execute()).generatedMaps[0];c&&(r.metadata.columns.forEach(u=>{const l=u.getEntityValue(c);if(l!=null){const h=this.queryRunner.connection.driver.prepareHydratedValue(l,u);u.setEntityValue(c,h)}}),r.generatedMap||(r.generatedMap={}),Object.assign(r.generatedMap,c))}},t=[],n=[];for(const r of this.updateSubjects)r.metadata.treeType==="nested-set"?t.push(r):n.push(r);const i=async()=>{for(const r of t)await e(r)};await Promise.all([...n.map(e),i()])}async executeRemoveOperations(){const[e,t]=this.groupBulkSubjects(this.removeSubjects,"delete");for(const n of t){const i=e[n],r=i.map(s=>{if(!s.identifier)throw new Dt(s);return s.identifier});if(v.isMongoEntityManager(this.queryRunner.manager))await this.queryRunner.manager.delete(i[0].metadata.target,r);else{switch(i[0].metadata.treeType){case"nested-set":await new di(this.queryRunner).remove(i);break;case"closure-table":await new pi(this.queryRunner).remove(i);break}await this.queryRunner.manager.createQueryBuilder().delete().from(i[0].metadata.target).where(r).callListeners(!1).execute()}}}cloneMongoSubjectEntity(e){const t={};if(e.entity)for(const n of e.metadata.columns)Q.mergeDeep(t,n.getEntityValueMap(e.entity));return t}async executeSoftRemoveOperations(){await Promise.all(this.softRemoveSubjects.map(async e=>{if(!e.identifier)throw new Dt(e);let t;if(v.isMongoEntityManager(this.queryRunner.manager)){const n=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete n[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete n[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(n[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(n[e.metadata.deleteDateColumn.propertyName]=new Date),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,n)}else{const n=this.queryRunner.manager.createQueryBuilder().softDelete().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{const i=n.getEntityValue(e.generatedMap);if(i!=null){const r=this.queryRunner.connection.driver.prepareHydratedValue(i,n);n.setEntityValue(e.generatedMap,r)}})}))}async executeRecoverOperations(){await Promise.all(this.recoverSubjects.map(async e=>{if(!e.identifier)throw new Dt(e);let t;if(v.isMongoEntityManager(this.queryRunner.manager)){const n=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete n[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete n[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(n[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(n[e.metadata.deleteDateColumn.propertyName]=null),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,n)}else{const n=this.queryRunner.manager.createQueryBuilder().restore().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{const i=n.getEntityValue(e.generatedMap);if(i!=null){const r=this.queryRunner.connection.driver.prepareHydratedValue(i,n);n.setEntityValue(e.generatedMap,r)}})}))}updateSpecialColumnsInPersistedEntities(){this.insertSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.insertSubjects),this.updateSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.updateSubjects),this.softRemoveSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.softRemoveSubjects),this.recoverSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.recoverSubjects),this.removeSubjects.length&&this.removeSubjects.forEach(e=>{e.entity&&e.metadata.primaryColumns.forEach(t=>{t.setEntityValue(e.entity,void 0)})}),this.allSubjects.forEach(e=>{e.entity&&(e.metadata.relationIds.forEach(t=>{t.setValue(e.entity)}),v.isMongoEntityManager(this.queryRunner.manager)&&e.metadata.objectIdColumn&&e.metadata.objectIdColumn.databaseName&&e.metadata.objectIdColumn.databaseName!==e.metadata.objectIdColumn.propertyName&&delete e.entity[e.metadata.objectIdColumn.databaseName])})}updateSpecialColumnsInInsertedAndUpdatedEntities(e){e.forEach(t=>{t.entity&&(t.metadata.columns.forEach(n=>{t.metadata.childEntityMetadatas.length>0&&t.metadata.childEntityMetadatas.map(i=>i.target).indexOf(n.target)!==-1||n.isVirtual||n.isDeleteDate||(n.isNullable&&n.getEntityValue(t.entity)===void 0&&n.setEntityValue(t.entity,null),t.updatedRelationMaps.length>0&&t.updatedRelationMaps.forEach(i=>{i.relation.joinColumns.forEach(r=>{r.isVirtual!==!0&&r.setEntityValue(t.entity,oe.isObject(i.value)?r.referencedColumn.getEntityValue(i.value):i.value)})}))}),t.generatedMap&&this.queryRunner.manager.merge(t.metadata.target,t.entity,t.generatedMap))})}groupBulkSubjects(e,t){const n={},i=[],r=e.some(a=>a.metadata.getInsertionReturningColumns().length>0),s=t==="delete"||this.queryRunner.connection.driver.isReturningSqlSupported("insert")||r===!1;return e.forEach((a,o)=>{const c=s||a.metadata.isJunction?a.metadata.name:a.metadata.name+"_"+o;n[c]?n[c].push(a):(n[c]=[a],i.push(c))}),[n,i]}}class ut{constructor(e){this["@instanceof"]=Symbol.for("Subject"),this.identifier=void 0,this.entityWithFulfilledIds=void 0,this.databaseEntityLoaded=!1,this.changeMaps=[],this.canBeInserted=!1,this.canBeUpdated=!1,this.mustBeRemoved=!1,this.canBeSoftRemoved=!1,this.canBeRecovered=!1,this.updatedRelationMaps=[],this.diffColumns=[],this.diffRelations=[],this.metadata=e.metadata,this.entity=e.entity,this.parentSubject=e.parentSubject,e.canBeInserted!==void 0&&(this.canBeInserted=e.canBeInserted),e.canBeUpdated!==void 0&&(this.canBeUpdated=e.canBeUpdated),e.mustBeRemoved!==void 0&&(this.mustBeRemoved=e.mustBeRemoved),e.canBeSoftRemoved!==void 0&&(this.canBeSoftRemoved=e.canBeSoftRemoved),e.canBeRecovered!==void 0&&(this.canBeRecovered=e.canBeRecovered),e.identifier!==void 0&&(this.identifier=e.identifier),e.changeMaps!==void 0&&this.changeMaps.push(...e.changeMaps),this.recompute()}get mustBeInserted(){return this.canBeInserted&&!this.databaseEntity}get mustBeUpdated(){return this.canBeUpdated&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)&&this.changeMaps.some(e=>!e.column||e.column.isUpdate)}get mustBeSoftRemoved(){return this.canBeSoftRemoved&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}get mustBeRecovered(){return this.canBeRecovered&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}createValueSetAndPopChangeMap(){const e=[],t=this.changeMaps.reduce((n,i)=>{let r=i.value;v.isSubject(r)&&(r=r.insertedValueSet?r.insertedValueSet:r.entity);let s;if(this.metadata.isJunction&&i.column)s=i.column.createValueMap(i.column.referencedColumn.getEntityValue(r));else if(i.column)s=i.column.createValueMap(r);else if(i.relation)if(oe.isObject(r)&&!Buffer.isBuffer(r)){const a=i.relation.getRelationIdMap(r);if(a===void 0)return e.push(i),this.canBeUpdated=!0,n;s=i.relation.createValueMap(a),this.updatedRelationMaps.push({relation:i.relation,value:a})}else s=i.relation.createValueMap(r),this.updatedRelationMaps.push({relation:i.relation,value:r});return Q.mergeDeep(n,s),n},{});return this.changeMaps=e,t}recompute(){this.entity?(this.entityWithFulfilledIds=Object.assign({},this.entity),this.parentSubject&&this.metadata.primaryColumns.forEach(e=>{if(e.relationMetadata&&e.relationMetadata.inverseEntityMetadata===this.parentSubject.metadata){const t=e.referencedColumn.getEntityValue(this.parentSubject.entity);e.setEntityValue(this.entityWithFulfilledIds,t)}}),this.identifier=this.metadata.getEntityIdMap(this.entityWithFulfilledIds)):this.databaseEntity&&(this.identifier=this.metadata.getEntityIdMap(this.databaseEntity))}}class sc{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let n=[];if(e.databaseEntity){const s=t.getEntityValue(e.databaseEntity);s&&(n=s.map(a=>t.inverseEntityMetadata.getEntityIdMap(a)))}let i=t.getEntityValue(e.entity);if(i===null&&(i=[]),i===void 0)return;const r=[];i.forEach(s=>{let a=t.inverseEntityMetadata.getEntityIdMap(s),o=this.subjects.find(u=>u.entity===s);if(o&&(a=o.identifier),!a){if(!o)return;o.changeMaps.push({relation:t.inverseRelation,value:e});return}n.find(u=>Q.compareIds(a,u))||(o||(o=new ut({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:a}),this.subjects.push(o)),o.changeMaps.push({relation:t.inverseRelation,value:e})),r.push(a)}),t.inverseRelation?.orphanedRowAction!=="disable"&&nt.difference(n,r).forEach(s=>{const a=new ut({metadata:t.inverseEntityMetadata,parentSubject:e,identifier:s});!t.inverseRelation||t.inverseRelation.orphanedRowAction==="nullify"?(a.canBeUpdated=!0,a.changeMaps=[{relation:t.inverseRelation,value:null}]):t.inverseRelation.orphanedRowAction==="delete"?a.mustBeRemoved=!0:t.inverseRelation.orphanedRowAction==="soft-delete"&&(a.canBeSoftRemoved=!0),this.subjects.push(a)})}}class ac{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToOneRelations.forEach(t=>{t.isOwning||t.persistenceEnabled===!1||this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let n;e.databaseEntity&&(n=t.getEntityValue(e.databaseEntity));const i=t.getEntityValue(e.entity);if(i===void 0)return;if(i===null){if(n){const o=new ut({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:n,changeMaps:[{relation:t.inverseRelation,value:null}]});this.subjects.push(o)}return}let r=t.inverseEntityMetadata.getEntityIdMap(i),s=this.subjects.find(o=>!!o.entity&&o.entity===i);if(s&&(r=s.identifier),!r){if(!s)return;s.changeMaps.push({relation:t.inverseRelation,value:e})}n&&Q.compareIds(r,n)||(s||(s=new ut({metadata:t.inverseEntityMetadata,canBeUpdated:!0,identifier:r}),this.subjects.push(s)),s.changeMaps.push({relation:t.inverseRelation,value:e}))}}class es{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.entity&&e.metadata.manyToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForAllRemoval(e){e.databaseEntity&&e.metadata.manyToManyRelations.forEach(t=>{if(t.persistenceEnabled===!1)return;t.getEntityValue(e.databaseEntity).forEach(i=>{const r=new ut({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,i)});this.subjects.push(r)})})}buildForSubjectRelation(e,t){let n=[];if(e.databaseEntity){const a=t.getEntityValue(e.databaseEntity);a&&(n=a.map(o=>t.inverseEntityMetadata.getEntityIdMap(o)))}let i=t.getEntityValue(e.entity);if(i===null&&(i=[]),!Array.isArray(i))return;i.forEach(a=>{let o=t.inverseEntityMetadata.getEntityIdMap(a);const c=this.subjects.find(y=>y.entity===a);if(c&&(o=c.identifier),!o&&!c||n.find(y=>Q.compareIds(y,o)))return;const l=t.isOwning?e:c||a,h=t.isOwning?c||a:e,m=new ut({metadata:t.junctionEntityMetadata,parentSubject:e,canBeInserted:!0});this.subjects.push(m),t.junctionEntityMetadata.ownerColumns.forEach(y=>{m.changeMaps.push({column:y,value:l})}),t.junctionEntityMetadata.inverseColumns.forEach(y=>{m.changeMaps.push({column:y,value:h})})});const r=[];i.forEach(a=>{let o=t.inverseEntityMetadata.getEntityIdMap(a);const c=this.subjects.find(u=>u.entity===a);c&&(o=c.identifier),o!=null&&r.push(o)}),n.filter(a=>!r.find(o=>Q.compareIds(o,a))).forEach(a=>{const o=new ut({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,a)});this.subjects.push(o)})}buildJunctionIdentifier(e,t,n){const i=t.isOwning?e.entity:n,r=t.isOwning?n:e.entity,s={};return t.junctionEntityMetadata.ownerColumns.forEach(a=>{Q.mergeDeep(s,a.createValueMap(a.referencedColumn.getEntityValue(i)))}),t.junctionEntityMetadata.inverseColumns.forEach(a=>{Q.mergeDeep(s,a.createValueMap(a.referencedColumn.getEntityValue(r)))}),s}}class oc{constructor(e,t){this.queryRunner=e,this.subjects=t}async load(e){const t=this.groupByEntityTargets().map(async n=>{const i=[],r=[];if(n.subjects.forEach(c=>{c.databaseEntity||!c.identifier||(i.push(c.identifier),r.push(c))}),!i.length)return;const s=[];e==="save"||e==="soft-remove"||e==="recover"?n.subjects.forEach(c=>{c.metadata.relations.forEach(u=>{u.getEntityValue(c.entityWithFulfilledIds)!==void 0&&s.indexOf(u.propertyPath)===-1&&s.push(u.propertyPath)})}):s.push(...n.subjects[0].metadata.manyToManyRelations.map(c=>c.propertyPath));const a={loadEagerRelations:!1,loadRelationIds:{relations:s,disableMixedMap:!0},withDeleted:!0};let o=[];this.queryRunner.connection.driver.options.type==="mongodb"?o=await this.queryRunner.manager.getRepository(n.target).findByIds(i,a):o=await this.queryRunner.manager.getRepository(n.target).createQueryBuilder().setFindOptions(a).whereInIds(i).getMany(),o.forEach(c=>{const u=r[0].metadata.getEntityIdMap(c);r.forEach(l=>{l.databaseEntity||Q.compareIds(l.identifier,u)&&(l.databaseEntity=c)})});for(const c of r)c.databaseEntityLoaded=!0});await Promise.all(t)}groupByEntityTargets(){return this.subjects.reduce((e,t)=>{let n=e.find(i=>i.target===t.metadata.target);return n||(n={target:t.metadata.target,subjects:[]},e.push(n)),n.subjects.push(t),e},[])}}class cc{constructor(e){this.allSubjects=e}build(e,t){e.metadata.extractRelationValuesFromEntity(e.entity,e.metadata.relations).forEach(([n,i,r])=>{if(i==null||!n.isCascadeInsert&&!n.isCascadeUpdate&&!n.isCascadeSoftRemove&&!n.isCascadeRecover||!oe.isObject(i))return;const s=this.findByPersistEntityLike(r.target,i);if(s){s.canBeInserted===!1&&(s.canBeInserted=n.isCascadeInsert===!0&&t==="save"),s.canBeUpdated===!1&&(s.canBeUpdated=n.isCascadeUpdate===!0&&t==="save"),s.canBeSoftRemoved===!1&&(s.canBeSoftRemoved=n.isCascadeSoftRemove===!0&&t==="soft-remove"),s.canBeRecovered===!1&&(s.canBeRecovered=n.isCascadeRecover===!0&&t==="recover");return}const a=new ut({metadata:r,parentSubject:e,entity:i,canBeInserted:n.isCascadeInsert===!0&&t==="save",canBeUpdated:n.isCascadeUpdate===!0&&t==="save",canBeSoftRemoved:n.isCascadeSoftRemove===!0&&t==="soft-remove",canBeRecovered:n.isCascadeRecover===!0&&t==="recover"});this.allSubjects.push(a),this.build(a,t)})}findByPersistEntityLike(e,t){return this.allSubjects.find(n=>n.entity?n.entity===t?!0:n.metadata.target===e&&n.metadata.compareEntities(n.entityWithFulfilledIds,t):!1)}}class Lt{constructor(e,t,n,i,r,s){this.connection=e,this.queryRunner=t,this.mode=n,this.target=i,this.entity=r,this.options=s}async execute(){if(!this.entity||typeof this.entity!="object")return Promise.reject(new na(this.mode,this.entity));await Promise.resolve();const e=this.queryRunner||this.connection.createQueryRunner(),t=e.data;this.options&&this.options.data&&(e.data=this.options.data);try{const n=Array.isArray(this.entity)?this.entity:[this.entity],i=this.options&&this.options.chunk&&this.options.chunk>0?Q.chunk(n,this.options.chunk):[n],s=(await Promise.all(i.map(async o=>{const c=[];o.forEach(l=>{const h=this.target?this.target:l.constructor;if(h===Object)throw new Xs(this.mode);const m=this.connection.getMetadata(h).findInheritanceMetadata(l);c.push(new ut({metadata:m,entity:l,canBeInserted:this.mode==="save",canBeUpdated:this.mode==="save",mustBeRemoved:this.mode==="remove",canBeSoftRemoved:this.mode==="soft-remove",canBeRecovered:this.mode==="recover"}))});const u=new cc(c);return c.forEach(l=>{u.build(l,this.mode)}),await new oc(e,c).load(this.mode),this.mode==="save"||this.mode==="soft-remove"||this.mode==="recover"?(new sc(c).build(),new ac(c).build(),new es(c).build()):c.forEach(l=>{l.mustBeRemoved&&new es(c).buildForAllRemoval(l)}),new rc(e,c,this.options)}))).filter(o=>o.hasExecutableOperations);if(s.length===0)return;let a=!1;try{e.isTransactionActive||this.connection.driver.transactionSupport!=="none"&&(!this.options||this.options.transaction!==!1)&&(a=!0,await e.startTransaction());for(const o of s)await o.execute();a===!0&&await e.commitTransaction()}catch(o){if(a)try{await e.rollbackTransaction()}catch{}throw o}}finally{e.data=t,this.queryRunner||await e.release()}}}class js{constructor(e,t){this["@instanceof"]=Symbol.for("EntityManager"),this.repositories=new Map,this.treeRepositories=[],this.plainObjectToEntityTransformer=new zo,this.connection=e,t&&(this.queryRunner=t,oe.assign(this.queryRunner,{manager:this}))}async transaction(e,t){const n=typeof e=="string"?e:void 0,i=typeof e=="function"?e:t;if(!i)throw new C("Transaction method requires callback in second parameter if isolation level is supplied.");if(this.queryRunner&&this.queryRunner.isReleased)throw new bs;const r=this.queryRunner||this.connection.createQueryRunner();try{await r.startTransaction(n);const s=await i(r.manager);return await r.commitTransaction(),s}catch(s){try{await r.rollbackTransaction()}catch{}throw s}finally{this.queryRunner||await r.release()}}async query(e,t){return this.connection.query(e,t,this.queryRunner)}async sql(e,...t){const{query:n,parameters:i}=Yt({driver:this.connection.driver,strings:e,expressions:t});return await this.query(n,i)}createQueryBuilder(e,t,n){return t?this.connection.createQueryBuilder(e,t,n||this.queryRunner):this.connection.createQueryBuilder(e||n||this.queryRunner)}hasId(e,t){const n=arguments.length===2?e:e.constructor,i=arguments.length===2?t:e;return this.connection.getMetadata(n).hasId(i)}getId(e,t){const n=arguments.length===2?e:e.constructor,i=arguments.length===2?t:e;return this.connection.getMetadata(n).getEntityIdMixedMap(i)}create(e,t){const n=this.connection.getMetadata(e);if(!t)return n.create(this.queryRunner);if(Array.isArray(t))return t.map(r=>this.create(e,r));const i=n.create(this.queryRunner);return this.plainObjectToEntityTransformer.transform(i,t,n,!0),i}merge(e,t,...n){const i=this.connection.getMetadata(e);return n.forEach(r=>this.plainObjectToEntityTransformer.transform(t,r,i)),t}async preload(e,t){const n=this.connection.getMetadata(e),r=await new Yo(this.connection.manager).transform(t,n);if(r)return this.merge(e,r,t)}save(e,t,n){let i=arguments.length>1&&(typeof e=="function"||v.isEntitySchema(e)||typeof e=="string")?e:void 0;const r=i?t:e,s=i?n:t;return v.isEntitySchema(i)&&(i=i.options.name),Array.isArray(r)&&r.length===0?Promise.resolve(r):new Lt(this.connection,this.queryRunner,"save",i,r,s).execute().then(()=>r)}remove(e,t,n){const i=arguments.length>1&&(typeof e=="function"||v.isEntitySchema(e)||typeof e=="string")?e:void 0,r=i?t:e,s=i?n:t;return Array.isArray(r)&&r.length===0?Promise.resolve(r):new Lt(this.connection,this.queryRunner,"remove",i,r,s).execute().then(()=>r)}softRemove(e,t,n){let i=arguments.length>1&&(typeof e=="function"||v.isEntitySchema(e)||typeof e=="string")?e:void 0;const r=i?t:e,s=i?n:t;return v.isEntitySchema(i)&&(i=i.options.name),Array.isArray(r)&&r.length===0?Promise.resolve(r):new Lt(this.connection,this.queryRunner,"soft-remove",i,r,s).execute().then(()=>r)}recover(e,t,n){let i=arguments.length>1&&(typeof e=="function"||v.isEntitySchema(e)||typeof e=="string")?e:void 0;const r=i?t:e,s=i?n:t;return v.isEntitySchema(i)&&(i=i.options.name),Array.isArray(r)&&r.length===0?Promise.resolve(r):new Lt(this.connection,this.queryRunner,"recover",i,r,s).execute().then(()=>r)}async insert(e,t){return this.createQueryBuilder().insert().into(e).values(t).execute()}async upsert(e,t,n){const i=this.connection.getMetadata(e);let r;Array.isArray(n)?r={conflictPaths:n}:r=n;let s;Array.isArray(t)?s=t:s=[t];const a=i.mapPropertyPathsToColumns(Array.isArray(r.conflictPaths)?r.conflictPaths:Object.keys(r.conflictPaths)),o=i.columns.filter(c=>!a.includes(c)&&s.some(u=>typeof c.getEntityValue(u)<"u"));return this.createQueryBuilder().insert().into(e).values(s).orUpdate([...a,...o].map(c=>c.databaseName),a.map(c=>c.databaseName),{skipUpdateIfNoValuesChanged:r.skipUpdateIfNoValuesChanged,indexPredicate:r.indexPredicate,upsertType:r.upsertType||this.connection.driver.supportedUpsertTypes[0]}).execute()}update(e,t,n){return Q.isCriteriaNullOrEmpty(t)?Promise.reject(new C("Empty criteria(s) are not allowed for the update method.")):Q.isPrimitiveCriteria(t)?this.createQueryBuilder().update(e).set(n).whereInIds(t).execute():this.createQueryBuilder().update(e).set(n).where(t).execute()}updateAll(e,t){return this.createQueryBuilder().update(e).set(t).execute()}delete(e,t){return Q.isCriteriaNullOrEmpty(t)?Promise.reject(new C("Empty criteria(s) are not allowed for the delete method.")):Q.isPrimitiveCriteria(t)?this.createQueryBuilder().delete().from(e).whereInIds(t).execute():this.createQueryBuilder().delete().from(e).where(t).execute()}deleteAll(e){return this.createQueryBuilder().delete().from(e).execute()}softDelete(e,t){return Q.isCriteriaNullOrEmpty(t)?Promise.reject(new C("Empty criteria(s) are not allowed for the softDelete method.")):Q.isPrimitiveCriteria(t)?this.createQueryBuilder().softDelete().from(e).whereInIds(t).execute():this.createQueryBuilder().softDelete().from(e).where(t).execute()}restore(e,t){return Q.isCriteriaNullOrEmpty(t)?Promise.reject(new C("Empty criteria(s) are not allowed for the restore method.")):Q.isPrimitiveCriteria(t)?this.createQueryBuilder().restore().from(e).whereInIds(t).execute():this.createQueryBuilder().restore().from(e).where(t).execute()}exists(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,_e.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getExists()}async existsBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getExists()}count(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,_e.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getCount()}countBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getCount()}sum(e,t,n){return this.callAggregateFun(e,"SUM",t,n)}average(e,t,n){return this.callAggregateFun(e,"AVG",t,n)}minimum(e,t,n){return this.callAggregateFun(e,"MIN",t,n)}maximum(e,t,n){return this.callAggregateFun(e,"MAX",t,n)}async callAggregateFun(e,t,n,i={}){const r=this.connection.getMetadata(e),s=r.columns.find(o=>o.propertyPath===n);if(!s)throw new C(`Column "${n}" was not found in table "${r.name}"`);const a=await this.createQueryBuilder(e,r.name).setFindOptions({where:i}).select(`${t}(${this.connection.driver.escape(s.databaseName)})`,t).getRawOne();return a[t]===null?null:parseFloat(a[t])}async find(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,_e.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getMany()}async findBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getMany()}findAndCount(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,_e.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getManyAndCount()}findAndCountBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getManyAndCount()}async findByIds(e,t){if(!t.length)return Promise.resolve([]);const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).andWhereInIds(t).getMany()}async findOne(e,t){let i=this.connection.getMetadata(e).name;if(t&&t.join&&(i=t.join.alias),!t.where)throw new Error("You must provide selection conditions in order to find a single row.");return this.createQueryBuilder(e,i).setFindOptions({...t,take:1}).getOne()}async findOneBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t,take:1}).getOne()}async findOneById(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({take:1}).whereInIds(n.ensureEntityIdMap(t)).getOne()}async findOneOrFail(e,t){return this.findOne(e,t).then(n=>n===null?Promise.reject(new Ei(e,t)):Promise.resolve(n))}async findOneByOrFail(e,t){return this.findOneBy(e,t).then(n=>n===null?Promise.reject(new Ei(e,t)):Promise.resolve(n))}async clear(e){const t=this.connection.getMetadata(e),n=this.queryRunner||this.connection.createQueryRunner();try{return await n.clearTable(t.tablePath)}finally{this.queryRunner||await n.release()}}async increment(e,t,n,i){const r=this.connection.getMetadata(e),s=r.findColumnWithPropertyPath(n);if(!s)throw new C(`Column ${n} was not found in ${r.targetName} entity.`);if(isNaN(Number(i)))throw new C(`Value "${i}" is not a number.`);const a=n.split(".").reduceRight((o,c)=>({[c]:o}),()=>this.connection.driver.escape(s.databaseName)+" + "+i);return this.createQueryBuilder(e,"entity").update(e).set(a).where(t).execute()}async decrement(e,t,n,i){const r=this.connection.getMetadata(e),s=r.findColumnWithPropertyPath(n);if(!s)throw new C(`Column ${n} was not found in ${r.targetName} entity.`);if(isNaN(Number(i)))throw new C(`Value "${i}" is not a number.`);const a=n.split(".").reduceRight((o,c)=>({[c]:o}),()=>this.connection.driver.escape(s.databaseName)+" - "+i);return this.createQueryBuilder(e,"entity").update(e).set(a).where(t).execute()}getRepository(e){const t=this.repositories.get(e);if(t)return t;if(this.connection.driver.options.type==="mongodb"){const n=new $o(e,this,this.queryRunner);return this.repositories.set(e,n),n}else{const n=new Fs(e,this,this.queryRunner);return this.repositories.set(e,n),n}}getTreeRepository(e){if(this.connection.driver.treeSupport===!1)throw new Zs(this.connection.driver);const t=this.treeRepositories.find(i=>i.target===e);if(t)return t;const n=new Go(e,this,this.queryRunner);return this.treeRepositories.push(n),n}getMongoRepository(e){return this.connection.getMongoRepository(e)}withRepository(e){const t=e.constructor,{target:n,manager:i,queryRunner:r,...s}=e;return Object.assign(new t(e.target,this),{...s})}getCustomRepository(e){const t=Gt().entityRepositories.find(r=>r.target===(typeof e=="function"?e:e.constructor));if(!t)throw new Es(e);const n=t.entity?this.connection.getMetadata(t.entity):void 0,i=new t.target(this,n);if(i instanceof Xo)i.manager||(i.manager=this);else{if(!n)throw new ia(e);i.manager=this,i.metadata=n}return i}async release(){if(!this.queryRunner)throw new fa;return this.queryRunner.release()}}class uc extends js{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SqljsEntityManager"),this.driver=e.driver}async loadDatabase(e){await this.driver.load(e)}async saveDatabase(e){await this.driver.save(e)}exportDatabase(){return this.driver.export()}}class lc{create(e,t){return e.driver.options.type==="mongodb"?new qo(e):e.driver.options.type==="sqljs"?new uc(e,t):new js(e,t)}}class lt{constructor(e){this["@instanceof"]=Symbol.for("View"),this.indices=[],e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,this.expression=e.expression,this.materialized=!!e.materialized)}clone(){return new lt({database:this.database,schema:this.schema,name:this.name,expression:this.expression,materialized:this.materialized})}addIndex(e){this.indices.push(e)}removeIndex(e){const t=this.indices.find(n=>n.name===e.name);t&&this.indices.splice(this.indices.indexOf(t),1)}static create(e,t){const n={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,e.schema,e.database),expression:e.expression,materialized:e.tableMetadataArgs.materialized};return new lt(n)}}class ts{static viewMetadataCmp(e,t){return!e||!t?0:e.dependsOn&&(e.dependsOn.has(t.target)||e.dependsOn.has(t.name))?1:t.dependsOn&&(t.dependsOn.has(e.target)||t.dependsOn.has(e.name))?-1:0}}class Xt{constructor(e){this.connection=e,this["@instanceof"]=Symbol.for("RdbmsSchemaBuilder")}async build(){this.queryRunner=this.connection.createQueryRunner(),this.currentDatabase=this.connection.driver.database,this.currentSchema=this.connection.driver.schema;const e=this.connection.driver.options.type!=="cockroachdb"&&this.connection.driver.options.type!=="spanner"&&this.connection.options.migrationsTransactionMode!=="none";await this.queryRunner.beforeMigration(),e&&await this.queryRunner.startTransaction();try{await this.createMetadataTableIfNecessary(this.queryRunner);const t=this.entityToSyncMetadatas.map(i=>this.getTablePath(i)),n=this.viewEntityToSyncMetadatas.map(i=>this.getTablePath(i));await this.queryRunner.getTables(t),await this.queryRunner.getViews(n),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),e&&await this.queryRunner.commitTransaction()}catch(t){try{e&&await this.queryRunner.rollbackTransaction()}catch{}throw t}finally{await this.queryRunner.afterMigration(),await this.queryRunner.release()}}async createMetadataTableIfNecessary(e){(this.viewEntityToSyncMetadatas.length>0||this.hasGeneratedColumns())&&await this.createTypeormMetadataTable(e)}async log(){this.queryRunner=this.connection.createQueryRunner();try{const e=this.entityToSyncMetadatas.map(n=>this.getTablePath(n)),t=this.viewEntityToSyncMetadatas.map(n=>this.getTablePath(n));return await this.queryRunner.getTables(e),await this.queryRunner.getViews(t),this.queryRunner.enableSqlMemory(),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),this.queryRunner.getMemorySql()}finally{this.queryRunner.disableSqlMemory(),await this.queryRunner.release()}}get entityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.synchronize&&e.tableType!=="entity-child"&&e.tableType!=="view")}get viewEntityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.tableType==="view"&&e.synchronize).sort(ts.viewMetadataCmp)}hasGeneratedColumns(){return this.connection.entityMetadatas.some(e=>e.columns.some(t=>t.generatedType))}async executeSchemaSyncOperationsInProperOrder(){await this.dropOldViews(),await this.dropOldForeignKeys(),await this.dropOldIndices(),await this.dropOldChecks(),await this.dropOldExclusions(),await this.dropCompositeUniqueConstraints(),await this.renameColumns(),await this.changeTableComment(),await this.createNewTables(),await this.dropRemovedColumns(),await this.addNewColumns(),await this.updatePrimaryKeys(),await this.updateExistColumns(),await this.createNewIndices(),await this.createNewChecks(),await this.createNewExclusions(),await this.createCompositeUniqueConstraints(),await this.createForeignKeys(),await this.createViews(),await this.createNewViewIndices()}getTablePath(e){const t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema||this.currentSchema,t.database||this.currentDatabase)}async dropOldForeignKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.foreignKeys.filter(i=>{const r=e.foreignKeys.find(s=>i.name===s.name&&this.getTablePath(i)===this.getTablePath(s.referencedEntityMetadata));return!r||r.onDelete&&r.onDelete!==i.onDelete||r.onUpdate&&r.onUpdate!==i.onUpdate});n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old foreign keys of ${t.name}: ${n.map(i=>i.name).join(", ")}`),await this.queryRunner.dropForeignKeys(t,n))}}async renameTables(){}async renameColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t||e.columns.length!==t.columns.length)continue;const n=e.columns.filter(s=>!s.isVirtualProperty).filter(s=>!t.columns.find(a=>a.name===s.databaseName&&a.type===this.connection.driver.normalizeType(s)&&a.isNullable===s.isNullable&&a.isUnique===this.connection.driver.normalizeIsUnique(s)));if(n.length===0||n.length>1)continue;const i=t.columns.filter(s=>!e.columns.find(a=>!a.isVirtualProperty&&a.databaseName===s.name&&this.connection.driver.normalizeType(a)===s.type&&a.isNullable===s.isNullable&&this.connection.driver.normalizeIsUnique(a)===s.isUnique));if(i.length===0||i.length>1)continue;const r=i[0].clone();r.name=n[0].databaseName,this.connection.logger.logSchemaBuild(`renaming column "${i[0].name}" in "${t.name}" to "${r.name}"`),await this.queryRunner.renameColumn(t,i[0],r)}}async dropOldIndices(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.indices.filter(i=>{const r=e.indices.find(s=>s.name===i.name);return r?r.synchronize===!1?!1:r.isUnique!==i.isUnique||r.isSpatial!==i.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&r.isFulltext!==i.isFulltext||r.columns.length!==i.columnNames.length?!0:!r.columns.every(s=>i.columnNames.indexOf(s.databaseName)!==-1):!0}).map(async i=>{this.connection.logger.logSchemaBuild(`dropping an index: "${i.name}" from table ${t.name}`),await this.queryRunner.dropIndex(t,i)});await Promise.all(n)}if(this.connection.options.type==="postgres"){const e=this.queryRunner;for(const t of this.viewEntityToSyncMetadatas){const n=this.queryRunner.loadedViews.find(r=>this.getTablePath(r)===this.getTablePath(t));if(!n)continue;const i=n.indices.filter(r=>{const s=t.indices.find(a=>a.name===r.name);return s?s.synchronize===!1?!1:s.isUnique!==r.isUnique||s.isSpatial!==r.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&s.isFulltext!==r.isFulltext||s.columns.length!==r.columnNames.length?!0:!s.columns.every(a=>r.columnNames.indexOf(a.databaseName)!==-1):!0}).map(async r=>{this.connection.logger.logSchemaBuild(`dropping an index: "${r.name}" from view ${n.name}`),await e.dropViewIndex(n,r)});await Promise.all(i)}}}async dropOldChecks(){if(!(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.checks.filter(i=>!e.checks.find(r=>r.name===i.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old check constraint: ${n.map(i=>`"${i.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropCheckConstraints(t,n))}}async dropCompositeUniqueConstraints(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.uniques.filter(i=>i.columnNames.length>1&&!e.uniques.find(r=>r.name===i.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old unique constraint: ${n.map(i=>`"${i.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropUniqueConstraints(t,n))}}async dropOldExclusions(){if(this.connection.driver.options.type==="postgres")for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.exclusions.filter(i=>!e.exclusions.find(r=>r.name===i.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old exclusion constraint: ${n.map(i=>`"${i.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropExclusionConstraints(t,n))}}async changeTableComment(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(t&&(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="postgres")){const n=e.comment;await this.queryRunner.changeTableComment(t,n)}}}async createNewTables(){for(const e of this.entityToSyncMetadatas){if(this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e)))continue;this.connection.logger.logSchemaBuild(`creating a new table: ${this.getTablePath(e)}`);const n=Se.create(e,this.connection.driver);await this.queryRunner.createTable(n,!1,!1),this.queryRunner.loadedTables.push(n)}}async createViews(){for(const e of this.viewEntityToSyncMetadatas){if(this.queryRunner.loadedViews.find(i=>{const r=typeof i.expression=="string"?i.expression.trim():i.expression(this.connection).getQuery(),s=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.getTablePath(i)===this.getTablePath(e)&&r===s}))continue;this.connection.logger.logSchemaBuild(`creating a new view: ${this.getTablePath(e)}`);const n=lt.create(e,this.connection.driver);await this.queryRunner.createView(n,!0),this.queryRunner.loadedViews.push(n)}}async dropOldViews(){const e=[],t=this.viewEntityToSyncMetadatas,n=new Map;for(const s of this.queryRunner.loadedViews){const a=t.find(o=>this.getTablePath(s)===this.getTablePath(o));a&&n.set(s,a)}for(const s of this.queryRunner.loadedViews){const a=n.get(s);if(!a)continue;const o=typeof s.expression=="string"?s.expression.trim():s.expression(this.connection).getQuery(),c=typeof a.expression=="string"?a.expression.trim():a.expression(this.connection).getQuery();o!==c&&(this.connection.logger.logSchemaBuild(`dropping an old view: ${s.name}`),e.push(s))}const i=s=>{const a=n.get(s);let o=[s];if(!a)return o;for(const[c,u]of n.entries())c!==s&&u.dependsOn&&(u.dependsOn.has(a.target)||u.dependsOn.has(a.name))&&(o=o.concat(i(c)));return o},r=new Set(e.map(s=>i(s)).reduce((s,a)=>s.concat(a),[]).sort((s,a)=>ts.viewMetadataCmp(n.get(s),n.get(a))).reverse());for(const s of r)await this.queryRunner.dropView(s);this.queryRunner.loadedViews=this.queryRunner.loadedViews.filter(s=>!r.has(s))}async dropRemovedColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.columns.filter(i=>!e.columns.find(r=>r.isVirtualProperty||r.databaseName===i.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`columns dropped in ${t.name}: `+n.map(i=>i.name).join(", ")),await this.queryRunner.dropColumns(t,n))}}async addNewColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;const n=e.columns.filter(s=>!s.isVirtualProperty&&!t.columns.find(a=>a.name===s.databaseName));if(n.length===0)continue;const r=this.metadataColumnsToTableColumnOptions(n).map(s=>new Fe(s));r.length!==0&&(this.connection.logger.logSchemaBuild("new columns added: "+n.map(s=>s.databaseName).join(", ")),await this.queryRunner.addColumns(t,r))}}async updatePrimaryKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.columns.filter(r=>r.isPrimary);if(t.columns.filter(r=>r.isPrimary).length!==n.length&&n.length>1){const r=n.map(s=>new Fe(jt.createTableColumnOptions(s,this.connection.driver)));await this.queryRunner.updatePrimaryKeys(t,r)}}}async updateExistColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=this.connection.driver.findChangedColumns(t.columns,e.columns);if(n.length===0)continue;for(const r of n)await this.dropColumnReferencedForeignKeys(this.getTablePath(e),r.databaseName);for(const r of n)await this.dropColumnCompositeIndices(this.getTablePath(e),r.databaseName);if(!(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="spanner"))for(const r of n)await this.dropColumnCompositeUniques(this.getTablePath(e),r.databaseName);const i=n.map(r=>{const s=t.columns.find(c=>c.name===r.databaseName),a=jt.createTableColumnOptions(r,this.connection.driver),o=new Fe(a);return{oldColumn:s,newColumn:o}});i.length!==0&&(this.connection.logger.logSchemaBuild(`columns changed in "${t.name}". updating: `+n.map(r=>r.databaseName).join(", ")),await this.queryRunner.changeColumns(t,i))}}async createNewIndices(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.indices.filter(i=>!t.indices.find(r=>r.name===i.name)&&i.synchronize===!0).map(i=>Pe.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${n.map(i=>`"${i.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createIndices(t,n))}}async createNewViewIndices(){if(this.connection.options.type!=="postgres"||!k.isPostgresFamily(this.connection.driver))return;const e=this.queryRunner;for(const t of this.viewEntityToSyncMetadatas){const n=this.queryRunner.loadedViews.find(r=>{const s=typeof r.expression=="string"?r.expression.trim():r.expression(this.connection).getQuery(),a=typeof t.expression=="string"?t.expression.trim():t.expression(this.connection).getQuery();return this.getTablePath(r)===this.getTablePath(t)&&s===a});if(!n||!n.materialized)continue;const i=t.indices.filter(r=>!n.indices.find(s=>s.name===r.name)&&r.synchronize===!0).map(r=>Pe.create(r));i.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${i.map(r=>`"${r.name}"`).join(", ")} in view "${n.name}"`),await e.createViewIndices(n,i))}}async createNewChecks(){if(!(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.checks.filter(i=>!t.checks.find(r=>r.name===i.name)).map(i=>tt.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new check constraints: ${n.map(i=>`"${i.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createCheckConstraints(t,n))}}async createCompositeUniqueConstraints(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.uniques.filter(i=>i.columns.length>1&&!t.uniques.find(r=>r.name===i.name)).map(i=>Le.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new unique constraints: ${n.map(i=>`"${i.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createUniqueConstraints(t,n))}}async createNewExclusions(){if(this.connection.driver.options.type==="postgres")for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.exclusions.filter(i=>!t.exclusions.find(r=>r.name===i.name)).map(i=>ft.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new exclusion constraints: ${n.map(i=>`"${i.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createExclusionConstraints(t,n))}}async createForeignKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.foreignKeys.filter(r=>!t.foreignKeys.find(s=>s.name===r.name&&this.getTablePath(s)===this.getTablePath(r.referencedEntityMetadata)));if(n.length===0)continue;const i=n.map(r=>We.create(r,this.connection.driver));this.connection.logger.logSchemaBuild(`creating a foreign keys: ${n.map(r=>r.name).join(", ")} on table "${t.name}"`),await this.queryRunner.createForeignKeys(t,i)}}async dropColumnReferencedForeignKeys(e,t){const n=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===e);if(!n)return;const i=[],r=n.foreignKeys.find(s=>s.columnNames.indexOf(t)!==-1);if(r){const s=n.clone();s.foreignKeys=[r],i.push(s),n.removeForeignKey(r)}for(const s of this.queryRunner.loadedTables){const a=s.foreignKeys.filter(o=>this.getTablePath(o)===e&&o.referencedColumnNames.indexOf(t)!==-1);if(a.length>0){const o=s.clone();o.foreignKeys=a,i.push(o),a.forEach(c=>s.removeForeignKey(c))}}if(i.length>0)for(const s of i)this.connection.logger.logSchemaBuild(`dropping related foreign keys of ${s.name}: ${s.foreignKeys.map(a=>a.name).join(", ")}`),await this.queryRunner.dropForeignKeys(s,s.foreignKeys)}async dropColumnCompositeIndices(e,t){const n=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===e);if(!n)return;const i=n.indices.filter(r=>r.columnNames.length>1&&r.columnNames.indexOf(t)!==-1);i.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related indices of "${e}"."${t}": ${i.map(r=>r.name).join(", ")}`),await this.queryRunner.dropIndices(n,i))}async dropColumnCompositeUniques(e,t){const n=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===e);if(!n)return;const i=n.uniques.filter(r=>r.columnNames.length>1&&r.columnNames.indexOf(t)!==-1);i.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related unique constraints of "${e}"."${t}": ${i.map(r=>r.name).join(", ")}`),await this.queryRunner.dropUniqueConstraints(n,i))}metadataColumnsToTableColumnOptions(e){return e.map(t=>jt.createTableColumnOptions(t,this.connection.driver))}async createTypeormMetadataTable(e){const t=this.currentSchema,n=this.currentDatabase,i=this.connection.driver.buildTableName(this.connection.metadataTableName,t,n),r=this.connection.driver.options.type==="spanner";await e.createTable(new Se({database:n,schema:t,name:i,columns:[{name:"type",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataType}),isNullable:!1,isPrimary:r},{name:"database",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataDatabase}),isNullable:!0,isPrimary:r},{name:"schema",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataSchema}),isNullable:!0,isPrimary:r},{name:"table",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataTable}),isNullable:!0,isPrimary:r},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataName}),isNullable:!0,isPrimary:r},{name:"value",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataValue}),isNullable:!0,isPrimary:r}]}),!0)}}class Nt{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime","json"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=k.buildDriverOptions(this.options).database}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(n=>n?t(n):e())})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){return this.attachedDatabases?.[e]?.attachHandle}getAttachedDatabasePathRelativeByHandle(e){return Object.values(this.attachedDatabases).find(({attachHandle:t})=>e===t)?.attachFilepathRelative}createSchemaBuilder(){return new Xt(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=De.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?ne.mixedDateToDateString(e):t.type==="time"?ne.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?ne.mixedDateToUtcDatetimeString(e):t.type==="json"||t.type==="simple-json"?ne.simpleJsonToString(e):t.type==="simple-array"?ne.simpleArrayToString(e):t.type==="simple-enum"?ne.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?De.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=ne.normalizeHydratedDate(e)):t.type==="date"?e=ne.mixedDateToDateString(e):t.type==="time"?e=ne.mixedTimeToString(e):t.type==="json"||t.type==="simple-json"?e=ne.stringToSimpleJson(e):t.type==="simple-array"?e=ne.stringToSimpleArray(e):t.type==="simple-enum"?e=ne.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=De.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){const i=Object.keys(n).map(r=>typeof n[r]=="boolean"?n[r]===!0?1:0:n[r]instanceof Date?ne.mixedDateToUtcDatetimeString(n[r]):n[r]);return!t||!Object.keys(t).length?[e,i]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(r,s,a)=>{if(!t.hasOwnProperty(a))return r;const o=t[a];return s?o.map(c=>(i.push(c),this.createParameter(a,i.length-1))).join(", "):typeof o=="function"?o():typeof o=="number"?String(o):typeof o=="boolean"?(i.push(+o),this.createParameter(a,i.length-1)):o instanceof Date?(i.push(ne.mixedDateToUtcDatetimeString(o)),this.createParameter(a,i.length-1)):(i.push(o),this.createParameter(a,i.length-1))}),[e,i])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){const t=this.database,n=void 0;if(v.isTable(e)||v.isView(e)){const r=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||r.database||t,schema:e.schema||r.schema||n,tableName:r.tableName}}if(v.isTableForeignKey(e)){const r=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||r.database||t,schema:e.referencedSchema||r.schema||n,tableName:r.tableName}}if(v.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const i=e.split(".");return i.length===3?{database:i[0]||t,schema:i[1]||n,tableName:i[2]}:i.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(i[0])??t,schema:i[0],tableName:i[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){const t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,i){const r=e.generatedColumns.reduce((s,a)=>{let o;return a.generationStrategy==="increment"&&t&&(o=t-i+n+1),o?Q.mergeDeep(s,a.createValueMap(o)):s},{});return Object.keys(r).length>0?r:void 0}findChangedColumns(e,t){return t.filter(n=>{const i=e.find(s=>s.name===n.databaseName);return i?i.name!==n.databaseName||i.type!==this.normalizeType(n)||i.length!==n.length||i.precision!==n.precision||i.scale!==n.scale||this.normalizeDefault(n)!==i.default||i.isPrimary!==n.isPrimary||i.isNullable!==n.isNullable||i.generatedType!==n.generatedType||i.asExpression!==n.asExpression||i.isUnique!==this.normalizeIsUnique(n)||i.enum&&n.enum&&!Q.isArraysEqual(i.enum,n.enum.map(s=>s+""))||n.generationStrategy!=="uuid"&&i.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}async createDatabaseConnection(){throw new C("Do not use AbstractSqlite directly, it has to be used with one of the sqlite drivers")}loadDependencies(){}}class it{constructor(){this.records=[]}}class ot{constructor(e){this.queryRunner=e}async broadcast(e,...t){const n=new Ge,i=this[`broadcast${e}Event`];typeof i=="function"&&i.call(this,n,...t),await n.wait()}broadcastBeforeInsertEvent(e,t,n){n&&t.beforeInsertListeners.length&&t.beforeInsertListeners.forEach(i=>{if(i.isAllowed(n)){const r=i.execute(n);r instanceof Promise&&e.promises.push(r),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.beforeInsert){const r=i.beforeInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastBeforeUpdateEvent(e,t,n,i,r,s){n&&t.beforeUpdateListeners.length&&t.beforeUpdateListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeUpdate){const o=a.beforeUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,updatedColumns:r||[],updatedRelations:s||[]});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastBeforeRemoveEvent(e,t,n,i,r){n&&t.beforeRemoveListeners.length&&t.beforeRemoveListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeRemove){const a=s.beforeRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastBeforeSoftRemoveEvent(e,t,n,i,r){n&&t.beforeSoftRemoveListeners.length&&t.beforeSoftRemoveListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeSoftRemove){const a=s.beforeSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastBeforeRecoverEvent(e,t,n,i,r){n&&t.beforeRecoverListeners.length&&t.beforeRecoverListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeRecover){const a=s.beforeRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterInsertEvent(e,t,n,i){n&&t.afterInsertListeners.length&&t.afterInsertListeners.forEach(r=>{if(r.isAllowed(n)){const s=r.execute(n);s instanceof Promise&&e.promises.push(s),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(r=>{if(this.isAllowedSubscriber(r,t.target)&&r.afterInsert){const s=r.afterInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,entityId:t.getEntityIdMixedMap(i)});s instanceof Promise&&e.promises.push(s),e.count++}})}broadcastBeforeQueryEvent(e,t,n){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(i.beforeQuery){const r=i.beforeQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:n});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterQueryEvent(e,t,n,i,r,s,a){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(o=>{if(o.afterQuery){const c=o.afterQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:n,success:i,executionTime:r,rawResults:s,error:a});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastBeforeTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionStart){const n=t.beforeTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionStart){const n=t.afterTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionCommit){const n=t.beforeTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionCommit){const n=t.afterTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionRollback){const n=t.beforeTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionRollback){const n=t.afterTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterUpdateEvent(e,t,n,i,r,s){n&&t.afterUpdateListeners.length&&t.afterUpdateListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterUpdate){const o=a.afterUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,updatedColumns:r||[],updatedRelations:s||[]});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastAfterRemoveEvent(e,t,n,i,r){n&&t.afterRemoveListeners.length&&t.afterRemoveListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterRemove){const a=s.afterRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterSoftRemoveEvent(e,t,n,i,r){n&&t.afterSoftRemoveListeners.length&&t.afterSoftRemoveListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterSoftRemove){const a=s.afterSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterRecoverEvent(e,t,n,i,r){n&&t.afterRecoverListeners.length&&t.afterRecoverListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterRecover){const a=s.afterRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastLoadEventsForAll(e,t,n){return this.broadcastLoadEvent(e,t,n)}broadcastLoadEvent(e,t,n){const i=this.queryRunner.connection.subscribers.filter(r=>this.isAllowedSubscriber(r,t.target)&&r.afterLoad);if(t.relations.length||t.afterLoadListeners.length||i.length){const r=n.filter(s=>!(s instanceof Promise));t.relations.length&&t.relations.forEach(s=>{r.forEach(a=>{if(s.isLazy&&!a.hasOwnProperty(s.propertyName))return;const o=s.getEntityValue(a);oe.isObject(o)&&this.broadcastLoadEvent(e,s.inverseEntityMetadata,Array.isArray(o)?o:[o])})}),t.afterLoadListeners.length&&t.afterLoadListeners.forEach(s=>{r.forEach(a=>{if(s.isAllowed(a)){const o=s.execute(a);o instanceof Promise&&e.promises.push(o),e.count++}})}),i.forEach(s=>{r.forEach(a=>{const o=s.afterLoad(a,{entity:a,metadata:t,connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});o instanceof Promise&&e.promises.push(o),e.count++})})}}isAllowedSubscriber(e,t){return!e.listenTo||!e.listenTo()||e.listenTo()===Object||e.listenTo()===t||e.listenTo().isPrototypeOf(t)}}class N{constructor(e,t){this.query=e,this.parameters=t,this["@instanceof"]=Symbol.for("Query")}}class Bt{constructor(){this.upQueries=[],this.downQueries=[]}}class Zt{constructor(){this.isReleased=!1,this.isTransactionActive=!1,this.data={},this.loadedTables=[],this.loadedViews=[],this.sqlMemoryMode=!1,this.sqlInMemory=new Bt,this.transactionDepth=0,this.cachedTablePaths={}}async sql(e,...t){const{query:n,parameters:i}=Yt({driver:this.connection.driver,strings:e,expressions:t});return await this.query(n,i)}async beforeMigration(){}async afterMigration(){}async getTable(e){return this.loadedTables=await this.loadTables([e]),this.loadedTables.length>0?this.loadedTables[0]:void 0}async getTables(e){return e?(this.loadedTables=await this.loadTables(e),this.loadedTables):await this.loadTables(e)}async getView(e){return this.loadedViews=await this.loadViews([e]),this.loadedViews.length>0?this.loadedViews[0]:void 0}async getViews(e){return this.loadedViews=await this.loadViews(e),this.loadedViews}enableSqlMemory(){this.sqlInMemory=new Bt,this.sqlMemoryMode=!0}disableSqlMemory(){this.sqlInMemory=new Bt,this.sqlMemoryMode=!1}clearSqlMemory(){this.sqlInMemory=new Bt}getMemorySql(){return this.sqlInMemory}async executeMemoryUpSql(){for(const{query:e,parameters:t}of this.sqlInMemory.upQueries)await this.query(e,t)}async executeMemoryDownSql(){for(const{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())await this.query(e,t)}getReplicationMode(){return this.mode}async getCachedView(e){const t=this.loadedViews.find(i=>i.name===e);if(t)return t;const n=await this.loadViews([e]);if(n.length>0)return this.loadedViews.push(n[0]),n[0];throw new C(`View "${e}" does not exist.`)}async getCachedTable(e){if(e in this.cachedTablePaths){const n=this.cachedTablePaths[e],i=this.loadedTables.find(r=>this.getTablePath(r)===n);if(i)return i}const t=await this.loadTables([e]);if(t.length>0){const n=this.getTablePath(t[0]),i=this.loadedTables.find(r=>this.getTablePath(r)===n);return i||(this.cachedTablePaths[e]=this.getTablePath(t[0]),this.loadedTables.push(t[0]),t[0])}else throw new C(`Table "${e}" does not exist.`)}replaceCachedTable(e,t){const n=this.getTablePath(e),i=this.loadedTables.find(r=>this.getTablePath(r)===n);for(const[r,s]of Object.entries(this.cachedTablePaths))s===n&&(this.cachedTablePaths[r]=this.getTablePath(t));i&&(i.database=t.database,i.schema=t.schema,i.name=t.name,i.columns=t.columns,i.indices=t.indices,i.foreignKeys=t.foreignKeys,i.uniques=t.uniques,i.checks=t.checks,i.justCreated=t.justCreated,i.engine=t.engine,i.comment=t.comment)}getTablePath(e){const t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema,t.database)}getTypeormMetadataTableName(){const e=this.connection.driver.options;return this.connection.driver.buildTableName(this.connection.metadataTableName,e.schema,e.database)}selectTypeormMetadataSql({database:e,schema:t,table:n,type:i,name:r}){const s=this.connection.createQueryBuilder(),a=s.select().from(this.getTypeormMetadataTableName(),"t").where(`${s.escape("type")} = :type`,{type:i}).andWhere(`${s.escape("name")} = :name`,{name:r});e&&a.andWhere(`${s.escape("database")} = :database`,{database:e}),t&&a.andWhere(`${s.escape("schema")} = :schema`,{schema:t}),n&&a.andWhere(`${s.escape("table")} = :table`,{table:n});const[o,c]=a.getQueryAndParameters();return new N(o,c)}insertTypeormMetadataSql({database:e,schema:t,table:n,type:i,name:r,value:s}){const[a,o]=this.connection.createQueryBuilder().insert().into(this.getTypeormMetadataTableName()).values({database:e,schema:t,table:n,type:i,name:r,value:s}).getQueryAndParameters();return new N(a,o)}deleteTypeormMetadataSql({database:e,schema:t,table:n,type:i,name:r}){const s=this.connection.createQueryBuilder(),a=s.delete().from(this.getTypeormMetadataTableName()).where(`${s.escape("type")} = :type`,{type:i}).andWhere(`${s.escape("name")} = :name`,{name:r});e&&a.andWhere(`${s.escape("database")} = :database`,{database:e}),t&&a.andWhere(`${s.escape("schema")} = :schema`,{schema:t}),n&&a.andWhere(`${s.escape("table")} = :table`,{table:n});const[o,c]=a.getQueryAndParameters();return new N(o,c)}isColumnChanged(e,t,n,i,r=!0){return e.charset!==t.charset||e.collation!==t.collation||e.precision!==t.precision||e.scale!==t.scale||e.width!==t.width||e.zerofill!==t.zerofill||e.unsigned!==t.unsigned||e.asExpression!==t.asExpression||n&&e.default!==t.default||e.onUpdate!==t.onUpdate||e.isNullable!==t.isNullable||i&&e.comment!==t.comment||r&&this.isEnumChanged(e,t)}isEnumChanged(e,t){return!Q.isArraysEqual(e.enum||[],t.enum||[])}isDefaultColumnLength(e,t,n){if(this.connection.hasMetadata(e.name)){const r=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(r&&this.connection.driver.getColumnLength(r))return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].length?this.connection.driver.dataTypeDefaults[t.type].length.toString()===n.toString():!1}isDefaultColumnPrecision(e,t,n){if(this.connection.hasMetadata(e.name)){const r=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(r&&r.precision!==null&&r.precision!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].precision!==null&&this.connection.driver.dataTypeDefaults[t.type].precision!==void 0?this.connection.driver.dataTypeDefaults[t.type].precision===n:!1}isDefaultColumnScale(e,t,n){if(this.connection.hasMetadata(e.name)){const r=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(r&&r.scale!==null&&r.scale!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].scale!==null&&this.connection.driver.dataTypeDefaults[t.type].scale!==void 0?this.connection.driver.dataTypeDefaults[t.type].scale===n:!1}async executeQueries(e,t){if(v.isQuery(e)&&(e=[e]),v.isQuery(t)&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(const{query:n,parameters:i}of e)await this.query(n,i)}generateIndexName(e,t){return this.connection.namingStrategy.indexName(e,t.columnNames,t.where)}}var se;(function(p){p.VIEW="VIEW",p.MATERIALIZED_VIEW="MATERIALIZED_VIEW",p.GENERATED_COLUMN="GENERATED_COLUMN"})(se||(se={}));class yt extends Zt{constructor(){super(),this.transactionPromise=null}connect(){return Promise.resolve(this.driver.databaseConnection)}release(){return this.loadedTables=[],this.clearSqlMemory(),Promise.resolve()}async startTransaction(e){if(this.driver.transactionSupport==="none")throw new C(`Transactions aren't supported by ${this.connection.driver.options.type}.`);if(this.isTransactionActive&&this.driver.transactionSupport==="simple")throw new ea;if(e&&e!=="READ UNCOMMITTED"&&e!=="SERIALIZABLE")throw new C("SQLite only supports SERIALIZABLE and READ UNCOMMITTED isolation");this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(e&&(e==="READ UNCOMMITTED"?await this.query("PRAGMA read_uncommitted = true"):await this.query("PRAGMA read_uncommitted = false")),await this.query("BEGIN TRANSACTION")):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}stream(e,t,n,i){throw new C("Stream is not supported by sqlite driver.")}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return Promise.resolve(!1)}async getCurrentDatabase(){return Promise.resolve(void 0)}async hasSchema(e){throw new C("This driver does not support table schemas")}async getCurrentSchema(){return Promise.resolve(void 0)}async hasTable(e){const n=`SELECT * FROM "sqlite_master" WHERE "type" = 'table' AND "name" = '${v.isTable(e)?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=v.isTable(e)?e.name:e,i=`PRAGMA table_xinfo(${this.escapePath(n)})`;return!!(await this.query(i)).find(s=>s.name===t)}async createDatabase(e,t){return Promise.resolve()}async dropDatabase(e,t){return Promise.resolve()}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t){return Promise.resolve()}async createTable(e,t=!1,n=!0,i=!0){const r=[],s=[];if(t&&await this.hasTable(e))return Promise.resolve();r.push(this.createTableSql(e,n)),s.push(this.dropTableSql(e)),i&&e.indices.forEach(o=>{o.name||(o.name=this.connection.namingStrategy.indexName(e,o.columnNames,o.where)),r.push(this.createIndexSql(e,o)),s.push(this.dropIndexSql(o))});const a=e.columns.filter(o=>o.generatedType&&o.asExpression);for(const o of a){const c=this.insertTypeormMetadataSql({table:e.name,type:se.GENERATED_COLUMN,name:o.name,value:o.asExpression}),u=this.deleteTypeormMetadataSql({table:e.name,type:se.GENERATED_COLUMN,name:o.name});r.push(c),s.push(u)}await this.executeQueries(r,s)}async dropTable(e,t,n=!0,i=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const r=n,s=v.isTable(e)?e:await this.getCachedTable(e),a=[],o=[];i&&s.indices.forEach(u=>{a.push(this.dropIndexSql(u)),o.push(this.createIndexSql(s,u))}),a.push(this.dropTableSql(s,t)),o.push(this.createTableSql(s,r));const c=s.columns.filter(u=>u.generatedType&&u.asExpression);for(const u of c){const l=this.deleteTypeormMetadataSql({table:s.name,type:se.GENERATED_COLUMN,name:u.name}),h=this.insertTypeormMetadataSql({table:s.name,type:se.GENERATED_COLUMN,name:u.name,value:u.asExpression});a.push(l),o.push(h)}await this.executeQueries(a,o)}async createView(e,t=!1){const n=[],i=[];n.push(this.createViewSql(e)),t&&n.push(this.insertViewDefinitionSql(e)),i.push(this.dropViewSql(e)),t&&i.push(this.deleteViewDefinitionSql(e)),await this.executeQueries(n,i)}async dropView(e){const t=v.isView(e)?e.name:e,n=await this.getCachedView(t),i=[],r=[];i.push(this.deleteViewDefinitionSql(n)),i.push(this.dropViewSql(n)),r.push(this.insertViewDefinitionSql(n)),r.push(this.createViewSql(n)),await this.executeQueries(i,r)}async renameTable(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();i.name=t;const r=new N(`ALTER TABLE ${this.escapePath(n.name)} RENAME TO ${this.escapePath(t)}`),s=new N(`ALTER TABLE ${this.escapePath(t)} RENAME TO ${this.escapePath(n.name)}`);await this.executeQueries(r,s),i.uniques.forEach(a=>{const o=this.connection.namingStrategy.uniqueConstraintName(n,a.columnNames);a.name===o&&(a.name=this.connection.namingStrategy.uniqueConstraintName(i,a.columnNames))}),i.foreignKeys.forEach(a=>{const o=this.connection.namingStrategy.foreignKeyName(n,a.columnNames,this.getTablePath(a),a.referencedColumnNames);a.name===o&&(a.name=this.connection.namingStrategy.foreignKeyName(i,a.columnNames,this.getTablePath(a),a.referencedColumnNames))}),i.indices.forEach(a=>{const o=this.connection.namingStrategy.indexName(n,a.columnNames,a.where);a.name===o&&(a.name=this.connection.namingStrategy.indexName(i,a.columnNames,a.where))}),n.name=i.name,await this.recreateTable(i,n)}async addColumn(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);return this.addColumns(n,[t])}async addColumns(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.addColumn(r)),await this.recreateTable(i,n)}async renameColumn(e,t,n){const i=v.isTable(e)?e:await this.getCachedTable(e),r=v.isTableColumn(t)?t:i.columns.find(a=>a.name===t);if(!r)throw new C(`Column "${t}" was not found in the "${i.name}" table.`);let s;return v.isTableColumn(n)?s=n:(s=r.clone(),s.name=n),this.changeColumn(i,r,s)}async changeColumn(e,t,n){const i=v.isTable(e)?e:await this.getCachedTable(e),r=v.isTableColumn(t)?t:i.columns.find(s=>s.name===t);if(!r)throw new C(`Column "${t}" was not found in the "${i.name}" table.`);await this.changeColumns(i,[{oldColumn:r,newColumn:n}])}async changeColumns(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>{r.newColumn.name!==r.oldColumn.name&&(i.findColumnUniques(r.oldColumn).forEach(a=>{const o=this.connection.namingStrategy.uniqueConstraintName(n,a.columnNames);a.columnNames.splice(a.columnNames.indexOf(r.oldColumn.name),1),a.columnNames.push(r.newColumn.name),a.name===o&&(a.name=this.connection.namingStrategy.uniqueConstraintName(i,a.columnNames))}),i.findColumnForeignKeys(r.oldColumn).forEach(a=>{const o=this.connection.namingStrategy.foreignKeyName(n,a.columnNames,this.getTablePath(a),a.referencedColumnNames);a.columnNames.splice(a.columnNames.indexOf(r.oldColumn.name),1),a.columnNames.push(r.newColumn.name),a.name===o&&(a.name=this.connection.namingStrategy.foreignKeyName(i,a.columnNames,this.getTablePath(a),a.referencedColumnNames))}),i.findColumnIndices(r.oldColumn).forEach(a=>{const o=this.connection.namingStrategy.indexName(n,a.columnNames,a.where);a.columnNames.splice(a.columnNames.indexOf(r.oldColumn.name),1),a.columnNames.push(r.newColumn.name),a.name===o&&(a.name=this.connection.namingStrategy.indexName(i,a.columnNames,a.where))}));const s=i.columns.find(a=>a.name===r.oldColumn.name);s&&(i.columns[i.columns.indexOf(s)]=r.newColumn)}),await this.recreateTable(i,n)}async dropColumn(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableColumn(t)?t:n.findColumnByName(t);if(!i)throw new C(`Column "${t}" was not found in table "${n.name}"`);await this.dropColumns(n,[i])}async dropColumns(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>{const s=v.isTableColumn(r)?r:n.findColumnByName(r);if(!s)throw new Error(`Column "${r}" was not found in table "${n.name}"`);i.removeColumn(s),i.findColumnUniques(s).forEach(a=>i.removeUniqueConstraint(a)),i.findColumnIndices(s).forEach(a=>i.removeIndex(a)),i.findColumnForeignKeys(s).forEach(a=>i.removeForeignKey(a))}),await this.recreateTable(i,n)}async createPrimaryKey(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();i.columns.forEach(r=>{t.find(s=>s===r.name)&&(r.isPrimary=!0)}),await this.recreateTable(i,n),n.columns.forEach(r=>{t.find(s=>s===r.name)&&(r.isPrimary=!0)})}async updatePrimaryKeys(e,t){await Promise.resolve()}async dropPrimaryKey(e){const t=v.isTable(e)?e:await this.getCachedTable(e),n=t.clone();n.primaryColumns.forEach(i=>{i.isPrimary=!1}),await this.recreateTable(n,t),t.primaryColumns.forEach(i=>{i.isPrimary=!1})}async createUniqueConstraint(e,t){await this.createUniqueConstraints(e,[t])}async createUniqueConstraints(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.addUniqueConstraint(r)),await this.recreateTable(i,n)}async dropUniqueConstraint(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableUnique(t)?t:n.uniques.find(r=>r.name===t);if(!i)throw new C(`Supplied unique constraint was not found in table ${n.name}`);await this.dropUniqueConstraints(n,[i])}async dropUniqueConstraints(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.removeUniqueConstraint(r)),await this.recreateTable(i,n)}async createCheckConstraint(e,t){await this.createCheckConstraints(e,[t])}async createCheckConstraints(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.addCheckConstraint(r)),await this.recreateTable(i,n)}async dropCheckConstraint(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableCheck(t)?t:n.checks.find(r=>r.name===t);if(!i)throw new C(`Supplied check constraint was not found in table ${n.name}`);await this.dropCheckConstraints(n,[i])}async dropCheckConstraints(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.removeCheckConstraint(r)),await this.recreateTable(i,n)}async createExclusionConstraint(e,t){throw new C("Sqlite does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new C("Sqlite does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new C("Sqlite does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new C("Sqlite does not support exclusion constraints.")}async createForeignKey(e,t){await this.createForeignKeys(e,[t])}async createForeignKeys(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.addForeignKey(r)),await this.recreateTable(i,n)}async dropForeignKey(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableForeignKey(t)?t:n.foreignKeys.find(r=>r.name===t);if(!i)throw new C(`Supplied foreign key was not found in table ${n.name}`);await this.dropForeignKeys(e,[i])}async dropForeignKeys(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.removeForeignKey(r)),await this.recreateTable(i,n)}async createIndex(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createIndexSql(n,t),r=this.dropIndexSql(t);await this.executeQueries(i,r),n.addIndex(t)}async createIndices(e,t){const n=t.map(i=>this.createIndex(e,i));await Promise.all(n)}async dropIndex(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableIndex(t)?t:n.indices.find(a=>a.name===t);if(!i)throw new C(`Supplied index ${t} was not found in table ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(i),s=this.createIndexSql(n,i);await this.executeQueries(r,s),n.removeIndex(i)}async dropIndices(e,t){const n=t.map(i=>this.dropIndex(e,i));await Promise.all(n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)}`)}async clearDatabase(e){let t;e&&this.driver.getAttachedDatabaseHandleByRelativePath(e)&&(t=this.driver.getAttachedDatabaseHandleByRelativePath(e)),await this.query("PRAGMA foreign_keys = OFF");const n=this.isTransactionActive;n||await this.startTransaction();try{const i=t?`SELECT 'DROP VIEW "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'view'`:`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`,r=await this.query(i);await Promise.all(r.map(o=>this.query(o.query)));const s=t?`SELECT 'DROP TABLE "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`:`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`,a=await this.query(s);await Promise.all(a.map(o=>this.query(o.query))),n||await this.commitTransaction()}catch(i){try{n||await this.rollbackTransaction()}catch{}throw i}finally{await this.query("PRAGMA foreign_keys = ON")}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=e.map(s=>"'"+s+"'").join(", ");let i=`SELECT "t".* FROM "${this.getTypeormMetadataTableName()}" "t" INNER JOIN "sqlite_master" s ON "s"."name" = "t"."name" AND "s"."type" = 'view' WHERE "t"."type" = '${se.VIEW}'`;return n.length>0&&(i+=` AND "t"."name" IN (${n})`),(await this.query(i)).map(s=>{const a=new lt;return a.name=s.name,a.expression=s.value,a})}async loadTableRecords(e,t){let n;const[i,r]=this.splitTablePath(e);return i&&this.driver.getAttachedDatabasePathRelativeByHandle(i)&&(n=this.driver.getAttachedDatabasePathRelativeByHandle(i)),this.query(`SELECT ${n?`'${n}'`:null} as database, ${i?`'${i}'`:null} as schema, * FROM ${i?`"${i}".`:""}${this.escapePath("sqlite_master")} WHERE "type" = '${t}' AND "${t==="table"?"name":"tbl_name"}" IN ('${r}')`)}async loadPragmaRecords(e,t){const[,n]=this.splitTablePath(e);return this.query(`PRAGMA ${t}("${n}")`)}async loadTables(e){if(e&&e.length===0)return[];let t=[],n;if(e){const i=e.filter(a=>a.split(".").length===1).map(a=>`'${a}'`),r=e.filter(a=>a.split(".").length>1),s=a=>{const o=[...r.map(c=>this.loadTableRecords(c,a))];return i.length&&o.push(this.query(`SELECT * FROM "sqlite_master" WHERE "type" = '${a}' AND "${a==="table"?"name":"tbl_name"}" IN (${i})`)),o};t=(await Promise.all(s("table"))).reduce((a,o)=>[...a,...o],[]).filter(Boolean),n=(await Promise.all(s("index"))).reduce((a,o)=>[...a,...o],[]).filter(Boolean)}else{t.push(...await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'table'`));const r=t.map(({name:s})=>`'${s}'`).join(", ");n=await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'index' AND "tbl_name" IN (${r})`)}return t.length===0?[]:Promise.all(t.map(async i=>{const r=i.database&&this.driver.getAttachedDatabaseHandleByRelativePath(i.database)?`${this.driver.getAttachedDatabaseHandleByRelativePath(i.database)}.${i.name}`:i.name,s=i.sql,a=s.includes("WITHOUT ROWID"),o=new Se({name:r,withoutRowid:a}),[c,u,l]=await Promise.all([this.loadPragmaRecords(r,"table_xinfo"),this.loadPragmaRecords(r,"index_list"),this.loadPragmaRecords(r,"foreign_key_list")]);let h;const m=i.sql,y=m.toUpperCase().indexOf("AUTOINCREMENT");if(y!==-1){h=m.substr(0,y);const S=h.lastIndexOf(","),V=h.lastIndexOf("(");S!==-1?(h=h.substr(S),h=h.substr(0,h.lastIndexOf('"')),h=h.substr(h.indexOf('"')+1)):V!==-1&&(h=h.substr(V),h=h.substr(0,h.lastIndexOf('"')),h=h.substr(h.indexOf('"')+1))}o.columns=await Promise.all(c.map(async S=>{const V=new Fe;if(V.name=S.name,V.type=S.type.toLowerCase(),V.default=S.dflt_value!==null&&S.dflt_value!==void 0?S.dflt_value:void 0,V.isNullable=S.notnull===0,V.isPrimary=S.pk>0,V.comment="",V.isGenerated=h===S.name,V.isGenerated&&(V.generationStrategy="increment"),S.hidden===2||S.hidden===3){V.generatedType=S.hidden===2?"VIRTUAL":"STORED";const D=this.selectTypeormMetadataSql({table:o.name,type:se.GENERATED_COLUMN,name:V.name}),q=await this.query(D.query,D.parameters);q[0]&&q[0].value?V.asExpression=q[0].value:V.asExpression=""}V.type==="varchar"&&(V.enum=Q.parseSqlCheckExpression(s,V.name));const L=V.type.indexOf("(");if(L!==-1){const D=V.type,q=D.substr(0,L);if(this.driver.withLengthColumnTypes.find(_=>_===q)){const _=parseInt(D.substring(L+1,D.length-1));_&&(V.length=_.toString(),V.type=q)}if(this.driver.withPrecisionColumnTypes.find(_=>_===q)){const _=new RegExp(`^${q}\\((\\d+),?\\s?(\\d+)?\\)`),I=D.match(_);I&&I[1]&&(V.precision=+I[1]),this.driver.withScaleColumnTypes.find(B=>B===q)&&I&&I[2]&&(V.scale=+I[2]),V.type=q}}return V}));let g;const b=[],R=/CONSTRAINT "([^"]*)" FOREIGN KEY ?\((.*?)\) REFERENCES "([^"]*)"/g;for(;(g=R.exec(s))!==null;)b.push({name:g[1],columns:g[2].substr(1,g[2].length-2).split('", "'),referencedTableName:g[3]});const P=Q.uniq(l,S=>S.id);o.foreignKeys=P.map(S=>{const V=l.filter(_=>_.id===S.id&&_.table===S.table),L=V.map(_=>_.from),D=V.map(_=>_.to),q=b.find(_=>_.referencedTableName===S.table&&_.columns.every(I=>L.indexOf(I)!==-1));return new We({name:q?.name,columnNames:L,referencedTableName:S.table,referencedColumnNames:D,onDelete:S.on_delete,onUpdate:S.on_update})});let M;const U=[],F=/CONSTRAINT "([^"]*)" UNIQUE ?\((.*?)\)/g;for(;(M=F.exec(s))!==null;)U.push({name:M[1],columns:M[2].substr(1,M[2].length-2).split('", "')});const J=u.filter(S=>S.origin==="u").map(S=>S.name).filter((S,V,L)=>L.indexOf(S)===V).map(async S=>{const V=u.find(_=>_.name===S),D=(await this.query(`PRAGMA index_info("${V.name}")`)).sort((_,I)=>parseInt(_.seqno)-parseInt(I.seqno)).map(_=>_.name);if(D.length===1){const _=o.columns.find(I=>!!D.find(B=>B===I.name));_&&(_.isUnique=!0)}const q=U.find(_=>_.columns.every(I=>D.indexOf(I)!==-1));return new Le({name:q?q.name:this.connection.namingStrategy.uniqueConstraintName(o,D),columnNames:D})});o.uniques=await Promise.all(J);let K;const re=/CONSTRAINT "([^"]*)" CHECK ?(\(.*?\))([,]|[)]$)/g;for(;(K=re.exec(s))!==null;)o.checks.push(new tt({name:K[1],expression:K[2]}));const $=u.filter(S=>S.origin==="c").map(S=>S.name).filter((S,V,L)=>L.indexOf(S)===V).map(async S=>{const V=n.find(W=>W.name===S),L=/WHERE (.*)/.exec(V.sql),D=u.find(W=>W.name===S),_=(await this.query(`PRAGMA index_info("${D.name}")`)).sort((W,ee)=>parseInt(W.seqno)-parseInt(ee.seqno)).map(W=>W.name),I=`${i.database?`${i.database}.`:""}${D.name}`,B=D.unique==="1"||D.unique===1;return new Pe({table:o,name:I,columnNames:_,isUnique:B,where:L?L[1]:void 0})}),Y=await Promise.all($);return o.indices=Y.filter(S=>!!S),o}))}createTableSql(e,t,n){const i=e.columns.filter(m=>m.isPrimary),r=i.find(m=>m.isGenerated&&m.generationStrategy==="increment"),s=i.length>1;if(s&&r)throw new C("Sqlite does not support AUTOINCREMENT on composite primary key");const a=e.columns.map(m=>this.buildCreateColumnSql(m,s)).join(", "),[o]=this.splitTablePath(e.name);let c=`CREATE TABLE ${this.escapePath(e.name)} (${a}`;const[u,l]=this.splitTablePath(e.name),h=n?`${u?`${u}.`:""}${l.replace(/^temporary_/,"")}`:e.name;if(e.columns.filter(m=>m.isUnique).forEach(m=>{e.uniques.some(g=>g.columnNames.length===1&&g.columnNames[0]===m.name)||e.uniques.push(new Le({name:this.connection.namingStrategy.uniqueConstraintName(e,[m.name]),columnNames:[m.name]}))}),e.uniques.length>0){const m=e.uniques.map(y=>{const g=y.name?y.name:this.connection.namingStrategy.uniqueConstraintName(h,y.columnNames),b=y.columnNames.map(R=>`"${R}"`).join(", ");return`CONSTRAINT "${g}" UNIQUE (${b})`}).join(", ");c+=`, ${m}`}if(e.checks.length>0){const m=e.checks.map(y=>`CONSTRAINT "${y.name?y.name:this.connection.namingStrategy.checkConstraintName(h,y.expression)}" CHECK (${y.expression})`).join(", ");c+=`, ${m}`}if(e.foreignKeys.length>0&&t){const m=e.foreignKeys.filter(y=>{const[g]=this.splitTablePath(y.referencedTableName);return g===o}).map(y=>{const[,g]=this.splitTablePath(y.referencedTableName),b=y.columnNames.map(M=>`"${M}"`).join(", ");y.name||(y.name=this.connection.namingStrategy.foreignKeyName(h,y.columnNames,this.getTablePath(y),y.referencedColumnNames));const R=y.referencedColumnNames.map(M=>`"${M}"`).join(", ");let P=`CONSTRAINT "${y.name}" FOREIGN KEY (${b}) REFERENCES "${g}" (${R})`;return y.onDelete&&(P+=` ON DELETE ${y.onDelete}`),y.onUpdate&&(P+=` ON UPDATE ${y.onUpdate}`),y.deferrable&&(P+=` DEFERRABLE ${y.deferrable}`),P}).join(", ");c+=`, ${m}`}if(i.length>1){const m=i.map(y=>`"${y.name}"`).join(", ");c+=`, PRIMARY KEY (${m})`}return c+=")",e.withoutRowid&&(c+=" WITHOUT ROWID"),new N(c)}dropTableSql(e,t){const n=v.isTable(e)?e.name:e,i=t?`DROP TABLE IF EXISTS ${this.escapePath(n)}`:`DROP TABLE ${this.escapePath(n)}`;return new N(i)}createViewSql(e){return typeof e.expression=="string"?new N(`CREATE VIEW "${e.name}" AS ${e.expression}`):new N(`CREATE VIEW "${e.name}" AS ${e.expression(this.connection).getQuery()}`)}insertViewDefinitionSql(e){const t=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:se.VIEW,name:e.name,value:t})}dropViewSql(e){const t=v.isView(e)?e.name:e;return new N(`DROP VIEW "${t}"`)}deleteViewDefinitionSql(e){const t=v.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:se.VIEW,name:t})}createIndexSql(e,t){const n=t.columnNames.map(s=>`"${s}"`).join(", "),[i,r]=this.splitTablePath(e.name);return new N(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX ${i?`"${i}".`:""}${this.escapePath(t.name)} ON "${r}" (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e){const t=v.isTableIndex(e)?e.name:e;return new N(`DROP INDEX ${this.escapePath(t)}`)}buildCreateColumnSql(e,t){let n='"'+e.name+'"';return v.isColumnMetadata(e)?n+=" "+this.driver.normalizeType(e):n+=" "+this.connection.driver.createFullType(e),e.enum&&(n+=' CHECK( "'+e.name+'" IN ('+e.enum.map(i=>"'"+i+"'").join(",")+") )"),e.isPrimary&&!t&&(n+=" PRIMARY KEY"),e.isGenerated===!0&&e.generationStrategy==="increment"&&(n+=" AUTOINCREMENT"),e.collation&&(n+=" COLLATE "+e.collation),e.isNullable!==!0&&(n+=" NOT NULL"),e.asExpression?n+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`:e.default!==void 0&&e.default!==null&&(n+=" DEFAULT ("+e.default+")"),n}async recreateTable(e,t,n=!0){const i=[],r=[];t.indices.forEach(c=>{i.push(this.dropIndexSql(c)),r.push(this.createIndexSql(t,c))});let[s,a]=this.splitTablePath(e.name);const[,o]=this.splitTablePath(t.name);if(e.name=a=`${s?`${s}.`:""}temporary_${a}`,i.push(this.createTableSql(e,!0,!0)),r.push(this.dropTableSql(e)),n){let c=e.columns.filter(l=>!l.generatedType).map(l=>`"${l.name}"`),u=t.columns.filter(l=>!l.generatedType).map(l=>`"${l.name}"`);u.length<c.length?c=e.columns.filter(l=>{const h=t.columns.find(m=>m.name===l.name);return h&&h.generatedType?!1:!l.generatedType&&h}).map(l=>`"${l.name}"`):u.length>c.length&&(u=t.columns.filter(l=>!l.generatedType&&e.columns.find(h=>h.name===l.name)).map(l=>`"${l.name}"`)),i.push(new N(`INSERT INTO ${this.escapePath(e.name)}(${c.join(", ")}) SELECT ${u.join(", ")} FROM ${this.escapePath(t.name)}`)),r.push(new N(`INSERT INTO ${this.escapePath(t.name)}(${u.join(", ")}) SELECT ${c.join(", ")} FROM ${this.escapePath(e.name)}`))}i.push(this.dropTableSql(t)),r.push(this.createTableSql(t,!0)),i.push(new N(`ALTER TABLE ${this.escapePath(e.name)} RENAME TO ${this.escapePath(o)}`)),r.push(new N(`ALTER TABLE ${this.escapePath(t.name)} RENAME TO ${this.escapePath(a)}`)),e.name=t.name,e.indices.forEach(c=>{c.name||(c.name=this.connection.namingStrategy.indexName(e,c.columnNames,c.where)),i.push(this.createIndexSql(e,c)),r.push(this.dropIndexSql(c))}),t.columns.filter(c=>{const u=e.columns.find(l=>l.name===c.name);return c.generatedType&&c.asExpression&&(!u||!u.generatedType&&!u.asExpression)}).forEach(c=>{const u=this.deleteTypeormMetadataSql({table:t.name,type:se.GENERATED_COLUMN,name:c.name}),l=this.insertTypeormMetadataSql({table:t.name,type:se.GENERATED_COLUMN,name:c.name,value:c.asExpression});i.push(u),r.push(l)}),e.columns.filter(c=>c.generatedType&&c.asExpression&&!t.columns.some(u=>u.name===c.name)).forEach(c=>{const u=this.insertTypeormMetadataSql({table:e.name,type:se.GENERATED_COLUMN,name:c.name,value:c.asExpression}),l=this.deleteTypeormMetadataSql({table:e.name,type:se.GENERATED_COLUMN,name:c.name});i.push(u),r.push(l)}),e.columns.filter(c=>c.generatedType&&c.asExpression).forEach(c=>{const u=t.columns.find(g=>g.name===c.name&&g.generatedType&&c.generatedType&&g.asExpression!==c.asExpression);if(!u)return;const l=this.deleteTypeormMetadataSql({table:t.name,type:se.GENERATED_COLUMN,name:u.name}),h=this.insertTypeormMetadataSql({table:e.name,type:se.GENERATED_COLUMN,name:c.name,value:c.asExpression});i.push(l),i.push(h);const m=this.insertTypeormMetadataSql({table:e.name,type:se.GENERATED_COLUMN,name:u.name,value:u.asExpression}),y=this.deleteTypeormMetadataSql({table:t.name,type:se.GENERATED_COLUMN,name:c.name});r.push(m),r.push(y)}),await this.executeQueries(i,r),this.replaceCachedTable(t,e)}splitTablePath(e){return e.indexOf(".")!==-1?e.split("."):[void 0,e]}escapePath(e,t){return(v.isTable(e)||v.isView(e)?e.name:e).replace(/^\.+|\.+$/g,"").split(".").map(i=>t?i:`"${i}"`).join(".")}changeTableComment(e,t){throw new C("sqlit driver does not support change comment.")}}class hc extends yt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ot(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Be;const i=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const r=new Ge,s=Date.now();try{const a=await new Promise((h,m)=>{i.executeSql(e,t,y=>h(y),y=>m(y))}),o=this.driver.options.maxQueryExecutionTime,u=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,u,a,void 0),o&&u>o&&this.driver.connection.logger.logQuerySlow(u,e,t,this);const l=new it;if(e.substr(0,11)==="INSERT INTO")l.raw=a.insertId;else{const h=[];for(let m=0;m<a.rows.length;m++)h.push(a.rows.item(m));l.records=h,l.raw=h}return n?l:l.raw}catch(a){throw this.driver.connection.logger.logQueryError(a,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,void 0,void 0,a),new et(e,t,a)}finally{await r.wait()}}async startTransaction(){throw new C("Transactions are not supported by the Cordova driver")}async commitTransaction(){throw new C("Transactions are not supported by the Cordova driver")}async rollbackTransaction(){throw new C("Transactions are not supported by the Cordova driver")}async clearDatabase(){await this.query("PRAGMA foreign_keys = OFF");try{const t=await this.query(`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`),i=await this.query(`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`);await Promise.all(t.map(r=>this.query(r.query))),await Promise.all(i.map(r=>this.query(r.query)))}finally{await this.query("PRAGMA foreign_keys = ON")}}parametrize(e,t=0){return Object.keys(e).map((n,i)=>`"${n}"=?`)}}class dc extends Nt{constructor(e){super(e),this.transactionSupport="none",this.database=this.options.database,this.loadDependencies()}async disconnect(){return this.queryRunner=void 0,new Promise((e,t)=>{this.databaseConnection.close(e,t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new hc(this)),this.queryRunner}async createDatabaseConnection(){const e=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{}),t=await new Promise((n,i)=>{this.sqlite.openDatabase(e,r=>n(r),r=>i(r))});return await new Promise((n,i)=>{t.executeSql("PRAGMA foreign_keys = ON",[],()=>n(),r=>i(r))}),t}loadDependencies(){try{const e=this.options.driver||window.sqlitePlugin;this.sqlite=e}catch{throw new Tt("Cordova-SQLite","cordova-sqlite-storage")}}}class pc extends yt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ot(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Be;const i=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const r=new Ge,s=Date.now();return new Promise(async(a,o)=>{try{i.executeSql(e,t,async c=>{const u=this.driver.options.maxQueryExecutionTime,h=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,h,c,void 0),u&&h>u&&this.driver.connection.logger.logQuerySlow(h,e,t,this),r.promises.length>0&&await Promise.all(r.promises);const m=new it;if(c?.hasOwnProperty("rowsAffected")&&(m.affected=c.rowsAffected),c?.hasOwnProperty("rows")){const y=[];for(let g=0;g<c.rows.length;g++)y.push(c.rows.item(g));m.raw=y,m.records=y}e.substr(0,11)==="INSERT INTO"&&(m.raw=c.insertId),a(n?m:m.raw)},c=>{this.driver.connection.logger.logQueryError(c,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,void 0,void 0,c),o(new et(e,t,c))})}catch(c){o(c)}finally{await r.wait()}})}parametrize(e,t=0){return Object.keys(e).map((n,i)=>`"${n}"=?`)}}class mc{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=this.options.database,this.loadDependencies()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new pc(this)),this.queryRunner}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(e,t)})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){return this.attachedDatabases?.[e]?.attachHandle}getAttachedDatabasePathRelativeByHandle(e){return Object.values(this.attachedDatabases).find(({attachHandle:t})=>e===t)?.attachFilepathRelative}createSchemaBuilder(){return new Xt(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=De.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?ne.mixedDateToDateString(e):t.type==="time"?ne.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?ne.mixedDateToUtcDatetimeString(e):t.type==="simple-array"?ne.simpleArrayToString(e):t.type==="simple-json"?ne.simpleJsonToString(e):t.type==="simple-enum"?ne.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?De.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=ne.normalizeHydratedDate(e)):t.type==="date"?e=ne.mixedDateToDateString(e):t.type==="time"?e=ne.mixedTimeToString(e):t.type==="simple-array"?e=ne.stringToSimpleArray(e):t.type==="simple-json"?e=ne.stringToSimpleJson(e):t.type==="simple-enum"?e=ne.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=De.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){const i=Object.keys(n).map(r=>typeof n[r]=="boolean"?n[r]===!0?1:0:n[r]instanceof Date?ne.mixedDateToUtcDatetimeString(n[r]):n[r]);return!t||!Object.keys(t).length?[e,i]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(r,s,a)=>{if(!t.hasOwnProperty(a))return r;const o=t[a];return s?o.map(c=>(i.push(c),this.createParameter(a,i.length-1))).join(", "):typeof o=="function"?o():typeof o=="number"?String(o):typeof o=="boolean"?(i.push(+o),this.createParameter(a,i.length-1)):o instanceof Date?(i.push(ne.mixedDateToUtcDatetimeString(o)),this.createParameter(a,i.length-1)):(i.push(o),this.createParameter(a,i.length-1))}),[e,i])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){const t=this.database,n=void 0;if(v.isTable(e)||v.isView(e)){const r=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||r.database||t,schema:e.schema||r.schema||n,tableName:r.tableName}}if(v.isTableForeignKey(e)){const r=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||r.database||t,schema:e.referencedSchema||r.schema||n,tableName:r.tableName}}if(v.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const i=e.split(".");return i.length===3?{database:i[0]||t,schema:i[1]||n,tableName:i[2]}:i.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(i[0])??t,schema:i[0],tableName:i[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){const t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,i){const r=e.generatedColumns.reduce((s,a)=>{let o;return a.generationStrategy==="increment"&&t&&(o=t-i+n+1),o?Q.mergeDeep(s,a.createValueMap(o)):s},{});return Object.keys(r).length>0?r:void 0}findChangedColumns(e,t){return t.filter(n=>{const i=e.find(s=>s.name===n.databaseName);return i?i.name!==n.databaseName||i.type!==this.normalizeType(n)||i.length!==n.length||i.precision!==n.precision||i.scale!==n.scale||this.normalizeDefault(n)!==i.default||i.isPrimary!==n.isPrimary||i.isNullable!==n.isNullable||i.generatedType!==n.generatedType||i.asExpression!==n.asExpression||i.isUnique!==this.normalizeIsUnique(n)||i.enum&&n.enum&&!Q.isArraysEqual(i.enum,n.enum.map(s=>s+""))||n.generationStrategy!=="uuid"&&i.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}createDatabaseConnection(){return new Promise((e,t)=>{const n=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{});this.sqlite.openDatabase(n,i=>{const r=i;r.executeSql("PRAGMA foreign_keys = ON",[],s=>{e(r)},s=>{t(s)})},i=>{t(i)})})}loadDependencies(){try{const e=this.options.driver||require("react-native-sqlite-storage");this.sqlite=e}catch{throw new Tt("React-Native","react-native-sqlite-storage")}}}class fc extends yt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ot(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Be;const i=this.driver.connection,r=await this.connect();return new Promise((s,a)=>{const o=e.substr(0,11)==="INSERT INTO";i.logger.logQuery(e,t,this);const c=(l,h)=>{const m=this.driver.options.maxQueryExecutionTime,g=Date.now()-u;m&&g>m&&i.logger.logQuerySlow(g,e,t,this),l&&(i.logger.logQueryError(l,e,t,this),a(new et(e,t,l)));const b=new it;b.raw=h,!o&&Array.isArray(h)&&(b.records=h),s(n?b:b.raw)},u=Date.now();o?r.execSQL(e,t,c):r.all(e,t,c)})}parametrize(e,t=0){return Object.keys(e).map((n,i)=>`"${n}"=?`)}}class yc extends Nt{constructor(e){super(e),this.connection=e,this.options=e.options,this.database=this.options.database,this.driver=this.options.driver,this.loadDependencies()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close().then(e).catch(t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new fc(this)),this.queryRunner}normalizeType(e){return e.type===Buffer?"blob":super.normalizeType(e)}createDatabaseConnection(){return new Promise((e,t)=>{const n=Object.assign({},{readOnly:this.options.readOnly,key:this.options.key,multithreading:this.options.multithreading,migrate:this.options.migrate,iosFlags:this.options.iosFlags,androidFlags:this.options.androidFlags},this.options.extra||{});new this.sqlite(this.options.database,n,(i,r)=>{if(i)return t(i);r.resultType(this.sqlite.RESULTSASOBJECT),r.execSQL("PRAGMA foreign_keys = ON",[],(s,a)=>{if(s)return t(s);e(r)})})})}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new Tt("Nativescript","nativescript-sqlite")}}class gc extends yt{constructor(e){super(),this.isDirty=!1,this.driver=e,this.connection=e.connection,this.broadcaster=new ot(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async flush(){this.isDirty&&(await this.driver.autoSave(),this.isDirty=!1)}async release(){return await this.flush(),super.release()}async commitTransaction(){await super.commitTransaction(),this.isTransactionActive||await this.flush()}async query(e,t=[],n=!1){if(this.isReleased)throw new Be;const i=e.trim().split(" ",1)[0],r=this.driver.databaseConnection;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const s=new Ge,a=Date.now();let o;try{o=r.prepare(e),t&&(t=t.map(y=>typeof y<"u"?y:null),o.bind(t));const c=this.driver.options.maxQueryExecutionTime,l=Date.now()-a;c&&l>c&&this.driver.connection.logger.logQuerySlow(l,e,t,this);const h=[];for(;o.step();)h.push(o.getAsObject());this.broadcaster.broadcastAfterQueryEvent(s,e,t,!0,l,h,void 0);const m=new it;return m.affected=r.getRowsModified(),m.records=h,m.raw=h,o.free(),i!=="SELECT"&&(this.isDirty=!0),n?m:m.raw}catch(c){throw o&&o.free(),this.driver.connection.logger.logQueryError(c,e,t,this),this.broadcaster.broadcastAfterQueryEvent(s,e,t,!1,void 0,void 0,c),new et(e,t,c)}finally{await s.wait()}}}class Ec extends Nt{constructor(e){if(super(e),this.options.autoSave&&!this.options.location&&!this.options.autoSaveCallback)throw new la("location or autoSaveCallback");this.loadDependencies()}async connect(){this.databaseConnection=await this.createDatabaseConnection()}async disconnect(){this.queryRunner=void 0,this.databaseConnection.close()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new gc(this)),this.queryRunner}async load(e,t=!0){if(typeof e=="string")if(Ee.type==="node")if(Ee.fileExist(e)){const n=Ee.readFileSync(e);return this.createDatabaseConnectionWithImport(n)}else{if(t)throw new C(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else{let n=null;if(this.options.useLocalForage)if(window.localforage)n=await window.localforage.getItem(e);else throw new C("localforage is not defined - please import localforage.js into your site");else n=Ee.getGlobalVariable().localStorage.getItem(e);if(n!=null)return this.createDatabaseConnectionWithImport(JSON.parse(n));if(t)throw new C(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else return this.createDatabaseConnectionWithImport(e)}async save(e){if(!e&&!this.options.location)throw new C("No location is set, specify a location parameter or add the location option to your configuration");let t="";if(e?t=e:this.options.location&&(t=this.options.location),Ee.type==="node")try{const n=Buffer.from(this.databaseConnection.export());await Ee.writeFile(t,n)}catch(n){throw new C(`Could not save database, error: ${n}`)}else{const n=this.databaseConnection.export(),i=[].slice.call(n);if(this.options.useLocalForage)if(window.localforage)await window.localforage.setItem(t,JSON.stringify(i));else throw new C("localforage is not defined - please import localforage.js into your site");else Ee.getGlobalVariable().localStorage.setItem(t,JSON.stringify(i))}}async autoSave(){this.options.autoSave&&!this.queryRunner?.isTransactionActive&&(this.options.autoSaveCallback?await this.options.autoSaveCallback(this.export()):await this.save())}export(){return this.databaseConnection.export()}createGeneratedMap(e,t){const n=e.generatedColumns.reduce((i,r)=>{if(r.isPrimary&&r.generationStrategy==="increment"){const s="SELECT last_insert_rowid()";try{const a=this.databaseConnection.exec(s);return this.connection.logger.logQuery(s),Q.mergeDeep(i,r.createValueMap(a[0].values[0][0]))}catch(a){this.connection.logger.logQueryError(a,s,[])}}return i},{});return Object.keys(n).length>0?n:void 0}createDatabaseConnection(){return this.options.location?this.load(this.options.location,!1):this.createDatabaseConnectionWithImport(this.options.database)}async createDatabaseConnectionWithImport(e){const n=typeof this.sqlite.Database=="function"?this.sqlite:await this.sqlite(this.options.sqlJsConfig);return e&&e.length>0?this.databaseConnection=new n.Database(e):this.databaseConnection=new n.Database,this.databaseConnection.exec("PRAGMA foreign_keys = ON"),this.databaseConnection}loadDependencies(){if(Ee.type==="browser"){const e=this.options.driver||window.SQL;this.sqlite=e}else try{const e=this.options.driver||Ee.load("sql.js");this.sqlite=e}catch{throw new Tt("sql.js","sql.js")}}}class Tc extends yt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ot(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Be;const i=await this.connect(),r=new Ge;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const s=Date.now(),a=await i.prepareAsync(e);try{const o=await a.executeAsync(t),c=this.driver.options.maxQueryExecutionTime,l=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,l,o,void 0),await r.wait(),c&&l>c&&this.driver.connection.logger.logQuerySlow(l,e,t,this);const h=new it;return h.affected=o.changes,h.records=await o.getAllAsync(),h.raw=e.startsWith("INSERT INTO")?o.lastInsertRowId:h.records,n?h:h.raw}catch(o){throw this.driver.connection.logger.logQueryError(o,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,0,void 0,o),await r.wait(),new et(e,t,o)}finally{await r.wait(),await a.finalizeAsync()}}}class bc extends Nt{constructor(e){super(e),this.sqlite=this.options.driver}async disconnect(){this.queryRunner=void 0,await this.databaseConnection.closeAsync(),this.databaseConnection=void 0}createQueryRunner(){return this.queryRunner||(this.queryRunner=new Tc(this)),this.queryRunner}async createDatabaseConnection(){return this.databaseConnection=await this.sqlite.openDatabaseAsync(this.options.database),await this.databaseConnection.runAsync("PRAGMA foreign_keys = ON"),this.databaseConnection}}class wc extends yt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ot(this)}async startTransaction(){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(e){throw this.isTransactionActive=!1,e}this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async beforeMigration(){const e=await this.connect();return new Promise((t,n)=>{e.exec([{sql:"PRAGMA foreign_keys = OFF",args:[]}],!1,i=>i?n(i):t())})}async afterMigration(){const e=await this.connect();return new Promise((t,n)=>{e.exec([{sql:"PRAGMA foreign_keys = ON",args:[]}],!1,i=>i?n(i):t())})}async query(e,t,n=!1){if(this.isReleased)throw new Be;return new Promise(async(i,r)=>{const s=await this.connect(),a=new Ge;this.driver.connection.logger.logQuery(e,t,this),this.broadcaster.broadcastBeforeQueryEvent(a,e,t);const o=Date.now();s.transaction(async c=>{typeof this.transaction>"u"&&(await this.startTransaction(),this.transaction=c),this.transaction.executeSql(e,t,async(u,l)=>{const h=this.driver.options.maxQueryExecutionTime,y=Date.now()-o;this.broadcaster.broadcastAfterQueryEvent(a,e,t,!0,y,l,void 0),await a.wait(),h&&y>h&&this.driver.connection.logger.logQuerySlow(y,e,t,this);const g=new it;if(l?.hasOwnProperty("rowsAffected")&&(g.affected=l.rowsAffected),l?.hasOwnProperty("rows")){const b=[];for(let R=0;R<l.rows.length;R++)b.push(l.rows.item(R));g.raw=b,g.records=b}e.startsWith("INSERT INTO")&&(g.raw=l.insertId),i(n?g:g.raw)},async(u,l)=>{this.driver.connection.logger.logQueryError(l,e,t,this),this.broadcaster.broadcastAfterQueryEvent(a,e,t,!1,void 0,void 0,l),await a.wait(),r(new et(e,t,l))})},async c=>{await this.rollbackTransaction(),r(c)},()=>{this.isTransactionActive=!1,this.transaction=void 0})})}}class Nc extends Nt{constructor(e){super(e),this.database=this.options.database,this.sqlite=this.options.driver}async disconnect(){return new Promise((e,t)=>{try{this.queryRunner=void 0,this.databaseConnection._db.close(),this.databaseConnection=void 0,e()}catch(n){t(n)}})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new wc(this)),this.queryRunner}createDatabaseConnection(){return new Promise((e,t)=>{try{const n=this.sqlite.openDatabase(this.options.database);n.transaction(i=>{i.executeSql("PRAGMA foreign_keys = ON",[],(r,s)=>{e(n)},(r,s)=>{t({transaction:r,error:s})})},i=>{t(i)})}catch(n){t(n)}})}}class Ac{constructor(e){this.connection=e}create(){return this.isLegacyDriver?new Nc(this.connection):new bc(this.connection)}get isLegacyDriver(){return!("openDatabaseAsync"in this.connection.options.driver)}}class Cc extends Zt{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.client=t,this.broadcaster=new ot(this)}async connect(){return{}}release(){return this.isReleased=!0,this.databaseConnection&&this.databaseConnection.release(),Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new Be;const i=await this.client.query(e,t),r=new it;return r.raw=i,i?.hasOwnProperty("records")&&Array.isArray(i.records)&&(r.records=i.records),i?.hasOwnProperty("numberOfRecordsUpdated")&&(r.affected=i.numberOfRecordsUpdated),n?r:r.raw}stream(e,t,n,i){if(this.isReleased)throw new Be;return new Promise(async(r,s)=>{try{const o=(await this.connect()).query(e,t);n&&o.on("end",n),i&&o.on("error",i),r(o)}catch(a){s(a)}})}async getDatabases(){return Promise.resolve([])}async getSchemas(e){throw new C("MySql driver does not support table schemas")}async hasDatabase(e){return!!(await this.query(`SELECT * FROM \`INFORMATION_SCHEMA\`.\`SCHEMATA\` WHERE \`SCHEMA_NAME\` = '${e}'`)).length}async getCurrentDatabase(){return(await this.query("SELECT DATABASE() AS `db_name`"))[0].db_name}async hasSchema(e){throw new C("MySql driver does not support table schemas")}async getCurrentSchema(){return(await this.query("SELECT SCHEMA() AS `schema_name`"))[0].schema_name}async hasTable(e){const t=this.driver.parseTableName(e),n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${t.database}' AND \`TABLE_NAME\` = '${t.tableName}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=this.driver.parseTableName(e),i=v.isTableColumn(t)?t.name:t,r=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${n.database}' AND \`TABLE_NAME\` = '${n.tableName}' AND \`COLUMN_NAME\` = '${i}'`;return!!(await this.query(r)).length}async createDatabase(e,t){const n=t?`CREATE DATABASE IF NOT EXISTS \`${e}\``:`CREATE DATABASE \`${e}\``,i=`DROP DATABASE \`${e}\``;await this.executeQueries(new N(n),new N(i))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS \`${e}\``:`DROP DATABASE \`${e}\``,i=`CREATE DATABASE \`${e}\``;await this.executeQueries(new N(n),new N(i))}async createSchema(e,t){throw new C("Schema create queries are not supported by MySql driver.")}async dropSchema(e,t){throw new C("Schema drop queries are not supported by MySql driver.")}async createTable(e,t=!1,n=!0){if(t&&await this.hasTable(e))return Promise.resolve();const i=[],r=[];return i.push(this.createTableSql(e,n)),r.push(this.dropTableSql(e)),e.indices.forEach(s=>r.push(this.dropIndexSql(e,s))),n&&e.foreignKeys.forEach(s=>r.push(this.dropForeignKeySql(e,s))),this.executeQueries(i,r)}async dropTable(e,t,n=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const i=n,r=this.getTablePath(e),s=await this.getCachedTable(r),a=[],o=[];n&&s.foreignKeys.forEach(c=>a.push(this.dropForeignKeySql(s,c))),s.indices.forEach(c=>a.push(this.dropIndexSql(s,c))),a.push(this.dropTableSql(s)),o.push(this.createTableSql(s,i)),await this.executeQueries(a,o)}async createView(e,t=!1){const n=[],i=[];n.push(this.createViewSql(e)),t&&n.push(await this.insertViewDefinitionSql(e)),i.push(this.dropViewSql(e)),t&&i.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(n,i)}async dropView(e){const t=v.isView(e)?e.name:e,n=await this.getCachedView(t),i=[],r=[];i.push(await this.deleteViewDefinitionSql(n)),i.push(this.dropViewSql(n)),r.push(await this.insertViewDefinitionSql(n)),r.push(this.createViewSql(n)),await this.executeQueries(i,r)}async renameTable(e,t){const n=[],i=[],r=v.isTable(e)?e:await this.getCachedTable(e),s=r.clone(),{database:a}=this.driver.parseTableName(r);s.name=a?`${a}.${t}`:t,n.push(new N(`RENAME TABLE ${this.escapePath(r)} TO ${this.escapePath(s)}`)),i.push(new N(`RENAME TABLE ${this.escapePath(s)} TO ${this.escapePath(r)}`)),s.indices.forEach(o=>{const c=o.columnNames.map(h=>`\`${h}\``).join(", "),u=this.connection.namingStrategy.indexName(s,o.columnNames,o.where);let l="";o.isUnique&&(l+="UNIQUE "),o.isSpatial&&(l+="SPATIAL "),o.isFulltext&&(l+="FULLTEXT "),n.push(new N(`ALTER TABLE ${this.escapePath(s)} DROP INDEX \`${o.name}\`, ADD ${l}INDEX \`${u}\` (${c})`)),i.push(new N(`ALTER TABLE ${this.escapePath(s)} DROP INDEX \`${u}\`, ADD ${l}INDEX \`${o.name}\` (${c})`)),o.name=u}),s.foreignKeys.forEach(o=>{const c=o.columnNames.map(y=>`\`${y}\``).join(", "),u=o.referencedColumnNames.map(y=>`\`${y}\``).join(","),l=this.connection.namingStrategy.foreignKeyName(s,o.columnNames);let h=`ALTER TABLE ${this.escapePath(s)} DROP FOREIGN KEY \`${o.name}\`, ADD CONSTRAINT \`${l}\` FOREIGN KEY (${c}) REFERENCES ${this.escapePath(this.getTablePath(o))}(${u})`;o.onDelete&&(h+=` ON DELETE ${o.onDelete}`),o.onUpdate&&(h+=` ON UPDATE ${o.onUpdate}`);let m=`ALTER TABLE ${this.escapePath(s)} DROP FOREIGN KEY \`${l}\`, ADD CONSTRAINT \`${o.name}\` FOREIGN KEY (${c}) REFERENCES ${this.escapePath(this.getTablePath(o))}(${u})`;o.onDelete&&(m+=` ON DELETE ${o.onDelete}`),o.onUpdate&&(m+=` ON UPDATE ${o.onUpdate}`),n.push(new N(h)),i.push(new N(m)),o.name=l}),await this.executeQueries(n,i),r.name=s.name,this.replaceCachedTable(r,s)}async addColumn(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=[],s=[],a=i.primaryColumns.length>0;if(r.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(t,a,!1)}`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN \`${t.name}\``)),t.isPrimary&&a){const c=i.columns.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(c){const h=c.clone();h.isGenerated=!1,h.generationStrategy=void 0,r.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(h,!0)}`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(t,!0)}`))}const u=i.primaryColumns;let l=u.map(h=>`\`${h.name}\``).join(", ");if(r.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${l})`)),u.push(t),l=u.map(h=>`\`${h.name}\``).join(", "),r.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${l})`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),c){const h=c.clone();h.isGenerated=!1,h.generationStrategy=void 0,r.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(t,!0)}`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(h,!0)}`))}}const o=i.indices.find(c=>c.columnNames.length===1&&c.columnNames[0]===t.name);if(o)r.push(this.createIndexSql(n,o)),s.push(this.dropIndexSql(n,o));else if(t.isUnique){const c=new Pe({name:this.connection.namingStrategy.indexName(n,[t.name]),columnNames:[t.name],isUnique:!0});i.indices.push(c),i.uniques.push(new Le({name:c.name,columnNames:c.columnNames})),r.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${c.name}\` (\`${t.name}\`)`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${c.name}\``))}await this.executeQueries(r,s),i.addColumn(t),this.replaceCachedTable(n,i)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const i=v.isTable(e)?e:await this.getCachedTable(e),r=v.isTableColumn(t)?t:i.columns.find(a=>a.name===t);if(!r)throw new C(`Column "${t}" was not found in the "${i.name}" table.`);let s;v.isTableColumn(n)?s=n:(s=r.clone(),s.name=n),await this.changeColumn(i,r,s)}async changeColumn(e,t,n){const i=v.isTable(e)?e:await this.getCachedTable(e);let r=i.clone();const s=[],a=[],o=v.isTableColumn(t)?t:i.columns.find(c=>c.name===t);if(!o)throw new C(`Column "${t}" was not found in the "${i.name}" table.`);if(n.isGenerated!==o.isGenerated&&n.generationStrategy!=="uuid"||o.type!==n.type||o.length!==n.length||o.generatedType!==n.generatedType)await this.dropColumn(i,o),await this.addColumn(i,n),r=i.clone();else{if(n.name!==o.name){s.push(new N(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${o.name}\` \`${n.name}\` ${this.buildCreateColumnSql(o,!0,!0)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${n.name}\` \`${o.name}\` ${this.buildCreateColumnSql(o,!0,!0)}`)),r.findColumnIndices(o).forEach(u=>{u.columnNames.splice(u.columnNames.indexOf(o.name),1),u.columnNames.push(n.name);const l=u.columnNames.map(y=>`\`${y}\``).join(", "),h=this.connection.namingStrategy.indexName(r,u.columnNames,u.where);let m="";u.isUnique&&(m+="UNIQUE "),u.isSpatial&&(m+="SPATIAL "),u.isFulltext&&(m+="FULLTEXT "),s.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP INDEX \`${u.name}\`, ADD ${m}INDEX \`${h}\` (${l})`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP INDEX \`${h}\`, ADD ${m}INDEX \`${u.name}\` (${l})`)),u.name=h}),r.findColumnForeignKeys(o).forEach(u=>{u.columnNames.splice(u.columnNames.indexOf(o.name),1),u.columnNames.push(n.name);const l=u.columnNames.map(b=>`\`${b}\``).join(", "),h=u.referencedColumnNames.map(b=>`\`${b}\``).join(","),m=this.connection.namingStrategy.foreignKeyName(r,u.columnNames);let y=`ALTER TABLE ${this.escapePath(i)} DROP FOREIGN KEY \`${u.name}\`, ADD CONSTRAINT \`${m}\` FOREIGN KEY (${l}) REFERENCES ${this.escapePath(this.getTablePath(u))}(${h})`;u.onDelete&&(y+=` ON DELETE ${u.onDelete}`),u.onUpdate&&(y+=` ON UPDATE ${u.onUpdate}`);let g=`ALTER TABLE ${this.escapePath(i)} DROP FOREIGN KEY \`${m}\`, ADD CONSTRAINT \`${u.name}\` FOREIGN KEY (${l}) REFERENCES ${this.escapePath(this.getTablePath(u))}(${h})`;u.onDelete&&(g+=` ON DELETE ${u.onDelete}`),u.onUpdate&&(g+=` ON UPDATE ${u.onUpdate}`),s.push(new N(y)),a.push(new N(g)),u.name=m});const c=r.columns.find(u=>u.name===o.name);r.columns[r.columns.indexOf(c)].name=n.name,o.name=n.name}if(this.isColumnChanged(o,n,!0)&&(s.push(new N(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${o.name}\` ${this.buildCreateColumnSql(n,!0)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${n.name}\` ${this.buildCreateColumnSql(o,!0)}`))),n.isPrimary!==o.isPrimary){const c=r.columns.find(l=>l.isGenerated&&l.generationStrategy==="increment");if(c){const l=c.clone();l.isGenerated=!1,l.generationStrategy=void 0,s.push(new N(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(l,!0)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(c,!0)}`))}const u=r.primaryColumns;if(u.length>0){const l=u.map(h=>`\`${h.name}\``).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${l})`))}if(n.isPrimary===!0){u.push(n);const l=r.columns.find(m=>m.name===n.name);l.isPrimary=!0;const h=u.map(m=>`\`${m.name}\``).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${h})`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`))}else{const l=u.find(m=>m.name===n.name);u.splice(u.indexOf(l),1);const h=r.columns.find(m=>m.name===n.name);if(h.isPrimary=!1,u.length>0){const m=u.map(y=>`\`${y.name}\``).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${m})`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`))}}if(c){const l=c.clone();l.isGenerated=!1,l.generationStrategy=void 0,s.push(new N(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(c,!0)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(l,!0)}`))}}if(n.isUnique!==o.isUnique)if(n.isUnique===!0){const c=new Pe({name:this.connection.namingStrategy.indexName(i,[n.name]),columnNames:[n.name],isUnique:!0});r.indices.push(c),r.uniques.push(new Le({name:c.name,columnNames:c.columnNames})),s.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD UNIQUE INDEX \`${c.name}\` (\`${n.name}\`)`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP INDEX \`${c.name}\``))}else{const c=r.indices.find(l=>l.columnNames.length===1&&l.isUnique===!0&&!!l.columnNames.find(h=>h===n.name));r.indices.splice(r.indices.indexOf(c),1);const u=r.uniques.find(l=>l.name===c.name);r.uniques.splice(r.uniques.indexOf(u),1),s.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP INDEX \`${c.name}\``)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD UNIQUE INDEX \`${c.name}\` (\`${n.name}\`)`))}}await this.executeQueries(s,a),this.replaceCachedTable(i,r)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:i}of t)await this.changeColumn(e,n,i)}async dropColumn(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableColumn(t)?t:n.findColumnByName(t);if(!i)throw new C(`Column "${t}" was not found in table "${n.name}"`);const r=n.clone(),s=[],a=[];if(i.isPrimary){const c=r.columns.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(c){const h=c.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(h,!0)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(c,!0)}`))}const u=r.primaryColumns.map(h=>`\`${h.name}\``).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`)),a.push(new N(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${u})`));const l=r.findColumnByName(i.name);if(l.isPrimary=!1,r.primaryColumns.length>0){const h=r.primaryColumns.map(m=>`\`${m.name}\``).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${h})`)),a.push(new N(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`))}if(c&&c.name!==i.name){const h=c.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(c,!0)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(h,!0)}`))}}const o=r.indices.find(c=>c.columnNames.length===1&&c.columnNames[0]===i.name);if(o)r.indices.splice(r.indices.indexOf(o),1),s.push(this.dropIndexSql(n,o)),a.push(this.createIndexSql(n,o));else if(i.isUnique){const c=this.connection.namingStrategy.uniqueConstraintName(n,[i.name]),u=r.uniques.find(m=>m.name===c);u&&r.uniques.splice(r.uniques.indexOf(u),1);const l=this.connection.namingStrategy.indexName(n,[i.name]),h=r.indices.find(m=>m.name===l);h&&r.indices.splice(r.indices.indexOf(h),1),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${l}\``)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${l}\` (\`${i.name}\`)`))}s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN \`${i.name}\``)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(i,!0)}`)),await this.executeQueries(s,a),r.removeColumn(i),this.replaceCachedTable(n,r)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=this.createPrimaryKeySql(n,t),s=this.dropPrimaryKeySql(n);await this.executeQueries(r,s),i.columns.forEach(a=>{t.find(o=>o===a.name)&&(a.isPrimary=!0)}),this.replaceCachedTable(n,i)}async updatePrimaryKeys(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=t.map(h=>h.name),s=[],a=[],o=i.columns.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(o){const h=o.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${o.name}\` ${this.buildCreateColumnSql(h,!0)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(o,!0)}`))}const c=i.primaryColumns;if(c.length>0){const h=c.map(m=>`\`${m.name}\``).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${h})`))}i.columns.filter(h=>r.indexOf(h.name)!==-1).forEach(h=>h.isPrimary=!0);const u=r.map(h=>`\`${h}\``).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${u})`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`));const l=o||t.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(l){const h=l.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(l,!0)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(h,!0)}`));const m=i.columns.find(y=>y.name===l.name);m.isGenerated=!0,m.generationStrategy="increment"}await this.executeQueries(s,a),this.replaceCachedTable(n,i)}async dropPrimaryKey(e){const t=v.isTable(e)?e:await this.getCachedTable(e),n=this.dropPrimaryKeySql(t),i=this.createPrimaryKeySql(t,t.primaryColumns.map(r=>r.name));await this.executeQueries(n,i),t.primaryColumns.forEach(r=>{r.isPrimary=!1})}async createUniqueConstraint(e,t){throw new C("MySql does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new C("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new C("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new C("MySql does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){throw new C("MySql does not support check constraints.")}async createCheckConstraints(e,t){throw new C("MySql does not support check constraints.")}async dropCheckConstraint(e,t){throw new C("MySql does not support check constraints.")}async dropCheckConstraints(e,t){throw new C("MySql does not support check constraints.")}async createExclusionConstraint(e,t){throw new C("MySql does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new C("MySql does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new C("MySql does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new C("MySql does not support exclusion constraints.")}async createForeignKey(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames));const i=this.createForeignKeySql(n,t),r=this.dropForeignKeySql(n,t);await this.executeQueries(i,r),n.addForeignKey(t)}async createForeignKeys(e,t){const n=t.map(i=>this.createForeignKey(e,i));await Promise.all(n)}async dropForeignKey(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableForeignKey(t)?t:n.foreignKeys.find(a=>a.name===t);if(!i)throw new C(`Supplied foreign key was not found in table ${n.name}`);const r=this.dropForeignKeySql(n,i),s=this.createForeignKeySql(n,i);await this.executeQueries(r,s),n.removeForeignKey(i)}async dropForeignKeys(e,t){const n=t.map(i=>this.dropForeignKey(e,i));await Promise.all(n)}async createIndex(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createIndexSql(n,t),r=this.dropIndexSql(n,t);await this.executeQueries(i,r),n.addIndex(t,!0)}async createIndices(e,t){const n=t.map(i=>this.createIndex(e,i));await Promise.all(n)}async dropIndex(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableIndex(t)?t:n.indices.find(a=>a.name===t);if(!i)throw new C(`Supplied index ${t} was not found in table ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(n,i),s=this.createIndexSql(n,i);await this.executeQueries(r,s),n.removeIndex(i,!0)}async dropIndices(e,t){const n=t.map(i=>this.dropIndex(e,i));await Promise.all(n)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(e){const t=e||this.driver.database;if(t){if(!await this.hasDatabase(t))return Promise.resolve()}else throw new C("Can not clear database. No database is specified");const n=this.isTransactionActive;n||await this.startTransaction();try{const i=`SELECT concat('DROP VIEW IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`VIEWS\` WHERE \`TABLE_SCHEMA\` = '${t}'`,r=await this.query(i);await Promise.all(r.map(u=>this.query(u.query)));const s="SET FOREIGN_KEY_CHECKS = 0;",a=`SELECT concat('DROP TABLE IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_SCHEMA\` = '${t}'`,o="SET FOREIGN_KEY_CHECKS = 1;";await this.query(s);const c=await this.query(a);await Promise.all(c.map(u=>this.query(u.query))),await this.query(o),n||await this.commitTransaction()}catch(i){try{n||await this.rollbackTransaction()}catch{}throw i}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=await this.getCurrentDatabase(),i=e.map(a=>{let{database:o,tableName:c}=this.driver.parseTableName(a);return o||(o=n),`(\`t\`.\`schema\` = '${o}' AND \`t\`.\`name\` = '${c}')`}).join(" OR "),r=`SELECT \`t\`.*, \`v\`.\`check_option\` FROM ${this.escapePath(this.getTypeormMetadataTableName())} \`t\` INNER JOIN \`information_schema\`.\`views\` \`v\` ON \`v\`.\`table_schema\` = \`t\`.\`schema\` AND \`v\`.\`table_name\` = \`t\`.\`name\` WHERE \`t\`.\`type\` = '${se.VIEW}' ${i?`AND (${i})`:""}`;return(await this.query(r)).map(a=>{const o=new lt,c=a.schema===n?void 0:a.schema;return o.database=a.schema,o.name=this.driver.buildTableName(a.name,void 0,c),o.expression=a.value,o})}async loadTables(e){if(e&&e.length===0)return[];const t=[],n=await this.getCurrentDatabase();if(!e)t.push(...await this.query("SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES`"));else{const P="SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES` WHERE "+e.map(M=>{let[U,F]=M.split(".");return F||(F=U,U=this.driver.database||n),`(\`TABLE_SCHEMA\` = '${U}' AND \`TABLE_NAME\` = '${F}')`}).join(" OR ");t.push(...await this.query(P))}if(t.length===0)return[];const i=t.map(({TABLE_NAME:R,TABLE_SCHEMA:P})=>`(\`TABLE_SCHEMA\` = '${P}' AND \`TABLE_NAME\` = '${R}')`).join(" OR "),r="SELECT * FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE "+i,s=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` WHERE \`CONSTRAINT_NAME\` = 'PRIMARY' AND (${i})`,a="SELECT `SCHEMA_NAME`, `DEFAULT_CHARACTER_SET_NAME` as `CHARSET`, `DEFAULT_COLLATION_NAME` AS `COLLATION` FROM `INFORMATION_SCHEMA`.`SCHEMATA`",c=`SELECT \`s\`.* FROM \`INFORMATION_SCHEMA\`.\`STATISTICS\` \`s\` LEFT JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`rc\` ON \`s\`.\`INDEX_NAME\` = \`rc\`.\`CONSTRAINT_NAME\` WHERE (${t.map(({TABLE_NAME:R,TABLE_SCHEMA:P})=>`(\`s\`.\`TABLE_SCHEMA\` = '${P}' AND \`s\`.\`TABLE_NAME\` = '${R}')`).join(" OR ")}) AND \`s\`.\`INDEX_NAME\` != 'PRIMARY' AND \`rc\`.\`CONSTRAINT_NAME\` IS NULL`,l="SELECT `kcu`.`TABLE_SCHEMA`, `kcu`.`TABLE_NAME`, `kcu`.`CONSTRAINT_NAME`, `kcu`.`COLUMN_NAME`, `kcu`.`REFERENCED_TABLE_SCHEMA`, `kcu`.`REFERENCED_TABLE_NAME`, `kcu`.`REFERENCED_COLUMN_NAME`, `rc`.`DELETE_RULE` `ON_DELETE`, `rc`.`UPDATE_RULE` `ON_UPDATE` FROM `INFORMATION_SCHEMA`.`KEY_COLUMN_USAGE` `kcu` INNER JOIN `INFORMATION_SCHEMA`.`REFERENTIAL_CONSTRAINTS` `rc` ON `rc`.`constraint_name` = `kcu`.`constraint_name` WHERE "+t.map(({TABLE_NAME:R,TABLE_SCHEMA:P})=>`(\`kcu\`.\`TABLE_SCHEMA\` = '${P}' AND \`kcu\`.\`TABLE_NAME\` = '${R}')`).join(" OR "),[h,m,y,g,b]=await Promise.all([this.query(r),this.query(s),this.query(a),this.query(c),this.query(l)]);return t.map(R=>{const P=new Se,M=y.find($=>$.SCHEMA_NAME===R.TABLE_SCHEMA),U=M.COLLATION,F=M.CHARSET,J=R.TABLE_SCHEMA===n?void 0:R.TABLE_SCHEMA;P.database=R.TABLE_SCHEMA,P.name=this.driver.buildTableName(R.TABLE_NAME,void 0,J),P.columns=h.filter($=>$.TABLE_NAME===R.TABLE_NAME&&$.TABLE_SCHEMA===R.TABLE_SCHEMA).map($=>{const Y=g.filter(q=>q.TABLE_NAME===R.TABLE_NAME&&q.TABLE_SCHEMA===R.TABLE_SCHEMA&&q.COLUMN_NAME===$.COLUMN_NAME&&parseInt(q.NON_UNIQUE,10)===0),S=this.connection.entityMetadatas.find(q=>this.getTablePath(P)===this.getTablePath(q)),V=Y.length>0&&S&&S.indices.some(q=>Y.some(_=>q.name===_.INDEX_NAME&&q.synchronize===!1)),L=Y.every(q=>g.some(_=>_.INDEX_NAME===q.INDEX_NAME&&_.COLUMN_NAME!==$.COLUMN_NAME)),D=new Fe;if(D.name=$.COLUMN_NAME,D.type=$.DATA_TYPE.toLowerCase(),D.zerofill=$.COLUMN_TYPE.includes("zerofill"),D.unsigned=D.zerofill||$.COLUMN_TYPE.includes("unsigned"),this.driver.unsignedColumnTypes.includes(D.type)){const q=$.COLUMN_TYPE.substring($.COLUMN_TYPE.indexOf("(")+1,$.COLUMN_TYPE.indexOf(")"));D.width=q&&!this.isDefaultColumnWidth(P,D,parseInt(q))?parseInt(q):void 0}if($.COLUMN_DEFAULT===null||$.COLUMN_DEFAULT===void 0?D.default=void 0:D.default=$.COLUMN_DEFAULT==="CURRENT_TIMESTAMP"?$.COLUMN_DEFAULT:`'${$.COLUMN_DEFAULT}'`,$.EXTRA.indexOf("on update")!==-1&&(D.onUpdate=$.EXTRA.substring($.EXTRA.indexOf("on update")+10)),$.GENERATION_EXPRESSION&&(D.asExpression=$.GENERATION_EXPRESSION,D.generatedType=$.EXTRA.indexOf("VIRTUAL")!==-1?"VIRTUAL":"STORED"),D.isUnique=Y.length>0&&!V&&!L,D.isNullable=$.IS_NULLABLE==="YES",D.isPrimary=m.some(q=>q.TABLE_NAME===$.TABLE_NAME&&q.TABLE_SCHEMA===$.TABLE_SCHEMA&&q.COLUMN_NAME===$.COLUMN_NAME),D.zerofill=$.COLUMN_TYPE.indexOf("zerofill")!==-1,D.isGenerated=$.EXTRA.indexOf("auto_increment")!==-1,D.isGenerated&&(D.generationStrategy="increment"),D.comment=typeof $.COLUMN_COMMENT=="string"&&$.COLUMN_COMMENT.length===0?void 0:$.COLUMN_COMMENT,$.CHARACTER_SET_NAME&&(D.charset=$.CHARACTER_SET_NAME===F?void 0:$.CHARACTER_SET_NAME),$.COLLATION_NAME&&(D.collation=$.COLLATION_NAME===U?void 0:$.COLLATION_NAME),this.driver.withLengthColumnTypes.indexOf(D.type)!==-1&&$.CHARACTER_MAXIMUM_LENGTH){const q=$.CHARACTER_MAXIMUM_LENGTH.toString();D.length=this.isDefaultColumnLength(P,D,q)?"":q}if((D.type==="decimal"||D.type==="double"||D.type==="float")&&($.NUMERIC_PRECISION!==null&&!this.isDefaultColumnPrecision(P,D,$.NUMERIC_PRECISION)&&(D.precision=parseInt($.NUMERIC_PRECISION)),$.NUMERIC_SCALE!==null&&!this.isDefaultColumnScale(P,D,$.NUMERIC_SCALE)&&(D.scale=parseInt($.NUMERIC_SCALE))),D.type==="enum"||D.type==="simple-enum"||D.type==="set"){const q=$.COLUMN_TYPE,_=q.substring(q.indexOf("(")+1,q.lastIndexOf(")")).split(",");D.enum=_.map(I=>I.substring(1,I.length-1)),D.length=""}return(D.type==="datetime"||D.type==="time"||D.type==="timestamp")&&$.DATETIME_PRECISION!==null&&$.DATETIME_PRECISION!==void 0&&!this.isDefaultColumnPrecision(P,D,parseInt($.DATETIME_PRECISION))&&(D.precision=parseInt($.DATETIME_PRECISION)),D});const K=Q.uniq(b.filter($=>$.TABLE_NAME===R.TABLE_NAME&&$.TABLE_SCHEMA===R.TABLE_SCHEMA),$=>$.CONSTRAINT_NAME);P.foreignKeys=K.map($=>{const Y=b.filter(L=>L.CONSTRAINT_NAME===$.CONSTRAINT_NAME),S=$.REFERENCED_TABLE_SCHEMA===n?void 0:$.REFERENCED_TABLE_SCHEMA,V=this.driver.buildTableName($.REFERENCED_TABLE_NAME,void 0,S);return new We({name:$.CONSTRAINT_NAME,columnNames:Y.map(L=>L.COLUMN_NAME),referencedDatabase:$.REFERENCED_TABLE_SCHEMA,referencedTableName:V,referencedColumnNames:Y.map(L=>L.REFERENCED_COLUMN_NAME),onDelete:$.ON_DELETE,onUpdate:$.ON_UPDATE})});const re=Q.uniq(g.filter($=>$.TABLE_NAME===R.TABLE_NAME&&$.TABLE_SCHEMA===R.TABLE_SCHEMA),$=>$.INDEX_NAME);return P.indices=re.map($=>{const Y=g.filter(V=>V.TABLE_SCHEMA===$.TABLE_SCHEMA&&V.TABLE_NAME===$.TABLE_NAME&&V.INDEX_NAME===$.INDEX_NAME),S=parseInt($.NON_UNIQUE,10);return new Pe({table:P,name:$.INDEX_NAME,columnNames:Y.map(V=>V.COLUMN_NAME),isUnique:S===0,isSpatial:$.INDEX_TYPE==="SPATIAL",isFulltext:$.INDEX_TYPE==="FULLTEXT"})}),P})}createTableSql(e,t){const n=e.columns.map(r=>this.buildCreateColumnSql(r,!0)).join(", ");let i=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(r=>r.isUnique).forEach(r=>{const s=e.indices.some(o=>o.columnNames.length===1&&!!o.isUnique&&o.columnNames.indexOf(r.name)!==-1),a=e.uniques.some(o=>o.columnNames.length===1&&o.columnNames.indexOf(r.name)!==-1);!s&&!a&&e.indices.push(new Pe({name:this.connection.namingStrategy.uniqueConstraintName(e,[r.name]),columnNames:[r.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(r=>{e.indices.some(a=>a.name===r.name)||e.indices.push(new Pe({name:r.name,columnNames:r.columnNames,isUnique:!0}))}),e.indices.length>0){const r=e.indices.map(s=>{const a=s.columnNames.map(c=>`\`${c}\``).join(", ");s.name||(s.name=this.connection.namingStrategy.indexName(e,s.columnNames,s.where));let o="";return s.isUnique&&(o+="UNIQUE "),s.isSpatial&&(o+="SPATIAL "),s.isFulltext&&(o+="FULLTEXT "),`${o}INDEX \`${s.name}\` (${a})`}).join(", ");i+=`, ${r}`}if(e.foreignKeys.length>0&&t){const r=e.foreignKeys.map(s=>{const a=s.columnNames.map(u=>`\`${u}\``).join(", ");s.name||(s.name=this.connection.namingStrategy.foreignKeyName(e,s.columnNames));const o=s.referencedColumnNames.map(u=>`\`${u}\``).join(", ");let c=`CONSTRAINT \`${s.name}\` FOREIGN KEY (${a}) REFERENCES ${this.escapePath(this.getTablePath(s))} (${o})`;return s.onDelete&&(c+=` ON DELETE ${s.onDelete}`),s.onUpdate&&(c+=` ON UPDATE ${s.onUpdate}`),c}).join(", ");i+=`, ${r}`}if(e.primaryColumns.length>0){const r=e.primaryColumns.map(s=>`\`${s.name}\``).join(", ");i+=`, PRIMARY KEY (${r})`}return i+=`) ENGINE=${e.engine||"InnoDB"}`,new N(i)}dropTableSql(e){return new N(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){return typeof e.expression=="string"?new N(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression}`):new N(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){const t=await this.getCurrentDatabase(),n=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:se.VIEW,schema:t,name:e.name,value:n})}dropViewSql(e){return new N(`DROP VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const t=await this.getCurrentDatabase(),n=v.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:se.VIEW,schema:t,name:n})}createIndexSql(e,t){const n=t.columnNames.map(r=>`\`${r}\``).join(", ");let i="";return t.isUnique&&(i+="UNIQUE "),t.isSpatial&&(i+="SPATIAL "),t.isFulltext&&(i+="FULLTEXT "),new N(`CREATE ${i}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${n})`)}dropIndexSql(e,t){const n=v.isTableIndex(t)?t.name:t;return new N(`DROP INDEX \`${n}\` ON ${this.escapePath(e)}`)}createPrimaryKeySql(e,t){const n=t.map(i=>`\`${i}\``).join(", ");return new N(`ALTER TABLE ${this.escapePath(e)} ADD PRIMARY KEY (${n})`)}dropPrimaryKeySql(e){return new N(`ALTER TABLE ${this.escapePath(e)} DROP PRIMARY KEY`)}createForeignKeySql(e,t){const n=t.columnNames.map(s=>`\`${s}\``).join(", "),i=t.referencedColumnNames.map(s=>`\`${s}\``).join(",");let r=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${i})`;return t.onDelete&&(r+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(r+=` ON UPDATE ${t.onUpdate}`),new N(r)}dropForeignKeySql(e,t){const n=v.isTableForeignKey(t)?t.name:t;return new N(`ALTER TABLE ${this.escapePath(e)} DROP FOREIGN KEY \`${n}\``)}escapeComment(e){return!e||e.length===0?"''":(e=e.replace(/\\/g,"\\\\").replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){const{database:t,tableName:n}=this.driver.parseTableName(e);return t&&t!==this.driver.database?`\`${t}\`.\`${n}\``:`\`${n}\``}buildCreateColumnSql(e,t,n=!1){let i="";return n?i=this.connection.driver.createFullType(e):i=`\`${e.name}\` ${this.connection.driver.createFullType(e)}`,e.asExpression&&(i+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`),e.zerofill?i+=" ZEROFILL":e.unsigned&&(i+=" UNSIGNED"),e.enum&&(i+=` (${e.enum.map(r=>"'"+r+"'").join(", ")})`),e.charset&&(i+=` CHARACTER SET "${e.charset}"`),e.collation&&(i+=` COLLATE "${e.collation}"`),e.isNullable||(i+=" NOT NULL"),e.isNullable&&(i+=" NULL"),e.isPrimary&&!t&&(i+=" PRIMARY KEY"),e.isGenerated&&e.generationStrategy==="increment"&&(i+=" AUTO_INCREMENT"),e.comment&&(i+=` COMMENT ${this.escapeComment(e.comment)}`),e.default!==void 0&&e.default!==null&&(i+=` DEFAULT ${e.default}`),e.onUpdate&&(i+=` ON UPDATE ${e.onUpdate}`),i}isDefaultColumnWidth(e,t,n){if(this.connection.hasMetadata(e.name)){const s=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(s&&s.width)return!1}const i=this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].width;if(i){const s=["int","tinyint","smallint","mediumint"].indexOf(t.type)!==-1;return t.unsigned&&s?i-1===n:i===n}return!1}changeTableComment(e,t){throw new C("aurora-mysql driver does not support change table comment.")}}class Sc{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["bit","int","integer","tinyint","smallint","mediumint","bigint","float","double","double precision","real","decimal","dec","numeric","fixed","bool","boolean","date","datetime","timestamp","time","year","char","nchar","national char","varchar","nvarchar","national varchar","blob","text","tinyblob","tinytext","mediumblob","mediumtext","longblob","longtext","enum","set","binary","varbinary","json","geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.supportedUpsertTypes=["on-duplicate-key-update"],this.spatialTypes=["geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.withLengthColumnTypes=["char","varchar","nvarchar","binary","varbinary"],this.unsignedColumnTypes=["tinyint","smallint","mediumint","int","integer","bigint"],this.withPrecisionColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real","time","datetime","timestamp"],this.withScaleColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real"],this.mappedDataTypes={createDate:"datetime",createDatePrecision:6,createDateDefault:"CURRENT_TIMESTAMP(6)",updateDate:"datetime",updateDatePrecision:6,updateDateDefault:"CURRENT_TIMESTAMP(6)",deleteDate:"datetime",deleteDatePrecision:6,deleteDateNullable:!0,version:"int",treeLevel:"int",migrationId:"int",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.dataTypeDefaults={varchar:{length:255},nvarchar:{length:255},"national varchar":{length:255},char:{length:1},binary:{length:1},varbinary:{length:255},decimal:{precision:10,scale:0},dec:{precision:10,scale:0},numeric:{precision:10,scale:0},fixed:{precision:10,scale:0},float:{precision:12},double:{precision:22},time:{precision:0},datetime:{precision:0},timestamp:{precision:0},bit:{width:1},int:{width:11},integer:{width:11},tinyint:{width:4},smallint:{width:6},mediumint:{width:9},bigint:{width:20}},this.maxAliasLength=63,this.cteCapabilities={enabled:!1},this.connection=e,this.options=e.options,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),this.database=k.buildDriverOptions(this.options).database}async connect(){if(!this.database){const e=this.createQueryRunner("master");this.database=await e.getCurrentDatabase(),await e.release()}}afterConnect(){return Promise.resolve()}async disconnect(){}createSchemaBuilder(){return new Xt(this.connection)}createQueryRunner(e){return new Cc(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions))}escapeQueryWithParameters(e,t,n){const i=Object.keys(n).map(r=>n[r]);return!t||!Object.keys(t).length?[e,i]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(r,s,a)=>{if(!t.hasOwnProperty(a))return r;const o=t[a];return s?o.map(c=>(i.push(c),this.createParameter(a,i.length-1))).join(", "):typeof o=="function"?o():(i.push(o),this.createParameter(a,i.length-1))}),[e,i])}escape(e){return"`"+e+"`"}buildTableName(e,t,n){const i=[e];return n&&i.unshift(n),i.join(".")}parseTableName(e){const t=this.database,n=void 0;if(v.isTable(e)||v.isView(e)){const r=this.parseTableName(e.name);return{database:e.database||r.database||t,schema:e.schema||r.schema||n,tableName:r.tableName}}if(v.isTableForeignKey(e)){const r=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||r.database||t,schema:e.referencedSchema||r.schema||n,tableName:r.tableName}}if(v.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const i=e.split(".");return{database:(i.length>1?i[0]:void 0)||t,schema:n,tableName:i.length>1?i[1]:i[0]}}preparePersistentValue(e,t){return t.transformer&&(e=De.transformTo(t.transformer,e)),!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.preparePersistentValue(e,t):e==null?e:t.type===Boolean?e===!0?1:0:t.type==="date"?ne.mixedDateToDateString(e):t.type==="time"?ne.mixedDateToTimeString(e):t.type==="json"?JSON.stringify(e):t.type==="timestamp"||t.type==="datetime"||t.type===Date?ne.mixedDateToDate(e):t.type==="simple-array"||t.type==="set"?ne.simpleArrayToString(e):t.type==="simple-json"?ne.simpleJsonToString(e):t.type==="enum"||t.type==="simple-enum"?""+e:e}prepareHydratedValue(e,t){return e==null?t.transformer?De.transformFrom(t.transformer,e):e:!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.prepareHydratedValue(e,t):(t.type===Boolean||t.type==="bool"||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?e=ne.normalizeHydratedDate(e):t.type==="date"?e=ne.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type==="time"?e=ne.mixedTimeToString(e):t.type==="simple-array"||t.type==="set"?e=ne.stringToSimpleArray(e):t.type==="simple-json"?e=ne.stringToSimpleJson(e):(t.type==="enum"||t.type==="simple-enum")&&t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0?e=parseInt(e):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=De.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number||e.type==="integer"?"int":e.type===String?"varchar":e.type===Date?"datetime":e.type===Buffer?"blob":e.type===Boolean?"tinyint":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"enum":e.type==="double precision"||e.type==="real"?"double":e.type==="dec"||e.type==="numeric"||e.type==="fixed"?"decimal":e.type==="bool"||e.type==="boolean"?"tinyint":e.type==="nvarchar"||e.type==="national varchar"?"varchar":e.type==="nchar"||e.type==="national char"?"char":e.type||""}normalizeDefault(e){const t=e.default;if(t!==null){if((e.type==="enum"||e.type==="simple-enum")&&t!==void 0)return`'${t}'`;if(e.type==="set"&&t!==void 0)return`'${ne.simpleArrayToString(t)}'`;if(typeof t=="number")return`${t}`;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!==void 0)return`${t}`}}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"varchar":case"nvarchar":case"national varchar":return"255";case"varbinary":return"255";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t+=" array"),t}obtainMasterConnection(){return new Promise((e,t)=>{this.poolCluster?this.poolCluster.getConnection("MASTER",(n,i)=>{n?t(n):e(this.prepareDbConnection(i))}):this.pool?this.pool.getConnection((n,i)=>{n?t(n):e(this.prepareDbConnection(i))}):t(new C("Connection is not established with mysql database"))})}obtainSlaveConnection(){return this.poolCluster?new Promise((e,t)=>{this.poolCluster.getConnection("SLAVE*",(n,i)=>{n?t(n):e(this.prepareDbConnection(i))})}):this.obtainMasterConnection()}createGeneratedMap(e,t,n){const i=e.generatedColumns.reduce((r,s)=>{let a;return s.generationStrategy==="increment"&&t.insertId&&(a=t.insertId+n),Q.mergeDeep(r,s.createValueMap(a))},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{const i=e.find(s=>s.name===n.databaseName);if(!i)return!1;let r=n.length;return!r&&n.generationStrategy==="uuid"&&(r=this.getColumnLength(n)),i.name!==n.databaseName||i.type!==this.normalizeType(n)||i.length!==r||i.width!==n.width||i.precision!==n.precision||i.scale!==n.scale||i.zerofill!==n.zerofill||i.unsigned!==n.unsigned||i.asExpression!==n.asExpression||i.generatedType!==n.generatedType||i.comment!==this.escapeComment(n.comment)||!this.compareDefaultValues(this.normalizeDefault(n),i.default)||i.enum&&n.enum&&!Q.isArraysEqual(i.enum,n.enum.map(s=>s+""))||i.onUpdate!==n.onUpdate||i.isPrimary!==n.isPrimary||i.isNullable!==n.isNullable||i.isUnique!==this.normalizeIsUnique(n)||n.generationStrategy!=="uuid"&&i.isGenerated!==n.isGenerated})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!0}createParameter(e,t){return"?"}loadDependencies(){const e=this.options.driver||Ee.load("typeorm-aurora-data-api-driver");this.DataApiDriver=e,this.DataApiDriver=this.DataApiDriver.default||this.DataApiDriver}createConnectionOptions(e,t){return t=Object.assign({},t,k.buildDriverOptions(t)),Object.assign({},{resourceArn:e.resourceArn,secretArn:e.secretArn,database:e.database,region:e.region,type:e.type},{host:t.host,user:t.username,password:t.password,database:t.database,port:t.port,ssl:e.ssl},e.extra||{})}async createPool(e){return{}}prepareDbConnection(e){const{logger:t}=this.connection;return e.listeners("error").length===0&&e.on("error",n=>t.log("warn",`MySQL connection raised an error. ${n}`)),e}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}}class Rc extends Zt{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new ot(this)}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;const n=i=>this.releasePostgresConnection(i);return this.releaseCallback=i=>{this.databaseConnection.removeListener("error",n),t(i)},this.databaseConnection.on("error",n),this.databaseConnection}):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;const n=i=>this.releasePostgresConnection(i);return this.releaseCallback=i=>{this.databaseConnection.removeListener("error",n),t(i)},this.databaseConnection.on("error",n),this.databaseConnection}),this.databaseConnectionPromise)}async releasePostgresConnection(e){if(this.isReleased)return;this.isReleased=!0,this.releaseCallback&&(this.releaseCallback(e),this.releaseCallback=void 0);const t=this.driver.connectedQueryRunners.indexOf(this);t!==-1&&this.driver.connectedQueryRunners.splice(t,1)}release(){return this.releasePostgresConnection()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(await this.query("START TRANSACTION"),e&&await this.query("SET TRANSACTION ISOLATION LEVEL "+e)):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new Be;const i=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const r=new Ge;try{const s=Date.now(),a=await i.query(e,t),o=this.driver.options.maxQueryExecutionTime,u=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,u,a,void 0),o&&u>o&&this.driver.connection.logger.logQuerySlow(u,e,t,this);const l=new it;if(a){switch(a.hasOwnProperty("rows")&&(l.records=a.rows),a.hasOwnProperty("rowCount")&&(l.affected=a.rowCount),a.command){case"DELETE":case"UPDATE":l.raw=[a.rows,a.rowCount];break;default:l.raw=a.rows}if(!n)return l.raw}return l}catch(s){throw this.driver.connection.logger.logQueryError(s,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,void 0,void 0,s),new et(e,t,s)}finally{await r.wait()}}async stream(e,t,n,i){const r=this.driver.loadStreamDependency();if(this.isReleased)throw new Be;const s=await this.connect();this.driver.connection.logger.logQuery(e,t,this);const a=s.query(new r(e,t));return n&&a.on("end",n),i&&a.on("error",i),a}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return!!(await this.query(`SELECT * FROM pg_database WHERE datname='${e}';`)).length}async getCurrentDatabase(){return(await this.query("SELECT * FROM current_database()"))[0].current_database}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){return(await this.query("SELECT * FROM current_schema()"))[0].current_schema}async hasTable(e){const t=this.driver.parseTableName(e);t.schema||(t.schema=await this.getCurrentSchema());const n=`SELECT * FROM "information_schema"."tables" WHERE "table_schema" = '${t.schema}' AND "table_name" = '${t.tableName}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=this.driver.parseTableName(e);n.schema||(n.schema=await this.getCurrentSchema());const i=`SELECT * FROM "information_schema"."columns" WHERE "table_schema" = '${n.schema}' AND "table_name" = '${n.tableName}' AND "column_name" = '${t}'`;return!!(await this.query(i)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();const n=`CREATE DATABASE "${e}"`,i=`DROP DATABASE "${e}"`;await this.executeQueries(new N(n),new N(i))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,i=`CREATE DATABASE "${e}"`;await this.executeQueries(new N(n),new N(i))}async createSchema(e,t){const n=e.indexOf(".")===-1?e:e.split(".")[1],i=t?`CREATE SCHEMA IF NOT EXISTS "${n}"`:`CREATE SCHEMA "${n}"`,r=`DROP SCHEMA "${n}" CASCADE`;await this.executeQueries(new N(i),new N(r))}async dropSchema(e,t,n){const i=e.indexOf(".")===-1?e:e.split(".")[1],r=t?`DROP SCHEMA IF EXISTS "${i}" ${n?"CASCADE":""}`:`DROP SCHEMA "${i}" ${n?"CASCADE":""}`,s=`CREATE SCHEMA "${i}"`;await this.executeQueries(new N(r),new N(s))}async createTable(e,t=!1,n=!0,i=!0){if(t&&await this.hasTable(e))return Promise.resolve();const r=[],s=[],a=e.columns.filter(u=>u.type==="enum"||u.type==="simple-enum"),o=[];for(const u of a){const l=await this.hasEnumType(e,u),h=this.buildEnumName(e,u);!l&&o.indexOf(h)===-1&&(o.push(h),r.push(this.createEnumTypeSql(e,u,h)),s.push(this.dropEnumTypeSql(e,u,h)))}const c=e.columns.filter(u=>u.generatedType==="STORED"&&u.asExpression);for(const u of c){const l=(await this.getTableNameWithSchema(e.name)).split("."),h=l[1],m=l[0],y=this.insertTypeormMetadataSql({database:this.driver.database,schema:m,table:h,type:se.GENERATED_COLUMN,name:u.name,value:u.asExpression}),g=this.deleteTypeormMetadataSql({database:this.driver.database,schema:m,table:h,type:se.GENERATED_COLUMN,name:u.name});r.push(y),s.push(g)}r.push(this.createTableSql(e,n)),s.push(this.dropTableSql(e)),n&&e.foreignKeys.forEach(u=>s.push(this.dropForeignKeySql(e,u))),i&&e.indices.forEach(u=>{u.name||(u.name=this.connection.namingStrategy.indexName(e,u.columnNames,u.where)),r.push(this.createIndexSql(e,u)),s.push(this.dropIndexSql(e,u))}),e.comment&&(r.push(new N("COMMENT ON TABLE "+this.escapePath(e)+" IS '"+e.comment+"'")),s.push(new N("COMMENT ON TABLE "+this.escapePath(e)+" IS NULL"))),await this.executeQueries(r,s)}async dropTable(e,t,n=!0,i=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const r=n,s=this.getTablePath(e),a=await this.getCachedTable(s),o=[],c=[];i&&a.indices.forEach(l=>{o.push(this.dropIndexSql(a,l)),c.push(this.createIndexSql(a,l))}),n&&a.foreignKeys.forEach(l=>o.push(this.dropForeignKeySql(a,l))),o.push(this.dropTableSql(a)),c.push(this.createTableSql(a,r));const u=a.columns.filter(l=>l.generatedType&&l.asExpression);for(const l of u){const h=(await this.getTableNameWithSchema(a.name)).split("."),m=h[1],y=h[0],g=this.deleteTypeormMetadataSql({database:this.driver.database,schema:y,table:m,type:se.GENERATED_COLUMN,name:l.name}),b=this.insertTypeormMetadataSql({database:this.driver.database,schema:y,table:m,type:se.GENERATED_COLUMN,name:l.name,value:l.asExpression});o.push(g),c.push(b)}await this.executeQueries(o,c)}async createView(e,t=!1){const n=[],i=[];n.push(this.createViewSql(e)),t&&n.push(await this.insertViewDefinitionSql(e)),i.push(this.dropViewSql(e)),t&&i.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(n,i)}async dropView(e){const t=v.isView(e)?e.name:e,n=await this.getCachedView(t),i=[],r=[];i.push(await this.deleteViewDefinitionSql(n)),i.push(this.dropViewSql(n)),r.push(await this.insertViewDefinitionSql(n)),r.push(this.createViewSql(n)),await this.executeQueries(i,r)}async renameTable(e,t){const n=[],i=[],r=v.isTable(e)?e:await this.getCachedTable(e),s=r.clone(),{schema:a,tableName:o}=this.driver.parseTableName(r);if(s.name=a?`${a}.${t}`:t,n.push(new N(`ALTER TABLE ${this.escapePath(r)} RENAME TO "${t}"`)),i.push(new N(`ALTER TABLE ${this.escapePath(s)} RENAME TO "${o}"`)),s.primaryColumns.length>0&&!s.primaryColumns[0].primaryKeyConstraintName){const u=s.primaryColumns.map(m=>m.name),l=this.connection.namingStrategy.primaryKeyName(r,u),h=this.connection.namingStrategy.primaryKeyName(s,u);n.push(new N(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${l}" TO "${h}"`)),i.push(new N(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${h}" TO "${l}"`))}s.columns.map(u=>{if(u.isGenerated&&u.generationStrategy==="increment"){const l=this.buildSequencePath(r,u.name),h=this.buildSequenceName(r,u.name),m=this.buildSequencePath(s,u.name),y=this.buildSequenceName(s,u.name),g=`ALTER SEQUENCE ${this.escapePath(l)} RENAME TO "${y}"`,b=`ALTER SEQUENCE ${this.escapePath(m)} RENAME TO "${h}"`;n.push(new N(g)),i.push(new N(b))}}),s.uniques.forEach(u=>{const l=this.connection.namingStrategy.uniqueConstraintName(r,u.columnNames);if(u.name!==l)return;const h=this.connection.namingStrategy.uniqueConstraintName(s,u.columnNames);n.push(new N(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${u.name}" TO "${h}"`)),i.push(new N(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${h}" TO "${u.name}"`)),u.name=h}),s.indices.forEach(u=>{const l=this.connection.namingStrategy.indexName(r,u.columnNames,u.where);if(u.name!==l)return;const{schema:h}=this.driver.parseTableName(s),m=this.connection.namingStrategy.indexName(s,u.columnNames,u.where),y=h?`ALTER INDEX "${h}"."${u.name}" RENAME TO "${m}"`:`ALTER INDEX "${u.name}" RENAME TO "${m}"`,g=h?`ALTER INDEX "${h}"."${m}" RENAME TO "${u.name}"`:`ALTER INDEX "${m}" RENAME TO "${u.name}"`;n.push(new N(y)),i.push(new N(g)),u.name=m}),s.foreignKeys.forEach(u=>{const l=this.connection.namingStrategy.foreignKeyName(r,u.columnNames,this.getTablePath(u),u.referencedColumnNames);if(u.name!==l)return;const h=this.connection.namingStrategy.foreignKeyName(s,u.columnNames,this.getTablePath(u),u.referencedColumnNames);n.push(new N(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${u.name}" TO "${h}"`)),i.push(new N(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${h}" TO "${u.name}"`)),u.name=h});const c=s.columns.filter(u=>u.type==="enum"||u.type==="simple-enum");for(const u of c){if(u.enumName)continue;const l=await this.getUserDefinedTypeName(r,u);n.push(new N(`ALTER TYPE "${l.schema}"."${l.name}" RENAME TO ${this.buildEnumName(s,u,!1)}`)),i.push(new N(`ALTER TYPE ${this.buildEnumName(s,u)} RENAME TO "${l.name}"`))}await this.executeQueries(n,i)}async addColumn(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=[],s=[];if((t.type==="enum"||t.type==="simple-enum")&&(await this.hasEnumType(n,t)||(r.push(this.createEnumTypeSql(n,t)),s.push(this.dropEnumTypeSql(n,t)))),r.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,t)}`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${t.name}"`)),t.isPrimary){const o=i.primaryColumns;if(o.length>0){const l=o[0].primaryKeyConstraintName?o[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,o.map(m=>m.name)),h=o.map(m=>`"${m.name}"`).join(", ");r.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${l}"`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${l}" PRIMARY KEY (${h})`))}o.push(t);const c=o[0].primaryKeyConstraintName?o[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,o.map(l=>l.name)),u=o.map(l=>`"${l.name}"`).join(", ");r.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${c}" PRIMARY KEY (${u})`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${c}"`))}const a=i.indices.find(o=>o.columnNames.length===1&&o.columnNames[0]===t.name);if(a&&(r.push(this.createIndexSql(n,a)),s.push(this.dropIndexSql(n,a))),t.isUnique){const o=new Le({name:this.connection.namingStrategy.uniqueConstraintName(n,[t.name]),columnNames:[t.name]});i.uniques.push(o),r.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${o.name}" UNIQUE ("${t.name}")`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${o.name}"`))}if(t.generatedType==="STORED"&&t.asExpression){const o=(await this.getTableNameWithSchema(n.name)).split("."),c=o[1],u=o[0],l=this.insertTypeormMetadataSql({database:this.driver.database,schema:u,table:c,type:se.GENERATED_COLUMN,name:t.name,value:t.asExpression}),h=this.deleteTypeormMetadataSql({database:this.driver.database,schema:u,table:c,type:se.GENERATED_COLUMN,name:t.name});r.push(l),s.push(h)}t.comment&&(r.push(new N(`COMMENT ON COLUMN ${this.escapePath(n)}."${t.name}" IS ${this.escapeComment(t.comment)}`)),s.push(new N(`COMMENT ON COLUMN ${this.escapePath(n)}."${t.name}" IS ${this.escapeComment(t.comment)}`))),await this.executeQueries(r,s),i.addColumn(t),this.replaceCachedTable(n,i)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const i=v.isTable(e)?e:await this.getCachedTable(e),r=v.isTableColumn(t)?t:i.columns.find(a=>a.name===t);if(!r)throw new C(`Column "${t}" was not found in the "${i.name}" table.`);let s;return v.isTableColumn(n)?s=n:(s=r.clone(),s.name=n),this.changeColumn(i,r,s)}async changeColumn(e,t,n){const i=v.isTable(e)?e:await this.getCachedTable(e);let r=i.clone();const s=[],a=[];let o=!1;const c=v.isTableColumn(t)?t:i.columns.find(u=>u.name===t);if(!c)throw new C(`Column "${t}" was not found in the "${i.name}" table.`);if(c.type!==n.type||c.length!==n.length||n.isArray!==c.isArray||!c.generatedType&&n.generatedType==="STORED"||c.asExpression!==n.asExpression&&n.generatedType==="STORED")await this.dropColumn(i,c),await this.addColumn(i,n),r=i.clone();else{if(c.name!==n.name){if(s.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME COLUMN "${c.name}" TO "${n.name}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME COLUMN "${n.name}" TO "${c.name}"`)),c.type==="enum"||c.type==="simple-enum"){const l=await this.getUserDefinedTypeName(i,c);s.push(new N(`ALTER TYPE "${l.schema}"."${l.name}" RENAME TO ${this.buildEnumName(i,n,!1)}`)),a.push(new N(`ALTER TYPE ${this.buildEnumName(i,n)} RENAME TO "${l.name}"`))}if(c.isPrimary===!0&&!c.primaryKeyConstraintName){const h=r.primaryColumns.map(g=>g.name),m=this.connection.namingStrategy.primaryKeyName(r,h);h.splice(h.indexOf(c.name),1),h.push(n.name);const y=this.connection.namingStrategy.primaryKeyName(r,h);s.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${m}" TO "${y}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${y}" TO "${m}"`))}if(c.isGenerated===!0&&n.generationStrategy==="increment"){const l=this.buildSequencePath(i,c.name),h=this.buildSequenceName(i,c.name),m=this.buildSequencePath(i,n.name),y=this.buildSequenceName(i,n.name),g=`ALTER SEQUENCE ${this.escapePath(l)} RENAME TO "${y}"`,b=`ALTER SEQUENCE ${this.escapePath(m)} RENAME TO "${h}"`;s.push(new N(g)),a.push(new N(b))}r.findColumnUniques(c).forEach(l=>{const h=this.connection.namingStrategy.uniqueConstraintName(r,l.columnNames);if(l.name!==h)return;l.columnNames.splice(l.columnNames.indexOf(c.name),1),l.columnNames.push(n.name);const m=this.connection.namingStrategy.uniqueConstraintName(r,l.columnNames);s.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${l.name}" TO "${m}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${m}" TO "${l.name}"`)),l.name=m}),r.findColumnIndices(c).forEach(l=>{const h=this.connection.namingStrategy.indexName(r,l.columnNames,l.where);if(l.name!==h)return;l.columnNames.splice(l.columnNames.indexOf(c.name),1),l.columnNames.push(n.name);const{schema:m}=this.driver.parseTableName(i),y=this.connection.namingStrategy.indexName(r,l.columnNames,l.where),g=m?`ALTER INDEX "${m}"."${l.name}" RENAME TO "${y}"`:`ALTER INDEX "${l.name}" RENAME TO "${y}"`,b=m?`ALTER INDEX "${m}"."${y}" RENAME TO "${l.name}"`:`ALTER INDEX "${y}" RENAME TO "${l.name}"`;s.push(new N(g)),a.push(new N(b)),l.name=y}),r.findColumnForeignKeys(c).forEach(l=>{const h=this.connection.namingStrategy.foreignKeyName(r,l.columnNames,this.getTablePath(l),l.referencedColumnNames);if(l.name!==h)return;l.columnNames.splice(l.columnNames.indexOf(c.name),1),l.columnNames.push(n.name);const m=this.connection.namingStrategy.foreignKeyName(r,l.columnNames,this.getTablePath(l),l.referencedColumnNames);s.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${l.name}" TO "${m}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${m}" TO "${l.name}"`)),l.name=m});const u=r.columns.find(l=>l.name===c.name);r.columns[r.columns.indexOf(u)].name=n.name,c.name=n.name}if((n.precision!==c.precision||n.scale!==c.scale)&&(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(c)}`))),(n.type==="enum"||n.type==="simple-enum")&&(c.type==="enum"||c.type==="simple-enum")&&(!Q.isArraysEqual(n.enum,c.enum)||n.enumName!==c.enumName)){const u=n.isArray?"[]":"",l=this.buildEnumName(i,n),h=this.buildEnumName(i,c),m=this.buildEnumName(i,c,!1),y=this.buildEnumName(i,c,!0,!1,!0),g=this.buildEnumName(i,c,!1,!1,!0);s.push(new N(`ALTER TYPE ${h} RENAME TO ${g}`)),a.push(new N(`ALTER TYPE ${y} RENAME TO ${m}`)),s.push(this.createEnumTypeSql(i,n,l)),a.push(this.dropEnumTypeSql(i,n,l)),c.default!==null&&c.default!==void 0&&(o=!0,s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${c.name}" DROP DEFAULT`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${c.name}" SET DEFAULT ${c.default}`)));const b=`${l}${u} USING "${n.name}"::"text"::${l}${u}`,R=`${y}${u} USING "${n.name}"::"text"::${y}${u}`;s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${b}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${R}`)),n.default!==null&&n.default!==void 0&&(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${n.default}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`))),s.push(this.dropEnumTypeSql(i,c,y)),a.push(this.createEnumTypeSql(i,c,y))}if(c.isNullable!==n.isNullable&&(n.isNullable?(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${c.name}" DROP NOT NULL`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${c.name}" SET NOT NULL`))):(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${c.name}" SET NOT NULL`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${c.name}" DROP NOT NULL`)))),c.comment!==n.comment&&(s.push(new N(`COMMENT ON COLUMN ${this.escapePath(i)}."${c.name}" IS ${this.escapeComment(n.comment)}`)),a.push(new N(`COMMENT ON COLUMN ${this.escapePath(i)}."${n.name}" IS ${this.escapeComment(c.comment)}`))),n.isPrimary!==c.isPrimary){const u=r.primaryColumns;if(u.length>0){const l=u[0].primaryKeyConstraintName?u[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,u.map(m=>m.name)),h=u.map(m=>`"${m.name}"`).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${l}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${l}" PRIMARY KEY (${h})`))}if(n.isPrimary===!0){u.push(n);const l=r.columns.find(y=>y.name===n.name);l.isPrimary=!0;const h=u[0].primaryKeyConstraintName?u[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,u.map(y=>y.name)),m=u.map(y=>`"${y.name}"`).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${h}" PRIMARY KEY (${m})`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${h}"`))}else{const l=u.find(m=>m.name===n.name);u.splice(u.indexOf(l),1);const h=r.columns.find(m=>m.name===n.name);if(h.isPrimary=!1,u.length>0){const m=u[0].primaryKeyConstraintName?u[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,u.map(g=>g.name)),y=u.map(g=>`"${g.name}"`).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${m}" PRIMARY KEY (${y})`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${m}"`))}}}if(n.isUnique!==c.isUnique)if(n.isUnique===!0){const u=new Le({name:this.connection.namingStrategy.uniqueConstraintName(i,[n.name]),columnNames:[n.name]});r.uniques.push(u),s.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${u.name}" UNIQUE ("${n.name}")`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${u.name}"`))}else{const u=r.uniques.find(l=>l.columnNames.length===1&&!!l.columnNames.find(h=>h===n.name));r.uniques.splice(r.uniques.indexOf(u),1),s.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${u.name}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${u.name}" UNIQUE ("${n.name}")`))}if(c.isGenerated!==n.isGenerated&&(c.isGenerated&&(c.generationStrategy==="uuid"?(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${c.name}" DROP DEFAULT`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${c.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):c.generationStrategy==="increment"&&(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(i,n))}')`)),s.push(new N(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(i,n))}`)),a.push(new N(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(i,n))} OWNED BY ${this.escapePath(i)}."${n.name}"`)))),n.generationStrategy==="uuid"?n.isGenerated===!0?(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${this.driver.uuidGenerator}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):n.generationStrategy==="increment"&&(n.isGenerated===!0?(s.push(new N(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(i,n))} OWNED BY ${this.escapePath(i)}."${n.name}"`)),a.push(new N(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(i,n))}`)),s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(i,n))}')`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(i,n))}')`)),s.push(new N(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(i,n))}`)),a.push(new N(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(i,n))} OWNED BY ${this.escapePath(i)}."${n.name}"`))))),n.default!==c.default&&!o&&(n.default!==null&&n.default!==void 0?(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${n.default}`)),c.default!==null&&c.default!==void 0?a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${c.default}`)):a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):c.default!==null&&c.default!==void 0&&(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${c.default}`)))),((n.spatialFeatureType||"").toLowerCase()!==(c.spatialFeatureType||"").toLowerCase()||n.srid!==c.srid)&&(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(c)}`))),n.collation!==c.collation){s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${n.type} COLLATE "${n.collation}"`));const u=c.collation?`"${c.collation}"`:'pg_catalog."default"';a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${n.type} COLLATE ${u}`))}if(n.generatedType!==c.generatedType&&(!n.generatedType||n.generatedType==="VIRTUAL")){const u=(await this.getTableNameWithSchema(i.name)).split("."),l=u[1],h=u[0];s.push(new N(`ALTER TABLE ${this.escapePath(i)} RENAME COLUMN "${c.name}" TO "TEMP_OLD_${c.name}"`)),s.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD ${this.buildCreateColumnSql(i,n)}`)),s.push(new N(`UPDATE ${this.escapePath(i)} SET "${n.name}" = "TEMP_OLD_${c.name}"`)),s.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP COLUMN "TEMP_OLD_${c.name}"`)),s.push(this.deleteTypeormMetadataSql({database:this.driver.database,schema:h,table:l,type:se.GENERATED_COLUMN,name:c.name})),a.push(this.insertTypeormMetadataSql({database:this.driver.database,schema:h,table:l,type:se.GENERATED_COLUMN,name:c.name,value:c.asExpression})),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ADD ${this.buildCreateColumnSql(i,c)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} DROP COLUMN "${n.name}"`))}}await this.executeQueries(s,a),this.replaceCachedTable(i,r)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:i}of t)await this.changeColumn(e,n,i)}async dropColumn(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableColumn(t)?t:n.findColumnByName(t);if(!i)throw new C(`Column "${t}" was not found in table "${n.name}"`);const r=n.clone(),s=[],a=[];if(i.isPrimary){const l=i.primaryKeyConstraintName?i.primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,r.primaryColumns.map(y=>y.name)),h=r.primaryColumns.map(y=>`"${y.name}"`).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${l}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${l}" PRIMARY KEY (${h})`));const m=r.findColumnByName(i.name);if(m.isPrimary=!1,r.primaryColumns.length>0){const y=r.primaryColumns[0].primaryKeyConstraintName?r.primaryColumns[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,r.primaryColumns.map(b=>b.name)),g=r.primaryColumns.map(b=>`"${b.name}"`).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${y}" PRIMARY KEY (${g})`)),a.push(new N(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${y}"`))}}const o=r.indices.find(l=>l.columnNames.length===1&&l.columnNames[0]===i.name);o&&(r.indices.splice(r.indices.indexOf(o),1),s.push(this.dropIndexSql(n,o)),a.push(this.createIndexSql(n,o)));const c=r.checks.find(l=>!!l.columnNames&&l.columnNames.length===1&&l.columnNames[0]===i.name);c&&(r.checks.splice(r.checks.indexOf(c),1),s.push(this.dropCheckConstraintSql(n,c)),a.push(this.createCheckConstraintSql(n,c)));const u=r.uniques.find(l=>l.columnNames.length===1&&l.columnNames[0]===i.name);if(u&&(r.uniques.splice(r.uniques.indexOf(u),1),s.push(this.dropUniqueConstraintSql(n,u)),a.push(this.createUniqueConstraintSql(n,u))),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${i.name}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,i)}`)),(i.type==="enum"||i.type==="simple-enum")&&await this.hasEnumType(n,i)){const h=await this.getUserDefinedTypeName(n,i),m=`"${h.schema}"."${h.name}"`;s.push(this.dropEnumTypeSql(n,i,m)),a.push(this.createEnumTypeSql(n,i,m))}if(i.generatedType==="STORED"){const l=(await this.getTableNameWithSchema(n.name)).split("."),h=l[1],m=l[0],y=this.deleteTypeormMetadataSql({database:this.driver.database,schema:m,table:h,type:se.GENERATED_COLUMN,name:i.name}),g=this.insertTypeormMetadataSql({database:this.driver.database,schema:m,table:h,type:se.GENERATED_COLUMN,name:i.name,value:i.asExpression});s.push(y),a.push(g)}await this.executeQueries(s,a),r.removeColumn(i),this.replaceCachedTable(n,r)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t,n){const i=v.isTable(e)?e:await this.getCachedTable(e),r=i.clone(),s=this.createPrimaryKeySql(i,t,n);r.columns.forEach(o=>{t.find(c=>c===o.name)&&(o.isPrimary=!0)});const a=this.dropPrimaryKeySql(r);await this.executeQueries(s,a),this.replaceCachedTable(i,r)}async updatePrimaryKeys(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=t.map(l=>l.name),s=[],a=[],o=i.primaryColumns;if(o.length>0){const l=o[0].primaryKeyConstraintName?o[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,o.map(m=>m.name)),h=o.map(m=>`"${m.name}"`).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${l}"`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${l}" PRIMARY KEY (${h})`))}i.columns.filter(l=>r.indexOf(l.name)!==-1).forEach(l=>l.isPrimary=!0);const c=o[0]?.primaryKeyConstraintName?o[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,r),u=r.map(l=>`"${l}"`).join(", ");s.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${c}" PRIMARY KEY (${u})`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${c}"`)),await this.executeQueries(s,a),this.replaceCachedTable(n,i)}async dropPrimaryKey(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=this.dropPrimaryKeySql(n),r=this.createPrimaryKeySql(n,n.primaryColumns.map(s=>s.name),t);await this.executeQueries(i,r),n.primaryColumns.forEach(s=>{s.isPrimary=!1})}async createUniqueConstraint(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.uniqueConstraintName(n,t.columnNames));const i=this.createUniqueConstraintSql(n,t),r=this.dropUniqueConstraintSql(n,t);await this.executeQueries(i,r),n.addUniqueConstraint(t)}async createUniqueConstraints(e,t){for(const n of t)await this.createUniqueConstraint(e,n)}async dropUniqueConstraint(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableUnique(t)?t:n.uniques.find(a=>a.name===t);if(!i)throw new C(`Supplied unique constraint was not found in table ${n.name}`);const r=this.dropUniqueConstraintSql(n,i),s=this.createUniqueConstraintSql(n,i);await this.executeQueries(r,s),n.removeUniqueConstraint(i)}async dropUniqueConstraints(e,t){for(const n of[...t])await this.dropUniqueConstraint(e,n)}async createCheckConstraint(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(n,t.expression));const i=this.createCheckConstraintSql(n,t),r=this.dropCheckConstraintSql(n,t);await this.executeQueries(i,r),n.addCheckConstraint(t)}async createCheckConstraints(e,t){const n=t.map(i=>this.createCheckConstraint(e,i));await Promise.all(n)}async dropCheckConstraint(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableCheck(t)?t:n.checks.find(a=>a.name===t);if(!i)throw new C(`Supplied check constraint was not found in table ${n.name}`);const r=this.dropCheckConstraintSql(n,i),s=this.createCheckConstraintSql(n,i);await this.executeQueries(r,s),n.removeCheckConstraint(i)}async dropCheckConstraints(e,t){const n=t.map(i=>this.dropCheckConstraint(e,i));await Promise.all(n)}async createExclusionConstraint(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.exclusionConstraintName(n,t.expression));const i=this.createExclusionConstraintSql(n,t),r=this.dropExclusionConstraintSql(n,t);await this.executeQueries(i,r),n.addExclusionConstraint(t)}async createExclusionConstraints(e,t){const n=t.map(i=>this.createExclusionConstraint(e,i));await Promise.all(n)}async dropExclusionConstraint(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableExclusion(t)?t:n.exclusions.find(a=>a.name===t);if(!i)throw new C(`Supplied exclusion constraint was not found in table ${n.name}`);const r=this.dropExclusionConstraintSql(n,i),s=this.createExclusionConstraintSql(n,i);await this.executeQueries(r,s),n.removeExclusionConstraint(i)}async dropExclusionConstraints(e,t){const n=t.map(i=>this.dropExclusionConstraint(e,i));await Promise.all(n)}async createForeignKey(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames,this.getTablePath(t),t.referencedColumnNames));const i=this.createForeignKeySql(n,t),r=this.dropForeignKeySql(n,t);await this.executeQueries(i,r),n.addForeignKey(t)}async createForeignKeys(e,t){for(const n of t)await this.createForeignKey(e,n)}async dropForeignKey(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableForeignKey(t)?t:n.foreignKeys.find(a=>a.name===t);if(!i)throw new C(`Supplied foreign key was not found in table ${n.name}`);i.name||(i.name=this.connection.namingStrategy.foreignKeyName(n,i.columnNames,this.getTablePath(i),i.referencedColumnNames));const r=this.dropForeignKeySql(n,i),s=this.createForeignKeySql(n,i);await this.executeQueries(r,s),n.removeForeignKey(i)}async dropForeignKeys(e,t){for(const n of[...t])await this.dropForeignKey(e,n)}async createIndex(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createIndexSql(n,t),r=this.dropIndexSql(n,t);await this.executeQueries(i,r),n.addIndex(t)}async createViewIndex(e,t){const n=v.isView(e)?e:await this.getCachedView(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createViewIndexSql(n,t),r=this.dropIndexSql(n,t);await this.executeQueries(i,r),n.addIndex(t)}async createIndices(e,t){for(const n of t)await this.createIndex(e,n)}async createViewIndices(e,t){for(const n of t)await this.createViewIndex(e,n)}async dropIndex(e,t){const n=v.isTable(e)?e:await this.getCachedTable(e),i=v.isTableIndex(t)?t:n.indices.find(a=>a.name===t);if(!i)throw new C(`Supplied index ${t} was not found in table ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(n,i),s=this.createIndexSql(n,i);await this.executeQueries(r,s),n.removeIndex(i)}async dropViewIndex(e,t){const n=v.isView(e)?e:await this.getCachedView(e),i=v.isTableIndex(t)?t:n.indices.find(a=>a.name===t);if(!i)throw new C(`Supplied index ${t} was not found in view ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(n,i),s=this.createViewIndexSql(n,i);await this.executeQueries(r,s),n.removeIndex(i)}async dropIndices(e,t){for(const n of[...t])await this.dropIndex(e,n)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(){const e=[];this.connection.entityMetadatas.filter(i=>i.schema).forEach(i=>{e.find(s=>s===i.schema)||e.push(i.schema)}),e.push(this.driver.options.schema||"current_schema()");const t=e.map(i=>i==="current_schema()"?i:"'"+i+"'").join(", "),n=this.isTransactionActive;n||await this.startTransaction();try{const i=`SELECT 'DROP VIEW IF EXISTS "' || schemaname || '"."' || viewname || '" CASCADE;' as "query" FROM "pg_views" WHERE "schemaname" IN (${t}) AND "viewname" NOT IN ('geography_columns', 'geometry_columns', 'raster_columns', 'raster_overviews')`,r=await this.query(i);if(await Promise.all(r.map(o=>this.query(o.query))),k.isReleaseVersionOrGreater(this.driver,"9.3")){const o=`SELECT 'DROP MATERIALIZED VIEW IF EXISTS "' || schemaname || '"."' || matviewname || '" CASCADE;' as "query" FROM "pg_matviews" WHERE "schemaname" IN (${t})`,c=await this.query(o);await Promise.all(c.map(u=>this.query(u.query)))}const s=`SELECT 'DROP TABLE IF EXISTS "' || schemaname || '"."' || tablename || '" CASCADE;' as "query" FROM "pg_tables" WHERE "schemaname" IN (${t}) AND "tablename" NOT IN ('spatial_ref_sys')`,a=await this.query(s);await Promise.all(a.map(o=>this.query(o.query))),await this.dropEnumTypes(t),n||await this.commitTransaction()}catch(i){try{n||await this.rollbackTransaction()}catch{}throw i}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=await this.getCurrentDatabase(),i=await this.getCurrentSchema(),r=e.length===0?"1=1":e.map(l=>this.driver.parseTableName(l)).map(({schema:l,tableName:h})=>(l||(l=this.driver.options.schema||i),`("t"."schema" = '${l}' AND "t"."name" = '${h}')`)).join(" OR "),a=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('m') AND "cnst"."contype" IS NULL AND (${e.length===0?"1=1":e.map(l=>this.driver.parseTableName(l)).map(({schema:l,tableName:h})=>(l||(l=this.driver.options.schema||i),`("ns"."nspname" = '${l}' AND "t"."relname" = '${h}')`)).join(" OR ")})`,o=`SELECT "t".* FROM ${this.escapePath(this.getTypeormMetadataTableName())} "t" INNER JOIN "pg_catalog"."pg_class" "c" ON "c"."relname" = "t"."name" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "c"."relnamespace" AND "n"."nspname" = "t"."schema" WHERE "t"."type" IN ('${se.VIEW}', '${se.MATERIALIZED_VIEW}') ${r?`AND (${r})`:""}`,c=await this.query(o),u=await this.query(a);return c.map(l=>{const h=Q.uniq(u.filter(g=>g.table_name===l.name&&g.table_schema===l.schema),g=>g.constraint_name),m=new lt,y=l.schema===i&&!this.driver.options.schema?void 0:l.schema;return m.database=n,m.schema=l.schema,m.name=this.driver.buildTableName(l.name,y),m.expression=l.value,m.materialized=l.type===se.MATERIALIZED_VIEW,m.indices=h.map(g=>{const b=u.filter(R=>R.table_schema===g.table_schema&&R.table_name===g.table_name&&R.constraint_name===g.constraint_name);return new Pe({view:m,name:g.constraint_name,columnNames:b.map(R=>R.column_name),isUnique:g.is_unique==="TRUE",where:g.condition,isFulltext:!1})}),m})}async loadTables(e){if(e&&e.length===0)return[];const t=await this.getCurrentSchema(),n=await this.getCurrentDatabase(),i=[];if(!e)i.push(...await this.query(`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables"`));else{const M=`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables" WHERE `+e.map(U=>this.driver.parseTableName(U)).map(({schema:U,tableName:F})=>`("table_schema" = '${U||t}' AND "table_name" = '${F}')`).join(" OR ");i.push(...await this.query(M))}if(i.length===0)return[];const s=`SELECT columns.*, pg_catalog.col_description(('"' || table_catalog || '"."' || table_schema || '"."' || table_name || '"')::regclass::oid, ordinal_position) AS description, ('"' || "udt_schema" || '"."' || "udt_name" || '"')::"regtype"::text AS "regtype", pg_catalog.format_type("col_attr"."atttypid", "col_attr"."atttypmod") AS "format_type" FROM "information_schema"."columns" LEFT JOIN "pg_catalog"."pg_attribute" AS "col_attr" ON "col_attr"."attname" = "columns"."column_name" AND "col_attr"."attrelid" = ( SELECT "cls"."oid" FROM "pg_catalog"."pg_class" AS "cls" LEFT JOIN "pg_catalog"."pg_namespace" AS "ns" ON "ns"."oid" = "cls"."relnamespace" WHERE "cls"."relname" = "columns"."table_name" AND "ns"."nspname" = "columns"."table_schema" ) WHERE `+i.map(({table_schema:P,table_name:M})=>`("table_schema" = '${P}' AND "table_name" = '${M}')`).join(" OR "),a=i.map(({table_schema:P,table_name:M})=>`("ns"."nspname" = '${P}' AND "t"."relname" = '${M}')`).join(" OR "),o=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "cnst"."conname" AS "constraint_name", pg_get_constraintdef("cnst"."oid") AS "expression", CASE "cnst"."contype" WHEN 'p' THEN 'PRIMARY' WHEN 'u' THEN 'UNIQUE' WHEN 'c' THEN 'CHECK' WHEN 'x' THEN 'EXCLUDE' END AS "constraint_type", "a"."attname" AS "column_name" FROM "pg_constraint" "cnst" INNER JOIN "pg_class" "t" ON "t"."oid" = "cnst"."conrelid" INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "cnst"."connamespace" LEFT JOIN "pg_attribute" "a" ON "a"."attrelid" = "cnst"."conrelid" AND "a"."attnum" = ANY ("cnst"."conkey") WHERE "t"."relkind" IN ('r', 'p') AND (${a})`,c=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name", "am"."amname" AS "index_type" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" INNER JOIN "pg_am" "am" ON "i"."relam" = "am"."oid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('r', 'p') AND "cnst"."contype" IS NULL AND (${a})`,u=i.map(({table_schema:P,table_name:M})=>`("ns"."nspname" = '${P}' AND "cl"."relname" = '${M}')`).join(" OR "),h=await this.hasSupportForPartitionedTables()?` AND "cl"."relispartition" = 'f'`:"",m=`SELECT "con"."conname" AS "constraint_name", "con"."nspname" AS "table_schema", "con"."relname" AS "table_name", "att2"."attname" AS "column_name", "ns"."nspname" AS "referenced_table_schema", "cl"."relname" AS "referenced_table_name", "att"."attname" AS "referenced_column_name", "con"."confdeltype" AS "on_delete", "con"."confupdtype" AS "on_update", "con"."condeferrable" AS "deferrable", "con"."condeferred" AS "deferred" FROM ( SELECT UNNEST ("con1"."conkey") AS "parent", UNNEST ("con1"."confkey") AS "child", "con1"."confrelid", "con1"."conrelid", "con1"."conname", "con1"."contype", "ns"."nspname", "cl"."relname", "con1"."condeferrable", CASE WHEN "con1"."condeferred" THEN 'INITIALLY DEFERRED' ELSE 'INITIALLY IMMEDIATE' END as condeferred, CASE "con1"."confdeltype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confdeltype", CASE "con1"."confupdtype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confupdtype" FROM "pg_class" "cl" INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_constraint" "con1" ON "con1"."conrelid" = "cl"."oid" WHERE "con1"."contype" = 'f' AND (${u}) ) "con" INNER JOIN "pg_attribute" "att" ON "att"."attrelid" = "con"."confrelid" AND "att"."attnum" = "con"."child" INNER JOIN "pg_class" "cl" ON "cl"."oid" = "con"."confrelid" ${h}INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_attribute" "att2" ON "att2"."attrelid" = "con"."conrelid" AND "att2"."attnum" = "con"."parent"`,[y,g,b,R]=await Promise.all([this.query(s),this.query(o),this.query(c),this.query(m)]);return Promise.all(i.map(async P=>{const M=new Se,U=(S,V)=>S[V]===t&&(!this.driver.options.schema||this.driver.options.schema===t)?void 0:S[V],F=U(P,"table_schema");M.database=n,M.schema=P.table_schema,M.comment=P.table_comment,M.name=this.driver.buildTableName(P.table_name,F),M.columns=await Promise.all(y.filter(S=>S.table_name===P.table_name&&S.table_schema===P.table_schema).map(async S=>{const V=g.filter(I=>I.table_name===S.table_name&&I.table_schema===S.table_schema&&I.column_name===S.column_name),L=new Fe;if(L.name=S.column_name,L.type=S.regtype.toLowerCase(),L.type==="vector"||L.type==="halfvec"){const I=S.format_type.match(/^(?:vector|halfvec)\((\d+)\)$/);I&&I[1]&&(L.length=I[1])}if(L.type==="numeric"||L.type==="numeric[]"||L.type==="decimal"||L.type==="float"){let I=S.numeric_precision,B=S.numeric_scale;if(S.data_type==="ARRAY"){const W=S.format_type.match(/^numeric\(([0-9]+),([0-9]+)\)\[\]$/);W&&(I=+W[1],B=+W[2])}I!==null&&!this.isDefaultColumnPrecision(M,L,I)?L.precision=I:B!==null&&!this.isDefaultColumnScale(M,L,B)&&(L.precision=void 0),B!==null&&!this.isDefaultColumnScale(M,L,B)?L.scale=B:I!==null&&!this.isDefaultColumnPrecision(M,L,I)&&(L.scale=void 0)}if((L.type==="interval"||L.type==="time without time zone"||L.type==="time with time zone"||L.type==="timestamp without time zone"||L.type==="timestamp with time zone")&&(L.precision=this.isDefaultColumnPrecision(M,L,S.datetime_precision)?void 0:S.datetime_precision),S.data_type==="USER-DEFINED"||S.data_type==="ARRAY"){const{name:I}=await this.getUserDefinedTypeName(M,L),W=this.buildEnumName(M,L,!1,!0)!==I?I:void 0,ee=`SELECT "e"."enumlabel" AS "value" FROM "pg_enum" "e" INNER JOIN "pg_type" "t" ON "t"."oid" = "e"."enumtypid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${P.table_schema}' AND "t"."typname" = '${W||I}'`,ie=await this.query(ee);if(ie.length&&(L.type="enum",L.enum=ie.map(ce=>ce.value),L.enumName=W),S.data_type==="ARRAY"){L.isArray=!0;const ce=L.type.replace("[]","");L.type=this.connection.driver.normalizeType({type:ce})}}if(L.type==="geometry"||L.type==="geography"){const I=`SELECT * FROM (SELECT "f_table_schema" "table_schema", "f_table_name" "table_name", "f_${L.type}_column" "column_name", "srid", "type" FROM "${L.type}_columns") AS _ WHERE "column_name" = '${S.column_name}' AND "table_schema" = '${S.table_schema}' AND "table_name" = '${S.table_name}'`,B=await this.query(I);B.length>0&&(L.spatialFeatureType=B[0].type,L.srid=B[0].srid)}if(this.driver.withLengthColumnTypes.indexOf(L.type)!==-1){let I;if(L.isArray){const B=/\((\d+)\)/.exec(S.format_type);I=B?B[1]:void 0}else S.character_maximum_length&&(I=S.character_maximum_length.toString());I&&(L.length=this.isDefaultColumnLength(M,L,I)?"":I)}L.isNullable=S.is_nullable==="YES";const D=V.find(I=>I.constraint_type==="PRIMARY");if(D){L.isPrimary=!0;const B=g.filter(ee=>ee.table_name===S.table_name&&ee.table_schema===S.table_schema&&ee.column_name!==S.column_name&&ee.constraint_type==="PRIMARY").map(ee=>ee.column_name);B.push(S.column_name);const W=this.connection.namingStrategy.primaryKeyName(M,B);D.constraint_name!==W&&(L.primaryKeyConstraintName=D.constraint_name)}const q=V.filter(I=>I.constraint_type==="UNIQUE"),_=q.every(I=>g.some(B=>B.constraint_type==="UNIQUE"&&B.constraint_name===I.constraint_name&&B.column_name!==S.column_name));if(L.isUnique=q.length>0&&!_,S.is_identity==="YES")L.isGenerated=!0,L.generationStrategy="identity",L.generatedIdentity=S.identity_generation;else if(S.column_default!==null&&S.column_default!==void 0){const I=`nextval('${this.buildSequenceName(M,S.column_name)}'::regclass)`,B=`nextval('${this.buildSequencePath(M,S.column_name)}'::regclass)`,W=S.column_default.replace(/"/g,"");W===I||W===B?(L.isGenerated=!0,L.generationStrategy="increment"):S.column_default==="gen_random_uuid()"||/^uuid_generate_v\d\(\)/.test(S.column_default)?L.type==="uuid"?(L.isGenerated=!0,L.generationStrategy="uuid"):L.default=S.column_default:S.column_default==="now()"||S.column_default.indexOf("'now'::text")!==-1?L.default=S.column_default:(L.default=S.column_default.replace(/::[\w\s.[\]\-"]+/g,""),L.default=L.default.replace(/^(-?\d+)$/,"'$1'"))}if(S.is_generated==="ALWAYS"&&S.generation_expression){L.generatedType="STORED";const I=this.selectTypeormMetadataSql({database:n,schema:P.table_schema,table:P.table_name,type:se.GENERATED_COLUMN,name:L.name}),B=await this.query(I.query,I.parameters);B[0]&&B[0].value?L.asExpression=B[0].value:L.asExpression=""}return L.comment=S.description?S.description:void 0,S.character_set_name&&(L.charset=S.character_set_name),S.collation_name&&(L.collation=S.collation_name),L}));const J=Q.uniq(g.filter(S=>S.table_name===P.table_name&&S.table_schema===P.table_schema&&S.constraint_type==="UNIQUE"),S=>S.constraint_name);M.uniques=J.map(S=>{const V=g.filter(L=>L.constraint_name===S.constraint_name);return new Le({name:S.constraint_name,columnNames:V.map(L=>L.column_name),deferrable:S.deferrable?S.deferred:void 0})});const K=Q.uniq(g.filter(S=>S.table_name===P.table_name&&S.table_schema===P.table_schema&&S.constraint_type==="CHECK"),S=>S.constraint_name);M.checks=K.map(S=>{const V=g.filter(L=>L.constraint_name===S.constraint_name);return new tt({name:S.constraint_name,columnNames:V.map(L=>L.column_name),expression:S.expression.replace(/^\s*CHECK\s*\((.*)\)\s*$/i,"$1")})});const re=Q.uniq(g.filter(S=>S.table_name===P.table_name&&S.table_schema===P.table_schema&&S.constraint_type==="EXCLUDE"),S=>S.constraint_name);M.exclusions=re.map(S=>new ft({name:S.constraint_name,expression:S.expression.substring(8)}));const $=Q.uniq(R.filter(S=>S.table_name===P.table_name&&S.table_schema===P.table_schema),S=>S.constraint_name);M.foreignKeys=$.map(S=>{const V=R.filter(q=>q.constraint_name===S.constraint_name),L=U(S,"referenced_table_schema"),D=this.driver.buildTableName(S.referenced_table_name,L);return new We({name:S.constraint_name,columnNames:V.map(q=>q.column_name),referencedSchema:S.referenced_table_schema,referencedTableName:D,referencedColumnNames:V.map(q=>q.referenced_column_name),onDelete:S.on_delete,onUpdate:S.on_update,deferrable:S.deferrable?S.deferred:void 0})});const Y=Q.uniq(b.filter(S=>S.table_name===P.table_name&&S.table_schema===P.table_schema),S=>S.constraint_name);return M.indices=Y.map(S=>{const V=b.filter(L=>L.table_schema===S.table_schema&&L.table_name===S.table_name&&L.constraint_name===S.constraint_name);return new Pe({table:M,name:S.constraint_name,columnNames:V.map(L=>L.column_name),isUnique:S.is_unique==="TRUE",where:S.condition,isSpatial:S.index_type==="gist",isFulltext:!1})}),M}))}createTableSql(e,t){const n=e.columns.map(s=>this.buildCreateColumnSql(e,s)).join(", ");let i=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(s=>s.isUnique).forEach(s=>{e.uniques.some(o=>o.columnNames.length===1&&o.columnNames[0]===s.name)||e.uniques.push(new Le({name:this.connection.namingStrategy.uniqueConstraintName(e,[s.name]),columnNames:[s.name]}))}),e.uniques.length>0){const s=e.uniques.map(a=>{const o=a.name?a.name:this.connection.namingStrategy.uniqueConstraintName(e,a.columnNames),c=a.columnNames.map(l=>`"${l}"`).join(", ");let u=`CONSTRAINT "${o}" UNIQUE (${c})`;return a.deferrable&&(u+=` DEFERRABLE ${a.deferrable}`),u}).join(", ");i+=`, ${s}`}if(e.checks.length>0){const s=e.checks.map(a=>`CONSTRAINT "${a.name?a.name:this.connection.namingStrategy.checkConstraintName(e,a.expression)}" CHECK (${a.expression})`).join(", ");i+=`, ${s}`}if(e.exclusions.length>0){const s=e.exclusions.map(a=>`CONSTRAINT "${a.name?a.name:this.connection.namingStrategy.exclusionConstraintName(e,a.expression)}" EXCLUDE ${a.expression}`).join(", ");i+=`, ${s}`}if(e.foreignKeys.length>0&&t){const s=e.foreignKeys.map(a=>{const o=a.columnNames.map(l=>`"${l}"`).join(", ");a.name||(a.name=this.connection.namingStrategy.foreignKeyName(e,a.columnNames,this.getTablePath(a),a.referencedColumnNames));const c=a.referencedColumnNames.map(l=>`"${l}"`).join(", ");let u=`CONSTRAINT "${a.name}" FOREIGN KEY (${o}) REFERENCES ${this.escapePath(this.getTablePath(a))} (${c})`;return a.onDelete&&(u+=` ON DELETE ${a.onDelete}`),a.onUpdate&&(u+=` ON UPDATE ${a.onUpdate}`),a.deferrable&&(u+=` DEFERRABLE ${a.deferrable}`),u}).join(", ");i+=`, ${s}`}const r=e.columns.filter(s=>s.isPrimary);if(r.length>0){const s=r[0].primaryKeyConstraintName?r[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(e,r.map(o=>o.name)),a=r.map(o=>`"${o.name}"`).join(", ");i+=`, CONSTRAINT "${s}" PRIMARY KEY (${a})`}return i+=")",e.columns.filter(s=>s.comment).forEach(s=>i+=`; COMMENT ON COLUMN ${this.escapePath(e)}."${s.name}" IS ${this.escapeComment(s.comment)}`),new N(i)}async getVersion(){return(await this.query("SELECT version()"))[0].version.replace(/^PostgreSQL ([\d.]+).*$/,"$1")}dropTableSql(e){return new N(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){const t=e.materialized?"MATERIALIZED ":"",n=this.escapePath(e);return typeof e.expression=="string"?new N(`CREATE ${t}VIEW ${n} AS ${e.expression}`):new N(`CREATE ${t}VIEW ${n} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){const t=await this.getCurrentSchema();let{schema:n,tableName:i}=this.driver.parseTableName(e);n||(n=t);const r=e.materialized?se.MATERIALIZED_VIEW:se.VIEW,s=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:r,schema:n,name:i,value:s})}dropViewSql(e){const t=e.materialized?"MATERIALIZED ":"";return new N(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const t=await this.getCurrentSchema();let{schema:n,tableName:i}=this.driver.parseTableName(e);n||(n=t);const r=e.materialized?se.MATERIALIZED_VIEW:se.VIEW;return this.deleteTypeormMetadataSql({type:r,schema:n,name:i})}async dropEnumTypes(e){const t=`SELECT 'DROP TYPE IF EXISTS "' || n.nspname || '"."' || t.typname || '" CASCADE;' as "query" FROM "pg_type" "t" INNER JOIN "pg_enum" "e" ON "e"."enumtypid" = "t"."oid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" IN (${e}) GROUP BY "n"."nspname", "t"."typname"`,n=await this.query(t);await Promise.all(n.map(i=>this.query(i.query)))}async hasEnumType(e,t){let{schema:n}=this.driver.parseTableName(e);n||(n=await this.getCurrentSchema());const i=this.buildEnumName(e,t,!1,!0),r=`SELECT "n"."nspname", "t"."typname" FROM "pg_type" "t" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${n}' AND "t"."typname" = '${i}'`;return!!(await this.query(r)).length}createEnumTypeSql(e,t,n){n||(n=this.buildEnumName(e,t));const i=t.enum.map(r=>`'${r.replaceAll("'","''")}'`).join(", ");return new N(`CREATE TYPE ${n} AS ENUM(${i})`)}dropEnumTypeSql(e,t,n){return n||(n=this.buildEnumName(e,t)),new N(`DROP TYPE ${n}`)}createIndexSql(e,t){const n=t.columnNames.map(i=>`"${i}"`).join(", ");return new N(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX${t.isConcurrent?" CONCURRENTLY":""} "${t.name}" ON ${this.escapePath(e)} ${t.isSpatial?"USING GiST ":""}(${n}) ${t.where?"WHERE "+t.where:""}`)}createViewIndexSql(e,t){const n=t.columnNames.map(i=>`"${i}"`).join(", ");return new N(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX "${t.name}" ON ${this.escapePath(e)} (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e,t){const n=v.isTableIndex(t)?t.name:t,i=v.isTableIndex(t)?t.isConcurrent:!1,{schema:r}=this.driver.parseTableName(e);return r?new N(`DROP INDEX ${i?"CONCURRENTLY ":""}"${r}"."${n}"`):new N(`DROP INDEX ${i?"CONCURRENTLY ":""}"${n}"`)}createPrimaryKeySql(e,t,n){const i=n||this.connection.namingStrategy.primaryKeyName(e,t),r=t.map(s=>`"${s}"`).join(", ");return new N(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${i}" PRIMARY KEY (${r})`)}dropPrimaryKeySql(e){if(!e.primaryColumns.length)throw new C(`Table ${e} has no primary keys.`);const t=e.primaryColumns.map(r=>r.name),n=e.primaryColumns[0].primaryKeyConstraintName,i=n||this.connection.namingStrategy.primaryKeyName(e,t);return new N(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${i}"`)}createUniqueConstraintSql(e,t){const n=t.columnNames.map(r=>'"'+r+'"').join(", ");let i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" UNIQUE (${n})`;return t.deferrable&&(i+=` DEFERRABLE ${t.deferrable}`),new N(i)}dropUniqueConstraintSql(e,t){const n=v.isTableUnique(t)?t.name:t;return new N(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createCheckConstraintSql(e,t){return new N(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){const n=v.isTableCheck(t)?t.name:t;return new N(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createExclusionConstraintSql(e,t){return new N(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" EXCLUDE ${t.expression}`)}dropExclusionConstraintSql(e,t){const n=v.isTableExclusion(t)?t.name:t;return new N(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createForeignKeySql(e,t){const n=t.columnNames.map(s=>'"'+s+'"').join(", "),i=t.referencedColumnNames.map(s=>'"'+s+'"').join(",");let r=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${i})`;return t.onDelete&&(r+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(r+=` ON UPDATE ${t.onUpdate}`),t.deferrable&&(r+=` DEFERRABLE ${t.deferrable}`),new N(r)}dropForeignKeySql(e,t){const n=v.isTableForeignKey(t)?t.name:t;return new N(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}buildSequenceName(e,t){const{tableName:n}=this.driver.parseTableName(e),i=v.isTableColumn(t)?t.name:t;let r=`${n}_${i}_seq`;return r.length>this.connection.driver.maxAliasLength&&(r=`${n.substring(0,29)}_${i.substring(0,Math.max(29,63-e.name.length-5))}_seq`),r}buildSequencePath(e,t){const{schema:n}=this.driver.parseTableName(e);return n?`${n}.${this.buildSequenceName(e,t)}`:this.buildSequenceName(e,t)}buildEnumName(e,t,n=!0,i,r){const{schema:s,tableName:a}=this.driver.parseTableName(e);let o=t.enumName?t.enumName:`${a}_${t.name.toLowerCase()}_enum`;return s&&n&&(o=`${s}.${o}`),r&&(o=o+"_old"),o.split(".").map(c=>i?c:`"${c}"`).join(".")}async getUserDefinedTypeName(e,t){let{schema:n,tableName:i}=this.driver.parseTableName(e);n||(n=await this.getCurrentSchema());const r=await this.query(`SELECT "udt_schema", "udt_name" FROM "information_schema"."columns" WHERE "table_schema" = '${n}' AND "table_name" = '${i}' AND "column_name"='${t.name}'`);let s=r[0].udt_name;return s.indexOf("_")===0&&(s=s.substr(1,s.length)),{schema:r[0].udt_schema,name:s}}escapeComment(e){return!e||e.length===0?"NULL":(e=e.replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){const{schema:t,tableName:n}=this.driver.parseTableName(e);return t&&t!==this.driver.searchSchema?`"${t}"."${n}"`:`"${n}"`}async getTableNameWithSchema(e){const t=v.isTable(e)?e.name:e;return t.indexOf(".")===-1?`${(await this.query("SELECT current_schema()"))[0].current_schema}.${t}`:`${t.split(".")[0]}.${t.split(".")[1]}`}buildCreateColumnSql(e,t){let n='"'+t.name+'"';if(t.isGenerated===!0&&t.generationStrategy!=="uuid")if(t.generationStrategy==="identity"){const i=t.generatedIdentity||"BY DEFAULT";n+=` ${t.type} GENERATED ${i} AS IDENTITY`}else(t.type==="integer"||t.type==="int"||t.type==="int4")&&(n+=" SERIAL"),(t.type==="smallint"||t.type==="int2")&&(n+=" SMALLSERIAL"),(t.type==="bigint"||t.type==="int8")&&(n+=" BIGSERIAL");return t.type==="enum"||t.type==="simple-enum"?(n+=" "+this.buildEnumName(e,t),t.isArray&&(n+=" array")):(!t.isGenerated||t.type==="uuid")&&(n+=" "+this.connection.driver.createFullType(t)),t.generatedType==="STORED"&&t.asExpression&&(n+=` GENERATED ALWAYS AS (${t.asExpression}) STORED`),t.charset&&(n+=' CHARACTER SET "'+t.charset+'"'),t.collation&&(n+=' COLLATE "'+t.collation+'"'),t.isNullable!==!0&&(n+=" NOT NULL"),t.default!==void 0&&t.default!==null&&(n+=" DEFAULT "+t.default),t.isGenerated&&t.generationStrategy==="uuid"&&!t.default&&(n+=` DEFAULT ${this.driver.uuidGenerator}`),n}async hasSupportForPartitionedTables(){return!!(await this.query("SELECT TRUE FROM information_schema.columns WHERE table_name = 'pg_class' and column_name = 'relispartition'")).length}async changeTableComment(e,t){const n=[],i=[],r=v.isTable(e)?e:await this.getCachedTable(e);t=this.escapeComment(t);const s=this.escapeComment(r.comment);if(t===s)return;const a=r.clone();n.push(new N(`COMMENT ON TABLE ${this.escapePath(a)} IS ${t}`)),i.push(new N(`COMMENT ON TABLE ${this.escapePath(r)} IS ${s}`)),await this.executeQueries(n,i),r.comment=a.comment,this.replaceCachedTable(r,a)}}class Mc extends Rc{constructor(e,t){super(e,t)}}class xc extends Mc{constructor(e,t,n){super(e,n),this.client=t}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)),this.databaseConnectionPromise)}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new Be;const i=await this.client.query(e,t),r=new it;return r.raw=i,i?.hasOwnProperty("records")&&Array.isArray(i.records)&&(r.records=i.records),i?.hasOwnProperty("numberOfRecordsUpdated")&&(r.affected=i.numberOfRecordsUpdated),n?r:r.raw}changeTableComment(e,t){throw new C("aurora-postgres driver does not support change comment.")}}class vc extends Bs{}class Pc extends vc{constructor(e){super(),this.transactionSupport="nested",this.connection=e,this.options=e.options,this.isReplicated=!1,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),this.database=k.buildDriverOptions(this.options).database}async connect(){}async disconnect(){}createQueryRunner(e){return new xc(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),e)}preparePersistentValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.preparePersistentValue(e,t):(t.transformer&&(e=De.transformTo(t.transformer,e)),this.client.preparePersistentValue(e,t))}prepareHydratedValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.prepareHydratedValue(e,t):(t.transformer&&(e=De.transformFrom(t.transformer,e)),this.client.prepareHydratedValue(e,t))}loadDependencies(){const e=this.options.driver||Ee.load("typeorm-aurora-data-api-driver"),{pg:t}=e;this.DataApiDriver=t}executeQuery(e,t){return this.connection.query(t)}async afterConnect(){const e=await this.checkMetadataForExtensions();return e.hasExtensions&&await this.enableExtensions(e,this.connection),Promise.resolve()}}class Oc extends yt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ot(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async executeSet(e){if(this.isReleased)throw new Be;return(await this.connect()).executeSet(e,!1)}async query(e,t,n=!1){if(this.isReleased)throw new Be;const i=await this.connect();this.driver.connection.logger.logQuery(e,t,this);const r=e.substring(0,e.indexOf(" ")!==-1?e.indexOf(" "):void 0);try{let s;["BEGIN","ROLLBACK","COMMIT","CREATE","ALTER","DROP"].indexOf(r)!==-1?s=await i.execute(e,!1):["INSERT","UPDATE","DELETE"].indexOf(r)!==-1?s=await i.run(e,t,!1):s=await i.query(e,t||[]);const a=new it;return s?.hasOwnProperty("values")&&(a.raw=s.values,a.records=s.values),s?.hasOwnProperty("changes")&&(a.affected=s.changes.changes,a.raw=s.changes.lastId||s.changes.changes),n?a:a.raw}catch(s){throw this.driver.connection.logger.logQueryError(s,e,t,this),new et(e,t,s)}}parametrize(e){return Object.keys(e).map(t=>`"${t}"=?`)}}class Ic extends Nt{constructor(e){super(e),this.database=this.options.database,this.driver=this.options.driver,this.sqlite=this.options.driver}async connect(){this.databaseConnection=this.createDatabaseConnection(),await this.databaseConnection}async disconnect(){return this.queryRunner=void 0,(await this.databaseConnection).close().then(()=>{this.databaseConnection=void 0})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Oc(this)),this.queryRunner}async createDatabaseConnection(){const e=this.options.mode||"no-encryption",t=e!=="no-encryption",n=typeof this.options.version>"u"?1:this.options.version,i=await this.sqlite.createConnection(this.options.database,t,e,n);return await i.open(),await i.execute("PRAGMA foreign_keys = ON"),this.options.journalMode&&["DELETE","TRUNCATE","PERSIST","MEMORY","WAL","OFF"].indexOf(this.options.journalMode)!==-1&&await i.execute(`PRAGMA journal_mode = ${this.options.journalMode}`),i}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new Tt("Capacitor","@capacitor-community/sqlite")}}class Dc extends Zt{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new ot(this)}async connect(){if(this.session)return Promise.resolve(this.session);const[e]=await this.driver.instanceDatabase.createSession({});return this.session=e,this.sessionTransaction=await e.transaction(),this.session}async release(){return this.isReleased=!0,this.session&&await this.session.delete(),this.session=void 0,Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}await this.connect(),await this.sessionTransaction.begin(),this.connection.logger.logQuery("START TRANSACTION"),await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),await this.sessionTransaction.commit(),this.connection.logger.logQuery("COMMIT"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),await this.sessionTransaction.rollback(),this.connection.logger.logQuery("ROLLBACK"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new Be;await this.connect(),this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const i=new Ge;try{const r=Date.now();let s;const a=e.startsWith("SELECT"),o=a&&!this.isTransactionActive?this.driver.instanceDatabase:this.sessionTransaction;!this.isTransactionActive&&!a&&await this.sessionTransaction.begin();try{s=await o.run({sql:e,params:t?t.reduce((m,y,g)=>(m["param"+g]=y,m),{}):void 0,json:!0}),!this.isTransactionActive&&!a&&await this.sessionTransaction.commit()}catch(m){try{!this.isTransactionActive&&!a&&await this.sessionTransaction.rollback()}catch{}throw m}const c=this.driver.options.maxQueryExecutionTime,l=Date.now()-r;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,l,s,void 0),c&&l>c&&this.driver.connection.logger.logQuerySlow(l,e,t,this);const h=new it;return h.raw=s,h.records=s?s[0]:[],s&&s[1]&&s[1].rowCountExact&&(h.affected=parseInt(s[1].rowCountExact)),n?h:h.records}catch(r){throw this.driver.connection.logger.logQueryError(r,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,r),new et(e,t,r)}finally{await i.wait()}}async updateDDL(e,t){if(this.isReleased)throw new Be;this.driver.connection.logger.logQuery(e,t,this);try{const n=Date.now(),[i]=await this.driver.instanceDatabase.updateSchema(e);await i.promise();const r=this.driver.options.maxQueryExecutionTime,a=Date.now()-n;r&&a>r&&this.driver.connection.logger.logQuerySlow(a,e,t,this)}catch(n){throw this.driver.connection.logger.logQueryError(n,e,t,this),new et(e,t,n)}}async stream(e,t,n,i){if(this.isReleased)throw new Be;try{this.driver.connection.logger.logQuery(e,t,this);const r={sql:e,params:t?t.reduce((a,o,c)=>(a["param"+c]=o,a),{}):void 0,json:!0},s=this.driver.instanceDatabase.runStream(r);return n&&s.on("end",n),i&&s.on("error",i),s}catch(r){throw this.driver.connection.logger.logQueryError(r,e,t,this),new et(e,t,r)}}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){throw new C("Check database queries are not supported by Spanner driver.")}async getCurrentDatabase(){throw new C("Check database queries are not supported by Spanner driver.")}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){throw new C("Check schema queries are not supported by Spanner driver.")}async hasTable(e){const n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` = '${e instanceof Se?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const i=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` = '${e instanceof Se?e.name:e}' AND \`COLUMN_NAME\` = '${t}'`;return!!(await this.query(i)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();const n=`CREATE DATABASE "${e}"`,i=`DROP DATABASE "${e}"`;await this.executeQueries(new N(n),new N(i))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,i=`CREATE DATABASE "${e}"`;await this.executeQueries(new N(n),new N(i))}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t,n){return Promise.resolve()}async createTable(e,t=!1,n=!0,i=!0){if(t&&await this.hasTable(e))return Promise.resolve();const r=[],s=[];r.push(this.createTableSql(e,n)),s.push(this.dropTableSql(e)),n&&e.foreignKeys.forEach(o=>s.push(this.dropForeignKeySql(e,o))),i&&e.indices.forEach(o=>{o.name||(o.name=this.connection.namingStrategy.indexName(e,o.columnNames,o.where)),r.push(this.createIndexSql(e,o)),s.push(this.dropIndexSql(e,o))});const a=e.columns.filter(o=>o.generatedType&&o.asExpression);for(const o of a){const c=this.insertTypeormMetadataSql({table:e.name,type:se.GENERATED_COLUMN,name:o.name,value:o.asExpression}),u=this.deleteTypeormMetadataSql({table:e.name,type:se.GENERATED_COLUMN,name:o.name});r.push(c),s.push(u)}await this.executeQueries(r,s)}async dropTable(e,t,n=!0,i=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const r=n,s=this.getTablePath(e),a=await this.getCachedTable(s),o=[],c=[];i&&a.indices.forEach(l=>{o.push(this.dropIndexSql(a,l)),c.push(this.createIndexSql(a,l))}),n&&a.foreignKeys.forEach(l=>o.push(this.dropForeignKeySql(a,l))),o.push(this.dropTableSql(a)),c.push(this.createTableSql(a,r));const u=a.columns.filter(l=>l.generatedType&&l.asExpression);for(const l of u){const h=this.deleteTypeormMetadataSql({table:a.name,type:se.GENERATED_COLUMN,name:l.name}),m=this.insertTypeormMetadataSql({table:a.name,type:se.GENERATED_COLUMN,name:l.name,value:l.asExpression});o.push(h),c.push(m)}await this.executeQueries(o,c)}async createView(e){const t=[],n=[];t.push(this.createViewSql(e)),t.push(await this.insertViewDefinitionSql(e)),n.push(this.dropViewSql(e)),n.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(t,n)}async dropView(e){const t=e instanceof lt?e.name:e,n=await this.getCachedView(t),i=[],r=[];i.push(await this.deleteViewDefinitionSql(n)),i.push(this.dropViewSql(n)),r.push(await this.insertViewDefinitionSql(n)),r.push(this.createViewSql(n)),await this.executeQueries(i,r)}async renameTable(e,t){throw new C("Rename table queries are not supported by Spanner driver.")}async addColumn(e,t){const n=e instanceof Se?e:await this.getCachedTable(e),i=n.clone(),r=[],s=[];r.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(t)}`)),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN ${this.driver.escape(t.name)}`));const a=i.indices.find(o=>o.columnNames.length===1&&o.columnNames[0]===t.name);if(a)r.push(this.createIndexSql(n,a)),s.push(this.dropIndexSql(n,a));else if(t.isUnique){const o=new Pe({name:this.connection.namingStrategy.indexName(n,[t.name]),columnNames:[t.name],isUnique:!0});i.indices.push(o),i.uniques.push(new Le({name:o.name,columnNames:o.columnNames})),r.push(this.createIndexSql(n,o)),s.push(this.dropIndexSql(n,o))}if(t.generatedType&&t.asExpression){const o=this.insertTypeormMetadataSql({table:n.name,type:se.GENERATED_COLUMN,name:t.name,value:t.asExpression}),c=this.deleteTypeormMetadataSql({table:n.name,type:se.GENERATED_COLUMN,name:t.name});r.push(o),s.push(c)}await this.executeQueries(r,s),i.addColumn(t),this.replaceCachedTable(n,i)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const i=e instanceof Se?e:await this.getCachedTable(e),r=t instanceof Fe?t:i.columns.find(a=>a.name===t);if(!r)throw new C(`Column "${t}" was not found in the "${i.name}" table.`);let s;return n instanceof Fe?s=n:(s=r.clone(),s.name=n),this.changeColumn(i,r,s)}async changeColumn(e,t,n){const i=e instanceof Se?e:await this.getCachedTable(e);let r=i.clone();const s=[],a=[],o=t instanceof Fe?t:i.columns.find(c=>c.name===t);if(!o)throw new C(`Column "${t}" was not found in the "${i.name}" table.`);if(o.name!==n.name||o.type!==n.type||o.length!==n.length||o.isArray!==n.isArray||o.generatedType!==n.generatedType||o.asExpression!==n.asExpression)await this.dropColumn(i,o),await this.addColumn(i,n),r=i.clone();else if((n.precision!==o.precision||n.scale!==o.scale)&&(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(o)}`))),o.isNullable!==n.isNullable&&(n.isNullable?(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${o.name}" DROP NOT NULL`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${o.name}" SET NOT NULL`))):(s.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${o.name}" SET NOT NULL`)),a.push(new N(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${o.name}" DROP NOT NULL`)))),n.isUnique!==o.isUnique)if(n.isUnique===!0){const c=new Pe({name:this.connection.namingStrategy.indexName(i,[n.name]),columnNames:[n.name],isUnique:!0});r.indices.push(c),r.uniques.push(new Le({name:c.name,columnNames:c.columnNames})),s.push(this.createIndexSql(i,c)),a.push(this.dropIndexSql(i,c))}else{const c=r.indices.find(l=>l.columnNames.length===1&&l.isUnique===!0&&!!l.columnNames.find(h=>h===n.name));r.indices.splice(r.indices.indexOf(c),1);const u=r.uniques.find(l=>l.name===c.name);r.uniques.splice(r.uniques.indexOf(u),1),s.push(this.dropIndexSql(i,c)),a.push(this.createIndexSql(i,c))}await this.executeQueries(s,a),this.replaceCachedTable(i,r)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:i}of t)await this.changeColumn(e,n,i)}async dropColumn(e,t){const n=e instanceof Se?e:await this.getCachedTable(e),i=t instanceof Fe?t:n.findColumnByName(t);if(!i)throw new C(`Column "${t}" was not found in table "${n.name}"`);const r=n.clone(),s=[],a=[],o=r.indices.find(u=>u.columnNames.length===1&&u.columnNames[0]===i.name);o&&(r.indices.splice(r.indices.indexOf(o),1),s.push(this.dropIndexSql(n,o)),a.push(this.createIndexSql(n,o)));const c=r.checks.find(u=>!!u.columnNames&&u.columnNames.length===1&&u.columnNames[0]===i.name);if(c&&(r.checks.splice(r.checks.indexOf(c),1),s.push(this.dropCheckConstraintSql(n,c)),a.push(this.createCheckConstraintSql(n,c))),s.push(new N(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN ${this.driver.escape(i.name)}`)),a.push(new N(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(i)}`)),i.generatedType&&i.asExpression){const u=this.deleteTypeormMetadataSql({table:n.name,type:se.GENERATED_COLUMN,name:i.name}),l=this.insertTypeormMetadataSql({table:n.name,type:se.GENERATED_COLUMN,name:i.name,value:i.asExpression});s.push(u),a.push(l)}await this.executeQueries(s,a),r.removeColumn(i),this.replaceCachedTable(n,r)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async updatePrimaryKeys(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async dropPrimaryKey(e){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async createUniqueConstraint(e,t){throw new C("Spanner does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new C("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new C("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new C("Spanner does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){const n=e instanceof Se?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(n,t.expression));const i=this.createCheckConstraintSql(n,t),r=this.dropCheckConstraintSql(n,t);await this.executeQueries(i,r),n.addCheckConstraint(t)}async createCheckConstraints(e,t){const n=t.map(i=>this.createCheckConstraint(e,i));await Promise.all(n)}async dropCheckConstraint(e,t){const n=e instanceof Se?e:await this.getCachedTable(e),i=t instanceof tt?t:n.checks.find(a=>a.name===t);if(!i)throw new C(`Supplied check constraint was not found in table ${n.name}`);const r=this.dropCheckConstraintSql(n,i),s=this.createCheckConstraintSql(n,i);await this.executeQueries(r,s),n.removeCheckConstraint(i)}async dropCheckConstraints(e,t){const n=t.map(i=>this.dropCheckConstraint(e,i));await Promise.all(n)}async createExclusionConstraint(e,t){throw new C("Spanner does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new C("Spanner does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new C("Spanner does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new C("Spanner does not support exclusion constraints.")}async createForeignKey(e,t){const n=e instanceof Se?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames,this.getTablePath(t),t.referencedColumnNames));const i=this.createForeignKeySql(n,t),r=this.dropForeignKeySql(n,t);await this.executeQueries(i,r),n.addForeignKey(t)}async createForeignKeys(e,t){for(const n of t)await this.createForeignKey(e,n)}async dropForeignKey(e,t){const n=e instanceof Se?e:await this.getCachedTable(e),i=t instanceof We?t:n.foreignKeys.find(a=>a.name===t);if(!i)throw new C(`Supplied foreign key was not found in table ${n.name}`);const r=this.dropForeignKeySql(n,i),s=this.createForeignKeySql(n,i);await this.executeQueries(r,s),n.removeForeignKey(i)}async dropForeignKeys(e,t){for(const n of[...t])await this.dropForeignKey(e,n)}async createIndex(e,t){const n=e instanceof Se?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createIndexSql(n,t),r=this.dropIndexSql(n,t);await this.executeQueries(i,r),n.addIndex(t)}async createIndices(e,t){for(const n of t)await this.createIndex(e,n)}async dropIndex(e,t){const n=e instanceof Se?e:await this.getCachedTable(e),i=t instanceof Pe?t:n.indices.find(a=>a.name===t);if(!i)throw new C(`Supplied index ${t} was not found in table ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(n,i),s=this.createIndexSql(n,i);await this.executeQueries(r,s),n.removeIndex(i)}async dropIndices(e,t){for(const n of[...t])await this.dropIndex(e,n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)} WHERE true`)}async clearDatabase(){const t=await this.query("SELECT concat('DROP INDEX `', INDEX_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`INDEXES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `INDEX_TYPE` = 'INDEX' AND `SPANNER_IS_MANAGED` = false"),i=await this.query("SELECT concat('ALTER TABLE `', TABLE_NAME, '`', ' DROP CONSTRAINT `', CONSTRAINT_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLE_CONSTRAINTS` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `CONSTRAINT_TYPE` = 'FOREIGN KEY'"),s=await this.query("SELECT concat('DROP TABLE `', TABLE_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'");if(!t.length&&!i.length&&!s.length)return;const a=this.isTransactionActive;a||await this.startTransaction();try{for(const o of t)await this.updateDDL(o.query);for(const o of i)await this.updateDDL(o.query);for(const o of s)await this.updateDDL(o.query);await this.commitTransaction()}catch(o){try{a||await this.rollbackTransaction()}catch{}throw o}}async executeMemoryUpSql(){for(const{query:e,parameters:t}of this.sqlInMemory.upQueries)this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async executeMemoryDownSql(){for(const{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async loadViews(e){return Promise.resolve([])}async loadTables(e){if(e&&e.length===0)return[];const t=[];if(!e||!e.length)t.push(...await this.query("SELECT `TABLE_NAME` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'"));else{const y=`SELECT \`TABLE_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` IN (${e.map(g=>`'${g}'`).join(", ")})`;t.push(...await this.query(y))}if(!t.length)return[];const n=t.map(y=>`'${y.TABLE_NAME}'`).join(", "),i=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` IN (${n})`,r=`SELECT \`KCU\`.\`TABLE_NAME\`, \`KCU\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'PRIMARY KEY' AND \`TC\`.\`TABLE_NAME\` IN (${n})`,s=`SELECT \`I\`.\`TABLE_NAME\`, \`I\`.\`INDEX_NAME\`, \`I\`.\`IS_UNIQUE\`, \`I\`.\`IS_NULL_FILTERED\`, \`IC\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`INDEXES\` \`I\` INNER JOIN \`INFORMATION_SCHEMA\`.\`INDEX_COLUMNS\` \`IC\` ON \`IC\`.\`INDEX_NAME\` = \`I\`.\`INDEX_NAME\` AND \`IC\`.\`TABLE_NAME\` = \`I\`.\`TABLE_NAME\` WHERE \`I\`.\`TABLE_CATALOG\` = '' AND \`I\`.\`TABLE_SCHEMA\` = '' AND \`I\`.\`TABLE_NAME\` IN (${n}) AND \`I\`.\`INDEX_TYPE\` = 'INDEX' AND \`I\`.\`SPANNER_IS_MANAGED\` = false`,a=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`CC\`.\`CHECK_CLAUSE\`, \`CCU\`.\`COLUMN_NAME\`FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CHECK_CONSTRAINTS\` \`CC\` ON \`CC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'CHECK' AND \`TC\`.\`TABLE_NAME\` IN (${n}) AND \`TC\`.\`CONSTRAINT_NAME\` NOT LIKE 'CK_IS_NOT_NULL%'`,o=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`KCU\`.\`COLUMN_NAME\`, \`CTU\`.\`TABLE_NAME\` AS \`REFERENCED_TABLE_NAME\`, \`CCU\`.\`COLUMN_NAME\` AS \`REFERENCED_COLUMN_NAME\`, \`RC\`.\`UPDATE_RULE\`, \`RC\`.\`DELETE_RULE\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_TABLE_USAGE\` \`CTU\` ON \`CTU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`RC\` ON \`RC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'FOREIGN KEY' AND \`TC\`.\`TABLE_NAME\` IN (${n})`,[c,u,l,h,m]=await Promise.all([this.query(i),this.query(r),this.query(s),this.query(a),this.query(o)]);return Promise.all(t.map(async y=>{const g=new Se;g.name=this.driver.buildTableName(y.TABLE_NAME),g.columns=await Promise.all(c.filter(M=>M.TABLE_NAME===y.TABLE_NAME).map(async M=>{const U=l.filter(Y=>Y.TABLE_NAME===y.TABLE_NAME&&Y.COLUMN_NAME===M.COLUMN_NAME&&Y.IS_UNIQUE===!0),F=this.connection.entityMetadatas.find(Y=>this.getTablePath(g)===this.getTablePath(Y)),J=U.length>0&&F&&F.indices.some(Y=>U.some(S=>Y.name===S.INDEX_NAME&&Y.synchronize===!1)),K=U.every(Y=>l.some(S=>S.INDEX_NAME===Y.INDEX_NAME&&S.COLUMN_NAME!==M.COLUMN_NAME)),re=new Fe;re.name=M.COLUMN_NAME;let $=M.SPANNER_TYPE.toLowerCase();if($.indexOf("array")!==-1&&(re.isArray=!0,$=$.substring($.indexOf("<")+1,$.indexOf(">"))),$.indexOf("(")!==-1?re.type=$.substring(0,$.indexOf("(")):re.type=$,this.driver.withLengthColumnTypes.indexOf(re.type)!==-1&&(re.length=$.substring($.indexOf("(")+1,$.indexOf(")"))),M.IS_GENERATED==="ALWAYS"){re.asExpression=M.GENERATION_EXPRESSION,re.generatedType="STORED";const Y=this.selectTypeormMetadataSql({table:y.TABLE_NAME,type:se.GENERATED_COLUMN,name:re.name}),S=await this.query(Y.query,Y.parameters);S[0]&&S[0].value?re.asExpression=S[0].value:re.asExpression=""}return re.isUnique=U.length>0&&!J&&!K,re.isNullable=M.IS_NULLABLE==="YES",re.isPrimary=u.some(Y=>Y.TABLE_NAME===M.TABLE_NAME&&Y.COLUMN_NAME===M.COLUMN_NAME),re}));const b=m.filter(M=>M.TABLE_NAME===y.TABLE_NAME);g.foreignKeys=Q.uniq(b,M=>M.CONSTRAINT_NAME).map(M=>{const U=b.filter(F=>F.CONSTRAINT_NAME===M.CONSTRAINT_NAME);return new We({name:M.CONSTRAINT_NAME,columnNames:Q.uniq(U.map(F=>F.COLUMN_NAME)),referencedDatabase:M.REFERENCED_TABLE_SCHEMA,referencedTableName:M.REFERENCED_TABLE_NAME,referencedColumnNames:Q.uniq(U.map(F=>F.REFERENCED_COLUMN_NAME)),onDelete:M.DELETE_RULE,onUpdate:M.UPDATE_RULE})});const R=l.filter(M=>M.TABLE_NAME===y.TABLE_NAME);g.indices=Q.uniq(R,M=>M.INDEX_NAME).map(M=>{const U=R.filter(F=>F.INDEX_NAME===M.INDEX_NAME);return new Pe({table:g,name:M.INDEX_NAME,columnNames:U.map(F=>F.COLUMN_NAME),isUnique:M.IS_UNIQUE,isNullFiltered:M.IS_NULL_FILTERED})});const P=h.filter(M=>M.TABLE_NAME===y.TABLE_NAME);return g.checks=Q.uniq(P,M=>M.CONSTRAINT_NAME).map(M=>{const U=P.filter(F=>F.CONSTRAINT_NAME===M.CONSTRAINT_NAME);return new tt({name:M.CONSTRAINT_NAME,columnNames:U.map(F=>F.COLUMN_NAME),expression:M.CHECK_CLAUSE})}),g}))}createTableSql(e,t){const n=e.columns.map(s=>this.buildCreateColumnSql(s)).join(", ");let i=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(s=>s.isUnique).forEach(s=>{const a=e.indices.some(c=>c.columnNames.length===1&&!!c.isUnique&&c.columnNames.indexOf(s.name)!==-1),o=e.uniques.some(c=>c.columnNames.length===1&&c.columnNames.indexOf(s.name)!==-1);!a&&!o&&e.indices.push(new Pe({name:this.connection.namingStrategy.uniqueConstraintName(e,[s.name]),columnNames:[s.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(s=>{e.indices.some(o=>o.name===s.name)||e.indices.push(new Pe({name:s.name,columnNames:s.columnNames,isUnique:!0}))}),e.checks.length>0){const s=e.checks.map(a=>`CONSTRAINT \`${a.name?a.name:this.connection.namingStrategy.checkConstraintName(e,a.expression)}\` CHECK (${a.expression})`).join(", ");i+=`, ${s}`}if(e.foreignKeys.length>0&&t){const s=e.foreignKeys.map(a=>{const o=a.columnNames.map(u=>`\`${u}\``).join(", ");a.name||(a.name=this.connection.namingStrategy.foreignKeyName(e,a.columnNames,this.getTablePath(a),a.referencedColumnNames));const c=a.referencedColumnNames.map(u=>`\`${u}\``).join(", ");return`CONSTRAINT \`${a.name}\` FOREIGN KEY (${o}) REFERENCES ${this.escapePath(this.getTablePath(a))} (${c})`}).join(", ");i+=`, ${s}`}i+=")";const r=e.columns.filter(s=>s.isPrimary);if(r.length>0){const s=r.map(a=>this.driver.escape(a.name)).join(", ");i+=` PRIMARY KEY (${s})`}return new N(i)}dropTableSql(e){return new N(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){const t=e.materialized?"MATERIALIZED ":"",n=this.escapePath(e),i=typeof e.expression=="string"?e.expression:e.expression(this.connection).getQuery();return new N(`CREATE ${t}VIEW ${n} SQL SECURITY INVOKER AS ${i}`)}async insertViewDefinitionSql(e){const{schema:t,tableName:n}=this.driver.parseTableName(e),i=e.materialized?se.MATERIALIZED_VIEW:se.VIEW,r=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:i,schema:t,name:n,value:r})}dropViewSql(e){const t=e.materialized?"MATERIALIZED ":"";return new N(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const{schema:t,tableName:n}=this.driver.parseTableName(e),i=e.materialized?se.MATERIALIZED_VIEW:se.VIEW;return this.deleteTypeormMetadataSql({type:i,schema:t,name:n})}createIndexSql(e,t){const n=t.columnNames.map(r=>this.driver.escape(r)).join(", ");let i="";return t.isUnique&&(i+="UNIQUE "),t.isNullFiltered&&(i+="NULL_FILTERED "),new N(`CREATE ${i}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${n})`)}dropIndexSql(e,t){const n=t instanceof Pe?t.name:t;return new N(`DROP INDEX \`${n}\``)}createCheckConstraintSql(e,t){return new N(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){const n=t instanceof tt?t.name:t;return new N(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${n}\``)}createForeignKeySql(e,t){const n=t.columnNames.map(s=>this.driver.escape(s)).join(", "),i=t.referencedColumnNames.map(s=>this.driver.escape(s)).join(","),r=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))} (${i})`;return new N(r)}dropForeignKeySql(e,t){const n=t instanceof We?t.name:t;return new N(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${n}\``)}escapePath(e){const{tableName:t}=this.driver.parseTableName(e);return`\`${t}\``}buildCreateColumnSql(e){let t=`${this.driver.escape(e.name)} ${this.connection.driver.createFullType(e)}`;return e.generatedType==="STORED"&&e.asExpression?t+=` AS (${e.asExpression}) STORED`:e.isNullable||(t+=" NOT NULL"),t}async executeQueries(e,t){if(e instanceof N&&(e=[e]),t instanceof N&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(const{query:n,parameters:i}of e)this.isDMLQuery(n)?await this.query(n,i):await this.updateDDL(n,i)}isDMLQuery(e){return e.startsWith("INSERT")||e.startsWith("UPDATE")||e.startsWith("DELETE")}changeTableComment(e,t){throw new C("spanner driver does not support change table comment.")}}class qc{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="none",this.supportedDataTypes=["bool","int64","float64","numeric","string","json","bytes","date","timestamp","array"],this.supportedUpsertTypes=[],this.spatialTypes=[],this.withLengthColumnTypes=["string","bytes"],this.withPrecisionColumnTypes=[],this.withScaleColumnTypes=[],this.mappedDataTypes={createDate:"timestamp",createDateDefault:"",updateDate:"timestamp",updateDateDefault:"",deleteDate:"timestamp",deleteDateNullable:!0,version:"int64",treeLevel:"int64",migrationId:"int64",migrationName:"string",migrationTimestamp:"int64",cacheId:"string",cacheIdentifier:"string",cacheTime:"int64",cacheDuration:"int64",cacheQuery:"string",cacheResult:"string",metadataType:"string",metadataDatabase:"string",metadataSchema:"string",metadataTable:"string",metadataName:"string",metadataValue:"string"},this.parametersPrefix="@param",this.dataTypeDefaults={},this.maxAliasLength=63,this.cteCapabilities={enabled:!0},this.connection=e,this.options=e.options,this.isReplicated=!!this.options.replication,this.loadDependencies()}async connect(){this.instance=this.spanner.instance(this.options.instanceId),this.instanceDatabase=this.instance.database(this.options.databaseId)}afterConnect(){return Promise.resolve()}async disconnect(){this.instanceDatabase.close()}createSchemaBuilder(){return new Xt(this.connection)}createQueryRunner(e){return new Dc(this,e)}escapeQueryWithParameters(e,t,n){const i=Object.keys(n).map(s=>n[s]);if(!t||!Object.keys(t).length)return[e,i];const r=new Map;return e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(s,a,o)=>{if(!t.hasOwnProperty(o))return s;if(r.has(o))return this.parametersPrefix+r.get(o);const c=t[o];return c===null?s:a?c.map(u=>(i.push(u),this.createParameter(o,i.length-1))).join(", "):c instanceof Function?c():(i.push(c),r.set(o,i.length-1),this.createParameter(o,i.length-1))}),e=e.replace(/([ ]+)?=([ ]+)?:(\.\.\.)?([A-Za-z0-9_.]+)/g,(s,a,o,c,u)=>t.hasOwnProperty(u)&&t[u]===null?" IS NULL":s),[e,i]}escape(e){return`\`${e}\``}buildTableName(e,t,n){const i=[e];return n&&i.unshift(n),i.join(".")}parseTableName(e){const t=this.database,n=void 0;if(e instanceof Se||e instanceof lt){const r=this.parseTableName(e.name);return{database:e.database||r.database||t,schema:e.schema||r.schema||n,tableName:r.tableName}}if(e instanceof We){const r=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||r.database||t,schema:e.referencedSchema||r.schema||n,tableName:r.tableName}}if(e instanceof nt)return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const i=e.split(".");return{database:(i.length>1?i[0]:void 0)||t,schema:n,tableName:i.length>1?i[1]:i[0]}}preparePersistentValue(e,t){return t.transformer&&(e=De.transformTo(t.transformer,e)),e==null?e:t.type==="numeric"?(this.options.driver||Ee.load("spanner")).Spanner.numeric(e.toString()):t.type==="date"?ne.mixedDateToDateString(e):t.type==="json"?e:t.type==="timestamp"||t.type===Date?ne.mixedDateToDate(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?De.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="bool"?e=!!e:t.type==="timestamp"||t.type===Date?e=new Date(e):t.type==="numeric"?e=e.value:t.type==="date"?e=ne.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=De.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number?"int64":e.type===String||e.type==="uuid"?"string":e.type===Date?"timestamp":e.type===Buffer?"bytes":e.type===Boolean?"bool":e.type||""}normalizeDefault(e){return e.default===""?`"${e.default}"`:`${e.default}`}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"string":case"bytes":return"max";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t=`array<${t}>`),t}obtainMasterConnection(){return this.instanceDatabase}obtainSlaveConnection(){return this.instanceDatabase}createGeneratedMap(e,t,n){if(!t)return;if(t.insertId===void 0)return Object.keys(t).reduce((r,s)=>{const a=e.findColumnWithDatabaseName(s);return a&&Q.mergeDeep(r,a.createValueMap(t[s])),r},{});const i=e.generatedColumns.reduce((r,s)=>{let a;return s.generationStrategy==="increment"&&t.insertId&&(a=t.insertId+n),Q.mergeDeep(r,s.createValueMap(a))},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{const i=e.find(s=>s.name===n.databaseName);return i?i.name!==n.databaseName||i.type!==this.normalizeType(n)||i.length!==this.getColumnLength(n)||i.asExpression!==n.asExpression||i.generatedType!==n.generatedType||i.isPrimary!==n.isPrimary||!this.compareNullableValues(n,i)||i.isUnique!==this.normalizeIsUnique(n):!1})}isReturningSqlSupported(){return!0}isUUIDGenerationSupported(){return!0}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return this.parametersPrefix+t}loadDependencies(){try{const e=this.options.driver||Ee.load("spanner");if(this.options.credentials){this.spanner=new e.Spanner({projectId:this.options.projectId,credentials:this.options.credentials});return}this.spanner=new e.Spanner({projectId:this.options.projectId})}catch(e){throw console.error(e),new Tt("Spanner","@google-cloud/spanner")}}compareNullableValues(e,t){return e.generatedType?!0:e.isNullable===t.isNullable}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}normalizeDatetimeFunction(e){if(!e)return e;if(e.toUpperCase().indexOf("CURRENT_TIMESTAMP")!==-1||e.toUpperCase().indexOf("NOW")!==-1){const n=e.match(/\(\d+\)/);return n?`CURRENT_TIMESTAMP${n[0]}`:"CURRENT_TIMESTAMP"}else return e}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}}class $c{create(e){const{type:t}=e.options;switch(t){case"mysql":return new Gr(e);case"postgres":return new Bs(e);case"cockroachdb":return new _o(e);case"sap":return new Bo(e);case"mariadb":return new Gr(e);case"sqlite":return new Fo(e);case"better-sqlite3":return new jo(e);case"cordova":return new dc(e);case"nativescript":return new yc(e);case"react-native":return new mc(e);case"sqljs":return new Ec(e);case"oracle":return new Uo(e);case"mssql":return new Lo(e);case"mongodb":return new Do(e);case"expo":return new Ac(e).create();case"aurora-mysql":return new Sc(e);case"aurora-postgres":return new Pc(e);case"capacitor":return new Ic(e);case"spanner":return new qc(e);default:throw new oa(t,["aurora-mysql","aurora-postgres","better-sqlite3","capacitor","cockroachdb","cordova","expo","mariadb","mongodb","mssql","mysql","nativescript","oracle","postgres","react-native","sap","sqlite","sqljs","spanner"])}}}function mi(p,e,t=[".js",".cjs",".ts"]){return[]}const _c=new class{constructor(){this.instances=[]}get(p){let e=this.instances.find(t=>t.type===p);return e||(e={type:p,object:new p},this.instances.push(e)),e.object}};function ns(p){return _c.get(p)}class Ve{constructor(e){this["@instanceof"]=Symbol.for("ColumnMetadata"),this.length="",this.isPrimary=!1,this.isGenerated=!1,this.isNullable=!1,this.isSelect=!0,this.isInsert=!0,this.isUpdate=!0,this.zerofill=!1,this.unsigned=!1,this.isArray=!1,this.isVirtual=!1,this.isVirtualProperty=!1,this.isDiscriminator=!1,this.isTreeLevel=!1,this.isCreateDate=!1,this.isUpdateDate=!1,this.isDeleteDate=!1,this.isVersion=!1,this.isObjectId=!1,this.isNestedSetLeft=!1,this.isNestedSetRight=!1,this.isMaterializedPath=!1,this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.referencedColumn=e.referencedColumn,e.args.target&&(this.target=e.args.target),e.args.propertyName&&(this.propertyName=e.args.propertyName),e.args.options.name&&(this.givenDatabaseName=e.args.options.name),e.args.options.type&&(this.type=e.args.options.type),e.args.options.length&&(this.length=e.args.options.length?e.args.options.length.toString():""),e.args.options.width&&(this.width=e.args.options.width),e.args.options.charset&&(this.charset=e.args.options.charset),e.args.options.collation&&(this.collation=e.args.options.collation),e.args.options.primary&&(this.isPrimary=e.args.options.primary),e.args.options.default===null&&(this.isNullable=!0),e.args.options.nullable!==void 0&&(this.isNullable=e.args.options.nullable),e.args.options.select!==void 0&&(this.isSelect=e.args.options.select),e.args.options.insert!==void 0&&(this.isInsert=e.args.options.insert),e.args.options.update!==void 0&&(this.isUpdate=e.args.options.update),e.args.options.readonly!==void 0&&(this.isUpdate=!e.args.options.readonly),e.args.options.comment&&(this.comment=e.args.options.comment),e.args.options.default!==void 0&&(this.default=e.args.options.default),e.args.options.onUpdate&&(this.onUpdate=e.args.options.onUpdate),e.args.options.generatedIdentity&&(this.generatedIdentity=e.args.options.generatedIdentity),e.args.options.scale!==null&&e.args.options.scale!==void 0&&(this.scale=e.args.options.scale),e.args.options.zerofill&&(this.zerofill=e.args.options.zerofill,this.unsigned=!0),e.args.options.unsigned&&(this.unsigned=e.args.options.unsigned),e.args.options.precision!==null&&(this.precision=e.args.options.precision),e.args.options.enum&&(oe.isObject(e.args.options.enum)&&!Array.isArray(e.args.options.enum)?this.enum=Object.keys(e.args.options.enum).filter(t=>isNaN(+t)&&typeof e.args.options.enum[t]!="function").map(t=>e.args.options.enum[t]):this.enum=e.args.options.enum),e.args.options.enumName&&(this.enumName=e.args.options.enumName),e.args.options.primaryKeyConstraintName&&(this.primaryKeyConstraintName=e.args.options.primaryKeyConstraintName),e.args.options.foreignKeyConstraintName&&(this.foreignKeyConstraintName=e.args.options.foreignKeyConstraintName),e.args.options.asExpression&&(this.asExpression=e.args.options.asExpression,this.generatedType=e.args.options.generatedType?e.args.options.generatedType:"VIRTUAL"),e.args.options.hstoreType&&(this.hstoreType=e.args.options.hstoreType),e.args.options.array&&(this.isArray=e.args.options.array),e.args.mode&&(this.isVirtualProperty=e.args.mode==="virtual-property",this.isVirtual=e.args.mode==="virtual",this.isTreeLevel=e.args.mode==="treeLevel",this.isCreateDate=e.args.mode==="createDate",this.isUpdateDate=e.args.mode==="updateDate",this.isDeleteDate=e.args.mode==="deleteDate",this.isVersion=e.args.mode==="version",this.isObjectId=e.args.mode==="objectId"),this.isVirtualProperty&&(this.isInsert=!1,this.isUpdate=!1),e.args.options.transformer&&(this.transformer=e.args.options.transformer),e.args.options.spatialFeatureType&&(this.spatialFeatureType=e.args.options.spatialFeatureType),e.args.options.srid!==void 0&&(this.srid=e.args.options.srid),e.args.options.query&&(this.query=e.args.options.query),this.isTreeLevel&&(this.type=e.connection.driver.mappedDataTypes.treeLevel),this.isCreateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.createDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.createDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.createDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.createDatePrecision)),this.isUpdateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.updateDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.updateDateDefault),this.onUpdate||(this.onUpdate=e.connection.driver.mappedDataTypes.updateDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.updateDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.updateDatePrecision)),this.isDeleteDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.deleteDate),this.isNullable||(this.isNullable=e.connection.driver.mappedDataTypes.deleteDateNullable),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.deleteDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.deleteDatePrecision)),this.isVersion&&(this.type=e.connection.driver.mappedDataTypes.version),e.closureType&&(this.closureType=e.closureType),e.nestedSetLeft&&(this.isNestedSetLeft=e.nestedSetLeft),e.nestedSetRight&&(this.isNestedSetRight=e.nestedSetRight),e.materializedPath&&(this.isMaterializedPath=e.materializedPath)}createValueMap(e,t=!1){if(this.embeddedMetadata){const n=[...this.embeddedMetadata.parentPropertyNames],i=(r,s)=>{const a=r.shift();return a?(s[a]={},i(r,s[a]),s):((this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),s[t?this.databaseName:this.propertyName]=e,s)};return i(n,{})}else return(this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),{[t?this.databaseName:this.propertyName]:e}}getEntityValueMap(e,t){if(this.embeddedMetadata){const i=[...this.embeddedMetadata.parentPropertyNames],r=this.embeddedMetadata.isArray,s=(o,c)=>{if(c===void 0)return{};const u=o.shift();if(u){const l=s(o,c[u]);return Object.keys(l).length>0?{[u]:l}:{}}return r&&Array.isArray(c)?c.map(l=>({[this.propertyName]:l[this.propertyName]})):c[this.propertyName]!==void 0?{[this.propertyName]:c[this.propertyName]}:{}},a=s(i,e);return Object.keys(a).length>0?a:void 0}else if(this.relationMetadata&&!Object.getOwnPropertyDescriptor(e,this.relationMetadata.propertyName)?.get&&e[this.relationMetadata.propertyName]&&oe.isObject(e[this.relationMetadata.propertyName])){if(this.relationMetadata.joinColumns.length>1){const i=this.relationMetadata.joinColumns.reduce((r,s)=>{const a=s.referencedColumn.getEntityValueMap(e[this.relationMetadata.propertyName]);return a===void 0?r:Q.mergeDeep(r,a)},{});if(Object.keys(i).length>0)return{[this.propertyName]:i}}else{const i=this.relationMetadata.joinColumns[0].referencedColumn.getEntityValue(e[this.relationMetadata.propertyName]);if(i)return{[this.propertyName]:i}}return}else return e[this.propertyName]!==void 0?{[this.propertyName]:e[this.propertyName]}:void 0}getEntityValue(e,t=!1){if(e==null)return;let n;if(this.embeddedMetadata){const i=[...this.embeddedMetadata.parentPropertyNames],r=this.embeddedMetadata.isArray,s=(o,c)=>{const u=o.shift();return u&&c?s(o,c[u]):c},a=s(i,e);if(a)if(this.relationMetadata&&this.referencedColumn){const o=this.relationMetadata.getEntityValue(a);o&&oe.isObject(o)&&!v.isFindOperator(o)&&!Buffer.isBuffer(o)?n=this.referencedColumn.getEntityValue(o):a[this.propertyName]&&oe.isObject(a[this.propertyName])&&!v.isFindOperator(a[this.propertyName])&&!Buffer.isBuffer(a[this.propertyName])&&!(a[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(a[this.propertyName]):n=a[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(a[this.propertyName]):r&&Array.isArray(a)?n=a.map(o=>o[this.propertyName]):n=a[this.propertyName]}else if(this.relationMetadata&&this.referencedColumn){const i=this.relationMetadata.getEntityValue(e);i&&oe.isObject(i)&&!v.isFindOperator(i)&&typeof i!="function"&&!Buffer.isBuffer(i)?n=this.referencedColumn.getEntityValue(i):e[this.propertyName]&&oe.isObject(e[this.propertyName])&&!v.isFindOperator(e[this.propertyName])&&typeof e[this.propertyName]!="function"&&!Buffer.isBuffer(e[this.propertyName])&&!(e[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName];return t&&this.transformer&&(n=De.transformTo(this.transformer,n)),n}setEntityValue(e,t){if(this.embeddedMetadata){const n=(i,r)=>{const s=i.shift();return s?(r[s.propertyName]||(r[s.propertyName]=s.create()),n(i,r[s.propertyName]),r):(r[this.propertyName]=t,r)};return n([...this.embeddedMetadata.embeddedMetadataTree],e)}else!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName?(this.propertyName in e||(e[this.propertyName]={}),e[this.propertyName][this.referencedColumn.propertyName]=t):e[this.propertyName]=t}compareEntityValue(e,t){const n=this.getEntityValue(e);return typeof n?.equals=="function"?n.equals(t):n===t}build(e){return this.propertyPath=this.buildPropertyPath(),this.propertyAliasName=this.propertyPath.replace(".","_"),this.databaseName=this.buildDatabaseName(e),this.databasePath=this.buildDatabasePath(),this.databaseNameWithoutPrefixes=e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,[]),this}buildPropertyPath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.propertyName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName&&(e+="."+this.referencedColumn.propertyName),e}buildDatabasePath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.databaseName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.databaseName!==this.databaseName&&(e+="."+this.referencedColumn.databaseName),e}buildDatabaseName(e){let t=this.embeddedMetadata?this.embeddedMetadata.parentPrefixes:[];return e.driver.options.type==="mongodb"&&(t=[]),e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,t)}}class Xe{constructor(e){this.isUnique=!1,this.isSpatial=!1,this.isFulltext=!1,this.isNullFiltered=!1,this.synchronize=!0,this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,e.args.synchronize!==null&&e.args.synchronize!==void 0&&(this.synchronize=e.args.synchronize),this.isUnique=!!e.args.unique,this.isSpatial=!!e.args.spatial,this.isFulltext=!!e.args.fulltext,this.isNullFiltered=!!e.args.nullFiltered,this.parser=e.args.parser,this.where=e.args.where,this.isSparse=e.args.sparse,this.isBackground=e.args.background,this.isConcurrent=e.args.concurrent,this.expireAfterSeconds=e.args.expireAfterSeconds,this.givenName=e.args.name,this.givenColumnNames=e.args.columns)}build(e){if(this.synchronize===!1)return this.name=this.givenName,this;const t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(i=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+i:i.trim()),n.forEach(i=>t[i]=1);else{const i=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(i)?(n=i.map(r=>String(r)),n.forEach(r=>t[r]=1)):(n=Object.keys(i).map(r=>String(r)),Object.keys(i).forEach(r=>t[r]=i[r]))}this.columns=n.map(i=>{const r=this.entityMetadata.columns.find(c=>c.propertyPath===i);if(r)return[r];const s=this.entityMetadata.relations.find(c=>c.isWithJoinColumn&&c.propertyName===i);if(s)return s.joinColumns;const a=this.givenName?'"'+this.givenName+'" ':"",o=this.entityMetadata.targetName;throw new C(`Index ${a}contains column that is missing in the entity (${o}): `+i)}).reduce((i,r)=>i.concat(r))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,i)=>{const r=this.entityMetadata.columns.find(s=>s.propertyPath===i);return r&&(n[r.databasePath]=t[i]),n},{}),this.name=this.givenName?this.givenName:e.indexName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName),this.where),this}}class is{constructor(e){this.isTreeParent=!1,this.isTreeChildren=!1,this.isPrimary=!1,this.isLazy=!1,this.isEager=!1,this.persistenceEnabled=!0,this.isCascadeInsert=!1,this.isCascadeUpdate=!1,this.isCascadeRemove=!1,this.isCascadeSoftRemove=!1,this.isCascadeRecover=!1,this.isNullable=!0,this.createForeignKeyConstraints=!0,this.isOwning=!1,this.isOneToOne=!1,this.isOneToOneOwner=!1,this.isWithJoinColumn=!1,this.isOneToOneNotOwner=!1,this.isOneToMany=!1,this.isManyToOne=!1,this.isManyToMany=!1,this.isManyToManyOwner=!1,this.isManyToManyNotOwner=!1,this.foreignKeys=[],this.joinColumns=[],this.inverseJoinColumns=[],this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata;const t=e.args;this.target=t.target,this.propertyName=t.propertyName,this.relationType=t.relationType,t.inverseSideProperty&&(this.givenInverseSidePropertyFactory=t.inverseSideProperty),this.isLazy=t.isLazy||!1,this.isCascadeInsert=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("insert")!==-1,this.isCascadeUpdate=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("update")!==-1,this.isCascadeRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("remove")!==-1,this.isCascadeSoftRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("soft-remove")!==-1,this.isCascadeRecover=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("recover")!==-1,this.isNullable=!(t.options.nullable===!1||this.isPrimary),this.onDelete=t.options.onDelete,this.onUpdate=t.options.onUpdate,this.deferrable=t.options.deferrable,this.createForeignKeyConstraints=t.options.createForeignKeyConstraints!==!1,this.isEager=t.options.eager||!1,this.persistenceEnabled=t.options.persistence!==!1,this.orphanedRowAction=t.options.orphanedRowAction||"nullify",this.isTreeParent=t.isTreeParent||!1,this.isTreeChildren=t.isTreeChildren||!1,typeof t.type=="function"?this.type=typeof t.type=="function"?t.type():t.type:v.isEntitySchema(t.type)?this.type=t.type.options.name:oe.isObject(t.type)&&typeof t.type.name=="string"?this.type=t.type.name:this.type=t.type,this.isOneToOne=this.relationType==="one-to-one",this.isOneToMany=this.relationType==="one-to-many",this.isManyToOne=this.relationType==="many-to-one",this.isManyToMany=this.relationType==="many-to-many",this.isOneToOneNotOwner=!!this.isOneToOne,this.isManyToManyNotOwner=!!this.isManyToMany}getRelationIdMap(e){const n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(i=>i.referencedColumn);return nt.getValueMap(e,n)}ensureRelationIdMap(e){if(oe.isObject(e))return e;const n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(i=>i.referencedColumn);if(n.length>1)throw new C("Cannot create relation id map for a single value because relation contains multiple referenced columns.");return n[0].createValueMap(e)}getEntityValue(e,t=!1){if(e!=null)if(this.embeddedMetadata){const n=[...this.embeddedMetadata.parentPropertyNames],i=(s,a)=>{const o=s.shift();return o?a[o]?i(s,a[o]):void 0:a},r=i(n,e);return this.isLazy?r["__"+this.propertyName+"__"]!==void 0?r["__"+this.propertyName+"__"]:t===!0?r[this.propertyName]:void 0:r?r[this.isLazy?"__"+this.propertyName+"__":this.propertyName]:void 0}else return this.isLazy?e["__"+this.propertyName+"__"]!==void 0?e["__"+this.propertyName+"__"]:t===!0?e[this.propertyName]:void 0:e[this.propertyName]}setEntityValue(e,t){const n=this.isLazy?"__"+this.propertyName+"__":this.propertyName;if(this.embeddedMetadata){const i=(r,s)=>{const a=r.shift();return a?(s[a.propertyName]||(s[a.propertyName]=a.create()),i(r,s[a.propertyName]),s):(s[n]=t,s)};return i([...this.embeddedMetadata.embeddedMetadataTree],e)}else e[n]=t}createValueMap(e){if(this.embeddedMetadata){const t=[...this.embeddedMetadata.parentPropertyNames],n=(i,r)=>{const s=i.shift();return s?(r[s]={},n(i,r[s]),r):(r[this.propertyName]=e,r)};return n(t,{})}else return{[this.propertyName]:e}}build(){this.propertyPath=this.buildPropertyPath()}registerForeignKeys(...e){this.foreignKeys.push(...e)}registerJoinColumns(e=[],t=[]){this.joinColumns=e,this.inverseJoinColumns=t,this.isOwning=this.isManyToOne||(this.isManyToMany||this.isOneToOne)&&this.joinColumns.length>0,this.isOneToOneOwner=this.isOneToOne&&this.isOwning,this.isOneToOneNotOwner=this.isOneToOne&&!this.isOwning,this.isManyToManyOwner=this.isManyToMany&&this.isOwning,this.isManyToManyNotOwner=this.isManyToMany&&!this.isOwning,this.isWithJoinColumn=this.isManyToOne||this.isOneToOneOwner}registerJunctionEntityMetadata(e){this.junctionEntityMetadata=e,this.joinTableName=e.tableName,this.inverseRelation&&(this.inverseRelation.junctionEntityMetadata=e,this.joinTableName=e.tableName)}buildInverseSidePropertyPath(){if(this.givenInverseSidePropertyFactory){const e=this.inverseEntityMetadata.propertiesMap;if(typeof this.givenInverseSidePropertyFactory=="function")return this.givenInverseSidePropertyFactory(e);if(typeof this.givenInverseSidePropertyFactory=="string")return this.givenInverseSidePropertyFactory}else{if(this.isTreeParent&&this.entityMetadata.treeChildrenRelation)return this.entityMetadata.treeChildrenRelation.propertyName;if(this.isTreeChildren&&this.entityMetadata.treeParentRelation)return this.entityMetadata.treeParentRelation.propertyName}return""}buildPropertyPath(){return!this.embeddedMetadata||!this.embeddedMetadata.parentPropertyNames.length?this.propertyName:this.embeddedMetadata.parentPropertyNames.join(".")+"."+this.propertyName}}class Lc{constructor(e){this.columns=[],this.relations=[],this.listeners=[],this.indices=[],this.uniques=[],this.relationIds=[],this.relationCounts=[],this.embeddeds=[],this.isAlwaysUsingConstructor=!0,this.isArray=!1,this.parentPropertyNames=[],this.parentPrefixes=[],this.embeddedMetadataTree=[],this.columnsFromTree=[],this.relationsFromTree=[],this.listenersFromTree=[],this.indicesFromTree=[],this.uniquesFromTree=[],this.relationIdsFromTree=[],this.relationCountsFromTree=[],this.entityMetadata=e.entityMetadata,this.type=e.args.type(),this.propertyName=e.args.propertyName,this.customPrefix=e.args.prefix,this.isArray=e.args.isArray}create(e){return typeof this.type!="function"?{}:e?.fromDeserializer||!this.isAlwaysUsingConstructor?Object.create(this.type.prototype):new this.type}build(e){return this.embeddeds.forEach(t=>t.build(e)),this.prefix=this.buildPrefix(e),this.parentPropertyNames=this.buildParentPropertyNames(),this.parentPrefixes=this.buildParentPrefixes(),this.propertyPath=this.parentPropertyNames.join("."),this.embeddedMetadataTree=this.buildEmbeddedMetadataTree(),this.columnsFromTree=this.buildColumnsFromTree(),this.relationsFromTree=this.buildRelationsFromTree(),this.listenersFromTree=this.buildListenersFromTree(),this.indicesFromTree=this.buildIndicesFromTree(),this.uniquesFromTree=this.buildUniquesFromTree(),this.relationIdsFromTree=this.buildRelationIdsFromTree(),this.relationCountsFromTree=this.buildRelationCountsFromTree(),e.options.entitySkipConstructor&&(this.isAlwaysUsingConstructor=!e.options.entitySkipConstructor),this}buildPartialPrefix(){if(this.customPrefix===void 0||this.customPrefix===!0)return[this.propertyName];if(this.customPrefix===""||this.customPrefix===!1)return[];if(typeof this.customPrefix=="string")return[this.customPrefix];throw new C(`Invalid prefix option given for ${this.entityMetadata.targetName}#${this.propertyName}`)}buildPrefix(e){if(e.driver.options.type==="mongodb")return this.propertyName;const t=[];return this.parentEmbeddedMetadata&&t.push(this.parentEmbeddedMetadata.buildPrefix(e)),t.push(...this.buildPartialPrefix()),t.join("_")}buildParentPropertyNames(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPropertyNames().concat(this.propertyName):[this.propertyName]}buildParentPrefixes(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPrefixes().concat(this.buildPartialPrefix()):this.buildPartialPrefix()}buildEmbeddedMetadataTree(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildEmbeddedMetadataTree().concat(this):[this]}buildColumnsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildColumnsFromTree()),this.columns)}buildRelationsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationsFromTree()),this.relations)}buildListenersFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildListenersFromTree()),this.listeners)}buildIndicesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildIndicesFromTree()),this.indices)}buildUniquesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildUniquesFromTree()),this.uniques)}buildRelationIdsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationIdsFromTree()),this.relationIds)}buildRelationCountsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationCountsFromTree()),this.relationCounts)}}class rs{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}setValue(e){const t=this.relation.getEntityValue(e);if(Array.isArray(t))e[this.propertyName]=t.map(n=>this.relation.inverseEntityMetadata.getEntityIdMixedMap(n)).filter(n=>n!=null);else{const n=this.relation.inverseEntityMetadata.getEntityIdMixedMap(t);n!==void 0&&(e[this.propertyName]=n)}}build(){const e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new C(`Cannot find relation ${e}. Wrong relation specified for @RelationId decorator.`);this.relation=t}}class ss{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}build(){const e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new C(`Cannot find relation ${e}. Wrong relation specified for @RelationCount decorator.`);this.relation=t}}class xe{}xe.AFTER_LOAD="after-load";xe.BEFORE_INSERT="before-insert";xe.AFTER_INSERT="after-insert";xe.BEFORE_UPDATE="before-update";xe.AFTER_UPDATE="after-update";xe.BEFORE_REMOVE="before-remove";xe.AFTER_REMOVE="after-remove";xe.BEFORE_SOFT_REMOVE="before-soft-remove";xe.AFTER_SOFT_REMOVE="after-soft-remove";xe.BEFORE_RECOVER="before-recover";xe.AFTER_RECOVER="after-recover";class Et{constructor(e){this.columns=[],this.referencedColumns=[],this.columnNames=[],this.referencedColumnNames=[],this.entityMetadata=e.entityMetadata,this.referencedEntityMetadata=e.referencedEntityMetadata,this.columns=e.columns,this.referencedColumns=e.referencedColumns,this.onDelete=e.onDelete||"NO ACTION",this.onUpdate=e.onUpdate||"NO ACTION",this.deferrable=e.deferrable,this.givenName=e.name,e.namingStrategy&&this.build(e.namingStrategy)}build(e){this.columnNames=this.columns.map(t=>t.databaseName),this.referencedColumnNames=this.referencedColumns.map(t=>t.databaseName),this.referencedTablePath=this.referencedEntityMetadata.tablePath,this.name=this.givenName?this.givenName:e.foreignKeyName(this.entityMetadata.tableName,this.columnNames,this.referencedEntityMetadata.tableName,this.referencedColumnNames)}}class Bc{constructor(e){this.connection=e}build(e,t){const n=this.collectReferencedColumns(e,t),i=this.collectInverseReferencedColumns(e,t),r=t.name||this.connection.namingStrategy.joinTableName(e.entityMetadata.tableNameWithoutPrefix,e.inverseEntityMetadata.tableNameWithoutPrefix,e.propertyPath,e.inverseRelation?e.inverseRelation.propertyName:""),s=new nt({connection:this.connection,args:{target:"",name:r,type:"junction",database:t.database||e.entityMetadata.database,schema:t.schema||e.entityMetadata.schema,synchronize:t.synchronize}});s.build();const a=n.map(c=>{const u=t.joinColumns?t.joinColumns.find(h=>(!h.referencedColumnName||h.referencedColumnName===c.propertyName)&&!!h.name):void 0,l=u&&u.name?u.name:this.connection.namingStrategy.joinTableColumnName(e.entityMetadata.tableNameWithoutPrefix,c.propertyName,c.databaseName);return new Ve({connection:this.connection,entityMetadata:s,referencedColumn:c,args:{target:"",mode:"virtual",propertyName:l,options:{name:l,length:!c.length&&(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(c)!=="uuid"&&(c.generationStrategy==="uuid"||c.type==="uuid")?"36":c.length,width:c.width,type:c.type,precision:c.precision,scale:c.scale,charset:c.charset,collation:c.collation,zerofill:c.zerofill,unsigned:c.zerofill?!0:c.unsigned,enum:c.enum,enumName:c.enumName,foreignKeyConstraintName:u?.foreignKeyConstraintName,nullable:!1,primary:!0}}})}),o=i.map(c=>{const u=t.inverseJoinColumns?t.inverseJoinColumns.find(h=>(!h.referencedColumnName||h.referencedColumnName===c.propertyName)&&!!h.name):void 0,l=u&&u.name?u.name:this.connection.namingStrategy.joinTableInverseColumnName(e.inverseEntityMetadata.tableNameWithoutPrefix,c.propertyName,c.databaseName);return new Ve({connection:this.connection,entityMetadata:s,referencedColumn:c,args:{target:"",mode:"virtual",propertyName:l,options:{length:!c.length&&(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(c)!=="uuid"&&(c.generationStrategy==="uuid"||c.type==="uuid")?"36":c.length,width:c.width,type:c.type,precision:c.precision,scale:c.scale,charset:c.charset,collation:c.collation,zerofill:c.zerofill,unsigned:c.zerofill?!0:c.unsigned,enum:c.enum,enumName:c.enumName,foreignKeyConstraintName:u?.foreignKeyConstraintName,name:l,nullable:!1,primary:!0}}})});return this.changeDuplicatedColumnNames(a,o),s.ownerColumns=a,s.inverseColumns=o,s.ownColumns=[...a,...o],s.ownColumns.forEach(c=>c.relationMetadata=e),s.foreignKeys=e.createForeignKeyConstraints?[new Et({entityMetadata:s,referencedEntityMetadata:e.entityMetadata,columns:a,referencedColumns:n,name:a[0]?.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.onDelete||"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.onUpdate||"CASCADE"}),new Et({entityMetadata:s,referencedEntityMetadata:e.inverseEntityMetadata,columns:o,referencedColumns:i,name:o[0]?.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onDelete:"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onUpdate:"CASCADE"})]:[],s.ownIndices=[new Xe({entityMetadata:s,columns:a,args:{target:s.target,synchronize:!0}}),new Xe({entityMetadata:s,columns:o,args:{target:s.target,synchronize:!0}})],s}collectReferencedColumns(e,t){const n=t.joinColumns?t.joinColumns.find(i=>!!i.referencedColumnName):!1;return!t.joinColumns||t.joinColumns&&!n?e.entityMetadata.columns.filter(i=>i.isPrimary):t.joinColumns.map(i=>{const r=e.entityMetadata.columns.find(s=>s.propertyName===i.referencedColumnName);if(!r)throw new C(`Referenced column ${i.referencedColumnName} was not found in entity ${e.entityMetadata.name}`);return r})}collectInverseReferencedColumns(e,t){const n=!!t.inverseJoinColumns,i=n?t.inverseJoinColumns.find(r=>!!r.referencedColumnName):!1;return!n||n&&!i?e.inverseEntityMetadata.primaryColumns:t.inverseJoinColumns.map(r=>{const s=e.inverseEntityMetadata.ownColumns.find(a=>a.propertyName===r.referencedColumnName);if(!s)throw new C(`Referenced column ${r.referencedColumnName} was not found in entity ${e.inverseEntityMetadata.name}`);return s})}changeDuplicatedColumnNames(e,t){e.forEach(n=>{t.forEach(i=>{if(n.givenDatabaseName===i.givenDatabaseName){const r=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(n.propertyName,1);n.propertyName=r,n.givenDatabaseName=r;const s=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(i.propertyName,2);i.propertyName=s,i.givenDatabaseName=s}})})}}class Uc{constructor(e){this.connection=e}build(e){const t=new nt({parentClosureEntityMetadata:e,connection:this.connection,args:{target:"",name:e.treeOptions&&e.treeOptions.closureTableName?e.treeOptions.closureTableName:e.tableNameWithoutPrefix,type:"closure-junction"}});return t.build(),e.primaryColumns.forEach(n=>{t.ownColumns.push(new Ve({connection:this.connection,entityMetadata:t,closureType:"ancestor",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.ancestorColumnName?e.treeOptions.ancestorColumnName(n):n.propertyName+"_ancestor",options:{primary:!0,length:n.length,type:n.type,unsigned:n.unsigned,width:n.width,precision:n.precision,scale:n.scale,zerofill:n.zerofill,charset:n.charset,collation:n.collation}}})),t.ownColumns.push(new Ve({connection:this.connection,entityMetadata:t,closureType:"descendant",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.descendantColumnName?e.treeOptions.descendantColumnName(n):n.propertyName+"_descendant",options:{primary:!0,length:n.length,type:n.type,unsigned:n.unsigned,width:n.width,precision:n.precision,scale:n.scale,zerofill:n.zerofill,charset:n.charset,collation:n.collation}}}))}),t.ownIndices=[new Xe({entityMetadata:t,columns:[t.ownColumns[0]],args:{target:t.target,synchronize:!0}}),new Xe({entityMetadata:t,columns:[t.ownColumns[1]],args:{target:t.target,synchronize:!0}})],e.treeLevelColumn&&t.ownColumns.push(new Ve({connection:this.connection,entityMetadata:t,args:{target:"",mode:"virtual",propertyName:"level",options:{type:this.connection.driver.mappedDataTypes.treeLevel}}})),t.foreignKeys=[new Et({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[0]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"}),new Et({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[1]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"})],t}}class kt{constructor(e){this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,this.givenName=e.args.name,this.givenColumnNames=e.args.columns,this.deferrable=e.args.deferrable)}build(e){const t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(i=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+i:i.trim()),n.forEach(i=>t[i]=1);else{const i=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(i)?(n=i.map(r=>String(r)),n.forEach(r=>t[r]=1)):(n=Object.keys(i).map(r=>String(r)),Object.keys(i).forEach(r=>t[r]=i[r]))}this.columns=n.map(i=>{const r=this.entityMetadata.columns.find(c=>c.propertyPath===i);if(r)return[r];const s=this.entityMetadata.relations.find(c=>c.isWithJoinColumn&&c.propertyName===i);if(s)return s.joinColumns;const a=this.givenName?'"'+this.givenName+'" ':"",o=this.entityMetadata.targetName;throw new C(`Unique constraint ${a}contains column that is missing in the entity (${o}): `+i)}).reduce((i,r)=>i.concat(r))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,i)=>{const r=this.entityMetadata.columns.find(s=>s.propertyPath===i);return r&&(n[r.databasePath]=t[i]),n},{}),this.name=this.givenName?this.givenName:e.uniqueConstraintName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName)),this}}class Fc{constructor(e){this.connection=e}build(e,t){const n=this.collectReferencedColumns(e,t),i=this.collectColumns(e,t,n);if(!n.length||!t.createForeignKeyConstraints)return{foreignKey:void 0,columns:i,uniqueConstraint:void 0};const r=new Et({name:e[0]?.foreignKeyConstraintName,entityMetadata:t.entityMetadata,referencedEntityMetadata:t.inverseEntityMetadata,namingStrategy:this.connection.namingStrategy,columns:i,referencedColumns:n,onDelete:t.onDelete,onUpdate:t.onUpdate,deferrable:t.deferrable});if(i.every(a=>a.isPrimary)||!t.isOneToOne)return{foreignKey:r,columns:i,uniqueConstraint:void 0};const s=new kt({entityMetadata:t.entityMetadata,columns:r.columns,args:{name:this.connection.namingStrategy.relationConstraintName(t.entityMetadata.tableName,r.columns.map(a=>a.databaseName)),target:t.entityMetadata.target}});return s.build(this.connection.namingStrategy),{foreignKey:r,columns:i,uniqueConstraint:s}}collectReferencedColumns(e,t){const n=e.find(s=>!!s.referencedColumnName),i=e.length===0&&t.isManyToOne,r=e.length>0&&!n;return i||r?t.inverseEntityMetadata.primaryColumns:e.map(s=>{const a=t.inverseEntityMetadata.ownColumns.find(o=>o.propertyName===s.referencedColumnName);if(!a)throw new C(`Referenced column ${s.referencedColumnName} was not found in entity ${t.inverseEntityMetadata.name}`);return a})}collectColumns(e,t,n){return n.map(i=>{const r=e.find(c=>(!c.referencedColumnName||c.referencedColumnName===i.propertyName)&&!!c.name),s=r?r.name:this.connection.namingStrategy.joinColumnName(t.propertyName,i.propertyName);let o=(t.embeddedMetadata?t.embeddedMetadata.columns:t.entityMetadata.ownColumns).find(c=>c.databaseNameWithoutPrefixes===s);return o?o.referencedColumn&&(o=Q.cloneObject(o)):(o=new Ve({connection:this.connection,entityMetadata:t.entityMetadata,embeddedMetadata:t.embeddedMetadata,args:{target:"",mode:"virtual",propertyName:t.propertyName,options:{name:s,type:i.type,length:!i.length&&(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(i)!=="uuid"&&(i.generationStrategy==="uuid"||i.type==="uuid")?"36":i.length,width:i.width,charset:i.charset,collation:i.collation,precision:i.precision,scale:i.scale,zerofill:i.zerofill,unsigned:i.unsigned,comment:i.comment,enum:i.enum,enumName:i.enumName,primary:t.isPrimary,nullable:t.isNullable}}}),t.entityMetadata.registerColumn(o)),o.referencedColumn=i,o.type=i.type,o.relationMetadata=t,o.build(this.connection),o})}}class as{constructor(e){this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.type=e.args.type}isAllowed(e){return this.entityMetadata.target===e.constructor||typeof this.entityMetadata.target=="function"&&e.constructor.prototype instanceof this.entityMetadata.target}execute(e){if(!this.embeddedMetadata){const t=e[this.propertyName];if(!t)throw new Error(`Entity listener method "${this.propertyName}" does not exist in entity "${e.constructor.name}".`);if(typeof t!="function")throw new Error(`Entity listener method "${this.propertyName}" in entity "${e.constructor.name}" must be a function but got "${typeof t}".`);return t.call(e)}this.callEntityEmbeddedMethod(e,this.embeddedMetadata.propertyPath.split("."))}callEntityEmbeddedMethod(e,t){const n=t.shift();!n||!e[n]||(t.length===0?Array.isArray(e[n])?e[n].map(i=>i[this.propertyName]()):e[n][this.propertyName]():e[n]&&this.callEntityEmbeddedMethod(e[n],t))}}class jc{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.checkConstraintName(this.entityMetadata.tableName,this.expression),this}}class Qc{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.exclusionConstraintName(this.entityMetadata.tableName,this.expression),this}}class os{constructor(e,t){this.connection=e,this.metadataArgsStorage=t,this.junctionEntityMetadataBuilder=new Bc(e),this.closureJunctionEntityMetadataBuilder=new Uc(e),this.relationJoinColumnBuilder=new Fc(e)}build(e){const i=(e?this.metadataArgsStorage.filterTables(e):this.metadataArgsStorage.tables).filter(r=>r.type==="regular"||r.type==="closure"||r.type==="entity-child"||r.type==="view").map(r=>this.createEntityMetadata(r));return i.forEach(r=>this.computeParentEntityMetadata(i,r)),i.forEach(r=>{r.childEntityMetadatas=i.filter(s=>typeof r.target=="function"&&typeof s.target=="function"&&Ft.isInherited(s.target,r.target))}),i.filter(r=>r.tableType!=="entity-child").forEach(r=>r.build()),i.filter(r=>r.tableType==="entity-child").forEach(r=>r.build()),i.filter(r=>r.tableType!=="entity-child").forEach(r=>this.computeEntityMetadataStep1(i,r)),i.filter(r=>r.tableType==="entity-child").forEach(r=>this.computeEntityMetadataStep1(i,r)),i.forEach(r=>this.computeEntityMetadataStep2(r)),i.forEach(r=>this.computeInverseProperties(r,i)),i.filter(r=>r.tableType!=="entity-child").forEach(r=>{r.relations.filter(s=>s.isOneToOne||s.isManyToOne).forEach(s=>{const a=this.metadataArgsStorage.filterJoinColumns(s.target,s.propertyName),{foreignKey:o,columns:c,uniqueConstraint:u}=this.relationJoinColumnBuilder.build(a,s);if(o&&(s.registerForeignKeys(o),r.foreignKeys.push(o)),c&&s.registerJoinColumns(c),u)if(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){const l=new Xe({entityMetadata:u.entityMetadata,columns:u.columns,args:{target:u.target,name:u.name,unique:!0,synchronize:!0}});this.connection.driver.options.type==="mssql"&&(l.where=l.columns.map(h=>`${this.connection.driver.escape(h.databaseName)} IS NOT NULL`).join(" AND ")),this.connection.driver.options.type==="spanner"&&(l.isNullFiltered=!0),s.embeddedMetadata?s.embeddedMetadata.indices.push(l):s.entityMetadata.ownIndices.push(l),this.computeEntityMetadataStep2(r)}else s.embeddedMetadata?s.embeddedMetadata.uniques.push(u):s.entityMetadata.ownUniques.push(u),this.computeEntityMetadataStep2(r);if(o&&this.connection.driver.options.type==="cockroachdb"){const l=new Xe({entityMetadata:s.entityMetadata,columns:o.columns,args:{target:s.entityMetadata.target,synchronize:!0}});s.embeddedMetadata?s.embeddedMetadata.indices.push(l):s.entityMetadata.ownIndices.push(l),this.computeEntityMetadataStep2(r)}}),r.relations.filter(s=>s.isManyToMany).forEach(s=>{const a=this.metadataArgsStorage.findJoinTable(s.target,s.propertyName);if(!a)return;const o=this.junctionEntityMetadataBuilder.build(s,a);s.registerForeignKeys(...o.foreignKeys),s.registerJoinColumns(o.ownIndices[0].columns,o.ownIndices[1].columns),s.registerJunctionEntityMetadata(o),this.computeEntityMetadataStep2(o),this.computeInverseProperties(o,i),i.push(o)})}),i.forEach(r=>{r.relationsWithJoinColumns=r.relations.filter(s=>s.isWithJoinColumn),r.hasNonNullableRelations=r.relationsWithJoinColumns.some(s=>!s.isNullable||s.isPrimary)}),i.filter(r=>r.treeType==="closure-table").forEach(r=>{const s=this.closureJunctionEntityMetadataBuilder.build(r);r.closureJunctionTable=s,this.computeEntityMetadataStep2(s),this.computeInverseProperties(s,i),i.push(s)}),i.filter(r=>r.inheritancePattern==="STI"&&r.discriminatorColumn).forEach(r=>this.createKeysForTableInheritance(r)),i.forEach(r=>{r.indices.forEach(s=>s.build(this.connection.namingStrategy))}),i.forEach(r=>{r.uniques.forEach(s=>s.build(this.connection.namingStrategy))}),i.forEach(r=>{r.checks.forEach(s=>s.build(this.connection.namingStrategy))}),i.forEach(r=>{r.exclusions.forEach(s=>s.build(this.connection.namingStrategy))}),i.forEach(r=>this.createForeignKeys(r,i)),i.filter(r=>typeof r.target=="function").forEach(r=>{r.relations.filter(s=>s.isLazy).forEach(s=>{this.connection.relationLoader.enableLazyLoad(s,r.target.prototype)})}),i.forEach(r=>{r.columns.forEach(s=>{const a=this.metadataArgsStorage.findGenerated(s.target,s.propertyName);a&&(s.isGenerated=!0,s.generationStrategy=a.strategy,a.strategy==="uuid"?s.type="uuid":a.strategy==="rowid"?s.type="int":s.type=s.type||Number,s.build(this.connection),this.computeEntityMetadataStep2(r))})}),i}createEntityMetadata(e){const t=typeof e.target=="function"?Ft.getInheritanceTree(e.target):[e.target],n=this.metadataArgsStorage.findInheritanceType(e.target),i=this.metadataArgsStorage.findTree(e.target);let r;return(n&&n.pattern==="STI"||e.type==="entity-child")&&(r=this.metadataArgsStorage.filterSingleTableChildren(e.target).map(s=>s.target).filter(s=>typeof s=="function"),t.push(...r)),new nt({connection:this.connection,args:e,inheritanceTree:t,tableTree:i,inheritancePattern:n?n.pattern:void 0})}computeParentEntityMetadata(e,t){t.tableType==="entity-child"&&(t.parentEntityMetadata=e.find(n=>n.inheritanceTree.indexOf(t.target)!==-1&&n.inheritancePattern==="STI"))}computeEntityMetadataStep1(e,t){const n=this.metadataArgsStorage.findInheritanceType(t.target),i=this.metadataArgsStorage.findDiscriminatorValue(t.target);if(typeof i<"u"?t.discriminatorValue=i.value:t.discriminatorValue=t.target.name,t.embeddeds=this.createEmbeddedsRecursively(t,this.metadataArgsStorage.filterEmbeddeds(t.inheritanceTree)).map(s=>(t.inheritancePattern==="STI"&&(s.columns=s.columns.map(a=>(a.isNullable=!0,a))),s)),t.ownColumns=this.metadataArgsStorage.filterColumns(t.inheritanceTree).map(s=>{if(t.tableType==="entity-child")return t.parentEntityMetadata.ownColumns.find(c=>c.propertyName===s.propertyName);if(t.tableType==="regular"&&s.target!==t.target){const c=this.metadataArgsStorage.columns.find(u=>u.propertyName===s.propertyName&&u.target===t.target);c&&c.options.default&&(s.options.default=c.options.default)}const a=new Ve({connection:this.connection,entityMetadata:t,args:s});return e.find(c=>c.tableType==="entity-child"&&c.target===s.target)&&(a.isNullable=!0),a}),n&&n.column){const s=n.column&&n.column.name?n.column.name:"type";let a=t.ownColumns.find(o=>o.propertyName===s);a?a.isDiscriminator=!0:(a=new Ve({connection:this.connection,entityMetadata:t,args:{target:t.target,mode:"virtual",propertyName:s,options:n.column||{name:s,type:"varchar",nullable:!1}}}),a.isVirtual=!0,a.isDiscriminator=!0,t.ownColumns.push(a))}if(t.tableType==="entity-child"){const s=t.parentEntityMetadata.ownColumns.find(a=>a.isDiscriminator);s&&!t.ownColumns.find(a=>a===s)&&t.ownColumns.push(s),t.inheritancePattern=t.parentEntityMetadata.inheritancePattern,!t.treeType&&t.parentEntityMetadata.treeType&&(t.treeType=t.parentEntityMetadata.treeType,t.treeOptions=t.parentEntityMetadata.treeOptions,t.treeParentRelation=t.parentEntityMetadata.treeParentRelation,t.treeLevelColumn=t.parentEntityMetadata.treeLevelColumn)}const{namingStrategy:r}=this.connection;if(t.treeType==="materialized-path")t.ownColumns.push(new Ve({connection:this.connection,entityMetadata:t,materializedPath:!0,args:{target:t.target,mode:"virtual",propertyName:"mpath",options:{name:r.materializedPathColumnName,type:String,nullable:!0,default:""}}}));else if(t.treeType==="nested-set"){const{left:s,right:a}=r.nestedSetColumnNames;t.ownColumns.push(new Ve({connection:this.connection,entityMetadata:t,nestedSetLeft:!0,args:{target:t.target,mode:"virtual",propertyName:s,options:{name:s,type:Number,nullable:!1,default:1}}})),t.ownColumns.push(new Ve({connection:this.connection,entityMetadata:t,nestedSetRight:!0,args:{target:t.target,mode:"virtual",propertyName:a,options:{name:a,type:Number,nullable:!1,default:2}}}))}if(t.ownRelations=this.metadataArgsStorage.filterRelations(t.inheritanceTree).map(s=>{if(t.tableType==="entity-child"){const a=t.parentEntityMetadata.ownRelations.find(c=>c.propertyName===s.propertyName),o=typeof s.type=="function"?s.type():s.type;if(a.type!==o){const c=Object.create(a);return c.type=o,c}return a}return new is({entityMetadata:t,args:s})}),t.relationIds=this.metadataArgsStorage.filterRelationIds(t.inheritanceTree).map(s=>t.tableType==="entity-child"?t.parentEntityMetadata.relationIds.find(a=>a.propertyName===s.propertyName):new rs({entityMetadata:t,args:s})),t.relationCounts=this.metadataArgsStorage.filterRelationCounts(t.inheritanceTree).map(s=>t.tableType==="entity-child"?t.parentEntityMetadata.relationCounts.find(a=>a.propertyName===s.propertyName):new ss({entityMetadata:t,args:s})),t.ownListeners=this.metadataArgsStorage.filterListeners(t.inheritanceTree).map(s=>new as({entityMetadata:t,args:s})),t.checks=this.metadataArgsStorage.filterChecks(t.inheritanceTree).map(s=>new jc({entityMetadata:t,args:s})),this.connection.driver.options.type==="postgres"&&(t.exclusions=this.metadataArgsStorage.filterExclusions(t.inheritanceTree).map(s=>new Qc({entityMetadata:t,args:s}))),this.connection.driver.options.type==="cockroachdb"){t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(a=>!a.unique).map(a=>new Xe({entityMetadata:t,args:a}));const s=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(a=>a.unique).map(a=>new kt({entityMetadata:t,args:{target:a.target,name:a.name,columns:a.columns}}));t.ownUniques.push(...s)}else t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).map(s=>new Xe({entityMetadata:t,args:s}));if(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){const s=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(a=>new Xe({entityMetadata:t,args:{target:a.target,name:a.name,columns:a.columns,unique:!0,synchronize:!0}}));t.ownIndices.push(...s)}else{const s=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(a=>new kt({entityMetadata:t,args:a}));t.ownUniques.push(...s)}}createEmbeddedsRecursively(e,t){return t.map(n=>{const i=new Lc({entityMetadata:e,args:n}),r=typeof i.type=="function"?Ft.getInheritanceTree(i.type):[i.type];return i.columns=this.metadataArgsStorage.filterColumns(r).map(s=>new Ve({connection:this.connection,entityMetadata:e,embeddedMetadata:i,args:s})),i.relations=this.metadataArgsStorage.filterRelations(r).map(s=>new is({entityMetadata:e,embeddedMetadata:i,args:s})),i.listeners=this.metadataArgsStorage.filterListeners(r).map(s=>new as({entityMetadata:e,embeddedMetadata:i,args:s})),i.indices=this.metadataArgsStorage.filterIndices(r).map(s=>new Xe({entityMetadata:e,embeddedMetadata:i,args:s})),i.uniques=this.metadataArgsStorage.filterUniques(r).map(s=>new kt({entityMetadata:e,embeddedMetadata:i,args:s})),i.relationIds=this.metadataArgsStorage.filterRelationIds(r).map(s=>new rs({entityMetadata:e,args:s})),i.relationCounts=this.metadataArgsStorage.filterRelationCounts(r).map(s=>new ss({entityMetadata:e,args:s})),i.embeddeds=this.createEmbeddedsRecursively(e,this.metadataArgsStorage.filterEmbeddeds(r)),i.embeddeds.forEach(s=>s.parentEmbeddedMetadata=i),e.allEmbeddeds.push(i),i})}computeEntityMetadataStep2(e){e.embeddeds.forEach(t=>t.build(this.connection)),e.embeddeds.forEach(t=>{t.columnsFromTree.forEach(n=>n.build(this.connection)),t.relationsFromTree.forEach(n=>n.build())}),e.ownColumns.forEach(t=>t.build(this.connection)),e.ownRelations.forEach(t=>t.build()),e.relations=e.embeddeds.reduce((t,n)=>t.concat(n.relationsFromTree),e.ownRelations),e.eagerRelations=e.relations.filter(t=>t.isEager),e.lazyRelations=e.relations.filter(t=>t.isLazy),e.oneToOneRelations=e.relations.filter(t=>t.isOneToOne),e.oneToManyRelations=e.relations.filter(t=>t.isOneToMany),e.manyToOneRelations=e.relations.filter(t=>t.isManyToOne),e.manyToManyRelations=e.relations.filter(t=>t.isManyToMany),e.ownerOneToOneRelations=e.relations.filter(t=>t.isOneToOneOwner),e.ownerManyToManyRelations=e.relations.filter(t=>t.isManyToManyOwner),e.treeParentRelation=e.relations.find(t=>t.isTreeParent),e.treeChildrenRelation=e.relations.find(t=>t.isTreeChildren),e.columns=e.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),e.ownColumns),e.listeners=e.embeddeds.reduce((t,n)=>t.concat(n.listenersFromTree),e.ownListeners),e.afterLoadListeners=e.listeners.filter(t=>t.type===xe.AFTER_LOAD),e.afterInsertListeners=e.listeners.filter(t=>t.type===xe.AFTER_INSERT),e.afterUpdateListeners=e.listeners.filter(t=>t.type===xe.AFTER_UPDATE),e.afterRemoveListeners=e.listeners.filter(t=>t.type===xe.AFTER_REMOVE),e.afterSoftRemoveListeners=e.listeners.filter(t=>t.type===xe.AFTER_SOFT_REMOVE),e.afterRecoverListeners=e.listeners.filter(t=>t.type===xe.AFTER_RECOVER),e.beforeInsertListeners=e.listeners.filter(t=>t.type===xe.BEFORE_INSERT),e.beforeUpdateListeners=e.listeners.filter(t=>t.type===xe.BEFORE_UPDATE),e.beforeRemoveListeners=e.listeners.filter(t=>t.type===xe.BEFORE_REMOVE),e.beforeSoftRemoveListeners=e.listeners.filter(t=>t.type===xe.BEFORE_SOFT_REMOVE),e.beforeRecoverListeners=e.listeners.filter(t=>t.type===xe.BEFORE_RECOVER),e.indices=e.embeddeds.reduce((t,n)=>t.concat(n.indicesFromTree),e.ownIndices),e.uniques=e.embeddeds.reduce((t,n)=>t.concat(n.uniquesFromTree),e.ownUniques),e.primaryColumns=e.columns.filter(t=>t.isPrimary),e.nonVirtualColumns=e.columns.filter(t=>!t.isVirtual),e.ancestorColumns=e.columns.filter(t=>t.closureType==="ancestor"),e.descendantColumns=e.columns.filter(t=>t.closureType==="descendant"),e.hasMultiplePrimaryKeys=e.primaryColumns.length>1,e.generatedColumns=e.columns.filter(t=>t.isGenerated||t.isObjectId),e.hasUUIDGeneratedColumns=e.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,e.createDateColumn=e.columns.find(t=>t.isCreateDate),e.updateDateColumn=e.columns.find(t=>t.isUpdateDate),e.deleteDateColumn=e.columns.find(t=>t.isDeleteDate),e.versionColumn=e.columns.find(t=>t.isVersion),e.discriminatorColumn=e.columns.find(t=>t.isDiscriminator),e.treeLevelColumn=e.columns.find(t=>t.isTreeLevel),e.nestedSetLeftColumn=e.columns.find(t=>t.isNestedSetLeft),e.nestedSetRightColumn=e.columns.find(t=>t.isNestedSetRight),e.materializedPathColumn=e.columns.find(t=>t.isMaterializedPath),e.objectIdColumn=e.columns.find(t=>t.isObjectId),e.foreignKeys.forEach(t=>t.build(this.connection.namingStrategy)),e.propertiesMap=e.createPropertiesMap(),e.relationIds.forEach(t=>t.build()),e.relationCounts.forEach(t=>t.build()),e.embeddeds.forEach(t=>{t.relationIdsFromTree.forEach(n=>n.build()),t.relationCountsFromTree.forEach(n=>n.build())})}computeInverseProperties(e,t){e.relations.forEach(n=>{const i=t.find(r=>r.target===n.type||typeof n.type=="string"&&(r.targetName===n.type||r.givenTableName===n.type));if(!i)throw new C("Entity metadata for "+e.name+"#"+n.propertyPath+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");n.inverseEntityMetadata=i,n.inverseSidePropertyPath=n.buildInverseSidePropertyPath(),n.inverseRelation=i.relations.find(r=>r.propertyPath===n.inverseSidePropertyPath)})}createKeysForTableInheritance(e){e.indices.some(({givenColumnNames:n})=>!!n&&Array.isArray(n)&&n.length===1&&n[0]===e.discriminatorColumn?.databaseName)||e.indices.push(new Xe({entityMetadata:e,columns:[e.discriminatorColumn],args:{target:e.target,unique:!1}}))}createForeignKeys(e,t){this.metadataArgsStorage.filterForeignKeys(e.inheritanceTree).forEach(n=>{const i=typeof n.type=="function"?n.type():n.type,r=t.find(l=>typeof i=="string"?l.targetName===i||l.givenTableName===i:v.isEntitySchema(i)?l.target===i.options.name||l.target===i.options.target:l.target===i);if(!r)throw new C("Entity metadata for "+e.name+(n.propertyName?"#"+n.propertyName:"")+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");const s=n.columnNames??[],a=n.referencedColumnNames??[],o=[],c=[];n.propertyName&&(s.push(n.propertyName),n.inverseSide&&(typeof n.inverseSide=="function"?a.push(n.inverseSide(r.propertiesMap)):a.push(n.inverseSide))),a.length||c.push(...r.primaryColumns);const u=(l,h)=>{const m=h.columns.find(b=>b.propertyName===l||b.databaseName===l);if(m)return m;const y=n.name?'"'+n.name+'" ':"",g=h.targetName;throw new C(`Foreign key constraint ${y}contains column that is missing in the entity (${g}): ${l}`)};o.push(...s.map(l=>u(l,e))),c.push(...a.map(l=>u(l,r))),e.foreignKeys.push(new Et({entityMetadata:e,referencedEntityMetadata:r,namingStrategy:this.connection.namingStrategy,columns:o,referencedColumns:c,...n}))})}}class Ht extends C{static createEntitySchemaIsRequiredException(e){return new Ht(`EntitySchema is required for ${e} embedded field`)}static createTargetIsRequired(e){return new Ht(`Target field is required for ${e} embedded EntitySchema`)}constructor(e){super(e)}}class kc{transform(e){const t=new fs;return e.forEach(n=>{const i=n.options,r={target:i.target||i.name,name:i.tableName,database:i.database,schema:i.schema,type:i.type||"regular",orderBy:i.orderBy,synchronize:i.synchronize,withoutRowid:!!i.withoutRowid,expression:i.expression};t.tables.push(r);const{inheritance:s}=i;s&&t.inheritances.push({target:i.target,pattern:s.pattern??"STI",column:s.column?typeof s.column=="string"?{name:s.column}:s.column:void 0});const{discriminatorValue:a}=i;a&&t.discriminatorValues.push({target:i.target||i.name,value:a}),this.transformColumnsRecursive(i,t)}),t}transformColumnsRecursive(e,t){Object.keys(e.columns).forEach(n=>{const r=e.columns[n];let s="regular";r.createDate&&(s="createDate"),r.updateDate&&(s="updateDate"),r.deleteDate&&(s="deleteDate"),r.version&&(s="version"),r.treeChildrenCount&&(s="treeChildrenCount"),r.treeLevel&&(s="treeLevel"),r.objectId&&(s="objectId"),r.virtualProperty&&(s="virtual-property");const a={target:e.target||e.name,mode:s,propertyName:n,options:{type:r.type,name:r.objectId?"_id":r.name,primaryKeyConstraintName:r.primaryKeyConstraintName,length:r.length,width:r.width,nullable:r.nullable,readonly:r.readonly,update:r.update,select:r.select,insert:r.insert,primary:r.primary,unique:r.unique,comment:r.comment,default:r.default,onUpdate:r.onUpdate,precision:r.precision,scale:r.scale,zerofill:r.zerofill,unsigned:r.unsigned,charset:r.charset,collation:r.collation,enum:r.enum,enumName:r.enumName,asExpression:r.asExpression,generatedType:r.generatedType,hstoreType:r.hstoreType,array:r.array,transformer:r.transformer,spatialFeatureType:r.spatialFeatureType,srid:r.srid,query:r.query}};if(t.columns.push(a),r.generated){const o={target:e.target||e.name,propertyName:n,strategy:typeof r.generated=="string"?r.generated:"increment"};t.generations.push(o)}if(r.unique&&t.uniques.push({target:e.target||e.name,columns:[n]}),r.foreignKey){const o=r.foreignKey,c={target:e.target||e.name,type:o.target,propertyName:n,inverseSide:o.inverseSide,name:o.name,onDelete:o.onDelete,onUpdate:o.onUpdate,deferrable:o.deferrable};t.foreignKeys.push(c)}}),e.relations&&Object.keys(e.relations).forEach(n=>{const i=e.relations[n],r={target:e.target||e.name,propertyName:n,relationType:i.type,isLazy:i.lazy||!1,type:i.target,inverseSideProperty:i.inverseSide,isTreeParent:i.treeParent,isTreeChildren:i.treeChildren,options:{eager:i.eager||!1,cascade:i.cascade,nullable:i.nullable,onDelete:i.onDelete,onUpdate:i.onUpdate,deferrable:i.deferrable,createForeignKeyConstraints:i.createForeignKeyConstraints,persistence:i.persistence,orphanedRowAction:i.orphanedRowAction}};if(t.relations.push(r),i.joinColumn)if(typeof i.joinColumn=="boolean"){const s={target:e.target||e.name,propertyName:n};t.joinColumns.push(s)}else{const s=Array.isArray(i.joinColumn)?i.joinColumn:[i.joinColumn];for(const a of s){const o={target:e.target||e.name,propertyName:n,name:a.name,referencedColumnName:a.referencedColumnName,foreignKeyConstraintName:a.foreignKeyConstraintName};t.joinColumns.push(o)}}if(i.joinTable)if(typeof i.joinTable=="boolean"){const s={target:e.target||e.name,propertyName:n};t.joinTables.push(s)}else{const s={target:e.target||e.name,propertyName:n,name:i.joinTable.name,database:i.joinTable.database,schema:i.joinTable.schema,joinColumns:i.joinTable.joinColumn?[i.joinTable.joinColumn]:i.joinTable.joinColumns,inverseJoinColumns:i.joinTable.inverseJoinColumn?[i.joinTable.inverseJoinColumn]:i.joinTable.inverseJoinColumns};t.joinTables.push(s)}}),e.relationIds&&Object.keys(e.relationIds).forEach(n=>{const i=e.relationIds[n],r={propertyName:n,relation:i.relationName,target:e.target||e.name,alias:i.alias,queryBuilderFactory:i.queryBuilderFactory};t.relationIds.push(r)}),e.indices&&e.indices.forEach(n=>{const i={target:e.target||e.name,name:n.name,unique:n.unique===!0,spatial:n.spatial===!0,fulltext:n.fulltext===!0,nullFiltered:n.nullFiltered===!0,parser:n.parser,synchronize:n.synchronize!==!1,where:n.where,sparse:n.sparse,columns:n.columns};t.indices.push(i)}),e.foreignKeys&&e.foreignKeys.forEach(n=>{const i={target:e.target||e.name,type:n.target,columnNames:n.columnNames,referencedColumnNames:n.referencedColumnNames,name:n.name,onDelete:n.onDelete,onUpdate:n.onUpdate,deferrable:n.deferrable};t.foreignKeys.push(i)}),e.uniques&&e.uniques.forEach(n=>{const i={target:e.target||e.name,name:n.name,columns:n.columns,deferrable:n.deferrable};t.uniques.push(i)}),e.checks&&e.checks.forEach(n=>{const i={target:e.target||e.name,name:n.name,expression:n.expression};t.checks.push(i)}),e.exclusions&&e.exclusions.forEach(n=>{const i={target:e.target||e.name,name:n.name,expression:n.expression};t.exclusions.push(i)}),e.embeddeds&&Object.keys(e.embeddeds).forEach(n=>{const i=e.embeddeds[n];if(!i.schema)throw Ht.createEntitySchemaIsRequiredException(n);const r=i.schema.options;t.embeddeds.push({target:e.target||e.name,propertyName:n,isArray:i.array===!0,prefix:i.prefix!==void 0?i.prefix:void 0,type:()=>r?.target||r.name}),this.transformColumnsRecursive(r,t)})}}class Vc{constructor(e){this.connection=e}async buildMigrations(e){const[t]=Q.splitClassesAndStrings(e);return[...t,...await mi(this.connection.logger)].map(i=>ns(i))}async buildSubscribers(e){const[t]=Q.splitClassesAndStrings(e||[]),n=[...t,...await mi(this.connection.logger)];return Gt().filterSubscribers(n).map(i=>ns(i.target))}async buildEntityMetadatas(e){const[t]=Q.splitClassesAndStrings(e||[]),n=t.filter(c=>!v.isEntitySchema(c)),i=t.filter(c=>v.isEntitySchema(c)),r=[...n,...await mi(this.connection.logger)];r.forEach(c=>{v.isEntitySchema(c)&&i.push(c)});const s=new os(this.connection,Gt()).build(r),a=new kc().transform(i),o=new os(this.connection,a).build();return[...s,...o]}}class en{constructor(e){this.options=e}logQuery(e,t,n){this.isLogEnabledFor("query")&&this.writeLog("query",{type:"query",prefix:"query",message:e,format:"sql",parameters:t},n)}logQueryError(e,t,n,i){this.isLogEnabledFor("query-error")&&this.writeLog("warn",[{type:"query-error",prefix:"query failed",message:t,format:"sql",parameters:n},{type:"query-error",prefix:"error",message:e}],i)}logQuerySlow(e,t,n,i){this.isLogEnabledFor("query-slow")&&this.writeLog("warn",[{type:"query-slow",prefix:"query is slow",message:t,format:"sql",parameters:n,additionalInfo:{time:e}},{type:"query-slow",prefix:"execution time",message:e}],i)}logSchemaBuild(e,t){this.isLogEnabledFor("schema-build")&&this.writeLog("schema",{type:"schema-build",message:e},t)}logMigration(e,t){this.isLogEnabledFor("migration")&&this.writeLog("log",{type:"migration",message:e},t)}log(e,t,n){switch(e){case"log":if(!this.isLogEnabledFor("log"))return;this.writeLog("log",{type:"log",message:t},n);break;case"info":if(!this.isLogEnabledFor("info"))return;this.writeLog("info",{type:"info",prefix:"info",message:t},n);break;case"warn":if(!this.isLogEnabledFor("warn"))return;this.writeLog("warn",{type:"warn",message:t},n);break}}isLogEnabledFor(e){switch(e){case"query":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("query")!==-1;case"error":case"query-error":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("error")!==-1;case"query-slow":return!0;case"schema":case"schema-build":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("schema")!==-1;case"migration":return!0;case"log":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("log")!==-1;case"info":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("info")!==-1;case"warn":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("warn")!==-1;default:return!1}}prepareLogMessages(e,t,n){t={addColonToPrefix:!0,appendParameterAsComment:!0,highlightSql:!0,formatSql:!1,...t};const i=Array.isArray(e)?e:[e];for(let r of i){if(typeof r!="object"&&(r={message:r}),r.format==="sql"){let s=String(r.message);t.formatSql&&(s=Ee.formatSql(s,n?.connection?.options.type)),t.appendParameterAsComment&&r.parameters&&r.parameters.length&&(s+=` -- PARAMETERS: ${this.stringifyParams(r.parameters)}`),t.highlightSql&&(s=Ee.highlightSql(s)),r.message=s}t.addColonToPrefix&&r.prefix&&(r.prefix+=":")}return i}stringifyParams(e){try{return JSON.stringify(e)}catch{return e}}}class Wc extends en{writeLog(e,t,n){const i=this.prepareLogMessages(t,{highlightSql:!1});for(const r of i)switch(r.type??e){case"log":case"schema-build":case"migration":console.log(r.message);break;case"info":case"query":r.prefix?console.info(r.prefix,r.message):console.info(r.message);break;case"warn":case"query-slow":r.prefix?console.warn(r.prefix,r.message):console.warn(r.message);break;case"error":case"query-error":r.prefix?console.error(r.prefix,r.message):console.error(r.message);break}}}class cs extends en{writeLog(e,t,n){const i=this.prepareLogMessages(t);for(const r of i)switch(r.type??e){case"log":case"schema-build":case"migration":Ee.log(String(r.message));break;case"info":case"query":r.prefix?Ee.logInfo(r.prefix,r.message):Ee.log(String(r.message));break;case"warn":case"query-slow":r.prefix?Ee.logWarn(r.prefix,r.message):console.warn(Ee.warn(String(r.message)));break;case"error":case"query-error":r.prefix?Ee.logError(r.prefix,String(r.message)):console.error(Ee.error(String(r.message)));break}}}class Hc{logQuery(){throw new Error("This logger is not applicable in a browser context")}logQueryError(){throw new Error("This logger is not applicable in a browser context")}logQuerySlow(){throw new Error("This logger is not applicable in a browser context")}logSchemaBuild(){throw new Error("This logger is not applicable in a browser context")}logMigration(){throw new Error("This logger is not applicable in a browser context")}log(){throw new Error("This logger is not applicable in a browser context")}}class Gc extends Hc{}var Ut={exports:{}},fi,us;function zc(){if(us)return fi;us=1;var p=1e3,e=p*60,t=e*60,n=t*24,i=n*7,r=n*365.25;fi=function(u,l){l=l||{};var h=typeof u;if(h==="string"&&u.length>0)return s(u);if(h==="number"&&isFinite(u))return l.long?o(u):a(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function s(u){if(u=String(u),!(u.length>100)){var l=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(l){var h=parseFloat(l[1]),m=(l[2]||"ms").toLowerCase();switch(m){case"years":case"year":case"yrs":case"yr":case"y":return h*r;case"weeks":case"week":case"w":return h*i;case"days":case"day":case"d":return h*n;case"hours":case"hour":case"hrs":case"hr":case"h":return h*t;case"minutes":case"minute":case"mins":case"min":case"m":return h*e;case"seconds":case"second":case"secs":case"sec":case"s":return h*p;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}}}function a(u){var l=Math.abs(u);return l>=n?Math.round(u/n)+"d":l>=t?Math.round(u/t)+"h":l>=e?Math.round(u/e)+"m":l>=p?Math.round(u/p)+"s":u+"ms"}function o(u){var l=Math.abs(u);return l>=n?c(u,l,n,"day"):l>=t?c(u,l,t,"hour"):l>=e?c(u,l,e,"minute"):l>=p?c(u,l,p,"second"):u+" ms"}function c(u,l,h,m){var y=l>=h*1.5;return Math.round(u/h)+" "+m+(y?"s":"")}return fi}var yi,ls;function Kc(){if(ls)return yi;ls=1;function p(e){n.debug=n,n.default=n,n.coerce=c,n.disable=a,n.enable=r,n.enabled=o,n.humanize=zc(),n.destroy=u,Object.keys(e).forEach(l=>{n[l]=e[l]}),n.names=[],n.skips=[],n.formatters={};function t(l){let h=0;for(let m=0;m<l.length;m++)h=(h<<5)-h+l.charCodeAt(m),h|=0;return n.colors[Math.abs(h)%n.colors.length]}n.selectColor=t;function n(l){let h,m=null,y,g;function b(...R){if(!b.enabled)return;const P=b,M=Number(new Date),U=M-(h||M);P.diff=U,P.prev=h,P.curr=M,h=M,R[0]=n.coerce(R[0]),typeof R[0]!="string"&&R.unshift("%O");let F=0;R[0]=R[0].replace(/%([a-zA-Z%])/g,(K,re)=>{if(K==="%%")return"%";F++;const $=n.formatters[re];if(typeof $=="function"){const Y=R[F];K=$.call(P,Y),R.splice(F,1),F--}return K}),n.formatArgs.call(P,R),(P.log||n.log).apply(P,R)}return b.namespace=l,b.useColors=n.useColors(),b.color=n.selectColor(l),b.extend=i,b.destroy=n.destroy,Object.defineProperty(b,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(y!==n.namespaces&&(y=n.namespaces,g=n.enabled(l)),g),set:R=>{m=R}}),typeof n.init=="function"&&n.init(b),b}function i(l,h){const m=n(this.namespace+(typeof h>"u"?":":h)+l);return m.log=this.log,m}function r(l){n.save(l),n.namespaces=l,n.names=[],n.skips=[];const h=(typeof l=="string"?l:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const m of h)m[0]==="-"?n.skips.push(m.slice(1)):n.names.push(m)}function s(l,h){let m=0,y=0,g=-1,b=0;for(;m<l.length;)if(y<h.length&&(h[y]===l[m]||h[y]==="*"))h[y]==="*"?(g=y,b=m,y++):(m++,y++);else if(g!==-1)y=g+1,b++,m=b;else return!1;for(;y<h.length&&h[y]==="*";)y++;return y===h.length}function a(){const l=[...n.names,...n.skips.map(h=>"-"+h)].join(",");return n.enable(""),l}function o(l){for(const h of n.skips)if(s(l,h))return!1;for(const h of n.names)if(s(l,h))return!0;return!1}function c(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}return yi=p,yi}var hs;function Jc(){return hs||(hs=1,(function(p,e){var t={};e.formatArgs=i,e.save=r,e.load=s,e.useColors=n,e.storage=a(),e.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let c;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(c=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(c[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+p.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;c.splice(1,0,u,"color: inherit");let l=0,h=0;c[0].replace(/%[a-zA-Z%]/g,m=>{m!=="%%"&&(l++,m==="%c"&&(h=l))}),c.splice(h,0,u)}e.log=console.debug||console.log||(()=>{});function r(c){try{c?e.storage.setItem("debug",c):e.storage.removeItem("debug")}catch{}}function s(){let c;try{c=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!c&&typeof process<"u"&&"env"in process&&(c=t.DEBUG),c}function a(){try{return localStorage}catch{}}p.exports=Kc()(e);const{formatters:o}=p.exports;o.j=function(c){try{return JSON.stringify(c)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(Ut,Ut.exports)),Ut.exports}var ct=Jc();class Yc extends en{constructor(){super(...arguments),this.logger={log:ct.debug("typeorm:log"),info:ct.debug("typeorm:info"),warn:ct.debug("typeorm:warn"),error:ct.debug("typeorm:error"),query:ct.debug("typeorm:query:log"),"query-error":ct.debug("typeorm:query:error"),"query-slow":ct.debug("typeorm:query:slow"),"schema-build":ct.debug("typeorm:schema"),migration:ct.debug("typeorm:migration")}}isLogEnabledFor(e){switch(e){case"query":return this.logger.query.enabled;case"query-error":return this.logger["query-error"].enabled;case"query-slow":return!0;case"schema":case"schema-build":return this.logger["schema-build"].enabled;case"migration":return this.logger.migration.enabled;case"log":return this.logger.log.enabled;case"info":return this.logger.info.enabled;case"warn":return this.logger.warn.enabled;default:return!1}}writeLog(e,t,n){const i=this.prepareLogMessages(t,{appendParameterAsComment:!1});for(const r of i){const s=r.type??e;s in this.logger&&(r.prefix?this.logger[s](r.prefix,r.message):this.logger[s](r.message),r.parameters&&r.parameters.length&&this.logger[s]("parameters:",r.parameters))}}}class Xc extends en{writeLog(e,t,n){const i=this.prepareLogMessages(t,{highlightSql:!0,formatSql:!0},n);for(const r of i)switch(r.type??e){case"log":case"schema-build":case"migration":Ee.log(String(r.message));break;case"info":case"query":r.prefix?Ee.logInfo(r.prefix,r.message):Ee.log(String(r.message));break;case"warn":case"query-slow":r.prefix?Ee.logWarn(r.prefix,r.message):console.warn(Ee.warn(String(r.message)));break;case"error":case"query-error":r.prefix?Ee.logError(r.prefix,String(r.message)):console.error(Ee.error(String(r.message)));break}}}class ds{create(e,t){if(oe.isObject(e))return e;if(e)switch(e){case"simple-console":return new Wc(t);case"file":return new Gc(t);case"advanced-console":return new cs(t);case"formatted-console":return new Xc(t);case"debug":return new Yc}return new cs(t)}}class Zc{constructor(e,t){this.connection=e,this.clientType=t,this.redis=this.loadRedis()}async connect(){const e=this.connection.options.cache;if(this.clientType==="redis"){const t={...e?.options};let n=this.redis.createClient(t);typeof n.connect=="function"&&(t.legacyMode=!0,n=this.redis.createClient(t)),this.client=n,typeof this.connection.options.cache=="object"&&this.connection.options.cache.ignoreErrors&&this.client.on("error",r=>{this.connection.logger.log("warn",r)}),typeof this.client.connect=="function"&&await this.client.connect(),this.detectRedisVersion()}else if(this.clientType==="ioredis")e&&e.port?e.options?this.client=new this.redis(e.port,e.options):this.client=new this.redis(e.port):e&&e.options?this.client=new this.redis(e.options):this.client=new this.redis;else if(this.clientType==="ioredis/cluster")if(e&&e.options&&Array.isArray(e.options))this.client=new this.redis.Cluster(e.options);else if(e&&e.options&&e.options.startupNodes)this.client=new this.redis.Cluster(e.options.startupNodes,e.options.options);else throw new C(`options.startupNodes required for ${this.clientType}.`)}async disconnect(){if(this.isRedis5OrHigher()){await this.client.quit(),this.client=void 0;return}return new Promise((e,t)=>{this.client.quit((n,i)=>{if(n)return t(n);e(),this.client=void 0})})}async synchronize(e){}getFromCache(e,t){const n=e.identifier||e.query;return n?this.isRedis5OrHigher()?this.client.get(n).then(i=>i?JSON.parse(i):void 0):new Promise((i,r)=>{this.client.get(n,(s,a)=>{if(s)return r(s);i(a?JSON.parse(a):void 0)})}):Promise.resolve(void 0)}isExpired(e){return e.time+e.duration<Date.now()}async storeInCache(e,t,n){const i=e.identifier||e.query;if(!i)return;const r=JSON.stringify(e),s=e.duration;if(this.isRedis5OrHigher()){await this.client.set(i,r,{PX:s});return}return new Promise((a,o)=>{this.client.set(i,r,"PX",s,(c,u)=>{if(c)return o(c);a()})})}async clear(e){if(this.isRedis5OrHigher()){await this.client.flushDb();return}return new Promise((t,n)=>{this.client.flushdb((i,r)=>{if(i)return n(i);t()})})}async remove(e,t){await Promise.all(e.map(n=>this.deleteKey(n)))}async deleteKey(e){if(this.isRedis5OrHigher()){await this.client.del(e);return}return new Promise((t,n)=>{this.client.del(e,(i,r)=>{if(i)return n(i);t()})})}loadRedis(){try{return this.clientType==="ioredis/cluster"?Ee.load("ioredis"):Ee.load(this.clientType)}catch{throw new C(`Cannot use cache because ${this.clientType} is not installed. Please run "npm i ${this.clientType}".`)}}detectRedisVersion(){if(this.clientType==="redis")try{const e=this.client.set;e&&e.length<=3?this.redisMajorVersion=5:this.redisMajorVersion=3}catch{this.redisMajorVersion=3}}isRedis5OrHigher(){return this.clientType!=="redis"?!1:this.redisMajorVersion!==void 0&&this.redisMajorVersion>=5}}class eu{constructor(e){this.connection=e;const{schema:t}=this.connection.driver.options,n=this.connection.driver.database,r=(typeof this.connection.options.cache=="object"?this.connection.options.cache:{}).tableName||"query-result-cache";this.queryResultCacheDatabase=n,this.queryResultCacheSchema=t,this.queryResultCacheTable=this.connection.driver.buildTableName(r,t,n)}async connect(){}async disconnect(){}async synchronize(e){e=this.getQueryRunner(e);const t=this.connection.driver;await e.hasTable(this.queryResultCacheTable)||await e.createTable(new Se({database:this.queryResultCacheDatabase,schema:this.queryResultCacheSchema,name:this.queryResultCacheTable,columns:[{name:"id",isPrimary:!0,isNullable:!1,type:t.normalizeType({type:t.mappedDataTypes.cacheId}),generationStrategy:t.options.type==="spanner"?"uuid":"increment",isGenerated:!0},{name:"identifier",type:t.normalizeType({type:t.mappedDataTypes.cacheIdentifier}),isNullable:!0},{name:"time",type:t.normalizeType({type:t.mappedDataTypes.cacheTime}),isPrimary:!1,isNullable:!1},{name:"duration",type:t.normalizeType({type:t.mappedDataTypes.cacheDuration}),isPrimary:!1,isNullable:!1},{name:"query",type:t.normalizeType({type:t.mappedDataTypes.cacheQuery}),isPrimary:!1,isNullable:!1},{name:"result",type:t.normalizeType({type:t.mappedDataTypes.cacheResult}),isNullable:!1}]}))}getFromCache(e,t){t=this.getQueryRunner(t);const n=this.connection.createQueryBuilder(t).select().from(this.queryResultCacheTable,"cache");return e.identifier?n.where(`${n.escape("cache")}.${n.escape("identifier")} = :identifier`).setParameters({identifier:this.connection.driver.options.type==="mssql"?new Ye(e.identifier,"nvarchar"):e.identifier}).cache(!1).getRawOne():e.query?this.connection.driver.options.type==="oracle"?n.where(`dbms_lob.compare(${n.escape("cache")}.${n.escape("query")}, :query) = 0`,{query:e.query}).cache(!1).getRawOne():n.where(`${n.escape("cache")}.${n.escape("query")} = :query`).setParameters({query:this.connection.driver.options.type==="mssql"?new Ye(e.query,"nvarchar"):e.query}).cache(!1).getRawOne():Promise.resolve(void 0)}isExpired(e){const t=typeof e.duration=="string"?parseInt(e.duration):e.duration;return(typeof e.time=="string"?parseInt(e.time):e.time)+t<Date.now()}async storeInCache(e,t,n){const i=n===void 0||n?.getReplicationMode()==="slave";(n===void 0||i)&&(n=this.connection.createQueryRunner("master"));let r=e;if(this.connection.driver.options.type==="mssql"&&(r={identifier:new Ye(e.identifier,"nvarchar"),time:new Ye(e.time,"bigint"),duration:new Ye(e.duration,"int"),query:new Ye(e.query,"nvarchar"),result:new Ye(e.result,"nvarchar")}),t&&t.identifier){const s=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(r);s.where(`${s.escape("identifier")} = :condition`,{condition:r.identifier}),await s.execute()}else if(t&&t.query){const s=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(r);this.connection.driver.options.type==="oracle"?s.where('dbms_lob.compare("query", :condition) = 0',{condition:r.query}):s.where(`${s.escape("query")} = :condition`,{condition:r.query}),await s.execute()}else this.connection.driver.options.type==="spanner"&&!r.id&&(r.id=qs()),await n.manager.createQueryBuilder().insert().into(this.queryResultCacheTable).values(r).execute();i&&await n.release()}async clear(e){return this.getQueryRunner(e).clearTable(this.queryResultCacheTable)}async remove(e,t){const n=t||this.getQueryRunner();await Promise.all(e.map(i=>{const r=n.manager.createQueryBuilder();return r.delete().from(this.queryResultCacheTable).where(`${r.escape("identifier")} = :identifier`,{identifier:i}).execute()})),t||await n.release()}getQueryRunner(e){return e||this.connection.createQueryRunner()}}class ps{constructor(e){this.connection=e}create(){if(!this.connection.options.cache)throw new C("To use cache you need to enable it in connection options by setting cache: true or providing some caching options. Example: { host: ..., username: ..., cache: true }");const e=this.connection.options.cache;return e.provider&&typeof e.provider=="function"?e.provider(this.connection):e.type==="redis"||e.type==="ioredis"||e.type==="ioredis/cluster"?new Zc(this.connection,e.type):new eu(this.connection)}}class tu{constructor(e){this.connection=e}load(e,t,n,i){return n&&n.isReleased&&(n=void 0),e.isManyToOne||e.isOneToOneOwner?this.loadManyToOneOrOneToOneOwner(e,t,n,i):e.isOneToMany||e.isOneToOneNotOwner?this.loadOneToManyOrOneToOneNotOwner(e,t,n,i):e.isManyToManyOwner?this.loadManyToManyOwner(e,t,n,i):this.loadManyToManyNotOwner(e,t,n,i)}loadManyToOneOrOneToOneOwner(e,t,n,i){const r=Array.isArray(t)?t:[t],s=e.entityMetadata.name,a=i||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),o=a.expressionMap.mainAlias.name,c=e.entityMetadata.primaryColumns,l=(e.isOwning?e.joinColumns:e.inverseRelation.joinColumns).map(h=>`${e.entityMetadata.name}.${h.propertyName} = ${o}.${h.referencedColumn.propertyName}`).join(" AND ");if(a.innerJoin(e.entityMetadata.target,s,l),c.length===1)a.where(`${s}.${c[0].propertyPath} IN (:...${s+"_"+c[0].propertyName})`),a.setParameter(s+"_"+c[0].propertyName,r.map(h=>c[0].getEntityValue(h,!0)));else{const h=r.map((m,y)=>c.map((g,b)=>{const R=s+"_entity_"+y+"_"+b;return a.setParameter(R,g.getEntityValue(m,!0)),s+"."+g.propertyPath+" = :"+R}).join(" AND ")).map(m=>"("+m+")").join(" OR ");a.where(h)}return _e.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadOneToManyOrOneToOneNotOwner(e,t,n,i){const r=Array.isArray(t)?t:[t],s=e.inverseRelation.joinColumns,a=i||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.inverseRelation.entityMetadata.target,e.propertyName),o=a.expressionMap.mainAlias.name;if(s.length===1)a.where(`${o}.${s[0].propertyPath} IN (:...${o+"_"+s[0].propertyName})`),a.setParameter(o+"_"+s[0].propertyName,r.map(c=>s[0].referencedColumn.getEntityValue(c,!0)));else{const c=r.map((u,l)=>s.map((h,m)=>{const y=o+"_entity_"+l+"_"+m;return a.setParameter(y,h.referencedColumn.getEntityValue(u,!0)),o+"."+h.propertyPath+" = :"+y}).join(" AND ")).map(u=>"("+u+")").join(" OR ");a.where(c)}return _e.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadManyToManyOwner(e,t,n,i){const r=Array.isArray(t)?t:[t],s=e.joinColumns.reduce((h,m)=>(h[m.propertyName]=r.map(y=>m.referencedColumn.getEntityValue(y,!0)),h),{}),a=i||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),o=a.expressionMap.mainAlias.name,c=e.junctionEntityMetadata.tableName,u=e.joinColumns.map(h=>`${c}.${h.propertyName} IN (:...${h.propertyName})`),l=e.inverseJoinColumns.map(h=>`${c}.${h.propertyName}=${o}.${h.referencedColumn.propertyName}`);return a.innerJoin(c,c,[...u,...l].join(" AND ")).setParameters(s),_e.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadManyToManyNotOwner(e,t,n,i){const r=Array.isArray(t)?t:[t],s=i||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),a=s.expressionMap.mainAlias.name,o=e.junctionEntityMetadata.tableName,c=e.inverseRelation.joinColumns.map(h=>`${o}.${h.propertyName} = ${a}.${h.referencedColumn.propertyName}`),u=e.inverseRelation.inverseJoinColumns.map(h=>`${o}.${h.propertyName} IN (:...${h.propertyName})`),l=e.inverseRelation.inverseJoinColumns.reduce((h,m)=>(h[m.propertyName]=r.map(y=>m.referencedColumn.getEntityValue(y,!0)),h),{});return s.innerJoin(o,o,[...c,...u].join(" AND ")).setParameters(l),_e.joinEagerRelations(s,s.alias,s.expressionMap.mainAlias.metadata),s.getMany()}enableLazyLoad(e,t,n){const i=this,r="__"+e.propertyName+"__",s="__promise_"+e.propertyName+"__",a="__has_"+e.propertyName+"__",o=(u,l)=>(u[r]=l,u[a]=!0,delete u[s],l),c=(u,l)=>(delete u[a],delete u[r],u[s]=l,l.then(h=>u[s]===l?o(u,h):h),l);Object.defineProperty(t,e.propertyName,{get:function(){if(this[a]===!0||this[r]!==void 0)return Promise.resolve(this[r]);if(this[s])return this[s];const u=i.load(e,this,n).then(l=>e.isOneToOne||e.isManyToOne?l.length===0?null:l[0]:l);return c(this,u)},set:function(u){u instanceof Promise?c(this,u):o(this,u)},configurable:!0,enumerable:!1})}}Ls();class nu{constructor(e){this["@instanceof"]=Symbol.for("DataSource"),this.migrations=[],this.subscribers=[],this.entityMetadatas=[],this.entityMetadatasMap=new Map,Ls(),this.name=e.name||"default",this.options=e,this.logger=new ds().create(this.options.logger,this.options.logging),this.driver=new $c().create(this),this.manager=this.createEntityManager(),this.namingStrategy=e.namingStrategy||new Po,this.metadataTableName=e.metadataTableName||"typeorm_metadata",this.queryResultCache=e.cache?new ps(this).create():void 0,this.relationLoader=new tu(this),this.relationIdLoader=new $s(this),this.isInitialized=!1}get isConnected(){return this.isInitialized}get mongoManager(){if(!v.isMongoEntityManager(this.manager))throw new C("MongoEntityManager is only available for MongoDB databases.");return this.manager}get sqljsManager(){if(!v.isSqljsEntityManager(this.manager))throw new C("SqljsEntityManager is only available for Sqljs databases.");return this.manager}setOptions(e){return Object.assign(this.options,e),(e.logger||e.logging)&&(this.logger=new ds().create(e.logger||this.options.logger,e.logging||this.options.logging)),e.namingStrategy&&(this.namingStrategy=e.namingStrategy),e.cache&&(this.queryResultCache=new ps(this).create()),e.database&&(this.driver.database=k.buildDriverOptions(this.options).database),this}async initialize(){if(this.isInitialized)throw new Js(this.name);await this.driver.connect(),this.queryResultCache&&await this.queryResultCache.connect(),oe.assign(this,{isInitialized:!0});try{await this.buildMetadatas(),await this.driver.afterConnect(),this.options.dropSchema&&await this.dropDatabase(),this.options.migrationsRun&&await this.runMigrations({transaction:this.options.migrationsTransactionMode}),this.options.synchronize&&await this.synchronize()}catch(e){throw await this.destroy(),e}return this}async connect(){return this.initialize()}async destroy(){if(!this.isInitialized)throw new St(this.name);await this.driver.disconnect(),this.queryResultCache&&await this.queryResultCache.disconnect(),oe.assign(this,{isInitialized:!1})}async close(){return this.destroy()}async synchronize(e=!1){if(!this.isInitialized)throw new St(this.name);e&&await this.dropDatabase(),await this.driver.createSchemaBuilder().build()}async dropDatabase(){const e=this.createQueryRunner();try{if(this.driver.options.type==="mssql"||k.isMySQLFamily(this.driver)||this.driver.options.type==="aurora-mysql"||k.isSQLiteFamily(this.driver)){const t=[];if(this.entityMetadatas.forEach(n=>{n.database&&t.indexOf(n.database)===-1&&t.push(n.database)}),t.length===0&&this.driver.database&&t.push(this.driver.database),t.length===0)await e.clearDatabase();else for(const n of t)await e.clearDatabase(n)}else await e.clearDatabase()}finally{await e.release()}}async runMigrations(e){if(!this.isInitialized)throw new St(this.name);const t=new hi(this);return t.transaction=e?.transaction||this.options?.migrationsTransactionMode||"all",t.fake=e&&e.fake||!1,await t.executePendingMigrations()}async undoLastMigration(e){if(!this.isInitialized)throw new St(this.name);const t=new hi(this);t.transaction=e&&e.transaction||"all",t.fake=e&&e.fake||!1,await t.undoLastMigration()}async showMigrations(){if(!this.isInitialized)throw new St(this.name);return await new hi(this).showMigrations()}hasMetadata(e){return!!this.findMetadata(e)}getMetadata(e){const t=this.findMetadata(e);if(!t)throw new ta(e);return t}getRepository(e){return this.manager.getRepository(e)}getTreeRepository(e){return this.manager.getTreeRepository(e)}getMongoRepository(e){if(this.driver.options.type!=="mongodb")throw new C("You can use getMongoRepository only for MongoDB connections.");return this.manager.getRepository(e)}getCustomRepository(e){return this.manager.getCustomRepository(e)}async transaction(e,t){return this.manager.transaction(e,t)}async query(e,t,n){if(v.isMongoEntityManager(this.manager))throw new C("Queries aren't supported by MongoDB.");if(n&&n.isReleased)throw new bs;const i=n||this.createQueryRunner();try{return await i.query(e,t)}finally{n||await i.release()}}async sql(e,...t){const{query:n,parameters:i}=Yt({driver:this.driver,strings:e,expressions:t});return await this.query(n,i)}createQueryBuilder(e,t,n){if(v.isMongoEntityManager(this.manager))throw new C("Query Builder is not supported by MongoDB.");if(t){t=k.buildAlias(this.driver,void 0,t);const i=this.getMetadata(e);return new Rt(this,n).select(t).from(i.target,t)}else return new Rt(this,e)}createQueryRunner(e="master"){const t=this.driver.createQueryRunner(e),n=this.createEntityManager(t);return Object.assign(t,{manager:n}),t}getManyToManyMetadata(e,t){const n=this.getMetadata(e).findRelationWithPropertyPath(t);if(!n)throw new C(`Relation "${t}" was not found in ${e} entity.`);if(!n.isManyToMany)throw new C(`Relation "${e}#${t}" does not have a many-to-many relationship.You can use this method only on many-to-many relations.`);return n.junctionEntityMetadata}createEntityManager(e){return new lc().create(this,e)}findMetadata(e){const t=this.entityMetadatasMap.get(e);if(t)return t;for(const[n,i]of this.entityMetadatasMap){if(v.isEntitySchema(e)&&i.name===e.options.name)return i;if(typeof e=="string"){if(e.indexOf(".")!==-1){if(i.tablePath===e)return i}else if(i.name===e||i.tableName===e)return i}if(oe.isObjectWithName(e)&&typeof e.name=="string"){if(e.name.indexOf(".")!==-1){if(i.tablePath===e.name)return i}else if(i.name===e.name||i.tableName===e.name)return i}}}async buildMetadatas(){const e=new Vc(this),t=new Io,n=oe.mixedListToArray(this.options.subscribers||[]),i=await e.buildSubscribers(n);oe.assign(this,{subscribers:i});const r=oe.mixedListToArray(this.options.entities||[]),s=await e.buildEntityMetadatas(r);oe.assign(this,{entityMetadatas:s,entityMetadatasMap:new Map(s.map(c=>[c.target,c]))});const a=oe.mixedListToArray(this.options.migrations||[]),o=await e.buildMigrations(a);oe.assign(this,{migrations:o}),t.validateMany(this.entityMetadatas.filter(c=>c.tableType!=="view"),this.driver);for(const c of s)v.isBaseEntityConstructor(c.target)&&c.target.useDataSource(this)}defaultReplicationModeForReads(){if("replication"in this.driver.options&&this.driver.options.replication){const e=this.driver.options.replication.defaultMode;if(e)return e}return"slave"}}function Gt(){const p=Ee.getGlobalVariable();return p.typeormMetadataArgsStorage||(p.typeormMetadataArgsStorage=new fs),p.typeormMetadataArgsStorage}class Qs{configPath=(void 0)(process.cwd(),"data","connections.json");activeConnections=new Map;async init(){const e=(void 0)(this.configPath);(void 0)(e)||(void 0)(e,{recursive:!0})}async getAllConnections(){try{if(!(void 0)(this.configPath))return[];const e=(void 0)(this.configPath,"utf8");return JSON.parse(e)}catch(e){return console.error(":",e),[]}}async getConnectionById(e){return(await this.getAllConnections()).find(n=>n.id===e)||null}async addConnection(e){const t=await this.getAllConnections();if(t.find(n=>n.name===e.name))throw new Error("");return e.id=this.generateId(),e.createdAt=new Date,e.updatedAt=new Date,e.enabled=e.enabled!==void 0?e.enabled:!0,t.push(e),await this.saveConnections(t),e}async updateConnection(e,t){const n=await this.getAllConnections(),i=n.findIndex(r=>r.id===e);if(i===-1)throw new Error("");if(t.name&&n.find((r,s)=>r.name===t.name&&s!==i))throw new Error("");return n[i]={...n[i],...t,updatedAt:new Date},await this.saveConnections(n),n[i]}async deleteConnection(e){const t=await this.getAllConnections(),n=t.filter(i=>i.id!==e);if(n.length===t.length)throw new Error("");this.activeConnections.has(e)&&(await this.activeConnections.get(e)?.destroy(),this.activeConnections.delete(e)),await this.saveConnections(n)}async testConnection(e){try{console.log("test",e);const t=await this.createTypeORMDataSource(e);return await t.query("SELECT 1"),await t.destroy(),!0}catch(t){return console.error(t),!1}}async getActiveConnection(e,t){const n=t?`${e}_${t}`:e;if(this.activeConnections.has(n)){const a=this.activeConnections.get(n);if(a?.isInitialized)return a;this.activeConnections.delete(n)}if(this.activeConnections.size>=10){const a=this.activeConnections.keys().next().value||"",o=this.activeConnections.get(a);try{await o?.destroy()}catch(c){console.error(` ${a} :`,c)}this.activeConnections.delete(a)}const i=await this.getConnectionById(e);if(!i)throw new Error("");const r={...i,database:t||i.database},s=await this.createTypeORMDataSource(r);return this.activeConnections.set(n,s),s}async closeConnection(e,t){const n=t?`${e}_${t}`:e;this.activeConnections.has(n)&&(await this.activeConnections.get(n)?.destroy(),this.activeConnections.delete(n)),t&&this.activeConnections.has(e)&&(await this.activeConnections.get(e)?.destroy(),this.activeConnections.delete(e))}async closeAllConnectionsForId(e){const t=[];for(const[n,i]of this.activeConnections)if(n.startsWith(e+"_")||n===e)try{await i.destroy(),t.push(n)}catch(r){console.error(` ${n} :`,r)}t.forEach(n=>this.activeConnections.delete(n))}async closeAllConnections(){for(const[e,t]of this.activeConnections)try{await t.destroy()}catch(n){console.error(` ${e} :`,n)}this.activeConnections.clear()}async createTypeORMDataSource(e){const t=this.getTypeORMOptions(e);return new nu(t).initialize()}getTypeORMOptions(e){const t={type:e.type,host:e.host,port:e.port,username:e.username,password:e.password,database:e.database,synchronize:!1,logging:!1,...e.options};switch(e.type.toLowerCase()){case"sqlite":return{...t,type:"sqlite",database:e.database,host:void 0,port:void 0,username:void 0,password:void 0};case"postgres":case"postgresql":return{...t,type:"postgres",ssl:e.options?.ssl||!1};case"oracle":return{...t,type:"oracle",connectString:`${e.host}:${e.port}/${e.database}`,host:void 0,port:void 0,database:void 0,extra:{connectionTimeout:6e4,poolMax:10,poolMin:1,poolIncrement:1}};case"mssql":case"sqlserver":return{...t,type:"mssql",options:{encrypt:e.options?.encrypt||!1,trustServerCertificate:!0},extra:{connectionTimeout:6e4,requestTimeout:15e3}};default:return t}}async saveConnections(e){try{(void 0)(this.configPath,JSON.stringify(e,null,2),"utf8")}catch(t){throw console.error(":",t),t}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}}class Ot{async getDatabaseInfo(e,t){const n=await this.getTables(e,t);return{name:t,tableCount:n.length,size:await this.getDatabaseSize(e,t),tables:n}}async getTableInfo(e,t,n){const r=(await this.getTables(e,t)).find(s=>s.name===n);if(!r)throw new Error(` ${n} `);return r.columns=await this.getColumns(e,t,n),r.indexes=await this.getIndexes(e,t,n),r.foreignKeys=await this.getForeignKeys(e,t,n),r}async getTableData(e,t,n,i=1,r=100,s,a){let o=`SELECT * FROM ${this.quoteIdentifier(n)}`;s&&(o+=` WHERE ${s}`),a&&(o+=` ORDER BY ${a}`);const c=(i-1)*r;o+=` LIMIT ${r} OFFSET ${c}`;const u=await e.query(o);let l=`SELECT COUNT(*) as total FROM ${this.quoteIdentifier(n)}`;s&&(l+=` WHERE ${s}`);const m=(await e.query(l))[0]?.total||0;return{data:u,total:m}}async executeQuery(e,t){return await e.query(t)}async testConnection(e){try{return await e.query("SELECT 1"),!0}catch(t){return console.error(t),!1}}quoteIdentifier(e){return`"${e}"`}buildPaginationQuery(e,t,n){const i=(t-1)*n;return`${e} LIMIT ${n} OFFSET ${i}`}buildCountQuery(e){return`SELECT COUNT(*) as total FROM (${e}) as count_query`}async getViews(e,t){throw new Error(` ${this.getDatabaseType()} `)}async getViewDefinition(e,t,n){throw new Error(` ${this.getDatabaseType()} `)}async getProcedures(e,t){throw new Error(` ${this.getDatabaseType()} `)}async getProcedureDefinition(e,t,n){throw new Error(` ${this.getDatabaseType()} `)}async createDatabase(e,t,n){throw new Error(` ${this.getDatabaseType()} `)}async dropDatabase(e,t){throw new Error(` ${this.getDatabaseType()} `)}}class iu extends Ot{getDatabaseType(){return"mysql"}async getDatabases(e){return(await e.query("SHOW DATABASES")).map(n=>n.Database)}async getTables(e,t){return(await e.query(`
      SELECT 
        TABLE_NAME as name,
        TABLE_TYPE as type,
        ENGINE as engine,
        TABLE_ROWS as rowCount,
        DATA_LENGTH as dataSize,
        INDEX_LENGTH as indexSize,
        TABLE_COLLATION as collation,
        CREATE_TIME as createdAt,
        UPDATE_TIME as updatedAt,
        TABLE_COMMENT as comment
      FROM information_schema.TABLES 
      WHERE TABLE_SCHEMA = ?
    `,[t])).map(i=>({name:i.name,type:i.type,engine:i.engine,rowCount:i.rowCount||0,dataSize:i.dataSize||0,indexSize:i.indexSize||0,collation:i.collation,createdAt:i.createdAt,updatedAt:i.updatedAt,comment:i.comment}))}async getColumns(e,t,n){return(await e.query(`
      SELECT 
        COLUMN_NAME as name,
        COLUMN_TYPE as type,
        IS_NULLABLE as nullable,
        COLUMN_DEFAULT as defaultValue,
        COLUMN_KEY as columnKey,
        EXTRA as extra,
        CHARACTER_MAXIMUM_LENGTH as length,
        CHARACTER_SET_NAME as charset,
        COLLATION_NAME as collation,
        COLUMN_COMMENT as comment
      FROM information_schema.COLUMNS 
      WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ?
    `,[t,n])).map(r=>{const s=r.type||"";let a,o;const c=s.match(/(DECIMAL|NUMERIC)\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/i);return c&&(a=parseInt(c[2]),o=parseInt(c[3])),{name:r.name,type:r.type,nullable:r.nullable==="YES",defaultValue:r.defaultValue,isPrimary:r.columnKey==="PRI",isAutoIncrement:r.extra?.includes("auto_increment")||!1,length:r.length,precision:a,scale:o,charset:r.charset,collation:r.collation,comment:r.comment}})}async getIndexes(e,t,n){const i=await e.query(`
      SELECT 
        INDEX_NAME as name,
        INDEX_TYPE as type,
        COLUMN_NAME as columnName
      FROM information_schema.STATISTICS 
      WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ?
      ORDER BY INDEX_NAME, SEQ_IN_INDEX
    `,[t,n]),r=new Map;return i.forEach(s=>{if(!r.has(s.name)){let a=!1;s.name==="PRIMARY"?a=!0:a=s.name.toUpperCase().includes("UNIQUE")||s.type==="UNIQUE",r.set(s.name,{name:s.name,type:s.type,columns:[],unique:a})}r.get(s.name).columns.push(s.columnName)}),Array.from(r.values())}async getForeignKeys(e,t,n){return(await e.query(`
      SELECT 
        kcu.CONSTRAINT_NAME as name,
        kcu.COLUMN_NAME as columnName,
        kcu.REFERENCED_TABLE_NAME as referencedTable,
        kcu.REFERENCED_COLUMN_NAME as referencedColumn,
        rc.DELETE_RULE as onDelete,
        rc.UPDATE_RULE as onUpdate
      FROM information_schema.KEY_COLUMN_USAGE kcu
      LEFT JOIN information_schema.REFERENTIAL_CONSTRAINTS rc 
        ON kcu.CONSTRAINT_NAME = rc.CONSTRAINT_NAME 
        AND kcu.CONSTRAINT_SCHEMA = rc.CONSTRAINT_SCHEMA
      WHERE kcu.TABLE_SCHEMA = ? 
        AND kcu.TABLE_NAME = ?
        AND kcu.REFERENCED_TABLE_NAME IS NOT NULL
    `,[t,n])).map(r=>({name:r.name,column:r.columnName,referencedTable:r.referencedTable,referencedColumn:r.referencedColumn,onDelete:r.onDelete||"NO ACTION",onUpdate:r.onUpdate||"NO ACTION"}))}async getDatabaseSize(e,t){return(await e.query(`
      SELECT SUM(data_length + index_length) as size
      FROM information_schema.tables 
      WHERE table_schema = ?
    `,[t]))[0]?.size||0}quoteIdentifier(e){return`\`${e}\``}async getViews(e,t){return(await e.query(`
      SELECT 
        TABLE_NAME as name,
        TABLE_SCHEMA as schemaName
      FROM information_schema.VIEWS 
      WHERE TABLE_SCHEMA = ?
      ORDER BY TABLE_NAME
    `,[t])).map(i=>({name:i.name,comment:"",schemaName:i.schemaName}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT VIEW_DEFINITION as definition
      FROM information_schema.VIEWS 
      WHERE TABLE_SCHEMA = ? 
      AND TABLE_NAME = ?
    `,[t,n]))[0]?.definition||""}async getProcedures(e,t){return(await e.query(`
      SELECT 
        ROUTINE_NAME as name,
        ROUTINE_TYPE as type,
        ROUTINE_COMMENT as comment
      FROM information_schema.ROUTINES 
      WHERE ROUTINE_SCHEMA = ?
      ORDER BY ROUTINE_NAME
    `,[t])).map(i=>({name:i.name,comment:i.comment||"",type:i.type,returnType:"",language:"SQL"}))}async getProcedureDefinition(e,t,n){return(await e.query(`
      SELECT ROUTINE_DEFINITION as definition
      FROM information_schema.ROUTINES 
      WHERE ROUTINE_SCHEMA = ? 
      AND ROUTINE_NAME = ?
    `,[t,n]))[0]?.definition||""}async createDatabase(e,t,n){let i=`CREATE DATABASE ${this.quoteIdentifier(t)}`;if(n){const r=[];n.charset&&r.push(`CHARACTER SET ${n.charset}`),n.collation&&r.push(`COLLATE ${n.collation}`),r.length>0&&(i+=" "+r.join(" "))}await e.query(i)}async dropDatabase(e,t){const n=`DROP DATABASE ${this.quoteIdentifier(t)}`;await e.query(n)}}class ru extends Ot{getDatabaseType(){return"postgres"}async getDatabases(e){return(await e.query(`
      SELECT datname as name 
      FROM pg_database 
      WHERE datistemplate = false
    `)).map(n=>n.name)}async getTables(e,t){return(await e.query(`
      SELECT 
        t.table_name as name,
        'BASE TABLE' as type,
        (SELECT COUNT(*) FROM information_schema.columns WHERE table_name = t.table_name) as rowCount,
        0 as dataSize,
        0 as indexSize,
        '' as collation,
        obj_description(c.oid) as comment
      FROM information_schema.tables t
      LEFT JOIN pg_class c ON c.relname = t.table_name
      WHERE t.table_schema NOT IN ('information_schema', 'pg_catalog')
        AND t.table_type = 'BASE TABLE'
    `)).map(i=>({name:i.name,type:i.type,rowCount:i.rowcount||0,dataSize:i.datasize||0,indexSize:i.indexsize||0,collation:i.collation,comment:i.comment}))}async getColumns(e,t,n){const i=await e.query(`
      SELECT 
        column_name as name,
        data_type as type,
        is_nullable as nullable,
        column_default as defaultValue,
        character_maximum_length as length
      FROM information_schema.columns 
      WHERE table_name = $1
    `,[n]),r=await this.getPrimaryKeys(e,n);return i.map(s=>{const a=s.type||"";let o,c;const u=a.match(/(DECIMAL|NUMERIC)\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/i);return u&&(o=parseInt(u[2]),c=parseInt(u[3])),{name:s.name,type:s.type,nullable:s.nullable==="YES",defaultValue:s.defaultValue,isPrimary:r.includes(s.name),isAutoIncrement:s.defaultValue?.includes("nextval")||!1,length:s.length,precision:o,scale:c}})}async getIndexes(e,t,n){return(await e.query(`
      SELECT 
        indexname as name,
        indexdef as definition
      FROM pg_indexes 
      WHERE tablename = $1
    `,[n])).map(r=>({name:r.name,type:"INDEX",columns:[],unique:r.definition.toLowerCase().includes("unique")}))}async getForeignKeys(e,t,n){return(await e.query(`
      SELECT 
        tc.constraint_name as name,
        kcu.column_name as column,
        ccu.table_name as referencedTable,
        ccu.column_name as referencedColumn,
        rc.delete_rule as onDelete
      FROM information_schema.table_constraints tc
      JOIN information_schema.key_column_usage kcu
        ON tc.constraint_name = kcu.constraint_name
      JOIN information_schema.constraint_column_usage ccu
        ON ccu.constraint_name = tc.constraint_name
      JOIN information_schema.referential_constraints rc
        ON tc.constraint_name = rc.constraint_name
      WHERE tc.constraint_type = 'FOREIGN KEY' 
        AND tc.table_name = $1
    `,[n])).map(r=>({name:r.name,column:r.column,referencedTable:r.referencedtable,referencedColumn:r.referencedcolumn,onDelete:r.ondelete,onUpdate:"NO ACTION"}))}async getDatabaseSize(e,t){return(await e.query(`
      SELECT pg_database_size($1) as size
    `,[t]))[0]?.size||0}async getPrimaryKeys(e,t){return(await e.query(`
      SELECT column_name 
      FROM information_schema.table_constraints tc
      JOIN information_schema.key_column_usage kcu
        ON tc.constraint_name = kcu.constraint_name
      WHERE tc.constraint_type = 'PRIMARY KEY' 
        AND tc.table_name = $1
    `,[t])).map(i=>i.column_name)}quoteIdentifier(e){return`"${e}"`}async getViews(e,t){return(await e.query(`
      SELECT 
        table_name as name,
        COALESCE(obj_description(c.oid), '') as comment,
        table_schema as schemaName
      FROM information_schema.views v
      LEFT JOIN pg_class c ON c.relname = v.table_name
      WHERE v.table_schema NOT IN ('information_schema', 'pg_catalog')
      ORDER BY v.table_name
    `)).map(i=>({name:i.name,comment:i.comment||"",schemaName:i.schemaname}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT view_definition as definition
      FROM information_schema.views 
      WHERE table_name = $1
        AND table_schema NOT IN ('information_schema', 'pg_catalog')
    `,[n]))[0]?.definition||""}async getProcedures(e,t){return(await e.query(`
      SELECT 
        routine_name as name,
        COALESCE(routine_comment, '') as comment,
        routine_type as type,
        COALESCE(data_type, '') as returnType,
        external_language as language
      FROM information_schema.routines 
      WHERE routine_schema NOT IN ('information_schema', 'pg_catalog')
      ORDER BY routine_name
    `)).map(i=>({name:i.name,comment:i.comment||"",type:i.type,returnType:i.returntype||"",language:i.language||"SQL"}))}async getProcedureDefinition(e,t,n){return(await e.query(`
      SELECT routine_definition as definition
      FROM information_schema.routines 
      WHERE routine_name = $1
        AND routine_schema NOT IN ('information_schema', 'pg_catalog')
    `,[n]))[0]?.definition||""}async createDatabase(e,t,n){let i=`CREATE DATABASE ${this.quoteIdentifier(t)}`;if(n){const r=[];n.owner&&r.push(`OWNER ${n.owner}`),n.template&&r.push(`TEMPLATE ${n.template}`),n.encoding&&r.push(`ENCODING '${n.encoding}'`),n.lcCollate&&r.push(`LC_COLLATE '${n.lcCollate}'`),n.lcCtype&&r.push(`LC_CTYPE '${n.lcCtype}'`),n.tablespace&&r.push(`TABLESPACE ${n.tablespace}`),n.allowConnections!==void 0&&r.push(`ALLOW_CONNECTIONS ${n.allowConnections}`),n.connectionLimit!==void 0&&r.push(`CONNECTION LIMIT ${n.connectionLimit}`),r.length>0&&(i+=" "+r.join(" "))}await e.query(i)}async dropDatabase(e,t){const n=`DROP DATABASE ${this.quoteIdentifier(t)}`;await e.query(n)}}class su extends Ot{getDatabaseType(){return"sqlite"}async getDatabases(e){return["main"]}async getTables(e,t){return(await e.query(`
      SELECT 
        tbl_name as name,
        'table' as type,
        sql as definition
      FROM sqlite_master 
      WHERE type = 'table' AND tbl_name NOT LIKE 'sqlite_%'
    `)).map(i=>({name:i.name,type:i.type,rowCount:0,dataSize:0,indexSize:0}))}async getColumns(e,t,n){return(await e.query(`PRAGMA table_info(${n})`)).map(r=>({name:r.name,type:r.type,nullable:r.notnull===0,defaultValue:r.dflt_value,isPrimary:r.pk===1,isAutoIncrement:!1}))}async getIndexes(e,t,n){return(await e.query(`PRAGMA index_list(${n})`)).map(r=>({name:r.name,type:r.unique?"UNIQUE":"INDEX",columns:[],unique:r.unique===1}))}async getForeignKeys(e,t,n){return(await e.query(`PRAGMA foreign_key_list(${n})`)).map(r=>({name:`fk_${n}_${r.table}`,column:r.from,referencedTable:r.table,referencedColumn:r.to,onDelete:r.on_delete||"NO ACTION",onUpdate:r.on_update||"NO ACTION"}))}async getDatabaseSize(e,t){return 0}async getViews(e,t){return(await e.query(`
      SELECT 
        name,
        sql as definition
      FROM sqlite_master 
      WHERE type = 'view' AND name NOT LIKE 'sqlite_%'
      ORDER BY name
    `)).map(i=>({name:i.name,comment:"",schemaName:"main",definition:i.definition}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT sql as definition
      FROM sqlite_master 
      WHERE type = 'view' AND name = $1
    `,[n]))[0]?.definition||""}async getProcedures(e,t){return[]}async getProcedureDefinition(e,t,n){throw new Error("SQLite")}async createDatabase(e,t,n){throw new Error("SQLite")}async dropDatabase(e,t){throw new Error("SQLite")}}class au extends Ot{getDatabaseType(){return"oracle"}async getDatabases(e){return(await e.query(`
      SELECT username as name 
      FROM all_users 
      WHERE username NOT IN ('SYS', 'SYSTEM', 'XDB', 'OUTLN')
      ORDER BY username
    `)).map(n=>n.name)}async getTables(e,t){const n=await e.query(`
      SELECT 
        table_name as name,
        'TABLE' as type
      FROM all_tables 
      WHERE owner = ? 
        AND table_name NOT LIKE 'BIN$%'
        AND temporary = 'N'
      ORDER BY table_name
    `,[t.toUpperCase()]),i=[];for(const r of n){const s=await this.getTableStats(e,t,r.name);i.push({name:r.name,type:r.type,rowCount:s.rowCount,dataSize:s.dataSize,indexSize:s.indexSize})}return i}async getColumns(e,t,n){const i=await e.query(`
      SELECT 
        column_name as name,
        data_type as type,
        data_length as length,
        nullable as nullable,
        data_default as defaultValue
      FROM all_tab_columns 
      WHERE owner = ? 
        AND table_name = ?
      ORDER BY column_id
    `,[t.toUpperCase(),n.toUpperCase()]),r=await this.getPrimaryKeys(e,t,n);return i.map(s=>{const a=s.type||"";let o,c;const u=a.match(/(DECIMAL|NUMBER)\s*\(\s*(\d+)\s*(,\s*(\d+)\s*)?\s*\)/i);return u&&(o=parseInt(u[2]),u[3]&&(c=parseInt(u[3].replace(/\D/g,"")))),{name:s.name,type:s.type+(s.length?`(${s.length})`:""),nullable:s.nullable==="Y",defaultValue:s.defaultValue,isPrimary:r.includes(s.name),isAutoIncrement:!1,length:s.length,precision:o,scale:c}})}async getIndexes(e,t,n){const i=await e.query(`
      SELECT DISTINCT 
        i.index_name as name,
        DECODE(i.uniqueness, 'UNIQUE', 'UNIQUE INDEX', 'INDEX') as type,
        ic.column_name as column
      FROM all_indexes i
      JOIN all_ind_columns ic ON i.index_name = ic.index_name
      WHERE i.table_owner = ? 
        AND i.table_name = ?
        AND i.index_name NOT IN (SELECT constraint_name 
                               FROM all_constraints 
                               WHERE constraint_type = 'P' 
                               AND table_owner = ?)
      ORDER BY i.index_name, ic.column_position
    `,[t.toUpperCase(),n.toUpperCase(),t.toUpperCase()]),r=new Map;return i.forEach(s=>{r.has(s.name)||r.set(s.name,{name:s.name,type:s.type,columns:[],unique:s.type.includes("UNIQUE")}),r.get(s.name).columns.push(s.column)}),Array.from(r.values())}async getForeignKeys(e,t,n){return(await e.query(`
      SELECT 
        c.constraint_name as name,
        cc.column_name as column,
        r.table_name as referencedTable,
        rc.column_name as referencedColumn,
        c.delete_rule as onDelete
      FROM all_constraints c
      JOIN all_cons_columns cc ON c.constraint_name = cc.constraint_name
      JOIN all_constraints r ON c.r_constraint_name = r.constraint_name
      JOIN all_cons_columns rc ON r.constraint_name = rc.constraint_name AND cc.position = rc.position
      WHERE c.constraint_type = 'R'
        AND c.owner = ? 
        AND c.table_name = ?
    `,[t.toUpperCase(),n.toUpperCase()])).map(r=>({name:r.name,column:r.column,referencedTable:r.referencedTable,referencedColumn:r.referencedColumn,onDelete:r.onDelete||"NO ACTION",onUpdate:"NO ACTION"}))}async getDatabaseSize(e,t){return(await e.query(`
      SELECT SUM(bytes) as size
      FROM user_segments
    `))[0]?.size||0}async getTableStats(e,t,n){try{const i=await e.query(`
        SELECT 
          num_rows as rowCount,
          (SELECT SUM(bytes) FROM user_segments WHERE segment_name = ?) as dataSize
        FROM all_tables
        WHERE owner = ? AND table_name = ?
      `,[n.toUpperCase(),t.toUpperCase(),n.toUpperCase()]);return{rowCount:i[0]?.rowCount||0,dataSize:i[0]?.dataSize||0,indexSize:0}}catch{return{rowCount:0,dataSize:0,indexSize:0}}}async getPrimaryKeys(e,t,n){return(await e.query(`
      SELECT column_name
      FROM all_cons_columns cc
      JOIN all_constraints c ON cc.constraint_name = c.constraint_name
      WHERE c.constraint_type = 'P'
        AND c.owner = ? 
        AND c.table_name = ?
      ORDER BY cc.position
    `,[t.toUpperCase(),n.toUpperCase()])).map(r=>r.column_name)}quoteIdentifier(e){return`"${e.toUpperCase()}"`}async getViews(e,t){return(await e.query(`
      SELECT 
        view_name as name,
        '' as comment
      FROM all_views 
      WHERE owner = ?
      ORDER BY view_name
    `,[t.toUpperCase()])).map(i=>({name:i.name,comment:i.comment||"",schemaName:t}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT text as definition
      FROM all_views 
      WHERE owner = ? 
        AND view_name = ?
    `,[t.toUpperCase(),n.toUpperCase()]))[0]?.definition||""}async getProcedures(e,t){return(await e.query(`
      SELECT 
        object_name as name,
        '' as comment,
        'PROCEDURE' as type,
        '' as returnType,
        'PL/SQL' as language
      FROM all_objects 
      WHERE owner = ? 
        AND object_type IN ('PROCEDURE', 'FUNCTION')
        AND status = 'VALID'
      ORDER BY object_name
    `,[t.toUpperCase()])).map(i=>({name:i.name,comment:i.comment||"",type:i.type,returnType:i.returnType||"",language:i.language||"PL/SQL"}))}async getProcedureDefinition(e,t,n){return(await e.query(`
      SELECT text as definition
      FROM all_source 
      WHERE owner = ? 
        AND name = ?
      ORDER BY line
    `,[t.toUpperCase(),n.toUpperCase()])).map(r=>r.definition).join(`
`)||""}async createDatabase(e,t,n){let i=`CREATE DATABASE ${this.quoteIdentifier(t)}`;if(n){const r=[];n.user&&r.push(`USER ${n.user}`),n.password&&r.push(`IDENTIFIED BY ${n.password}`),n.defaultTablespace&&r.push(`DEFAULT TABLESPACE ${n.defaultTablespace}`),n.tempTablespace&&r.push(`TEMPORARY TABLESPACE ${n.tempTablespace}`),n.datafile&&r.push(`DATAFILE '${n.datafile}'`),n.size&&r.push(`SIZE ${n.size}`),n.autoExtend&&r.push("AUTOEXTEND ON"),r.length>0&&(i+=" "+r.join(" "))}await e.query(i)}async dropDatabase(e,t){const n=`DROP DATABASE ${this.quoteIdentifier(t)}`;await e.query(n)}}class ou extends Ot{getDatabaseType(){return"mssql"}async getDatabases(e){return(await e.query(`
      SELECT name 
      FROM sys.databases 
      WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb')
        AND state = 0
      ORDER BY name
    `)).map(n=>n.name)}async getTables(e,t){return(await e.query(`
      SELECT 
        t.name,
        'BASE TABLE' as type,
        p.rows as rowCount,
        SUM(a.total_pages) * 8 * 1024 as dataSize
      FROM ${this.quoteIdentifier(t)}.sys.tables t
      INNER JOIN ${this.quoteIdentifier(t)}.sys.partitions p ON t.object_id = p.object_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.allocation_units a ON p.partition_id = a.container_id
      WHERE t.is_ms_shipped = 0
        AND p.index_id IN (0, 1)
      GROUP BY t.name, p.rows
      ORDER BY t.name
    `)).map(i=>({name:i.name,type:i.type,rowCount:i.rowCount||0,dataSize:i.dataSize||0,indexSize:0}))}async getColumns(e,t,n){const i=await e.query(`
      SELECT 
        c.name,
        t.name as type,
        c.max_length as length,
        c.precision,
        c.scale,
        c.is_nullable as nullable,
        c.default_object_id,
        COLUMNPROPERTY(c.object_id, c.name, 'IsIdentity') as isIdentity
      FROM ${this.quoteIdentifier(t)}.sys.columns c
      INNER JOIN ${this.quoteIdentifier(t)}.sys.types t ON c.user_type_id = t.user_type_id
      WHERE c.object_id = OBJECT_ID(?)
      ORDER BY c.column_id
    `,[`${t}.${n}`]),r=await this.getPrimaryKeys(e,t,n);return i.map(s=>({name:s.name,type:s.type,nullable:s.nullable,defaultValue:s.default_object_id?"DEFAULT":null,isPrimary:r.includes(s.name),isAutoIncrement:s.isIdentity===1,length:s.length,precision:s.precision,scale:s.scale}))}async getIndexes(e,t,n){const i=await e.query(`
      SELECT 
        i.name,
        i.type_desc as type,
        c.name as column,
        i.is_unique as isUnique
      FROM ${this.quoteIdentifier(t)}.sys.indexes i
      INNER JOIN ${this.quoteIdentifier(t)}.sys.index_columns ic ON i.object_id = ic.object_id AND i.index_id = ic.index_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id
      WHERE i.object_id = OBJECT_ID(?)
        AND i.is_primary_key = 0
      ORDER BY i.name, ic.key_ordinal
    `,[`${t}.${n}`]),r=new Map;return i.forEach(s=>{r.has(s.name)||r.set(s.name,{name:s.name,type:s.type,columns:[],unique:s.isUnique}),r.get(s.name).columns.push(s.column)}),Array.from(r.values())}async getForeignKeys(e,t,n){return(await e.query(`
      SELECT 
        fk.name as name,
        c.name as column,
        rt.name as referencedTable,
        rc.name as referencedColumn,
        fk.delete_action_desc as onDelete,
        fk.update_action_desc as onUpdate
      FROM ${this.quoteIdentifier(t)}.sys.foreign_keys fk
      INNER JOIN ${this.quoteIdentifier(t)}.sys.foreign_key_columns fkc ON fk.object_id = fkc.constraint_object_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.columns c ON fkc.parent_object_id = c.object_id AND fkc.parent_column_id = c.column_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.columns rc ON fkc.referenced_object_id = rc.object_id AND fkc.referenced_column_id = rc.column_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.tables rt ON fkc.referenced_object_id = rt.object_id
      WHERE fkc.parent_object_id = OBJECT_ID(?)
    `,[`${t}.${n}`])).map(r=>({name:r.name,column:r.column,referencedTable:r.referencedTable,referencedColumn:r.referencedColumn,onDelete:r.onDelete,onUpdate:r.onUpdate}))}async getDatabaseSize(e,t){return(await e.query(`
      SELECT SUM(size * 8 * 1024) as size
      FROM sys.master_files
      WHERE database_id = DB_ID(?)
    `,[t]))[0]?.size||0}async getPrimaryKeys(e,t,n){return(await e.query(`
      SELECT c.name
      FROM ${this.quoteIdentifier(t)}.sys.key_constraints k
      INNER JOIN ${this.quoteIdentifier(t)}.sys.index_columns ic ON k.parent_object_id = ic.object_id AND k.unique_index_id = ic.index_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id
      WHERE k.type = 'PK'
        AND k.parent_object_id = OBJECT_ID(?)
      ORDER BY ic.key_ordinal
    `,[`${t}.${n}`])).map(r=>r.name)}quoteIdentifier(e){return`[${e}]`}async getViews(e,t){return(await e.query(`
      SELECT 
        TABLE_NAME as name,
        '' as comment,
        TABLE_SCHEMA as schemaName
      FROM ${this.quoteIdentifier(t)}.INFORMATION_SCHEMA.VIEWS
      ORDER BY TABLE_NAME
    `)).map(i=>({name:i.name,comment:i.comment||"",schemaName:i.schemaname}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT VIEW_DEFINITION as definition
      FROM ${this.quoteIdentifier(t)}.INFORMATION_SCHEMA.VIEWS 
      WHERE TABLE_NAME = ?
    `,[n]))[0]?.definition||""}async getProcedures(e,t){return(await e.query(`
      SELECT 
        ROUTINE_NAME as name,
        '' as comment,
        ROUTINE_TYPE as type,
        '' as returnType,
        'SQL' as language
      FROM ${this.quoteIdentifier(t)}.INFORMATION_SCHEMA.ROUTINES 
      WHERE ROUTINE_SCHEMA NOT IN ('sys', 'INFORMATION_SCHEMA')
      ORDER BY ROUTINE_NAME
    `)).map(i=>({name:i.name,comment:i.comment||"",type:i.type,returnType:i.returnType||"",language:i.language||"SQL"}))}async getProcedureDefinition(e,t,n){return(await e.query(`
      SELECT ROUTINE_DEFINITION as definition
      FROM ${this.quoteIdentifier(t)}.INFORMATION_SCHEMA.ROUTINES 
      WHERE ROUTINE_NAME = ?
    `,[n]))[0]?.definition||""}async createDatabase(e,t,n){let i=`CREATE DATABASE ${this.quoteIdentifier(t)}`;if(n){const r=[];if(n.collation&&r.push(`COLLATE ${n.collation}`),n.containment&&r.push(`CONTAINMENT = ${n.containment}`),n.compatibilityLevel&&r.push(`COMPATIBILITY_LEVEL = ${n.compatibilityLevel}`),n.dataFiles){const s=n.dataFiles.map(a=>{let o=`(NAME = '${a.name}', FILENAME = '${a.filename}'`;return a.size&&(o+=`, SIZE = ${a.size}`),a.maxSize&&(o+=`, MAXSIZE = ${a.maxSize}`),a.growth&&(o+=`, FILEGROWTH = ${a.growth}`),o+=")",o});r.push(`ON ${s.join(", ")}`)}if(n.logFiles){const s=n.logFiles.map(a=>{let o=`(NAME = '${a.name}', FILENAME = '${a.filename}'`;return a.size&&(o+=`, SIZE = ${a.size}`),a.maxSize&&(o+=`, MAXSIZE = ${a.maxSize}`),a.growth&&(o+=`, FILEGROWTH = ${a.growth}`),o+=")",o});r.push(`LOG ON ${s.join(", ")}`)}r.length>0&&(i+=" "+r.join(" "))}await e.query(i)}async dropDatabase(e,t){const n=`DROP DATABASE ${this.quoteIdentifier(t)}`;await e.query(n)}}class cu{connectionService;mysqlService;postgreSQLService;sqliteService;oracleService;sqlServerService;constructor(){this.connectionService=new Qs,this.mysqlService=new iu,this.postgreSQLService=new ru,this.sqliteService=new su,this.oracleService=new au,this.sqlServerService=new ou}getDatabaseService(e){switch(e.toLowerCase()){case"mysql":return this.mysqlService;case"postgres":case"postgresql":return this.postgreSQLService;case"sqlite":return this.sqliteService;case"oracle":return this.oracleService;case"mssql":case"sqlserver":return this.sqlServerService;default:throw new Error(`: ${e}`)}}async getDatabases(e){const t=await this.connectionService.getActiveConnection(e);return this.getDatabaseService(t.options.type).getDatabases(t)}async getDatabaseInfo(e,t){const n=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(n.options.type).getDatabaseInfo(n,t)}async getTables(e,t){const n=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(n.options.type).getTables(n,t)}async getTableInfo(e,t,n){const i=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(i.options.type).getTableInfo(i,t,n)}async getTableData(e,t,n,i=1,r=100,s,a){const o=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(o.options.type).getTableData(o,t,n,i,r,s,a)}async executeQuery(e,t,n){const i=await this.connectionService.getActiveConnection(e,n);return this.getDatabaseService(i.options.type).executeQuery(i,t)}async getViews(e,t){const n=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(n.options.type).getViews(n,t)}async getViewDefinition(e,t,n){const i=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(i.options.type).getViewDefinition(i,t,n)}async getProcedures(e,t){const n=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(n.options.type).getProcedures(n,t)}async getProcedureDefinition(e,t,n){const i=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(i.options.type).getProcedureDefinition(i,t,n)}async testConnection(e){const t=await this.connectionService.getActiveConnection(e);return this.getDatabaseService(t.options.type).testConnection(t)}getSupportedDatabaseTypes(){return[{value:"mysql",label:"MySQL",icon:"bi-database",defaultPort:3306,description:"MySQL",features:{supportSchemas:!1,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0}},{value:"postgres",label:"PostgreSQL",icon:"bi-database",defaultPort:5432,description:"PostgreSQL",features:{supportSchemas:!0,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0,supportArrays:!0,supportEnum:!0}},{value:"sqlite",label:"SQLite",icon:"bi-database",defaultPort:null,description:"SQLite",features:{supportSchemas:!1,supportProcedures:!1,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!1,supportArrays:!1}},{value:"oracle",label:"Oracle",icon:"bi-database",defaultPort:1521,description:"Oracle",features:{supportSchemas:!0,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!1,supportArrays:!1,supportSequences:!0,supportSynonyms:!0}},{value:"mssql",label:"SQL Server",icon:"bi-database",defaultPort:1433,description:"Microsoft SQL Server",features:{supportSchemas:!1,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0,supportArrays:!1,supportStoredProcedures:!0}}]}async createDatabase(e,t,n){const i=await this.connectionService.getActiveConnection(e);return this.getDatabaseService(i.options.type).createDatabase(i,t,n)}async dropDatabase(e,t){const n=await this.connectionService.getActiveConnection(e);return this.getDatabaseService(n.options.type).dropDatabase(n,t)}getDatabaseTypeSpecificConfig(e){return{type:this.getDatabaseService(e).getDatabaseType(),features:this.getDatabaseFeatures(e)}}getDatabaseFeatures(e){switch(e.toLowerCase()){case"mysql":return{supportSchemas:!1,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0};case"postgres":case"postgresql":return{supportSchemas:!0,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0,supportArrays:!0,supportEnum:!0};case"sqlite":return{supportSchemas:!1,supportProcedures:!1,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!1,supportArrays:!1};case"oracle":return{supportSchemas:!0,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!1,supportArrays:!1,supportSequences:!0,supportSynonyms:!0};case"mssql":case"sqlserver":return{supportSchemas:!1,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0,supportArrays:!1,supportStoredProcedures:!0};default:return{}}}}const dt=new Qs,be=new cu;async function wu(p,e){if(p==="/api/database/getConnections")return await dt.getAllConnections();if(p==="/api/database/getConnection"){const{id:t}=e;return await dt.getConnectionById(t)}if(p==="/api/database/addConnection")return await dt.addConnection(e);if(p==="/api/database/updateConnection"){const{id:t,...n}=e;if(!t)throw Error("Missing parameter: id");return await dt.updateConnection(t,n)}if(p==="/api/database/deleteConnection"){const{id:t}=e;if(!t)throw Error("Missing parameter: id");return await dt.deleteConnection(t),!0}if(p==="/api/database/testConnection")return await dt.testConnection(e);if(p==="/api/database/getDatabases"){const{id:t}=e;if(!t)throw Error("Missing parameter: id");return await be.getDatabases(t)}if(p==="/api/database/getDatabaseInfo"){const{id:t,database:n}=e;if(!t||!n)throw Error("Missing parameters: id, database");return await be.getDatabaseInfo(t,n)}if(p==="/api/database/getTables"){const{id:t,database:n}=e;if(!t||!n)throw Error("Missing parameters: id, database");return await be.getTables(t,n)}if(p==="/api/database/getTableInfo"){const{id:t,database:n,table:i}=e;if(!t||!n||!i)throw Error("Missing parameters: id, database, table");return await be.getTableInfo(t,n,i)}if(p==="/api/database/getTableData"){const{id:t,database:n,table:i,page:r=1,pageSize:s=100,where:a,orderBy:o}=e;if(!t||!n||!i)throw Error("Missing parameters: id, database, table");return await be.getTableData(t,n,i,r,s,a,o)}if(p==="/api/database/executeQuery"){const{id:t,sql:n,database:i}=e;if(!t||!n)throw Error("Missing parameters: id, sql");if(!n.trim())throw Error("SQL");return await be.executeQuery(t,n,i)}if(p==="/api/database/closeConnection"){const{id:t}=e;if(!t)throw Error("Missing parameter: id");return await dt.closeConnection(t),await dt.closeAllConnectionsForId(t),!0}if(p==="/api/database/getSupportedDatabaseTypes")return be.getSupportedDatabaseTypes();if(p==="/api/database/createDatabase"){const{id:t,databaseName:n,options:i}=e;if(!t||!n)throw Error("Missing parameters: id, databaseName");return await be.createDatabase(t,n,i),{success:!0}}if(p==="/api/database/dropDatabase"){const{id:t,databaseName:n}=e;if(!t||!n)throw Error("Missing parameters: id, databaseName");return await be.dropDatabase(t,n),{success:!0}}if(p==="/api/database/exportTableData"){const{id:t,database:n,table:i,format:r="json",where:s}=e;if(!t||!n||!i)throw Error("Missing parameters: id, database, table");return await be.getTableData(t,n,i,1,1e4,s)}if(p==="/api/database/saveTableStructure"){const{id:t,database:n,table:i,columns:r}=e;if(!t||!n||!i||!r)throw Error("Missing parameters");const s=uu(i.name,r,i),a=await be.executeQuery(t,s,n);return{success:!0,sql:s,result:a}}if(p==="/api/database/alterTable"){const{id:t,database:n,tableName:i,columns:r,oldColumns:s}=e;if(!t||!n||!i||!r)throw Error("Missing parameters");const a=lu(i,r,s),o=[];for(const c of a){const u=await be.executeQuery(t,c,n);o.push({sql:c,result:u})}return{success:!0,statements:a,results:o}}if(p==="/api/database/insertData"){const{id:t,database:n,table:i,data:r}=e;if(!t||!n||!i||!r)throw Error("Missing parameters");const s=hu(i,r),a=await be.executeQuery(t,s,n);return{sql:s,result:a}}if(p==="/api/database/updateData"){const{id:t,database:n,table:i,data:r,where:s}=e;if(!t||!n||!i||!r||!s)throw Error("Missing parameters");const a=du(i,r,s),o=await be.executeQuery(t,a,n);return{sql:a,result:o}}if(p==="/api/database/deleteData"){const{id:t,database:n,table:i,where:r}=e;if(!t||!n||!i||!r)throw Error("Missing parameters");const s=pu(i,r),a=await be.executeQuery(t,s,n);return{success:!0,sql:s,result:a}}if(p.startsWith("/api/database/truncateTable/")){const t=p.split("/").filter(Boolean);if(t.length<5)throw Error("Invalid URL format");const n=t[3],i=t[4],r=t[5];if(!n||!i||!r)throw Error("Missing parameters");const s=await be.connectionService.getActiveConnection(n,i),o=`TRUNCATE TABLE ${be.getDatabaseService(s.options.type).quoteIdentifier(r)}`,c=await be.executeQuery(n,o,i);return{success:!0,sql:o,result:c}}if(p.startsWith("/api/database/dropTable/")){const t=p.split("/").filter(Boolean);if(t.length<5)throw Error("Invalid URL format");const n=t[3],i=t[4],r=t[5];if(!n||!i||!r)throw Error("Missing parameters");const s=await be.connectionService.getActiveConnection(n,i),o=`DROP TABLE ${be.getDatabaseService(s.options.type).quoteIdentifier(r)}`,c=await be.executeQuery(n,o,i);return{success:!0,sql:o,result:c}}if(p==="/api/database/getViews"){const{id:t,database:n}=e;if(!t||!n)throw Error("Missing parameters: id, database");return await be.getViews(t,n)}if(p==="/api/database/getViewDefinition"){const{id:t,database:n,viewName:i}=e;if(!t||!n||!i)throw Error("Missing parameters: id, database, viewName");return await be.getViewDefinition(t,n,i)}if(p==="/api/database/createView"){const{id:t,database:n,viewName:i,definition:r}=e;if(!t||!n||!i||!r)throw Error("Missing parameters: id, database, viewName, definition");const s=await be.connectionService.getActiveConnection(t,n),o=`CREATE VIEW ${be.getDatabaseService(s.options.type).quoteIdentifier(i)} AS ${r}`,c=await be.executeQuery(t,o,n);return{success:!0,sql:o,result:c}}if(p==="/api/database/dropView"){const{id:t,database:n,viewName:i}=e;if(!t||!n||!i)throw Error("Missing parameters: id, database, viewName");const r=await be.connectionService.getActiveConnection(t,n),a=`DROP VIEW ${be.getDatabaseService(r.options.type).quoteIdentifier(i)}`,o=await be.executeQuery(t,a,n);return{success:!0,sql:a,result:o}}if(p==="/api/database/getProcedures"){const{id:t,database:n}=e;if(!t||!n)throw Error("Missing parameters: id, database");return await be.getProcedures(t,n)}if(p==="/api/database/getProcedureDefinition"){const{id:t,database:n,procedureName:i}=e;if(!t||!n||!i)throw Error("Missing parameters: id, database, procedureName");return await be.getProcedureDefinition(t,n,i)}throw Error("API endpoint not found")}function uu(p,e,t){let n=`CREATE TABLE \`${p}\` (
`;const i=[];return e.forEach((r,s)=>{const a=[];a.push(`  \`${r.name}\``),a.push(ks(r)),r.nullable||a.push("NOT NULL"),r.defaultValue!==null&&r.defaultValue!==""&&a.push(`DEFAULT ${Vs(r.defaultValue,r.type)}`),r.isAutoIncrement&&a.push("AUTO_INCREMENT"),r.comment&&a.push(`COMMENT '${r.comment}'`),n+=a.join(" "),s<e.length-1&&(n+=`,
`),r.isPrimary&&i.push(r.name)}),i.length>0&&(n+=`,
  PRIMARY KEY (\`${i.join("`, `")}\`)`),n+=`
) ENGINE=${t.engine} DEFAULT CHARSET=${t.charset} COLLATE=${t.collation}`,t.comment&&(n+=` COMMENT='${t.comment}'`),n+=";",n}function lu(p,e,t=[]){const n=[];n.push(`DROP TABLE IF EXISTS \`${p}_temp\`;`);let i=`CREATE TABLE \`${p}_temp\` (
`;const r=[];return e.forEach((s,a)=>{const o=[];o.push(`  \`${s.name}\``),o.push(ks(s)),s.nullable||o.push("NOT NULL"),s.defaultValue!==null&&s.defaultValue!==""&&o.push(`DEFAULT ${Vs(s.defaultValue,s.type)}`),s.isAutoIncrement&&o.push("AUTO_INCREMENT"),s.comment&&o.push(`COMMENT '${s.comment}'`),i+=o.join(" "),a<e.length-1&&(i+=`,
`),s.isPrimary&&r.push(s.name)}),r.length>0&&(i+=`,
  PRIMARY KEY (\`${r.join("`, `")}\`)`),i+=`
);`,n.push(i),n.push(`INSERT INTO \`${p}_temp\` SELECT * FROM \`${p}\`;`),n.push(`DROP TABLE \`${p}\`;`),n.push(`RENAME TABLE \`${p}_temp\` TO \`${p}\`;`),n}function hu(p,e){const t=Object.keys(e),n=Object.values(e),i=t.map(s=>`\`${s}\``).join(", "),r=n.map(s=>zt(s)).join(", ");return`INSERT INTO \`${p}\` (${i}) VALUES (${r});`}function du(p,e,t){const n=Object.entries(e).map(([r,s])=>`\`${r}\` = ${zt(s)}`).join(", "),i=Object.entries(t).map(([r,s])=>`\`${r}\` = ${zt(s)}`).join(" AND ");return`UPDATE \`${p}\` SET ${n} WHERE ${i};`}function pu(p,e){const t=Object.entries(e).map(([n,i])=>`\`${n}\` = ${zt(i)}`).join(" AND ");return`DELETE FROM \`${p}\` WHERE ${t};`}function ks(p){let e=p.type.toUpperCase();return mu(p.type)&&p.length&&(e+=`(${p.length})`),e}function mu(p){return["varchar","char","decimal","float","double"].some(t=>p.startsWith(t))}function Vs(p,e){return p===""||p===null||p===void 0?"NULL":fu(e)||["float","double","decimal"].includes(e)?p:`'${p.replace(/'/g,"''")}'`}function zt(p){if(p==null)return"NULL";if(typeof p=="number"||typeof p=="boolean")return String(p);if(p instanceof Date)return`'${p.toISOString().slice(0,19).replace("T"," ")}'`;if(typeof p=="object"&&p!==null)try{return`'${JSON.stringify(p).replace(/'/g,"''")}'`}catch{return`'${String(p).replace(/'/g,"''")}'`}return`'${String(p).replace(/'/g,"''")}'`}function fu(p){return["int","bigint","tinyint","smallint","mediumint"].includes(p)}export{wu as handleDatabaseRoutes};
