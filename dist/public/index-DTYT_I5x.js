import{c as Wt,b as ys}from"./index-DLTQcwRk.js";import"./vue-b5kXG6k_.js";import"./bootstrap-Bqj8QN9l.js";var Mr={};var vr;function Js(){if(vr)return Mr;vr=1;var d;return(function(e){(function(t){var n=typeof globalThis=="object"?globalThis:typeof Wt=="object"?Wt:typeof self=="object"?self:typeof this=="object"?this:o(),r=i(e);typeof n.Reflect<"u"&&(r=i(n.Reflect,r)),t(r,n),typeof n.Reflect>"u"&&(n.Reflect=e);function i(c,u){return function(l,h){Object.defineProperty(c,l,{configurable:!0,writable:!0,value:h}),u&&u(l,h)}}function s(){try{return Function("return this;")()}catch{}}function a(){try{return(0,eval)("(function() { return this; })()")}catch{}}function o(){return s()||a()}})(function(t,n){var r=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",s=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",a=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",o=typeof Object.create=="function",c={__proto__:[]}instanceof Array,u=!o&&!c,l={create:o?function(){return O(Object.create(null))}:c?function(){return O({__proto__:null})}:function(){return O({})},has:u?function(w,x){return r.call(w,x)}:function(w,x){return x in w},get:u?function(w,x){return r.call(w,x)?w[x]:void 0}:function(w,x){return w[x]}},h=Object.getPrototypeOf(Function),f=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:p(),E=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:m(),b=typeof WeakMap=="function"?WeakMap:C(),A=i?Symbol.for("@reflect-metadata:registry"):void 0,P=Ne(),D=xe(P);function I(w,x,_,z){if(Z(_)){if(!we(w))throw new TypeError;if(!Oe(x))throw new TypeError;return Q(w,x)}else{if(!we(w))throw new TypeError;if(!Se(x))throw new TypeError;if(!Se(z)&&!Z(z)&&!Me(z))throw new TypeError;return Me(z)&&(z=void 0),_=be(_),B(w,x,_,z)}}t("decorate",I);function W(w,x){function _(z,te){if(!Se(z))throw new TypeError;if(!Z(te)&&!Ge(te))throw new TypeError;X(w,x,z,te)}return _}t("metadata",W);function G(w,x,_,z){if(!Se(_))throw new TypeError;return Z(z)||(z=be(z)),X(w,x,_,z)}t("defineMetadata",G);function ie(w,x,_){if(!Se(x))throw new TypeError;return Z(_)||(_=be(_)),U(w,x,_)}t("hasMetadata",ie);function ne(w,x,_){if(!Se(x))throw new TypeError;return Z(_)||(_=be(_)),k(w,x,_)}t("hasOwnMetadata",ne);function pe(w,x,_){if(!Se(x))throw new TypeError;return Z(_)||(_=be(_)),L(w,x,_)}t("getMetadata",pe);function F(w,x,_){if(!Se(x))throw new TypeError;return Z(_)||(_=be(_)),V(w,x,_)}t("getOwnMetadata",F);function se(w,x){if(!Se(w))throw new TypeError;return Z(x)||(x=be(x)),oe(w,x)}t("getMetadataKeys",se);function v(w,x){if(!Se(w))throw new TypeError;return Z(x)||(x=be(x)),ee(w,x)}t("getOwnMetadataKeys",v);function Y(w,x,_){if(!Se(x))throw new TypeError;if(Z(_)||(_=be(_)),!Se(x))throw new TypeError;Z(_)||(_=be(_));var z=T(x,_,!1);return Z(z)?!1:z.OrdinaryDeleteMetadata(w,x,_)}t("deleteMetadata",Y);function Q(w,x){for(var _=w.length-1;_>=0;--_){var z=w[_],te=z(x);if(!Z(te)&&!Me(te)){if(!Oe(te))throw new TypeError;x=te}}return x}function B(w,x,_,z){for(var te=w.length-1;te>=0;--te){var Te=w[te],ge=Te(x,_,z);if(!Z(ge)&&!Me(ge)){if(!Se(ge))throw new TypeError;z=ge}}return z}function U(w,x,_){var z=k(w,x,_);if(z)return!0;var te=H(x);return Me(te)?!1:U(w,te,_)}function k(w,x,_){var z=T(x,_,!1);return Z(z)?!1:Re(z.OrdinaryHasOwnMetadata(w,x,_))}function L(w,x,_){var z=k(w,x,_);if(z)return V(w,x,_);var te=H(x);if(!Me(te))return L(w,te,_)}function V(w,x,_){var z=T(x,_,!1);if(!Z(z))return z.OrdinaryGetOwnMetadata(w,x,_)}function X(w,x,_,z){var te=T(_,z,!0);te.OrdinaryDefineOwnMetadata(w,x,_,z)}function oe(w,x){var _=ee(w,x),z=H(w);if(z===null)return _;var te=oe(z,x);if(te.length<=0)return _;if(_.length<=0)return te;for(var Te=new E,ge=[],Ae=0,re=_;Ae<re.length;Ae++){var ae=re[Ae],ue=Te.has(ae);ue||(Te.add(ae),ge.push(ae))}for(var le=0,Ce=te;le<Ce.length;le++){var ae=Ce[le],ue=Te.has(ae);ue||(Te.add(ae),ge.push(ae))}return ge}function ee(w,x){var _=T(w,x,!1);return _?_.OrdinaryOwnMetadataKeys(w,x):[]}function ce(w){if(w===null)return 1;switch(typeof w){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return w===null?1:6;default:return 6}}function Z(w){return w===void 0}function Me(w){return w===null}function qe(w){return typeof w=="symbol"}function Se(w){return typeof w=="object"?w!==null:typeof w=="function"}function je(w,x){switch(ce(w)){case 0:return w;case 1:return w;case 2:return w;case 3:return w;case 4:return w;case 5:return w}var _="string",z=y(w,s);if(z!==void 0){var te=z.call(w,_);if(Se(te))throw new TypeError;return te}return Pe(w)}function Pe(w,x){var _,z,te;{var Te=w.toString;if(Ee(Te)){var z=Te.call(w);if(!Se(z))return z}var _=w.valueOf;if(Ee(_)){var z=_.call(w);if(!Se(z))return z}}throw new TypeError}function Re(w){return!!w}function fe(w){return""+w}function be(w){var x=je(w);return qe(x)?x:fe(x)}function we(w){return Array.isArray?Array.isArray(w):w instanceof Object?w instanceof Array:Object.prototype.toString.call(w)==="[object Array]"}function Ee(w){return typeof w=="function"}function Oe(w){return typeof w=="function"}function Ge(w){switch(ce(w)){case 3:return!0;case 4:return!0;default:return!1}}function N(w,x){return w===x||w!==w&&x!==x}function y(w,x){var _=w[x];if(_!=null){if(!Ee(_))throw new TypeError;return _}}function g(w){var x=y(w,a);if(!Ee(x))throw new TypeError;var _=x.call(w);if(!Se(_))throw new TypeError;return _}function S(w){return w.value}function $(w){var x=w.next();return x.done?!1:x}function j(w){var x=w.return;x&&x.call(w)}function H(w){var x=Object.getPrototypeOf(w);if(typeof w!="function"||w===h||x!==h)return x;var _=w.prototype,z=_&&Object.getPrototypeOf(_);if(z==null||z===Object.prototype)return x;var te=z.constructor;return typeof te!="function"||te===w?x:te}function ye(){var w;!Z(A)&&typeof n.Reflect<"u"&&!(A in n.Reflect)&&typeof n.Reflect.defineMetadata=="function"&&(w=Fe(n.Reflect));var x,_,z,te=new b,Te={registerProvider:ge,getProvider:re,setProvider:ue};return Te;function ge(le){if(!Object.isExtensible(Te))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case w===le:break;case Z(x):x=le;break;case x===le:break;case Z(_):_=le;break;case _===le:break;default:z===void 0&&(z=new E),z.add(le);break}}function Ae(le,Ce){if(!Z(x)){if(x.isProviderFor(le,Ce))return x;if(!Z(_)){if(_.isProviderFor(le,Ce))return x;if(!Z(z))for(var De=g(z);;){var Ue=$(De);if(!Ue)return;var Ze=S(Ue);if(Ze.isProviderFor(le,Ce))return j(De),Ze}}}if(!Z(w)&&w.isProviderFor(le,Ce))return w}function re(le,Ce){var De=te.get(le),Ue;return Z(De)||(Ue=De.get(Ce)),Z(Ue)&&(Ue=Ae(le,Ce),Z(Ue)||(Z(De)&&(De=new f,te.set(le,De)),De.set(Ce,Ue))),Ue}function ae(le){if(Z(le))throw new TypeError;return x===le||_===le||!Z(z)&&z.has(le)}function ue(le,Ce,De){if(!ae(De))throw new Error("Metadata provider not registered.");var Ue=re(le,Ce);if(Ue!==De){if(!Z(Ue))return!1;var Ze=te.get(le);Z(Ze)&&(Ze=new f,te.set(le,Ze)),Ze.set(Ce,De)}return!0}}function Ne(){var w;return!Z(A)&&Se(n.Reflect)&&Object.isExtensible(n.Reflect)&&(w=n.Reflect[A]),Z(w)&&(w=ye()),!Z(A)&&Se(n.Reflect)&&Object.isExtensible(n.Reflect)&&Object.defineProperty(n.Reflect,A,{enumerable:!1,configurable:!1,writable:!1,value:w}),w}function xe(w){var x=new b,_={isProviderFor:function(ae,ue){var le=x.get(ae);return Z(le)?!1:le.has(ue)},OrdinaryDefineOwnMetadata:ge,OrdinaryHasOwnMetadata:te,OrdinaryGetOwnMetadata:Te,OrdinaryOwnMetadataKeys:Ae,OrdinaryDeleteMetadata:re};return P.registerProvider(_),_;function z(ae,ue,le){var Ce=x.get(ae),De=!1;if(Z(Ce)){if(!le)return;Ce=new f,x.set(ae,Ce),De=!0}var Ue=Ce.get(ue);if(Z(Ue)){if(!le)return;if(Ue=new f,Ce.set(ue,Ue),!w.setProvider(ae,ue,_))throw Ce.delete(ue),De&&x.delete(ae),new Error("Wrong provider for target.")}return Ue}function te(ae,ue,le){var Ce=z(ue,le,!1);return Z(Ce)?!1:Re(Ce.has(ae))}function Te(ae,ue,le){var Ce=z(ue,le,!1);if(!Z(Ce))return Ce.get(ae)}function ge(ae,ue,le,Ce){var De=z(le,Ce,!0);De.set(ae,ue)}function Ae(ae,ue){var le=[],Ce=z(ae,ue,!1);if(Z(Ce))return le;for(var De=Ce.keys(),Ue=g(De),Ze=0;;){var xr=$(Ue);if(!xr)return le.length=Ze,le;var zs=S(xr);try{le[Ze]=zs}catch(Ks){try{j(Ue)}finally{throw Ks}}Ze++}}function re(ae,ue,le){var Ce=z(ue,le,!1);if(Z(Ce)||!Ce.delete(ae))return!1;if(Ce.size===0){var De=x.get(ue);Z(De)||(De.delete(le),De.size===0&&x.delete(De))}return!0}}function Fe(w){var x=w.defineMetadata,_=w.hasOwnMetadata,z=w.getOwnMetadata,te=w.getOwnMetadataKeys,Te=w.deleteMetadata,ge=new b,Ae={isProviderFor:function(re,ae){var ue=ge.get(re);return!Z(ue)&&ue.has(ae)?!0:te(re,ae).length?(Z(ue)&&(ue=new E,ge.set(re,ue)),ue.add(ae),!0):!1},OrdinaryDefineOwnMetadata:x,OrdinaryHasOwnMetadata:_,OrdinaryGetOwnMetadata:z,OrdinaryOwnMetadataKeys:te,OrdinaryDeleteMetadata:Te};return Ae}function T(w,x,_){var z=P.getProvider(w,x);if(!Z(z))return z;if(_){if(P.setProvider(w,x,D))return D;throw new Error("Illegal state.")}}function p(){var w={},x=[],_=(function(){function Ae(re,ae,ue){this._index=0,this._keys=re,this._values=ae,this._selector=ue}return Ae.prototype["@@iterator"]=function(){return this},Ae.prototype[a]=function(){return this},Ae.prototype.next=function(){var re=this._index;if(re>=0&&re<this._keys.length){var ae=this._selector(this._keys[re],this._values[re]);return re+1>=this._keys.length?(this._index=-1,this._keys=x,this._values=x):this._index++,{value:ae,done:!1}}return{value:void 0,done:!0}},Ae.prototype.throw=function(re){throw this._index>=0&&(this._index=-1,this._keys=x,this._values=x),re},Ae.prototype.return=function(re){return this._index>=0&&(this._index=-1,this._keys=x,this._values=x),{value:re,done:!0}},Ae})(),z=(function(){function Ae(){this._keys=[],this._values=[],this._cacheKey=w,this._cacheIndex=-2}return Object.defineProperty(Ae.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Ae.prototype.has=function(re){return this._find(re,!1)>=0},Ae.prototype.get=function(re){var ae=this._find(re,!1);return ae>=0?this._values[ae]:void 0},Ae.prototype.set=function(re,ae){var ue=this._find(re,!0);return this._values[ue]=ae,this},Ae.prototype.delete=function(re){var ae=this._find(re,!1);if(ae>=0){for(var ue=this._keys.length,le=ae+1;le<ue;le++)this._keys[le-1]=this._keys[le],this._values[le-1]=this._values[le];return this._keys.length--,this._values.length--,N(re,this._cacheKey)&&(this._cacheKey=w,this._cacheIndex=-2),!0}return!1},Ae.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=w,this._cacheIndex=-2},Ae.prototype.keys=function(){return new _(this._keys,this._values,te)},Ae.prototype.values=function(){return new _(this._keys,this._values,Te)},Ae.prototype.entries=function(){return new _(this._keys,this._values,ge)},Ae.prototype["@@iterator"]=function(){return this.entries()},Ae.prototype[a]=function(){return this.entries()},Ae.prototype._find=function(re,ae){if(!N(this._cacheKey,re)){this._cacheIndex=-1;for(var ue=0;ue<this._keys.length;ue++)if(N(this._keys[ue],re)){this._cacheIndex=ue;break}}return this._cacheIndex<0&&ae&&(this._cacheIndex=this._keys.length,this._keys.push(re),this._values.push(void 0)),this._cacheIndex},Ae})();return z;function te(Ae,re){return Ae}function Te(Ae,re){return re}function ge(Ae,re){return[Ae,re]}}function m(){var w=(function(){function x(){this._map=new f}return Object.defineProperty(x.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),x.prototype.has=function(_){return this._map.has(_)},x.prototype.add=function(_){return this._map.set(_,_),this},x.prototype.delete=function(_){return this._map.delete(_)},x.prototype.clear=function(){this._map.clear()},x.prototype.keys=function(){return this._map.keys()},x.prototype.values=function(){return this._map.keys()},x.prototype.entries=function(){return this._map.entries()},x.prototype["@@iterator"]=function(){return this.keys()},x.prototype[a]=function(){return this.keys()},x})();return w}function C(){var w=16,x=l.create(),_=z();return(function(){function re(){this._key=z()}return re.prototype.has=function(ae){var ue=te(ae,!1);return ue!==void 0?l.has(ue,this._key):!1},re.prototype.get=function(ae){var ue=te(ae,!1);return ue!==void 0?l.get(ue,this._key):void 0},re.prototype.set=function(ae,ue){var le=te(ae,!0);return le[this._key]=ue,this},re.prototype.delete=function(ae){var ue=te(ae,!1);return ue!==void 0?delete ue[this._key]:!1},re.prototype.clear=function(){this._key=z()},re})();function z(){var re;do re="@@WeakMap@@"+Ae();while(l.has(x,re));return x[re]=!0,re}function te(re,ae){if(!r.call(re,_)){if(!ae)return;Object.defineProperty(re,_,{value:l.create()})}return re[_]}function Te(re,ae){for(var ue=0;ue<ae;++ue)re[ue]=Math.random()*255|0;return re}function ge(re){if(typeof Uint8Array=="function"){var ae=new Uint8Array(re);return typeof crypto<"u"?crypto.getRandomValues(ae):typeof msCrypto<"u"?msCrypto.getRandomValues(ae):Te(ae,re),ae}return Te(new Array(re),re)}function Ae(){var re=ge(w);re[6]=re[6]&79|64,re[8]=re[8]&191|128;for(var ae="",ue=0;ue<w;++ue){var le=re[ue];(ue===4||ue===6||ue===8)&&(ae+="-"),le<16&&(ae+="0"),ae+=le.toString(16).toLowerCase()}return ae}}function O(w){return w.__=void 0,delete w.__,w}})})(d||(d={})),Mr}Js();class jt{static getInheritanceTree(e){const t=[e],n=r=>{const i=Object.getPrototypeOf(r);i&&i.name&&(t.push(i),n(i))};return n(e),t}static isInherited(e,t){return e.prototype instanceof t}static filterByTarget(e,t){return t?e.filter(n=>n.target&&t.indexOf(n.target)!==-1):e}}class gs{constructor(){this.tables=[],this.trees=[],this.entityRepositories=[],this.transactionEntityManagers=[],this.transactionRepositories=[],this.namingStrategies=[],this.entitySubscribers=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.columns=[],this.generations=[],this.relations=[],this.joinColumns=[],this.joinTables=[],this.entityListeners=[],this.relationCounts=[],this.relationIds=[],this.embeddeds=[],this.inheritances=[],this.discriminatorValues=[]}filterTables(e){return this.filterByTarget(this.tables,e)}filterColumns(e){return this.filterByTargetAndWithoutDuplicateProperties(this.columns,e)}findGenerated(e,t){return this.generations.find(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.propertyName===t)}findTree(e){return this.trees.find(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterRelations(e){return this.filterByTargetAndWithoutDuplicateRelationProperties(this.relations,e)}filterRelationIds(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationIds,e)}filterRelationCounts(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationCounts,e)}filterIndices(e){return this.indices.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterForeignKeys(e){return this.foreignKeys.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterUniques(e){return this.uniques.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterChecks(e){return this.checks.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterExclusions(e){return this.exclusions.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterListeners(e){return this.filterByTarget(this.entityListeners,e)}filterEmbeddeds(e){return this.filterByTargetAndWithoutDuplicateEmbeddedProperties(this.embeddeds,e)}findJoinTable(e,t){return this.joinTables.find(n=>n.target===e&&n.propertyName===t)}filterJoinColumns(e,t){return this.joinColumns.filter(n=>n.target===e&&n.propertyName===t)}filterSubscribers(e){return this.filterByTarget(this.entitySubscribers,e)}filterNamingStrategies(e){return this.filterByTarget(this.namingStrategies,e)}filterTransactionEntityManagers(e,t){return this.transactionEntityManagers.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterTransactionRepository(e,t){return this.transactionRepositories.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterSingleTableChildren(e){return this.tables.filter(t=>typeof t.target=="function"&&typeof e=="function"&&jt.isInherited(t.target,e)&&t.type==="entity-child")}findInheritanceType(e){return this.inheritances.find(t=>t.target===e)}findDiscriminatorValue(e){return this.discriminatorValues.find(t=>t.target===e)}filterByTarget(e,t){return e.filter(n=>Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)}filterByTargetAndWithoutDuplicateProperties(e,t){const n=[];return e.forEach(r=>{(Array.isArray(t)?t.indexOf(r.target)!==-1:r.target===t)&&(n.find(s=>s.propertyName===r.propertyName)||n.push(r))}),n}filterByTargetAndWithoutDuplicateRelationProperties(e,t){const n=[];return e.forEach(r=>{if(Array.isArray(t)?t.indexOf(r.target)!==-1:r.target===t){const s=n.findIndex(a=>a.propertyName===r.propertyName);if(Array.isArray(t)&&s!==-1&&t.indexOf(r.target)<t.indexOf(n[s].target)){const a=Object.create(n[s]);a.type=r.type,n[s]=a}else s===-1&&n.push(r)}}),n}filterByTargetAndWithoutDuplicateEmbeddedProperties(e,t){const n=[];return e.forEach(r=>{(Array.isArray(t)?t.indexOf(r.target)!==-1:r.target===t)&&(n.find(a=>a.prefix===r.prefix&&a.propertyName===r.propertyName)||n.push(r))}),n}}var nn={},Ct={},Pr;function Es(){if(Pr)return Ct;Pr=1,Ct.byteLength=a,Ct.toByteArray=c,Ct.fromByteArray=h;for(var d=[],e=[],t=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=0,i=n.length;r<i;++r)d[r]=n[r],e[n.charCodeAt(r)]=r;e[45]=62,e[95]=63;function s(f){var E=f.length;if(E%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var b=f.indexOf("=");b===-1&&(b=E);var A=b===E?0:4-b%4;return[b,A]}function a(f){var E=s(f),b=E[0],A=E[1];return(b+A)*3/4-A}function o(f,E,b){return(E+b)*3/4-b}function c(f){var E,b=s(f),A=b[0],P=b[1],D=new t(o(f,A,P)),I=0,W=P>0?A-4:A,G;for(G=0;G<W;G+=4)E=e[f.charCodeAt(G)]<<18|e[f.charCodeAt(G+1)]<<12|e[f.charCodeAt(G+2)]<<6|e[f.charCodeAt(G+3)],D[I++]=E>>16&255,D[I++]=E>>8&255,D[I++]=E&255;return P===2&&(E=e[f.charCodeAt(G)]<<2|e[f.charCodeAt(G+1)]>>4,D[I++]=E&255),P===1&&(E=e[f.charCodeAt(G)]<<10|e[f.charCodeAt(G+1)]<<4|e[f.charCodeAt(G+2)]>>2,D[I++]=E>>8&255,D[I++]=E&255),D}function u(f){return d[f>>18&63]+d[f>>12&63]+d[f>>6&63]+d[f&63]}function l(f,E,b){for(var A,P=[],D=E;D<b;D+=3)A=(f[D]<<16&16711680)+(f[D+1]<<8&65280)+(f[D+2]&255),P.push(u(A));return P.join("")}function h(f){for(var E,b=f.length,A=b%3,P=[],D=16383,I=0,W=b-A;I<W;I+=D)P.push(l(f,I,I+D>W?W:I+D));return A===1?(E=f[b-1],P.push(d[E>>2]+d[E<<4&63]+"==")):A===2&&(E=(f[b-2]<<8)+f[b-1],P.push(d[E>>10]+d[E>>4&63]+d[E<<2&63]+"=")),P.join("")}return Ct}var Dt={};var Ir;function Ts(){return Ir||(Ir=1,Dt.read=function(d,e,t,n,r){var i,s,a=r*8-n-1,o=(1<<a)-1,c=o>>1,u=-7,l=t?r-1:0,h=t?-1:1,f=d[e+l];for(l+=h,i=f&(1<<-u)-1,f>>=-u,u+=a;u>0;i=i*256+d[e+l],l+=h,u-=8);for(s=i&(1<<-u)-1,i>>=-u,u+=n;u>0;s=s*256+d[e+l],l+=h,u-=8);if(i===0)i=1-c;else{if(i===o)return s?NaN:(f?-1:1)*(1/0);s=s+Math.pow(2,n),i=i-c}return(f?-1:1)*s*Math.pow(2,i-n)},Dt.write=function(d,e,t,n,r,i){var s,a,o,c=i*8-r-1,u=(1<<c)-1,l=u>>1,h=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:i-1,E=n?1:-1,b=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=u):(s=Math.floor(Math.log(e)/Math.LN2),e*(o=Math.pow(2,-s))<1&&(s--,o*=2),s+l>=1?e+=h/o:e+=h*Math.pow(2,1-l),e*o>=2&&(s++,o/=2),s+l>=u?(a=0,s=u):s+l>=1?(a=(e*o-1)*Math.pow(2,r),s=s+l):(a=e*Math.pow(2,l-1)*Math.pow(2,r),s=0));r>=8;d[t+f]=a&255,f+=E,a/=256,r-=8);for(s=s<<r|a,c+=r;c>0;d[t+f]=s&255,f+=E,s/=256,c-=8);d[t+f-E]|=b*128}),Dt}var Or;function Ys(){return Or||(Or=1,(function(d){const e=Es(),t=Ts(),n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;d.Buffer=a,d.SlowBuffer=D,d.INSPECT_MAX_BYTES=50;const r=2147483647;d.kMaxLength=r,a.TYPED_ARRAY_SUPPORT=i(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function i(){try{const T=new Uint8Array(1),p={foo:function(){return 42}};return Object.setPrototypeOf(p,Uint8Array.prototype),Object.setPrototypeOf(T,p),T.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function s(T){if(T>r)throw new RangeError('The value "'+T+'" is invalid for option "size"');const p=new Uint8Array(T);return Object.setPrototypeOf(p,a.prototype),p}function a(T,p,m){if(typeof T=="number"){if(typeof p=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return l(T)}return o(T,p,m)}a.poolSize=8192;function o(T,p,m){if(typeof T=="string")return h(T,p);if(ArrayBuffer.isView(T))return E(T);if(T==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof T);if(H(T,ArrayBuffer)||T&&H(T.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(H(T,SharedArrayBuffer)||T&&H(T.buffer,SharedArrayBuffer)))return b(T,p,m);if(typeof T=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const C=T.valueOf&&T.valueOf();if(C!=null&&C!==T)return a.from(C,p,m);const O=A(T);if(O)return O;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof T[Symbol.toPrimitive]=="function")return a.from(T[Symbol.toPrimitive]("string"),p,m);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof T)}a.from=function(T,p,m){return o(T,p,m)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function c(T){if(typeof T!="number")throw new TypeError('"size" argument must be of type number');if(T<0)throw new RangeError('The value "'+T+'" is invalid for option "size"')}function u(T,p,m){return c(T),T<=0?s(T):p!==void 0?typeof m=="string"?s(T).fill(p,m):s(T).fill(p):s(T)}a.alloc=function(T,p,m){return u(T,p,m)};function l(T){return c(T),s(T<0?0:P(T)|0)}a.allocUnsafe=function(T){return l(T)},a.allocUnsafeSlow=function(T){return l(T)};function h(T,p){if((typeof p!="string"||p==="")&&(p="utf8"),!a.isEncoding(p))throw new TypeError("Unknown encoding: "+p);const m=I(T,p)|0;let C=s(m);const O=C.write(T,p);return O!==m&&(C=C.slice(0,O)),C}function f(T){const p=T.length<0?0:P(T.length)|0,m=s(p);for(let C=0;C<p;C+=1)m[C]=T[C]&255;return m}function E(T){if(H(T,Uint8Array)){const p=new Uint8Array(T);return b(p.buffer,p.byteOffset,p.byteLength)}return f(T)}function b(T,p,m){if(p<0||T.byteLength<p)throw new RangeError('"offset" is outside of buffer bounds');if(T.byteLength<p+(m||0))throw new RangeError('"length" is outside of buffer bounds');let C;return p===void 0&&m===void 0?C=new Uint8Array(T):m===void 0?C=new Uint8Array(T,p):C=new Uint8Array(T,p,m),Object.setPrototypeOf(C,a.prototype),C}function A(T){if(a.isBuffer(T)){const p=P(T.length)|0,m=s(p);return m.length===0||T.copy(m,0,0,p),m}if(T.length!==void 0)return typeof T.length!="number"||ye(T.length)?s(0):f(T);if(T.type==="Buffer"&&Array.isArray(T.data))return f(T.data)}function P(T){if(T>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return T|0}function D(T){return+T!=T&&(T=0),a.alloc(+T)}a.isBuffer=function(p){return p!=null&&p._isBuffer===!0&&p!==a.prototype},a.compare=function(p,m){if(H(p,Uint8Array)&&(p=a.from(p,p.offset,p.byteLength)),H(m,Uint8Array)&&(m=a.from(m,m.offset,m.byteLength)),!a.isBuffer(p)||!a.isBuffer(m))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(p===m)return 0;let C=p.length,O=m.length;for(let w=0,x=Math.min(C,O);w<x;++w)if(p[w]!==m[w]){C=p[w],O=m[w];break}return C<O?-1:O<C?1:0},a.isEncoding=function(p){switch(String(p).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(p,m){if(!Array.isArray(p))throw new TypeError('"list" argument must be an Array of Buffers');if(p.length===0)return a.alloc(0);let C;if(m===void 0)for(m=0,C=0;C<p.length;++C)m+=p[C].length;const O=a.allocUnsafe(m);let w=0;for(C=0;C<p.length;++C){let x=p[C];if(H(x,Uint8Array))w+x.length>O.length?(a.isBuffer(x)||(x=a.from(x)),x.copy(O,w)):Uint8Array.prototype.set.call(O,x,w);else if(a.isBuffer(x))x.copy(O,w);else throw new TypeError('"list" argument must be an Array of Buffers');w+=x.length}return O};function I(T,p){if(a.isBuffer(T))return T.length;if(ArrayBuffer.isView(T)||H(T,ArrayBuffer))return T.byteLength;if(typeof T!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof T);const m=T.length,C=arguments.length>2&&arguments[2]===!0;if(!C&&m===0)return 0;let O=!1;for(;;)switch(p){case"ascii":case"latin1":case"binary":return m;case"utf8":case"utf-8":return y(T).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return m*2;case"hex":return m>>>1;case"base64":return $(T).length;default:if(O)return C?-1:y(T).length;p=(""+p).toLowerCase(),O=!0}}a.byteLength=I;function W(T,p,m){let C=!1;if((p===void 0||p<0)&&(p=0),p>this.length||((m===void 0||m>this.length)&&(m=this.length),m<=0)||(m>>>=0,p>>>=0,m<=p))return"";for(T||(T="utf8");;)switch(T){case"hex":return X(this,p,m);case"utf8":case"utf-8":return B(this,p,m);case"ascii":return L(this,p,m);case"latin1":case"binary":return V(this,p,m);case"base64":return Q(this,p,m);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return oe(this,p,m);default:if(C)throw new TypeError("Unknown encoding: "+T);T=(T+"").toLowerCase(),C=!0}}a.prototype._isBuffer=!0;function G(T,p,m){const C=T[p];T[p]=T[m],T[m]=C}a.prototype.swap16=function(){const p=this.length;if(p%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let m=0;m<p;m+=2)G(this,m,m+1);return this},a.prototype.swap32=function(){const p=this.length;if(p%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let m=0;m<p;m+=4)G(this,m,m+3),G(this,m+1,m+2);return this},a.prototype.swap64=function(){const p=this.length;if(p%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let m=0;m<p;m+=8)G(this,m,m+7),G(this,m+1,m+6),G(this,m+2,m+5),G(this,m+3,m+4);return this},a.prototype.toString=function(){const p=this.length;return p===0?"":arguments.length===0?B(this,0,p):W.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(p){if(!a.isBuffer(p))throw new TypeError("Argument must be a Buffer");return this===p?!0:a.compare(this,p)===0},a.prototype.inspect=function(){let p="";const m=d.INSPECT_MAX_BYTES;return p=this.toString("hex",0,m).replace(/(.{2})/g,"$1 ").trim(),this.length>m&&(p+=" ... "),"<Buffer "+p+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(p,m,C,O,w){if(H(p,Uint8Array)&&(p=a.from(p,p.offset,p.byteLength)),!a.isBuffer(p))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof p);if(m===void 0&&(m=0),C===void 0&&(C=p?p.length:0),O===void 0&&(O=0),w===void 0&&(w=this.length),m<0||C>p.length||O<0||w>this.length)throw new RangeError("out of range index");if(O>=w&&m>=C)return 0;if(O>=w)return-1;if(m>=C)return 1;if(m>>>=0,C>>>=0,O>>>=0,w>>>=0,this===p)return 0;let x=w-O,_=C-m;const z=Math.min(x,_),te=this.slice(O,w),Te=p.slice(m,C);for(let ge=0;ge<z;++ge)if(te[ge]!==Te[ge]){x=te[ge],_=Te[ge];break}return x<_?-1:_<x?1:0};function ie(T,p,m,C,O){if(T.length===0)return-1;if(typeof m=="string"?(C=m,m=0):m>2147483647?m=2147483647:m<-2147483648&&(m=-2147483648),m=+m,ye(m)&&(m=O?0:T.length-1),m<0&&(m=T.length+m),m>=T.length){if(O)return-1;m=T.length-1}else if(m<0)if(O)m=0;else return-1;if(typeof p=="string"&&(p=a.from(p,C)),a.isBuffer(p))return p.length===0?-1:ne(T,p,m,C,O);if(typeof p=="number")return p=p&255,typeof Uint8Array.prototype.indexOf=="function"?O?Uint8Array.prototype.indexOf.call(T,p,m):Uint8Array.prototype.lastIndexOf.call(T,p,m):ne(T,[p],m,C,O);throw new TypeError("val must be string, number or Buffer")}function ne(T,p,m,C,O){let w=1,x=T.length,_=p.length;if(C!==void 0&&(C=String(C).toLowerCase(),C==="ucs2"||C==="ucs-2"||C==="utf16le"||C==="utf-16le")){if(T.length<2||p.length<2)return-1;w=2,x/=2,_/=2,m/=2}function z(Te,ge){return w===1?Te[ge]:Te.readUInt16BE(ge*w)}let te;if(O){let Te=-1;for(te=m;te<x;te++)if(z(T,te)===z(p,Te===-1?0:te-Te)){if(Te===-1&&(Te=te),te-Te+1===_)return Te*w}else Te!==-1&&(te-=te-Te),Te=-1}else for(m+_>x&&(m=x-_),te=m;te>=0;te--){let Te=!0;for(let ge=0;ge<_;ge++)if(z(T,te+ge)!==z(p,ge)){Te=!1;break}if(Te)return te}return-1}a.prototype.includes=function(p,m,C){return this.indexOf(p,m,C)!==-1},a.prototype.indexOf=function(p,m,C){return ie(this,p,m,C,!0)},a.prototype.lastIndexOf=function(p,m,C){return ie(this,p,m,C,!1)};function pe(T,p,m,C){m=Number(m)||0;const O=T.length-m;C?(C=Number(C),C>O&&(C=O)):C=O;const w=p.length;C>w/2&&(C=w/2);let x;for(x=0;x<C;++x){const _=parseInt(p.substr(x*2,2),16);if(ye(_))return x;T[m+x]=_}return x}function F(T,p,m,C){return j(y(p,T.length-m),T,m,C)}function se(T,p,m,C){return j(g(p),T,m,C)}function v(T,p,m,C){return j($(p),T,m,C)}function Y(T,p,m,C){return j(S(p,T.length-m),T,m,C)}a.prototype.write=function(p,m,C,O){if(m===void 0)O="utf8",C=this.length,m=0;else if(C===void 0&&typeof m=="string")O=m,C=this.length,m=0;else if(isFinite(m))m=m>>>0,isFinite(C)?(C=C>>>0,O===void 0&&(O="utf8")):(O=C,C=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const w=this.length-m;if((C===void 0||C>w)&&(C=w),p.length>0&&(C<0||m<0)||m>this.length)throw new RangeError("Attempt to write outside buffer bounds");O||(O="utf8");let x=!1;for(;;)switch(O){case"hex":return pe(this,p,m,C);case"utf8":case"utf-8":return F(this,p,m,C);case"ascii":case"latin1":case"binary":return se(this,p,m,C);case"base64":return v(this,p,m,C);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Y(this,p,m,C);default:if(x)throw new TypeError("Unknown encoding: "+O);O=(""+O).toLowerCase(),x=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Q(T,p,m){return p===0&&m===T.length?e.fromByteArray(T):e.fromByteArray(T.slice(p,m))}function B(T,p,m){m=Math.min(T.length,m);const C=[];let O=p;for(;O<m;){const w=T[O];let x=null,_=w>239?4:w>223?3:w>191?2:1;if(O+_<=m){let z,te,Te,ge;switch(_){case 1:w<128&&(x=w);break;case 2:z=T[O+1],(z&192)===128&&(ge=(w&31)<<6|z&63,ge>127&&(x=ge));break;case 3:z=T[O+1],te=T[O+2],(z&192)===128&&(te&192)===128&&(ge=(w&15)<<12|(z&63)<<6|te&63,ge>2047&&(ge<55296||ge>57343)&&(x=ge));break;case 4:z=T[O+1],te=T[O+2],Te=T[O+3],(z&192)===128&&(te&192)===128&&(Te&192)===128&&(ge=(w&15)<<18|(z&63)<<12|(te&63)<<6|Te&63,ge>65535&&ge<1114112&&(x=ge))}}x===null?(x=65533,_=1):x>65535&&(x-=65536,C.push(x>>>10&1023|55296),x=56320|x&1023),C.push(x),O+=_}return k(C)}const U=4096;function k(T){const p=T.length;if(p<=U)return String.fromCharCode.apply(String,T);let m="",C=0;for(;C<p;)m+=String.fromCharCode.apply(String,T.slice(C,C+=U));return m}function L(T,p,m){let C="";m=Math.min(T.length,m);for(let O=p;O<m;++O)C+=String.fromCharCode(T[O]&127);return C}function V(T,p,m){let C="";m=Math.min(T.length,m);for(let O=p;O<m;++O)C+=String.fromCharCode(T[O]);return C}function X(T,p,m){const C=T.length;(!p||p<0)&&(p=0),(!m||m<0||m>C)&&(m=C);let O="";for(let w=p;w<m;++w)O+=Ne[T[w]];return O}function oe(T,p,m){const C=T.slice(p,m);let O="";for(let w=0;w<C.length-1;w+=2)O+=String.fromCharCode(C[w]+C[w+1]*256);return O}a.prototype.slice=function(p,m){const C=this.length;p=~~p,m=m===void 0?C:~~m,p<0?(p+=C,p<0&&(p=0)):p>C&&(p=C),m<0?(m+=C,m<0&&(m=0)):m>C&&(m=C),m<p&&(m=p);const O=this.subarray(p,m);return Object.setPrototypeOf(O,a.prototype),O};function ee(T,p,m){if(T%1!==0||T<0)throw new RangeError("offset is not uint");if(T+p>m)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(p,m,C){p=p>>>0,m=m>>>0,C||ee(p,m,this.length);let O=this[p],w=1,x=0;for(;++x<m&&(w*=256);)O+=this[p+x]*w;return O},a.prototype.readUintBE=a.prototype.readUIntBE=function(p,m,C){p=p>>>0,m=m>>>0,C||ee(p,m,this.length);let O=this[p+--m],w=1;for(;m>0&&(w*=256);)O+=this[p+--m]*w;return O},a.prototype.readUint8=a.prototype.readUInt8=function(p,m){return p=p>>>0,m||ee(p,1,this.length),this[p]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(p,m){return p=p>>>0,m||ee(p,2,this.length),this[p]|this[p+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(p,m){return p=p>>>0,m||ee(p,2,this.length),this[p]<<8|this[p+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(p,m){return p=p>>>0,m||ee(p,4,this.length),(this[p]|this[p+1]<<8|this[p+2]<<16)+this[p+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(p,m){return p=p>>>0,m||ee(p,4,this.length),this[p]*16777216+(this[p+1]<<16|this[p+2]<<8|this[p+3])},a.prototype.readBigUInt64LE=xe(function(p){p=p>>>0,Ee(p,"offset");const m=this[p],C=this[p+7];(m===void 0||C===void 0)&&Oe(p,this.length-8);const O=m+this[++p]*2**8+this[++p]*2**16+this[++p]*2**24,w=this[++p]+this[++p]*2**8+this[++p]*2**16+C*2**24;return BigInt(O)+(BigInt(w)<<BigInt(32))}),a.prototype.readBigUInt64BE=xe(function(p){p=p>>>0,Ee(p,"offset");const m=this[p],C=this[p+7];(m===void 0||C===void 0)&&Oe(p,this.length-8);const O=m*2**24+this[++p]*2**16+this[++p]*2**8+this[++p],w=this[++p]*2**24+this[++p]*2**16+this[++p]*2**8+C;return(BigInt(O)<<BigInt(32))+BigInt(w)}),a.prototype.readIntLE=function(p,m,C){p=p>>>0,m=m>>>0,C||ee(p,m,this.length);let O=this[p],w=1,x=0;for(;++x<m&&(w*=256);)O+=this[p+x]*w;return w*=128,O>=w&&(O-=Math.pow(2,8*m)),O},a.prototype.readIntBE=function(p,m,C){p=p>>>0,m=m>>>0,C||ee(p,m,this.length);let O=m,w=1,x=this[p+--O];for(;O>0&&(w*=256);)x+=this[p+--O]*w;return w*=128,x>=w&&(x-=Math.pow(2,8*m)),x},a.prototype.readInt8=function(p,m){return p=p>>>0,m||ee(p,1,this.length),this[p]&128?(255-this[p]+1)*-1:this[p]},a.prototype.readInt16LE=function(p,m){p=p>>>0,m||ee(p,2,this.length);const C=this[p]|this[p+1]<<8;return C&32768?C|4294901760:C},a.prototype.readInt16BE=function(p,m){p=p>>>0,m||ee(p,2,this.length);const C=this[p+1]|this[p]<<8;return C&32768?C|4294901760:C},a.prototype.readInt32LE=function(p,m){return p=p>>>0,m||ee(p,4,this.length),this[p]|this[p+1]<<8|this[p+2]<<16|this[p+3]<<24},a.prototype.readInt32BE=function(p,m){return p=p>>>0,m||ee(p,4,this.length),this[p]<<24|this[p+1]<<16|this[p+2]<<8|this[p+3]},a.prototype.readBigInt64LE=xe(function(p){p=p>>>0,Ee(p,"offset");const m=this[p],C=this[p+7];(m===void 0||C===void 0)&&Oe(p,this.length-8);const O=this[p+4]+this[p+5]*2**8+this[p+6]*2**16+(C<<24);return(BigInt(O)<<BigInt(32))+BigInt(m+this[++p]*2**8+this[++p]*2**16+this[++p]*2**24)}),a.prototype.readBigInt64BE=xe(function(p){p=p>>>0,Ee(p,"offset");const m=this[p],C=this[p+7];(m===void 0||C===void 0)&&Oe(p,this.length-8);const O=(m<<24)+this[++p]*2**16+this[++p]*2**8+this[++p];return(BigInt(O)<<BigInt(32))+BigInt(this[++p]*2**24+this[++p]*2**16+this[++p]*2**8+C)}),a.prototype.readFloatLE=function(p,m){return p=p>>>0,m||ee(p,4,this.length),t.read(this,p,!0,23,4)},a.prototype.readFloatBE=function(p,m){return p=p>>>0,m||ee(p,4,this.length),t.read(this,p,!1,23,4)},a.prototype.readDoubleLE=function(p,m){return p=p>>>0,m||ee(p,8,this.length),t.read(this,p,!0,52,8)},a.prototype.readDoubleBE=function(p,m){return p=p>>>0,m||ee(p,8,this.length),t.read(this,p,!1,52,8)};function ce(T,p,m,C,O,w){if(!a.isBuffer(T))throw new TypeError('"buffer" argument must be a Buffer instance');if(p>O||p<w)throw new RangeError('"value" argument is out of bounds');if(m+C>T.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(p,m,C,O){if(p=+p,m=m>>>0,C=C>>>0,!O){const _=Math.pow(2,8*C)-1;ce(this,p,m,C,_,0)}let w=1,x=0;for(this[m]=p&255;++x<C&&(w*=256);)this[m+x]=p/w&255;return m+C},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(p,m,C,O){if(p=+p,m=m>>>0,C=C>>>0,!O){const _=Math.pow(2,8*C)-1;ce(this,p,m,C,_,0)}let w=C-1,x=1;for(this[m+w]=p&255;--w>=0&&(x*=256);)this[m+w]=p/x&255;return m+C},a.prototype.writeUint8=a.prototype.writeUInt8=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,1,255,0),this[m]=p&255,m+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,2,65535,0),this[m]=p&255,this[m+1]=p>>>8,m+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,2,65535,0),this[m]=p>>>8,this[m+1]=p&255,m+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,4,4294967295,0),this[m+3]=p>>>24,this[m+2]=p>>>16,this[m+1]=p>>>8,this[m]=p&255,m+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,4,4294967295,0),this[m]=p>>>24,this[m+1]=p>>>16,this[m+2]=p>>>8,this[m+3]=p&255,m+4};function Z(T,p,m,C,O){we(p,C,O,T,m,7);let w=Number(p&BigInt(4294967295));T[m++]=w,w=w>>8,T[m++]=w,w=w>>8,T[m++]=w,w=w>>8,T[m++]=w;let x=Number(p>>BigInt(32)&BigInt(4294967295));return T[m++]=x,x=x>>8,T[m++]=x,x=x>>8,T[m++]=x,x=x>>8,T[m++]=x,m}function Me(T,p,m,C,O){we(p,C,O,T,m,7);let w=Number(p&BigInt(4294967295));T[m+7]=w,w=w>>8,T[m+6]=w,w=w>>8,T[m+5]=w,w=w>>8,T[m+4]=w;let x=Number(p>>BigInt(32)&BigInt(4294967295));return T[m+3]=x,x=x>>8,T[m+2]=x,x=x>>8,T[m+1]=x,x=x>>8,T[m]=x,m+8}a.prototype.writeBigUInt64LE=xe(function(p,m=0){return Z(this,p,m,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=xe(function(p,m=0){return Me(this,p,m,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(p,m,C,O){if(p=+p,m=m>>>0,!O){const z=Math.pow(2,8*C-1);ce(this,p,m,C,z-1,-z)}let w=0,x=1,_=0;for(this[m]=p&255;++w<C&&(x*=256);)p<0&&_===0&&this[m+w-1]!==0&&(_=1),this[m+w]=(p/x>>0)-_&255;return m+C},a.prototype.writeIntBE=function(p,m,C,O){if(p=+p,m=m>>>0,!O){const z=Math.pow(2,8*C-1);ce(this,p,m,C,z-1,-z)}let w=C-1,x=1,_=0;for(this[m+w]=p&255;--w>=0&&(x*=256);)p<0&&_===0&&this[m+w+1]!==0&&(_=1),this[m+w]=(p/x>>0)-_&255;return m+C},a.prototype.writeInt8=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,1,127,-128),p<0&&(p=255+p+1),this[m]=p&255,m+1},a.prototype.writeInt16LE=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,2,32767,-32768),this[m]=p&255,this[m+1]=p>>>8,m+2},a.prototype.writeInt16BE=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,2,32767,-32768),this[m]=p>>>8,this[m+1]=p&255,m+2},a.prototype.writeInt32LE=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,4,2147483647,-2147483648),this[m]=p&255,this[m+1]=p>>>8,this[m+2]=p>>>16,this[m+3]=p>>>24,m+4},a.prototype.writeInt32BE=function(p,m,C){return p=+p,m=m>>>0,C||ce(this,p,m,4,2147483647,-2147483648),p<0&&(p=4294967295+p+1),this[m]=p>>>24,this[m+1]=p>>>16,this[m+2]=p>>>8,this[m+3]=p&255,m+4},a.prototype.writeBigInt64LE=xe(function(p,m=0){return Z(this,p,m,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=xe(function(p,m=0){return Me(this,p,m,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function qe(T,p,m,C,O,w){if(m+C>T.length)throw new RangeError("Index out of range");if(m<0)throw new RangeError("Index out of range")}function Se(T,p,m,C,O){return p=+p,m=m>>>0,O||qe(T,p,m,4),t.write(T,p,m,C,23,4),m+4}a.prototype.writeFloatLE=function(p,m,C){return Se(this,p,m,!0,C)},a.prototype.writeFloatBE=function(p,m,C){return Se(this,p,m,!1,C)};function je(T,p,m,C,O){return p=+p,m=m>>>0,O||qe(T,p,m,8),t.write(T,p,m,C,52,8),m+8}a.prototype.writeDoubleLE=function(p,m,C){return je(this,p,m,!0,C)},a.prototype.writeDoubleBE=function(p,m,C){return je(this,p,m,!1,C)},a.prototype.copy=function(p,m,C,O){if(!a.isBuffer(p))throw new TypeError("argument should be a Buffer");if(C||(C=0),!O&&O!==0&&(O=this.length),m>=p.length&&(m=p.length),m||(m=0),O>0&&O<C&&(O=C),O===C||p.length===0||this.length===0)return 0;if(m<0)throw new RangeError("targetStart out of bounds");if(C<0||C>=this.length)throw new RangeError("Index out of range");if(O<0)throw new RangeError("sourceEnd out of bounds");O>this.length&&(O=this.length),p.length-m<O-C&&(O=p.length-m+C);const w=O-C;return this===p&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(m,C,O):Uint8Array.prototype.set.call(p,this.subarray(C,O),m),w},a.prototype.fill=function(p,m,C,O){if(typeof p=="string"){if(typeof m=="string"?(O=m,m=0,C=this.length):typeof C=="string"&&(O=C,C=this.length),O!==void 0&&typeof O!="string")throw new TypeError("encoding must be a string");if(typeof O=="string"&&!a.isEncoding(O))throw new TypeError("Unknown encoding: "+O);if(p.length===1){const x=p.charCodeAt(0);(O==="utf8"&&x<128||O==="latin1")&&(p=x)}}else typeof p=="number"?p=p&255:typeof p=="boolean"&&(p=Number(p));if(m<0||this.length<m||this.length<C)throw new RangeError("Out of range index");if(C<=m)return this;m=m>>>0,C=C===void 0?this.length:C>>>0,p||(p=0);let w;if(typeof p=="number")for(w=m;w<C;++w)this[w]=p;else{const x=a.isBuffer(p)?p:a.from(p,O),_=x.length;if(_===0)throw new TypeError('The value "'+p+'" is invalid for argument "value"');for(w=0;w<C-m;++w)this[w+m]=x[w%_]}return this};const Pe={};function Re(T,p,m){Pe[T]=class extends m{constructor(){super(),Object.defineProperty(this,"message",{value:p.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${T}]`,this.stack,delete this.name}get code(){return T}set code(O){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:O,writable:!0})}toString(){return`${this.name} [${T}]: ${this.message}`}}}Re("ERR_BUFFER_OUT_OF_BOUNDS",function(T){return T?`${T} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Re("ERR_INVALID_ARG_TYPE",function(T,p){return`The "${T}" argument must be of type number. Received type ${typeof p}`},TypeError),Re("ERR_OUT_OF_RANGE",function(T,p,m){let C=`The value of "${T}" is out of range.`,O=m;return Number.isInteger(m)&&Math.abs(m)>2**32?O=fe(String(m)):typeof m=="bigint"&&(O=String(m),(m>BigInt(2)**BigInt(32)||m<-(BigInt(2)**BigInt(32)))&&(O=fe(O)),O+="n"),C+=` It must be ${p}. Received ${O}`,C},RangeError);function fe(T){let p="",m=T.length;const C=T[0]==="-"?1:0;for(;m>=C+4;m-=3)p=`_${T.slice(m-3,m)}${p}`;return`${T.slice(0,m)}${p}`}function be(T,p,m){Ee(p,"offset"),(T[p]===void 0||T[p+m]===void 0)&&Oe(p,T.length-(m+1))}function we(T,p,m,C,O,w){if(T>m||T<p){const x=typeof p=="bigint"?"n":"";let _;throw p===0||p===BigInt(0)?_=`>= 0${x} and < 2${x} ** ${(w+1)*8}${x}`:_=`>= -(2${x} ** ${(w+1)*8-1}${x}) and < 2 ** ${(w+1)*8-1}${x}`,new Pe.ERR_OUT_OF_RANGE("value",_,T)}be(C,O,w)}function Ee(T,p){if(typeof T!="number")throw new Pe.ERR_INVALID_ARG_TYPE(p,"number",T)}function Oe(T,p,m){throw Math.floor(T)!==T?(Ee(T,m),new Pe.ERR_OUT_OF_RANGE("offset","an integer",T)):p<0?new Pe.ERR_BUFFER_OUT_OF_BOUNDS:new Pe.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${p}`,T)}const Ge=/[^+/0-9A-Za-z-_]/g;function N(T){if(T=T.split("=")[0],T=T.trim().replace(Ge,""),T.length<2)return"";for(;T.length%4!==0;)T=T+"=";return T}function y(T,p){p=p||1/0;let m;const C=T.length;let O=null;const w=[];for(let x=0;x<C;++x){if(m=T.charCodeAt(x),m>55295&&m<57344){if(!O){if(m>56319){(p-=3)>-1&&w.push(239,191,189);continue}else if(x+1===C){(p-=3)>-1&&w.push(239,191,189);continue}O=m;continue}if(m<56320){(p-=3)>-1&&w.push(239,191,189),O=m;continue}m=(O-55296<<10|m-56320)+65536}else O&&(p-=3)>-1&&w.push(239,191,189);if(O=null,m<128){if((p-=1)<0)break;w.push(m)}else if(m<2048){if((p-=2)<0)break;w.push(m>>6|192,m&63|128)}else if(m<65536){if((p-=3)<0)break;w.push(m>>12|224,m>>6&63|128,m&63|128)}else if(m<1114112){if((p-=4)<0)break;w.push(m>>18|240,m>>12&63|128,m>>6&63|128,m&63|128)}else throw new Error("Invalid code point")}return w}function g(T){const p=[];for(let m=0;m<T.length;++m)p.push(T.charCodeAt(m)&255);return p}function S(T,p){let m,C,O;const w=[];for(let x=0;x<T.length&&!((p-=2)<0);++x)m=T.charCodeAt(x),C=m>>8,O=m%256,w.push(O),w.push(C);return w}function $(T){return e.toByteArray(N(T))}function j(T,p,m,C){let O;for(O=0;O<C&&!(O+m>=p.length||O>=T.length);++O)p[O+m]=T[O];return O}function H(T,p){return T instanceof p||T!=null&&T.constructor!=null&&T.constructor.name!=null&&T.constructor.name===p.name}function ye(T){return T!==T}const Ne=(function(){const T="0123456789abcdef",p=new Array(256);for(let m=0;m<16;++m){const C=m*16;for(let O=0;O<16;++O)p[C+O]=T[m]+T[O]}return p})();function xe(T){return typeof BigInt>"u"?Fe:T}function Fe(){throw new Error("BigInt not supported")}})(nn)),nn}var bs=Ys();class ve{static getGlobalVariable(){return typeof window<"u"?window:typeof globalThis<"u"?globalThis:global}static load(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: require("${e}").`);return""}static pathNormalize(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.normalize("${e}").`);return""}static pathExtname(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.extname("${e}").`);return""}static pathResolve(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.resolve("${e}").`);return""}static fileExist(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.existsSync("${e}").`);return!1}static dotenv(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: dotenv.config({ path: "${e}" }).`)}static getEnvVariable(e){}static readFileSync(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.readFileSync("${e}").`);return null}static appendFileSync(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.appendFileSync("${e}").`)}static writeFile(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.writeFile("${e}").`);return Promise.reject(null)}static highlightSql(e){return e}static logInfo(e,t){console.info(e+" ",t)}static logError(e,t){console.error(e+" ",t)}static logWarn(e,t){console.warn(e+" ",t)}static log(e){console.log(e)}static warn(e){return e}}ve.type="browser";typeof window<"u"&&(window.Buffer=bs.Buffer);typeof globalThis<"u"&&(globalThis.Buffer=bs.Buffer);typeof global<"u"&&typeof require<"u"&&(global.Buffer=require("buffer/").Buffer);class me{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(const n of t)for(const r of Object.getOwnPropertyNames(n))e[r]=n[r]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}}class M extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class qt extends M{constructor(e){super(`Internal error. Subject ${e.metadata.targetName} must have an identifier to perform operation.`)}}class Xs extends M{constructor(e){super(`Cannot create a "${e}" connection because connection to the database already established.`)}}class Et extends M{constructor(){super("Locking not supported on given driver.")}}class Zs extends M{constructor(e,t){super();const n=e.primaryColumns.reduce((r,i,s)=>(i.setEntityValue(r,s+1),r),{});this.message=`Cannot use given entity id "${t}" because "${e.targetName}" contains multiple primary columns, you must provide object in following form: ${JSON.stringify(n)} as an id.`}}class ea extends M{constructor(e){super(`Cannot ${e}, given value must be instance of entity class, instead object literal is given. Or you must specify an entity target to method call.`)}}class Er extends M{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class ta extends M{constructor(e){super(`Tree repositories are not supported in ${e.options.type} driver.`)}}class ws extends M{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} was not found. Did you forgot to put @EntityRepository decorator on it?`)}}class Ye extends M{constructor(){super("Transaction is not started yet, start transaction before committing or rolling it back.")}}class na extends M{constructor(){super("Transaction already started for the given connection, commit current transaction before starting a new one.")}}class q{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}}class Tr extends M{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return q.isEntitySchema(e)?e.options.name:typeof e=="function"||me.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class ra extends M{constructor(e){super(),this.message=`No metadata for "${this.stringifyTarget(e)}" was found.`}stringifyTarget(e){return q.isEntitySchema(e)?e.options.name:typeof e=="function"||me.isObject(e)&&"name"in e?e.name:e}}class ia extends M{constructor(e,t){super(`Cannot ${e}, given value must be an entity, instead "${t}" is given.`)}}class Dr extends M{constructor(e,t,n){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${n}.`)}}class Ns extends M{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class sa extends M{constructor(e){super(`Custom entity repository ${typeof e=="function"?e.name:e.constructor.name}  cannot inherit Repository class without entity being set in the @EntityRepository decorator.`)}}class As extends M{constructor(){super("Database connection provided by a query runner was already released, cannot continue to use its querying methods anymore.")}}class qr extends M{constructor(e){super(`Cannot attach entity "${e}" to its parent. Please make sure parent is saved in the database before saving children nodes.`)}}class rn extends M{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} does not have managed entity. Did you forget to specify entity for it @EntityRepository(MyEntity)? `)}}class aa extends M{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class oa extends M{constructor(e){super(`Circular relations detected: ${e}. To resolve this issue you need to set nullable: true somewhere in this dependency structure.`)}}class Jt extends M{constructor(){super("OUTPUT or RETURNING clause only supported by PostgreSQL, MariaDB, Microsoft SqlServer or Google Spanner.")}}class ca extends M{constructor(e){super(`Entity "${e.name}" does not have a primary column. Primary column is required to have in all your entities. Use @PrimaryColumn decorator to add a primary column to your entity.`)}}class nt extends M{constructor(e,t){super(e),Object.setPrototypeOf(this,nt.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}}class ua extends M{constructor(e,t=[]){super(`Wrong driver: "${e}" given. Supported drivers are: ${t.map(n=>`"${n}"`).join(", ")}.`)}}class bt extends M{constructor(e,t){super(`${e} package has not been found installed. Please run "npm install ${t}".`)}}class la extends M{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class ha extends M{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class St extends M{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class pa extends M{constructor(e){super(`Driver option (${e}) is not set. Please set it to perform connection to the database.`)}}class da extends M{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class fa extends M{constructor(){super("An open transaction is required for pessimistic lock.")}}class ma extends M{constructor(e,t,n){super();const r=typeof t=="string"?t:t.name;this.message=`Data type "${r}" in "${e.entityMetadata.targetName}.${e.propertyName}" is not supported by "${n}" database.`}}class ya extends M{constructor(e){super(`Array initializations are not allowed in entity relations. Please remove array initialization (= []) from "${e.entityMetadata.targetName}#${e.propertyPath}". This is ORM requirement to make relations to work properly. Refer docs for more information.`)}}class rt extends M{constructor(e,t,n){if(super(n.toString().replace(/^error: /,"").replace(/^Error: /,"").replace(/^Request/,"")),this.query=e,this.parameters=t,this.driverError=n,n){const{name:r,...i}=n;me.assign(this,{...i})}}}class ga extends M{constructor(){super("Entity manager is not using single database connection and cannot be released. Only entity managers created by connection#createEntityManagerWithSingleDatabaseConnection methods have a single database connection and they should be released.")}}class Ea extends M{constructor(e){super(`Removed entity "${e.metadata.name}" is also scheduled for update operation. Make sure you are not updating and removing same object (note that update or remove may be executed by cascade operations).`)}}class He extends M{constructor(){super("Query runner already released. Cannot run queries anymore.")}}class Ta extends M{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class Rt extends M{constructor(e){super(`Cannot execute operation on "${e}" connection because connection is not yet established.`)}}class ba extends M{constructor(e){super(`Option "${e}" is not set in your connection options, please define "${e}" option in your connection options or ormconfig.json`)}}class wa extends M{constructor(e){const t=e.map(n=>`"${n.name}"`);super(`Migrations ${t.join(", ")} override the transaction mode, but the global transaction mode is "all"`)}}class $r{constructor(e){me.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new M(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class ot{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[t,n]=e.split(".");return!(!t||!n||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var sn={exports:{}},$t={exports:{}},_r;function wt(){return _r||(_r=1,typeof Object.create=="function"?$t.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:$t.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}),$t.exports}var _t={exports:{}},an={};var Lr;function Na(){return Lr||(Lr=1,(function(d){var e=Es(),t=Ts(),n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;d.Buffer=a,d.SlowBuffer=D,d.INSPECT_MAX_BYTES=50;var r=2147483647;d.kMaxLength=r,a.TYPED_ARRAY_SUPPORT=i(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function i(){try{var N=new Uint8Array(1),y={foo:function(){return 42}};return Object.setPrototypeOf(y,Uint8Array.prototype),Object.setPrototypeOf(N,y),N.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function s(N){if(N>r)throw new RangeError('The value "'+N+'" is invalid for option "size"');var y=new Uint8Array(N);return Object.setPrototypeOf(y,a.prototype),y}function a(N,y,g){if(typeof N=="number"){if(typeof y=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return l(N)}return o(N,y,g)}a.poolSize=8192;function o(N,y,g){if(typeof N=="string")return h(N,y);if(ArrayBuffer.isView(N))return E(N);if(N==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof N);if(Ee(N,ArrayBuffer)||N&&Ee(N.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Ee(N,SharedArrayBuffer)||N&&Ee(N.buffer,SharedArrayBuffer)))return b(N,y,g);if(typeof N=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');var S=N.valueOf&&N.valueOf();if(S!=null&&S!==N)return a.from(S,y,g);var $=A(N);if($)return $;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof N[Symbol.toPrimitive]=="function")return a.from(N[Symbol.toPrimitive]("string"),y,g);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof N)}a.from=function(N,y,g){return o(N,y,g)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function c(N){if(typeof N!="number")throw new TypeError('"size" argument must be of type number');if(N<0)throw new RangeError('The value "'+N+'" is invalid for option "size"')}function u(N,y,g){return c(N),N<=0?s(N):y!==void 0?typeof g=="string"?s(N).fill(y,g):s(N).fill(y):s(N)}a.alloc=function(N,y,g){return u(N,y,g)};function l(N){return c(N),s(N<0?0:P(N)|0)}a.allocUnsafe=function(N){return l(N)},a.allocUnsafeSlow=function(N){return l(N)};function h(N,y){if((typeof y!="string"||y==="")&&(y="utf8"),!a.isEncoding(y))throw new TypeError("Unknown encoding: "+y);var g=I(N,y)|0,S=s(g),$=S.write(N,y);return $!==g&&(S=S.slice(0,$)),S}function f(N){for(var y=N.length<0?0:P(N.length)|0,g=s(y),S=0;S<y;S+=1)g[S]=N[S]&255;return g}function E(N){if(Ee(N,Uint8Array)){var y=new Uint8Array(N);return b(y.buffer,y.byteOffset,y.byteLength)}return f(N)}function b(N,y,g){if(y<0||N.byteLength<y)throw new RangeError('"offset" is outside of buffer bounds');if(N.byteLength<y+(g||0))throw new RangeError('"length" is outside of buffer bounds');var S;return y===void 0&&g===void 0?S=new Uint8Array(N):g===void 0?S=new Uint8Array(N,y):S=new Uint8Array(N,y,g),Object.setPrototypeOf(S,a.prototype),S}function A(N){if(a.isBuffer(N)){var y=P(N.length)|0,g=s(y);return g.length===0||N.copy(g,0,0,y),g}if(N.length!==void 0)return typeof N.length!="number"||Oe(N.length)?s(0):f(N);if(N.type==="Buffer"&&Array.isArray(N.data))return f(N.data)}function P(N){if(N>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return N|0}function D(N){return+N!=N&&(N=0),a.alloc(+N)}a.isBuffer=function(y){return y!=null&&y._isBuffer===!0&&y!==a.prototype},a.compare=function(y,g){if(Ee(y,Uint8Array)&&(y=a.from(y,y.offset,y.byteLength)),Ee(g,Uint8Array)&&(g=a.from(g,g.offset,g.byteLength)),!a.isBuffer(y)||!a.isBuffer(g))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(y===g)return 0;for(var S=y.length,$=g.length,j=0,H=Math.min(S,$);j<H;++j)if(y[j]!==g[j]){S=y[j],$=g[j];break}return S<$?-1:$<S?1:0},a.isEncoding=function(y){switch(String(y).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(y,g){if(!Array.isArray(y))throw new TypeError('"list" argument must be an Array of Buffers');if(y.length===0)return a.alloc(0);var S;if(g===void 0)for(g=0,S=0;S<y.length;++S)g+=y[S].length;var $=a.allocUnsafe(g),j=0;for(S=0;S<y.length;++S){var H=y[S];if(Ee(H,Uint8Array))j+H.length>$.length?a.from(H).copy($,j):Uint8Array.prototype.set.call($,H,j);else if(a.isBuffer(H))H.copy($,j);else throw new TypeError('"list" argument must be an Array of Buffers');j+=H.length}return $};function I(N,y){if(a.isBuffer(N))return N.length;if(ArrayBuffer.isView(N)||Ee(N,ArrayBuffer))return N.byteLength;if(typeof N!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof N);var g=N.length,S=arguments.length>2&&arguments[2]===!0;if(!S&&g===0)return 0;for(var $=!1;;)switch(y){case"ascii":case"latin1":case"binary":return g;case"utf8":case"utf-8":return Pe(N).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return g*2;case"hex":return g>>>1;case"base64":return be(N).length;default:if($)return S?-1:Pe(N).length;y=(""+y).toLowerCase(),$=!0}}a.byteLength=I;function W(N,y,g){var S=!1;if((y===void 0||y<0)&&(y=0),y>this.length||((g===void 0||g>this.length)&&(g=this.length),g<=0)||(g>>>=0,y>>>=0,g<=y))return"";for(N||(N="utf8");;)switch(N){case"hex":return X(this,y,g);case"utf8":case"utf-8":return B(this,y,g);case"ascii":return L(this,y,g);case"latin1":case"binary":return V(this,y,g);case"base64":return Q(this,y,g);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return oe(this,y,g);default:if(S)throw new TypeError("Unknown encoding: "+N);N=(N+"").toLowerCase(),S=!0}}a.prototype._isBuffer=!0;function G(N,y,g){var S=N[y];N[y]=N[g],N[g]=S}a.prototype.swap16=function(){var y=this.length;if(y%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var g=0;g<y;g+=2)G(this,g,g+1);return this},a.prototype.swap32=function(){var y=this.length;if(y%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var g=0;g<y;g+=4)G(this,g,g+3),G(this,g+1,g+2);return this},a.prototype.swap64=function(){var y=this.length;if(y%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var g=0;g<y;g+=8)G(this,g,g+7),G(this,g+1,g+6),G(this,g+2,g+5),G(this,g+3,g+4);return this},a.prototype.toString=function(){var y=this.length;return y===0?"":arguments.length===0?B(this,0,y):W.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(y){if(!a.isBuffer(y))throw new TypeError("Argument must be a Buffer");return this===y?!0:a.compare(this,y)===0},a.prototype.inspect=function(){var y="",g=d.INSPECT_MAX_BYTES;return y=this.toString("hex",0,g).replace(/(.{2})/g,"$1 ").trim(),this.length>g&&(y+=" ... "),"<Buffer "+y+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(y,g,S,$,j){if(Ee(y,Uint8Array)&&(y=a.from(y,y.offset,y.byteLength)),!a.isBuffer(y))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof y);if(g===void 0&&(g=0),S===void 0&&(S=y?y.length:0),$===void 0&&($=0),j===void 0&&(j=this.length),g<0||S>y.length||$<0||j>this.length)throw new RangeError("out of range index");if($>=j&&g>=S)return 0;if($>=j)return-1;if(g>=S)return 1;if(g>>>=0,S>>>=0,$>>>=0,j>>>=0,this===y)return 0;for(var H=j-$,ye=S-g,Ne=Math.min(H,ye),xe=this.slice($,j),Fe=y.slice(g,S),T=0;T<Ne;++T)if(xe[T]!==Fe[T]){H=xe[T],ye=Fe[T];break}return H<ye?-1:ye<H?1:0};function ie(N,y,g,S,$){if(N.length===0)return-1;if(typeof g=="string"?(S=g,g=0):g>2147483647?g=2147483647:g<-2147483648&&(g=-2147483648),g=+g,Oe(g)&&(g=$?0:N.length-1),g<0&&(g=N.length+g),g>=N.length){if($)return-1;g=N.length-1}else if(g<0)if($)g=0;else return-1;if(typeof y=="string"&&(y=a.from(y,S)),a.isBuffer(y))return y.length===0?-1:ne(N,y,g,S,$);if(typeof y=="number")return y=y&255,typeof Uint8Array.prototype.indexOf=="function"?$?Uint8Array.prototype.indexOf.call(N,y,g):Uint8Array.prototype.lastIndexOf.call(N,y,g):ne(N,[y],g,S,$);throw new TypeError("val must be string, number or Buffer")}function ne(N,y,g,S,$){var j=1,H=N.length,ye=y.length;if(S!==void 0&&(S=String(S).toLowerCase(),S==="ucs2"||S==="ucs-2"||S==="utf16le"||S==="utf-16le")){if(N.length<2||y.length<2)return-1;j=2,H/=2,ye/=2,g/=2}function Ne(m,C){return j===1?m[C]:m.readUInt16BE(C*j)}var xe;if($){var Fe=-1;for(xe=g;xe<H;xe++)if(Ne(N,xe)===Ne(y,Fe===-1?0:xe-Fe)){if(Fe===-1&&(Fe=xe),xe-Fe+1===ye)return Fe*j}else Fe!==-1&&(xe-=xe-Fe),Fe=-1}else for(g+ye>H&&(g=H-ye),xe=g;xe>=0;xe--){for(var T=!0,p=0;p<ye;p++)if(Ne(N,xe+p)!==Ne(y,p)){T=!1;break}if(T)return xe}return-1}a.prototype.includes=function(y,g,S){return this.indexOf(y,g,S)!==-1},a.prototype.indexOf=function(y,g,S){return ie(this,y,g,S,!0)},a.prototype.lastIndexOf=function(y,g,S){return ie(this,y,g,S,!1)};function pe(N,y,g,S){g=Number(g)||0;var $=N.length-g;S?(S=Number(S),S>$&&(S=$)):S=$;var j=y.length;S>j/2&&(S=j/2);for(var H=0;H<S;++H){var ye=parseInt(y.substr(H*2,2),16);if(Oe(ye))return H;N[g+H]=ye}return H}function F(N,y,g,S){return we(Pe(y,N.length-g),N,g,S)}function se(N,y,g,S){return we(Re(y),N,g,S)}function v(N,y,g,S){return we(be(y),N,g,S)}function Y(N,y,g,S){return we(fe(y,N.length-g),N,g,S)}a.prototype.write=function(y,g,S,$){if(g===void 0)$="utf8",S=this.length,g=0;else if(S===void 0&&typeof g=="string")$=g,S=this.length,g=0;else if(isFinite(g))g=g>>>0,isFinite(S)?(S=S>>>0,$===void 0&&($="utf8")):($=S,S=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");var j=this.length-g;if((S===void 0||S>j)&&(S=j),y.length>0&&(S<0||g<0)||g>this.length)throw new RangeError("Attempt to write outside buffer bounds");$||($="utf8");for(var H=!1;;)switch($){case"hex":return pe(this,y,g,S);case"utf8":case"utf-8":return F(this,y,g,S);case"ascii":case"latin1":case"binary":return se(this,y,g,S);case"base64":return v(this,y,g,S);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Y(this,y,g,S);default:if(H)throw new TypeError("Unknown encoding: "+$);$=(""+$).toLowerCase(),H=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Q(N,y,g){return y===0&&g===N.length?e.fromByteArray(N):e.fromByteArray(N.slice(y,g))}function B(N,y,g){g=Math.min(N.length,g);for(var S=[],$=y;$<g;){var j=N[$],H=null,ye=j>239?4:j>223?3:j>191?2:1;if($+ye<=g){var Ne,xe,Fe,T;switch(ye){case 1:j<128&&(H=j);break;case 2:Ne=N[$+1],(Ne&192)===128&&(T=(j&31)<<6|Ne&63,T>127&&(H=T));break;case 3:Ne=N[$+1],xe=N[$+2],(Ne&192)===128&&(xe&192)===128&&(T=(j&15)<<12|(Ne&63)<<6|xe&63,T>2047&&(T<55296||T>57343)&&(H=T));break;case 4:Ne=N[$+1],xe=N[$+2],Fe=N[$+3],(Ne&192)===128&&(xe&192)===128&&(Fe&192)===128&&(T=(j&15)<<18|(Ne&63)<<12|(xe&63)<<6|Fe&63,T>65535&&T<1114112&&(H=T))}}H===null?(H=65533,ye=1):H>65535&&(H-=65536,S.push(H>>>10&1023|55296),H=56320|H&1023),S.push(H),$+=ye}return k(S)}var U=4096;function k(N){var y=N.length;if(y<=U)return String.fromCharCode.apply(String,N);for(var g="",S=0;S<y;)g+=String.fromCharCode.apply(String,N.slice(S,S+=U));return g}function L(N,y,g){var S="";g=Math.min(N.length,g);for(var $=y;$<g;++$)S+=String.fromCharCode(N[$]&127);return S}function V(N,y,g){var S="";g=Math.min(N.length,g);for(var $=y;$<g;++$)S+=String.fromCharCode(N[$]);return S}function X(N,y,g){var S=N.length;(!y||y<0)&&(y=0),(!g||g<0||g>S)&&(g=S);for(var $="",j=y;j<g;++j)$+=Ge[N[j]];return $}function oe(N,y,g){for(var S=N.slice(y,g),$="",j=0;j<S.length-1;j+=2)$+=String.fromCharCode(S[j]+S[j+1]*256);return $}a.prototype.slice=function(y,g){var S=this.length;y=~~y,g=g===void 0?S:~~g,y<0?(y+=S,y<0&&(y=0)):y>S&&(y=S),g<0?(g+=S,g<0&&(g=0)):g>S&&(g=S),g<y&&(g=y);var $=this.subarray(y,g);return Object.setPrototypeOf($,a.prototype),$};function ee(N,y,g){if(N%1!==0||N<0)throw new RangeError("offset is not uint");if(N+y>g)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(y,g,S){y=y>>>0,g=g>>>0,S||ee(y,g,this.length);for(var $=this[y],j=1,H=0;++H<g&&(j*=256);)$+=this[y+H]*j;return $},a.prototype.readUintBE=a.prototype.readUIntBE=function(y,g,S){y=y>>>0,g=g>>>0,S||ee(y,g,this.length);for(var $=this[y+--g],j=1;g>0&&(j*=256);)$+=this[y+--g]*j;return $},a.prototype.readUint8=a.prototype.readUInt8=function(y,g){return y=y>>>0,g||ee(y,1,this.length),this[y]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(y,g){return y=y>>>0,g||ee(y,2,this.length),this[y]|this[y+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(y,g){return y=y>>>0,g||ee(y,2,this.length),this[y]<<8|this[y+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(y,g){return y=y>>>0,g||ee(y,4,this.length),(this[y]|this[y+1]<<8|this[y+2]<<16)+this[y+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(y,g){return y=y>>>0,g||ee(y,4,this.length),this[y]*16777216+(this[y+1]<<16|this[y+2]<<8|this[y+3])},a.prototype.readIntLE=function(y,g,S){y=y>>>0,g=g>>>0,S||ee(y,g,this.length);for(var $=this[y],j=1,H=0;++H<g&&(j*=256);)$+=this[y+H]*j;return j*=128,$>=j&&($-=Math.pow(2,8*g)),$},a.prototype.readIntBE=function(y,g,S){y=y>>>0,g=g>>>0,S||ee(y,g,this.length);for(var $=g,j=1,H=this[y+--$];$>0&&(j*=256);)H+=this[y+--$]*j;return j*=128,H>=j&&(H-=Math.pow(2,8*g)),H},a.prototype.readInt8=function(y,g){return y=y>>>0,g||ee(y,1,this.length),this[y]&128?(255-this[y]+1)*-1:this[y]},a.prototype.readInt16LE=function(y,g){y=y>>>0,g||ee(y,2,this.length);var S=this[y]|this[y+1]<<8;return S&32768?S|4294901760:S},a.prototype.readInt16BE=function(y,g){y=y>>>0,g||ee(y,2,this.length);var S=this[y+1]|this[y]<<8;return S&32768?S|4294901760:S},a.prototype.readInt32LE=function(y,g){return y=y>>>0,g||ee(y,4,this.length),this[y]|this[y+1]<<8|this[y+2]<<16|this[y+3]<<24},a.prototype.readInt32BE=function(y,g){return y=y>>>0,g||ee(y,4,this.length),this[y]<<24|this[y+1]<<16|this[y+2]<<8|this[y+3]},a.prototype.readFloatLE=function(y,g){return y=y>>>0,g||ee(y,4,this.length),t.read(this,y,!0,23,4)},a.prototype.readFloatBE=function(y,g){return y=y>>>0,g||ee(y,4,this.length),t.read(this,y,!1,23,4)},a.prototype.readDoubleLE=function(y,g){return y=y>>>0,g||ee(y,8,this.length),t.read(this,y,!0,52,8)},a.prototype.readDoubleBE=function(y,g){return y=y>>>0,g||ee(y,8,this.length),t.read(this,y,!1,52,8)};function ce(N,y,g,S,$,j){if(!a.isBuffer(N))throw new TypeError('"buffer" argument must be a Buffer instance');if(y>$||y<j)throw new RangeError('"value" argument is out of bounds');if(g+S>N.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(y,g,S,$){if(y=+y,g=g>>>0,S=S>>>0,!$){var j=Math.pow(2,8*S)-1;ce(this,y,g,S,j,0)}var H=1,ye=0;for(this[g]=y&255;++ye<S&&(H*=256);)this[g+ye]=y/H&255;return g+S},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(y,g,S,$){if(y=+y,g=g>>>0,S=S>>>0,!$){var j=Math.pow(2,8*S)-1;ce(this,y,g,S,j,0)}var H=S-1,ye=1;for(this[g+H]=y&255;--H>=0&&(ye*=256);)this[g+H]=y/ye&255;return g+S},a.prototype.writeUint8=a.prototype.writeUInt8=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,1,255,0),this[g]=y&255,g+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,2,65535,0),this[g]=y&255,this[g+1]=y>>>8,g+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,2,65535,0),this[g]=y>>>8,this[g+1]=y&255,g+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,4,4294967295,0),this[g+3]=y>>>24,this[g+2]=y>>>16,this[g+1]=y>>>8,this[g]=y&255,g+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,4,4294967295,0),this[g]=y>>>24,this[g+1]=y>>>16,this[g+2]=y>>>8,this[g+3]=y&255,g+4},a.prototype.writeIntLE=function(y,g,S,$){if(y=+y,g=g>>>0,!$){var j=Math.pow(2,8*S-1);ce(this,y,g,S,j-1,-j)}var H=0,ye=1,Ne=0;for(this[g]=y&255;++H<S&&(ye*=256);)y<0&&Ne===0&&this[g+H-1]!==0&&(Ne=1),this[g+H]=(y/ye>>0)-Ne&255;return g+S},a.prototype.writeIntBE=function(y,g,S,$){if(y=+y,g=g>>>0,!$){var j=Math.pow(2,8*S-1);ce(this,y,g,S,j-1,-j)}var H=S-1,ye=1,Ne=0;for(this[g+H]=y&255;--H>=0&&(ye*=256);)y<0&&Ne===0&&this[g+H+1]!==0&&(Ne=1),this[g+H]=(y/ye>>0)-Ne&255;return g+S},a.prototype.writeInt8=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,1,127,-128),y<0&&(y=255+y+1),this[g]=y&255,g+1},a.prototype.writeInt16LE=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,2,32767,-32768),this[g]=y&255,this[g+1]=y>>>8,g+2},a.prototype.writeInt16BE=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,2,32767,-32768),this[g]=y>>>8,this[g+1]=y&255,g+2},a.prototype.writeInt32LE=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,4,2147483647,-2147483648),this[g]=y&255,this[g+1]=y>>>8,this[g+2]=y>>>16,this[g+3]=y>>>24,g+4},a.prototype.writeInt32BE=function(y,g,S){return y=+y,g=g>>>0,S||ce(this,y,g,4,2147483647,-2147483648),y<0&&(y=4294967295+y+1),this[g]=y>>>24,this[g+1]=y>>>16,this[g+2]=y>>>8,this[g+3]=y&255,g+4};function Z(N,y,g,S,$,j){if(g+S>N.length)throw new RangeError("Index out of range");if(g<0)throw new RangeError("Index out of range")}function Me(N,y,g,S,$){return y=+y,g=g>>>0,$||Z(N,y,g,4),t.write(N,y,g,S,23,4),g+4}a.prototype.writeFloatLE=function(y,g,S){return Me(this,y,g,!0,S)},a.prototype.writeFloatBE=function(y,g,S){return Me(this,y,g,!1,S)};function qe(N,y,g,S,$){return y=+y,g=g>>>0,$||Z(N,y,g,8),t.write(N,y,g,S,52,8),g+8}a.prototype.writeDoubleLE=function(y,g,S){return qe(this,y,g,!0,S)},a.prototype.writeDoubleBE=function(y,g,S){return qe(this,y,g,!1,S)},a.prototype.copy=function(y,g,S,$){if(!a.isBuffer(y))throw new TypeError("argument should be a Buffer");if(S||(S=0),!$&&$!==0&&($=this.length),g>=y.length&&(g=y.length),g||(g=0),$>0&&$<S&&($=S),$===S||y.length===0||this.length===0)return 0;if(g<0)throw new RangeError("targetStart out of bounds");if(S<0||S>=this.length)throw new RangeError("Index out of range");if($<0)throw new RangeError("sourceEnd out of bounds");$>this.length&&($=this.length),y.length-g<$-S&&($=y.length-g+S);var j=$-S;return this===y&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(g,S,$):Uint8Array.prototype.set.call(y,this.subarray(S,$),g),j},a.prototype.fill=function(y,g,S,$){if(typeof y=="string"){if(typeof g=="string"?($=g,g=0,S=this.length):typeof S=="string"&&($=S,S=this.length),$!==void 0&&typeof $!="string")throw new TypeError("encoding must be a string");if(typeof $=="string"&&!a.isEncoding($))throw new TypeError("Unknown encoding: "+$);if(y.length===1){var j=y.charCodeAt(0);($==="utf8"&&j<128||$==="latin1")&&(y=j)}}else typeof y=="number"?y=y&255:typeof y=="boolean"&&(y=Number(y));if(g<0||this.length<g||this.length<S)throw new RangeError("Out of range index");if(S<=g)return this;g=g>>>0,S=S===void 0?this.length:S>>>0,y||(y=0);var H;if(typeof y=="number")for(H=g;H<S;++H)this[H]=y;else{var ye=a.isBuffer(y)?y:a.from(y,$),Ne=ye.length;if(Ne===0)throw new TypeError('The value "'+y+'" is invalid for argument "value"');for(H=0;H<S-g;++H)this[H+g]=ye[H%Ne]}return this};var Se=/[^+/0-9A-Za-z-_]/g;function je(N){if(N=N.split("=")[0],N=N.trim().replace(Se,""),N.length<2)return"";for(;N.length%4!==0;)N=N+"=";return N}function Pe(N,y){y=y||1/0;for(var g,S=N.length,$=null,j=[],H=0;H<S;++H){if(g=N.charCodeAt(H),g>55295&&g<57344){if(!$){if(g>56319){(y-=3)>-1&&j.push(239,191,189);continue}else if(H+1===S){(y-=3)>-1&&j.push(239,191,189);continue}$=g;continue}if(g<56320){(y-=3)>-1&&j.push(239,191,189),$=g;continue}g=($-55296<<10|g-56320)+65536}else $&&(y-=3)>-1&&j.push(239,191,189);if($=null,g<128){if((y-=1)<0)break;j.push(g)}else if(g<2048){if((y-=2)<0)break;j.push(g>>6|192,g&63|128)}else if(g<65536){if((y-=3)<0)break;j.push(g>>12|224,g>>6&63|128,g&63|128)}else if(g<1114112){if((y-=4)<0)break;j.push(g>>18|240,g>>12&63|128,g>>6&63|128,g&63|128)}else throw new Error("Invalid code point")}return j}function Re(N){for(var y=[],g=0;g<N.length;++g)y.push(N.charCodeAt(g)&255);return y}function fe(N,y){for(var g,S,$,j=[],H=0;H<N.length&&!((y-=2)<0);++H)g=N.charCodeAt(H),S=g>>8,$=g%256,j.push($),j.push(S);return j}function be(N){return e.toByteArray(je(N))}function we(N,y,g,S){for(var $=0;$<S&&!($+g>=y.length||$>=N.length);++$)y[$+g]=N[$];return $}function Ee(N,y){return N instanceof y||N!=null&&N.constructor!=null&&N.constructor.name!=null&&N.constructor.name===y.name}function Oe(N){return N!==N}var Ge=(function(){for(var N="0123456789abcdef",y=new Array(256),g=0;g<16;++g)for(var S=g*16,$=0;$<16;++$)y[S+$]=N[g]+N[$];return y})()})(an)),an}var Br;function ft(){return Br||(Br=1,(function(d,e){var t=Na(),n=t.Buffer;function r(s,a){for(var o in s)a[o]=s[o]}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?d.exports=t:(r(t,e),e.Buffer=i);function i(s,a,o){return n(s,a,o)}i.prototype=Object.create(n.prototype),r(n,i),i.from=function(s,a,o){if(typeof s=="number")throw new TypeError("Argument must not be a number");return n(s,a,o)},i.alloc=function(s,a,o){if(typeof s!="number")throw new TypeError("Argument must be a number");var c=n(s);return a!==void 0?typeof o=="string"?c.fill(a,o):c.fill(a):c.fill(0),c},i.allocUnsafe=function(s){if(typeof s!="number")throw new TypeError("Argument must be a number");return n(s)},i.allocUnsafeSlow=function(s){if(typeof s!="number")throw new TypeError("Argument must be a number");return t.SlowBuffer(s)}})(_t,_t.exports)),_t.exports}var on,Ur;function Aa(){if(Ur)return on;Ur=1;var d={}.toString;return on=Array.isArray||function(e){return d.call(e)=="[object Array]"},on}var cn,Fr;function Mt(){return Fr||(Fr=1,cn=TypeError),cn}var un,jr;function Cs(){return jr||(jr=1,un=Object),un}var ln,kr;function Ca(){return kr||(kr=1,ln=Error),ln}var hn,Qr;function Sa(){return Qr||(Qr=1,hn=EvalError),hn}var pn,Vr;function Ra(){return Vr||(Vr=1,pn=RangeError),pn}var dn,Wr;function xa(){return Wr||(Wr=1,dn=ReferenceError),dn}var fn,Hr;function Ss(){return Hr||(Hr=1,fn=SyntaxError),fn}var mn,Gr;function Ma(){return Gr||(Gr=1,mn=URIError),mn}var yn,zr;function va(){return zr||(zr=1,yn=Math.abs),yn}var gn,Kr;function Pa(){return Kr||(Kr=1,gn=Math.floor),gn}var En,Jr;function Ia(){return Jr||(Jr=1,En=Math.max),En}var Tn,Yr;function Oa(){return Yr||(Yr=1,Tn=Math.min),Tn}var bn,Xr;function Da(){return Xr||(Xr=1,bn=Math.pow),bn}var wn,Zr;function qa(){return Zr||(Zr=1,wn=Math.round),wn}var Nn,ei;function $a(){return ei||(ei=1,Nn=Number.isNaN||function(e){return e!==e}),Nn}var An,ti;function _a(){if(ti)return An;ti=1;var d=$a();return An=function(t){return d(t)||t===0?t:t<0?-1:1},An}var Cn,ni;function La(){return ni||(ni=1,Cn=Object.getOwnPropertyDescriptor),Cn}var Sn,ri;function vt(){if(ri)return Sn;ri=1;var d=La();if(d)try{d([],"length")}catch{d=null}return Sn=d,Sn}var Rn,ii;function Yt(){if(ii)return Rn;ii=1;var d=Object.defineProperty||!1;if(d)try{d({},"a",{value:1})}catch{d=!1}return Rn=d,Rn}var xn,si;function Rs(){return si||(si=1,xn=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var e={},t=Symbol("test"),n=Object(t);if(typeof t=="string"||Object.prototype.toString.call(t)!=="[object Symbol]"||Object.prototype.toString.call(n)!=="[object Symbol]")return!1;var r=42;e[t]=r;for(var i in e)return!1;if(typeof Object.keys=="function"&&Object.keys(e).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(e).length!==0)return!1;var s=Object.getOwnPropertySymbols(e);if(s.length!==1||s[0]!==t||!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var a=Object.getOwnPropertyDescriptor(e,t);if(a.value!==r||a.enumerable!==!0)return!1}return!0}),xn}var Mn,ai;function Ba(){if(ai)return Mn;ai=1;var d=typeof Symbol<"u"&&Symbol,e=Rs();return Mn=function(){return typeof d!="function"||typeof Symbol!="function"||typeof d("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:e()},Mn}var vn,oi;function xs(){return oi||(oi=1,vn=typeof Reflect<"u"&&Reflect.getPrototypeOf||null),vn}var Pn,ci;function Ms(){if(ci)return Pn;ci=1;var d=Cs();return Pn=d.getPrototypeOf||null,Pn}var In,ui;function Ua(){if(ui)return In;ui=1;var d="Function.prototype.bind called on incompatible ",e=Object.prototype.toString,t=Math.max,n="[object Function]",r=function(o,c){for(var u=[],l=0;l<o.length;l+=1)u[l]=o[l];for(var h=0;h<c.length;h+=1)u[h+o.length]=c[h];return u},i=function(o,c){for(var u=[],l=c,h=0;l<o.length;l+=1,h+=1)u[h]=o[l];return u},s=function(a,o){for(var c="",u=0;u<a.length;u+=1)c+=a[u],u+1<a.length&&(c+=o);return c};return In=function(o){var c=this;if(typeof c!="function"||e.apply(c)!==n)throw new TypeError(d+c);for(var u=i(arguments,1),l,h=function(){if(this instanceof l){var P=c.apply(this,r(u,arguments));return Object(P)===P?P:this}return c.apply(o,r(u,arguments))},f=t(0,c.length-u.length),E=[],b=0;b<f;b++)E[b]="$"+b;if(l=Function("binder","return function ("+s(E,",")+"){ return binder.apply(this,arguments); }")(h),c.prototype){var A=function(){};A.prototype=c.prototype,l.prototype=new A,A.prototype=null}return l},In}var On,li;function Pt(){if(li)return On;li=1;var d=Ua();return On=Function.prototype.bind||d,On}var Dn,hi;function br(){return hi||(hi=1,Dn=Function.prototype.call),Dn}var qn,pi;function wr(){return pi||(pi=1,qn=Function.prototype.apply),qn}var $n,di;function Fa(){return di||(di=1,$n=typeof Reflect<"u"&&Reflect&&Reflect.apply),$n}var _n,fi;function vs(){if(fi)return _n;fi=1;var d=Pt(),e=wr(),t=br(),n=Fa();return _n=n||d.call(t,e),_n}var Ln,mi;function Nr(){if(mi)return Ln;mi=1;var d=Pt(),e=Mt(),t=br(),n=vs();return Ln=function(i){if(i.length<1||typeof i[0]!="function")throw new e("a function is required");return n(d,t,i)},Ln}var Bn,yi;function ja(){if(yi)return Bn;yi=1;var d=Nr(),e=vt(),t;try{t=[].__proto__===Array.prototype}catch(s){if(!s||typeof s!="object"||!("code"in s)||s.code!=="ERR_PROTO_ACCESS")throw s}var n=!!t&&e&&e(Object.prototype,"__proto__"),r=Object,i=r.getPrototypeOf;return Bn=n&&typeof n.get=="function"?d([n.get]):typeof i=="function"?function(a){return i(a==null?a:r(a))}:!1,Bn}var Un,gi;function Ps(){if(gi)return Un;gi=1;var d=xs(),e=Ms(),t=ja();return Un=d?function(r){return d(r)}:e?function(r){if(!r||typeof r!="object"&&typeof r!="function")throw new TypeError("getProto: not an object");return e(r)}:t?function(r){return t(r)}:null,Un}var Fn,Ei;function ka(){if(Ei)return Fn;Ei=1;var d=Function.prototype.call,e=Object.prototype.hasOwnProperty,t=Pt();return Fn=t.call(d,e),Fn}var jn,Ti;function Is(){if(Ti)return jn;Ti=1;var d,e=Cs(),t=Ca(),n=Sa(),r=Ra(),i=xa(),s=Ss(),a=Mt(),o=Ma(),c=va(),u=Pa(),l=Ia(),h=Oa(),f=Da(),E=qa(),b=_a(),A=Function,P=function(Re){try{return A('"use strict"; return ('+Re+").constructor;")()}catch{}},D=vt(),I=Yt(),W=function(){throw new a},G=D?(function(){try{return arguments.callee,W}catch{try{return D(arguments,"callee").get}catch{return W}}})():W,ie=Ba()(),ne=Ps(),pe=Ms(),F=xs(),se=wr(),v=br(),Y={},Q=typeof Uint8Array>"u"||!ne?d:ne(Uint8Array),B={__proto__:null,"%AggregateError%":typeof AggregateError>"u"?d:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?d:ArrayBuffer,"%ArrayIteratorPrototype%":ie&&ne?ne([][Symbol.iterator]()):d,"%AsyncFromSyncIteratorPrototype%":d,"%AsyncFunction%":Y,"%AsyncGenerator%":Y,"%AsyncGeneratorFunction%":Y,"%AsyncIteratorPrototype%":Y,"%Atomics%":typeof Atomics>"u"?d:Atomics,"%BigInt%":typeof BigInt>"u"?d:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?d:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?d:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?d:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":t,"%eval%":eval,"%EvalError%":n,"%Float16Array%":typeof Float16Array>"u"?d:Float16Array,"%Float32Array%":typeof Float32Array>"u"?d:Float32Array,"%Float64Array%":typeof Float64Array>"u"?d:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?d:FinalizationRegistry,"%Function%":A,"%GeneratorFunction%":Y,"%Int8Array%":typeof Int8Array>"u"?d:Int8Array,"%Int16Array%":typeof Int16Array>"u"?d:Int16Array,"%Int32Array%":typeof Int32Array>"u"?d:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":ie&&ne?ne(ne([][Symbol.iterator]())):d,"%JSON%":typeof JSON=="object"?JSON:d,"%Map%":typeof Map>"u"?d:Map,"%MapIteratorPrototype%":typeof Map>"u"||!ie||!ne?d:ne(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":e,"%Object.getOwnPropertyDescriptor%":D,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?d:Promise,"%Proxy%":typeof Proxy>"u"?d:Proxy,"%RangeError%":r,"%ReferenceError%":i,"%Reflect%":typeof Reflect>"u"?d:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?d:Set,"%SetIteratorPrototype%":typeof Set>"u"||!ie||!ne?d:ne(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?d:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":ie&&ne?ne(""[Symbol.iterator]()):d,"%Symbol%":ie?Symbol:d,"%SyntaxError%":s,"%ThrowTypeError%":G,"%TypedArray%":Q,"%TypeError%":a,"%Uint8Array%":typeof Uint8Array>"u"?d:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?d:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?d:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?d:Uint32Array,"%URIError%":o,"%WeakMap%":typeof WeakMap>"u"?d:WeakMap,"%WeakRef%":typeof WeakRef>"u"?d:WeakRef,"%WeakSet%":typeof WeakSet>"u"?d:WeakSet,"%Function.prototype.call%":v,"%Function.prototype.apply%":se,"%Object.defineProperty%":I,"%Object.getPrototypeOf%":pe,"%Math.abs%":c,"%Math.floor%":u,"%Math.max%":l,"%Math.min%":h,"%Math.pow%":f,"%Math.round%":E,"%Math.sign%":b,"%Reflect.getPrototypeOf%":F};if(ne)try{null.error}catch(Re){var U=ne(ne(Re));B["%Error.prototype%"]=U}var k=function Re(fe){var be;if(fe==="%AsyncFunction%")be=P("async function () {}");else if(fe==="%GeneratorFunction%")be=P("function* () {}");else if(fe==="%AsyncGeneratorFunction%")be=P("async function* () {}");else if(fe==="%AsyncGenerator%"){var we=Re("%AsyncGeneratorFunction%");we&&(be=we.prototype)}else if(fe==="%AsyncIteratorPrototype%"){var Ee=Re("%AsyncGenerator%");Ee&&ne&&(be=ne(Ee.prototype))}return B[fe]=be,be},L={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},V=Pt(),X=ka(),oe=V.call(v,Array.prototype.concat),ee=V.call(se,Array.prototype.splice),ce=V.call(v,String.prototype.replace),Z=V.call(v,String.prototype.slice),Me=V.call(v,RegExp.prototype.exec),qe=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,Se=/\\(\\)?/g,je=function(fe){var be=Z(fe,0,1),we=Z(fe,-1);if(be==="%"&&we!=="%")throw new s("invalid intrinsic syntax, expected closing `%`");if(we==="%"&&be!=="%")throw new s("invalid intrinsic syntax, expected opening `%`");var Ee=[];return ce(fe,qe,function(Oe,Ge,N,y){Ee[Ee.length]=N?ce(y,Se,"$1"):Ge||Oe}),Ee},Pe=function(fe,be){var we=fe,Ee;if(X(L,we)&&(Ee=L[we],we="%"+Ee[0]+"%"),X(B,we)){var Oe=B[we];if(Oe===Y&&(Oe=k(we)),typeof Oe>"u"&&!be)throw new a("intrinsic "+fe+" exists, but is not available. Please file an issue!");return{alias:Ee,name:we,value:Oe}}throw new s("intrinsic "+fe+" does not exist!")};return jn=function(fe,be){if(typeof fe!="string"||fe.length===0)throw new a("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof be!="boolean")throw new a('"allowMissing" argument must be a boolean');if(Me(/^%?[^%]*%?$/,fe)===null)throw new s("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var we=je(fe),Ee=we.length>0?we[0]:"",Oe=Pe("%"+Ee+"%",be),Ge=Oe.name,N=Oe.value,y=!1,g=Oe.alias;g&&(Ee=g[0],ee(we,oe([0,1],g)));for(var S=1,$=!0;S<we.length;S+=1){var j=we[S],H=Z(j,0,1),ye=Z(j,-1);if((H==='"'||H==="'"||H==="`"||ye==='"'||ye==="'"||ye==="`")&&H!==ye)throw new s("property names with quotes must have matching quotes");if((j==="constructor"||!$)&&(y=!0),Ee+="."+j,Ge="%"+Ee+"%",X(B,Ge))N=B[Ge];else if(N!=null){if(!(j in N)){if(!be)throw new a("base intrinsic for "+fe+" exists, but the property is not available.");return}if(D&&S+1>=we.length){var Ne=D(N,j);$=!!Ne,$&&"get"in Ne&&!("originalValue"in Ne.get)?N=Ne.get:N=N[j]}else $=X(N,j),N=N[j];$&&!y&&(B[Ge]=N)}}return N},jn}var kn,bi;function Os(){if(bi)return kn;bi=1;var d=Is(),e=Nr(),t=e([d("%String.prototype.indexOf%")]);return kn=function(r,i){var s=d(r,!!i);return typeof s=="function"&&t(r,".prototype.")>-1?e([s]):s},kn}var Qn,wi;function Qa(){if(wi)return Qn;wi=1;var d=Function.prototype.toString,e=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,t,n;if(typeof e=="function"&&typeof Object.defineProperty=="function")try{t=Object.defineProperty({},"length",{get:function(){throw n}}),n={},e(function(){throw 42},null,t)}catch(D){D!==n&&(e=null)}else e=null;var r=/^\s*class\b/,i=function(I){try{var W=d.call(I);return r.test(W)}catch{return!1}},s=function(I){try{return i(I)?!1:(d.call(I),!0)}catch{return!1}},a=Object.prototype.toString,o="[object Object]",c="[object Function]",u="[object GeneratorFunction]",l="[object HTMLAllCollection]",h="[object HTML document.all class]",f="[object HTMLCollection]",E=typeof Symbol=="function"&&!!Symbol.toStringTag,b=!(0 in[,]),A=function(){return!1};if(typeof document=="object"){var P=document.all;a.call(P)===a.call(document.all)&&(A=function(I){if((b||!I)&&(typeof I>"u"||typeof I=="object"))try{var W=a.call(I);return(W===l||W===h||W===f||W===o)&&I("")==null}catch{}return!1})}return Qn=e?function(I){if(A(I))return!0;if(!I||typeof I!="function"&&typeof I!="object")return!1;try{e(I,null,t)}catch(W){if(W!==n)return!1}return!i(I)&&s(I)}:function(I){if(A(I))return!0;if(!I||typeof I!="function"&&typeof I!="object")return!1;if(E)return s(I);if(i(I))return!1;var W=a.call(I);return W!==c&&W!==u&&!/^\[object HTML/.test(W)?!1:s(I)},Qn}var Vn,Ni;function Va(){if(Ni)return Vn;Ni=1;var d=Qa(),e=Object.prototype.toString,t=Object.prototype.hasOwnProperty,n=function(o,c,u){for(var l=0,h=o.length;l<h;l++)t.call(o,l)&&(u==null?c(o[l],l,o):c.call(u,o[l],l,o))},r=function(o,c,u){for(var l=0,h=o.length;l<h;l++)u==null?c(o.charAt(l),l,o):c.call(u,o.charAt(l),l,o)},i=function(o,c,u){for(var l in o)t.call(o,l)&&(u==null?c(o[l],l,o):c.call(u,o[l],l,o))};function s(a){return e.call(a)==="[object Array]"}return Vn=function(o,c,u){if(!d(c))throw new TypeError("iterator must be a function");var l;arguments.length>=3&&(l=u),s(o)?n(o,c,l):typeof o=="string"?r(o,c,l):i(o,c,l)},Vn}var Wn,Ai;function Wa(){return Ai||(Ai=1,Wn=["Float16Array","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"]),Wn}var Hn,Ci;function Ha(){if(Ci)return Hn;Ci=1;var d=Wa(),e=typeof globalThis>"u"?Wt:globalThis;return Hn=function(){for(var n=[],r=0;r<d.length;r++)typeof e[d[r]]=="function"&&(n[n.length]=d[r]);return n},Hn}var Gn={exports:{}},zn,Si;function Ga(){if(Si)return zn;Si=1;var d=Yt(),e=Ss(),t=Mt(),n=vt();return zn=function(i,s,a){if(!i||typeof i!="object"&&typeof i!="function")throw new t("`obj` must be an object or a function`");if(typeof s!="string"&&typeof s!="symbol")throw new t("`property` must be a string or a symbol`");if(arguments.length>3&&typeof arguments[3]!="boolean"&&arguments[3]!==null)throw new t("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&typeof arguments[4]!="boolean"&&arguments[4]!==null)throw new t("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&typeof arguments[5]!="boolean"&&arguments[5]!==null)throw new t("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&typeof arguments[6]!="boolean")throw new t("`loose`, if provided, must be a boolean");var o=arguments.length>3?arguments[3]:null,c=arguments.length>4?arguments[4]:null,u=arguments.length>5?arguments[5]:null,l=arguments.length>6?arguments[6]:!1,h=!!n&&n(i,s);if(d)d(i,s,{configurable:u===null&&h?h.configurable:!u,enumerable:o===null&&h?h.enumerable:!o,value:a,writable:c===null&&h?h.writable:!c});else if(l||!o&&!c&&!u)i[s]=a;else throw new e("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.")},zn}var Kn,Ri;function za(){if(Ri)return Kn;Ri=1;var d=Yt(),e=function(){return!!d};return e.hasArrayLengthDefineBug=function(){if(!d)return null;try{return d([],"length",{value:1}).length!==1}catch{return!0}},Kn=e,Kn}var Jn,xi;function Ka(){if(xi)return Jn;xi=1;var d=Is(),e=Ga(),t=za()(),n=vt(),r=Mt(),i=d("%Math.floor%");return Jn=function(a,o){if(typeof a!="function")throw new r("`fn` is not a function");if(typeof o!="number"||o<0||o>4294967295||i(o)!==o)throw new r("`length` must be a positive 32-bit integer");var c=arguments.length>2&&!!arguments[2],u=!0,l=!0;if("length"in a&&n){var h=n(a,"length");h&&!h.configurable&&(u=!1),h&&!h.writable&&(l=!1)}return(u||l||!c)&&(t?e(a,"length",o,!0,!0):e(a,"length",o)),a},Jn}var Yn,Mi;function Ja(){if(Mi)return Yn;Mi=1;var d=Pt(),e=wr(),t=vs();return Yn=function(){return t(d,e,arguments)},Yn}var vi;function Ya(){return vi||(vi=1,(function(d){var e=Ka(),t=Yt(),n=Nr(),r=Ja();d.exports=function(s){var a=n(arguments),o=s.length-(arguments.length-1);return e(a,1+(o>0?o:0),!0)},t?t(d.exports,"apply",{value:r}):d.exports.apply=r})(Gn)),Gn.exports}var Xn,Pi;function Xa(){if(Pi)return Xn;Pi=1;var d=Rs();return Xn=function(){return d()&&!!Symbol.toStringTag},Xn}var Zn,Ii;function Za(){if(Ii)return Zn;Ii=1;var d=Va(),e=Ha(),t=Ya(),n=Os(),r=vt(),i=Ps(),s=n("Object.prototype.toString"),a=Xa()(),o=typeof globalThis>"u"?Wt:globalThis,c=e(),u=n("String.prototype.slice"),l=n("Array.prototype.indexOf",!0)||function(A,P){for(var D=0;D<A.length;D+=1)if(A[D]===P)return D;return-1},h={__proto__:null};a&&r&&i?d(c,function(b){var A=new o[b];if(Symbol.toStringTag in A&&i){var P=i(A),D=r(P,Symbol.toStringTag);if(!D&&P){var I=i(P);D=r(I,Symbol.toStringTag)}h["$"+b]=t(D.get)}}):d(c,function(b){var A=new o[b],P=A.slice||A.set;P&&(h["$"+b]=t(P))});var f=function(A){var P=!1;return d(h,function(D,I){if(!P)try{"$"+D(A)===I&&(P=u(I,1))}catch{}}),P},E=function(A){var P=!1;return d(h,function(D,I){if(!P)try{D(A),P=u(I,1)}catch{}}),P};return Zn=function(A){if(!A||typeof A!="object")return!1;if(!a){var P=u(s(A),8,-1);return l(c,P)>-1?P:P!=="Object"?!1:E(A)}return r?f(A):null},Zn}var er,Oi;function eo(){if(Oi)return er;Oi=1;var d=Za();return er=function(t){return!!d(t)},er}var tr,Di;function to(){if(Di)return tr;Di=1;var d=Mt(),e=Os(),t=e("TypedArray.prototype.buffer",!0),n=eo();return tr=t||function(i){if(!n(i))throw new d("Not a Typed Array");return i.buffer},tr}var nr,qi;function no(){if(qi)return nr;qi=1;var d=ft().Buffer,e=Aa(),t=to(),n=ArrayBuffer.isView||function(o){try{return t(o),!0}catch{return!1}},r=typeof Uint8Array<"u",i=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",s=i&&(d.prototype instanceof Uint8Array||d.TYPED_ARRAY_SUPPORT);return nr=function(o,c){if(d.isBuffer(o))return o.constructor&&!("isBuffer"in o)?d.from(o):o;if(typeof o=="string")return d.from(o,c);if(i&&n(o)){if(o.byteLength===0)return d.alloc(0);if(s){var u=d.from(o.buffer,o.byteOffset,o.byteLength);if(u.byteLength===o.byteLength)return u}var l=o instanceof Uint8Array?o:new Uint8Array(o.buffer,o.byteOffset,o.byteLength),h=d.from(l);if(h.length===o.byteLength)return h}if(r&&o instanceof Uint8Array)return d.from(o);var f=e(o);if(f)for(var E=0;E<o.length;E+=1){var b=o[E];if(typeof b!="number"||b<0||b>255||~~b!==b)throw new RangeError("Array items must be numbers in the range 0-255.")}if(f||d.isBuffer(o)&&o.constructor&&typeof o.constructor.isBuffer=="function"&&o.constructor.isBuffer(o))return d.from(o);throw new TypeError('The "data" argument must be a string, an Array, a Buffer, a Uint8Array, or a DataView.')},nr}var rr,$i;function Nt(){if($i)return rr;$i=1;var d=ft().Buffer,e=no();function t(n,r){this._block=d.alloc(n),this._finalSize=r,this._blockSize=n,this._len=0}return t.prototype.update=function(n,r){n=e(n,r||"utf8");for(var i=this._block,s=this._blockSize,a=n.length,o=this._len,c=0;c<a;){for(var u=o%s,l=Math.min(a-c,s-u),h=0;h<l;h++)i[u+h]=n[c+h];o+=l,c+=l,o%s===0&&this._update(i)}return this._len+=a,this},t.prototype.digest=function(n){var r=this._len%this._blockSize;this._block[r]=128,this._block.fill(0,r+1),r>=this._finalSize&&(this._update(this._block),this._block.fill(0));var i=this._len*8;if(i<=4294967295)this._block.writeUInt32BE(i,this._blockSize-4);else{var s=(i&4294967295)>>>0,a=(i-s)/4294967296;this._block.writeUInt32BE(a,this._blockSize-8),this._block.writeUInt32BE(s,this._blockSize-4)}this._update(this._block);var o=this._hash();return n?o.toString(n):o},t.prototype._update=function(){throw new Error("_update must be implemented by subclass")},rr=t,rr}var ir,_i;function ro(){if(_i)return ir;_i=1;var d=wt(),e=Nt(),t=ft().Buffer,n=[1518500249,1859775393,-1894007588,-899497514],r=new Array(80);function i(){this.init(),this._w=r,e.call(this,64,56)}d(i,e),i.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function s(c){return c<<5|c>>>27}function a(c){return c<<30|c>>>2}function o(c,u,l,h){return c===0?u&l|~u&h:c===2?u&l|u&h|l&h:u^l^h}return i.prototype._update=function(c){for(var u=this._w,l=this._a|0,h=this._b|0,f=this._c|0,E=this._d|0,b=this._e|0,A=0;A<16;++A)u[A]=c.readInt32BE(A*4);for(;A<80;++A)u[A]=u[A-3]^u[A-8]^u[A-14]^u[A-16];for(var P=0;P<80;++P){var D=~~(P/20),I=s(l)+o(D,h,f,E)+b+u[P]+n[D]|0;b=E,E=f,f=a(h),h=l,l=I}this._a=l+this._a|0,this._b=h+this._b|0,this._c=f+this._c|0,this._d=E+this._d|0,this._e=b+this._e|0},i.prototype._hash=function(){var c=t.allocUnsafe(20);return c.writeInt32BE(this._a|0,0),c.writeInt32BE(this._b|0,4),c.writeInt32BE(this._c|0,8),c.writeInt32BE(this._d|0,12),c.writeInt32BE(this._e|0,16),c},ir=i,ir}var sr,Li;function io(){if(Li)return sr;Li=1;var d=wt(),e=Nt(),t=ft().Buffer,n=[1518500249,1859775393,-1894007588,-899497514],r=new Array(80);function i(){this.init(),this._w=r,e.call(this,64,56)}d(i,e),i.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function s(u){return u<<1|u>>>31}function a(u){return u<<5|u>>>27}function o(u){return u<<30|u>>>2}function c(u,l,h,f){return u===0?l&h|~l&f:u===2?l&h|l&f|h&f:l^h^f}return i.prototype._update=function(u){for(var l=this._w,h=this._a|0,f=this._b|0,E=this._c|0,b=this._d|0,A=this._e|0,P=0;P<16;++P)l[P]=u.readInt32BE(P*4);for(;P<80;++P)l[P]=s(l[P-3]^l[P-8]^l[P-14]^l[P-16]);for(var D=0;D<80;++D){var I=~~(D/20),W=a(h)+c(I,f,E,b)+A+l[D]+n[I]|0;A=b,b=E,E=o(f),f=h,h=W}this._a=h+this._a|0,this._b=f+this._b|0,this._c=E+this._c|0,this._d=b+this._d|0,this._e=A+this._e|0},i.prototype._hash=function(){var u=t.allocUnsafe(20);return u.writeInt32BE(this._a|0,0),u.writeInt32BE(this._b|0,4),u.writeInt32BE(this._c|0,8),u.writeInt32BE(this._d|0,12),u.writeInt32BE(this._e|0,16),u},sr=i,sr}var ar,Bi;function Ds(){if(Bi)return ar;Bi=1;var d=wt(),e=Nt(),t=ft().Buffer,n=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],r=new Array(64);function i(){this.init(),this._w=r,e.call(this,64,56)}d(i,e),i.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function s(h,f,E){return E^h&(f^E)}function a(h,f,E){return h&f|E&(h|f)}function o(h){return(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10)}function c(h){return(h>>>6|h<<26)^(h>>>11|h<<21)^(h>>>25|h<<7)}function u(h){return(h>>>7|h<<25)^(h>>>18|h<<14)^h>>>3}function l(h){return(h>>>17|h<<15)^(h>>>19|h<<13)^h>>>10}return i.prototype._update=function(h){for(var f=this._w,E=this._a|0,b=this._b|0,A=this._c|0,P=this._d|0,D=this._e|0,I=this._f|0,W=this._g|0,G=this._h|0,ie=0;ie<16;++ie)f[ie]=h.readInt32BE(ie*4);for(;ie<64;++ie)f[ie]=l(f[ie-2])+f[ie-7]+u(f[ie-15])+f[ie-16]|0;for(var ne=0;ne<64;++ne){var pe=G+c(D)+s(D,I,W)+n[ne]+f[ne]|0,F=o(E)+a(E,b,A)|0;G=W,W=I,I=D,D=P+pe|0,P=A,A=b,b=E,E=pe+F|0}this._a=E+this._a|0,this._b=b+this._b|0,this._c=A+this._c|0,this._d=P+this._d|0,this._e=D+this._e|0,this._f=I+this._f|0,this._g=W+this._g|0,this._h=G+this._h|0},i.prototype._hash=function(){var h=t.allocUnsafe(32);return h.writeInt32BE(this._a,0),h.writeInt32BE(this._b,4),h.writeInt32BE(this._c,8),h.writeInt32BE(this._d,12),h.writeInt32BE(this._e,16),h.writeInt32BE(this._f,20),h.writeInt32BE(this._g,24),h.writeInt32BE(this._h,28),h},ar=i,ar}var or,Ui;function so(){if(Ui)return or;Ui=1;var d=wt(),e=Ds(),t=Nt(),n=ft().Buffer,r=new Array(64);function i(){this.init(),this._w=r,t.call(this,64,56)}return d(i,e),i.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},i.prototype._hash=function(){var s=n.allocUnsafe(28);return s.writeInt32BE(this._a,0),s.writeInt32BE(this._b,4),s.writeInt32BE(this._c,8),s.writeInt32BE(this._d,12),s.writeInt32BE(this._e,16),s.writeInt32BE(this._f,20),s.writeInt32BE(this._g,24),s},or=i,or}var cr,Fi;function qs(){if(Fi)return cr;Fi=1;var d=wt(),e=Nt(),t=ft().Buffer,n=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],r=new Array(160);function i(){this.init(),this._w=r,e.call(this,128,112)}d(i,e),i.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function s(b,A,P){return P^b&(A^P)}function a(b,A,P){return b&A|P&(b|A)}function o(b,A){return(b>>>28|A<<4)^(A>>>2|b<<30)^(A>>>7|b<<25)}function c(b,A){return(b>>>14|A<<18)^(b>>>18|A<<14)^(A>>>9|b<<23)}function u(b,A){return(b>>>1|A<<31)^(b>>>8|A<<24)^b>>>7}function l(b,A){return(b>>>1|A<<31)^(b>>>8|A<<24)^(b>>>7|A<<25)}function h(b,A){return(b>>>19|A<<13)^(A>>>29|b<<3)^b>>>6}function f(b,A){return(b>>>19|A<<13)^(A>>>29|b<<3)^(b>>>6|A<<26)}function E(b,A){return b>>>0<A>>>0?1:0}return i.prototype._update=function(b){for(var A=this._w,P=this._ah|0,D=this._bh|0,I=this._ch|0,W=this._dh|0,G=this._eh|0,ie=this._fh|0,ne=this._gh|0,pe=this._hh|0,F=this._al|0,se=this._bl|0,v=this._cl|0,Y=this._dl|0,Q=this._el|0,B=this._fl|0,U=this._gl|0,k=this._hl|0,L=0;L<32;L+=2)A[L]=b.readInt32BE(L*4),A[L+1]=b.readInt32BE(L*4+4);for(;L<160;L+=2){var V=A[L-30],X=A[L-30+1],oe=u(V,X),ee=l(X,V);V=A[L-4],X=A[L-4+1];var ce=h(V,X),Z=f(X,V),Me=A[L-14],qe=A[L-14+1],Se=A[L-32],je=A[L-32+1],Pe=ee+qe|0,Re=oe+Me+E(Pe,ee)|0;Pe=Pe+Z|0,Re=Re+ce+E(Pe,Z)|0,Pe=Pe+je|0,Re=Re+Se+E(Pe,je)|0,A[L]=Re,A[L+1]=Pe}for(var fe=0;fe<160;fe+=2){Re=A[fe],Pe=A[fe+1];var be=a(P,D,I),we=a(F,se,v),Ee=o(P,F),Oe=o(F,P),Ge=c(G,Q),N=c(Q,G),y=n[fe],g=n[fe+1],S=s(G,ie,ne),$=s(Q,B,U),j=k+N|0,H=pe+Ge+E(j,k)|0;j=j+$|0,H=H+S+E(j,$)|0,j=j+g|0,H=H+y+E(j,g)|0,j=j+Pe|0,H=H+Re+E(j,Pe)|0;var ye=Oe+we|0,Ne=Ee+be+E(ye,Oe)|0;pe=ne,k=U,ne=ie,U=B,ie=G,B=Q,Q=Y+j|0,G=W+H+E(Q,Y)|0,W=I,Y=v,I=D,v=se,D=P,se=F,F=j+ye|0,P=H+Ne+E(F,j)|0}this._al=this._al+F|0,this._bl=this._bl+se|0,this._cl=this._cl+v|0,this._dl=this._dl+Y|0,this._el=this._el+Q|0,this._fl=this._fl+B|0,this._gl=this._gl+U|0,this._hl=this._hl+k|0,this._ah=this._ah+P+E(this._al,F)|0,this._bh=this._bh+D+E(this._bl,se)|0,this._ch=this._ch+I+E(this._cl,v)|0,this._dh=this._dh+W+E(this._dl,Y)|0,this._eh=this._eh+G+E(this._el,Q)|0,this._fh=this._fh+ie+E(this._fl,B)|0,this._gh=this._gh+ne+E(this._gl,U)|0,this._hh=this._hh+pe+E(this._hl,k)|0},i.prototype._hash=function(){var b=t.allocUnsafe(64);function A(P,D,I){b.writeInt32BE(P,I),b.writeInt32BE(D,I+4)}return A(this._ah,this._al,0),A(this._bh,this._bl,8),A(this._ch,this._cl,16),A(this._dh,this._dl,24),A(this._eh,this._el,32),A(this._fh,this._fl,40),A(this._gh,this._gl,48),A(this._hh,this._hl,56),b},cr=i,cr}var ur,ji;function ao(){if(ji)return ur;ji=1;var d=wt(),e=qs(),t=Nt(),n=ft().Buffer,r=new Array(160);function i(){this.init(),this._w=r,t.call(this,128,112)}return d(i,e),i.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},i.prototype._hash=function(){var s=n.allocUnsafe(48);function a(o,c,u){s.writeInt32BE(o,u),s.writeInt32BE(c,u+4)}return a(this._ah,this._al,0),a(this._bh,this._bl,8),a(this._ch,this._cl,16),a(this._dh,this._dl,24),a(this._eh,this._el,32),a(this._fh,this._fl,40),s},ur=i,ur}var ki;function oo(){return ki||(ki=1,(function(d){d.exports=function(t){var n=t.toLowerCase(),r=d.exports[n];if(!r)throw new Error(n+" is not supported (we accept pull requests)");return new r},d.exports.sha=ro(),d.exports.sha1=io(),d.exports.sha224=so(),d.exports.sha256=Ds(),d.exports.sha384=ao(),d.exports.sha512=qs()})(sn)),sn.exports}var co=oo();const uo=ys(co);function lr(d,e=!1){return e&&(d=" "+d),d.replace(/^([A-Z])|[\s-_](\w)/g,function(t,n,r){return r?r.toUpperCase():n.toLowerCase()})}function Qi(d){return d.replace(/([A-Z])([A-Z])([a-z])/g,"$1_$2$3").replace(/([a-z0-9])([A-Z])/g,"$1_$2").toLowerCase()}function lo(d){return d.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}function $s(d,e={}){const{segmentLength:t=4,separator:n="__",termLength:r=2}=e;return d.split(n).reduce((a,o)=>{const c=o.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),u=c.length>1?r:t,l=c.map(h=>h.substr(0,u)).join("");return a.push(l),a},[]).join(n)}function ho(d,e={}){const t=uo("sha1");t.update(d,"utf8");const n=t.digest("hex");return e.length&&e.length>0?n.slice(0,e.length):n}class po{static isGreaterOrEqual(e,t){if(!e)return!1;const n=Vi(e),r=Vi(t);for(let i=0;i<n.length&&i<r.length;i++){if(n[i]>r[i])return!0;if(n[i]<r[i])return!1}return!0}}function Vi(d){return d.split(".").map(e=>parseInt(e,10))}class J{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return po.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){const n=this.parseConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const r of Object.keys(n))typeof n[r]>"u"&&delete n[r];return Object.assign({},e,n)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){const n=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const r of Object.keys(n))typeof n[r]>"u"&&delete n[r];return Object.assign({},e,n)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...n){const r=t&&t.joiner?t.joiner:"_",i=n.length===1?n[0]:n.join(r);if(e&&e>0&&i.length>e){if(t&&t.shorten===!0){const s=$s(i);if(s.length<e)return s}return ho(i,{length:e})}return i}static buildColumnAlias({maxAliasLength:e},t,...n){return typeof t=="string"?(n.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...n)}static parseConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),r=e.substr(n+2),i=r.indexOf("/"),s=i!==-1?r.substr(0,i):r;let a=i!==-1?r.substr(i+1):void 0;a&&a.indexOf("?")!==-1&&(a=a.substr(0,a.indexOf("?")));const o=s.lastIndexOf("@"),c=s.substr(0,o),u=s.substr(o+1);let l=c,h="";const f=c.indexOf(":");f!==-1&&(l=c.substr(0,f),h=c.substr(f+1));const[E,b]=u.split(":");return{type:t,host:E,username:decodeURIComponent(l),password:decodeURIComponent(h),port:b?parseInt(b):void 0,database:a||void 0}}static parseMongoDBConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),r=e.substr(n+2),i=r.indexOf("/"),s=i!==-1?r.substr(0,i):r;let a=i!==-1?r.substr(i+1):void 0,o="",c,u,l,h;const f={};if(a&&a.indexOf("?")!==-1){o=a.substr(a.indexOf("?")+1,a.length);const G=o.split("&");let ie,ne;G.forEach(pe=>{ie=pe.split("=")[0],ne=pe.split("=")[1],f[ie]=ne}),h=f.replicaSet,a=a.substr(0,a.indexOf("?"))}const E=s.lastIndexOf("@"),b=s.substr(0,E),A=s.substr(E+1);let P=b,D="";const I=b.indexOf(":");I!==-1&&(P=b.substr(0,I),D=b.substr(I+1)),h?l=A:[c,u]=A.split(":");const W={type:t,host:c,hostReplicaSet:l,username:decodeURIComponent(P),password:decodeURIComponent(D),port:u?parseInt(u):void 0,database:a||void 0};for(const[G,ie]of Object.entries(f))W[G]=ie;return W}}class _s{constructor(e,t,n){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,n&&me.assign(this,n)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){const e=()=>{for(const t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(n=>t.selection===this.alias.name+"."+n.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(ot.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(ot.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){const e=()=>{if(!ot.isAliasProperty(this.entityOrProperty))return;const t=this.queryExpressionMap.findAliasByName(this.parentAlias);let n=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(n||t.metadata.parentEntityMetadata&&(n=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),n))return n;throw new M(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new M("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new M("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?J.buildAlias(this.connection.driver,void 0,e,this.alias.name):J.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class Ar{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,me.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!ot.isAliasProperty(this.relationName))throw new M("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!ot.isAliasProperty(this.relationName))throw new M("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!ot.isAliasProperty(this.relationName))throw new M("Given value must be a string representation of alias property");const t=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!t)throw new M(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return t}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class Cr{constructor(e,t){this.expressionMap=e,me.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!ot.isAliasProperty(this.relationName))throw new M("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!ot.isAliasProperty(this.relationName))throw new M("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!ot.isAliasProperty(this.relationName))throw new M("Given value is a string representation of alias property");const[e,t]=this.relationName.split("."),r=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!r)throw new M(`Relation with property path ${t} in entity was not found.`);return r}get metadata(){if(!ot.isAliasProperty(this.relationName))throw new M("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class Sr{constructor(e){this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=e.options?.timeTravelQueries||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,n)=>(t[this.mainAlias.name+"."+n]=e[n],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);const n=new $r;return n.type=e.type,t&&(n.name=t),e.metadata&&(n.metadata=e.metadata),e.target&&!n.hasMetadata&&(n.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(n.tablePath=e.tablePath),e.subQuery&&(n.subQuery=e.subQuery),this.aliases.push(n),n}findAliasByName(e){const t=this.aliases.find(n=>n.name===e);if(!t)throw new M(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){const[t,n]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(n)}get relationMetadata(){if(!this.mainAlias)throw new M("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new M(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new Sr(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new $r(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new _s(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new Ar(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new Cr(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.useIndex=this.useIndex,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}}class Ht{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class ke{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((r,i)=>i.from(r),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((n,r)=>r.to(n),t):e.to(t)}}class It{constructor(e,t,n=!0,r=!1,i,s){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=n,this._multipleParameters=r,this._getSql=i,this._objectLiteralParameters=s}get useParameter(){return q.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return q.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return q.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return q.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(q.isFindOperator(this._value))return this._value}get getSql(){return q.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof It?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&ke.transformTo(e,t)):ke.transformTo(e,this._value)}}function fo(d){return new It("in",d,!0,!0)}const mo=/[.*+\-?^${}()|[\]\\]/g,yo=d=>d.replace(mo,"\\$&");class Le{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,q.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new Sr(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){Le.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new M("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(n=>({selection:n})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),q.isSelectQueryBuilder(this)?this:Le.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",q.isInsertQueryBuilder(this)?this:Le.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){const n=t||e;if(e=q.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const r=this.createFromAlias(e);this.expressionMap.setMainAlias(r)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=n,q.isUpdateQueryBuilder(this)?this:Le.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",q.isDeleteQueryBuilder(this)?this:Le.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",q.isSoftDeleteQueryBuilder(this)?this:Le.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",q.isSoftDeleteQueryBuilder(this)?this:Le.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){const n=arguments.length===2?e:void 0,r=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=r,n){const i=this.createFromAlias(n);this.expressionMap.setMainAlias(i)}return q.isRelationQueryBuilder(this)?this:Le.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){const n=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(i=>!!n.findRelationWithPropertyPath(i))}hasParameter(e){return this.parentQueryBuilder?.hasParameter(e)||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new M(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new M("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(const[t,n]of Object.entries(e))this.setParameter(t,n);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){const n=t.childEntityMetadatas.filter(r=>r.discriminatorColumn).map(r=>r.discriminatorValue);n.push(t.discriminatorValue),e.discriminatorColumnValues=n}}return e}printSql(){const[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();try{return await n.query(e,t)}finally{n!==this.queryRunner&&await n.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,n){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:n||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new M('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){const n=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:n.tablePath})}else{if(typeof e=="string"){const i=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:i?void 0:e,subQuery:i?e:void 0})}const n=e(this.subQuery());this.setParameters(n.getParameters());const r=n.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:r})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const t={};for(const i of this.expressionMap.aliases){if(!i.hasMetadata)continue;const s=this.expressionMap.aliasNamePrefixingEnabled&&i.name?`${i.name}.`:"";t[s]||(t[s]={});for(const a of i.metadata.relations)a.joinColumns.length>0&&(t[s][a.propertyPath]=a.joinColumns[0].databaseName);for(const a of i.metadata.relations){const o=[...a.joinColumns,...a.inverseJoinColumns];for(const c of o){const u=`${a.propertyPath}.${c.referencedColumn.propertyPath}`;t[s][u]=c.databaseName}}for(const a of i.metadata.columns)t[s][a.databaseName]=a.databaseName;for(const a of i.metadata.columns)t[s][a.propertyName]=a.databaseName;for(const a of i.metadata.columns)t[s][a.propertyPath]=a.databaseName}const n=Object.keys(t),r=n.map(i=>yo(i)).join("|");return n.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${r?"("+r+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...i)=>{let s,a,o;if(r){if(s=i[0],a=i[1],o=i[3],t[i[2]][o])return`${a}${this.escape(i[2].substring(0,i[2].length-1))}.${this.escape(t[i[2]][o])}`}else if(s=i[0],a=i[1],o=i[2],t[""][o])return`${a}${this.escape(t[""][o])}`;return s})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){const r=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&r.deleteDateColumn){const i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+r.deleteDateColumn.propertyName:r.deleteDateColumn.propertyName,s=`${this.replacePropertyNames(i)} IS NULL`;e.push(s)}if(r.discriminatorColumn&&r.parentEntityMetadata){const i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+r.discriminatorColumn.databaseName:r.discriminatorColumn.databaseName,s=`${this.replacePropertyNames(i)} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){const r=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(r)}let n="";return n+=this.createTimeTravelQuery(),e.length?e.length===1?n+=` WHERE ${e[0]}`:n+=` WHERE ( ${e.join(" ) AND ( ")} )`:n+="",n}createReturningExpression(e){const t=this.getReturningColumns(),n=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&n.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(r=>t.indexOf(r)===-1)),t.length){let r=t.map(i=>{const s=this.escape(i.databaseName);return n.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+s:this.escape(this.getMainTableName())+"."+s:s}).join(", ");return n.options.type==="oracle"&&(r+=" INTO "+t.map(i=>this.createParameter({type:n.columnTypeToNativeParameter(i.type),dir:n.oracle.BIND_OUT})).join(", ")),n.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(r+=" INTO @OutputTable"),r}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,n)=>{const r=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(n>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${r}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(n>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${r}${this.connection.options.isolateWhereStatements?")":""}`}return r}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:n}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return n.options.type==="postgres"||n.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return n.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${It.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(n=>{let r=typeof n.queryBuilder=="string"?n.queryBuilder:"";if(typeof n.queryBuilder!="string"){if(n.queryBuilder.hasCommonTableExpressions())throw new M(`Nested CTEs aren't supported (CTE: ${n.alias})`);if(r=n.queryBuilder.getQuery(),!this.connection.driver.cteCapabilities.writable&&!q.isSelectQueryBuilder(n.queryBuilder))throw new M(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${n.alias})`);this.setParameters(n.queryBuilder.getParameters())}let i=this.escape(n.alias);if(n.options.columnNames){const o=n.options.columnNames.map(c=>this.escape(c));if(q.isSelectQueryBuilder(n.queryBuilder)&&n.queryBuilder.expressionMap.selects.length&&n.options.columnNames.length!==n.queryBuilder.expressionMap.selects.length)throw new M(`cte.options.columnNames length (${n.options.columnNames.length}) doesn't match subquery select list length ${n.queryBuilder.expressionMap.selects.length} (CTE: ${n.alias})`);i+=`(${o.join(", ")})`}const s=n.options.recursive&&e?"RECURSIVE":"";let a="";return this.connection.driver.cteCapabilities.materializedHint&&n.options.materialized!==void 0&&(a=n.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[s,i,"AS",a,`(${r})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const t=this.expressionMap.mainAlias.metadata,n=(Array.isArray(e)?e:[e]).map(r=>t.ensureEntityIdMap(r));if(!t.hasMultiplePrimaryKeys){const r=t.primaryColumns[0];if(!r.transformer&&!r.relationMetadata&&!r.embeddedMetadata)return{[r.propertyName]:fo(n.map(i=>r.getEntityValue(i,!1)))}}return new Ht(r=>{for(const i of n)r.orWhere(new Ht(s=>s.where(i)))})}getExistsCondition(e){const t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias;const n=[],r=e.split(".");for(;r.length>1;){const a=r[0];if(!t?.hasMetadata)break;if(t.metadata.hasEmbeddedWithPropertyPath(a)){r.unshift(`${r.shift()}.${r.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(a)){const o=this.expressionMap.joinAttributes.find(c=>c.relationPropertyPath===a);if(!o?.alias){const c=n.length>0?`${n.join(".")}.${a}`:a;throw new Error(`Cannot find alias for relation at ${c}`)}t=o.alias,n.push(...a.split(".")),r.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);const i=r.join("."),s=t.metadata.findColumnsWithPropertyPath(i);if(!s.length)throw new nt(e,t.metadata);return[t,n,s]}createPropertyPath(e,t,n=""){const r=[];for(const i of Object.keys(t)){const s=n?`${n}.${i}`:i;if(t[i]===null||typeof t[i]!="object"||q.isFindOperator(t[i])){r.push(s);continue}if(e.hasEmbeddedWithPropertyPath(s)){const a=this.createPropertyPath(e,t[i],s);r.push(...a);continue}if(e.hasRelationWithPropertyPath(s)){const a=e.findRelationWithPropertyPath(s);if(a.relationType==="one-to-one"||a.relationType==="many-to-one"){const l=a.joinColumns.map(f=>f.referencedColumn).filter(f=>!!f);if(l.length>0&&l.every(f=>f.getEntityValue(t[i],!1))){r.push(s);continue}}if(a.relationType==="one-to-many"||a.relationType==="many-to-many")throw new Error(`Cannot query across ${a.relationType} for property ${s}`);const o=a.inverseEntityMetadata.primaryColumns;if(o.length>0&&o.every(l=>l.getEntityValue(t[i],!1))){const l=o.map(h=>`${s}.${h.propertyPath}`);r.push(...l);continue}const u=this.createPropertyPath(a.inverseEntityMetadata,t[i]).map(l=>`${s}.${l}`);r.push(...u);continue}r.push(s)}return r}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const n of t){const[r,i,s]=this.findColumnsForPropertyPath(n);for(const a of s){let o=e;for(const l of i){if(!o||!(l in o)){o={};break}o=o[l]}const c=this.expressionMap.aliasNamePrefixingEnabled?`${r.name}.${a.propertyPath}`:a.propertyPath,u=a.getEntityValue(o,!0);yield[c,u]}}}else for(const t of Object.keys(e)){const n=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,n]}}getWherePredicateCondition(e,t){if(q.isFindOperator(t)){const n=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(const r of t.value)n.push(this.createParameter(r));else n.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...n]};if(t.type==="and"){const r=t.value;return{operator:t.type,parameters:r.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else if(t.type==="or"){const r=t.value;return{operator:t.type,parameters:r.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else return{operator:t.type,parameters:[e,...n]}}else if(t===null){const n=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(n==="sql-null")return{operator:"isNull",parameters:[e]};if(n==="throw")throw new M(`Null value encountered in property '${e}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}else if(t===void 0&&(this.connection.options.invalidWhereValuesBehavior?.undefined||"ignore")==="throw")throw new M(`Undefined value encountered in property '${e}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(q.isBrackets(e)){const r=this.createQueryBuilder();return r.parentQueryBuilder=this,r.expressionMap.mainAlias=this.expressionMap.mainAlias,r.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,r.expressionMap.parameters=this.expressionMap.parameters,r.expressionMap.nativeParameters=this.expressionMap.nativeParameters,r.expressionMap.wheres=[],e.whereFactory(r),{operator:q.isNotBrackets(e)?"not":"brackets",condition:r.expressionMap.wheres}}if(typeof e=="function")return e(this);const t=Array.isArray(e)?e:[e],n=[];for(const r of t){const i=[];for(const[s,a]of this.getPredicates(r))i.push({type:"and",condition:this.getWherePredicateCondition(s,a)});n.push({type:"or",condition:i})}return n.length===1?n[0].condition:n}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}Le.queryBuilderRegistry={};class go{static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class Eo extends Le{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let r=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),r=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const i=await n.query(e,t,!0),s=go.from(i);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),r&&await n.commitTransaction(),s}catch(i){if(r)try{await n.rollbackTransaction()}catch{}throw i}finally{n!==this.queryRunner&&await n.release()}}from(e,t){e=q.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new Jt;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),n=this.createReturningExpression("delete");return n===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${n}${t}`:this.connection.driver.options.type==="spanner"?`DELETE FROM ${e}${t} THEN RETURN ${n}`:`DELETE FROM ${e}${t} RETURNING ${n}`}}const Qe=[];for(let d=0;d<256;++d)Qe.push((d+256).toString(16).slice(1));function To(d,e=0){return(Qe[d[e+0]]+Qe[d[e+1]]+Qe[d[e+2]]+Qe[d[e+3]]+"-"+Qe[d[e+4]]+Qe[d[e+5]]+"-"+Qe[d[e+6]]+Qe[d[e+7]]+"-"+Qe[d[e+8]]+Qe[d[e+9]]+"-"+Qe[d[e+10]]+Qe[d[e+11]]+Qe[d[e+12]]+Qe[d[e+13]]+Qe[d[e+14]]+Qe[d[e+15]]).toLowerCase()}let hr;const bo=new Uint8Array(16);function wo(){if(!hr){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");hr=crypto.getRandomValues.bind(crypto)}return hr(bo)}const No=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Wi={randomUUID:No};function Ls(d,e,t){if(Wi.randomUUID&&!d)return Wi.randomUUID();d=d||{};const n=d.random??d.rng?.()??wo();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,To(n)}class Xe{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class Hi{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.raw,t}}class Rr{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){const n=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(r,i)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((o,c,u)=>(o[this.expressionMap.extraReturningColumns[u].databaseName]=c[0],o),{}));const s=Array.isArray(e.raw)?e.raw[i]:e.raw,a=this.queryRunner.connection.driver.createGeneratedMap(n,s);a&&(this.queryRunner.manager.merge(n.target,r,a),e.generatedMaps.push(a))}else{const s=this.expressionMap.extraReturningColumns;if(s.length>0){const a=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!a)throw new M("Cannot update entity because entity id is not set in the entity.");const o=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(c=>n.targetName+"."+c.propertyPath)).addSelect(s.map(c=>n.targetName+"."+c.propertyPath)).from(n.target,n.targetName).where(a).withDeleted().setOption("create-pojo").getOne();o&&(this.queryRunner.manager.merge(n.target,r,o),e.generatedMaps.push(o))}}}))}async insert(e,t){const n=this.expressionMap.mainAlias.metadata;let r=n.getInsertionReturningColumns();const i=this.queryRunner.connection.driver.isReturningSqlSupported("insert");r=r.filter(a=>a.isGenerated?i===!0:!0);const s=t.map((a,o)=>{Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(this.queryRunner.connection.driver.options.type==="oracle"?e.raw=e.raw.reduce((l,h,f)=>(l[this.expressionMap.extraReturningColumns[f].databaseName]=h[0],l),{}):this.queryRunner.connection.driver.options.type==="spanner"&&(e.raw=e.raw[0]));const c=Array.isArray(e.raw)?e.raw[o]:e.raw,u=this.queryRunner.connection.driver.createGeneratedMap(n,c,o,t.length)||{};return o in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(n.target,u,this.expressionMap.locallyGenerated[o]),this.queryRunner.manager.merge(n.target,a,u),u});if(r.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const a=t.map(c=>{const u=n.getEntityIdMap(c);if(!u)throw new M("Cannot update entity because entity id is not set in the entity.");return u}),o=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(c=>n.targetName+"."+c.propertyPath)).addSelect(r.map(c=>n.targetName+"."+c.propertyPath)).from(n.target,n.targetName).where(a).setOption("create-pojo").getMany();t.forEach((c,u)=>{this.queryRunner.manager.merge(n.target,s[u],o[u]),this.queryRunner.manager.merge(n.target,c,o[u])})}t.forEach((a,o)=>{const c=n.getEntityIdMap(a);e.identifiers.push(c),e.generatedMaps.push(s[o])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class Ao extends Le{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new Hi;const t=this.obtainQueryRunner();let n=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const E=new Xe;e.forEach(b=>{t.broadcaster.broadcastBeforeInsertEvent(E,this.expressionMap.mainAlias.metadata,b)}),await E.wait()}let r=null,i=null;const s=new Rr(t,this.expressionMap),a=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const E of this.expressionMap.returning)a.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(E));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),a.push(...this.expressionMap.extraReturningColumns.filter(E=>!a.includes(E)))),a.length>0&&this.connection.driver.options.type==="mssql"&&(r=this.connection.driver.buildTableVariableDeclaration("@OutputTable",a),i="SELECT * FROM @OutputTable");const[o,c]=this.getQueryAndParameters(),l=[r,o,i].filter(E=>E!=null).join(`;

`),h=await t.query(l,c,!0),f=Hi.from(h);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.insert(f,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const E=new Xe;e.forEach(b=>{t.broadcaster.broadcastAfterInsertEvent(E,this.expressionMap.mainAlias.metadata,b)}),await E.wait()}return n&&await t.commitTransaction(),f}catch(r){if(n)try{await t.rollbackTransaction()}catch{}throw r}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=q.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e);return this.expressionMap.setMainAlias(n),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new Jt;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,n){const{where:r,parameters:i}=n?.overwriteCondition??{};let s;if(r){const a=this.getWhereCondition(r);(Array.isArray(a)?a.length!==0:a)&&(s=[{type:"simple",condition:a}])}return i&&this.setParameters(i),Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:n?.skipUpdateIfNoValuesChanged,indexPredicate:n?.indexPredicate,upsertType:n?.upsertType,overwriteCondition:s},this):(this.expressionMap.onUpdate={conflict:e?.conflict_target,columns:e?.columns,overwrite:e?.overwrite,skipUpdateIfNoValuesChanged:n?.skipUpdateIfNoValuesChanged,upsertType:n?.upsertType,overwriteCondition:s},this)}createInsertExpression(){if((this.expressionMap.onUpdate||this.expressionMap.onIgnore)&&(this.expressionMap.onUpdate?.upsertType??"merge-into")==="merge-into"&&this.connection.driver.supportedUpsertTypes.includes("merge-into"))return this.createMergeExpression();const e=this.getTableName(this.getMainTableName()),t=this.alias!==this.getMainTableName()?this.escape(this.alias):e,n=this.createValuesExpression(),r=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),i=this.createColumnNamesExpression();let s="INSERT ";if(this.expressionMap.onUpdate?.upsertType==="primary-key"&&(s="UPSERT "),(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),s+=`INTO ${e}`,this.alias!==this.getMainTableName()&&J.isPostgresFamily(this.connection.driver)&&(s+=` AS "${this.alias}"`),i?s+=`(${i})`:!n&&(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s+="()"),r&&this.connection.driver.options.type==="mssql"&&(s+=` OUTPUT ${r}`),n?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?s+=` ${n}`:s+=` VALUES ${n}`:J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?s+=" VALUES ()":s+=" DEFAULT VALUES",this.expressionMap.onUpdate?.upsertType!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)s+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)s+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:a,columns:o,conflict:c,skipUpdateIfNoValuesChanged:u,indexPredicate:l}=this.expressionMap.onUpdate;let h="ON CONFLICT";if(Array.isArray(c)){if(h+=` ( ${c.map(E=>this.escape(E)).join(", ")} )`,l&&!J.isPostgresFamily(this.connection.driver))throw new M("indexPredicate option is not supported by the current database driver");l&&J.isPostgresFamily(this.connection.driver)&&(h+=` WHERE ( ${l} )`)}else c&&(h+=` ON CONSTRAINT ${this.escape(c)}`);const f=[];if(Array.isArray(a)?f.push(...a.map(E=>`${this.escape(E)} = EXCLUDED.${this.escape(E)}`)):o&&f.push(...o.map(E=>`${this.escape(E)} = :${E}`)),f.length>0&&(s+=` ${h} DO UPDATE SET `,f.push(...this.expressionMap.mainAlias.metadata.columns.filter(E=>E.isUpdateDate&&!a?.includes(E.databaseName)&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||J.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(E=>`${this.escape(E.databaseName)} = DEFAULT`)),s+=f.join(", ")),Array.isArray(a)&&u){this.expressionMap.onUpdate.overwriteCondition??=[];const E=a.map(b=>({type:"or",condition:`${t}.${this.escape(b)} IS DISTINCT FROM EXCLUDED.${this.escape(b)}`}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:E})}J.isPostgresFamily(this.connection.driver)&&this.expressionMap.onUpdate.overwriteCondition&&this.expressionMap.onUpdate.overwriteCondition.length>0&&(s+=` WHERE ${this.createUpsertConditionExpression()}`)}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:a,columns:o}=this.expressionMap.onUpdate;Array.isArray(a)?(s+=" ON DUPLICATE KEY UPDATE ",s+=a.map(c=>`${this.escape(c)} = VALUES(${this.escape(c)})`).join(", "),s+=" "):Array.isArray(o)&&(s+=" ON DUPLICATE KEY UPDATE ",s+=o.map(c=>`${this.escape(c)} = :${c}`).join(", "),s+=" ")}}else if(this.expressionMap.onUpdate)throw new M("onUpdate is not supported by the current database driver")}return r&&(J.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||J.isMySQLFamily(this.connection.driver))&&(s+=` RETURNING ${r}`),r&&this.connection.driver.options.type==="spanner"&&(s+=` THEN RETURN ${r}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(a=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(a.propertyPath)!==-1:a.isInsert).some(a=>this.isOverridingAutoIncrementBehavior(a))&&(s=`SET IDENTITY_INSERT ${e} ON; ${s}; SET IDENTITY_INSERT ${e} OFF`),s}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!J.isSQLiteFamily(this.connection.driver)&&!J.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(n=>this.escape(n)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){const e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let n="";return e.forEach((r,i)=>{t.forEach((s,a)=>{a===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?n+=" SELECT ":n+="("),n+=this.createColumnValueExpression(e,i,s),a===t.length-1?i===e.length-1?["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?n+=" FROM "+this.connection.driver.dummyTableName:n+=")":["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?n+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":n+="), ":n+=", "})}),n==="()"?"":n}else{let n="";return e.forEach((r,i)=>{Object.keys(r).forEach((a,o)=>{o===0&&(n+="(");const c=r[a];typeof c=="function"?n+=c():c===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||J.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n+="NULL":n+="DEFAULT":c===null&&this.connection.driver.options.type==="spanner"||(n+=this.createParameter(c)),o===Object.keys(r).length-1?i===e.length-1?n+=")":n+="), ":n+=", "})}),n==="()"?"":n}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(me.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new ha}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}createMergeExpression(){if(!this.connection.driver.supportedUpsertTypes.includes("merge-into"))throw new M('Upsert type "merge-into" is not supported by current database driver');if(this.expressionMap.onUpdate?.upsertType&&this.expressionMap.onUpdate.upsertType!=="merge-into")throw new M(`Upsert type "${this.expressionMap.onUpdate.upsertType}" is not supported by current database driver`);const e=this.getTableName(this.getMainTableName()),t=this.escape(this.alias),n=this.getInsertedColumns(),r=this.createColumnNamesExpression();let i=`MERGE INTO ${e} ${this.escape(this.alias)}`;const s=this.escape("mergeIntoSource"),a=this.createMergeIntoSourceExpression(s);if(i+=` ${a}`,this.expressionMap.onIgnore){const u=n.find(l=>l.isPrimary);u?i+=` ON (${t}.${this.escape(u.databaseName)} = ${s}.${this.escape(u.databaseName)})`:i+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(l=>`(${l.columns.map(h=>`${t}.${this.escape(h.databaseName)} = ${s}.${this.escape(h.databaseName)}`).join(" AND ")})`).join(" OR ")})`}else if(this.expressionMap.onUpdate){const{conflict:u,indexPredicate:l}=this.expressionMap.onUpdate;if(l)throw new M('indexPredicate option is not supported by upsert type "merge-into"');Array.isArray(u)?i+=` ON (${u.map(h=>`${t}.${this.escape(h)} = ${s}.${this.escape(h)}`).join(" AND ")})`:u?i+=` ON (${t}.${this.escape(u)} = ${s}.${this.escape(u)})`:i+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(h=>`(${h.columns.map(f=>`${t}.${this.escape(f.databaseName)} = ${s}.${this.escape(f.databaseName)}`).join(" AND ")})`).join(" OR ")})`}if(this.expressionMap.onUpdate){const{overwrite:u,columns:l,conflict:h,skipUpdateIfNoValuesChanged:f}=this.expressionMap.onUpdate;let E="";if(Array.isArray(u)&&(E+=(u||l)?.filter(A=>!h?.includes(A)).map(A=>`${t}.${this.escape(A)} = ${s}.${this.escape(A)}`).join(", ")),Array.isArray(u)&&f){this.expressionMap.onUpdate.overwriteCondition??=[];const A=u.map(P=>({type:"or",condition:{operator:"notEqual",parameters:[`${t}.${this.escape(P)}`,`${s}.${this.escape(P)}`]}}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:A})}const b=this.createUpsertConditionExpression();E.trim()&&((this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap")&&b!=""?i+=` WHEN MATCHED AND ${b} THEN UPDATE SET ${E}`:(i+=` WHEN MATCHED THEN UPDATE SET ${E}`,b!=""&&(i+=` WHERE ${b}`)))}const o=this.createMergeIntoInsertValuesExpression(s),c=this.connection.driver.options.type==="mssql"?this.createReturningExpression("insert"):null;return i+=" WHEN NOT MATCHED THEN INSERT",r&&(i+=`(${r})`),o&&(i+=` VALUES ${o}`),c&&this.connection.driver.options.type==="mssql"&&(i+=` OUTPUT ${c}`),this.connection.driver.options.type==="mssql"&&(i+=";"),i}createMergeIntoSourceExpression(e){const t=this.getValueSets(),n=this.getInsertedColumns();let r="USING (";if(n.length>0)this.connection.driver.options.type==="mssql"&&(r+="VALUES "),t.forEach((i,s)=>{n.forEach((a,o)=>{o===0&&(this.connection.driver.options.type==="mssql"?r+="(":r+="SELECT ");const c=a.getEntityValue(i);c===void 0&&!(a.isGenerated&&a.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported())?a.default!==void 0&&a.default!==null?r+=this.connection.driver.normalizeDefault(a):r+="NULL":c===null?r+="NULL":r+=this.createColumnValueExpression(t,s,a),this.connection.driver.options.type!=="mssql"&&(r+=` AS ${this.escape(a.databaseName)}`),o===n.length-1?s===t.length-1?["oracle","sap"].includes(this.connection.driver.options.type)?r+=" FROM "+this.connection.driver.dummyTableName:this.connection.driver.options.type==="mssql"&&(r+=")"):["oracle","sap"].includes(this.connection.driver.options.type)&&t.length>1?r+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":this.connection.driver.options.type==="mssql"?r+="), ":r+=" UNION ALL ":r+=", "})});else throw new M('Upsert type "merge-into" is not supported without metadata tables');return r+=`) ${e}`,this.connection.driver.options.type==="mssql"&&(r+=` (${n.map(i=>this.escape(i.databaseName)).join(", ")})`),r}createMergeIntoInsertValuesExpression(e){const t=this.getInsertedColumns();let n="";if(t.length>0)t.forEach((r,i)=>{i===0&&(n+="("),r.isGenerated&&r.generationStrategy==="uuid"&&this.connection.driver.isUUIDGenerationSupported()||r.isGenerated&&r.generationStrategy!=="uuid"?n+="DEFAULT":n+=`${e}.${this.escape(r.databaseName)}`,i===t.length-1?n+=")":n+=", "});else throw new M('Upsert type "merge-into" is not supported without metadata tables');return n==="()"?"":n}createUpsertConditionExpression(){if(!this.expressionMap.onUpdate.overwriteCondition)return"";const e=[],t=this.createWhereClausesExpression(this.expressionMap.onUpdate.overwriteCondition);if(t.length>0&&t!=="1=1"&&e.push(t),this.expressionMap.mainAlias.hasMetadata){const r=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&r.deleteDateColumn){const s=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+r.deleteDateColumn.propertyName:r.deleteDateColumn.propertyName} IS NULL`;e.push(s)}if(r.discriminatorColumn&&r.parentEntityMetadata){const s=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+r.discriminatorColumn.databaseName:r.discriminatorColumn.databaseName} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){const r=this.expressionMap.extraAppendedAndWhereCondition;e.push(r)}let n="";return e.length?e.length===1?n+=`${e[0]}`:n+=`( ${e.join(" ) AND ( ")} )`:n+="",n}createColumnValueExpression(e,t,n){const r=e[t];let i="",s=n.getEntityValue(r);if(typeof s!="function"&&(s=this.connection.driver.preparePersistentValue(s,n)),n.isVersion&&s===void 0)i+="1";else if(n.isDiscriminator)i+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(n.isGenerated&&n.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&s===void 0)s=Ls(),i+=this.createParameter(s),t in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[t]={}),n.setEntityValue(this.expressionMap.locallyGenerated[t],s);else if(s===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||J.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n.default!==void 0&&n.default!==null?i+=this.connection.driver.normalizeDefault(n):this.connection.driver.options.type==="spanner"&&n.isGenerated&&n.generationStrategy==="uuid"?i+="GENERATE_UUID()":i+="NULL":i+="DEFAULT";else if(s===null&&(this.connection.driver.options.type==="spanner"||this.connection.driver.options.type==="oracle"))i+="NULL";else if(typeof s=="function")i+=s();else{this.connection.driver.options.type==="mssql"&&(s=this.connection.driver.parametrizeValue(n,s));const a=this.createParameter(s);if((J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.includes(n.type)){const c=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";n.srid!=null?i+=`${c}(${a}, ${n.srid})`:i+=`${c}(${a})`}else J.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.includes(n.type)?n.srid!=null?i+=`ST_SetSRID(ST_GeomFromGeoJSON(${a}), ${n.srid})::${n.type}`:i+=`ST_GeomFromGeoJSON(${a})::${n.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.includes(n.type)?i+=n.type+"::STGeomFromText("+a+", "+(n.srid||"0")+")":i+=a}return i}}class Gi{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){const t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){const n=t.joinColumns.reduce((r,i)=>{const s=me.isObject(e)?i.referencedColumn.getEntityValue(e):e;return i.setEntityValue(r,s),r},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(n).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){const n={};t.inverseRelation.joinColumns.forEach(o=>{n[o.propertyName]=null});const r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i={},s=[];r.forEach((o,c)=>{t.inverseRelation.joinColumns.map((u,l)=>{const h="joinColumn_"+c+"_"+l;i[h]=me.isObject(o)?u.referencedColumn.getEntityValue(o):o,s.push(`${u.propertyPath} = :${h}`)})});const a=s.map(o=>"("+o+")").join(" OR ");if(!a)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).where(a).setParameters(i).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new M("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const n=this.expressionMap.of,r=t.inverseRelation.joinColumns.reduce((i,s)=>{const a=me.isObject(n)?s.referencedColumn.getEntityValue(n):n;return s.setEntityValue(i,a),i},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(r).whereInIds(e).execute()}else{const n=t.junctionEntityMetadata,r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],s=t.isManyToManyOwner?r:i,a=t.isManyToManyOwner?i:r,o=[];if(s.forEach(c=>{a.forEach(u=>{const l={};n.ownerColumns.forEach(h=>{l[h.databaseName]=me.isObject(c)?h.referencedColumn.getEntityValue(c):c}),n.inverseColumns.forEach(h=>{l[h.databaseName]=me.isObject(u)?h.referencedColumn.getEntityValue(u):u}),o.push(l)})}),!o.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(o.map(c=>this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(c).execute())):await this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(o).execute()}}}class Co{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){const t=this.expressionMap.relationMetadata;if(t.isOneToMany){const n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],r=Array.isArray(e)?e:[e],i={};t.inverseRelation.joinColumns.forEach(c=>{i[c.propertyName]=null});const s={},a=[];n.forEach((c,u)=>{a.push(...r.map((l,h)=>[...t.inverseRelation.joinColumns.map((f,E)=>{const b="joinColumn_"+u+"_"+h+"_"+E;return s[b]=me.isObject(c)?f.referencedColumn.getEntityValue(c):c,`${f.propertyPath} = :${b}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((f,E)=>{const b="primaryColumn_"+h+"_"+h+"_"+E;return s[b]=me.isObject(l)?f.getEntityValue(l):l,`${f.propertyPath} = :${b}`})].join(" AND ")))});const o=a.map(c=>"("+c+")").join(" OR ");if(!o)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).where(o).setParameters(s).execute()}else{const n=t.junctionEntityMetadata,r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],s=t.isManyToManyOwner?r:i,a=t.isManyToManyOwner?i:r,o={},c=[];s.forEach((l,h)=>{c.push(...a.map((f,E)=>[...n.ownerColumns.map((b,A)=>{const P="firstValue_"+h+"_"+E+"_"+A;return o[P]=me.isObject(l)?b.referencedColumn.getEntityValue(l):l,`${b.databaseName} = :${P}`}),...n.inverseColumns.map((b,A)=>{const P="secondValue_"+h+"_"+E+"_"+A;return o[P]=me.isObject(f)?b.referencedColumn.getEntityValue(f):f,`${b.databaseName} = :${P}`})].join(" AND ")))});const u=c.map(l=>"("+l+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(n.tableName).where(u).setParameters(o).execute()}}}class So extends Le{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new M("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new M(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!me.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new M('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Gi(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new M("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new M(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!me.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new M('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Gi(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new M("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new M(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new Co(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!me.isObject(e)){const t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new M("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class K{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(n,r)=>e.slice(r*t,r*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((n,r)=>{const i=t(r);let s=n.find(a=>a.id===i);return s||(s={id:i,items:[]},n.push(s)),s.items.push(r),n},[])}static uniq(e,t){return e.reduce((n,r)=>{let i=!1;if(typeof t=="function"){const s=t(r);i=!!n.find(a=>t(a)===s)}else typeof t=="string"?i=!!n.find(s=>s[t]===r[t]):i=n.indexOf(r)!==-1;return i||n.push(r),n},[])}static mergeDeep(e,...t){if(!t.length)return e;for(const n of t)K.merge(e,n);return e}static cloneObject(e){return e==null?e:Object.assign(Object.create(Object.getPrototypeOf(e)),e)}static deepCompare(...e){let t,n,r,i;if(e.length<1)return!0;for(t=1,n=e.length;t<n;t++)if(r=[],i=[],!K.compare2Objects(r,i,e[0],e[t]))return!1;return!0}static deepValue(e,t){const n=t.split(".");for(let r=0,i=n.length;r<i;r++)e=e[n[r]];return e}static replaceEmptyObjectsWithBooleans(e){for(const t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:K.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){const t={};for(const n of e){const r=n.split(".");if(!r.length)continue;(!t[r[0]]||t[r[0]]===!0)&&(t[r[0]]={});let i=t[r[0]];for(const[s,a]of r.entries())s!==0&&(i[a]?i=i[a]:s===r.length-1?(i[a]={},i=null):(i[a]={},i=i[a]))}return K.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:K.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(n=>t.includes(n))}static areMutuallyExclusive(...e){return!e.some(n=>{const r=e.filter(i=>i!==n);return n.some(i=>r.some(s=>s.includes(i)))})}static parseSqlCheckExpression(e,t){const n=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(n&&n.index){const i=e.substring(n.index+n[0].length);let s="",a="";const o=[];for(let c=0;c<i.length;c++){const u=i[c];switch(u){case",":s==""?(o.push(a),a=""):a+=u;break;case"'":s==u?i[c+1]===u?(a+=u,c+=1):s="":s=u;break;case")":if(s=="")return o.push(a),o;a+=u;break;default:s!=""&&(a+=u)}}}}static isCriteriaNullOrEmpty(e){return e==null||e===""||Array.isArray(e)&&e.length===0||K.isPlainObject(e)&&Object.keys(e).length===0}static isSinglePrimitiveCriteria(e){return typeof e=="string"||typeof e=="number"||e instanceof Date}static isPrimitiveCriteria(e){return Array.isArray(e)?e.every(t=>K.isSinglePrimitiveCriteria(t)):K.isSinglePrimitiveCriteria(e)}static compare2Objects(e,t,n,r){let i;if(Number.isNaN(n)&&Number.isNaN(r)||n===r)return!0;if(n===null||r===null||n===void 0||r===void 0)return!1;if((typeof n.equals=="function"||typeof n.equals=="function")&&n.equals(r))return!0;if(typeof n=="function"&&typeof r=="function"||n instanceof Date&&r instanceof Date||n instanceof RegExp&&r instanceof RegExp||typeof n=="string"&&typeof r=="string"||typeof n=="number"&&typeof r=="number")return n.toString()===r.toString();if(!(typeof n=="object"&&typeof r=="object")||Object.prototype.isPrototypeOf.call(n,r)||Object.prototype.isPrototypeOf.call(r,n)||n.constructor!==r.constructor||n.prototype!==r.prototype||e.indexOf(n)>-1||t.indexOf(r)>-1)return!1;for(i in r){if(r.hasOwnProperty(i)!==n.hasOwnProperty(i))return!1;if(typeof r[i]!=typeof n[i])return!1}for(i in n){if(r.hasOwnProperty(i)!==n.hasOwnProperty(i))return!1;if(typeof r[i]!=typeof n[i])return!1;switch(typeof n[i]){case"object":case"function":if(e.push(n),t.push(r),!K.compare2Objects(e,t,n[i],r[i]))return!1;e.pop(),t.pop();break;default:if(n[i]!==r[i])return!1;break}}return!0}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,n,r){if(r.has(n)){e[t]=r.get(n);return}if(!(n instanceof Promise)){if(!K.isPlainObject(n)&&!Array.isArray(n)){e[t]=n;return}e[t]||(e[t]=Array.isArray(n)?[]:{}),r.set(n,e[t]),K.merge(e[t],n,r),r.delete(n)}}static mergeObjectKey(e,t,n,r){if(r.has(n)){Object.assign(e,{[t]:r.get(n)});return}if(!(n instanceof Promise)){if(!K.isPlainObject(n)&&!Array.isArray(n)){Object.assign(e,{[t]:n});return}e[t]||Object.assign(e,{[t]:Array.isArray(n)?[]:{}}),r.set(n,e[t]),K.merge(e[t],n,r),r.delete(n)}}static merge(e,t,n=new Map){if(K.isPlainObject(e)&&K.isPlainObject(t))for(const[r,i]of Object.entries(t))r!=="__proto__"&&K.mergeObjectKey(e,r,i,n);if(Array.isArray(e)&&Array.isArray(t))for(let r=0;r<t.length;r++)K.mergeArrayKey(e,r,t[r],n)}}class Ro{constructor(e,t,n,r,i){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=n,this.rawRelationCountResults=r,this.queryRunner=i,this.pojo=this.expressionMap.options.includes("create-pojo"),this.selections=new Set(this.expressionMap.selects.map(s=>s.selection)),this.aliasCache=new Map,this.columnsCache=new Map}transform(e,t){const n=this.group(e,t),r=[];for(const i of n.values()){const s=this.transformRawResultsGroup(i,t);s!==void 0&&r.push(s)}return r}buildAlias(e,t){let n=this.aliasCache.get(e);n||(n=new Map,this.aliasCache.set(e,n));let r=n.get(t);return r||(r=J.buildAlias(this.driver,void 0,e,t),n.set(t,r)),r}group(e,t){const n=new Map,r=[];t.metadata.tableType==="view"?r.push(...t.metadata.columns.map(i=>this.buildAlias(t.name,i.databaseName))):r.push(...t.metadata.primaryColumns.map(i=>this.buildAlias(t.name,i.databaseName)));for(const i of e){const s=r.map(o=>{const c=i[o];return Buffer.isBuffer(c)?c.toString("hex"):me.isObject(c)?JSON.stringify(c):c}).join("_"),a=n.get(s);a?a.push(i):n.set(s,[i])}return n}transformRawResultsGroup(e,t){let n=t.metadata;if(n.discriminatorColumn){const u=e.map(h=>h[this.buildAlias(t.name,t.metadata.discriminatorColumn.databaseName)]),l=n.childEntityMetadatas.find(h=>typeof u.find(f=>f===h.discriminatorValue)<"u");l&&(n=l)}const r=n.create(this.queryRunner,{fromDeserializer:!0,pojo:this.pojo}),i=this.transformColumns(e,t,r,n),s=this.transformJoins(e,r,t,n),a=this.transformRelationIds(e,t,r,n),o=this.transformRelationCounts(e,t,r);if(i||n.primaryColumns.every(u=>u.isVirtual===!0)&&(s||a||o))return r}transformColumns(e,t,n,r){let i=!1;const s=e[0];for(const[a,o]of this.getColumnsToProcess(t.name,r)){const c=s[a];c!==void 0&&(c!==null&&!o.isVirtualProperty&&(i=!0),o.setEntityValue(n,this.driver.prepareHydratedValue(c,o)))}return i}transformJoins(e,t,n,r){let i=!1;for(const s of this.expressionMap.joinAttributes){if(!s.metadata||!s.isSelected||s.relation&&!r.relations.find(o=>o===s.relation))continue;if(s.mapToProperty){if(s.mapToPropertyParentAlias!==n.name)continue}else if(!s.relation||s.parentAlias!==n.name||s.relationPropertyPath!==s.relation.propertyPath)continue;let a=this.transform(e,s.alias);a=s.isMany?a:a[0],a=!s.isMany&&a===void 0?null:a,a!==void 0&&(s.mapToPropertyPropertyName?t[s.mapToPropertyPropertyName]=a:s.relation.setEntityValue(t,a),i=!0)}return i}transformRelationIds(e,t,n,r){let i=!1;for(const[s,a]of this.rawRelationIdResults.entries()){if(a.relationIdAttribute.parentAlias!==t.name)continue;const o=a.relationIdAttribute.relation,c=this.createValueMapFromJoinColumns(o,a.relationIdAttribute.parentAlias,e);if(c==null)continue;this.prepareDataForTransformRelationIds();const u=this.hashEntityIds(o,c),l=this.relationIdMaps[s][u]||[],h=a.relationIdAttribute.mapToPropertyPropertyPath.split("."),f=(E,b,A)=>{const P=E.shift();if(P&&E.length===0)return b[P]=A,b;if(P&&E.length>0)f(E,b[P],A);else return b};o.isOneToOne||o.isManyToOne?l[0]!==void 0&&(f(h,n,l[0]),i=!0):(f(h,n,l),i=i||l.length>0)}return i}transformRelationCounts(e,t,n){let r=!1;for(const i of this.rawRelationCountResults){if(i.relationCountAttribute.parentAlias!==t.name)continue;const s=i.relationCountAttribute.relation;let a;s.isOneToMany?a=s.inverseRelation.joinColumns[0].referencedColumn.databaseName:a=s.isOwning?s.joinColumns[0].referencedColumn.databaseName:s.inverseRelation.joinColumns[0].referencedColumn.databaseName;const o=e[0][this.buildAlias(t.name,a)];if(o!=null){n[i.relationCountAttribute.mapToPropertyPropertyName]=0;for(const c of i.results)c.parentId===o&&(n[i.relationCountAttribute.mapToPropertyPropertyName]=parseInt(c.cnt),r=!0)}}return r}getColumnsToProcess(e,t){let n=this.columnsCache.get(e);n||(n=new Map,this.columnsCache.set(e,n));let r=n.get(t);return r||(r=t.columns.filter(i=>!i.isVirtual&&(this.selections.has(e)||this.selections.has(`${e}.${i.propertyPath}`))&&!t.childEntityMetadatas.some(s=>s.target===i.target)).map(i=>[this.buildAlias(e,i.databaseName),i]),n.set(t,r)),r}createValueMapFromJoinColumns(e,t,n){let r;return e.isManyToOne||e.isOneToOneOwner?r=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?r=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?r=e.joinColumns.map(i=>i):r=e.inverseRelation.inverseJoinColumns.map(i=>i),r.reduce((i,s)=>{for(const a of n)e.isManyToOne||e.isOneToOneOwner?i[s.databaseName]=this.driver.prepareHydratedValue(a[this.buildAlias(t,s.databaseName)],s):i[s.databaseName]=this.driver.prepareHydratedValue(a[this.buildAlias(t,s.referencedColumn.databaseName)],s.referencedColumn);return i},{})}extractEntityPrimaryIds(e,t){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(r=>r):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(r=>r):e.isOwning?n=e.joinColumns.map(r=>r):n=e.inverseRelation.inverseJoinColumns.map(r=>r),n.reduce((r,i)=>(r[i.databaseName]=t[i.databaseName],r),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const t=e.relationIdAttribute.relation;let n;return t.isManyToOne||t.isOneToOneOwner?n=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?n=t.inverseEntityMetadata.primaryColumns:t.isOwning?n=t.inverseJoinColumns:n=t.inverseRelation.joinColumns,e.results.reduce((r,i)=>{let s=n.reduce((a,o)=>{let c=i[o.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(o.isVirtual&&o.referencedColumn&&o.referencedColumn.propertyName!==o.propertyName&&(c=o.referencedColumn.createValueMap(c)),K.mergeDeep(a,o.createValueMap(c))):(!o.isPrimary&&o.referencedColumn.referencedColumn&&(c=o.referencedColumn.referencedColumn.createValueMap(c)),K.mergeDeep(a,o.referencedColumn.createValueMap(c)))},{});if(n.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?s=n[0].getEntityValue(s):s=n[0].referencedColumn.getEntityValue(s)),s!==void 0){const a=this.hashEntityIds(t,i);r[a]?r[a].push(s):r[a]=[s]}return r},{})}))}hashEntityIds(e,t){const n=this.extractEntityPrimaryIds(e,t);return JSON.stringify(n)}}let xo=class{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationIdAttributes=n}async load(e){const t=this.relationIdAttributes.map(async n=>{if(n.relation.isManyToOne||n.relation.isOneToOneOwner){if(n.queryBuilderFactory)throw new M("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const r={},i=e.map(s=>{const a={},o=[];n.relation.joinColumns.forEach(u=>{a[u.databaseName]=this.connection.driver.prepareHydratedValue(s[J.buildAlias(this.connection.driver,void 0,n.parentAlias,u.databaseName)],u.referencedColumn);const l=`${u.databaseName}:${a[u.databaseName]}`;o.indexOf(l)===-1&&o.push(l)}),n.relation.entityMetadata.primaryColumns.forEach(u=>{a[u.databaseName]=this.connection.driver.prepareHydratedValue(s[J.buildAlias(this.connection.driver,void 0,n.parentAlias,u.databaseName)],u);const l=`${u.databaseName}:${a[u.databaseName]}`;o.indexOf(l)===-1&&o.push(l)}),o.sort();const c=o.join("::");return r[c]?null:(r[c]=!0,a)}).filter(s=>s);return{relationIdAttribute:n,results:i}}else if(n.relation.isOneToMany||n.relation.isOneToOneNotOwner){const r=n.relation,i=r.isOwning?r.joinColumns:r.inverseRelation.joinColumns,s=r.inverseEntityMetadata.target,a=r.inverseEntityMetadata.tableName,o=n.alias||a,c={},u={},l=e.map((b,A)=>{const P=[],D={},I=i.map(G=>{const ie=G.databaseName+A,ne=b[J.buildAlias(this.connection.driver,void 0,n.parentAlias,G.referencedColumn.databaseName)],pe=`${o}:${G.propertyPath}:${ne}`;return P.indexOf(pe)!==-1?"":(P.push(pe),D[ie]=ne,o+"."+G.propertyPath+" = :"+ie)}).filter(G=>G).join(" AND ");P.sort();const W=P.join("::");return c[W]?"":(c[W]=!0,Object.assign(u,D),I)}).filter(b=>b).map(b=>"("+b+")").join(" OR ");if(!l)return{relationIdAttribute:n,results:[]};const h=this.connection.createQueryBuilder(this.queryRunner);K.uniq([...i,...r.inverseRelation.entityMetadata.primaryColumns],b=>b.propertyPath).forEach(b=>{h.addSelect(o+"."+b.propertyPath,b.databaseName)}),h.from(s,o).where("("+l+")").setParameters(u),n.queryBuilderFactory&&n.queryBuilderFactory(h);const E=await h.getRawMany();return E.forEach(b=>{i.forEach(A=>{b[A.databaseName]=this.connection.driver.prepareHydratedValue(b[A.databaseName],A.referencedColumn)}),r.inverseRelation.entityMetadata.primaryColumns.forEach(A=>{b[A.databaseName]=this.connection.driver.prepareHydratedValue(b[A.databaseName],A)})}),{relationIdAttribute:n,results:E}}else{const r=n.relation,i=r.isOwning?r.joinColumns:r.inverseRelation.inverseJoinColumns,s=r.isOwning?r.inverseJoinColumns:r.inverseRelation.joinColumns,a=n.junctionAlias,o=n.joinInverseSideMetadata.tableName,c=n.alias||o,u=r.isOwning?r.junctionEntityMetadata.tableName:r.inverseRelation.junctionEntityMetadata.tableName,l=e.map(I=>i.reduce((W,G)=>(W[G.propertyPath]=I[J.buildAlias(this.connection.driver,void 0,n.parentAlias,G.referencedColumn.databaseName)],W),{}));if(l.length===0)return{relationIdAttribute:n,results:[]};const h={},f={},E=l.map((I,W)=>{const G=[],ie={},ne=Object.keys(I).map(F=>{const se=F+W,v=I[F],Y=`${a}:${F}:${v}`;return G.indexOf(Y)!==-1?"":(G.push(Y),ie[se]=v,a+"."+F+" = :"+se)}).filter(F=>F).join(" AND ");G.sort();const pe=G.join("::");return f[pe]?"":(f[pe]=!0,Object.assign(h,ie),ne)}).filter(I=>I),b=s.map(I=>a+"."+I.propertyPath+" = "+c+"."+I.referencedColumn.propertyPath).join(" AND "),A=E.map(I=>"("+I+" AND "+b+")").join(" OR "),P=this.connection.createQueryBuilder(this.queryRunner);s.forEach(I=>{P.addSelect(a+"."+I.propertyPath,I.databaseName).addOrderBy(a+"."+I.propertyPath)}),i.forEach(I=>{P.addSelect(a+"."+I.propertyPath,I.databaseName).addOrderBy(a+"."+I.propertyPath)}),P.from(o,c).innerJoin(u,a,A).setParameters(h),n.queryBuilderFactory&&n.queryBuilderFactory(P);const D=await P.getRawMany();return D.forEach(I=>{[...i,...s].forEach(W=>{I[W.databaseName]=this.connection.driver.prepareHydratedValue(I[W.databaseName],W.referencedColumn)})}),{relationIdAttribute:n,results:D}}});return Promise.all(t)}};class Bs{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,n){const r=Array.isArray(t)?t:[t],i=Array.isArray(n)?n:n?[n]:void 0;return e.isManyToMany?this.loadForManyToMany(e,r,i):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,r,i):this.loadForOneToManyAndOneToOneNotOwner(e,r,i)}async loadManyToManyRelationIdsAndGroup(e,t,n,r){const i=e.isManyToMany||e.isOneToMany,s=Array.isArray(t)?t:[t];if(!n&&(n=await this.connection.relationLoader.load(e,t,this.queryRunner,r),!n.length))return s.map(l=>({entity:l,related:i?[]:void 0}));const a=await this.load(e,t,n),o=Array.isArray(n)?n:[n];let c=[],u=[];return e.isManyToManyOwner?(c=e.junctionEntityMetadata.inverseColumns.map(l=>l.referencedColumn),u=e.junctionEntityMetadata.ownerColumns.map(l=>l.referencedColumn)):e.isManyToManyNotOwner?(c=e.junctionEntityMetadata.ownerColumns.map(l=>l.referencedColumn),u=e.junctionEntityMetadata.inverseColumns.map(l=>l.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(c=e.joinColumns.map(l=>l.referencedColumn),u=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(c=e.inverseRelation.entityMetadata.primaryColumns,u=e.inverseRelation.joinColumns.map(l=>l.referencedColumn)),s.map(l=>{const h={entity:l,related:i?[]:void 0},f=a.filter(E=>u.every(b=>b.compareEntityValue(l,E[b.entityMetadata.name+"_"+b.propertyAliasName])));return f.length&&o.forEach(E=>{f.forEach(b=>{c.every(P=>P.compareEntityValue(E,b[J.buildAlias(this.connection.driver,void 0,P.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+P.propertyPath.replace(".","_"))]))&&(i?h.related.push(E):h.related=E)})}),h})}loadForManyToMany(e,t,n){const r=e.junctionEntityMetadata,i=r.name,s=e.isOwning?r.ownerColumns:r.inverseColumns,a=e.isOwning?r.inverseColumns:r.ownerColumns,o=this.connection.createQueryBuilder(this.queryRunner);s.forEach(h=>{const f=J.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+h.referencedColumn.propertyPath.replace(".","_"));o.addSelect(i+"."+h.propertyPath,f)}),a.forEach(h=>{const f=J.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_"));o.addSelect(i+"."+h.propertyPath,f)});let c="";if(s.length===1){const h=t.map(E=>s[0].referencedColumn.getEntityValue(E));h.every(E=>typeof E=="number")?c=`${i}.${s[0].propertyPath} IN (${h.join(", ")})`:(o.setParameter("values1",h),c=i+"."+s[0].propertyPath+" IN (:...values1)")}else c="("+t.map((h,f)=>s.map(E=>{const b="entity1_"+f+"_"+E.propertyName;return o.setParameter(b,E.referencedColumn.getEntityValue(h)),i+"."+E.propertyPath+" = :"+b}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";let u="";if(n)if(a.length===1){const h=n.map(E=>a[0].referencedColumn.getEntityValue(E));h.every(E=>typeof E=="number")?u=`${i}.${a[0].propertyPath} IN (${h.join(", ")})`:(o.setParameter("values2",h),u=i+"."+a[0].propertyPath+" IN (:...values2)")}else u="("+n.map((h,f)=>a.map(E=>{const b="entity2_"+f+"_"+E.propertyName;return o.setParameter(b,E.referencedColumn.getEntityValue(h)),i+"."+E.propertyPath+" = :"+b}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";const l=[c,u].filter(h=>h.length>0).join(" AND ");return o.from(r.target,i).where(l).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,n){const r=e.entityMetadata.targetName,i=e.joinColumns.every(o=>!!e.entityMetadata.nonVirtualColumns.find(c=>c===o));if(n&&i){const o=[];if(t.forEach(c=>{const u={};e.entityMetadata.primaryColumns.forEach(l=>{const h=l.entityMetadata.name+"_"+l.propertyPath.replace(".","_");u[h]=l.getEntityValue(c)}),n.forEach(l=>{e.joinColumns.forEach(h=>{const f=h.getEntityValue(c),E=h.referencedColumn.getEntityValue(l);if(!(f===void 0||E===void 0)&&f===E){const b=h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_");u[b]=E}})}),Object.keys(u).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&o.push(u)}),o.length===t.length)return Promise.resolve(o)}const s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(o=>{const c=J.buildAlias(this.connection.driver,void 0,o.entityMetadata.name+"_"+o.propertyPath.replace(".","_"));s.addSelect(r+"."+o.propertyPath,c)}),e.joinColumns.forEach(o=>{const c=J.buildAlias(this.connection.driver,void 0,o.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+o.referencedColumn.propertyPath.replace(".","_"));s.addSelect(r+"."+o.propertyPath,c)});let a="";if(e.entityMetadata.primaryColumns.length===1){const o=t.map(u=>e.entityMetadata.primaryColumns[0].getEntityValue(u));o.every(u=>typeof u=="number")?a=`${r}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${o.join(", ")})`:(s.setParameter("values",o),a=r+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else a=t.map((o,c)=>e.entityMetadata.primaryColumns.map((u,l)=>{const h="entity"+c+"_"+l;return s.setParameter(h,u.getEntityValue(o)),r+"."+u.propertyPath+" = :"+h}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return s.from(e.entityMetadata.target,r).where(a).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,n){const r=e;if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(c=>e.joinColumns.indexOf(c)!==-1))return Promise.resolve(t.map(c=>{const u={};return e.joinColumns.forEach(function(l){const h=l.referencedColumn.getEntityValue(c),f=l.referencedColumn.entityMetadata.name+"_"+l.referencedColumn.propertyPath.replace(".","_"),E=l.entityMetadata.name+"_"+r.propertyPath.replace(".","_")+"_"+l.propertyPath.replace(".","_");u[f]=h,u[E]=h}),u}));const i=e.entityMetadata.targetName,s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(o=>{const c=J.buildAlias(this.connection.driver,void 0,o.entityMetadata.name+"_"+r.propertyPath.replace(".","_")+"_"+o.propertyPath.replace(".","_"));s.addSelect(i+"."+o.propertyPath,c)}),e.joinColumns.forEach(o=>{const c=J.buildAlias(this.connection.driver,void 0,o.referencedColumn.entityMetadata.name+"_"+o.referencedColumn.propertyPath.replace(".","_"));s.addSelect(i+"."+o.propertyPath,c)});let a="";if(e.joinColumns.length===1){const o=t.map(u=>e.joinColumns[0].referencedColumn.getEntityValue(u));o.every(u=>typeof u=="number")?a=`${i}.${e.joinColumns[0].propertyPath} IN (${o.join(", ")})`:(s.setParameter("values",o),a=i+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else a=t.map((o,c)=>e.joinColumns.map((u,l)=>{const h="entity"+c+"_"+l;return s.setParameter(h,u.referencedColumn.getEntityValue(o)),i+"."+u.propertyPath+" = :"+h}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return s.from(e.entityMetadata.target,i).where(a).getRawMany()}}class Mo{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(n)})})}metadataToAttribute(e,t){return new Ar(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class vo{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationCountAttributes=n}async load(e){const t=(r,i,s)=>s.indexOf(r)===i,n=this.relationCountAttributes.map(async r=>{if(r.relation.isOneToMany){const i=r.relation,s=i.inverseRelation,a=s.joinColumns[0].referencedColumn.propertyName,o=i.inverseEntityMetadata.target,c=i.inverseEntityMetadata.tableName,u=r.alias||c,l=s.propertyName;let h=e.map(E=>E[r.parentAlias+"_"+a]).filter(E=>!!E);if(h=h.filter(t),h.length===0)return{relationCountAttribute:r,results:[]};const f=this.connection.createQueryBuilder(this.queryRunner);return f.select(u+"."+l,"parentId").addSelect("COUNT(*)","cnt").from(o,u).where(u+"."+l+" IN (:...ids)").addGroupBy(u+"."+l).setParameter("ids",h),r.queryBuilderFactory&&r.queryBuilderFactory(f),{relationCountAttribute:r,results:await f.getRawMany()}}else{let i,s,a,o;r.relation.isOwning?(i=r.relation.joinColumns[0].referencedColumn.databaseName,s=r.relation.inverseJoinColumns[0].referencedColumn.databaseName,a=r.relation.junctionEntityMetadata.columns[0],o=r.relation.junctionEntityMetadata.columns[1]):(i=r.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,s=r.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,a=r.relation.junctionEntityMetadata.columns[1],o=r.relation.junctionEntityMetadata.columns[0]);let c=e.map(A=>A[r.parentAlias+"_"+i]).filter(A=>!!A);if(c=c.filter(t),c.length===0)return{relationCountAttribute:r,results:[]};const u=r.junctionAlias,l=r.joinInverseSideMetadata.tableName,h=r.alias||l,f=r.relation.junctionEntityMetadata.tableName,E=u+"."+a.propertyName+" IN ("+c.map(A=>isNaN(A)?"'"+A+"'":A)+") AND "+u+"."+o.propertyName+" = "+h+"."+s,b=this.connection.createQueryBuilder(this.queryRunner);return b.select(u+"."+a.propertyName,"parentId").addSelect("COUNT("+b.escape(h)+"."+b.escape(s)+")","cnt").from(l,h).innerJoin(f,u,E).addGroupBy(u+"."+a.propertyName),r.queryBuilderFactory&&r.queryBuilderFactory(b),{relationCountAttribute:r,results:await b.getRawMany()}}});return Promise.all(n)}}class Po{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(n)})})}metadataToAttribute(e,t){return new Cr(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class Ve{static isFindOneOptions(e){const t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){const t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t?.relations){const n=[...t.relations];if(Ve.applyRelationsRecursively(e,n,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),n.length>0)throw new da(n)}return e}static applyRelationsRecursively(e,t,n,r,i){let s=[];if(i){const a=new RegExp("^"+i.replace(".","\\.")+"\\.");s=t.filter(o=>o.match(a)).map(o=>r.findRelationWithPropertyPath(o.replace(a,""))).filter(o=>o)}else s=t.map(a=>r.findRelationWithPropertyPath(a)).filter(a=>a);s.forEach(a=>{const o=J.buildAlias(e.connection.driver,{joiner:"__"},n,a.propertyPath),c=n+"."+a.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(a):e.leftJoinAndSelect(c,o),t.splice(t.indexOf(i?i+"."+a.propertyPath:a.propertyPath),1);let u,l;if(e.expressionMap.relationLoadStrategy==="query")u=a.inverseEntityMetadata,l=o;else{const h=e.expressionMap.joinAttributes.find(f=>f.entityOrProperty===c);u=h.metadata,l=h.alias.name}if(!l||!u)throw new nt(a.propertyPath,r);if(this.applyRelationsRecursively(e,t,l,u,i?i+"."+a.propertyPath:a.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const h=r.relations.find(f=>f.propertyName===a.propertyPath);h&&this.joinEagerRelations(e,o,h.inverseEntityMetadata)}})}static joinEagerRelations(e,t,n){n.eagerRelations.forEach(r=>{let i=J.buildAlias(e.connection.driver,{joiner:"__"},t,r.propertyName),s=!0;for(const c of e.expressionMap.joinAttributes)if(!(c.condition!==void 0||c.mapToProperty!==void 0||c.isMappingMany!==void 0||c.direction!=="LEFT"||c.entityOrProperty!==`${t}.${r.propertyPath}`)){s=!1,i=c.alias.name;break}const a=!!e.expressionMap.joinAttributes.find(c=>c.alias.name===i);s&&!a&&e.leftJoin(t+"."+r.propertyPath,i);let o=!0;for(const c of e.expressionMap.selects)if(!(c.aliasName!==void 0||c.virtual!==void 0||c.selection!==i)){o=!1;break}o&&e.addSelect(i),this.joinEagerRelations(e,i,r.inverseEntityMetadata)})}}class xt extends Le{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(n=>({selection:n}));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(n=>({selection:n})));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}addFrom(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(n),this}innerJoin(e,t,n,r){return this.join("INNER",e,t,n,r),this}leftJoin(e,t,n,r){return this.join("LEFT",e,t,n,r),this}innerJoinAndSelect(e,t,n,r){return this.addSelect(t),this.innerJoin(e,t,n,r),this}leftJoinAndSelect(e,t,n,r){return this.addSelect(t),this.leftJoin(e,t,n,r),this}innerJoinAndMapMany(e,t,n,r,i){return this.addSelect(n),this.join("INNER",t,n,r,i,e,!0),this}innerJoinAndMapOne(e,t,n,r,i,s){return this.addSelect(n),this.join("INNER",t,n,r,i,e,!1,s),this}leftJoinAndMapMany(e,t,n,r,i){return this.addSelect(n),this.join("LEFT",t,n,r,i,e,!0),this}leftJoinAndMapOne(e,t,n,r,i,s){return this.addSelect(n),this.join("LEFT",t,n,r,i,e,!1,s),this}loadRelationIdAndMap(e,t,n,r){const i=new Ar(this.expressionMap);return i.mapToProperty=e,i.relationName=t,typeof n=="string"&&(i.alias=n),typeof n=="object"&&n.disableMixedMap&&(i.disableMixedMap=!0),i.queryBuilderFactory=r,this.expressionMap.relationIdAttributes.push(i),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,n,r){const i=new Cr(this.expressionMap);return i.mapToProperty=e,i.relationName=t,i.alias=n,i.queryBuilderFactory=r,this.expressionMap.relationCountAttributes.push(i),this.expressionMap.createAlias({type:"other",name:i.junctionAlias}),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new M('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new M('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new M('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new M('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new M('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new M('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new M('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new M('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,n){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=n,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new St;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);const n=await this.loadRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const t=(await this.getRawAndEntities()).entities[0];if(t&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const r=n.updateDateColumn.getEntityValue(t);if(r.getTime()!==this.expressionMap.lockVersion.getTime())throw new Dr(n.name,this.expressionMap.lockVersion,r)}else{const r=n.versionColumn.getEntityValue(t);if(r!==this.expressionMap.lockVersion)throw new Dr(n.name,this.expressionMap.lockVersion,r)}}return t===void 0?null:t}async getOneOrFail(){const e=await this.getOne();if(!e)throw new Tr(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new St;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new St;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeCountQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new St;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new St;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;let r=this.lazyCount(n);if(r===void 0){const s=this.expressionMap.cacheId;s&&(this.expressionMap.cacheId=`${s}-count`),r=await this.executeCountQuery(e)}const i=[n.entities,r];return t&&await e.commitTransaction(),i}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}lazyCount(e){const t=this.expressionMap.limit!==void 0&&this.expressionMap.limit!==null;if(this.expressionMap.joinAttributes.length>0&&t)return;const n=this.expressionMap.take!==void 0&&this.expressionMap.take!==null,r=t?this.expressionMap.limit:n?this.expressionMap.take:void 0;if(r!==void 0&&e.entities.length===r)return;const i=this.expressionMap.skip!==void 0&&this.expressionMap.skip!==null&&this.expressionMap.skip>0,s=this.expressionMap.offset!==void 0&&this.expressionMap.offset!==null&&this.expressionMap.offset>0;if(e.entities.length===0&&(i||s))return;const a=s?this.expressionMap.offset:i?this.expressionMap.skip:0;return e.entities.length+a}async stream(){this.expressionMap.queryEntity=!1;const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let r=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),r=!0);const i=()=>{if(n!==this.queryRunner)return n.release()},s=n.stream(e,t,i,i);return r&&await n.commitTransaction(),s}catch(i){if(r)try{await n.rollbackTransaction()}catch{}throw i}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,n,r,i,s,a,o){i&&this.setParameters(i);const c=new _s(this.connection,this.expressionMap);c.direction=e,c.mapAsEntity=o,c.mapToProperty=s,c.isMappingMany=a,c.entityOrProperty=t,c.condition=r,this.expressionMap.joinAttributes.push(c);const u=c.metadata;if(u){if(u.deleteDateColumn&&!this.expressionMap.withDeleted){const l=`${n}.${u.deleteDateColumn.propertyName} IS NULL`;c.condition=c.condition?` ${c.condition} AND ${l}`:`${l}`}c.alias=this.expressionMap.createAlias({type:"join",name:n,metadata:u}),c.relation&&c.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:c.junctionAlias,metadata:c.relation.junctionEntityMetadata})}else{let l="";if(typeof t=="function"){const f=t(this.subQuery());this.setParameters(f.getParameters()),l=f.getQuery()}else l=t;const h=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";c.alias=this.expressionMap.createAlias({type:"join",name:n,tablePath:h===!1?t:void 0,subQuery:h===!0?l:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new M("Cannot build query because main alias is not set (call qb#from method)");const e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){const a=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,a)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,a))}this.expressionMap.joinAttributes.forEach(a=>{if(a.metadata)e.push(...this.buildEscapedEntityColumnSelects(a.alias.name,a.metadata)),t.push(...this.findEntityColumnSelects(a.alias.name,a.metadata));else if(this.expressionMap.selects.some(c=>c.selection===a.alias.name)){e.push({selection:this.escape(a.alias.name)+".*"});const c=this.expressionMap.selects.find(u=>u.selection===a.alias.name);t.push(c)}}),this.expressionMap.selects.filter(a=>t.indexOf(a)===-1).forEach(a=>e.push({selection:this.replacePropertyNames(a.selection),aliasName:a.aliasName})),e.length===0&&e.push({selection:"*"});let n="";this.expressionMap.useIndex&&J.isMySQLFamily(this.connection.driver)&&(n=` USE INDEX (${this.expressionMap.useIndex})`);const r=this.expressionMap.aliases.filter(a=>a.type==="from"&&(a.tablePath||a.subQuery)).map(a=>a.subQuery?a.subQuery+" "+this.escape(a.name):this.getTableName(a.tablePath)+" "+this.escape(a.name)),i=this.createSelectDistinctExpression(),s=e.map(a=>a.selection+(a.aliasName?" AS "+this.escape(a.aliasName):"")).join(", ");return i+s+" FROM "+r.join(", ")+this.createTableLockExpression()+n}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:n}=this.expressionMap,{driver:r}=this.connection;let i="SELECT ";return n>0&&J.isMySQLFamily(r)&&(i+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),J.isPostgresFamily(r)&&t.length>0?i=`SELECT DISTINCT ON (${t.map(a=>this.replacePropertyNames(a)).join(", ")}) `:e&&(i="SELECT DISTINCT "),i}createJoinExpression(){return this.expressionMap.joinAttributes.map(t=>{const n=t.relation,r=t.tablePath,i=t.alias.name;let s=t.condition?" AND ("+t.condition+")":"";const a=t.parentAlias;if(!a||!n){const o=t.alias.subQuery?t.alias.subQuery:this.getTableName(r);return" "+t.direction+" JOIN "+o+" "+this.escape(i)+this.createTableLockExpression()+(t.condition?" ON "+this.replacePropertyNames(t.condition):"")}if(n.isManyToOne||n.isOneToOneOwner){const o=n.joinColumns.map(c=>i+"."+c.referencedColumn.propertyPath+"="+a+"."+n.propertyPath+"."+c.referencedColumn.propertyPath).join(" AND ");return" "+t.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+s)}else if(n.isOneToMany||n.isOneToOneNotOwner){const o=n.inverseRelation.joinColumns.map(c=>(n.inverseEntityMetadata.tableType==="entity-child"&&n.inverseEntityMetadata.discriminatorColumn&&(s+=" AND "+i+"."+n.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+n.inverseEntityMetadata.discriminatorValue+"'"),i+"."+n.inverseRelation.propertyPath+"."+c.referencedColumn.propertyPath+"="+a+"."+c.referencedColumn.propertyPath)).join(" AND ");if(!o)throw new M(`Relation ${n.entityMetadata.name}.${n.propertyName} does not have join columns.`);return" "+t.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+s)}else{const o=n.junctionEntityMetadata.tablePath,c=t.junctionAlias;let u="",l="";return n.isOwning?(u=n.joinColumns.map(h=>c+"."+h.propertyPath+"="+a+"."+h.referencedColumn.propertyPath).join(" AND "),l=n.inverseJoinColumns.map(h=>i+"."+h.referencedColumn.propertyPath+"="+c+"."+h.propertyPath).join(" AND ")):(u=n.inverseRelation.inverseJoinColumns.map(h=>c+"."+h.propertyPath+"="+a+"."+h.referencedColumn.propertyPath).join(" AND "),l=n.inverseRelation.joinColumns.map(h=>i+"."+h.referencedColumn.propertyPath+"="+c+"."+h.propertyPath).join(" AND "))," "+t.direction+" JOIN "+this.getTableName(o)+" "+this.escape(c)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(u)+" "+t.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l+s)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{const n=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,r=this.expressionMap.selects.find(i=>i.selection===t);if(r&&!r.aliasName&&t.indexOf(".")!==-1){const i=t.split("."),s=i[0],a=i.slice(1).join("."),o=this.expressionMap.aliases.find(c=>c.name===s);if(o){const c=o.metadata.findColumnWithPropertyPath(a);if(c){const u=J.buildAlias(this.connection.driver,void 0,s,c.databaseName);return this.escape(u)+" "+n}}}return this.replacePropertyNames(t)+" "+n}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;e===void 0&&t===void 0&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take);const n=t!=null,r=e!=null;if(this.connection.driver.options.type==="mssql"){let i="";if((n||r)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(i=" ORDER BY (SELECT NULL)"),n&&r)return i+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return i+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(r)return i+" OFFSET "+e+" ROWS"}else if(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(n&&r)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(r)throw new Ta}else if(J.isSQLiteFamily(this.connection.driver)){if(n&&r)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(r)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(n&&r)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return" FETCH NEXT "+t+" ROWS ONLY";if(r)return" OFFSET "+e+" ROWS"}else{if(n&&r)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(r)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let t="";if(this.expressionMap.lockTables){if(!(J.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new M("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new M("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let n="";switch(this.expressionMap.onLocked==="nowait"?n=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(n=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return J.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+n:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(J.isPostgresFamily(e))return" FOR SHARE"+t+n;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new Et;case"pessimistic_write":if(J.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+n;if(J.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+n;if(e.options.type==="mssql")return"";throw new Et;case"pessimistic_partial_write":if(J.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(J.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new Et;case"pessimistic_write_or_fail":if(J.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(J.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new Et;case"for_no_key_update":if(J.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+n;throw new Et;case"for_key_share":if(J.isPostgresFamily(e))return" FOR KEY SHARE"+t+n;throw new Et;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((t,n)=>{switch(t.type){case"and":return(n>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(n>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){const n=this.expressionMap.selects.some(c=>c.selection===e),r=[];if(n&&r.push(...t.columns.filter(c=>c.isSelect===!0)),r.push(...t.columns.filter(c=>this.expressionMap.selects.some(u=>u.selection===e+"."+c.propertyPath))),r.length===0)return[];const i=this.expressionMap.queryEntity?t.primaryColumns.filter(c=>r.indexOf(c)===-1):[],s=[...r,...i],a=[],o=this.escape(e);return s.forEach(c=>{let u=o+"."+this.escape(c.databaseName);c.isVirtualProperty&&c.query&&(u=`(${c.query(o)})`),this.connection.driver.spatialTypes.indexOf(c.type)!==-1&&((J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(u=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${u})`),J.isPostgresFamily(this.connection.driver)&&(c.precision?u=`ST_AsGeoJSON(${u}, ${c.precision})::json`:u=`ST_AsGeoJSON(${u})::json`),this.connection.driver.options.type==="mssql"&&(u=`${u}.ToString()`));const l=this.expressionMap.selects.filter(h=>h.selection===e+"."+c.propertyPath);l.length?l.forEach(h=>{a.push({selection:u,aliasName:h.aliasName?h.aliasName:J.buildAlias(this.connection.driver,void 0,e,c.databaseName),virtual:h.virtual})}):a.push({selection:u,aliasName:J.buildAlias(this.connection.driver,void 0,e,c.databaseName),virtual:n})}),a}findEntityColumnSelects(e,t){return this.expressionMap.selects.filter(n=>n.selection===e||t.columns.some(r=>n.selection===e+"."+r.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,n=this.expressionMap.mainAlias.metadata.primaryColumns,r=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||J.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(", ")+"))";if(J.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const i=n.map(s=>`${r}.${this.escape(s.databaseName)}`).join(", '|;|', ");return n.length===1?`COUNT(DISTINCT(${i}))`:`COUNT(DISTINCT(CONCAT(${i})))`}return this.connection.driver.options.type==="spanner"?n.length===1?`COUNT(DISTINCT(${r}.${this.escape(n[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${n.map(s=>`CAST(${r}.${this.escape(s.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const t=this.computeCountExpression(),n=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!n||!n[0]||!n[0].cnt?0:parseInt(n[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?K.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?K.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{const n=this.expressionMap.aliases.find(r=>r.metadata.tableNameWithoutPrefix===t);if(!n)throw new M(`"${t}" is not part of this query`);return this.escape(n.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&Ve.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new M('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new fa;if(this.expressionMap.lockMode==="optimistic"){const o=this.expressionMap.mainAlias.metadata;if(!o.versionColumn&&!o.updateDateColumn)throw new la(o.name)}const t=new xo(this.connection,e,this.expressionMap.relationIdAttributes),n=new vo(this.connection,e,this.expressionMap.relationCountAttributes);new Mo(this.expressionMap).transform(),new Po(this.expressionMap).transform();let s=[],a=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[o,c]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),u=this.expressionMap.mainAlias.metadata,l=this.expressionMap.mainAlias.name,h=u.primaryColumns.map(b=>{const A=this.escape("distinctAlias"),P=this.escape(J.buildAlias(this.connection.driver,void 0,l,b.databaseName));c[P]||(c[P]="ASC");const D=J.buildAlias(this.connection.driver,void 0,"ids_"+l,b.databaseName);return`${A}.${P} AS ${this.escape(D)}`}),f=this.clone(),E=f.expressionMap.timeTravel;if(s=await new xt(this.connection,e).select(`DISTINCT ${h.join(", ")}`).addSelect(o).from(`(${f.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(E).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(c).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),s.length>0){let b="";const A={};if(u.hasMultiplePrimaryKeys)b=s.map((P,D)=>u.primaryColumns.map(I=>{const W=`orm_distinct_ids_${D}_${I.databaseName}`,G=J.buildAlias(this.connection.driver,void 0,"ids_"+l,I.databaseName);return A[W]=P[G],`${l}.${I.propertyPath}=:${W}`}).join(" AND ")).join(" OR ");else{const P=J.buildAlias(this.connection.driver,void 0,"ids_"+l,u.primaryColumns[0].databaseName),D=s.map(W=>W[P]);D.every(W=>typeof W=="number")?b=`${l}.${u.primaryColumns[0].propertyPath} IN (${D.join(", ")})`:(A.orm_distinct_ids=D,b=l+"."+u.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}s=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:b}).setParameters(A).loadRawResults(e)}}else s=await this.loadRawResults(e);if(s.length>0){const o=await t.load(s),c=await n.load(s);a=new Ro(this.expressionMap,this.connection.driver,o,c,this.queryRunner).transform(s,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,a)}if(this.expressionMap.relationLoadStrategy==="query"){const o=new Bs(this.connection,e);await Promise.all(this.relationMetadatas.map(async c=>{const u=c.inverseEntityMetadata.target,l=c.inverseEntityMetadata.targetName,h=Array.isArray(this.findOptions.select)?K.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,f=Array.isArray(this.findOptions.relations)?K.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,E=this.createQueryBuilder(e).select(l).from(u,l).setFindOptions({select:h?K.deepValue(h,c.propertyPath):void 0,order:this.findOptions.order?K.deepValue(this.findOptions.order,c.propertyPath):void 0,relations:f?K.deepValue(f,c.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(a.length>0){const b=await o.loadManyToManyRelationIdsAndGroup(c,a,void 0,E);a.forEach(A=>{const P=b.find(D=>D.entity===A);if(P){const D=P.related===void 0?null:P.related;c.setEntityValue(A,D)}})}}))}return{raw:s,entities:a}}createOrderByCombinedWithSelectExpression(e){const t=this.expressionMap.allOrderBys,n=Object.keys(t).map(i=>{if(i.indexOf(".")!==-1){const s=i.split("."),a=s[0],o=s.slice(1).join("."),u=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(o);return this.escape(e)+"."+this.escape(J.buildAlias(this.connection.driver,void 0,a,u.databaseName))}else return this.expressionMap.selects.find(s=>s.selection===i||s.aliasName===i)?this.escape(e)+"."+this.escape(i):""}).join(", "),r={};return Object.keys(t).forEach(i=>{if(i.indexOf(".")!==-1){const s=i.split("."),a=s[0],o=s.slice(1).join("."),u=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(o);r[this.escape(e)+"."+this.escape(J.buildAlias(this.connection.driver,void 0,a,u.databaseName))]=t[i]}else this.expressionMap.selects.find(s=>s.selection===i||s.aliasName===i)?r[this.escape(e)+"."+this.escape(i)]=t[i]:r[i]=t[i]}),[n,r]}async loadRawResults(e){const[t,n]=this.getQueryAndParameters(),r=t+" -- PARAMETERS: "+JSON.stringify(n,(u,l)=>typeof l=="bigint"?l.toString():l),i=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let s;const a=i.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let o=!1;if(this.connection.queryResultCache&&a)try{if(s=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:r,duration:this.expressionMap.cacheDuration||i.duration||1e3},e),s&&!this.connection.queryResultCache.isExpired(s))return JSON.parse(s.result)}catch(u){if(!i.ignoreErrors)throw u;o=!0}const c=await e.query(t,n,!0);if(!o&&this.connection.queryResultCache&&a)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:r,time:Date.now(),duration:this.expressionMap.cacheDuration||i.duration||1e3,result:JSON.stringify(c.records)},s,e)}catch(u){if(!i.ignoreErrors)throw u}return c.records}mergeExpressionMap(e){return me.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,n,r){for(const i in e){if(e[i]===void 0||e[i]===!1)continue;const s=r?r+"."+i:i,a=t.findColumnWithPropertyPathStrict(s),o=t.findEmbeddedWithPropertyPath(s),c=t.findRelationWithPropertyPath(s);if(!o&&!a&&!c)throw new nt(s,t);a?this.selects.push(n+"."+s):o&&this.buildSelect(e[i],t,n,s)}}buildRelations(e,t,n,r,i){e&&Object.keys(e).forEach(s=>{const a=e[s],o=i?i+"."+s:s,c=n.findEmbeddedWithPropertyPath(o),u=n.findRelationWithPropertyPath(o);if(!c&&!u)throw new nt(o,n);if(c)this.buildRelations(a,typeof t=="object"?K.deepValue(t,c.propertyPath):void 0,n,r,o);else if(u){let l=r+"_"+o.replace(".","_");l=J.buildAlias(this.connection.driver,{joiner:"__"},r,l),(a===!0||typeof a=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(u):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[s]=="object"?t[s]:void 0,alias:l,parentAlias:r,relationMetadata:u}),t&&typeof t[s]=="object"&&this.buildSelect(t[s],u.inverseEntityMetadata,l))),typeof a=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(a,typeof t=="object"?K.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,l,void 0)}})}buildEagerRelations(e,t,n,r,i){e&&Object.keys(e).forEach(s=>{const a=e[s],o=i?i+"."+s:s,c=n.findEmbeddedWithPropertyPath(o),u=n.findRelationWithPropertyPath(o);if(!c&&!u)throw new nt(o,n);if(c)this.buildEagerRelations(a,typeof t=="object"?K.deepValue(t,c.propertyPath):void 0,n,r,o);else if(u){let l=r+"_"+o.replace(".","_");l=J.buildAlias(this.connection.driver,{joiner:"__"},r,l),(a===!0||typeof a=="object")&&u.inverseEntityMetadata.eagerRelations.forEach(h=>{let f=l+"_"+h.propertyPath.replace(".","_");f=J.buildAlias(this.connection.driver,{joiner:"__"},l,f),this.joins.find(b=>b.alias===f)||this.joins.push({type:"left",select:!0,alias:f,parentAlias:l,selection:void 0,relationMetadata:h}),t&&typeof t[s]=="object"&&this.buildSelect(t[s],u.inverseEntityMetadata,l)}),typeof a=="object"&&this.buildEagerRelations(a,typeof t=="object"?K.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,l,void 0)}})}buildOrder(e,t,n,r){for(const i in e){if(e[i]===void 0)continue;const s=r?r+"."+i:i,a=t.findColumnWithPropertyPathStrict(s),o=t.findEmbeddedWithPropertyPath(s),c=t.findRelationWithPropertyPath(s);if(!o&&!a&&!c)throw new nt(s,t);if(a){let u=typeof e[i]=="object"?e[i].direction:e[i];u=u==="DESC"||u==="desc"||u===-1?"DESC":"ASC";let l=typeof e[i]=="object"?e[i].nulls:void 0;l=l?.toLowerCase()==="first"?"NULLS FIRST":l?.toLowerCase()==="last"?"NULLS LAST":void 0;const h=`${n}.${s}`;this.addOrderBy(h,u,l)}else if(o)this.buildOrder(e[i],t,n,s);else if(c){let u=n+"_"+s.replace(".","_");u=J.buildAlias(this.connection.driver,{joiner:"__"},n,u),this.joins.find(h=>h.alias===u)||this.joins.push({type:"left",select:!1,alias:u,parentAlias:n,selection:void 0,relationMetadata:c}),this.buildOrder(e[i],c.inverseEntityMetadata,u)}}}buildWhere(e,t,n,r){let i="";if(Array.isArray(e))e.length&&(i=e.map(s=>this.buildWhere(s,t,n,r)).filter(s=>!!s).map(s=>"("+s+")").join(" OR "));else{const s=[];for(const a in e){let o=e[a];const c=r?r+"."+a:a,u=t.findColumnWithPropertyPathStrict(c),l=t.findEmbeddedWithPropertyPath(c),h=t.findRelationWithPropertyPath(c);if(!l&&!u&&!h)throw new nt(c,t);if(o===void 0){if((this.connection.options.invalidWhereValuesBehavior?.undefined||"ignore")==="throw")throw new M(`Undefined value encountered in property '${n}.${a}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);continue}if(o===null){const f=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(f==="ignore")continue;if(f==="throw")throw new M(`Null value encountered in property '${n}.${a}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}if(u){let f=`${n}.${c}`;if(u.isVirtualProperty&&u.query&&(f=`(${u.query(this.escape(n))})`),o===null){s.push(`${f} IS NULL`);continue}q.isEqualOperator(e[a])&&(o=e[a].value),u.transformer&&(o instanceof It?o.transformValue(u.transformer):o=ke.transformTo(u.transformer,o)),this.connection.driver.options.type==="mssql"&&(o=this.connection.driver.parametrizeValues(u,o)),s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(f,o)))}else if(l){const f=this.buildWhere(e[a],t,n,c);f&&s.push(f)}else if(h){if(e[a]===null){const f=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(f==="sql-null")s.push(`${n}.${c} IS NULL`);else if(f==="throw")throw new M(`Null value encountered in property '${n}.${a}' of a where condition. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`);continue}if(typeof e[a]=="object"&&Object.keys(e[a]).every(E=>e[a][E]===void 0))continue;if(q.isFindOperator(e[a]))if(e[a].type==="moreThan"||e[a].type==="lessThan"||e[a].type==="moreThanOrEqual"||e[a].type==="lessThanOrEqual"){let f="";e[a].type==="moreThan"?f=">":e[a].type==="lessThan"?f="<":e[a].type==="moreThanOrEqual"?f=">=":e[a].type==="lessThanOrEqual"&&(f="<=");const E=this.subQuery();if(h.isManyToManyOwner)E.select("COUNT(*)").from(h.joinTableName,h.joinTableName).where(h.joinColumns.map(b=>`${h.joinTableName}.${b.propertyName} = ${n}.${b.referencedColumn.propertyName}`).join(" AND "));else if(h.isManyToManyNotOwner)E.select("COUNT(*)").from(h.inverseRelation.joinTableName,h.inverseRelation.joinTableName).where(h.inverseRelation.inverseJoinColumns.map(b=>`${h.inverseRelation.joinTableName}.${b.propertyName} = ${n}.${b.referencedColumn.propertyName}`).join(" AND "));else if(h.isOneToMany)E.select("COUNT(*)").from(h.inverseEntityMetadata.target,h.inverseEntityMetadata.tableName).where(h.inverseRelation.joinColumns.map(b=>`${h.inverseEntityMetadata.tableName}.${b.propertyName} = ${n}.${b.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(E.getSql()+" "+f+" "+parseInt(e[a].value))}else if(h.isManyToOne||h.isOneToOne&&h.isOneToOneOwner){const f=`${n}.${c}`;s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(f,e[a])))}else throw new Error("This relation isn't supported by given find operator");else{let f=n+"_"+h.propertyPath.replace(".","_");f=J.buildAlias(this.connection.driver,{joiner:"__"},n,f),this.joins.find(A=>A.alias===f)||this.joins.push({type:"left",select:!1,selection:void 0,alias:f,parentAlias:n,relationMetadata:h});const b=this.buildWhere(e[a],h.inverseEntityMetadata,f);b&&s.push(b)}}}i=s.length?"("+s.join(") AND (")+")":s.join(" AND ")}return i.length?"("+i+")":i}}class Us{constructor(){this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class Io extends Le{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const n=new Rr(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=n.getSoftDeletionReturningColumns());const[r,i]=this.getQueryAndParameters(),s=await e.query(r,i,!0),a=Us.from(s);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await n.update(a,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),a}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=q.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Jt;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new M(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const r=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!r)throw new M("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(r)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new M(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new aa(e);const t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new M('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new Er;const n=this.createWhereExpression(),r=this.createReturningExpression("update");return r===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${r}${n}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n} RETURNING ${r}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){const e=this.expressionMap.limit;if(e){if(J.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new Ns}return""}}class Oo extends Le{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let n=null,r=null;const i=new Rr(e,this.expressionMap),s=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const h of this.expressionMap.returning)s.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(h));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=i.getUpdationReturningColumns(),s.push(...this.expressionMap.extraReturningColumns.filter(h=>!s.includes(h)))),s.length>0&&this.connection.driver.options.type==="mssql"&&(n=this.connection.driver.buildTableVariableDeclaration("@OutputTable",s),r="SELECT * FROM @OutputTable");const[a,o]=this.getQueryAndParameters(),c=[n,a,r],u=await e.query(c.filter(h=>h!=null).join(`;

`),o,!0),l=Us.from(u);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await i.update(l,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),l}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Jt;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new M(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const r=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!r)throw new M("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(r)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,n={};for(const o in e)e[o]!==void 0&&(n[o]=e[o]);const r=[],i=[];if(t?(this.createPropertyPath(t,n).forEach(o=>{const c=t.findColumnsWithPropertyPath(o);if(c.length<=0)throw new nt(o,t);c.forEach(u=>{if(!u.isUpdate||i.includes(u))return;i.push(u);let l=u.getEntityValue(n);if(u.referencedColumn&&typeof l=="object"&&!(l instanceof Date)&&l!==null&&!Buffer.isBuffer(l)?l=u.referencedColumn.getEntityValue(l):typeof l!="function"&&(l=this.connection.driver.preparePersistentValue(l,u)),typeof l=="function")r.push(this.escape(u.databaseName)+" = "+l());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&l===null)r.push(this.escape(u.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(l=this.connection.driver.parametrizeValue(u,l));const h=this.createParameter(l);let f=null;if((J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1){const b=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";u.srid!=null?f=`${b}(${h}, ${u.srid})`:f=`${b}(${h})`}else J.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?u.srid!=null?f=`ST_SetSRID(ST_GeomFromGeoJSON(${h}), ${u.srid})::${u.type}`:f=`ST_GeomFromGeoJSON(${h})::${u.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?f=u.type+"::STGeomFromText("+h+", "+(u.srid||"0")+")":f=h;r.push(this.escape(u.databaseName)+" = "+f)}})}),(r.length>0||Object.keys(n).length===0)&&(t.versionColumn&&i.indexOf(t.versionColumn)===-1&&r.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&i.indexOf(t.updateDateColumn)===-1&&r.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(n).map(o=>{const c=n[o];if(typeof c=="function")r.push(this.escape(o)+" = "+c());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&c===null)r.push(this.escape(o)+" = NULL");else{const u=this.createParameter(c);r.push(this.escape(o)+" = "+u)}}),r.length<=0)throw new Er;const s=this.createWhereExpression(),a=this.createReturningExpression("update");return a===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${r.join(", ")}${s}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${r.join(", ")} OUTPUT ${a}${s}`:this.connection.driver.options.type==="spanner"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${r.join(", ")}${s} THEN RETURN ${a}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${r.join(", ")}${s} RETURNING ${a}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){const e=this.expressionMap.limit;if(e){if(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new Ns}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new Er}}function Fs(){Le.registerQueryBuilderClass("DeleteQueryBuilder",d=>new Eo(d)),Le.registerQueryBuilderClass("InsertQueryBuilder",d=>new Ao(d)),Le.registerQueryBuilderClass("RelationQueryBuilder",d=>new So(d)),Le.registerQueryBuilderClass("SelectQueryBuilder",d=>new xt(d)),Le.registerQueryBuilderClass("SoftDeleteQueryBuilder",d=>new Io(d)),Le.registerQueryBuilderClass("UpdateQueryBuilder",d=>new Oo(d))}class pt{static sha1(e){const t=function(G,ie){return G<<ie|G>>>32-ie},n=function(G){let ie="",ne,pe;for(ne=7;ne>=0;ne--)pe=G>>>ne*4&15,ie+=pe.toString(16);return ie};let r,i,s;const a=new Array(80);let o=1732584193,c=4023233417,u=2562383102,l=271733878,h=3285377520,f,E,b,A,P,D;e=encodeURIComponent(e);const I=e.length,W=[];for(i=0;i<I-3;i+=4)s=e.charCodeAt(i)<<24|e.charCodeAt(i+1)<<16|e.charCodeAt(i+2)<<8|e.charCodeAt(i+3),W.push(s);switch(I%4){case 0:i=2147483648;break;case 1:i=e.charCodeAt(I-1)<<24|8388608;break;case 2:i=e.charCodeAt(I-2)<<24|e.charCodeAt(I-1)<<16|32768;break;case 3:i=e.charCodeAt(I-3)<<24|e.charCodeAt(I-2)<<16|e.charCodeAt(I-1)<<8|128;break}for(W.push(i);W.length%16!==14;)W.push(0);for(W.push(I>>>29),W.push(I<<3&4294967295),r=0;r<W.length;r+=16){for(i=0;i<16;i++)a[i]=W[r+i];for(i=16;i<=79;i++)a[i]=t(a[i-3]^a[i-8]^a[i-14]^a[i-16],1);for(f=o,E=c,b=u,A=l,P=h,i=0;i<=19;i++)D=t(f,5)+(E&b|~E&A)+P+a[i]+1518500249&4294967295,P=A,A=b,b=t(E,30),E=f,f=D;for(i=20;i<=39;i++)D=t(f,5)+(E^b^A)+P+a[i]+1859775393&4294967295,P=A,A=b,b=t(E,30),E=f,f=D;for(i=40;i<=59;i++)D=t(f,5)+(E&b|E&A|b&A)+P+a[i]+2400959708&4294967295,P=A,A=b,b=t(E,30),E=f,f=D;for(i=60;i<=79;i++)D=t(f,5)+(E^b^A)+P+a[i]+3395469782&4294967295,P=A,A=b,b=t(E,30),E=f,f=D;o=o+f&4294967295,c=c+E&4294967295,u=u+b&4294967295,l=l+A&4294967295,h=h+P&4294967295}return D=n(o)+n(c)+n(u)+n(l)+n(h),D.toLowerCase()}}class Do{constructor(){this.nestedSetColumnNames={left:"nsleft",right:"nsright"},this.materializedPathColumnName="mpath"}getTableName(e){return typeof e!="string"&&(e=e.name),e.split(".").pop()}tableName(e,t){return t||Qi(e)}closureJunctionTableName(e){return e+"_closure"}columnName(e,t,n){const r=t||e;return n.length?lr(n.join("_"))+lo(r):r}relationName(e){return e}primaryKeyName(e,t){const n=[...t];n.sort();const s=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"PK_"+pt.sha1(s).substr(0,27)}uniqueConstraintName(e,t){const n=[...t];n.sort();const s=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"UQ_"+pt.sha1(s).substr(0,27)}relationConstraintName(e,t,n){const r=[...t];r.sort();let a=`${this.getTableName(e).replace(".","_")}_${r.join("_")}`;return n&&(a+=`_${n}`),"REL_"+pt.sha1(a).substr(0,26)}defaultConstraintName(e,t){const i=`${this.getTableName(e).replace(".","_")}_${t}`;return"DF_"+pt.sha1(i).substr(0,27)}foreignKeyName(e,t,n,r){const i=[...t];i.sort();const o=`${this.getTableName(e).replace(".","_")}_${i.join("_")}`;return"FK_"+pt.sha1(o).substr(0,27)}indexName(e,t,n){const r=[...t];r.sort();let a=`${this.getTableName(e).replace(".","_")}_${r.join("_")}`;return n&&(a+=`_${n}`),"IDX_"+pt.sha1(a).substr(0,26)}checkConstraintName(e,t,n){const s=`${this.getTableName(e).replace(".","_")}_${t}`,a="CHK_"+pt.sha1(s).substr(0,26);return n?`${a}_ENUM`:a}exclusionConstraintName(e,t){const i=`${this.getTableName(e).replace(".","_")}_${t}`;return"XCL_"+pt.sha1(i).substr(0,26)}joinColumnName(e,t){return lr(e+"_"+t)}joinTableName(e,t,n,r){return Qi(e+"_"+n.replace(/\./gi,"_")+"_"+t)}joinTableColumnDuplicationPrefix(e,t){return e+"_"+t}joinTableColumnName(e,t,n){return lr(e+"_"+(n||t))}joinTableInverseColumnName(e,t,n){return this.joinTableColumnName(e,t,n)}prefixTableName(e,t){return e+t}}class ze{constructor(e){this["@instanceof"]=Symbol.for("TableColumn"),this.isNullable=!1,this.isGenerated=!1,this.isPrimary=!1,this.isUnique=!1,this.isArray=!1,this.length="",this.zerofill=!1,this.unsigned=!1,e&&(this.name=e.name,this.type=e.type||"",this.length=e.length||"",this.width=e.width,this.charset=e.charset,this.collation=e.collation,this.precision=e.precision,this.scale=e.scale,this.zerofill=e.zerofill||!1,this.unsigned=this.zerofill?!0:e.unsigned||!1,this.default=e.default,this.onUpdate=e.onUpdate,this.isNullable=e.isNullable||!1,this.isGenerated=e.isGenerated||!1,this.generationStrategy=e.generationStrategy,this.generatedIdentity=e.generatedIdentity,this.isPrimary=e.isPrimary||!1,this.isUnique=e.isUnique||!1,this.isArray=e.isArray||!1,this.comment=e.comment,this.enum=e.enum,this.enumName=e.enumName,this.primaryKeyConstraintName=e.primaryKeyConstraintName,this.asExpression=e.asExpression,this.generatedType=e.generatedType,this.spatialFeatureType=e.spatialFeatureType,this.srid=e.srid)}clone(){return new ze({name:this.name,type:this.type,length:this.length,width:this.width,charset:this.charset,collation:this.collation,precision:this.precision,scale:this.scale,zerofill:this.zerofill,unsigned:this.unsigned,enum:this.enum,enumName:this.enumName,primaryKeyConstraintName:this.primaryKeyConstraintName,asExpression:this.asExpression,generatedType:this.generatedType,default:this.default,onUpdate:this.onUpdate,isNullable:this.isNullable,isGenerated:this.isGenerated,generationStrategy:this.generationStrategy,generatedIdentity:this.generatedIdentity,isPrimary:this.isPrimary,isUnique:this.isUnique,isArray:this.isArray,comment:this.comment,spatialFeatureType:this.spatialFeatureType,srid:this.srid})}}class Be{constructor(e){this["@instanceof"]=Symbol.for("TableIndex"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.isUnique=!!e.isUnique,this.isSpatial=!!e.isSpatial,this.isConcurrent=!!e.isConcurrent,this.isFulltext=!!e.isFulltext,this.isNullFiltered=!!e.isNullFiltered,this.parser=e.parser,this.where=e.where?e.where:""}clone(){return new Be({name:this.name,columnNames:[...this.columnNames],isUnique:this.isUnique,isSpatial:this.isSpatial,isConcurrent:this.isConcurrent,isFulltext:this.isFulltext,isNullFiltered:this.isNullFiltered,parser:this.parser,where:this.where})}static create(e){return new Be({name:e.name,columnNames:e.columns.map(t=>t.databaseName),isUnique:e.isUnique,isSpatial:e.isSpatial,isConcurrent:e.isConcurrent,isFulltext:e.isFulltext,isNullFiltered:e.isNullFiltered,parser:e.parser,where:e.where})}}class Je{constructor(e){this["@instanceof"]=Symbol.for("TableForeignKey"),this.columnNames=[],this.referencedColumnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.referencedColumnNames=e.referencedColumnNames,this.referencedDatabase=e.referencedDatabase,this.referencedSchema=e.referencedSchema,this.referencedTableName=e.referencedTableName,this.onDelete=e.onDelete,this.onUpdate=e.onUpdate,this.deferrable=e.deferrable}clone(){return new Je({name:this.name,columnNames:[...this.columnNames],referencedColumnNames:[...this.referencedColumnNames],referencedDatabase:this.referencedDatabase,referencedSchema:this.referencedSchema,referencedTableName:this.referencedTableName,onDelete:this.onDelete,onUpdate:this.onUpdate,deferrable:this.deferrable})}static create(e,t){return new Je({name:e.name,columnNames:e.columnNames,referencedColumnNames:e.referencedColumnNames,referencedDatabase:e.referencedEntityMetadata.database,referencedSchema:e.referencedEntityMetadata.schema,referencedTableName:e.referencedTablePath,onDelete:e.onDelete,onUpdate:e.onUpdate,deferrable:e.deferrable})}}class kt{static createTableColumnOptions(e,t){return{name:e.databaseName,length:t.getColumnLength(e),width:e.width,charset:e.charset,collation:e.collation,precision:e.precision,scale:e.scale,zerofill:e.zerofill,unsigned:e.unsigned,asExpression:e.asExpression,generatedType:e.generatedType,default:t.normalizeDefault(e),onUpdate:e.onUpdate,comment:e.comment,isGenerated:e.isGenerated,generationStrategy:e.generationStrategy,generatedIdentity:e.generatedIdentity,isNullable:e.isNullable,type:t.normalizeType(e),isPrimary:e.isPrimary,isUnique:t.normalizeIsUnique(e),isArray:e.isArray||!1,enum:e.enum?e.enum.map(n=>n+""):e.enum,enumName:e.enumName,primaryKeyConstraintName:e.primaryKeyConstraintName,spatialFeatureType:e.spatialFeatureType,srid:e.srid}}}class We{constructor(e){this["@instanceof"]=Symbol.for("TableUnique"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.deferrable=e.deferrable}clone(){return new We({name:this.name,columnNames:[...this.columnNames],deferrable:this.deferrable})}static create(e){return new We({name:e.name,columnNames:e.columns.map(t=>t.databaseName),deferrable:e.deferrable})}}class it{constructor(e){this["@instanceof"]=Symbol.for("TableCheck"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.expression=e.expression}clone(){return new it({name:this.name,columnNames:this.columnNames?[...this.columnNames]:[],expression:this.expression})}static create(e){return new it({name:e.name,expression:e.expression})}}class yt{constructor(e){this["@instanceof"]=Symbol.for("TableExclusion"),this.name=e.name,this.expression=e.expression}clone(){return new yt({name:this.name,expression:this.expression})}static create(e){return new yt({name:e.name,expression:e.expression})}}class $e{constructor(e){this["@instanceof"]=Symbol.for("Table"),this.columns=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.justCreated=!1,this.withoutRowid=!1,e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,e.columns&&(this.columns=e.columns.map(t=>new ze(t))),e.indices&&(this.indices=e.indices.map(t=>new Be(t))),e.foreignKeys&&(this.foreignKeys=e.foreignKeys.map(t=>new Je({...t,referencedDatabase:t?.referencedDatabase||e.database,referencedSchema:t?.referencedSchema||e.schema}))),e.uniques&&(this.uniques=e.uniques.map(t=>new We(t))),e.checks&&(this.checks=e.checks.map(t=>new it(t))),e.exclusions&&(this.exclusions=e.exclusions.map(t=>new yt(t))),e.justCreated!==void 0&&(this.justCreated=e.justCreated),e.withoutRowid&&(this.withoutRowid=e.withoutRowid),this.engine=e.engine,this.comment=e.comment)}get primaryColumns(){return this.columns.filter(e=>e.isPrimary)}clone(){return new $e({schema:this.schema,database:this.database,name:this.name,columns:this.columns.map(e=>e.clone()),indices:this.indices.map(e=>e.clone()),foreignKeys:this.foreignKeys.map(e=>e.clone()),uniques:this.uniques.map(e=>e.clone()),checks:this.checks.map(e=>e.clone()),exclusions:this.exclusions.map(e=>e.clone()),justCreated:this.justCreated,withoutRowid:this.withoutRowid,engine:this.engine,comment:this.comment})}addColumn(e){this.columns.push(e)}removeColumn(e){const t=this.columns.find(n=>n.name===e.name);t&&this.columns.splice(this.columns.indexOf(t),1)}addUniqueConstraint(e){if(this.uniques.push(e),e.columnNames.length===1){const t=this.columns.find(n=>n.name===e.columnNames[0]);t&&(t.isUnique=!0)}}removeUniqueConstraint(e){const t=this.uniques.find(n=>n.name===e.name);if(t&&(this.uniques.splice(this.uniques.indexOf(t),1),t.columnNames.length===1)){const n=this.columns.find(r=>r.name===t.columnNames[0]);n&&(n.isUnique=!1)}}addCheckConstraint(e){this.checks.push(e)}removeCheckConstraint(e){const t=this.checks.find(n=>n.name===e.name);t&&this.checks.splice(this.checks.indexOf(t),1)}addExclusionConstraint(e){this.exclusions.push(e)}removeExclusionConstraint(e){const t=this.exclusions.find(n=>n.name===e.name);t&&this.exclusions.splice(this.exclusions.indexOf(t),1)}addForeignKey(e){this.foreignKeys.push(e)}removeForeignKey(e){const t=this.foreignKeys.find(n=>n.name===e.name);t&&this.foreignKeys.splice(this.foreignKeys.indexOf(t),1)}addIndex(e,t=!1){if(this.indices.push(e),e.columnNames.length===1&&e.isUnique&&t){const n=this.columns.find(r=>r.name===e.columnNames[0]);n&&(n.isUnique=!0)}}removeIndex(e,t=!1){const n=this.indices.find(r=>r.name===e.name);if(n&&(this.indices.splice(this.indices.indexOf(n),1),n.columnNames.length===1&&n.isUnique&&t)){const r=this.columns.find(i=>i.name===n.columnNames[0]);r&&(r.isUnique=this.indices.some(i=>i.columnNames.length===1&&i.columnNames[0]===r.name&&!!n.isUnique))}}findColumnByName(e){return this.columns.find(t=>t.name===e)}findColumnIndices(e){return this.indices.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnForeignKeys(e){return this.foreignKeys.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnUniques(e){return this.uniques.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnChecks(e){return this.checks.filter(t=>!!t.columnNames.find(n=>n===e.name))}static create(e,t){const n=e.database===t.database?void 0:e.database,r=e.schema===t.options.schema?void 0:e.schema,i={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,r,n),withoutRowid:e.withoutRowid,engine:e.engine,columns:e.columns.filter(s=>s&&!s.isVirtualProperty).map(s=>kt.createTableColumnOptions(s,t)),indices:e.indices.filter(s=>s.synchronize===!0).map(s=>Be.create(s)),uniques:e.uniques.map(s=>We.create(s)),checks:e.checks.map(s=>it.create(s)),exclusions:e.exclusions.map(s=>yt.create(s)),comment:e.comment};return new $e(i)}}class zi{constructor(e,t,n,r,i){this.id=e,this.timestamp=t,this.name=n,this.instance=r,this.transaction=i}}class et{constructor(e,t,...n){this.value=e,this.type=t,this["@instanceof"]=Symbol.for("MssqlParameter"),this.params=[],this.params=n||[]}}class pr{constructor(e,t){this.connection=e,this.queryRunner=t,this.transaction="all";const{schema:n}=this.connection.driver.options,r=this.connection.driver.database;this.migrationsDatabase=r,this.migrationsSchema=n,this.migrationsTableName=e.options.migrationsTableName||"migrations",this.migrationsTable=this.connection.driver.buildTableName(this.migrationsTableName,n,r)}async executeMigration(e){return this.withQueryRunner(async t=>{await this.createMigrationsTableIfNotExist(t);const n=this.connection.driver.createSchemaBuilder();return q.isRdbmsSchemaBuilder(n)&&await n.createMetadataTableIfNecessary(t),await t.beforeMigration(),await e.instance.up(t),await t.afterMigration(),await this.insertExecutedMigration(t,e),e})}async getAllMigrations(){return Promise.resolve(this.getMigrations())}async getExecutedMigrations(){return this.withQueryRunner(async e=>(await this.createMigrationsTableIfNotExist(e),await this.loadExecutedMigrations(e)))}async getPendingMigrations(){const e=await this.getAllMigrations(),t=await this.getExecutedMigrations();return e.filter(n=>!t.find(r=>r.name===n.name))}insertMigration(e){return this.withQueryRunner(t=>this.insertExecutedMigration(t,e))}deleteMigration(e){return this.withQueryRunner(t=>this.deleteExecutedMigration(t,e))}async showMigrations(){let e=!1;const t=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(t);const n=await this.loadExecutedMigrations(t),r=this.getMigrations();for(const i of r){const s=n.find(a=>a.name===i.name);s?this.connection.logger.logSchemaBuild(`[X] ${s.id} ${i.name}`):(e=!0,this.connection.logger.logSchemaBuild(`[ ] ${i.name}`))}return this.queryRunner||await t.release(),e}async executePendingMigrations(){const e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);const t=this.connection.driver.createSchemaBuilder();q.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);const n=await this.loadExecutedMigrations(e),r=this.getLatestTimestampMigration(n),i=this.getMigrations(),s=[],a=i.filter(u=>!n.find(h=>h.name===u.name));if(!a.length)return this.connection.logger.logSchemaBuild("No migrations are pending"),this.queryRunner||await e.release(),[];if(this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${i.length} migrations were found in the source code.`),r&&this.connection.logger.logSchemaBuild(`${r.name} is the last executed migration. It was executed on ${new Date(r.timestamp).toString()}.`),this.connection.logger.logSchemaBuild(`${a.length} migrations are new migrations must be executed.`),this.transaction==="all"){const u=a.filter(l=>l.instance?.transaction!==void 0);if(u.length>0){const l=new wa(u);throw this.connection.logger.logMigration(`Migrations failed, error: ${l.message}`),l}}const o={each:!0,none:!1,all:!1}[this.transaction];for(const u of a)if(u.instance){const l=u.instance.transaction;l===void 0?u.transaction=o:u.transaction=l}let c=!1;this.transaction==="all"&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),c=!0);try{for(const u of a){if(this.fake){await this.insertExecutedMigration(e,u);continue}u.transaction&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),c=!0),await u.instance.up(e).catch(l=>{throw this.connection.logger.logMigration(`Migration "${u.name}" failed, error: ${l?.message}`),l}).then(async()=>{await this.insertExecutedMigration(e,u),u.transaction&&c&&(await e.commitTransaction(),await e.afterMigration())}).then(()=>{s.push(u),this.connection.logger.logSchemaBuild(`Migration ${u.name} has been ${this.fake?"(fake) ":""}executed successfully.`)})}this.transaction==="all"&&c&&(await e.commitTransaction(),await e.afterMigration())}catch(u){if(c)try{await e.rollbackTransaction()}catch{}throw u}finally{this.queryRunner||await e.release()}return s}async undoLastMigration(){const e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);const t=this.connection.driver.createSchemaBuilder();q.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);const n=await this.loadExecutedMigrations(e),r=this.getLatestExecutedMigration(n);if(!r){this.connection.logger.logSchemaBuild("No migrations were found in the database. Nothing to revert!");return}const s=this.getMigrations().find(o=>o.name===r.name);if(!s)throw new M(`No migration ${r.name} was found in the source code. Make sure you have this migration in your codebase and its included in the connection options.`);this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${r.name} is the last executed migration. It was executed on ${new Date(r.timestamp).toString()}.`),this.connection.logger.logSchemaBuild("Now reverting it...");let a=!1;this.transaction!=="none"&&!e.isTransactionActive&&(await e.startTransaction(),a=!0);try{this.fake||(await e.beforeMigration(),await s.instance.down(e),await e.afterMigration()),await this.deleteExecutedMigration(e,s),this.connection.logger.logSchemaBuild(`Migration ${s.name} has been ${this.fake?"(fake) ":""}reverted successfully.`),a&&await e.commitTransaction()}catch(o){if(a)try{await e.rollbackTransaction()}catch{}throw o}finally{this.queryRunner||await e.release()}}async createMigrationsTableIfNotExist(e){if(this.connection.driver.options.type==="mongodb")return;await e.hasTable(this.migrationsTable)||await e.createTable(new $e({database:this.migrationsDatabase,schema:this.migrationsSchema,name:this.migrationsTable,columns:[{name:"id",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationId}),isGenerated:!0,generationStrategy:"increment",isPrimary:!0,isNullable:!1},{name:"timestamp",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp}),isPrimary:!1,isNullable:!1},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}),isNullable:!1}]}))}async loadExecutedMigrations(e){return this.connection.driver.options.type==="mongodb"?e.cursor(this.migrationsTableName,{}).sort({_id:-1}).toArray():(await this.connection.manager.createQueryBuilder(e).select().orderBy(this.connection.driver.escape("id"),"DESC").from(this.migrationsTable,this.migrationsTableName).getRawMany()).map(n=>new zi(parseInt(n.id),parseInt(n.timestamp),n.name))}getMigrations(){const e=this.connection.migrations.map(t=>{const n=t.name||t.constructor.name,r=parseInt(n.substr(-13),10);if(!r||isNaN(r))throw new M(`${n} migration name is wrong. Migration class name should have a JavaScript timestamp appended.`);return new zi(void 0,r,n,t)});return this.checkForDuplicateMigrations(e),e.sort((t,n)=>t.timestamp-n.timestamp)}checkForDuplicateMigrations(e){const t=e.map(r=>r.name),n=Array.from(new Set(t.filter((r,i)=>t.indexOf(r)<i)));if(n.length>0)throw Error(`Duplicate migrations: ${n.join(", ")}`)}getLatestTimestampMigration(e){const t=e.map(n=>n).sort((n,r)=>(n.timestamp-r.timestamp)*-1);return t.length>0?t[0]:void 0}getLatestExecutedMigration(e){return e.length>0?e[0]:void 0}async insertExecutedMigration(e,t){const n={};this.connection.driver.options.type==="mssql"?(n.timestamp=new et(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),n.name=new et(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb"?await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).insertOne(n):await e.manager.createQueryBuilder().insert().into(this.migrationsTable).values(n).execute()}async deleteExecutedMigration(e,t){const n={};if(this.connection.driver.options.type==="mssql"?(n.timestamp=new et(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),n.name=new et(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb")await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).deleteOne(n);else{const r=e.manager.createQueryBuilder();await r.delete().from(this.migrationsTable).where(`${r.escape("timestamp")} = :timestamp`).andWhere(`${r.escape("name")} = :name`).setParameters(n).execute()}}async withQueryRunner(e){const t=this.queryRunner||this.connection.createQueryRunner();try{return await e(t)}finally{this.queryRunner||await t.release()}}}function Lt(d,e,t){const n=[],r={};return function i(s){r[s]=!0,n.push(s),d[s].forEach(function(a){if(!r[a])i(a);else if(n.indexOf(a)>=0)throw n.push(a),new M(`Dependency Cycle Found: ${n.join(" -> ")}`)}),n.pop(),(!e||d[s].length===0)&&t.indexOf(s)===-1&&t.push(s)}}class qo{constructor(){this.nodes={},this.outgoingEdges={},this.incomingEdges={}}addNode(e,t){this.hasNode(e)||(arguments.length===2?this.nodes[e]=t:this.nodes[e]=e,this.outgoingEdges[e]=[],this.incomingEdges[e]=[])}removeNode(e){this.hasNode(e)&&(delete this.nodes[e],delete this.outgoingEdges[e],delete this.incomingEdges[e],[this.incomingEdges,this.outgoingEdges].forEach(function(t){Object.keys(t).forEach(function(n){const r=t[n].indexOf(e);r>=0&&t[n].splice(r,1)})}))}hasNode(e){return this.nodes.hasOwnProperty(e)}getNodeData(e){if(this.hasNode(e))return this.nodes[e];throw new M(`Node does not exist: ${e}`)}setNodeData(e,t){if(this.hasNode(e))this.nodes[e]=t;else throw new M(`Node does not exist: ${e}`)}addDependency(e,t){if(!this.hasNode(e))throw new M(`Node does not exist: ${e}`);if(!this.hasNode(t))throw new M(`Node does not exist: ${t}`);return this.outgoingEdges[e].indexOf(t)===-1&&this.outgoingEdges[e].push(t),this.incomingEdges[t].indexOf(e)===-1&&this.incomingEdges[t].push(e),!0}removeDependency(e,t){let n;this.hasNode(e)&&(n=this.outgoingEdges[e].indexOf(t),n>=0&&this.outgoingEdges[e].splice(n,1)),this.hasNode(t)&&(n=this.incomingEdges[t].indexOf(e),n>=0&&this.incomingEdges[t].splice(n,1))}dependenciesOf(e,t){if(this.hasNode(e)){const n=[];Lt(this.outgoingEdges,t,n)(e);const i=n.indexOf(e);return i>=0&&n.splice(i,1),n}else throw new M(`Node does not exist: ${e}`)}dependantsOf(e,t){if(this.hasNode(e)){const n=[];Lt(this.incomingEdges,t,n)(e);const i=n.indexOf(e);return i>=0&&n.splice(i,1),n}else throw new M(`Node does not exist: ${e}`)}overallOrder(e){const t=this,n=[],r=Object.keys(this.nodes);if(r.length===0)return n;{const i=Lt(this.outgoingEdges,!1,[]);r.forEach(function(a){i(a)});const s=Lt(this.outgoingEdges,e,n);return r.filter(function(a){return t.incomingEdges[a].length===0}).forEach(function(a){s(a)}),n}}}class $o{validateMany(e,t){e.forEach(n=>this.validate(n,e,t)),this.validateDependencies(e),this.validateEagerRelations(e)}validate(e,t,n){if(!e.primaryColumns.length&&!e.isJunction)throw new ca(e);if(e.primaryColumns.length>1&&!e.primaryColumns.every((s,a,o)=>s.primaryKeyConstraintName===o[0].primaryKeyConstraintName))throw new M(`Entity ${e.name} has multiple primary columns with different constraint names. Constraint names should be the equal.`);if(e.inheritancePattern==="STI"||e.tableType==="entity-child"){if(!e.discriminatorColumn)throw new M(`Entity ${e.name} using single-table inheritance, it should also have a discriminator column. Did you forget to put discriminator column options?`);if(typeof e.discriminatorValue>"u")throw new M(`Entity ${e.name} has an undefined discriminator value. Discriminator value should be defined.`);const i=t.find(s=>s!==e&&(s.inheritancePattern==="STI"||s.tableType==="entity-child")&&s.tableName===e.tableName&&s.discriminatorValue===e.discriminatorValue&&s.inheritanceTree.some(a=>e.inheritanceTree.indexOf(a)!==-1));if(i)throw new M(`Entities ${e.name} and ${i.name} have the same discriminator values. Make sure they are different while using the @ChildEntity decorator.`)}if(e.relationCounts.forEach(i=>{if(i.relation.isManyToOne||i.relation.isOneToOne)throw new M("Relation count can not be implemented on ManyToOne or OneToOne relations.")}),n.options.type!=="mongodb"&&e.columns.filter(i=>!i.isVirtualProperty).forEach(i=>{const s=n.normalizeType(i);if(!n.supportedDataTypes.includes(s))throw new ma(i,s,n.options.type);if(i.length&&!n.withLengthColumnTypes.includes(s))throw new M(`Column ${i.propertyName} of Entity ${e.name} does not support length property.`);if(i.type==="enum"&&!i.enum&&!i.enumName)throw new M(`Column "${i.propertyName}" of Entity "${e.name}" is defined as enum, but missing "enum" or "enumName" properties.`)}),(J.isMySQLFamily(n)||n.options.type==="aurora-mysql")&&e.columns.filter(s=>s.isGenerated&&s.generationStrategy!=="uuid").length>1)throw new M(`Error in ${e.name} entity. There can be only one auto-increment column in MySql table.`);if(J.isMySQLFamily(n)&&t.filter(s=>s.database).length===0&&!n.database)throw new ba("database");if(n.options.type==="mssql"&&e.columns.filter(s=>s.charset).length>1)throw new M("Character set specifying is not supported in Sql Server");if(n.options.type==="postgres"){const i=e.columns.find(s=>s.asExpression&&(!s.generatedType||s.generatedType==="VIRTUAL"));if(i)throw new M(`Column "${i.propertyName}" of Entity "${e.name}" is defined as VIRTUAL, but Postgres supports only STORED generated columns.`)}const r=e.create(void 0,{fromDeserializer:!0});e.relations.forEach(i=>{if(i.isManyToMany||i.isOneToMany){if(i.persistenceEnabled===!1)return;const s=i.getEntityValue(r);if(Array.isArray(s))throw new ya(i)}}),e.relations.forEach(i=>{if(n.supportedOnDeleteTypes&&i.onDelete&&!n.supportedOnDeleteTypes.includes(i.onDelete))throw new M(`OnDeleteType "${i.onDelete}" is not supported for ${n.options.type}!`);if(n.supportedOnUpdateTypes&&i.onUpdate&&!n.supportedOnUpdateTypes.includes(i.onUpdate))throw new M(`OnUpdateType "${i.onUpdate}" is not valid for ${n.options.type}!`)}),e.relations.forEach(i=>{if(i.isCascadeRemove&&i.inverseRelation&&i.inverseRelation.isCascadeRemove)throw new M(`Relation ${e.name}#${i.propertyName} and ${i.inverseRelation.entityMetadata.name}#${i.inverseRelation.propertyName} both has cascade remove set. This may lead to unexpected circular removals. Please set cascade remove only from one side of relationship.`)})}validateDependencies(e){const t=new qo;e.forEach(n=>{t.addNode(n.name)}),e.forEach(n=>{n.relationsWithJoinColumns.filter(r=>!r.isNullable).forEach(r=>{t.addDependency(n.name,r.inverseEntityMetadata.name)})});try{t.overallOrder()}catch(n){throw new oa(n.toString().replace("Error: Dependency Cycle Found: ",""))}}validateEagerRelations(e){e.forEach(t=>{t.eagerRelations.forEach(n=>{if(n.inverseRelation&&n.inverseRelation.isEager)throw new M(`Circular eager relations are disallowed. ${t.targetName}#${n.propertyPath} contains "eager: true", and its inverse side ${n.inverseEntityMetadata.targetName}#${n.inverseRelation.propertyPath} contains "eager: true" as well. Remove "eager: true" from one side of the relation.`)})})}}class _o{}class Lo{}class Bo{}class js{}class Uo{}class Fo{}class jo{}class Ki{}class ko{}class Qo{}class Vo{}class mt{static createRelationMaps(e,t,n,r){return r.map(i=>{const s=t.treeParentRelation.joinColumns[0],a=s.referencedColumn??t.primaryColumns[0],o=s.givenDatabaseName||s.databaseName,c=a.givenDatabaseName||a.databaseName,u=i[n+"_"+c],l=i[n+"_"+o];return{id:e.connection.driver.prepareHydratedValue(u,a),parentId:e.connection.driver.prepareHydratedValue(l,s)}})}static buildChildrenEntityTree(e,t,n,r,i){const s=e.treeChildrenRelation.propertyName;if(i.depth===0){t[s]=[];return}const o=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],c=o.getEntityValue(t),u=r.filter(h=>h.parentId===c),l=new Set(u.map(h=>h.id));t[s]=n.filter(h=>l.has(o.getEntityValue(h))),t[s].forEach(h=>{mt.buildChildrenEntityTree(e,h,n,r,{...i,depth:i.depth-1})})}static buildParentEntityTree(e,t,n,r){const i=e.treeParentRelation.propertyName,a=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],o=a.getEntityValue(t),c=r.find(l=>l.id===o),u=n.find(l=>c?a.getEntityValue(l)===c.parentId:!1);u&&(t[i]=u,mt.buildParentEntityTree(e,t[i],n,r))}}function Ji(d,e){var t=Object.keys(d);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(d);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(d,r).enumerable})),t.push.apply(t,n)}return t}function Yi(d){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ji(Object(t),!0).forEach(function(n){Wo(d,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(d,Object.getOwnPropertyDescriptors(t)):Ji(Object(t)).forEach(function(n){Object.defineProperty(d,n,Object.getOwnPropertyDescriptor(t,n))})}return d}function Wo(d,e,t){return e=Ho(e),e in d?Object.defineProperty(d,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):d[e]=t,d}function Ho(d){var e=Go(d,"string");return typeof e=="symbol"?e:String(e)}function Go(d,e){if(typeof d!="object"||d===null)return d;var t=d[Symbol.toPrimitive];if(t!==void 0){var n=t.call(d,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(d)}const zo=ks({});function ks(d){return e.withOptions=t=>ks(Yi(Yi({},d),t)),e;function e(t,...n){const r=typeof t=="string"?[t]:t.raw,{alignValues:i=!1,escapeSpecialCharacters:s=Array.isArray(t),trimWhitespace:a=!0}=d;let o="";for(let l=0;l<r.length;l++){let h=r[l];if(s&&(h=h.replace(/\\\n[ \t]*/g,"").replace(/\\`/g,"`").replace(/\\\$/g,"$").replace(/\\\{/g,"{")),o+=h,l<n.length){const f=i?Ko(n[l],o):n[l];o+=f}}const c=o.split(`
`);let u=null;for(const l of c){const h=l.match(/^(\s+)\S+/);if(h){const f=h[1].length;u?u=Math.min(u,f):u=f}}if(u!==null){const l=u;o=c.map(h=>h[0]===" "||h[0]==="	"?h.slice(l):h).join(`
`)}return a&&(o=o.trim()),s&&(o=o.replace(/\\n/g,`
`)),o}}function Ko(d,e){if(typeof d!="string"||!d.includes(`
`))return d;const n=e.slice(e.lastIndexOf(`
`)+1).match(/^(\s+)/);if(n){const r=n[1];return d.replace(/\n/g,`
${r}`)}return d}function Xt({driver:d,strings:e,expressions:t}){let n="";const r=[];let i=0;for(const[s,a]of t.entries()){if(n+=e[s],a===null){n+="NULL";continue}if(typeof a=="function"){const o=a();if(typeof o=="string"){n+=o;continue}if(Array.isArray(o)){if(o.length===0)throw new Error(`Expression ${s} in this sql tagged template is a function which returned an empty array. Empty arrays cannot safely be expanded into parameter lists.`);const c=o.map(()=>d.createParameter(`param_${i+1}`,i++));n+=c.join(", "),r.push(...o);continue}throw new Error(`Expression ${s} in this sql tagged template is a function which returned a value of type "${o===null?"null":typeof o}". Only array and string types are supported as function return values in sql tagged template expressions.`)}n+=d.createParameter(`param_${i+1}`,i++),r.push(a)}return n+=e[e.length-1],n=zo(n),{query:n,parameters:r}}class Qs{get metadata(){return this.manager.connection.getMetadata(this.target)}constructor(e,t,n){this.target=e,this.manager=t,this.queryRunner=n}createQueryBuilder(e,t){return this.manager.createQueryBuilder(this.metadata.target,e||this.metadata.targetName,t||this.queryRunner)}hasId(e){return this.manager.hasId(this.metadata.target,e)}getId(e){return this.manager.getId(this.metadata.target,e)}create(e){return this.manager.create(this.metadata.target,e)}merge(e,...t){return this.manager.merge(this.metadata.target,e,...t)}preload(e){return this.manager.preload(this.metadata.target,e)}save(e,t){return this.manager.save(this.metadata.target,e,t)}remove(e,t){return this.manager.remove(this.metadata.target,e,t)}softRemove(e,t){return this.manager.softRemove(this.metadata.target,e,t)}recover(e,t){return this.manager.recover(this.metadata.target,e,t)}insert(e){return this.manager.insert(this.metadata.target,e)}update(e,t){return this.manager.update(this.metadata.target,e,t)}updateAll(e){return this.manager.updateAll(this.metadata.target,e)}upsert(e,t){return this.manager.upsert(this.metadata.target,e,t)}delete(e){return this.manager.delete(this.metadata.target,e)}deleteAll(){return this.manager.deleteAll(this.metadata.target)}softDelete(e){return this.manager.softDelete(this.metadata.target,e)}restore(e){return this.manager.restore(this.metadata.target,e)}exist(e){return this.manager.exists(this.metadata.target,e)}exists(e){return this.manager.exists(this.metadata.target,e)}existsBy(e){return this.manager.existsBy(this.metadata.target,e)}count(e){return this.manager.count(this.metadata.target,e)}countBy(e){return this.manager.countBy(this.metadata.target,e)}sum(e,t){return this.manager.sum(this.metadata.target,e,t)}average(e,t){return this.manager.average(this.metadata.target,e,t)}minimum(e,t){return this.manager.minimum(this.metadata.target,e,t)}maximum(e,t){return this.manager.maximum(this.metadata.target,e,t)}async find(e){return this.manager.find(this.metadata.target,e)}async findBy(e){return this.manager.findBy(this.metadata.target,e)}findAndCount(e){return this.manager.findAndCount(this.metadata.target,e)}findAndCountBy(e){return this.manager.findAndCountBy(this.metadata.target,e)}async findByIds(e){return this.manager.findByIds(this.metadata.target,e)}async findOne(e){return this.manager.findOne(this.metadata.target,e)}async findOneBy(e){return this.manager.findOneBy(this.metadata.target,e)}async findOneById(e){return this.manager.findOneById(this.metadata.target,e)}async findOneOrFail(e){return this.manager.findOneOrFail(this.metadata.target,e)}async findOneByOrFail(e){return this.manager.findOneByOrFail(this.metadata.target,e)}query(e,t){return this.manager.query(e,t)}async sql(e,...t){const{query:n,parameters:r}=Xt({driver:this.manager.connection.driver,strings:e,expressions:t});return await this.query(n,r)}clear(){return this.manager.clear(this.metadata.target)}increment(e,t,n){return this.manager.increment(this.metadata.target,e,t,n)}decrement(e,t,n){return this.manager.decrement(this.metadata.target,e,t,n)}extend(e){const t=this.constructor,{target:n,manager:r,queryRunner:i}=this,s=class extends t{constructor(a,o,c){super(a,o,c)}};for(const a in e)s.prototype[a]=e[a];return new s(n,r,i)}}class Jo extends Qs{async findTrees(e){const t=await this.findRoots(e);return await Promise.all(t.map(n=>this.findDescendantsTree(n,e))),t}findRoots(e){const t=a=>this.manager.connection.driver.escape(a),n=a=>this.manager.connection.driver.escape(a),r=this.metadata.treeParentRelation.joinColumns[0],i=r.givenDatabaseName||r.databaseName,s=this.createQueryBuilder("treeEntity");return Ve.applyOptionsToTreeQueryBuilder(s,e),s.where(`${t("treeEntity")}.${n(i)} IS NULL`).getMany()}findDescendants(e,t){const n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);return Ve.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findDescendantsTree(e,t){const n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);Ve.applyOptionsToTreeQueryBuilder(n,t);const r=await n.getRawAndEntities(),i=mt.createRelationMaps(this.manager,this.metadata,"treeEntity",r.raw);return mt.buildChildrenEntityTree(this.metadata,e,r.entities,i,{depth:-1,...t}),e}countDescendants(e){return this.createDescendantsQueryBuilder("treeEntity","treeClosure",e).getCount()}createDescendantsQueryBuilder(e,t,n){const r=i=>this.manager.connection.driver.escape(i);if(this.metadata.treeType==="closure-table"){const i=this.metadata.closureJunctionTable.descendantColumns.map(o=>r(t)+"."+r(o.propertyPath)+" = "+r(e)+"."+r(o.referencedColumn.propertyPath)).join(" AND "),s={},a=this.metadata.closureJunctionTable.ancestorColumns.map(o=>(s[o.referencedColumn.propertyName]=o.referencedColumn.getEntityValue(n),r(t)+"."+r(o.propertyPath)+" = :"+o.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,i).where(a).setParameters(s)}else if(this.metadata.treeType==="nested-set"){const i=e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN joined."+this.metadata.nestedSetLeftColumn.propertyPath+" AND joined."+this.metadata.nestedSetRightColumn.propertyPath,s={},a=this.metadata.treeParentRelation.joinColumns.map(o=>{const c=o.referencedColumn.propertyPath.replace(".","_");return s[c]=o.referencedColumn.getEntityValue(n),"joined."+o.referencedColumn.propertyPath+" = :"+c}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",i).where(a,s)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(i=>{const s=i.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return J.isSQLiteFamily(this.manager.connection.driver)?`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE ${s.getQuery()} || '%'`:`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE NULLIF(CONCAT(${s.getQuery()}, '%'), '%')`});throw new M("Supported only in tree entities")}findAncestors(e,t){const n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);return Ve.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findAncestorsTree(e,t){const n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);Ve.applyOptionsToTreeQueryBuilder(n,t);const r=await n.getRawAndEntities(),i=mt.createRelationMaps(this.manager,this.metadata,"treeEntity",r.raw);return mt.buildParentEntityTree(this.metadata,e,r.entities,i),e}countAncestors(e){return this.createAncestorsQueryBuilder("treeEntity","treeClosure",e).getCount()}createAncestorsQueryBuilder(e,t,n){if(this.metadata.treeType==="closure-table"){const r=this.metadata.closureJunctionTable.ancestorColumns.map(a=>t+"."+a.propertyPath+" = "+e+"."+a.referencedColumn.propertyPath).join(" AND "),i={},s=this.metadata.closureJunctionTable.descendantColumns.map(a=>(i[a.referencedColumn.propertyName]=a.referencedColumn.getEntityValue(n),t+"."+a.propertyPath+" = :"+a.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,r).where(s).setParameters(i)}else if(this.metadata.treeType==="nested-set"){const r="joined."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN "+e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" AND "+e+"."+this.metadata.nestedSetRightColumn.propertyPath,i={},s=this.metadata.treeParentRelation.joinColumns.map(a=>{const o=a.referencedColumn.propertyPath.replace(".","_");return i[o]=a.referencedColumn.getEntityValue(n),"joined."+a.referencedColumn.propertyPath+" = :"+o}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",r).where(s,i)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(r=>{const i=r.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return J.isSQLiteFamily(this.manager.connection.driver)?`${i.getQuery()} LIKE ${e}.${this.metadata.materializedPathColumn.propertyPath} || '%'`:`${i.getQuery()} LIKE CONCAT(${e}.${this.metadata.materializedPathColumn.propertyPath}, '%')`});throw new M("Supported only in tree entities")}}class Yo{transform(e,t,n,r=!1){return this.groupAndTransform(e,t,n,r),e}groupAndTransform(e,t,n,r=!1){n.nonVirtualColumns.forEach(i=>{const s=i.getEntityValue(t);s!==void 0&&i.setEntityValue(e,s)}),n.relations.length&&n.relations.forEach(i=>{let s=i.getEntityValue(e);const a=i.getEntityValue(t,r);if(a!==void 0)if(i.isOneToMany||i.isManyToMany){if(!Array.isArray(a))return;s||(s=[],i.setEntityValue(e,s)),a.forEach(o=>{let c=s.find(l=>i.inverseEntityMetadata.compareEntities(o,l));const u=i.inverseEntityMetadata.findInheritanceMetadata(o);c||(c=u.create(void 0,{fromDeserializer:!0}),s.push(c)),this.groupAndTransform(c,o,u,r)})}else{if(!me.isObject(a)){me.isObject(s)||i.setEntityValue(e,a);return}const o=i.inverseEntityMetadata.findInheritanceMetadata(a);s||(s=o.create(void 0,{fromDeserializer:!0}),i.setEntityValue(e,s)),this.groupAndTransform(s,a,o,r)}})}}class Xo{constructor(e,t,n,r){this.plainEntity=e,this.metadata=t,this.parentLoadMapItem=n,this.relation=r}get target(){return this.metadata.target}get id(){return this.metadata.getEntityIdMixedMap(this.plainEntity)}}class Zo{constructor(){this.loadMapItems=[]}get mainLoadMapItem(){return this.loadMapItems.find(e=>!e.relation&&!e.parentLoadMapItem)}addLoadMap(e){this.loadMapItems.find(n=>n.target===e.target&&n.id===e.id)||this.loadMapItems.push(e)}fillEntities(e,t){t.forEach(n=>{const r=this.loadMapItems.find(i=>i.target===e&&i.metadata.compareEntities(n,i.plainEntity));r&&(r.entity=n)})}groupByTargetIds(){const e=[];return this.loadMapItems.forEach(t=>{let n=e.find(r=>r.target===t.target);n||(n={target:t.target,ids:[]},e.push(n)),n.ids.push(t.id)}),e}}class ec{constructor(e){this.manager=e}async transform(e,t){if(!t.hasAllPrimaryKeys(e))return Promise.reject("Given object does not have a primary column, cannot transform it to database entity.");const n=new Zo,r=(i,s,a,o)=>{const c=new Xo(i,s,a,o);n.addLoadMap(c),s.extractRelationValuesFromEntity(i,t.relations).filter(u=>u!=null).forEach(([u,l,h])=>r(l,h,c,u))};return r(e,t),await Promise.all(n.groupByTargetIds().map(i=>this.manager.findByIds(i.target,i.ids).then(s=>n.fillEntities(i.target,s)))),n.loadMapItems.forEach(i=>{!i.relation||!i.entity||!i.parentLoadMapItem||!i.parentLoadMapItem.entity||(i.relation.isManyToMany||i.relation.isOneToMany?(i.parentLoadMapItem.entity[i.relation.propertyName]||(i.parentLoadMapItem.entity[i.relation.propertyName]=[]),i.parentLoadMapItem.entity[i.relation.propertyName].push(i.entity)):i.parentLoadMapItem.entity[i.relation.propertyName]=i.entity)}),n.mainLoadMapItem?n.mainLoadMapItem.entity:void 0}}class tc{get repository(){const e=this.getCustomRepositoryTarget(this);if(!e)throw new rn(this.constructor);return this.manager.getRepository(e)}get treeRepository(){const e=this.getCustomRepositoryTarget(this);if(!e)throw new rn(this.constructor);return this.manager.getTreeRepository(e)}createQueryBuilder(e){const t=this.getCustomRepositoryTarget(this.constructor);if(!t)throw new rn(this.constructor);return this.manager.getRepository(t).createQueryBuilder(e)}createQueryBuilderFor(e,t){return this.getRepositoryFor(e).createQueryBuilder(t)}getRepositoryFor(e){return this.manager.getRepository(e)}getTreeRepositoryFor(e){return this.manager.getTreeRepository(e)}getCustomRepositoryTarget(e){const t=zt().entityRepositories.find(n=>n.target===(typeof e=="function"?e:e.constructor));if(!t)throw new ws(e);return t.entity}}class Xi{constructor(e){this.subjects=[...e],this.metadatas=this.getUniqueMetadatas(this.subjects)}sort(e){if(!this.metadatas.length)return this.subjects;const t=[];if(e==="delete"){const a=this.subjects.filter(o=>!o.entity&&!o.databaseEntity);t.push(...a),this.removeAlreadySorted(a)}const n=this.getNonNullableDependencies();let r=this.toposort(n);e==="insert"&&(r=r.reverse()),r.forEach(a=>{const o=this.subjects.filter(c=>c.metadata.targetName===a||c.metadata.inheritanceTree.some(u=>u.name===a));t.push(...o),this.removeAlreadySorted(o)});const i=this.getDependencies();let s=this.toposort(i);return e==="insert"&&(s=s.reverse()),s.forEach(a=>{const o=this.subjects.filter(c=>c.metadata.targetName===a);t.push(...o),this.removeAlreadySorted(o)}),t.push(...this.subjects),t}removeAlreadySorted(e){e.forEach(t=>{this.subjects.splice(this.subjects.indexOf(t),1)})}getUniqueMetadatas(e){const t=[];return e.forEach(n=>{t.indexOf(n.metadata)===-1&&t.push(n.metadata)}),t}getNonNullableDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.isNullable||e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}getDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.inverseEntityMetadata!==t&&e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}toposort(e){function t(c){const u=[];for(let l=0,h=c.length;l<h;l++){const f=c[l];u.indexOf(f[0])<0&&u.push(f[0]),u.indexOf(f[1])<0&&u.push(f[1])}return u}const n=t(e);let r=n.length,i=r;const s=new Array(r),a=new Set;for(;i--;)a.has(i)||o(n[i],i,[]);function o(c,u,l){if(l.indexOf(c)>=0)throw new M("Cyclic dependency: "+JSON.stringify(c));if(!~n.indexOf(c))throw new M("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(c));if(a.has(u))return;a.add(u);const h=e.filter(function(f){return f[0]===c});if(u=h.length){const f=l.concat(c);do{const E=h[--u][1];o(E,n.indexOf(E),f)}while(u)}s[--r]=c}return s}}var Qt={exports:{}},nc=Qt.exports,Zi;function rc(){return Zi||(Zi=1,(function(d,e){(function(t,n){d.exports=n()})(nc,(function(){var t=1e3,n=6e4,r=36e5,i="millisecond",s="second",a="minute",o="hour",c="day",u="week",l="month",h="quarter",f="year",E="date",b="Invalid Date",A=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,P=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,D={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(B){var U=["th","st","nd","rd"],k=B%100;return"["+B+(U[(k-20)%10]||U[k]||U[0])+"]"}},I=function(B,U,k){var L=String(B);return!L||L.length>=U?B:""+Array(U+1-L.length).join(k)+B},W={s:I,z:function(B){var U=-B.utcOffset(),k=Math.abs(U),L=Math.floor(k/60),V=k%60;return(U<=0?"+":"-")+I(L,2,"0")+":"+I(V,2,"0")},m:function B(U,k){if(U.date()<k.date())return-B(k,U);var L=12*(k.year()-U.year())+(k.month()-U.month()),V=U.clone().add(L,l),X=k-V<0,oe=U.clone().add(L+(X?-1:1),l);return+(-(L+(k-V)/(X?V-oe:oe-V))||0)},a:function(B){return B<0?Math.ceil(B)||0:Math.floor(B)},p:function(B){return{M:l,y:f,w:u,d:c,D:E,h:o,m:a,s,ms:i,Q:h}[B]||String(B||"").toLowerCase().replace(/s$/,"")},u:function(B){return B===void 0}},G="en",ie={};ie[G]=D;var ne="$isDayjsObject",pe=function(B){return B instanceof Y||!(!B||!B[ne])},F=function B(U,k,L){var V;if(!U)return G;if(typeof U=="string"){var X=U.toLowerCase();ie[X]&&(V=X),k&&(ie[X]=k,V=X);var oe=U.split("-");if(!V&&oe.length>1)return B(oe[0])}else{var ee=U.name;ie[ee]=U,V=ee}return!L&&V&&(G=V),V||!L&&G},se=function(B,U){if(pe(B))return B.clone();var k=typeof U=="object"?U:{};return k.date=B,k.args=arguments,new Y(k)},v=W;v.l=F,v.i=pe,v.w=function(B,U){return se(B,{locale:U.$L,utc:U.$u,x:U.$x,$offset:U.$offset})};var Y=(function(){function B(k){this.$L=F(k.locale,null,!0),this.parse(k),this.$x=this.$x||k.x||{},this[ne]=!0}var U=B.prototype;return U.parse=function(k){this.$d=(function(L){var V=L.date,X=L.utc;if(V===null)return new Date(NaN);if(v.u(V))return new Date;if(V instanceof Date)return new Date(V);if(typeof V=="string"&&!/Z$/i.test(V)){var oe=V.match(A);if(oe){var ee=oe[2]-1||0,ce=(oe[7]||"0").substring(0,3);return X?new Date(Date.UTC(oe[1],ee,oe[3]||1,oe[4]||0,oe[5]||0,oe[6]||0,ce)):new Date(oe[1],ee,oe[3]||1,oe[4]||0,oe[5]||0,oe[6]||0,ce)}}return new Date(V)})(k),this.init()},U.init=function(){var k=this.$d;this.$y=k.getFullYear(),this.$M=k.getMonth(),this.$D=k.getDate(),this.$W=k.getDay(),this.$H=k.getHours(),this.$m=k.getMinutes(),this.$s=k.getSeconds(),this.$ms=k.getMilliseconds()},U.$utils=function(){return v},U.isValid=function(){return this.$d.toString()!==b},U.isSame=function(k,L){var V=se(k);return this.startOf(L)<=V&&V<=this.endOf(L)},U.isAfter=function(k,L){return se(k)<this.startOf(L)},U.isBefore=function(k,L){return this.endOf(L)<se(k)},U.$g=function(k,L,V){return v.u(k)?this[L]:this.set(V,k)},U.unix=function(){return Math.floor(this.valueOf()/1e3)},U.valueOf=function(){return this.$d.getTime()},U.startOf=function(k,L){var V=this,X=!!v.u(L)||L,oe=v.p(k),ee=function(Re,fe){var be=v.w(V.$u?Date.UTC(V.$y,fe,Re):new Date(V.$y,fe,Re),V);return X?be:be.endOf(c)},ce=function(Re,fe){return v.w(V.toDate()[Re].apply(V.toDate("s"),(X?[0,0,0,0]:[23,59,59,999]).slice(fe)),V)},Z=this.$W,Me=this.$M,qe=this.$D,Se="set"+(this.$u?"UTC":"");switch(oe){case f:return X?ee(1,0):ee(31,11);case l:return X?ee(1,Me):ee(0,Me+1);case u:var je=this.$locale().weekStart||0,Pe=(Z<je?Z+7:Z)-je;return ee(X?qe-Pe:qe+(6-Pe),Me);case c:case E:return ce(Se+"Hours",0);case o:return ce(Se+"Minutes",1);case a:return ce(Se+"Seconds",2);case s:return ce(Se+"Milliseconds",3);default:return this.clone()}},U.endOf=function(k){return this.startOf(k,!1)},U.$set=function(k,L){var V,X=v.p(k),oe="set"+(this.$u?"UTC":""),ee=(V={},V[c]=oe+"Date",V[E]=oe+"Date",V[l]=oe+"Month",V[f]=oe+"FullYear",V[o]=oe+"Hours",V[a]=oe+"Minutes",V[s]=oe+"Seconds",V[i]=oe+"Milliseconds",V)[X],ce=X===c?this.$D+(L-this.$W):L;if(X===l||X===f){var Z=this.clone().set(E,1);Z.$d[ee](ce),Z.init(),this.$d=Z.set(E,Math.min(this.$D,Z.daysInMonth())).$d}else ee&&this.$d[ee](ce);return this.init(),this},U.set=function(k,L){return this.clone().$set(k,L)},U.get=function(k){return this[v.p(k)]()},U.add=function(k,L){var V,X=this;k=Number(k);var oe=v.p(L),ee=function(Me){var qe=se(X);return v.w(qe.date(qe.date()+Math.round(Me*k)),X)};if(oe===l)return this.set(l,this.$M+k);if(oe===f)return this.set(f,this.$y+k);if(oe===c)return ee(1);if(oe===u)return ee(7);var ce=(V={},V[a]=n,V[o]=r,V[s]=t,V)[oe]||1,Z=this.$d.getTime()+k*ce;return v.w(Z,this)},U.subtract=function(k,L){return this.add(-1*k,L)},U.format=function(k){var L=this,V=this.$locale();if(!this.isValid())return V.invalidDate||b;var X=k||"YYYY-MM-DDTHH:mm:ssZ",oe=v.z(this),ee=this.$H,ce=this.$m,Z=this.$M,Me=V.weekdays,qe=V.months,Se=V.meridiem,je=function(fe,be,we,Ee){return fe&&(fe[be]||fe(L,X))||we[be].slice(0,Ee)},Pe=function(fe){return v.s(ee%12||12,fe,"0")},Re=Se||function(fe,be,we){var Ee=fe<12?"AM":"PM";return we?Ee.toLowerCase():Ee};return X.replace(P,(function(fe,be){return be||(function(we){switch(we){case"YY":return String(L.$y).slice(-2);case"YYYY":return v.s(L.$y,4,"0");case"M":return Z+1;case"MM":return v.s(Z+1,2,"0");case"MMM":return je(V.monthsShort,Z,qe,3);case"MMMM":return je(qe,Z);case"D":return L.$D;case"DD":return v.s(L.$D,2,"0");case"d":return String(L.$W);case"dd":return je(V.weekdaysMin,L.$W,Me,2);case"ddd":return je(V.weekdaysShort,L.$W,Me,3);case"dddd":return Me[L.$W];case"H":return String(ee);case"HH":return v.s(ee,2,"0");case"h":return Pe(1);case"hh":return Pe(2);case"a":return Re(ee,ce,!0);case"A":return Re(ee,ce,!1);case"m":return String(ce);case"mm":return v.s(ce,2,"0");case"s":return String(L.$s);case"ss":return v.s(L.$s,2,"0");case"SSS":return v.s(L.$ms,3,"0");case"Z":return oe}return null})(fe)||oe.replace(":","")}))},U.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},U.diff=function(k,L,V){var X,oe=this,ee=v.p(L),ce=se(k),Z=(ce.utcOffset()-this.utcOffset())*n,Me=this-ce,qe=function(){return v.m(oe,ce)};switch(ee){case f:X=qe()/12;break;case l:X=qe();break;case h:X=qe()/3;break;case u:X=(Me-Z)/6048e5;break;case c:X=(Me-Z)/864e5;break;case o:X=Me/r;break;case a:X=Me/n;break;case s:X=Me/t;break;default:X=Me}return V?X:v.a(X)},U.daysInMonth=function(){return this.endOf(l).$D},U.$locale=function(){return ie[this.$L]},U.locale=function(k,L){if(!k)return this.$L;var V=this.clone(),X=F(k,L,!0);return X&&(V.$L=X),V},U.clone=function(){return v.w(this.$d,this)},U.toDate=function(){return new Date(this.valueOf())},U.toJSON=function(){return this.isValid()?this.toISOString():null},U.toISOString=function(){return this.$d.toISOString()},U.toString=function(){return this.$d.toUTCString()},B})(),Q=Y.prototype;return se.prototype=Q,[["$ms",i],["$s",s],["$m",a],["$H",o],["$W",c],["$M",l],["$y",f],["$D",E]].forEach((function(B){Q[B[1]]=function(U){return this.$g(U,B[0],B[1])}})),se.extend=function(B,U){return B.$i||(B(U,Y,se),B.$i=!0),se},se.locale=F,se.isDayjs=pe,se.unix=function(B){return se(1e3*B)},se.en=ie[G],se.Ls=ie,se.p={},se}))})(Qt)),Qt.exports}var ic=rc();const sc=ys(ic);class he{static normalizeHydratedDate(e){return e&&(typeof e=="string"?new Date(e):e)}static mixedDateToDateString(e){return e instanceof Date?this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate()):e}static mixedDateToDate(e,t=!1,n=!0){let r=typeof e=="string"?sc(e).toDate():e;return t&&(r=new Date(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds(),r.getUTCMilliseconds())),n||r.setUTCMilliseconds(0),r}static mixedDateToTimeString(e,t=!1){return e instanceof Date?this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+(t?"":":"+this.formatZerolessValue(e.getSeconds())):e}static mixedTimeToDate(e){if(typeof e=="string"){const[t,n,r]=e.split(":"),i=new Date;return t&&i.setHours(parseInt(t)),n&&i.setMinutes(parseInt(n)),r&&i.setSeconds(parseInt(r)),i}return e}static mixedTimeToString(e,t=!1){return e=e instanceof Date?e.getHours()+":"+e.getMinutes()+(t?"":":"+e.getSeconds()):e,typeof e=="string"?e.split(":").map(n=>n.length===1?"0"+n:n).join(":"):e}static mixedDateToDatetimeString(e,t){if(typeof e=="string"&&(e=new Date(e)),e instanceof Date){let n=this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate())+" "+this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+":"+this.formatZerolessValue(e.getSeconds());t&&(n+=`.${this.formatMilliseconds(e.getMilliseconds())}`),e=n}return e}static mixedDateToUtcDatetimeString(e){return typeof e=="string"&&(e=new Date(e)),e instanceof Date?this.formatZerolessValue(e.getUTCFullYear(),4)+"-"+this.formatZerolessValue(e.getUTCMonth()+1)+"-"+this.formatZerolessValue(e.getUTCDate())+" "+this.formatZerolessValue(e.getUTCHours())+":"+this.formatZerolessValue(e.getUTCMinutes())+":"+this.formatZerolessValue(e.getUTCSeconds())+"."+this.formatMilliseconds(e.getUTCMilliseconds()):e}static simpleArrayToString(e){return Array.isArray(e)?e.map(t=>String(t)).join(","):e}static stringToSimpleArray(e){return typeof e=="string"?e.length>0?e.split(","):[]:e}static simpleJsonToString(e){return JSON.stringify(e)}static stringToSimpleJson(e){return typeof e=="string"?JSON.parse(e):e}static simpleEnumToString(e){return""+e}static stringToSimpleEnum(e,t){return t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0&&(e=parseInt(e)),e}static formatZerolessValue(e,t=2){return`${"0".repeat(t)}${e}`.slice(-t)}static formatMilliseconds(e){return e<10?"00"+e:e<100?"0"+e:String(e)}}class ac{compute(e){e.forEach(t=>{this.computeDiffColumns(t),this.computeDiffRelationalColumns(e,t)})}computeDiffColumns(e){e.entity&&e.metadata.columns.forEach(t=>{if(t.isVirtual||t.isDiscriminator)return;const n=e.changeMaps.find(i=>i.column===t);n&&e.changeMaps.splice(e.changeMaps.indexOf(n),1);const r=t.getEntityValue(e.entity);if(r!==void 0){if(e.databaseEntity){const i=t.type!=="json"&&t.type!=="jsonb";let s=t.getEntityValue(e.databaseEntity,i);if(t.relationMetadata){const o=t.relationMetadata.getEntityValue(e.entity);if(o!=null)return}let a=r;if(r!==null&&s!==null){switch(t.type){case"date":a=t.isArray?r.map(o=>he.mixedDateToDateString(o)):he.mixedDateToDateString(r),s=t.isArray?s.map(o=>he.mixedDateToDateString(o)):he.mixedDateToDateString(s);break;case"time":case"time with time zone":case"time without time zone":case"timetz":a=t.isArray?r.map(o=>he.mixedDateToTimeString(o)):he.mixedDateToTimeString(r),s=t.isArray?s.map(o=>he.mixedDateToTimeString(o)):he.mixedDateToTimeString(s);break;case"datetime":case"datetime2":case Date:case"timestamp":case"timestamp without time zone":case"timestamp with time zone":case"timestamp with local time zone":case"timestamptz":a=t.isArray?r.map(o=>he.mixedDateToUtcDatetimeString(o)):he.mixedDateToUtcDatetimeString(r),s=t.isArray?s.map(o=>he.mixedDateToUtcDatetimeString(o)):he.mixedDateToUtcDatetimeString(s);break;case"json":case"jsonb":if(K.deepCompare(r,s))return;break;case"simple-array":a=he.simpleArrayToString(r),s=he.simpleArrayToString(s);break;case"simple-enum":a=he.simpleEnumToString(r),s=he.simpleEnumToString(s);break;case"simple-json":a=he.simpleJsonToString(r),s=he.simpleJsonToString(s);break}t.transformer&&(a=ke.transformTo(t.transformer,r))}if(t.isArray){if(K.deepCompare(a,s))return}else if(Buffer.isBuffer(a)&&Buffer.isBuffer(s)){if(a.equals(s))return}else if(a===s)return}e.diffColumns.includes(t)||e.diffColumns.push(t),e.changeMaps.push({column:t,value:r})}})}computeDiffRelationalColumns(e,t){t.entity&&t.metadata.relationsWithJoinColumns.forEach(n=>{let r=n.getEntityValue(t.entity);if(r===void 0)return;if(t.databaseEntity){let a=r;a!==null&&me.isObject(a)&&(a=n.getRelationIdMap(a));const o=n.getEntityValue(t.databaseEntity);if(K.compareIds(a,o))return;t.diffRelations.push(n)}const i=e.find(a=>a.mustBeInserted&&a.entity===r);i&&(r=i);const s=t.changeMaps.find(a=>a.relation===n);s?s.value=r:t.changeMaps.push({relation:n,value:r})})}}class es extends M{constructor(){super("Nested sets do not support multiple root entities.")}}class dr{constructor(e){this.queryRunner=e}async insert(e){const t=c=>this.queryRunner.connection.driver.escape(c),n=this.getTableName(e.metadata.tablePath),r=t(e.metadata.nestedSetLeftColumn.databaseName),i=t(e.metadata.nestedSetRightColumn.databaseName);let s=e.metadata.treeParentRelation.getEntityValue(e.entity);!s&&e.parentSubject&&e.parentSubject.entity&&(s=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);const a=e.metadata.getEntityIdMap(s);let o;if(a&&(o=await this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.nestedSetRightColumn.propertyPath,"right").from(e.metadata.target,e.metadata.targetName).whereInIds(a).getRawOne().then(c=>{const u=c?c.right:void 0;return typeof u=="string"?parseInt(u):u})),o!==void 0)await this.queryRunner.query(`UPDATE ${n} SET ${r} = CASE WHEN ${r} > ${o} THEN ${r} + 2 ELSE ${r} END,${i} = ${i} + 2 WHERE ${i} >= ${o}`),K.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(o),e.metadata.nestedSetRightColumn.createValueMap(o+1));else{if(!await this.isUniqueRootEntity(e,s))throw new es;K.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(1),e.metadata.nestedSetRightColumn.createValueMap(2))}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(a=>Object.entries(e.identifier).every(([o,c])=>a[o]===c))),n===void 0||t===void 0)return;const r=e.metadata.treeParentRelation.getEntityValue(n),i=e.metadata.getEntityIdMap(r),s=e.metadata.getEntityIdMap(t);if(!K.compareIds(i,s)){if(t){const a=E=>this.queryRunner.connection.driver.escape(E),o=this.getTableName(e.metadata.tablePath),c=a(e.metadata.nestedSetLeftColumn.databaseName),u=a(e.metadata.nestedSetRightColumn.databaseName),l=e.metadata.getEntityIdMap(n);let h;l&&(h=(await this.getNestedSetIds(e.metadata,l))[0]);let f;if(s&&(f=(await this.getNestedSetIds(e.metadata,s))[0]),h!==void 0&&f!==void 0){const E=f.left>h.left,b=h.right-h.left+1;let A;E?A=f.left-h.right:A=f.right-h.left;const P=`WHEN ${c} >= ${h.left} AND ${c} < ${h.right} THEN ${c} + ${A} `,D=`WHEN ${u} > ${h.left} AND ${u} <= ${h.right} THEN ${u} + ${A} `;E?await this.queryRunner.query(`UPDATE ${o} SET ${c} = CASE WHEN ${c} > ${h.right} AND ${c} <= ${f.left} THEN ${c} - ${b} `+P+`ELSE ${c} END, ${u} = CASE WHEN ${u} > ${h.right} AND ${u} < ${f.left} THEN ${u} - ${b} `+D+`ELSE ${u} END`):await this.queryRunner.query(`UPDATE ${o} SET ${c} = CASE WHEN ${c} < ${h.left} AND ${c} > ${f.right} THEN ${c} + ${b} `+P+`ELSE ${c} END, ${u} = CASE WHEN ${u} < ${h.left} AND ${u} >= ${f.right} THEN ${u} + ${b} `+D+`ELSE ${u} END`)}}else if(!await this.isUniqueRootEntity(e,t))throw new es}}async remove(e){Array.isArray(e)||(e=[e]);const t=e[0].metadata,n=c=>this.queryRunner.connection.driver.escape(c),r=this.getTableName(t.tablePath),i=n(t.nestedSetLeftColumn.databaseName),s=n(t.nestedSetRightColumn.databaseName),a=[];for(const c of e){const u=t.getEntityIdMap(c.entity);u&&a.push(u)}const o=await this.getNestedSetIds(t,a);for(const c of o){const u=c.right-c.left+1;await this.queryRunner.query(`UPDATE ${r} SET ${i} = CASE WHEN ${i} > ${c.left} THEN ${i} - ${u} ELSE ${i} END, ${s} = CASE WHEN ${s} > ${c.right} THEN ${s} - ${u} ELSE ${s} END`)}}getNestedSetIds(e,t){const n={left:`${e.targetName}.${e.nestedSetLeftColumn.propertyPath}`,right:`${e.targetName}.${e.nestedSetRightColumn.propertyPath}`},r=this.queryRunner.manager.createQueryBuilder();return Object.entries(n).forEach(([i,s])=>{r.addSelect(s,i)}),r.from(e.target,e.targetName).whereInIds(t).orderBy(n.right,"DESC").getRawMany().then(i=>{const s=[];for(const a of i){const o={};for(const c of Object.keys(n)){const u=a?a[c]:void 0;o[c]=typeof u=="string"?parseInt(u):u}s.push(o)}return s})}async isUniqueRootEntity(e,t){const n=c=>this.queryRunner.connection.driver.escape(c),r=this.getTableName(e.metadata.tablePath),i=[],s=e.metadata.treeParentRelation.joinColumns.map(c=>{const u=n(c.databaseName),l=c.getEntityValue(t);if(l==null)return`${u} IS NULL`;i.push(l);const h=this.queryRunner.connection.driver.createParameter("entity_"+c.databaseName,i.length-1);return`${u} = ${h}`}).join(" AND "),a="count",o=await this.queryRunner.query(`SELECT COUNT(1) AS ${n(a)} FROM ${r} WHERE ${s}`,i,!0);return parseInt(o.records[0][a])===0}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}}class fr{constructor(e){this.queryRunner=e}async insert(e){const t={};e.metadata.closureJunctionTable.ancestorColumns.forEach(r=>{t[r.databaseName]=e.identifier}),e.metadata.closureJunctionTable.descendantColumns.forEach(r=>{t[r.databaseName]=e.identifier}),await this.queryRunner.manager.createQueryBuilder().insert().into(e.metadata.closureJunctionTable.tablePath).values(t).updateEntity(!1).callListeners(!1).execute();let n=e.metadata.treeParentRelation.getEntityValue(e.entity);if(!n&&e.parentSubject&&e.parentSubject.entity&&(n=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity),n){const r=l=>this.queryRunner.connection.driver.escape(l),i=this.getTableName(e.metadata.closureJunctionTable.tablePath),s=[],a=e.metadata.closureJunctionTable.ancestorColumns.map(l=>r(l.databaseName)),o=e.metadata.closureJunctionTable.descendantColumns.map(l=>r(l.databaseName)),c=e.metadata.primaryColumns.map(l=>(s.push(l.getEntityValue(e.insertedValueSet?e.insertedValueSet:e.entity)),this.queryRunner.connection.driver.createParameter("child_entity_"+l.databaseName,s.length-1))),u=e.metadata.closureJunctionTable.descendantColumns.map(l=>{const h=r(l.databaseName),f=l.referencedColumn.getEntityValue(n);if(!f)throw new qr(e.metadata.name);s.push(f);const E=this.queryRunner.connection.driver.createParameter("parent_entity_"+l.referencedColumn.databaseName,s.length-1);return`${h} = ${E}`});await this.queryRunner.query(`INSERT INTO ${i} (${[...a,...o].join(", ")}) SELECT ${a.join(", ")}, ${c.join(", ")} FROM ${i} WHERE ${u.join(" AND ")}`,s)}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(f=>Object.entries(e.identifier).every(([E,b])=>f[E]===b))),n===void 0||t===void 0)return;const r=e.metadata.treeParentRelation.getEntityValue(n),i=e.metadata.getEntityIdMap(r),s=e.metadata.getEntityIdMap(t);if(K.compareIds(i,s))return;const a=f=>this.queryRunner.connection.driver.escape(f),o=e.metadata.closureJunctionTable,c=o.ancestorColumns.map(f=>a(f.databaseName)),u=o.descendantColumns.map(f=>a(f.databaseName)),l=(f,E)=>{const b=`sub${E}`,A=f.createQueryBuilder().select(u.join(", ")).from(o.tablePath,b);for(const P of o.ancestorColumns)A.andWhere(`${a(b)}.${a(P.databaseName)} = :value_${P.referencedColumn.databaseName}`);return f.createQueryBuilder().select(u.join(", ")).from(`(${A.getQuery()})`,E).setParameters(A.getParameters()).getQuery()},h={};for(const f of e.metadata.primaryColumns)h[`value_${f.databaseName}`]=n[f.databaseName];if(await this.queryRunner.manager.createQueryBuilder().delete().from(o.tablePath).where(f=>`(${u.join(", ")}) IN (${l(f,"descendant")})`).andWhere(f=>`(${c.join(", ")}) NOT IN (${l(f,"ancestor")})`).setParameters(h).execute(),t){const f=[],E=this.getTableName(o.tablePath),b=a("supertree"),A=a("subtree"),P=[...c.map(W=>`${b}.${W}`),...u.map(W=>`${A}.${W}`)],D=e.metadata.closureJunctionTable.ancestorColumns.map(W=>{const G=a(W.databaseName),ie=W.referencedColumn.getEntityValue(n);f.push(ie);const ne=this.queryRunner.connection.driver.createParameter("entity_"+W.referencedColumn.databaseName,f.length-1);return`${A}.${G} = ${ne}`}),I=e.metadata.closureJunctionTable.descendantColumns.map(W=>{const G=a(W.databaseName),ie=W.referencedColumn.getEntityValue(t);if(!ie)throw new qr(e.metadata.name);f.push(ie);const ne=this.queryRunner.connection.driver.createParameter("parent_entity_"+W.referencedColumn.databaseName,f.length-1);return`${b}.${G} = ${ne}`});await this.queryRunner.query(`INSERT INTO ${E} (${[...c,...u].join(", ")}) SELECT ${P.join(", ")} FROM ${E} AS ${b}, ${E} AS ${A} WHERE ${[...D,...I].join(" AND ")}`,f)}}async remove(e){if(this.queryRunner.connection.driver.options.type!=="mssql")return;Array.isArray(e)||(e=[e]);const t=o=>this.queryRunner.connection.driver.escape(o),n=e.map(o=>o.identifier),r=e[0].metadata.closureJunctionTable,i=o=>o.map(c=>{const u=n.map(l=>l[c.referencedColumn.databaseName]);return`${t(c.databaseName)} IN (${u.join(", ")})`}).join(" AND "),s=i(r.ancestorColumns),a=i(r.descendantColumns);await this.queryRunner.manager.createQueryBuilder().delete().from(r.tablePath).where(s).orWhere(a).execute()}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}}class st{constructor(e){this["@instanceof"]=Symbol.for("EntityMetadata"),this.childEntityMetadatas=[],this.inheritanceTree=[],this.tableType="regular",this.withoutRowid=!1,this.synchronize=!0,this.hasNonNullableRelations=!1,this.isJunction=!1,this.isAlwaysUsingConstructor=!0,this.isClosureJunction=!1,this.hasMultiplePrimaryKeys=!1,this.hasUUIDGeneratedColumns=!1,this.ownColumns=[],this.columns=[],this.ancestorColumns=[],this.descendantColumns=[],this.nonVirtualColumns=[],this.ownerColumns=[],this.inverseColumns=[],this.generatedColumns=[],this.primaryColumns=[],this.ownRelations=[],this.relations=[],this.eagerRelations=[],this.lazyRelations=[],this.oneToOneRelations=[],this.ownerOneToOneRelations=[],this.oneToManyRelations=[],this.manyToOneRelations=[],this.manyToManyRelations=[],this.ownerManyToManyRelations=[],this.relationsWithJoinColumns=[],this.relationIds=[],this.relationCounts=[],this.foreignKeys=[],this.embeddeds=[],this.allEmbeddeds=[],this.ownIndices=[],this.indices=[],this.uniques=[],this.ownUniques=[],this.checks=[],this.exclusions=[],this.ownListeners=[],this.listeners=[],this.afterLoadListeners=[],this.beforeInsertListeners=[],this.afterInsertListeners=[],this.beforeUpdateListeners=[],this.afterUpdateListeners=[],this.beforeRemoveListeners=[],this.beforeSoftRemoveListeners=[],this.beforeRecoverListeners=[],this.afterRemoveListeners=[],this.afterSoftRemoveListeners=[],this.afterRecoverListeners=[],this.connection=e.connection,this.inheritanceTree=e.inheritanceTree||[],this.inheritancePattern=e.inheritancePattern,this.treeType=e.tableTree?e.tableTree.type:void 0,this.treeOptions=e.tableTree?e.tableTree.options:void 0,this.parentClosureEntityMetadata=e.parentClosureEntityMetadata,this.tableMetadataArgs=e.args,this.target=this.tableMetadataArgs.target,this.tableType=this.tableMetadataArgs.type,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid,this.dependsOn=this.tableMetadataArgs.dependsOn}create(e,t){const n=!!(t&&t.pojo===!0);let r;return typeof this.target=="function"&&!n?!t?.fromDeserializer||this.isAlwaysUsingConstructor?r=new this.target:r=Object.create(this.target.prototype):r={},this.connection.options.typename&&(r[this.connection.options.typename]=this.targetName),this.lazyRelations.forEach(i=>this.connection.relationLoader.enableLazyLoad(i,r,e)),r}hasId(e){return e?this.primaryColumns.every(t=>{const n=t.getEntityValue(e);return n!=null&&n!==""}):!1}hasAllPrimaryKeys(e){return this.primaryColumns.every(t=>{const n=t.getEntityValue(e);return n!=null})}ensureEntityIdMap(e){if(me.isObject(e))return e;if(this.hasMultiplePrimaryKeys)throw new Zs(this,e);return this.primaryColumns[0].createValueMap(e)}getEntityIdMap(e){if(e)return st.getValueMap(e,this.primaryColumns,{skipNulls:!0})}getEntityIdMixedMap(e){if(!e)return e;const t=this.getEntityIdMap(e);return this.hasMultiplePrimaryKeys?t:t&&this.primaryColumns[0].getEntityValue(t)}compareEntities(e,t){const n=this.getEntityIdMap(e);if(!n)return!1;const r=this.getEntityIdMap(t);return r?K.compareIds(n,r):!1}findColumnWithPropertyName(e){return this.columns.find(t=>t.propertyName===e)}findColumnWithDatabaseName(e){return this.columns.find(t=>t.databaseName===e)}hasColumnWithPropertyPath(e){return this.columns.some(n=>n.propertyPath===e)||this.hasRelationWithPropertyPath(e)}findColumnWithPropertyPath(e){const t=this.columns.find(r=>r.propertyPath===e);if(t)return t;const n=this.relations.find(r=>r.propertyPath===e);if(n&&n.joinColumns.length===1)return n.joinColumns[0]}findColumnWithPropertyPathStrict(e){return this.columns.find(t=>t.propertyPath===e)}findColumnsWithPropertyPath(e){const t=this.columns.find(r=>r.propertyPath===e);if(t)return[t];const n=this.findRelationWithPropertyPath(e);return n&&n.joinColumns?n.joinColumns:[]}hasRelationWithPropertyPath(e){return this.relations.some(t=>t.propertyPath===e)}findRelationWithPropertyPath(e){return this.relations.find(t=>t.propertyPath===e)}hasEmbeddedWithPropertyPath(e){return this.allEmbeddeds.some(t=>t.propertyPath===e)}findEmbeddedWithPropertyPath(e){return this.allEmbeddeds.find(t=>t.propertyPath===e)}mapPropertyPathsToColumns(e){return e.map(t=>{const n=this.findColumnWithPropertyPath(t);if(n==null)throw new nt(t,this);return n})}extractRelationValuesFromEntity(e,t){const n=[];return t.forEach(r=>{const i=r.getEntityValue(e);Array.isArray(i)?i.forEach(s=>n.push([r,s,st.getInverseEntityMetadata(s,r)])):i&&n.push([r,i,st.getInverseEntityMetadata(i,r)])}),n}findInheritanceMetadata(e){if(this.inheritancePattern==="STI"&&this.childEntityMetadatas.length>0){let t;return this.discriminatorColumn&&(t=e[this.discriminatorColumn.propertyName]),this.childEntityMetadatas.find(n=>t===n.discriminatorValue||e.constructor===n.target)||this}return this}static getInverseEntityMetadata(e,t){return t.inverseEntityMetadata.findInheritanceMetadata(e)}static createPropertyPath(e,t,n=""){const r=[];return Object.keys(t).forEach(i=>{const s=n?n+"."+i:i;if(e.hasEmbeddedWithPropertyPath(s)){const a=this.createPropertyPath(e,t[i],s);r.push(...a)}else{const a=n?n+"."+i:i;r.push(a)}}),r}static difference(e,t){return e.filter(n=>!t.find(r=>K.compareIds(n,r)))}static getValueMap(e,t,n){return t.reduce((r,i)=>{const s=i.getEntityValueMap(e,n);if(!(r===void 0||s===null||s===void 0))return K.mergeDeep(r,s)},{})}build(){const e=this.connection.namingStrategy,t=this.connection.options.entityPrefix,n=this.connection.options.entitySkipConstructor;this.engine=this.tableMetadataArgs.engine,this.database=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.database:this.tableMetadataArgs.database,this.tableMetadataArgs.schema?this.schema=this.tableMetadataArgs.schema:this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.schema=this.parentEntityMetadata.schema:this.connection.options?.hasOwnProperty("schema")&&(this.schema=this.connection.options.schema),this.givenTableName=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.givenTableName:this.tableMetadataArgs.name,this.synchronize=this.tableMetadataArgs.synchronize!==!1,this.targetName=typeof this.tableMetadataArgs.target=="function"?this.tableMetadataArgs.target.name:this.tableMetadataArgs.target,this.tableMetadataArgs.type==="closure-junction"?this.tableNameWithoutPrefix=e.closureJunctionTableName(this.givenTableName):this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.tableNameWithoutPrefix=e.tableName(this.parentEntityMetadata.targetName,this.parentEntityMetadata.givenTableName):(this.tableNameWithoutPrefix=e.tableName(this.targetName,this.givenTableName),this.tableMetadataArgs.type==="junction"&&this.connection.driver.maxAliasLength&&this.connection.driver.maxAliasLength>0&&this.tableNameWithoutPrefix.length>this.connection.driver.maxAliasLength&&(this.tableNameWithoutPrefix=$s(this.tableNameWithoutPrefix,{separator:"_",segmentLength:3}))),this.tableName=t?e.prefixTableName(t,this.tableNameWithoutPrefix):this.tableNameWithoutPrefix,this.target=this.target?this.target:this.tableName,this.name=this.targetName?this.targetName:this.tableName,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid===!0,this.tablePath=this.connection.driver.buildTableName(this.tableName,this.schema,this.database),this.orderBy=typeof this.tableMetadataArgs.orderBy=="function"?this.tableMetadataArgs.orderBy(this.propertiesMap):this.tableMetadataArgs.orderBy,n!==void 0&&(this.isAlwaysUsingConstructor=!n),this.isJunction=this.tableMetadataArgs.type==="closure-junction"||this.tableMetadataArgs.type==="junction",this.isClosureJunction=this.tableMetadataArgs.type==="closure-junction",this.comment=this.tableMetadataArgs.comment}registerColumn(e){this.ownColumns.indexOf(e)===-1&&(this.ownColumns.push(e),this.columns=this.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),this.ownColumns),this.primaryColumns=this.columns.filter(t=>t.isPrimary),this.hasMultiplePrimaryKeys=this.primaryColumns.length>1,this.hasUUIDGeneratedColumns=this.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,this.propertiesMap=this.createPropertiesMap(),this.childEntityMetadatas&&this.childEntityMetadatas.forEach(t=>t.registerColumn(e)))}createPropertiesMap(){const e={};return this.columns.forEach(t=>K.mergeDeep(e,t.createValueMap(t.propertyPath))),this.relations.forEach(t=>K.mergeDeep(e,t.createValueMap(t.propertyPath))),e}getInsertionReturningColumns(){return this.columns.filter(e=>e.default!==void 0||e.asExpression!==void 0||e.isGenerated||e.isCreateDate||e.isUpdateDate||e.isDeleteDate||e.isVersion)}}class ts{constructor(e){this.queryRunner=e}async insert(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);const n=e.metadata.getEntityIdMap(t);let r="";n&&(r=await this.getEntityPath(e,n));const i=e.metadata.treeParentRelation.joinColumns.map(s=>s.referencedColumn.getEntityValue(e.insertedValueSet)).join("_");await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[e.metadata.materializedPathColumn.propertyPath]:r+i+"."}).where(e.identifier).execute()}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(l=>Object.entries(e.identifier).every(([h,f])=>l[h]===f)));const r=e.metadata.treeParentRelation.getEntityValue(n),i=this.getEntityParentReferencedColumnMap(e,r),s=this.getEntityParentReferencedColumnMap(e,t);if(K.compareIds(i,s))return;let a="";s&&(a=await this.getEntityPath(e,s));let o="";i&&(o=await this.getEntityPath(e,i)||"");const c=e.metadata.treeParentRelation.joinColumns.map(l=>l.referencedColumn.getEntityValue(n)).join("_"),u=e.metadata.materializedPathColumn.propertyPath;await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[u]:()=>`REPLACE(${this.queryRunner.connection.driver.escape(u)}, '${o}${c}.', '${a}${c}.')`}).where(`${u} LIKE :path`,{path:`${o}${c}.%`}).execute()}getEntityParentReferencedColumnMap(e,t){if(t)return st.getValueMap(t,e.metadata.treeParentRelation.joinColumns.map(n=>n.referencedColumn).filter(n=>n!=null),{skipNulls:!0})}getEntityPath(e,t){const n=e.metadata,r=(Array.isArray(t)?t:[t]).map(i=>n.ensureEntityIdMap(i));return this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.materializedPathColumn.propertyPath,"path").from(e.metadata.target,e.metadata.targetName).where(new Ht(i=>{for(const s of r)i.orWhere(new Ht(a=>a.where(s)))})).getRawOne().then(i=>i?i.path:"")}}class oc{constructor(e,t,n){this.hasExecutableOperations=!1,this.insertSubjects=[],this.updateSubjects=[],this.removeSubjects=[],this.softRemoveSubjects=[],this.recoverSubjects=[],this.queryRunner=e,this.allSubjects=t,this.options=n,this.validate(),this.recompute()}async execute(){let e;(!this.options||this.options.listeners!==!1)&&(e=this.broadcastBeforeEventsForAll(),e.promises.length>0&&await Promise.all(e.promises)),e&&e.count>0&&(this.insertSubjects.forEach(t=>t.recompute()),this.updateSubjects.forEach(t=>t.recompute()),this.removeSubjects.forEach(t=>t.recompute()),this.softRemoveSubjects.forEach(t=>t.recompute()),this.recoverSubjects.forEach(t=>t.recompute()),this.recompute()),this.insertSubjects=new Xi(this.insertSubjects).sort("insert"),await this.executeInsertOperations(),this.updateSubjects=this.allSubjects.filter(t=>t.mustBeUpdated),await this.executeUpdateOperations(),this.removeSubjects=new Xi(this.removeSubjects).sort("delete"),await this.executeRemoveOperations(),this.softRemoveSubjects=this.allSubjects.filter(t=>t.mustBeSoftRemoved),await this.executeSoftRemoveOperations(),this.recoverSubjects=this.allSubjects.filter(t=>t.mustBeRecovered),await this.executeRecoverOperations(),this.updateSpecialColumnsInPersistedEntities(),(!this.options||this.options.listeners!==!1)&&(e=this.broadcastAfterEventsForAll(),e.promises.length>0&&await Promise.all(e.promises))}validate(){this.allSubjects.forEach(e=>{if(e.mustBeUpdated&&e.mustBeRemoved)throw new Ea(e)})}recompute(){new ac().compute(this.allSubjects),this.insertSubjects=this.allSubjects.filter(e=>e.mustBeInserted),this.updateSubjects=this.allSubjects.filter(e=>e.mustBeUpdated),this.removeSubjects=this.allSubjects.filter(e=>e.mustBeRemoved),this.softRemoveSubjects=this.allSubjects.filter(e=>e.mustBeSoftRemoved),this.recoverSubjects=this.allSubjects.filter(e=>e.mustBeRecovered),this.hasExecutableOperations=this.insertSubjects.length>0||this.updateSubjects.length>0||this.removeSubjects.length>0||this.softRemoveSubjects.length>0||this.recoverSubjects.length>0}broadcastBeforeEventsForAll(){const e=new Xe;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeInsertEvent(e,t.metadata,t.entity)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}broadcastAfterEventsForAll(){const e=new Xe;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterInsertEvent(e,t.metadata,t.entity,t.identifier)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}async executeInsertOperations(){const[e,t]=this.groupBulkSubjects(this.insertSubjects,"insert");for(const n of t){const r=e[n],i=[],s=[],a=[];if(this.queryRunner.connection.driver.options.type==="mongodb"?r.forEach(o=>{o.metadata.createDateColumn&&o.entity&&(o.entity[o.metadata.createDateColumn.databaseName]=new Date),o.metadata.updateDateColumn&&o.entity&&(o.entity[o.metadata.updateDateColumn.databaseName]=new Date),o.createValueSetAndPopChangeMap(),s.push(o),i.push(o.entity)}):this.queryRunner.connection.driver.options.type==="oracle"?r.forEach(o=>{a.push(o)}):r.forEach(o=>{o.changeMaps.length===0||o.metadata.treeType||this.queryRunner.connection.driver.options.type==="oracle"||this.queryRunner.connection.driver.options.type==="sap"?a.push(o):(s.push(o),i.push(o.createValueSetAndPopChangeMap()))}),q.isMongoEntityManager(this.queryRunner.manager)){const o=await this.queryRunner.manager.insert(r[0].metadata.target,i);r.forEach((c,u)=>{c.identifier=o.identifiers[u],c.generatedMap=o.generatedMaps[u],c.insertedValueSet=i[u]})}else{if(i.length>0){const o=await this.queryRunner.manager.createQueryBuilder().insert().into(r[0].metadata.target).values(i).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute();s.forEach((c,u)=>{c.identifier=o.identifiers[u],c.generatedMap=o.generatedMaps[u],c.insertedValueSet=i[u]})}if(a.length>0)for(const o of a)o.insertedValueSet=o.createValueSetAndPopChangeMap(),o.metadata.treeType==="nested-set"&&await new dr(this.queryRunner).insert(o),await this.queryRunner.manager.createQueryBuilder().insert().into(o.metadata.target).values(o.insertedValueSet).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute().then(c=>{o.identifier=c.identifiers[0],o.generatedMap=c.generatedMaps[0]}),o.metadata.treeType==="closure-table"?await new fr(this.queryRunner).insert(o):o.metadata.treeType==="materialized-path"&&await new ts(this.queryRunner).insert(o)}r.forEach(o=>{o.generatedMap&&o.metadata.columns.forEach(c=>{const u=c.getEntityValue(o.generatedMap);if(u!=null){const l=this.queryRunner.connection.driver.prepareHydratedValue(u,c);c.setEntityValue(o.generatedMap,l)}})})}}async executeUpdateOperations(){const e=async i=>{if(!i.identifier)throw new qt(i);if(q.isMongoEntityManager(this.queryRunner.manager)){const s=this.cloneMongoSubjectEntity(i);i.metadata.objectIdColumn&&i.metadata.objectIdColumn.propertyName&&delete s[i.metadata.objectIdColumn.propertyName],i.metadata.createDateColumn&&i.metadata.createDateColumn.propertyName&&delete s[i.metadata.createDateColumn.propertyName],i.metadata.updateDateColumn&&i.metadata.updateDateColumn.propertyName&&(s[i.metadata.updateDateColumn.propertyName]=new Date),await this.queryRunner.manager.update(i.metadata.target,i.identifier,s)}else{const s=i.createValueSetAndPopChangeMap();switch(i.metadata.treeType){case"nested-set":await new dr(this.queryRunner).update(i);break;case"closure-table":await new fr(this.queryRunner).update(i);break;case"materialized-path":await new ts(this.queryRunner).update(i);break}const a=this.queryRunner.manager.createQueryBuilder().update(i.metadata.target).set(s).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);i.entity?a.whereEntity(i.identifier):a.where(i.identifier);const c=(await a.execute()).generatedMaps[0];c&&(i.metadata.columns.forEach(u=>{const l=u.getEntityValue(c);if(l!=null){const h=this.queryRunner.connection.driver.prepareHydratedValue(l,u);u.setEntityValue(c,h)}}),i.generatedMap||(i.generatedMap={}),Object.assign(i.generatedMap,c))}},t=[],n=[];for(const i of this.updateSubjects)i.metadata.treeType==="nested-set"?t.push(i):n.push(i);const r=async()=>{for(const i of t)await e(i)};await Promise.all([...n.map(e),r()])}async executeRemoveOperations(){const[e,t]=this.groupBulkSubjects(this.removeSubjects,"delete");for(const n of t){const r=e[n],i=r.map(s=>{if(!s.identifier)throw new qt(s);return s.identifier});if(q.isMongoEntityManager(this.queryRunner.manager))await this.queryRunner.manager.delete(r[0].metadata.target,i);else{switch(r[0].metadata.treeType){case"nested-set":await new dr(this.queryRunner).remove(r);break;case"closure-table":await new fr(this.queryRunner).remove(r);break}await this.queryRunner.manager.createQueryBuilder().delete().from(r[0].metadata.target).where(i).callListeners(!1).execute()}}}cloneMongoSubjectEntity(e){const t={};if(e.entity)for(const n of e.metadata.columns)K.mergeDeep(t,n.getEntityValueMap(e.entity));return t}async executeSoftRemoveOperations(){await Promise.all(this.softRemoveSubjects.map(async e=>{if(!e.identifier)throw new qt(e);let t;if(q.isMongoEntityManager(this.queryRunner.manager)){const n=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete n[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete n[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(n[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(n[e.metadata.deleteDateColumn.propertyName]=new Date),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,n)}else{const n=this.queryRunner.manager.createQueryBuilder().softDelete().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{const r=n.getEntityValue(e.generatedMap);if(r!=null){const i=this.queryRunner.connection.driver.prepareHydratedValue(r,n);n.setEntityValue(e.generatedMap,i)}})}))}async executeRecoverOperations(){await Promise.all(this.recoverSubjects.map(async e=>{if(!e.identifier)throw new qt(e);let t;if(q.isMongoEntityManager(this.queryRunner.manager)){const n=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete n[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete n[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(n[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(n[e.metadata.deleteDateColumn.propertyName]=null),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,n)}else{const n=this.queryRunner.manager.createQueryBuilder().restore().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{const r=n.getEntityValue(e.generatedMap);if(r!=null){const i=this.queryRunner.connection.driver.prepareHydratedValue(r,n);n.setEntityValue(e.generatedMap,i)}})}))}updateSpecialColumnsInPersistedEntities(){this.insertSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.insertSubjects),this.updateSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.updateSubjects),this.softRemoveSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.softRemoveSubjects),this.recoverSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.recoverSubjects),this.removeSubjects.length&&this.removeSubjects.forEach(e=>{e.entity&&e.metadata.primaryColumns.forEach(t=>{t.setEntityValue(e.entity,void 0)})}),this.allSubjects.forEach(e=>{e.entity&&(e.metadata.relationIds.forEach(t=>{t.setValue(e.entity)}),q.isMongoEntityManager(this.queryRunner.manager)&&e.metadata.objectIdColumn&&e.metadata.objectIdColumn.databaseName&&e.metadata.objectIdColumn.databaseName!==e.metadata.objectIdColumn.propertyName&&delete e.entity[e.metadata.objectIdColumn.databaseName])})}updateSpecialColumnsInInsertedAndUpdatedEntities(e){e.forEach(t=>{t.entity&&(t.metadata.columns.forEach(n=>{t.metadata.childEntityMetadatas.length>0&&t.metadata.childEntityMetadatas.map(r=>r.target).indexOf(n.target)!==-1||n.isVirtual||n.isDeleteDate||(n.isNullable&&n.getEntityValue(t.entity)===void 0&&n.setEntityValue(t.entity,null),t.updatedRelationMaps.length>0&&t.updatedRelationMaps.forEach(r=>{r.relation.joinColumns.forEach(i=>{i.isVirtual!==!0&&i.setEntityValue(t.entity,me.isObject(r.value)?i.referencedColumn.getEntityValue(r.value):r.value)})}))}),t.generatedMap&&this.queryRunner.manager.merge(t.metadata.target,t.entity,t.generatedMap))})}groupBulkSubjects(e,t){const n={},r=[],i=e.some(a=>a.metadata.getInsertionReturningColumns().length>0),s=t==="delete"||this.queryRunner.connection.driver.isReturningSqlSupported("insert")||i===!1;return e.forEach((a,o)=>{const c=s||a.metadata.isJunction?a.metadata.name:a.metadata.name+"_"+o;n[c]?n[c].push(a):(n[c]=[a],r.push(c))}),[n,r]}}class lt{constructor(e){this["@instanceof"]=Symbol.for("Subject"),this.identifier=void 0,this.entityWithFulfilledIds=void 0,this.databaseEntityLoaded=!1,this.changeMaps=[],this.canBeInserted=!1,this.canBeUpdated=!1,this.mustBeRemoved=!1,this.canBeSoftRemoved=!1,this.canBeRecovered=!1,this.updatedRelationMaps=[],this.diffColumns=[],this.diffRelations=[],this.metadata=e.metadata,this.entity=e.entity,this.parentSubject=e.parentSubject,e.canBeInserted!==void 0&&(this.canBeInserted=e.canBeInserted),e.canBeUpdated!==void 0&&(this.canBeUpdated=e.canBeUpdated),e.mustBeRemoved!==void 0&&(this.mustBeRemoved=e.mustBeRemoved),e.canBeSoftRemoved!==void 0&&(this.canBeSoftRemoved=e.canBeSoftRemoved),e.canBeRecovered!==void 0&&(this.canBeRecovered=e.canBeRecovered),e.identifier!==void 0&&(this.identifier=e.identifier),e.changeMaps!==void 0&&this.changeMaps.push(...e.changeMaps),this.recompute()}get mustBeInserted(){return this.canBeInserted&&!this.databaseEntity}get mustBeUpdated(){return this.canBeUpdated&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)&&this.changeMaps.some(e=>!e.column||e.column.isUpdate)}get mustBeSoftRemoved(){return this.canBeSoftRemoved&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}get mustBeRecovered(){return this.canBeRecovered&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}createValueSetAndPopChangeMap(){const e=[],t=this.changeMaps.reduce((n,r)=>{let i=r.value;q.isSubject(i)&&(i=i.insertedValueSet?i.insertedValueSet:i.entity);let s;if(this.metadata.isJunction&&r.column)s=r.column.createValueMap(r.column.referencedColumn.getEntityValue(i));else if(r.column)s=r.column.createValueMap(i);else if(r.relation)if(me.isObject(i)&&!Buffer.isBuffer(i)){const a=r.relation.getRelationIdMap(i);if(a===void 0)return e.push(r),this.canBeUpdated=!0,n;s=r.relation.createValueMap(a),this.updatedRelationMaps.push({relation:r.relation,value:a})}else s=r.relation.createValueMap(i),this.updatedRelationMaps.push({relation:r.relation,value:i});return K.mergeDeep(n,s),n},{});return this.changeMaps=e,t}recompute(){this.entity?(this.entityWithFulfilledIds=Object.assign({},this.entity),this.parentSubject&&this.metadata.primaryColumns.forEach(e=>{if(e.relationMetadata&&e.relationMetadata.inverseEntityMetadata===this.parentSubject.metadata){const t=e.referencedColumn.getEntityValue(this.parentSubject.entity);e.setEntityValue(this.entityWithFulfilledIds,t)}}),this.identifier=this.metadata.getEntityIdMap(this.entityWithFulfilledIds)):this.databaseEntity&&(this.identifier=this.metadata.getEntityIdMap(this.databaseEntity))}}class cc{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let n=[];if(e.databaseEntity){const s=t.getEntityValue(e.databaseEntity);s&&(n=s.map(a=>t.inverseEntityMetadata.getEntityIdMap(a)))}let r=t.getEntityValue(e.entity);if(r===null&&(r=[]),r===void 0)return;const i=[];r.forEach(s=>{let a=t.inverseEntityMetadata.getEntityIdMap(s),o=this.subjects.find(u=>u.entity===s);if(o&&(a=o.identifier),!a){if(!o)return;o.changeMaps.push({relation:t.inverseRelation,value:e});return}n.find(u=>K.compareIds(a,u))||(o||(o=new lt({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:a}),this.subjects.push(o)),o.changeMaps.push({relation:t.inverseRelation,value:e})),i.push(a)}),t.inverseRelation?.orphanedRowAction!=="disable"&&st.difference(n,i).forEach(s=>{const a=new lt({metadata:t.inverseEntityMetadata,parentSubject:e,identifier:s});!t.inverseRelation||t.inverseRelation.orphanedRowAction==="nullify"?(a.canBeUpdated=!0,a.changeMaps=[{relation:t.inverseRelation,value:null}]):t.inverseRelation.orphanedRowAction==="delete"?a.mustBeRemoved=!0:t.inverseRelation.orphanedRowAction==="soft-delete"&&(a.canBeSoftRemoved=!0),this.subjects.push(a)})}}class uc{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToOneRelations.forEach(t=>{t.isOwning||t.persistenceEnabled===!1||this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let n;e.databaseEntity&&(n=t.getEntityValue(e.databaseEntity));const r=t.getEntityValue(e.entity);if(r===void 0)return;if(r===null){if(n){const o=new lt({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:n,changeMaps:[{relation:t.inverseRelation,value:null}]});this.subjects.push(o)}return}let i=t.inverseEntityMetadata.getEntityIdMap(r),s=this.subjects.find(o=>!!o.entity&&o.entity===r);if(s&&(i=s.identifier),!i){if(!s)return;s.changeMaps.push({relation:t.inverseRelation,value:e})}n&&K.compareIds(i,n)||(s||(s=new lt({metadata:t.inverseEntityMetadata,canBeUpdated:!0,identifier:i}),this.subjects.push(s)),s.changeMaps.push({relation:t.inverseRelation,value:e}))}}class ns{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.entity&&e.metadata.manyToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForAllRemoval(e){e.databaseEntity&&e.metadata.manyToManyRelations.forEach(t=>{if(t.persistenceEnabled===!1)return;t.getEntityValue(e.databaseEntity).forEach(r=>{const i=new lt({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,r)});this.subjects.push(i)})})}buildForSubjectRelation(e,t){let n=[];if(e.databaseEntity){const a=t.getEntityValue(e.databaseEntity);a&&(n=a.map(o=>t.inverseEntityMetadata.getEntityIdMap(o)))}let r=t.getEntityValue(e.entity);if(r===null&&(r=[]),!Array.isArray(r))return;r.forEach(a=>{let o=t.inverseEntityMetadata.getEntityIdMap(a);const c=this.subjects.find(E=>E.entity===a);if(c&&(o=c.identifier),!o&&!c||n.find(E=>K.compareIds(E,o)))return;const l=t.isOwning?e:c||a,h=t.isOwning?c||a:e,f=new lt({metadata:t.junctionEntityMetadata,parentSubject:e,canBeInserted:!0});this.subjects.push(f),t.junctionEntityMetadata.ownerColumns.forEach(E=>{f.changeMaps.push({column:E,value:l})}),t.junctionEntityMetadata.inverseColumns.forEach(E=>{f.changeMaps.push({column:E,value:h})})});const i=[];r.forEach(a=>{let o=t.inverseEntityMetadata.getEntityIdMap(a);const c=this.subjects.find(u=>u.entity===a);c&&(o=c.identifier),o!=null&&i.push(o)}),n.filter(a=>!i.find(o=>K.compareIds(o,a))).forEach(a=>{const o=new lt({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,a)});this.subjects.push(o)})}buildJunctionIdentifier(e,t,n){const r=t.isOwning?e.entity:n,i=t.isOwning?n:e.entity,s={};return t.junctionEntityMetadata.ownerColumns.forEach(a=>{K.mergeDeep(s,a.createValueMap(a.referencedColumn.getEntityValue(r)))}),t.junctionEntityMetadata.inverseColumns.forEach(a=>{K.mergeDeep(s,a.createValueMap(a.referencedColumn.getEntityValue(i)))}),s}}class lc{constructor(e,t){this.queryRunner=e,this.subjects=t}async load(e){const t=this.groupByEntityTargets().map(async n=>{const r=[],i=[];if(n.subjects.forEach(c=>{c.databaseEntity||!c.identifier||(r.push(c.identifier),i.push(c))}),!r.length)return;const s=[];e==="save"||e==="soft-remove"||e==="recover"?n.subjects.forEach(c=>{c.metadata.relations.forEach(u=>{u.getEntityValue(c.entityWithFulfilledIds)!==void 0&&s.indexOf(u.propertyPath)===-1&&s.push(u.propertyPath)})}):s.push(...n.subjects[0].metadata.manyToManyRelations.map(c=>c.propertyPath));const a={loadEagerRelations:!1,loadRelationIds:{relations:s,disableMixedMap:!0},withDeleted:!0};let o=[];this.queryRunner.connection.driver.options.type==="mongodb"?o=await this.queryRunner.manager.getRepository(n.target).findByIds(r,a):o=await this.queryRunner.manager.getRepository(n.target).createQueryBuilder().setFindOptions(a).whereInIds(r).getMany(),o.forEach(c=>{const u=i[0].metadata.getEntityIdMap(c);i.forEach(l=>{l.databaseEntity||K.compareIds(l.identifier,u)&&(l.databaseEntity=c)})});for(const c of i)c.databaseEntityLoaded=!0});await Promise.all(t)}groupByEntityTargets(){return this.subjects.reduce((e,t)=>{let n=e.find(r=>r.target===t.metadata.target);return n||(n={target:t.metadata.target,subjects:[]},e.push(n)),n.subjects.push(t),e},[])}}class hc{constructor(e){this.allSubjects=e}build(e,t){e.metadata.extractRelationValuesFromEntity(e.entity,e.metadata.relations).forEach(([n,r,i])=>{if(r==null||!n.isCascadeInsert&&!n.isCascadeUpdate&&!n.isCascadeSoftRemove&&!n.isCascadeRecover||!me.isObject(r))return;const s=this.findByPersistEntityLike(i.target,r);if(s){s.canBeInserted===!1&&(s.canBeInserted=n.isCascadeInsert===!0&&t==="save"),s.canBeUpdated===!1&&(s.canBeUpdated=n.isCascadeUpdate===!0&&t==="save"),s.canBeSoftRemoved===!1&&(s.canBeSoftRemoved=n.isCascadeSoftRemove===!0&&t==="soft-remove"),s.canBeRecovered===!1&&(s.canBeRecovered=n.isCascadeRecover===!0&&t==="recover");return}const a=new lt({metadata:i,parentSubject:e,entity:r,canBeInserted:n.isCascadeInsert===!0&&t==="save",canBeUpdated:n.isCascadeUpdate===!0&&t==="save",canBeSoftRemoved:n.isCascadeSoftRemove===!0&&t==="soft-remove",canBeRecovered:n.isCascadeRecover===!0&&t==="recover"});this.allSubjects.push(a),this.build(a,t)})}findByPersistEntityLike(e,t){return this.allSubjects.find(n=>n.entity?n.entity===t?!0:n.metadata.target===e&&n.metadata.compareEntities(n.entityWithFulfilledIds,t):!1)}}class Bt{constructor(e,t,n,r,i,s){this.connection=e,this.queryRunner=t,this.mode=n,this.target=r,this.entity=i,this.options=s}async execute(){if(!this.entity||typeof this.entity!="object")return Promise.reject(new ia(this.mode,this.entity));await Promise.resolve();const e=this.queryRunner||this.connection.createQueryRunner(),t=e.data;this.options&&this.options.data&&(e.data=this.options.data);try{const n=Array.isArray(this.entity)?this.entity:[this.entity],r=this.options&&this.options.chunk&&this.options.chunk>0?K.chunk(n,this.options.chunk):[n],s=(await Promise.all(r.map(async o=>{const c=[];o.forEach(l=>{const h=this.target?this.target:l.constructor;if(h===Object)throw new ea(this.mode);const f=this.connection.getMetadata(h).findInheritanceMetadata(l);c.push(new lt({metadata:f,entity:l,canBeInserted:this.mode==="save",canBeUpdated:this.mode==="save",mustBeRemoved:this.mode==="remove",canBeSoftRemoved:this.mode==="soft-remove",canBeRecovered:this.mode==="recover"}))});const u=new hc(c);return c.forEach(l=>{u.build(l,this.mode)}),await new lc(e,c).load(this.mode),this.mode==="save"||this.mode==="soft-remove"||this.mode==="recover"?(new cc(c).build(),new uc(c).build(),new ns(c).build()):c.forEach(l=>{l.mustBeRemoved&&new ns(c).buildForAllRemoval(l)}),new oc(e,c,this.options)}))).filter(o=>o.hasExecutableOperations);if(s.length===0)return;let a=!1;try{e.isTransactionActive||this.connection.driver.transactionSupport!=="none"&&(!this.options||this.options.transaction!==!1)&&(a=!0,await e.startTransaction());for(const o of s)await o.execute();a===!0&&await e.commitTransaction()}catch(o){if(a)try{await e.rollbackTransaction()}catch{}throw o}}finally{e.data=t,this.queryRunner||await e.release()}}}class Vs{constructor(e,t){this["@instanceof"]=Symbol.for("EntityManager"),this.repositories=new Map,this.treeRepositories=[],this.plainObjectToEntityTransformer=new Yo,this.connection=e,t&&(this.queryRunner=t,me.assign(this.queryRunner,{manager:this}))}async transaction(e,t){const n=typeof e=="string"?e:void 0,r=typeof e=="function"?e:t;if(!r)throw new M("Transaction method requires callback in second parameter if isolation level is supplied.");if(this.queryRunner&&this.queryRunner.isReleased)throw new As;const i=this.queryRunner||this.connection.createQueryRunner();try{await i.startTransaction(n);const s=await r(i.manager);return await i.commitTransaction(),s}catch(s){try{await i.rollbackTransaction()}catch{}throw s}finally{this.queryRunner||await i.release()}}async query(e,t){return this.connection.query(e,t,this.queryRunner)}async sql(e,...t){const{query:n,parameters:r}=Xt({driver:this.connection.driver,strings:e,expressions:t});return await this.query(n,r)}createQueryBuilder(e,t,n){return t?this.connection.createQueryBuilder(e,t,n||this.queryRunner):this.connection.createQueryBuilder(e||n||this.queryRunner)}hasId(e,t){const n=arguments.length===2?e:e.constructor,r=arguments.length===2?t:e;return this.connection.getMetadata(n).hasId(r)}getId(e,t){const n=arguments.length===2?e:e.constructor,r=arguments.length===2?t:e;return this.connection.getMetadata(n).getEntityIdMixedMap(r)}create(e,t){const n=this.connection.getMetadata(e);if(!t)return n.create(this.queryRunner);if(Array.isArray(t))return t.map(i=>this.create(e,i));const r=n.create(this.queryRunner);return this.plainObjectToEntityTransformer.transform(r,t,n,!0),r}merge(e,t,...n){const r=this.connection.getMetadata(e);return n.forEach(i=>this.plainObjectToEntityTransformer.transform(t,i,r)),t}async preload(e,t){const n=this.connection.getMetadata(e),i=await new ec(this.connection.manager).transform(t,n);if(i)return this.merge(e,i,t)}save(e,t,n){let r=arguments.length>1&&(typeof e=="function"||q.isEntitySchema(e)||typeof e=="string")?e:void 0;const i=r?t:e,s=r?n:t;return q.isEntitySchema(r)&&(r=r.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new Bt(this.connection,this.queryRunner,"save",r,i,s).execute().then(()=>i)}remove(e,t,n){const r=arguments.length>1&&(typeof e=="function"||q.isEntitySchema(e)||typeof e=="string")?e:void 0,i=r?t:e,s=r?n:t;return Array.isArray(i)&&i.length===0?Promise.resolve(i):new Bt(this.connection,this.queryRunner,"remove",r,i,s).execute().then(()=>i)}softRemove(e,t,n){let r=arguments.length>1&&(typeof e=="function"||q.isEntitySchema(e)||typeof e=="string")?e:void 0;const i=r?t:e,s=r?n:t;return q.isEntitySchema(r)&&(r=r.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new Bt(this.connection,this.queryRunner,"soft-remove",r,i,s).execute().then(()=>i)}recover(e,t,n){let r=arguments.length>1&&(typeof e=="function"||q.isEntitySchema(e)||typeof e=="string")?e:void 0;const i=r?t:e,s=r?n:t;return q.isEntitySchema(r)&&(r=r.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new Bt(this.connection,this.queryRunner,"recover",r,i,s).execute().then(()=>i)}async insert(e,t){return this.createQueryBuilder().insert().into(e).values(t).execute()}async upsert(e,t,n){const r=this.connection.getMetadata(e);let i;Array.isArray(n)?i={conflictPaths:n}:i=n;let s;Array.isArray(t)?s=t:s=[t];const a=r.mapPropertyPathsToColumns(Array.isArray(i.conflictPaths)?i.conflictPaths:Object.keys(i.conflictPaths)),o=r.columns.filter(c=>!a.includes(c)&&s.some(u=>typeof c.getEntityValue(u)<"u"));return this.createQueryBuilder().insert().into(e).values(s).orUpdate([...a,...o].map(c=>c.databaseName),a.map(c=>c.databaseName),{skipUpdateIfNoValuesChanged:i.skipUpdateIfNoValuesChanged,indexPredicate:i.indexPredicate,upsertType:i.upsertType||this.connection.driver.supportedUpsertTypes[0]}).execute()}update(e,t,n){return K.isCriteriaNullOrEmpty(t)?Promise.reject(new M("Empty criteria(s) are not allowed for the update method.")):K.isPrimitiveCriteria(t)?this.createQueryBuilder().update(e).set(n).whereInIds(t).execute():this.createQueryBuilder().update(e).set(n).where(t).execute()}updateAll(e,t){return this.createQueryBuilder().update(e).set(t).execute()}delete(e,t){return K.isCriteriaNullOrEmpty(t)?Promise.reject(new M("Empty criteria(s) are not allowed for the delete method.")):K.isPrimitiveCriteria(t)?this.createQueryBuilder().delete().from(e).whereInIds(t).execute():this.createQueryBuilder().delete().from(e).where(t).execute()}deleteAll(e){return this.createQueryBuilder().delete().from(e).execute()}softDelete(e,t){return K.isCriteriaNullOrEmpty(t)?Promise.reject(new M("Empty criteria(s) are not allowed for the softDelete method.")):K.isPrimitiveCriteria(t)?this.createQueryBuilder().softDelete().from(e).whereInIds(t).execute():this.createQueryBuilder().softDelete().from(e).where(t).execute()}restore(e,t){return K.isCriteriaNullOrEmpty(t)?Promise.reject(new M("Empty criteria(s) are not allowed for the restore method.")):K.isPrimitiveCriteria(t)?this.createQueryBuilder().restore().from(e).whereInIds(t).execute():this.createQueryBuilder().restore().from(e).where(t).execute()}exists(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ve.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getExists()}async existsBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getExists()}count(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ve.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getCount()}countBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getCount()}sum(e,t,n){return this.callAggregateFun(e,"SUM",t,n)}average(e,t,n){return this.callAggregateFun(e,"AVG",t,n)}minimum(e,t,n){return this.callAggregateFun(e,"MIN",t,n)}maximum(e,t,n){return this.callAggregateFun(e,"MAX",t,n)}async callAggregateFun(e,t,n,r={}){const i=this.connection.getMetadata(e),s=i.columns.find(o=>o.propertyPath===n);if(!s)throw new M(`Column "${n}" was not found in table "${i.name}"`);const a=await this.createQueryBuilder(e,i.name).setFindOptions({where:r}).select(`${t}(${this.connection.driver.escape(s.databaseName)})`,t).getRawOne();return a[t]===null?null:parseFloat(a[t])}async find(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ve.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getMany()}async findBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getMany()}findAndCount(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ve.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getManyAndCount()}findAndCountBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getManyAndCount()}async findByIds(e,t){if(!t.length)return Promise.resolve([]);const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).andWhereInIds(t).getMany()}async findOne(e,t){let r=this.connection.getMetadata(e).name;if(t&&t.join&&(r=t.join.alias),!t.where)throw new Error("You must provide selection conditions in order to find a single row.");return this.createQueryBuilder(e,r).setFindOptions({...t,take:1}).getOne()}async findOneBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t,take:1}).getOne()}async findOneById(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({take:1}).whereInIds(n.ensureEntityIdMap(t)).getOne()}async findOneOrFail(e,t){return this.findOne(e,t).then(n=>n===null?Promise.reject(new Tr(e,t)):Promise.resolve(n))}async findOneByOrFail(e,t){return this.findOneBy(e,t).then(n=>n===null?Promise.reject(new Tr(e,t)):Promise.resolve(n))}async clear(e){const t=this.connection.getMetadata(e),n=this.queryRunner||this.connection.createQueryRunner();try{return await n.clearTable(t.tablePath)}finally{this.queryRunner||await n.release()}}async increment(e,t,n,r){const i=this.connection.getMetadata(e),s=i.findColumnWithPropertyPath(n);if(!s)throw new M(`Column ${n} was not found in ${i.targetName} entity.`);if(isNaN(Number(r)))throw new M(`Value "${r}" is not a number.`);const a=n.split(".").reduceRight((o,c)=>({[c]:o}),()=>this.connection.driver.escape(s.databaseName)+" + "+r);return this.createQueryBuilder(e,"entity").update(e).set(a).where(t).execute()}async decrement(e,t,n,r){const i=this.connection.getMetadata(e),s=i.findColumnWithPropertyPath(n);if(!s)throw new M(`Column ${n} was not found in ${i.targetName} entity.`);if(isNaN(Number(r)))throw new M(`Value "${r}" is not a number.`);const a=n.split(".").reduceRight((o,c)=>({[c]:o}),()=>this.connection.driver.escape(s.databaseName)+" - "+r);return this.createQueryBuilder(e,"entity").update(e).set(a).where(t).execute()}getRepository(e){const t=this.repositories.get(e);if(t)return t;if(this.connection.driver.options.type==="mongodb"){const n=new Bo(e,this,this.queryRunner);return this.repositories.set(e,n),n}else{const n=new Qs(e,this,this.queryRunner);return this.repositories.set(e,n),n}}getTreeRepository(e){if(this.connection.driver.treeSupport===!1)throw new ta(this.connection.driver);const t=this.treeRepositories.find(r=>r.target===e);if(t)return t;const n=new Jo(e,this,this.queryRunner);return this.treeRepositories.push(n),n}getMongoRepository(e){return this.connection.getMongoRepository(e)}withRepository(e){const t=e.constructor,{target:n,manager:r,queryRunner:i,...s}=e;return Object.assign(new t(e.target,this),{...s})}getCustomRepository(e){const t=zt().entityRepositories.find(i=>i.target===(typeof e=="function"?e:e.constructor));if(!t)throw new ws(e);const n=t.entity?this.connection.getMetadata(t.entity):void 0,r=new t.target(this,n);if(r instanceof tc)r.manager||(r.manager=this);else{if(!n)throw new sa(e);r.manager=this,r.metadata=n}return r}async release(){if(!this.queryRunner)throw new ga;return this.queryRunner.release()}}class pc extends Vs{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SqljsEntityManager"),this.driver=e.driver}async loadDatabase(e){await this.driver.load(e)}async saveDatabase(e){await this.driver.save(e)}exportDatabase(){return this.driver.export()}}class dc{create(e,t){return e.driver.options.type==="mongodb"?new Lo(e):e.driver.options.type==="sqljs"?new pc(e,t):new Vs(e,t)}}class ht{constructor(e){this["@instanceof"]=Symbol.for("View"),this.indices=[],e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,this.expression=e.expression,this.materialized=!!e.materialized)}clone(){return new ht({database:this.database,schema:this.schema,name:this.name,expression:this.expression,materialized:this.materialized})}addIndex(e){this.indices.push(e)}removeIndex(e){const t=this.indices.find(n=>n.name===e.name);t&&this.indices.splice(this.indices.indexOf(t),1)}static create(e,t){const n={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,e.schema,e.database),expression:e.expression,materialized:e.tableMetadataArgs.materialized};return new ht(n)}}class rs{static viewMetadataCmp(e,t){return!e||!t?0:e.dependsOn&&(e.dependsOn.has(t.target)||e.dependsOn.has(t.name))?1:t.dependsOn&&(t.dependsOn.has(e.target)||t.dependsOn.has(e.name))?-1:0}}class Zt{constructor(e){this.connection=e,this["@instanceof"]=Symbol.for("RdbmsSchemaBuilder")}async build(){this.queryRunner=this.connection.createQueryRunner(),this.currentDatabase=this.connection.driver.database,this.currentSchema=this.connection.driver.schema;const e=this.connection.driver.options.type!=="cockroachdb"&&this.connection.driver.options.type!=="spanner"&&this.connection.options.migrationsTransactionMode!=="none";await this.queryRunner.beforeMigration(),e&&await this.queryRunner.startTransaction();try{await this.createMetadataTableIfNecessary(this.queryRunner);const t=this.entityToSyncMetadatas.map(r=>this.getTablePath(r)),n=this.viewEntityToSyncMetadatas.map(r=>this.getTablePath(r));await this.queryRunner.getTables(t),await this.queryRunner.getViews(n),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),e&&await this.queryRunner.commitTransaction()}catch(t){try{e&&await this.queryRunner.rollbackTransaction()}catch{}throw t}finally{await this.queryRunner.afterMigration(),await this.queryRunner.release()}}async createMetadataTableIfNecessary(e){(this.viewEntityToSyncMetadatas.length>0||this.hasGeneratedColumns())&&await this.createTypeormMetadataTable(e)}async log(){this.queryRunner=this.connection.createQueryRunner();try{const e=this.entityToSyncMetadatas.map(n=>this.getTablePath(n)),t=this.viewEntityToSyncMetadatas.map(n=>this.getTablePath(n));return await this.queryRunner.getTables(e),await this.queryRunner.getViews(t),this.queryRunner.enableSqlMemory(),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),this.queryRunner.getMemorySql()}finally{this.queryRunner.disableSqlMemory(),await this.queryRunner.release()}}get entityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.synchronize&&e.tableType!=="entity-child"&&e.tableType!=="view")}get viewEntityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.tableType==="view"&&e.synchronize).sort(rs.viewMetadataCmp)}hasGeneratedColumns(){return this.connection.entityMetadatas.some(e=>e.columns.some(t=>t.generatedType))}async executeSchemaSyncOperationsInProperOrder(){await this.dropOldViews(),await this.dropOldForeignKeys(),await this.dropOldIndices(),await this.dropOldChecks(),await this.dropOldExclusions(),await this.dropCompositeUniqueConstraints(),await this.renameColumns(),await this.changeTableComment(),await this.createNewTables(),await this.dropRemovedColumns(),await this.addNewColumns(),await this.updatePrimaryKeys(),await this.updateExistColumns(),await this.createNewIndices(),await this.createNewChecks(),await this.createNewExclusions(),await this.createCompositeUniqueConstraints(),await this.createForeignKeys(),await this.createViews(),await this.createNewViewIndices()}getTablePath(e){const t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema||this.currentSchema,t.database||this.currentDatabase)}async dropOldForeignKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.foreignKeys.filter(r=>{const i=e.foreignKeys.find(s=>r.name===s.name&&this.getTablePath(r)===this.getTablePath(s.referencedEntityMetadata));return!i||i.onDelete&&i.onDelete!==r.onDelete||i.onUpdate&&i.onUpdate!==r.onUpdate});n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old foreign keys of ${t.name}: ${n.map(r=>r.name).join(", ")}`),await this.queryRunner.dropForeignKeys(t,n))}}async renameTables(){}async renameColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t||e.columns.length!==t.columns.length)continue;const n=e.columns.filter(s=>!s.isVirtualProperty).filter(s=>!t.columns.find(a=>a.name===s.databaseName&&a.type===this.connection.driver.normalizeType(s)&&a.isNullable===s.isNullable&&a.isUnique===this.connection.driver.normalizeIsUnique(s)));if(n.length===0||n.length>1)continue;const r=t.columns.filter(s=>!e.columns.find(a=>!a.isVirtualProperty&&a.databaseName===s.name&&this.connection.driver.normalizeType(a)===s.type&&a.isNullable===s.isNullable&&this.connection.driver.normalizeIsUnique(a)===s.isUnique));if(r.length===0||r.length>1)continue;const i=r[0].clone();i.name=n[0].databaseName,this.connection.logger.logSchemaBuild(`renaming column "${r[0].name}" in "${t.name}" to "${i.name}"`),await this.queryRunner.renameColumn(t,r[0],i)}}async dropOldIndices(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.indices.filter(r=>{const i=e.indices.find(s=>s.name===r.name);return i?i.synchronize===!1?!1:i.isUnique!==r.isUnique||i.isSpatial!==r.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&i.isFulltext!==r.isFulltext||i.columns.length!==r.columnNames.length?!0:!i.columns.every(s=>r.columnNames.indexOf(s.databaseName)!==-1):!0}).map(async r=>{this.connection.logger.logSchemaBuild(`dropping an index: "${r.name}" from table ${t.name}`),await this.queryRunner.dropIndex(t,r)});await Promise.all(n)}if(this.connection.options.type==="postgres"){const e=this.queryRunner;for(const t of this.viewEntityToSyncMetadatas){const n=this.queryRunner.loadedViews.find(i=>this.getTablePath(i)===this.getTablePath(t));if(!n)continue;const r=n.indices.filter(i=>{const s=t.indices.find(a=>a.name===i.name);return s?s.synchronize===!1?!1:s.isUnique!==i.isUnique||s.isSpatial!==i.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&s.isFulltext!==i.isFulltext||s.columns.length!==i.columnNames.length?!0:!s.columns.every(a=>i.columnNames.indexOf(a.databaseName)!==-1):!0}).map(async i=>{this.connection.logger.logSchemaBuild(`dropping an index: "${i.name}" from view ${n.name}`),await e.dropViewIndex(n,i)});await Promise.all(r)}}}async dropOldChecks(){if(!(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.checks.filter(r=>!e.checks.find(i=>i.name===r.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old check constraint: ${n.map(r=>`"${r.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropCheckConstraints(t,n))}}async dropCompositeUniqueConstraints(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.uniques.filter(r=>r.columnNames.length>1&&!e.uniques.find(i=>i.name===r.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old unique constraint: ${n.map(r=>`"${r.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropUniqueConstraints(t,n))}}async dropOldExclusions(){if(this.connection.driver.options.type==="postgres")for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.exclusions.filter(r=>!e.exclusions.find(i=>i.name===r.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old exclusion constraint: ${n.map(r=>`"${r.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropExclusionConstraints(t,n))}}async changeTableComment(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(t&&(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="postgres")){const n=e.comment;await this.queryRunner.changeTableComment(t,n)}}}async createNewTables(){for(const e of this.entityToSyncMetadatas){if(this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e)))continue;this.connection.logger.logSchemaBuild(`creating a new table: ${this.getTablePath(e)}`);const n=$e.create(e,this.connection.driver);await this.queryRunner.createTable(n,!1,!1),this.queryRunner.loadedTables.push(n)}}async createViews(){for(const e of this.viewEntityToSyncMetadatas){if(this.queryRunner.loadedViews.find(r=>{const i=typeof r.expression=="string"?r.expression.trim():r.expression(this.connection).getQuery(),s=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.getTablePath(r)===this.getTablePath(e)&&i===s}))continue;this.connection.logger.logSchemaBuild(`creating a new view: ${this.getTablePath(e)}`);const n=ht.create(e,this.connection.driver);await this.queryRunner.createView(n,!0),this.queryRunner.loadedViews.push(n)}}async dropOldViews(){const e=[],t=this.viewEntityToSyncMetadatas,n=new Map;for(const s of this.queryRunner.loadedViews){const a=t.find(o=>this.getTablePath(s)===this.getTablePath(o));a&&n.set(s,a)}for(const s of this.queryRunner.loadedViews){const a=n.get(s);if(!a)continue;const o=typeof s.expression=="string"?s.expression.trim():s.expression(this.connection).getQuery(),c=typeof a.expression=="string"?a.expression.trim():a.expression(this.connection).getQuery();o!==c&&(this.connection.logger.logSchemaBuild(`dropping an old view: ${s.name}`),e.push(s))}const r=s=>{const a=n.get(s);let o=[s];if(!a)return o;for(const[c,u]of n.entries())c!==s&&u.dependsOn&&(u.dependsOn.has(a.target)||u.dependsOn.has(a.name))&&(o=o.concat(r(c)));return o},i=new Set(e.map(s=>r(s)).reduce((s,a)=>s.concat(a),[]).sort((s,a)=>rs.viewMetadataCmp(n.get(s),n.get(a))).reverse());for(const s of i)await this.queryRunner.dropView(s);this.queryRunner.loadedViews=this.queryRunner.loadedViews.filter(s=>!i.has(s))}async dropRemovedColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.columns.filter(r=>!e.columns.find(i=>i.isVirtualProperty||i.databaseName===r.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`columns dropped in ${t.name}: `+n.map(r=>r.name).join(", ")),await this.queryRunner.dropColumns(t,n))}}async addNewColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;const n=e.columns.filter(s=>!s.isVirtualProperty&&!t.columns.find(a=>a.name===s.databaseName));if(n.length===0)continue;const i=this.metadataColumnsToTableColumnOptions(n).map(s=>new ze(s));i.length!==0&&(this.connection.logger.logSchemaBuild("new columns added: "+n.map(s=>s.databaseName).join(", ")),await this.queryRunner.addColumns(t,i))}}async updatePrimaryKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.columns.filter(i=>i.isPrimary);if(t.columns.filter(i=>i.isPrimary).length!==n.length&&n.length>1){const i=n.map(s=>new ze(kt.createTableColumnOptions(s,this.connection.driver)));await this.queryRunner.updatePrimaryKeys(t,i)}}}async updateExistColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=this.connection.driver.findChangedColumns(t.columns,e.columns);if(n.length===0)continue;for(const i of n)await this.dropColumnReferencedForeignKeys(this.getTablePath(e),i.databaseName);for(const i of n)await this.dropColumnCompositeIndices(this.getTablePath(e),i.databaseName);if(!(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="spanner"))for(const i of n)await this.dropColumnCompositeUniques(this.getTablePath(e),i.databaseName);const r=n.map(i=>{const s=t.columns.find(c=>c.name===i.databaseName),a=kt.createTableColumnOptions(i,this.connection.driver),o=new ze(a);return{oldColumn:s,newColumn:o}});r.length!==0&&(this.connection.logger.logSchemaBuild(`columns changed in "${t.name}". updating: `+n.map(i=>i.databaseName).join(", ")),await this.queryRunner.changeColumns(t,r))}}async createNewIndices(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.indices.filter(r=>!t.indices.find(i=>i.name===r.name)&&r.synchronize===!0).map(r=>Be.create(r));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${n.map(r=>`"${r.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createIndices(t,n))}}async createNewViewIndices(){if(this.connection.options.type!=="postgres"||!J.isPostgresFamily(this.connection.driver))return;const e=this.queryRunner;for(const t of this.viewEntityToSyncMetadatas){const n=this.queryRunner.loadedViews.find(i=>{const s=typeof i.expression=="string"?i.expression.trim():i.expression(this.connection).getQuery(),a=typeof t.expression=="string"?t.expression.trim():t.expression(this.connection).getQuery();return this.getTablePath(i)===this.getTablePath(t)&&s===a});if(!n||!n.materialized)continue;const r=t.indices.filter(i=>!n.indices.find(s=>s.name===i.name)&&i.synchronize===!0).map(i=>Be.create(i));r.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${r.map(i=>`"${i.name}"`).join(", ")} in view "${n.name}"`),await e.createViewIndices(n,r))}}async createNewChecks(){if(!(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.checks.filter(r=>!t.checks.find(i=>i.name===r.name)).map(r=>it.create(r));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new check constraints: ${n.map(r=>`"${r.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createCheckConstraints(t,n))}}async createCompositeUniqueConstraints(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.uniques.filter(r=>r.columns.length>1&&!t.uniques.find(i=>i.name===r.name)).map(r=>We.create(r));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new unique constraints: ${n.map(r=>`"${r.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createUniqueConstraints(t,n))}}async createNewExclusions(){if(this.connection.driver.options.type==="postgres")for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.exclusions.filter(r=>!t.exclusions.find(i=>i.name===r.name)).map(r=>yt.create(r));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new exclusion constraints: ${n.map(r=>`"${r.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createExclusionConstraints(t,n))}}async createForeignKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.foreignKeys.filter(i=>!t.foreignKeys.find(s=>s.name===i.name&&this.getTablePath(s)===this.getTablePath(i.referencedEntityMetadata)));if(n.length===0)continue;const r=n.map(i=>Je.create(i,this.connection.driver));this.connection.logger.logSchemaBuild(`creating a foreign keys: ${n.map(i=>i.name).join(", ")} on table "${t.name}"`),await this.queryRunner.createForeignKeys(t,r)}}async dropColumnReferencedForeignKeys(e,t){const n=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===e);if(!n)return;const r=[],i=n.foreignKeys.find(s=>s.columnNames.indexOf(t)!==-1);if(i){const s=n.clone();s.foreignKeys=[i],r.push(s),n.removeForeignKey(i)}for(const s of this.queryRunner.loadedTables){const a=s.foreignKeys.filter(o=>this.getTablePath(o)===e&&o.referencedColumnNames.indexOf(t)!==-1);if(a.length>0){const o=s.clone();o.foreignKeys=a,r.push(o),a.forEach(c=>s.removeForeignKey(c))}}if(r.length>0)for(const s of r)this.connection.logger.logSchemaBuild(`dropping related foreign keys of ${s.name}: ${s.foreignKeys.map(a=>a.name).join(", ")}`),await this.queryRunner.dropForeignKeys(s,s.foreignKeys)}async dropColumnCompositeIndices(e,t){const n=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===e);if(!n)return;const r=n.indices.filter(i=>i.columnNames.length>1&&i.columnNames.indexOf(t)!==-1);r.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related indices of "${e}"."${t}": ${r.map(i=>i.name).join(", ")}`),await this.queryRunner.dropIndices(n,r))}async dropColumnCompositeUniques(e,t){const n=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===e);if(!n)return;const r=n.uniques.filter(i=>i.columnNames.length>1&&i.columnNames.indexOf(t)!==-1);r.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related unique constraints of "${e}"."${t}": ${r.map(i=>i.name).join(", ")}`),await this.queryRunner.dropUniqueConstraints(n,r))}metadataColumnsToTableColumnOptions(e){return e.map(t=>kt.createTableColumnOptions(t,this.connection.driver))}async createTypeormMetadataTable(e){const t=this.currentSchema,n=this.currentDatabase,r=this.connection.driver.buildTableName(this.connection.metadataTableName,t,n),i=this.connection.driver.options.type==="spanner";await e.createTable(new $e({database:n,schema:t,name:r,columns:[{name:"type",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataType}),isNullable:!1,isPrimary:i},{name:"database",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataDatabase}),isNullable:!0,isPrimary:i},{name:"schema",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataSchema}),isNullable:!0,isPrimary:i},{name:"table",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataTable}),isNullable:!0,isPrimary:i},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataName}),isNullable:!0,isPrimary:i},{name:"value",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataValue}),isNullable:!0,isPrimary:i}]}),!0)}}class At{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime","json"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=J.buildDriverOptions(this.options).database}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(n=>n?t(n):e())})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){return this.attachedDatabases?.[e]?.attachHandle}getAttachedDatabasePathRelativeByHandle(e){return Object.values(this.attachedDatabases).find(({attachHandle:t})=>e===t)?.attachFilepathRelative}createSchemaBuilder(){return new Zt(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=ke.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?he.mixedDateToDateString(e):t.type==="time"?he.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?he.mixedDateToUtcDatetimeString(e):t.type==="json"||t.type==="simple-json"?he.simpleJsonToString(e):t.type==="simple-array"?he.simpleArrayToString(e):t.type==="simple-enum"?he.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?ke.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=he.normalizeHydratedDate(e)):t.type==="date"?e=he.mixedDateToDateString(e):t.type==="time"?e=he.mixedTimeToString(e):t.type==="json"||t.type==="simple-json"?e=he.stringToSimpleJson(e):t.type==="simple-array"?e=he.stringToSimpleArray(e):t.type==="simple-enum"?e=he.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=ke.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){const r=Object.keys(n).map(i=>typeof n[i]=="boolean"?n[i]===!0?1:0:n[i]instanceof Date?he.mixedDateToUtcDatetimeString(n[i]):n[i]);return!t||!Object.keys(t).length?[e,r]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,s,a)=>{if(!t.hasOwnProperty(a))return i;const o=t[a];return s?o.map(c=>(r.push(c),this.createParameter(a,r.length-1))).join(", "):typeof o=="function"?o():typeof o=="number"?String(o):typeof o=="boolean"?(r.push(+o),this.createParameter(a,r.length-1)):o instanceof Date?(r.push(he.mixedDateToUtcDatetimeString(o)),this.createParameter(a,r.length-1)):(r.push(o),this.createParameter(a,r.length-1))}),[e,r])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){const t=this.database,n=void 0;if(q.isTable(e)||q.isView(e)){const i=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if(q.isTableForeignKey(e)){const i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if(q.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const r=e.split(".");return r.length===3?{database:r[0]||t,schema:r[1]||n,tableName:r[2]}:r.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(r[0])??t,schema:r[0],tableName:r[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){const t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,r){const i=e.generatedColumns.reduce((s,a)=>{let o;return a.generationStrategy==="increment"&&t&&(o=t-r+n+1),o?K.mergeDeep(s,a.createValueMap(o)):s},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{const r=e.find(s=>s.name===n.databaseName);return r?r.name!==n.databaseName||r.type!==this.normalizeType(n)||r.length!==n.length||r.precision!==n.precision||r.scale!==n.scale||this.normalizeDefault(n)!==r.default||r.isPrimary!==n.isPrimary||r.isNullable!==n.isNullable||r.generatedType!==n.generatedType||r.asExpression!==n.asExpression||r.isUnique!==this.normalizeIsUnique(n)||r.enum&&n.enum&&!K.isArraysEqual(r.enum,n.enum.map(s=>s+""))||n.generationStrategy!=="uuid"&&r.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}async createDatabaseConnection(){throw new M("Do not use AbstractSqlite directly, it has to be used with one of the sqlite drivers")}loadDependencies(){}}class at{constructor(){this.records=[]}}class ct{constructor(e){this.queryRunner=e}async broadcast(e,...t){const n=new Xe,r=this[`broadcast${e}Event`];typeof r=="function"&&r.call(this,n,...t),await n.wait()}broadcastBeforeInsertEvent(e,t,n){n&&t.beforeInsertListeners.length&&t.beforeInsertListeners.forEach(r=>{if(r.isAllowed(n)){const i=r.execute(n);i instanceof Promise&&e.promises.push(i),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(r=>{if(this.isAllowedSubscriber(r,t.target)&&r.beforeInsert){const i=r.beforeInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t});i instanceof Promise&&e.promises.push(i),e.count++}})}broadcastBeforeUpdateEvent(e,t,n,r,i,s){n&&t.beforeUpdateListeners.length&&t.beforeUpdateListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeUpdate){const o=a.beforeUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,updatedColumns:i||[],updatedRelations:s||[]});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastBeforeRemoveEvent(e,t,n,r,i){n&&t.beforeRemoveListeners.length&&t.beforeRemoveListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeRemove){const a=s.beforeRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastBeforeSoftRemoveEvent(e,t,n,r,i){n&&t.beforeSoftRemoveListeners.length&&t.beforeSoftRemoveListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeSoftRemove){const a=s.beforeSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastBeforeRecoverEvent(e,t,n,r,i){n&&t.beforeRecoverListeners.length&&t.beforeRecoverListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeRecover){const a=s.beforeRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterInsertEvent(e,t,n,r){n&&t.afterInsertListeners.length&&t.afterInsertListeners.forEach(i=>{if(i.isAllowed(n)){const s=i.execute(n);s instanceof Promise&&e.promises.push(s),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.afterInsert){const s=i.afterInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,entityId:t.getEntityIdMixedMap(r)});s instanceof Promise&&e.promises.push(s),e.count++}})}broadcastBeforeQueryEvent(e,t,n){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(r=>{if(r.beforeQuery){const i=r.beforeQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:n});i instanceof Promise&&e.promises.push(i),e.count++}})}broadcastAfterQueryEvent(e,t,n,r,i,s,a){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(o=>{if(o.afterQuery){const c=o.afterQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:n,success:r,executionTime:i,rawResults:s,error:a});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastBeforeTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionStart){const n=t.beforeTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionStart){const n=t.afterTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionCommit){const n=t.beforeTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionCommit){const n=t.afterTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionRollback){const n=t.beforeTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionRollback){const n=t.afterTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterUpdateEvent(e,t,n,r,i,s){n&&t.afterUpdateListeners.length&&t.afterUpdateListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterUpdate){const o=a.afterUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,updatedColumns:i||[],updatedRelations:s||[]});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastAfterRemoveEvent(e,t,n,r,i){n&&t.afterRemoveListeners.length&&t.afterRemoveListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterRemove){const a=s.afterRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterSoftRemoveEvent(e,t,n,r,i){n&&t.afterSoftRemoveListeners.length&&t.afterSoftRemoveListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterSoftRemove){const a=s.afterSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterRecoverEvent(e,t,n,r,i){n&&t.afterRecoverListeners.length&&t.afterRecoverListeners.forEach(s=>{if(s.isAllowed(n)){const a=s.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterRecover){const a=s.afterRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastLoadEventsForAll(e,t,n){return this.broadcastLoadEvent(e,t,n)}broadcastLoadEvent(e,t,n){const r=this.queryRunner.connection.subscribers.filter(i=>this.isAllowedSubscriber(i,t.target)&&i.afterLoad);if(t.relations.length||t.afterLoadListeners.length||r.length){const i=n.filter(s=>!(s instanceof Promise));t.relations.length&&t.relations.forEach(s=>{i.forEach(a=>{if(s.isLazy&&!a.hasOwnProperty(s.propertyName))return;const o=s.getEntityValue(a);me.isObject(o)&&this.broadcastLoadEvent(e,s.inverseEntityMetadata,Array.isArray(o)?o:[o])})}),t.afterLoadListeners.length&&t.afterLoadListeners.forEach(s=>{i.forEach(a=>{if(s.isAllowed(a)){const o=s.execute(a);o instanceof Promise&&e.promises.push(o),e.count++}})}),r.forEach(s=>{i.forEach(a=>{const o=s.afterLoad(a,{entity:a,metadata:t,connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});o instanceof Promise&&e.promises.push(o),e.count++})})}}isAllowedSubscriber(e,t){return!e.listenTo||!e.listenTo()||e.listenTo()===Object||e.listenTo()===t||e.listenTo().isPrototypeOf(t)}}class R{constructor(e,t){this.query=e,this.parameters=t,this["@instanceof"]=Symbol.for("Query")}}class Ut{constructor(){this.upQueries=[],this.downQueries=[]}}class en{constructor(){this.isReleased=!1,this.isTransactionActive=!1,this.data={},this.loadedTables=[],this.loadedViews=[],this.sqlMemoryMode=!1,this.sqlInMemory=new Ut,this.transactionDepth=0,this.cachedTablePaths={}}async sql(e,...t){const{query:n,parameters:r}=Xt({driver:this.connection.driver,strings:e,expressions:t});return await this.query(n,r)}async beforeMigration(){}async afterMigration(){}async getTable(e){return this.loadedTables=await this.loadTables([e]),this.loadedTables.length>0?this.loadedTables[0]:void 0}async getTables(e){return e?(this.loadedTables=await this.loadTables(e),this.loadedTables):await this.loadTables(e)}async getView(e){return this.loadedViews=await this.loadViews([e]),this.loadedViews.length>0?this.loadedViews[0]:void 0}async getViews(e){return this.loadedViews=await this.loadViews(e),this.loadedViews}enableSqlMemory(){this.sqlInMemory=new Ut,this.sqlMemoryMode=!0}disableSqlMemory(){this.sqlInMemory=new Ut,this.sqlMemoryMode=!1}clearSqlMemory(){this.sqlInMemory=new Ut}getMemorySql(){return this.sqlInMemory}async executeMemoryUpSql(){for(const{query:e,parameters:t}of this.sqlInMemory.upQueries)await this.query(e,t)}async executeMemoryDownSql(){for(const{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())await this.query(e,t)}getReplicationMode(){return this.mode}async getCachedView(e){const t=this.loadedViews.find(r=>r.name===e);if(t)return t;const n=await this.loadViews([e]);if(n.length>0)return this.loadedViews.push(n[0]),n[0];throw new M(`View "${e}" does not exist.`)}async getCachedTable(e){if(e in this.cachedTablePaths){const n=this.cachedTablePaths[e],r=this.loadedTables.find(i=>this.getTablePath(i)===n);if(r)return r}const t=await this.loadTables([e]);if(t.length>0){const n=this.getTablePath(t[0]),r=this.loadedTables.find(i=>this.getTablePath(i)===n);return r||(this.cachedTablePaths[e]=this.getTablePath(t[0]),this.loadedTables.push(t[0]),t[0])}else throw new M(`Table "${e}" does not exist.`)}replaceCachedTable(e,t){const n=this.getTablePath(e),r=this.loadedTables.find(i=>this.getTablePath(i)===n);for(const[i,s]of Object.entries(this.cachedTablePaths))s===n&&(this.cachedTablePaths[i]=this.getTablePath(t));r&&(r.database=t.database,r.schema=t.schema,r.name=t.name,r.columns=t.columns,r.indices=t.indices,r.foreignKeys=t.foreignKeys,r.uniques=t.uniques,r.checks=t.checks,r.justCreated=t.justCreated,r.engine=t.engine,r.comment=t.comment)}getTablePath(e){const t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema,t.database)}getTypeormMetadataTableName(){const e=this.connection.driver.options;return this.connection.driver.buildTableName(this.connection.metadataTableName,e.schema,e.database)}selectTypeormMetadataSql({database:e,schema:t,table:n,type:r,name:i}){const s=this.connection.createQueryBuilder(),a=s.select().from(this.getTypeormMetadataTableName(),"t").where(`${s.escape("type")} = :type`,{type:r}).andWhere(`${s.escape("name")} = :name`,{name:i});e&&a.andWhere(`${s.escape("database")} = :database`,{database:e}),t&&a.andWhere(`${s.escape("schema")} = :schema`,{schema:t}),n&&a.andWhere(`${s.escape("table")} = :table`,{table:n});const[o,c]=a.getQueryAndParameters();return new R(o,c)}insertTypeormMetadataSql({database:e,schema:t,table:n,type:r,name:i,value:s}){const[a,o]=this.connection.createQueryBuilder().insert().into(this.getTypeormMetadataTableName()).values({database:e,schema:t,table:n,type:r,name:i,value:s}).getQueryAndParameters();return new R(a,o)}deleteTypeormMetadataSql({database:e,schema:t,table:n,type:r,name:i}){const s=this.connection.createQueryBuilder(),a=s.delete().from(this.getTypeormMetadataTableName()).where(`${s.escape("type")} = :type`,{type:r}).andWhere(`${s.escape("name")} = :name`,{name:i});e&&a.andWhere(`${s.escape("database")} = :database`,{database:e}),t&&a.andWhere(`${s.escape("schema")} = :schema`,{schema:t}),n&&a.andWhere(`${s.escape("table")} = :table`,{table:n});const[o,c]=a.getQueryAndParameters();return new R(o,c)}isColumnChanged(e,t,n,r,i=!0){return e.charset!==t.charset||e.collation!==t.collation||e.precision!==t.precision||e.scale!==t.scale||e.width!==t.width||e.zerofill!==t.zerofill||e.unsigned!==t.unsigned||e.asExpression!==t.asExpression||n&&e.default!==t.default||e.onUpdate!==t.onUpdate||e.isNullable!==t.isNullable||r&&e.comment!==t.comment||i&&this.isEnumChanged(e,t)}isEnumChanged(e,t){return!K.isArraysEqual(e.enum||[],t.enum||[])}isDefaultColumnLength(e,t,n){if(this.connection.hasMetadata(e.name)){const i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&this.connection.driver.getColumnLength(i))return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].length?this.connection.driver.dataTypeDefaults[t.type].length.toString()===n.toString():!1}isDefaultColumnPrecision(e,t,n){if(this.connection.hasMetadata(e.name)){const i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&i.precision!==null&&i.precision!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].precision!==null&&this.connection.driver.dataTypeDefaults[t.type].precision!==void 0?this.connection.driver.dataTypeDefaults[t.type].precision===n:!1}isDefaultColumnScale(e,t,n){if(this.connection.hasMetadata(e.name)){const i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&i.scale!==null&&i.scale!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].scale!==null&&this.connection.driver.dataTypeDefaults[t.type].scale!==void 0?this.connection.driver.dataTypeDefaults[t.type].scale===n:!1}async executeQueries(e,t){if(q.isQuery(e)&&(e=[e]),q.isQuery(t)&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(const{query:n,parameters:r}of e)await this.query(n,r)}generateIndexName(e,t){return this.connection.namingStrategy.indexName(e,t.columnNames,t.where)}}var de;(function(d){d.VIEW="VIEW",d.MATERIALIZED_VIEW="MATERIALIZED_VIEW",d.GENERATED_COLUMN="GENERATED_COLUMN"})(de||(de={}));class gt extends en{constructor(){super(),this.transactionPromise=null}connect(){return Promise.resolve(this.driver.databaseConnection)}release(){return this.loadedTables=[],this.clearSqlMemory(),Promise.resolve()}async startTransaction(e){if(this.driver.transactionSupport==="none")throw new M(`Transactions aren't supported by ${this.connection.driver.options.type}.`);if(this.isTransactionActive&&this.driver.transactionSupport==="simple")throw new na;if(e&&e!=="READ UNCOMMITTED"&&e!=="SERIALIZABLE")throw new M("SQLite only supports SERIALIZABLE and READ UNCOMMITTED isolation");this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(e&&(e==="READ UNCOMMITTED"?await this.query("PRAGMA read_uncommitted = true"):await this.query("PRAGMA read_uncommitted = false")),await this.query("BEGIN TRANSACTION")):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}stream(e,t,n,r){throw new M("Stream is not supported by sqlite driver.")}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return Promise.resolve(!1)}async getCurrentDatabase(){return Promise.resolve(void 0)}async hasSchema(e){throw new M("This driver does not support table schemas")}async getCurrentSchema(){return Promise.resolve(void 0)}async hasTable(e){const n=`SELECT * FROM "sqlite_master" WHERE "type" = 'table' AND "name" = '${q.isTable(e)?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=q.isTable(e)?e.name:e,r=`PRAGMA table_xinfo(${this.escapePath(n)})`;return!!(await this.query(r)).find(s=>s.name===t)}async createDatabase(e,t){return Promise.resolve()}async dropDatabase(e,t){return Promise.resolve()}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t){return Promise.resolve()}async createTable(e,t=!1,n=!0,r=!0){const i=[],s=[];if(t&&await this.hasTable(e))return Promise.resolve();i.push(this.createTableSql(e,n)),s.push(this.dropTableSql(e)),r&&e.indices.forEach(o=>{o.name||(o.name=this.connection.namingStrategy.indexName(e,o.columnNames,o.where)),i.push(this.createIndexSql(e,o)),s.push(this.dropIndexSql(o))});const a=e.columns.filter(o=>o.generatedType&&o.asExpression);for(const o of a){const c=this.insertTypeormMetadataSql({table:e.name,type:de.GENERATED_COLUMN,name:o.name,value:o.asExpression}),u=this.deleteTypeormMetadataSql({table:e.name,type:de.GENERATED_COLUMN,name:o.name});i.push(c),s.push(u)}await this.executeQueries(i,s)}async dropTable(e,t,n=!0,r=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const i=n,s=q.isTable(e)?e:await this.getCachedTable(e),a=[],o=[];r&&s.indices.forEach(u=>{a.push(this.dropIndexSql(u)),o.push(this.createIndexSql(s,u))}),a.push(this.dropTableSql(s,t)),o.push(this.createTableSql(s,i));const c=s.columns.filter(u=>u.generatedType&&u.asExpression);for(const u of c){const l=this.deleteTypeormMetadataSql({table:s.name,type:de.GENERATED_COLUMN,name:u.name}),h=this.insertTypeormMetadataSql({table:s.name,type:de.GENERATED_COLUMN,name:u.name,value:u.asExpression});a.push(l),o.push(h)}await this.executeQueries(a,o)}async createView(e,t=!1){const n=[],r=[];n.push(this.createViewSql(e)),t&&n.push(this.insertViewDefinitionSql(e)),r.push(this.dropViewSql(e)),t&&r.push(this.deleteViewDefinitionSql(e)),await this.executeQueries(n,r)}async dropView(e){const t=q.isView(e)?e.name:e,n=await this.getCachedView(t),r=[],i=[];r.push(this.deleteViewDefinitionSql(n)),r.push(this.dropViewSql(n)),i.push(this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(r,i)}async renameTable(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();r.name=t;const i=new R(`ALTER TABLE ${this.escapePath(n.name)} RENAME TO ${this.escapePath(t)}`),s=new R(`ALTER TABLE ${this.escapePath(t)} RENAME TO ${this.escapePath(n.name)}`);await this.executeQueries(i,s),r.uniques.forEach(a=>{const o=this.connection.namingStrategy.uniqueConstraintName(n,a.columnNames);a.name===o&&(a.name=this.connection.namingStrategy.uniqueConstraintName(r,a.columnNames))}),r.foreignKeys.forEach(a=>{const o=this.connection.namingStrategy.foreignKeyName(n,a.columnNames,this.getTablePath(a),a.referencedColumnNames);a.name===o&&(a.name=this.connection.namingStrategy.foreignKeyName(r,a.columnNames,this.getTablePath(a),a.referencedColumnNames))}),r.indices.forEach(a=>{const o=this.connection.namingStrategy.indexName(n,a.columnNames,a.where);a.name===o&&(a.name=this.connection.namingStrategy.indexName(r,a.columnNames,a.where))}),n.name=r.name,await this.recreateTable(r,n)}async addColumn(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);return this.addColumns(n,[t])}async addColumns(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.addColumn(i)),await this.recreateTable(r,n)}async renameColumn(e,t,n){const r=q.isTable(e)?e:await this.getCachedTable(e),i=q.isTableColumn(t)?t:r.columns.find(a=>a.name===t);if(!i)throw new M(`Column "${t}" was not found in the "${r.name}" table.`);let s;return q.isTableColumn(n)?s=n:(s=i.clone(),s.name=n),this.changeColumn(r,i,s)}async changeColumn(e,t,n){const r=q.isTable(e)?e:await this.getCachedTable(e),i=q.isTableColumn(t)?t:r.columns.find(s=>s.name===t);if(!i)throw new M(`Column "${t}" was not found in the "${r.name}" table.`);await this.changeColumns(r,[{oldColumn:i,newColumn:n}])}async changeColumns(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>{i.newColumn.name!==i.oldColumn.name&&(r.findColumnUniques(i.oldColumn).forEach(a=>{const o=this.connection.namingStrategy.uniqueConstraintName(n,a.columnNames);a.columnNames.splice(a.columnNames.indexOf(i.oldColumn.name),1),a.columnNames.push(i.newColumn.name),a.name===o&&(a.name=this.connection.namingStrategy.uniqueConstraintName(r,a.columnNames))}),r.findColumnForeignKeys(i.oldColumn).forEach(a=>{const o=this.connection.namingStrategy.foreignKeyName(n,a.columnNames,this.getTablePath(a),a.referencedColumnNames);a.columnNames.splice(a.columnNames.indexOf(i.oldColumn.name),1),a.columnNames.push(i.newColumn.name),a.name===o&&(a.name=this.connection.namingStrategy.foreignKeyName(r,a.columnNames,this.getTablePath(a),a.referencedColumnNames))}),r.findColumnIndices(i.oldColumn).forEach(a=>{const o=this.connection.namingStrategy.indexName(n,a.columnNames,a.where);a.columnNames.splice(a.columnNames.indexOf(i.oldColumn.name),1),a.columnNames.push(i.newColumn.name),a.name===o&&(a.name=this.connection.namingStrategy.indexName(r,a.columnNames,a.where))}));const s=r.columns.find(a=>a.name===i.oldColumn.name);s&&(r.columns[r.columns.indexOf(s)]=i.newColumn)}),await this.recreateTable(r,n)}async dropColumn(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableColumn(t)?t:n.findColumnByName(t);if(!r)throw new M(`Column "${t}" was not found in table "${n.name}"`);await this.dropColumns(n,[r])}async dropColumns(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>{const s=q.isTableColumn(i)?i:n.findColumnByName(i);if(!s)throw new Error(`Column "${i}" was not found in table "${n.name}"`);r.removeColumn(s),r.findColumnUniques(s).forEach(a=>r.removeUniqueConstraint(a)),r.findColumnIndices(s).forEach(a=>r.removeIndex(a)),r.findColumnForeignKeys(s).forEach(a=>r.removeForeignKey(a))}),await this.recreateTable(r,n)}async createPrimaryKey(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();r.columns.forEach(i=>{t.find(s=>s===i.name)&&(i.isPrimary=!0)}),await this.recreateTable(r,n),n.columns.forEach(i=>{t.find(s=>s===i.name)&&(i.isPrimary=!0)})}async updatePrimaryKeys(e,t){await Promise.resolve()}async dropPrimaryKey(e){const t=q.isTable(e)?e:await this.getCachedTable(e),n=t.clone();n.primaryColumns.forEach(r=>{r.isPrimary=!1}),await this.recreateTable(n,t),t.primaryColumns.forEach(r=>{r.isPrimary=!1})}async createUniqueConstraint(e,t){await this.createUniqueConstraints(e,[t])}async createUniqueConstraints(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.addUniqueConstraint(i)),await this.recreateTable(r,n)}async dropUniqueConstraint(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableUnique(t)?t:n.uniques.find(i=>i.name===t);if(!r)throw new M(`Supplied unique constraint was not found in table ${n.name}`);await this.dropUniqueConstraints(n,[r])}async dropUniqueConstraints(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.removeUniqueConstraint(i)),await this.recreateTable(r,n)}async createCheckConstraint(e,t){await this.createCheckConstraints(e,[t])}async createCheckConstraints(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.addCheckConstraint(i)),await this.recreateTable(r,n)}async dropCheckConstraint(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableCheck(t)?t:n.checks.find(i=>i.name===t);if(!r)throw new M(`Supplied check constraint was not found in table ${n.name}`);await this.dropCheckConstraints(n,[r])}async dropCheckConstraints(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.removeCheckConstraint(i)),await this.recreateTable(r,n)}async createExclusionConstraint(e,t){throw new M("Sqlite does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new M("Sqlite does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new M("Sqlite does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new M("Sqlite does not support exclusion constraints.")}async createForeignKey(e,t){await this.createForeignKeys(e,[t])}async createForeignKeys(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.addForeignKey(i)),await this.recreateTable(r,n)}async dropForeignKey(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableForeignKey(t)?t:n.foreignKeys.find(i=>i.name===t);if(!r)throw new M(`Supplied foreign key was not found in table ${n.name}`);await this.dropForeignKeys(e,[r])}async dropForeignKeys(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.removeForeignKey(i)),await this.recreateTable(r,n)}async createIndex(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createIndexSql(n,t),i=this.dropIndexSql(t);await this.executeQueries(r,i),n.addIndex(t)}async createIndices(e,t){const n=t.map(r=>this.createIndex(e,r));await Promise.all(n)}async dropIndex(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableIndex(t)?t:n.indices.find(a=>a.name===t);if(!r)throw new M(`Supplied index ${t} was not found in table ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(r),s=this.createIndexSql(n,r);await this.executeQueries(i,s),n.removeIndex(r)}async dropIndices(e,t){const n=t.map(r=>this.dropIndex(e,r));await Promise.all(n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)}`)}async clearDatabase(e){let t;e&&this.driver.getAttachedDatabaseHandleByRelativePath(e)&&(t=this.driver.getAttachedDatabaseHandleByRelativePath(e)),await this.query("PRAGMA foreign_keys = OFF");const n=this.isTransactionActive;n||await this.startTransaction();try{const r=t?`SELECT 'DROP VIEW "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'view'`:`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`,i=await this.query(r);await Promise.all(i.map(o=>this.query(o.query)));const s=t?`SELECT 'DROP TABLE "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`:`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`,a=await this.query(s);await Promise.all(a.map(o=>this.query(o.query))),n||await this.commitTransaction()}catch(r){try{n||await this.rollbackTransaction()}catch{}throw r}finally{await this.query("PRAGMA foreign_keys = ON")}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=e.map(s=>"'"+s+"'").join(", ");let r=`SELECT "t".* FROM "${this.getTypeormMetadataTableName()}" "t" INNER JOIN "sqlite_master" s ON "s"."name" = "t"."name" AND "s"."type" = 'view' WHERE "t"."type" = '${de.VIEW}'`;return n.length>0&&(r+=` AND "t"."name" IN (${n})`),(await this.query(r)).map(s=>{const a=new ht;return a.name=s.name,a.expression=s.value,a})}async loadTableRecords(e,t){let n;const[r,i]=this.splitTablePath(e);return r&&this.driver.getAttachedDatabasePathRelativeByHandle(r)&&(n=this.driver.getAttachedDatabasePathRelativeByHandle(r)),this.query(`SELECT ${n?`'${n}'`:null} as database, ${r?`'${r}'`:null} as schema, * FROM ${r?`"${r}".`:""}${this.escapePath("sqlite_master")} WHERE "type" = '${t}' AND "${t==="table"?"name":"tbl_name"}" IN ('${i}')`)}async loadPragmaRecords(e,t){const[,n]=this.splitTablePath(e);return this.query(`PRAGMA ${t}("${n}")`)}async loadTables(e){if(e&&e.length===0)return[];let t=[],n;if(e){const r=e.filter(a=>a.split(".").length===1).map(a=>`'${a}'`),i=e.filter(a=>a.split(".").length>1),s=a=>{const o=[...i.map(c=>this.loadTableRecords(c,a))];return r.length&&o.push(this.query(`SELECT * FROM "sqlite_master" WHERE "type" = '${a}' AND "${a==="table"?"name":"tbl_name"}" IN (${r})`)),o};t=(await Promise.all(s("table"))).reduce((a,o)=>[...a,...o],[]).filter(Boolean),n=(await Promise.all(s("index"))).reduce((a,o)=>[...a,...o],[]).filter(Boolean)}else{t.push(...await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'table'`));const i=t.map(({name:s})=>`'${s}'`).join(", ");n=await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'index' AND "tbl_name" IN (${i})`)}return t.length===0?[]:Promise.all(t.map(async r=>{const i=r.database&&this.driver.getAttachedDatabaseHandleByRelativePath(r.database)?`${this.driver.getAttachedDatabaseHandleByRelativePath(r.database)}.${r.name}`:r.name,s=r.sql,a=s.includes("WITHOUT ROWID"),o=new $e({name:i,withoutRowid:a}),[c,u,l]=await Promise.all([this.loadPragmaRecords(i,"table_xinfo"),this.loadPragmaRecords(i,"index_list"),this.loadPragmaRecords(i,"foreign_key_list")]);let h;const f=r.sql,E=f.toUpperCase().indexOf("AUTOINCREMENT");if(E!==-1){h=f.substr(0,E);const v=h.lastIndexOf(","),Y=h.lastIndexOf("(");v!==-1?(h=h.substr(v),h=h.substr(0,h.lastIndexOf('"')),h=h.substr(h.indexOf('"')+1)):Y!==-1&&(h=h.substr(Y),h=h.substr(0,h.lastIndexOf('"')),h=h.substr(h.indexOf('"')+1))}o.columns=await Promise.all(c.map(async v=>{const Y=new ze;if(Y.name=v.name,Y.type=v.type.toLowerCase(),Y.default=v.dflt_value!==null&&v.dflt_value!==void 0?v.dflt_value:void 0,Y.isNullable=v.notnull===0,Y.isPrimary=v.pk>0,Y.comment="",Y.isGenerated=h===v.name,Y.isGenerated&&(Y.generationStrategy="increment"),v.hidden===2||v.hidden===3){Y.generatedType=v.hidden===2?"VIRTUAL":"STORED";const B=this.selectTypeormMetadataSql({table:o.name,type:de.GENERATED_COLUMN,name:Y.name}),U=await this.query(B.query,B.parameters);U[0]&&U[0].value?Y.asExpression=U[0].value:Y.asExpression=""}Y.type==="varchar"&&(Y.enum=K.parseSqlCheckExpression(s,Y.name));const Q=Y.type.indexOf("(");if(Q!==-1){const B=Y.type,U=B.substr(0,Q);if(this.driver.withLengthColumnTypes.find(k=>k===U)){const k=parseInt(B.substring(Q+1,B.length-1));k&&(Y.length=k.toString(),Y.type=U)}if(this.driver.withPrecisionColumnTypes.find(k=>k===U)){const k=new RegExp(`^${U}\\((\\d+),?\\s?(\\d+)?\\)`),L=B.match(k);L&&L[1]&&(Y.precision=+L[1]),this.driver.withScaleColumnTypes.find(V=>V===U)&&L&&L[2]&&(Y.scale=+L[2]),Y.type=U}}return Y}));let b;const A=[],P=/CONSTRAINT "([^"]*)" FOREIGN KEY ?\((.*?)\) REFERENCES "([^"]*)"/g;for(;(b=P.exec(s))!==null;)A.push({name:b[1],columns:b[2].substr(1,b[2].length-2).split('", "'),referencedTableName:b[3]});const D=K.uniq(l,v=>v.id);o.foreignKeys=D.map(v=>{const Y=l.filter(k=>k.id===v.id&&k.table===v.table),Q=Y.map(k=>k.from),B=Y.map(k=>k.to),U=A.find(k=>k.referencedTableName===v.table&&k.columns.every(L=>Q.indexOf(L)!==-1));return new Je({name:U?.name,columnNames:Q,referencedTableName:v.table,referencedColumnNames:B,onDelete:v.on_delete,onUpdate:v.on_update})});let I;const W=[],G=/CONSTRAINT "([^"]*)" UNIQUE ?\((.*?)\)/g;for(;(I=G.exec(s))!==null;)W.push({name:I[1],columns:I[2].substr(1,I[2].length-2).split('", "')});const ie=u.filter(v=>v.origin==="u").map(v=>v.name).filter((v,Y,Q)=>Q.indexOf(v)===Y).map(async v=>{const Y=u.find(k=>k.name===v),B=(await this.query(`PRAGMA index_info("${Y.name}")`)).sort((k,L)=>parseInt(k.seqno)-parseInt(L.seqno)).map(k=>k.name);if(B.length===1){const k=o.columns.find(L=>!!B.find(V=>V===L.name));k&&(k.isUnique=!0)}const U=W.find(k=>k.columns.every(L=>B.indexOf(L)!==-1));return new We({name:U?U.name:this.connection.namingStrategy.uniqueConstraintName(o,B),columnNames:B})});o.uniques=await Promise.all(ie);let ne;const pe=/CONSTRAINT "([^"]*)" CHECK ?(\(.*?\))([,]|[)]$)/g;for(;(ne=pe.exec(s))!==null;)o.checks.push(new it({name:ne[1],expression:ne[2]}));const F=u.filter(v=>v.origin==="c").map(v=>v.name).filter((v,Y,Q)=>Q.indexOf(v)===Y).map(async v=>{const Y=n.find(X=>X.name===v),Q=/WHERE (.*)/.exec(Y.sql),B=u.find(X=>X.name===v),k=(await this.query(`PRAGMA index_info("${B.name}")`)).sort((X,oe)=>parseInt(X.seqno)-parseInt(oe.seqno)).map(X=>X.name),L=`${r.database?`${r.database}.`:""}${B.name}`,V=B.unique==="1"||B.unique===1;return new Be({table:o,name:L,columnNames:k,isUnique:V,where:Q?Q[1]:void 0})}),se=await Promise.all(F);return o.indices=se.filter(v=>!!v),o}))}createTableSql(e,t,n){const r=e.columns.filter(f=>f.isPrimary),i=r.find(f=>f.isGenerated&&f.generationStrategy==="increment"),s=r.length>1;if(s&&i)throw new M("Sqlite does not support AUTOINCREMENT on composite primary key");const a=e.columns.map(f=>this.buildCreateColumnSql(f,s)).join(", "),[o]=this.splitTablePath(e.name);let c=`CREATE TABLE ${this.escapePath(e.name)} (${a}`;const[u,l]=this.splitTablePath(e.name),h=n?`${u?`${u}.`:""}${l.replace(/^temporary_/,"")}`:e.name;if(e.columns.filter(f=>f.isUnique).forEach(f=>{e.uniques.some(b=>b.columnNames.length===1&&b.columnNames[0]===f.name)||e.uniques.push(new We({name:this.connection.namingStrategy.uniqueConstraintName(e,[f.name]),columnNames:[f.name]}))}),e.uniques.length>0){const f=e.uniques.map(E=>{const b=E.name?E.name:this.connection.namingStrategy.uniqueConstraintName(h,E.columnNames),A=E.columnNames.map(P=>`"${P}"`).join(", ");return`CONSTRAINT "${b}" UNIQUE (${A})`}).join(", ");c+=`, ${f}`}if(e.checks.length>0){const f=e.checks.map(E=>`CONSTRAINT "${E.name?E.name:this.connection.namingStrategy.checkConstraintName(h,E.expression)}" CHECK (${E.expression})`).join(", ");c+=`, ${f}`}if(e.foreignKeys.length>0&&t){const f=e.foreignKeys.filter(E=>{const[b]=this.splitTablePath(E.referencedTableName);return b===o}).map(E=>{const[,b]=this.splitTablePath(E.referencedTableName),A=E.columnNames.map(I=>`"${I}"`).join(", ");E.name||(E.name=this.connection.namingStrategy.foreignKeyName(h,E.columnNames,this.getTablePath(E),E.referencedColumnNames));const P=E.referencedColumnNames.map(I=>`"${I}"`).join(", ");let D=`CONSTRAINT "${E.name}" FOREIGN KEY (${A}) REFERENCES "${b}" (${P})`;return E.onDelete&&(D+=` ON DELETE ${E.onDelete}`),E.onUpdate&&(D+=` ON UPDATE ${E.onUpdate}`),E.deferrable&&(D+=` DEFERRABLE ${E.deferrable}`),D}).join(", ");c+=`, ${f}`}if(r.length>1){const f=r.map(E=>`"${E.name}"`).join(", ");c+=`, PRIMARY KEY (${f})`}return c+=")",e.withoutRowid&&(c+=" WITHOUT ROWID"),new R(c)}dropTableSql(e,t){const n=q.isTable(e)?e.name:e,r=t?`DROP TABLE IF EXISTS ${this.escapePath(n)}`:`DROP TABLE ${this.escapePath(n)}`;return new R(r)}createViewSql(e){return typeof e.expression=="string"?new R(`CREATE VIEW "${e.name}" AS ${e.expression}`):new R(`CREATE VIEW "${e.name}" AS ${e.expression(this.connection).getQuery()}`)}insertViewDefinitionSql(e){const t=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:de.VIEW,name:e.name,value:t})}dropViewSql(e){const t=q.isView(e)?e.name:e;return new R(`DROP VIEW "${t}"`)}deleteViewDefinitionSql(e){const t=q.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:de.VIEW,name:t})}createIndexSql(e,t){const n=t.columnNames.map(s=>`"${s}"`).join(", "),[r,i]=this.splitTablePath(e.name);return new R(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX ${r?`"${r}".`:""}${this.escapePath(t.name)} ON "${i}" (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e){const t=q.isTableIndex(e)?e.name:e;return new R(`DROP INDEX ${this.escapePath(t)}`)}buildCreateColumnSql(e,t){let n='"'+e.name+'"';return q.isColumnMetadata(e)?n+=" "+this.driver.normalizeType(e):n+=" "+this.connection.driver.createFullType(e),e.enum&&(n+=' CHECK( "'+e.name+'" IN ('+e.enum.map(r=>"'"+r+"'").join(",")+") )"),e.isPrimary&&!t&&(n+=" PRIMARY KEY"),e.isGenerated===!0&&e.generationStrategy==="increment"&&(n+=" AUTOINCREMENT"),e.collation&&(n+=" COLLATE "+e.collation),e.isNullable!==!0&&(n+=" NOT NULL"),e.asExpression?n+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`:e.default!==void 0&&e.default!==null&&(n+=" DEFAULT ("+e.default+")"),n}async recreateTable(e,t,n=!0){const r=[],i=[];t.indices.forEach(c=>{r.push(this.dropIndexSql(c)),i.push(this.createIndexSql(t,c))});let[s,a]=this.splitTablePath(e.name);const[,o]=this.splitTablePath(t.name);if(e.name=a=`${s?`${s}.`:""}temporary_${a}`,r.push(this.createTableSql(e,!0,!0)),i.push(this.dropTableSql(e)),n){let c=e.columns.filter(l=>!l.generatedType).map(l=>`"${l.name}"`),u=t.columns.filter(l=>!l.generatedType).map(l=>`"${l.name}"`);u.length<c.length?c=e.columns.filter(l=>{const h=t.columns.find(f=>f.name===l.name);return h&&h.generatedType?!1:!l.generatedType&&h}).map(l=>`"${l.name}"`):u.length>c.length&&(u=t.columns.filter(l=>!l.generatedType&&e.columns.find(h=>h.name===l.name)).map(l=>`"${l.name}"`)),r.push(new R(`INSERT INTO ${this.escapePath(e.name)}(${c.join(", ")}) SELECT ${u.join(", ")} FROM ${this.escapePath(t.name)}`)),i.push(new R(`INSERT INTO ${this.escapePath(t.name)}(${u.join(", ")}) SELECT ${c.join(", ")} FROM ${this.escapePath(e.name)}`))}r.push(this.dropTableSql(t)),i.push(this.createTableSql(t,!0)),r.push(new R(`ALTER TABLE ${this.escapePath(e.name)} RENAME TO ${this.escapePath(o)}`)),i.push(new R(`ALTER TABLE ${this.escapePath(t.name)} RENAME TO ${this.escapePath(a)}`)),e.name=t.name,e.indices.forEach(c=>{c.name||(c.name=this.connection.namingStrategy.indexName(e,c.columnNames,c.where)),r.push(this.createIndexSql(e,c)),i.push(this.dropIndexSql(c))}),t.columns.filter(c=>{const u=e.columns.find(l=>l.name===c.name);return c.generatedType&&c.asExpression&&(!u||!u.generatedType&&!u.asExpression)}).forEach(c=>{const u=this.deleteTypeormMetadataSql({table:t.name,type:de.GENERATED_COLUMN,name:c.name}),l=this.insertTypeormMetadataSql({table:t.name,type:de.GENERATED_COLUMN,name:c.name,value:c.asExpression});r.push(u),i.push(l)}),e.columns.filter(c=>c.generatedType&&c.asExpression&&!t.columns.some(u=>u.name===c.name)).forEach(c=>{const u=this.insertTypeormMetadataSql({table:e.name,type:de.GENERATED_COLUMN,name:c.name,value:c.asExpression}),l=this.deleteTypeormMetadataSql({table:e.name,type:de.GENERATED_COLUMN,name:c.name});r.push(u),i.push(l)}),e.columns.filter(c=>c.generatedType&&c.asExpression).forEach(c=>{const u=t.columns.find(b=>b.name===c.name&&b.generatedType&&c.generatedType&&b.asExpression!==c.asExpression);if(!u)return;const l=this.deleteTypeormMetadataSql({table:t.name,type:de.GENERATED_COLUMN,name:u.name}),h=this.insertTypeormMetadataSql({table:e.name,type:de.GENERATED_COLUMN,name:c.name,value:c.asExpression});r.push(l),r.push(h);const f=this.insertTypeormMetadataSql({table:e.name,type:de.GENERATED_COLUMN,name:u.name,value:u.asExpression}),E=this.deleteTypeormMetadataSql({table:t.name,type:de.GENERATED_COLUMN,name:c.name});i.push(f),i.push(E)}),await this.executeQueries(r,i),this.replaceCachedTable(t,e)}splitTablePath(e){return e.indexOf(".")!==-1?e.split("."):[void 0,e]}escapePath(e,t){return(q.isTable(e)||q.isView(e)?e.name:e).replace(/^\.+|\.+$/g,"").split(".").map(r=>t?r:`"${r}"`).join(".")}changeTableComment(e,t){throw new M("sqlit driver does not support change comment.")}}class fc extends gt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ct(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new He;const r=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const i=new Xe,s=Date.now();try{const a=await new Promise((h,f)=>{r.executeSql(e,t,E=>h(E),E=>f(E))}),o=this.driver.options.maxQueryExecutionTime,u=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,u,a,void 0),o&&u>o&&this.driver.connection.logger.logQuerySlow(u,e,t,this);const l=new at;if(e.substr(0,11)==="INSERT INTO")l.raw=a.insertId;else{const h=[];for(let f=0;f<a.rows.length;f++)h.push(a.rows.item(f));l.records=h,l.raw=h}return n?l:l.raw}catch(a){throw this.driver.connection.logger.logQueryError(a,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,a),new rt(e,t,a)}finally{await i.wait()}}async startTransaction(){throw new M("Transactions are not supported by the Cordova driver")}async commitTransaction(){throw new M("Transactions are not supported by the Cordova driver")}async rollbackTransaction(){throw new M("Transactions are not supported by the Cordova driver")}async clearDatabase(){await this.query("PRAGMA foreign_keys = OFF");try{const t=await this.query(`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`),r=await this.query(`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`);await Promise.all(t.map(i=>this.query(i.query))),await Promise.all(r.map(i=>this.query(i.query)))}finally{await this.query("PRAGMA foreign_keys = ON")}}parametrize(e,t=0){return Object.keys(e).map((n,r)=>`"${n}"=?`)}}class mc extends At{constructor(e){super(e),this.transactionSupport="none",this.database=this.options.database,this.loadDependencies()}async disconnect(){return this.queryRunner=void 0,new Promise((e,t)=>{this.databaseConnection.close(e,t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new fc(this)),this.queryRunner}async createDatabaseConnection(){const e=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{}),t=await new Promise((n,r)=>{this.sqlite.openDatabase(e,i=>n(i),i=>r(i))});return await new Promise((n,r)=>{t.executeSql("PRAGMA foreign_keys = ON",[],()=>n(),i=>r(i))}),t}loadDependencies(){try{const e=this.options.driver||window.sqlitePlugin;this.sqlite=e}catch{throw new bt("Cordova-SQLite","cordova-sqlite-storage")}}}class yc extends gt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ct(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new He;const r=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const i=new Xe,s=Date.now();return new Promise(async(a,o)=>{try{r.executeSql(e,t,async c=>{const u=this.driver.options.maxQueryExecutionTime,h=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,h,c,void 0),u&&h>u&&this.driver.connection.logger.logQuerySlow(h,e,t,this),i.promises.length>0&&await Promise.all(i.promises);const f=new at;if(c?.hasOwnProperty("rowsAffected")&&(f.affected=c.rowsAffected),c?.hasOwnProperty("rows")){const E=[];for(let b=0;b<c.rows.length;b++)E.push(c.rows.item(b));f.raw=E,f.records=E}e.substr(0,11)==="INSERT INTO"&&(f.raw=c.insertId),a(n?f:f.raw)},c=>{this.driver.connection.logger.logQueryError(c,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,c),o(new rt(e,t,c))})}catch(c){o(c)}finally{await i.wait()}})}parametrize(e,t=0){return Object.keys(e).map((n,r)=>`"${n}"=?`)}}class gc{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=this.options.database,this.loadDependencies()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new yc(this)),this.queryRunner}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(e,t)})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){return this.attachedDatabases?.[e]?.attachHandle}getAttachedDatabasePathRelativeByHandle(e){return Object.values(this.attachedDatabases).find(({attachHandle:t})=>e===t)?.attachFilepathRelative}createSchemaBuilder(){return new Zt(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=ke.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?he.mixedDateToDateString(e):t.type==="time"?he.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?he.mixedDateToUtcDatetimeString(e):t.type==="simple-array"?he.simpleArrayToString(e):t.type==="simple-json"?he.simpleJsonToString(e):t.type==="simple-enum"?he.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?ke.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=he.normalizeHydratedDate(e)):t.type==="date"?e=he.mixedDateToDateString(e):t.type==="time"?e=he.mixedTimeToString(e):t.type==="simple-array"?e=he.stringToSimpleArray(e):t.type==="simple-json"?e=he.stringToSimpleJson(e):t.type==="simple-enum"?e=he.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=ke.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){const r=Object.keys(n).map(i=>typeof n[i]=="boolean"?n[i]===!0?1:0:n[i]instanceof Date?he.mixedDateToUtcDatetimeString(n[i]):n[i]);return!t||!Object.keys(t).length?[e,r]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,s,a)=>{if(!t.hasOwnProperty(a))return i;const o=t[a];return s?o.map(c=>(r.push(c),this.createParameter(a,r.length-1))).join(", "):typeof o=="function"?o():typeof o=="number"?String(o):typeof o=="boolean"?(r.push(+o),this.createParameter(a,r.length-1)):o instanceof Date?(r.push(he.mixedDateToUtcDatetimeString(o)),this.createParameter(a,r.length-1)):(r.push(o),this.createParameter(a,r.length-1))}),[e,r])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){const t=this.database,n=void 0;if(q.isTable(e)||q.isView(e)){const i=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if(q.isTableForeignKey(e)){const i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if(q.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const r=e.split(".");return r.length===3?{database:r[0]||t,schema:r[1]||n,tableName:r[2]}:r.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(r[0])??t,schema:r[0],tableName:r[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){const t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,r){const i=e.generatedColumns.reduce((s,a)=>{let o;return a.generationStrategy==="increment"&&t&&(o=t-r+n+1),o?K.mergeDeep(s,a.createValueMap(o)):s},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{const r=e.find(s=>s.name===n.databaseName);return r?r.name!==n.databaseName||r.type!==this.normalizeType(n)||r.length!==n.length||r.precision!==n.precision||r.scale!==n.scale||this.normalizeDefault(n)!==r.default||r.isPrimary!==n.isPrimary||r.isNullable!==n.isNullable||r.generatedType!==n.generatedType||r.asExpression!==n.asExpression||r.isUnique!==this.normalizeIsUnique(n)||r.enum&&n.enum&&!K.isArraysEqual(r.enum,n.enum.map(s=>s+""))||n.generationStrategy!=="uuid"&&r.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}createDatabaseConnection(){return new Promise((e,t)=>{const n=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{});this.sqlite.openDatabase(n,r=>{const i=r;i.executeSql("PRAGMA foreign_keys = ON",[],s=>{e(i)},s=>{t(s)})},r=>{t(r)})})}loadDependencies(){try{const e=this.options.driver||require("react-native-sqlite-storage");this.sqlite=e}catch{throw new bt("React-Native","react-native-sqlite-storage")}}}class Ec extends gt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ct(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new He;const r=this.driver.connection,i=await this.connect();return new Promise((s,a)=>{const o=e.substr(0,11)==="INSERT INTO";r.logger.logQuery(e,t,this);const c=(l,h)=>{const f=this.driver.options.maxQueryExecutionTime,b=Date.now()-u;f&&b>f&&r.logger.logQuerySlow(b,e,t,this),l&&(r.logger.logQueryError(l,e,t,this),a(new rt(e,t,l)));const A=new at;A.raw=h,!o&&Array.isArray(h)&&(A.records=h),s(n?A:A.raw)},u=Date.now();o?i.execSQL(e,t,c):i.all(e,t,c)})}parametrize(e,t=0){return Object.keys(e).map((n,r)=>`"${n}"=?`)}}class Tc extends At{constructor(e){super(e),this.connection=e,this.options=e.options,this.database=this.options.database,this.driver=this.options.driver,this.loadDependencies()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close().then(e).catch(t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Ec(this)),this.queryRunner}normalizeType(e){return e.type===Buffer?"blob":super.normalizeType(e)}createDatabaseConnection(){return new Promise((e,t)=>{const n=Object.assign({},{readOnly:this.options.readOnly,key:this.options.key,multithreading:this.options.multithreading,migrate:this.options.migrate,iosFlags:this.options.iosFlags,androidFlags:this.options.androidFlags},this.options.extra||{});new this.sqlite(this.options.database,n,(r,i)=>{if(r)return t(r);i.resultType(this.sqlite.RESULTSASOBJECT),i.execSQL("PRAGMA foreign_keys = ON",[],(s,a)=>{if(s)return t(s);e(i)})})})}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new bt("Nativescript","nativescript-sqlite")}}class bc extends gt{constructor(e){super(),this.isDirty=!1,this.driver=e,this.connection=e.connection,this.broadcaster=new ct(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async flush(){this.isDirty&&(await this.driver.autoSave(),this.isDirty=!1)}async release(){return await this.flush(),super.release()}async commitTransaction(){await super.commitTransaction(),this.isTransactionActive||await this.flush()}async query(e,t=[],n=!1){if(this.isReleased)throw new He;const r=e.trim().split(" ",1)[0],i=this.driver.databaseConnection;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const s=new Xe,a=Date.now();let o;try{o=i.prepare(e),t&&(t=t.map(E=>typeof E<"u"?E:null),o.bind(t));const c=this.driver.options.maxQueryExecutionTime,l=Date.now()-a;c&&l>c&&this.driver.connection.logger.logQuerySlow(l,e,t,this);const h=[];for(;o.step();)h.push(o.getAsObject());this.broadcaster.broadcastAfterQueryEvent(s,e,t,!0,l,h,void 0);const f=new at;return f.affected=i.getRowsModified(),f.records=h,f.raw=h,o.free(),r!=="SELECT"&&(this.isDirty=!0),n?f:f.raw}catch(c){throw o&&o.free(),this.driver.connection.logger.logQueryError(c,e,t,this),this.broadcaster.broadcastAfterQueryEvent(s,e,t,!1,void 0,void 0,c),new rt(e,t,c)}finally{await s.wait()}}}class wc extends At{constructor(e){if(super(e),this.options.autoSave&&!this.options.location&&!this.options.autoSaveCallback)throw new pa("location or autoSaveCallback");this.loadDependencies()}async connect(){this.databaseConnection=await this.createDatabaseConnection()}async disconnect(){this.queryRunner=void 0,this.databaseConnection.close()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new bc(this)),this.queryRunner}async load(e,t=!0){if(typeof e=="string")if(ve.type==="node")if(ve.fileExist(e)){const n=ve.readFileSync(e);return this.createDatabaseConnectionWithImport(n)}else{if(t)throw new M(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else{let n=null;if(this.options.useLocalForage)if(window.localforage)n=await window.localforage.getItem(e);else throw new M("localforage is not defined - please import localforage.js into your site");else n=ve.getGlobalVariable().localStorage.getItem(e);if(n!=null)return this.createDatabaseConnectionWithImport(JSON.parse(n));if(t)throw new M(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else return this.createDatabaseConnectionWithImport(e)}async save(e){if(!e&&!this.options.location)throw new M("No location is set, specify a location parameter or add the location option to your configuration");let t="";if(e?t=e:this.options.location&&(t=this.options.location),ve.type==="node")try{const n=Buffer.from(this.databaseConnection.export());await ve.writeFile(t,n)}catch(n){throw new M(`Could not save database, error: ${n}`)}else{const n=this.databaseConnection.export(),r=[].slice.call(n);if(this.options.useLocalForage)if(window.localforage)await window.localforage.setItem(t,JSON.stringify(r));else throw new M("localforage is not defined - please import localforage.js into your site");else ve.getGlobalVariable().localStorage.setItem(t,JSON.stringify(r))}}async autoSave(){this.options.autoSave&&!this.queryRunner?.isTransactionActive&&(this.options.autoSaveCallback?await this.options.autoSaveCallback(this.export()):await this.save())}export(){return this.databaseConnection.export()}createGeneratedMap(e,t){const n=e.generatedColumns.reduce((r,i)=>{if(i.isPrimary&&i.generationStrategy==="increment"){const s="SELECT last_insert_rowid()";try{const a=this.databaseConnection.exec(s);return this.connection.logger.logQuery(s),K.mergeDeep(r,i.createValueMap(a[0].values[0][0]))}catch(a){this.connection.logger.logQueryError(a,s,[])}}return r},{});return Object.keys(n).length>0?n:void 0}createDatabaseConnection(){return this.options.location?this.load(this.options.location,!1):this.createDatabaseConnectionWithImport(this.options.database)}async createDatabaseConnectionWithImport(e){const n=typeof this.sqlite.Database=="function"?this.sqlite:await this.sqlite(this.options.sqlJsConfig);return e&&e.length>0?this.databaseConnection=new n.Database(e):this.databaseConnection=new n.Database,this.databaseConnection.exec("PRAGMA foreign_keys = ON"),this.databaseConnection}loadDependencies(){if(ve.type==="browser"){const e=this.options.driver||window.SQL;this.sqlite=e}else try{const e=this.options.driver||ve.load("sql.js");this.sqlite=e}catch{throw new bt("sql.js","sql.js")}}}class Nc extends gt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ct(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new He;const r=await this.connect(),i=new Xe;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const s=Date.now(),a=await r.prepareAsync(e);try{const o=await a.executeAsync(t),c=this.driver.options.maxQueryExecutionTime,l=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,l,o,void 0),await i.wait(),c&&l>c&&this.driver.connection.logger.logQuerySlow(l,e,t,this);const h=new at;return h.affected=o.changes,h.records=await o.getAllAsync(),h.raw=e.startsWith("INSERT INTO")?o.lastInsertRowId:h.records,n?h:h.raw}catch(o){throw this.driver.connection.logger.logQueryError(o,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,0,void 0,o),await i.wait(),new rt(e,t,o)}finally{await i.wait(),await a.finalizeAsync()}}}class Ac extends At{constructor(e){super(e),this.sqlite=this.options.driver}async disconnect(){this.queryRunner=void 0,await this.databaseConnection.closeAsync(),this.databaseConnection=void 0}createQueryRunner(){return this.queryRunner||(this.queryRunner=new Nc(this)),this.queryRunner}async createDatabaseConnection(){return this.databaseConnection=await this.sqlite.openDatabaseAsync(this.options.database),await this.databaseConnection.runAsync("PRAGMA foreign_keys = ON"),this.databaseConnection}}class Cc extends gt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ct(this)}async startTransaction(){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(e){throw this.isTransactionActive=!1,e}this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new Ye;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new Ye;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async beforeMigration(){const e=await this.connect();return new Promise((t,n)=>{e.exec([{sql:"PRAGMA foreign_keys = OFF",args:[]}],!1,r=>r?n(r):t())})}async afterMigration(){const e=await this.connect();return new Promise((t,n)=>{e.exec([{sql:"PRAGMA foreign_keys = ON",args:[]}],!1,r=>r?n(r):t())})}async query(e,t,n=!1){if(this.isReleased)throw new He;return new Promise(async(r,i)=>{const s=await this.connect(),a=new Xe;this.driver.connection.logger.logQuery(e,t,this),this.broadcaster.broadcastBeforeQueryEvent(a,e,t);const o=Date.now();s.transaction(async c=>{typeof this.transaction>"u"&&(await this.startTransaction(),this.transaction=c),this.transaction.executeSql(e,t,async(u,l)=>{const h=this.driver.options.maxQueryExecutionTime,E=Date.now()-o;this.broadcaster.broadcastAfterQueryEvent(a,e,t,!0,E,l,void 0),await a.wait(),h&&E>h&&this.driver.connection.logger.logQuerySlow(E,e,t,this);const b=new at;if(l?.hasOwnProperty("rowsAffected")&&(b.affected=l.rowsAffected),l?.hasOwnProperty("rows")){const A=[];for(let P=0;P<l.rows.length;P++)A.push(l.rows.item(P));b.raw=A,b.records=A}e.startsWith("INSERT INTO")&&(b.raw=l.insertId),r(n?b:b.raw)},async(u,l)=>{this.driver.connection.logger.logQueryError(l,e,t,this),this.broadcaster.broadcastAfterQueryEvent(a,e,t,!1,void 0,void 0,l),await a.wait(),i(new rt(e,t,l))})},async c=>{await this.rollbackTransaction(),i(c)},()=>{this.isTransactionActive=!1,this.transaction=void 0})})}}class Sc extends At{constructor(e){super(e),this.database=this.options.database,this.sqlite=this.options.driver}async disconnect(){return new Promise((e,t)=>{try{this.queryRunner=void 0,this.databaseConnection._db.close(),this.databaseConnection=void 0,e()}catch(n){t(n)}})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Cc(this)),this.queryRunner}createDatabaseConnection(){return new Promise((e,t)=>{try{const n=this.sqlite.openDatabase(this.options.database);n.transaction(r=>{r.executeSql("PRAGMA foreign_keys = ON",[],(i,s)=>{e(n)},(i,s)=>{t({transaction:i,error:s})})},r=>{t(r)})}catch(n){t(n)}})}}class Rc{constructor(e){this.connection=e}create(){return this.isLegacyDriver?new Sc(this.connection):new Ac(this.connection)}get isLegacyDriver(){return!("openDatabaseAsync"in this.connection.options.driver)}}class xc extends en{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.client=t,this.broadcaster=new ct(this)}async connect(){return{}}release(){return this.isReleased=!0,this.databaseConnection&&this.databaseConnection.release(),Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new He;const r=await this.client.query(e,t),i=new at;return i.raw=r,r?.hasOwnProperty("records")&&Array.isArray(r.records)&&(i.records=r.records),r?.hasOwnProperty("numberOfRecordsUpdated")&&(i.affected=r.numberOfRecordsUpdated),n?i:i.raw}stream(e,t,n,r){if(this.isReleased)throw new He;return new Promise(async(i,s)=>{try{const o=(await this.connect()).query(e,t);n&&o.on("end",n),r&&o.on("error",r),i(o)}catch(a){s(a)}})}async getDatabases(){return Promise.resolve([])}async getSchemas(e){throw new M("MySql driver does not support table schemas")}async hasDatabase(e){return!!(await this.query(`SELECT * FROM \`INFORMATION_SCHEMA\`.\`SCHEMATA\` WHERE \`SCHEMA_NAME\` = '${e}'`)).length}async getCurrentDatabase(){return(await this.query("SELECT DATABASE() AS `db_name`"))[0].db_name}async hasSchema(e){throw new M("MySql driver does not support table schemas")}async getCurrentSchema(){return(await this.query("SELECT SCHEMA() AS `schema_name`"))[0].schema_name}async hasTable(e){const t=this.driver.parseTableName(e),n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${t.database}' AND \`TABLE_NAME\` = '${t.tableName}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=this.driver.parseTableName(e),r=q.isTableColumn(t)?t.name:t,i=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${n.database}' AND \`TABLE_NAME\` = '${n.tableName}' AND \`COLUMN_NAME\` = '${r}'`;return!!(await this.query(i)).length}async createDatabase(e,t){const n=t?`CREATE DATABASE IF NOT EXISTS \`${e}\``:`CREATE DATABASE \`${e}\``,r=`DROP DATABASE \`${e}\``;await this.executeQueries(new R(n),new R(r))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS \`${e}\``:`DROP DATABASE \`${e}\``,r=`CREATE DATABASE \`${e}\``;await this.executeQueries(new R(n),new R(r))}async createSchema(e,t){throw new M("Schema create queries are not supported by MySql driver.")}async dropSchema(e,t){throw new M("Schema drop queries are not supported by MySql driver.")}async createTable(e,t=!1,n=!0){if(t&&await this.hasTable(e))return Promise.resolve();const r=[],i=[];return r.push(this.createTableSql(e,n)),i.push(this.dropTableSql(e)),e.indices.forEach(s=>i.push(this.dropIndexSql(e,s))),n&&e.foreignKeys.forEach(s=>i.push(this.dropForeignKeySql(e,s))),this.executeQueries(r,i)}async dropTable(e,t,n=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const r=n,i=this.getTablePath(e),s=await this.getCachedTable(i),a=[],o=[];n&&s.foreignKeys.forEach(c=>a.push(this.dropForeignKeySql(s,c))),s.indices.forEach(c=>a.push(this.dropIndexSql(s,c))),a.push(this.dropTableSql(s)),o.push(this.createTableSql(s,r)),await this.executeQueries(a,o)}async createView(e,t=!1){const n=[],r=[];n.push(this.createViewSql(e)),t&&n.push(await this.insertViewDefinitionSql(e)),r.push(this.dropViewSql(e)),t&&r.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(n,r)}async dropView(e){const t=q.isView(e)?e.name:e,n=await this.getCachedView(t),r=[],i=[];r.push(await this.deleteViewDefinitionSql(n)),r.push(this.dropViewSql(n)),i.push(await this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(r,i)}async renameTable(e,t){const n=[],r=[],i=q.isTable(e)?e:await this.getCachedTable(e),s=i.clone(),{database:a}=this.driver.parseTableName(i);s.name=a?`${a}.${t}`:t,n.push(new R(`RENAME TABLE ${this.escapePath(i)} TO ${this.escapePath(s)}`)),r.push(new R(`RENAME TABLE ${this.escapePath(s)} TO ${this.escapePath(i)}`)),s.indices.forEach(o=>{const c=o.columnNames.map(h=>`\`${h}\``).join(", "),u=this.connection.namingStrategy.indexName(s,o.columnNames,o.where);let l="";o.isUnique&&(l+="UNIQUE "),o.isSpatial&&(l+="SPATIAL "),o.isFulltext&&(l+="FULLTEXT "),n.push(new R(`ALTER TABLE ${this.escapePath(s)} DROP INDEX \`${o.name}\`, ADD ${l}INDEX \`${u}\` (${c})`)),r.push(new R(`ALTER TABLE ${this.escapePath(s)} DROP INDEX \`${u}\`, ADD ${l}INDEX \`${o.name}\` (${c})`)),o.name=u}),s.foreignKeys.forEach(o=>{const c=o.columnNames.map(E=>`\`${E}\``).join(", "),u=o.referencedColumnNames.map(E=>`\`${E}\``).join(","),l=this.connection.namingStrategy.foreignKeyName(s,o.columnNames);let h=`ALTER TABLE ${this.escapePath(s)} DROP FOREIGN KEY \`${o.name}\`, ADD CONSTRAINT \`${l}\` FOREIGN KEY (${c}) REFERENCES ${this.escapePath(this.getTablePath(o))}(${u})`;o.onDelete&&(h+=` ON DELETE ${o.onDelete}`),o.onUpdate&&(h+=` ON UPDATE ${o.onUpdate}`);let f=`ALTER TABLE ${this.escapePath(s)} DROP FOREIGN KEY \`${l}\`, ADD CONSTRAINT \`${o.name}\` FOREIGN KEY (${c}) REFERENCES ${this.escapePath(this.getTablePath(o))}(${u})`;o.onDelete&&(f+=` ON DELETE ${o.onDelete}`),o.onUpdate&&(f+=` ON UPDATE ${o.onUpdate}`),n.push(new R(h)),r.push(new R(f)),o.name=l}),await this.executeQueries(n,r),i.name=s.name,this.replaceCachedTable(i,s)}async addColumn(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=[],s=[],a=r.primaryColumns.length>0;if(i.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(t,a,!1)}`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN \`${t.name}\``)),t.isPrimary&&a){const c=r.columns.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(c){const h=c.clone();h.isGenerated=!1,h.generationStrategy=void 0,i.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(h,!0)}`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(t,!0)}`))}const u=r.primaryColumns;let l=u.map(h=>`\`${h.name}\``).join(", ");if(i.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${l})`)),u.push(t),l=u.map(h=>`\`${h.name}\``).join(", "),i.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${l})`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),c){const h=c.clone();h.isGenerated=!1,h.generationStrategy=void 0,i.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(t,!0)}`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(h,!0)}`))}}const o=r.indices.find(c=>c.columnNames.length===1&&c.columnNames[0]===t.name);if(o)i.push(this.createIndexSql(n,o)),s.push(this.dropIndexSql(n,o));else if(t.isUnique){const c=new Be({name:this.connection.namingStrategy.indexName(n,[t.name]),columnNames:[t.name],isUnique:!0});r.indices.push(c),r.uniques.push(new We({name:c.name,columnNames:c.columnNames})),i.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${c.name}\` (\`${t.name}\`)`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${c.name}\``))}await this.executeQueries(i,s),r.addColumn(t),this.replaceCachedTable(n,r)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const r=q.isTable(e)?e:await this.getCachedTable(e),i=q.isTableColumn(t)?t:r.columns.find(a=>a.name===t);if(!i)throw new M(`Column "${t}" was not found in the "${r.name}" table.`);let s;q.isTableColumn(n)?s=n:(s=i.clone(),s.name=n),await this.changeColumn(r,i,s)}async changeColumn(e,t,n){const r=q.isTable(e)?e:await this.getCachedTable(e);let i=r.clone();const s=[],a=[],o=q.isTableColumn(t)?t:r.columns.find(c=>c.name===t);if(!o)throw new M(`Column "${t}" was not found in the "${r.name}" table.`);if(n.isGenerated!==o.isGenerated&&n.generationStrategy!=="uuid"||o.type!==n.type||o.length!==n.length||o.generatedType!==n.generatedType)await this.dropColumn(r,o),await this.addColumn(r,n),i=r.clone();else{if(n.name!==o.name){s.push(new R(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${o.name}\` \`${n.name}\` ${this.buildCreateColumnSql(o,!0,!0)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${n.name}\` \`${o.name}\` ${this.buildCreateColumnSql(o,!0,!0)}`)),i.findColumnIndices(o).forEach(u=>{u.columnNames.splice(u.columnNames.indexOf(o.name),1),u.columnNames.push(n.name);const l=u.columnNames.map(E=>`\`${E}\``).join(", "),h=this.connection.namingStrategy.indexName(i,u.columnNames,u.where);let f="";u.isUnique&&(f+="UNIQUE "),u.isSpatial&&(f+="SPATIAL "),u.isFulltext&&(f+="FULLTEXT "),s.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${u.name}\`, ADD ${f}INDEX \`${h}\` (${l})`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${h}\`, ADD ${f}INDEX \`${u.name}\` (${l})`)),u.name=h}),i.findColumnForeignKeys(o).forEach(u=>{u.columnNames.splice(u.columnNames.indexOf(o.name),1),u.columnNames.push(n.name);const l=u.columnNames.map(A=>`\`${A}\``).join(", "),h=u.referencedColumnNames.map(A=>`\`${A}\``).join(","),f=this.connection.namingStrategy.foreignKeyName(i,u.columnNames);let E=`ALTER TABLE ${this.escapePath(r)} DROP FOREIGN KEY \`${u.name}\`, ADD CONSTRAINT \`${f}\` FOREIGN KEY (${l}) REFERENCES ${this.escapePath(this.getTablePath(u))}(${h})`;u.onDelete&&(E+=` ON DELETE ${u.onDelete}`),u.onUpdate&&(E+=` ON UPDATE ${u.onUpdate}`);let b=`ALTER TABLE ${this.escapePath(r)} DROP FOREIGN KEY \`${f}\`, ADD CONSTRAINT \`${u.name}\` FOREIGN KEY (${l}) REFERENCES ${this.escapePath(this.getTablePath(u))}(${h})`;u.onDelete&&(b+=` ON DELETE ${u.onDelete}`),u.onUpdate&&(b+=` ON UPDATE ${u.onUpdate}`),s.push(new R(E)),a.push(new R(b)),u.name=f});const c=i.columns.find(u=>u.name===o.name);i.columns[i.columns.indexOf(c)].name=n.name,o.name=n.name}if(this.isColumnChanged(o,n,!0)&&(s.push(new R(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${o.name}\` ${this.buildCreateColumnSql(n,!0)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${n.name}\` ${this.buildCreateColumnSql(o,!0)}`))),n.isPrimary!==o.isPrimary){const c=i.columns.find(l=>l.isGenerated&&l.generationStrategy==="increment");if(c){const l=c.clone();l.isGenerated=!1,l.generationStrategy=void 0,s.push(new R(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(l,!0)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(c,!0)}`))}const u=i.primaryColumns;if(u.length>0){const l=u.map(h=>`\`${h.name}\``).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${l})`))}if(n.isPrimary===!0){u.push(n);const l=i.columns.find(f=>f.name===n.name);l.isPrimary=!0;const h=u.map(f=>`\`${f.name}\``).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${h})`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`))}else{const l=u.find(f=>f.name===n.name);u.splice(u.indexOf(l),1);const h=i.columns.find(f=>f.name===n.name);if(h.isPrimary=!1,u.length>0){const f=u.map(E=>`\`${E.name}\``).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${f})`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`))}}if(c){const l=c.clone();l.isGenerated=!1,l.generationStrategy=void 0,s.push(new R(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(c,!0)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(l,!0)}`))}}if(n.isUnique!==o.isUnique)if(n.isUnique===!0){const c=new Be({name:this.connection.namingStrategy.indexName(r,[n.name]),columnNames:[n.name],isUnique:!0});i.indices.push(c),i.uniques.push(new We({name:c.name,columnNames:c.columnNames})),s.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD UNIQUE INDEX \`${c.name}\` (\`${n.name}\`)`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${c.name}\``))}else{const c=i.indices.find(l=>l.columnNames.length===1&&l.isUnique===!0&&!!l.columnNames.find(h=>h===n.name));i.indices.splice(i.indices.indexOf(c),1);const u=i.uniques.find(l=>l.name===c.name);i.uniques.splice(i.uniques.indexOf(u),1),s.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${c.name}\``)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD UNIQUE INDEX \`${c.name}\` (\`${n.name}\`)`))}}await this.executeQueries(s,a),this.replaceCachedTable(r,i)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:r}of t)await this.changeColumn(e,n,r)}async dropColumn(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableColumn(t)?t:n.findColumnByName(t);if(!r)throw new M(`Column "${t}" was not found in table "${n.name}"`);const i=n.clone(),s=[],a=[];if(r.isPrimary){const c=i.columns.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(c){const h=c.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(h,!0)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(c,!0)}`))}const u=i.primaryColumns.map(h=>`\`${h.name}\``).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`)),a.push(new R(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${u})`));const l=i.findColumnByName(r.name);if(l.isPrimary=!1,i.primaryColumns.length>0){const h=i.primaryColumns.map(f=>`\`${f.name}\``).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${h})`)),a.push(new R(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`))}if(c&&c.name!==r.name){const h=c.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(c,!0)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(h,!0)}`))}}const o=i.indices.find(c=>c.columnNames.length===1&&c.columnNames[0]===r.name);if(o)i.indices.splice(i.indices.indexOf(o),1),s.push(this.dropIndexSql(n,o)),a.push(this.createIndexSql(n,o));else if(r.isUnique){const c=this.connection.namingStrategy.uniqueConstraintName(n,[r.name]),u=i.uniques.find(f=>f.name===c);u&&i.uniques.splice(i.uniques.indexOf(u),1);const l=this.connection.namingStrategy.indexName(n,[r.name]),h=i.indices.find(f=>f.name===l);h&&i.indices.splice(i.indices.indexOf(h),1),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${l}\``)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${l}\` (\`${r.name}\`)`))}s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN \`${r.name}\``)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(r,!0)}`)),await this.executeQueries(s,a),i.removeColumn(r),this.replaceCachedTable(n,i)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=this.createPrimaryKeySql(n,t),s=this.dropPrimaryKeySql(n);await this.executeQueries(i,s),r.columns.forEach(a=>{t.find(o=>o===a.name)&&(a.isPrimary=!0)}),this.replaceCachedTable(n,r)}async updatePrimaryKeys(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=t.map(h=>h.name),s=[],a=[],o=r.columns.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(o){const h=o.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${o.name}\` ${this.buildCreateColumnSql(h,!0)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(o,!0)}`))}const c=r.primaryColumns;if(c.length>0){const h=c.map(f=>`\`${f.name}\``).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${h})`))}r.columns.filter(h=>i.indexOf(h.name)!==-1).forEach(h=>h.isPrimary=!0);const u=i.map(h=>`\`${h}\``).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${u})`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`));const l=o||t.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(l){const h=l.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(l,!0)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(h,!0)}`));const f=r.columns.find(E=>E.name===l.name);f.isGenerated=!0,f.generationStrategy="increment"}await this.executeQueries(s,a),this.replaceCachedTable(n,r)}async dropPrimaryKey(e){const t=q.isTable(e)?e:await this.getCachedTable(e),n=this.dropPrimaryKeySql(t),r=this.createPrimaryKeySql(t,t.primaryColumns.map(i=>i.name));await this.executeQueries(n,r),t.primaryColumns.forEach(i=>{i.isPrimary=!1})}async createUniqueConstraint(e,t){throw new M("MySql does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new M("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new M("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new M("MySql does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){throw new M("MySql does not support check constraints.")}async createCheckConstraints(e,t){throw new M("MySql does not support check constraints.")}async dropCheckConstraint(e,t){throw new M("MySql does not support check constraints.")}async dropCheckConstraints(e,t){throw new M("MySql does not support check constraints.")}async createExclusionConstraint(e,t){throw new M("MySql does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new M("MySql does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new M("MySql does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new M("MySql does not support exclusion constraints.")}async createForeignKey(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames));const r=this.createForeignKeySql(n,t),i=this.dropForeignKeySql(n,t);await this.executeQueries(r,i),n.addForeignKey(t)}async createForeignKeys(e,t){const n=t.map(r=>this.createForeignKey(e,r));await Promise.all(n)}async dropForeignKey(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableForeignKey(t)?t:n.foreignKeys.find(a=>a.name===t);if(!r)throw new M(`Supplied foreign key was not found in table ${n.name}`);const i=this.dropForeignKeySql(n,r),s=this.createForeignKeySql(n,r);await this.executeQueries(i,s),n.removeForeignKey(r)}async dropForeignKeys(e,t){const n=t.map(r=>this.dropForeignKey(e,r));await Promise.all(n)}async createIndex(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createIndexSql(n,t),i=this.dropIndexSql(n,t);await this.executeQueries(r,i),n.addIndex(t,!0)}async createIndices(e,t){const n=t.map(r=>this.createIndex(e,r));await Promise.all(n)}async dropIndex(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableIndex(t)?t:n.indices.find(a=>a.name===t);if(!r)throw new M(`Supplied index ${t} was not found in table ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(n,r),s=this.createIndexSql(n,r);await this.executeQueries(i,s),n.removeIndex(r,!0)}async dropIndices(e,t){const n=t.map(r=>this.dropIndex(e,r));await Promise.all(n)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(e){const t=e||this.driver.database;if(t){if(!await this.hasDatabase(t))return Promise.resolve()}else throw new M("Can not clear database. No database is specified");const n=this.isTransactionActive;n||await this.startTransaction();try{const r=`SELECT concat('DROP VIEW IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`VIEWS\` WHERE \`TABLE_SCHEMA\` = '${t}'`,i=await this.query(r);await Promise.all(i.map(u=>this.query(u.query)));const s="SET FOREIGN_KEY_CHECKS = 0;",a=`SELECT concat('DROP TABLE IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_SCHEMA\` = '${t}'`,o="SET FOREIGN_KEY_CHECKS = 1;";await this.query(s);const c=await this.query(a);await Promise.all(c.map(u=>this.query(u.query))),await this.query(o),n||await this.commitTransaction()}catch(r){try{n||await this.rollbackTransaction()}catch{}throw r}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=await this.getCurrentDatabase(),r=e.map(a=>{let{database:o,tableName:c}=this.driver.parseTableName(a);return o||(o=n),`(\`t\`.\`schema\` = '${o}' AND \`t\`.\`name\` = '${c}')`}).join(" OR "),i=`SELECT \`t\`.*, \`v\`.\`check_option\` FROM ${this.escapePath(this.getTypeormMetadataTableName())} \`t\` INNER JOIN \`information_schema\`.\`views\` \`v\` ON \`v\`.\`table_schema\` = \`t\`.\`schema\` AND \`v\`.\`table_name\` = \`t\`.\`name\` WHERE \`t\`.\`type\` = '${de.VIEW}' ${r?`AND (${r})`:""}`;return(await this.query(i)).map(a=>{const o=new ht,c=a.schema===n?void 0:a.schema;return o.database=a.schema,o.name=this.driver.buildTableName(a.name,void 0,c),o.expression=a.value,o})}async loadTables(e){if(e&&e.length===0)return[];const t=[],n=await this.getCurrentDatabase();if(!e)t.push(...await this.query("SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES`"));else{const D="SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES` WHERE "+e.map(I=>{let[W,G]=I.split(".");return G||(G=W,W=this.driver.database||n),`(\`TABLE_SCHEMA\` = '${W}' AND \`TABLE_NAME\` = '${G}')`}).join(" OR ");t.push(...await this.query(D))}if(t.length===0)return[];const r=t.map(({TABLE_NAME:P,TABLE_SCHEMA:D})=>`(\`TABLE_SCHEMA\` = '${D}' AND \`TABLE_NAME\` = '${P}')`).join(" OR "),i="SELECT * FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE "+r,s=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` WHERE \`CONSTRAINT_NAME\` = 'PRIMARY' AND (${r})`,a="SELECT `SCHEMA_NAME`, `DEFAULT_CHARACTER_SET_NAME` as `CHARSET`, `DEFAULT_COLLATION_NAME` AS `COLLATION` FROM `INFORMATION_SCHEMA`.`SCHEMATA`",c=`SELECT \`s\`.* FROM \`INFORMATION_SCHEMA\`.\`STATISTICS\` \`s\` LEFT JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`rc\` ON \`s\`.\`INDEX_NAME\` = \`rc\`.\`CONSTRAINT_NAME\` WHERE (${t.map(({TABLE_NAME:P,TABLE_SCHEMA:D})=>`(\`s\`.\`TABLE_SCHEMA\` = '${D}' AND \`s\`.\`TABLE_NAME\` = '${P}')`).join(" OR ")}) AND \`s\`.\`INDEX_NAME\` != 'PRIMARY' AND \`rc\`.\`CONSTRAINT_NAME\` IS NULL`,l="SELECT `kcu`.`TABLE_SCHEMA`, `kcu`.`TABLE_NAME`, `kcu`.`CONSTRAINT_NAME`, `kcu`.`COLUMN_NAME`, `kcu`.`REFERENCED_TABLE_SCHEMA`, `kcu`.`REFERENCED_TABLE_NAME`, `kcu`.`REFERENCED_COLUMN_NAME`, `rc`.`DELETE_RULE` `ON_DELETE`, `rc`.`UPDATE_RULE` `ON_UPDATE` FROM `INFORMATION_SCHEMA`.`KEY_COLUMN_USAGE` `kcu` INNER JOIN `INFORMATION_SCHEMA`.`REFERENTIAL_CONSTRAINTS` `rc` ON `rc`.`constraint_name` = `kcu`.`constraint_name` WHERE "+t.map(({TABLE_NAME:P,TABLE_SCHEMA:D})=>`(\`kcu\`.\`TABLE_SCHEMA\` = '${D}' AND \`kcu\`.\`TABLE_NAME\` = '${P}')`).join(" OR "),[h,f,E,b,A]=await Promise.all([this.query(i),this.query(s),this.query(a),this.query(c),this.query(l)]);return t.map(P=>{const D=new $e,I=E.find(F=>F.SCHEMA_NAME===P.TABLE_SCHEMA),W=I.COLLATION,G=I.CHARSET,ie=P.TABLE_SCHEMA===n?void 0:P.TABLE_SCHEMA;D.database=P.TABLE_SCHEMA,D.name=this.driver.buildTableName(P.TABLE_NAME,void 0,ie),D.columns=h.filter(F=>F.TABLE_NAME===P.TABLE_NAME&&F.TABLE_SCHEMA===P.TABLE_SCHEMA).map(F=>{const se=b.filter(U=>U.TABLE_NAME===P.TABLE_NAME&&U.TABLE_SCHEMA===P.TABLE_SCHEMA&&U.COLUMN_NAME===F.COLUMN_NAME&&parseInt(U.NON_UNIQUE,10)===0),v=this.connection.entityMetadatas.find(U=>this.getTablePath(D)===this.getTablePath(U)),Y=se.length>0&&v&&v.indices.some(U=>se.some(k=>U.name===k.INDEX_NAME&&U.synchronize===!1)),Q=se.every(U=>b.some(k=>k.INDEX_NAME===U.INDEX_NAME&&k.COLUMN_NAME!==F.COLUMN_NAME)),B=new ze;if(B.name=F.COLUMN_NAME,B.type=F.DATA_TYPE.toLowerCase(),B.zerofill=F.COLUMN_TYPE.includes("zerofill"),B.unsigned=B.zerofill||F.COLUMN_TYPE.includes("unsigned"),this.driver.unsignedColumnTypes.includes(B.type)){const U=F.COLUMN_TYPE.substring(F.COLUMN_TYPE.indexOf("(")+1,F.COLUMN_TYPE.indexOf(")"));B.width=U&&!this.isDefaultColumnWidth(D,B,parseInt(U))?parseInt(U):void 0}if(F.COLUMN_DEFAULT===null||F.COLUMN_DEFAULT===void 0?B.default=void 0:B.default=F.COLUMN_DEFAULT==="CURRENT_TIMESTAMP"?F.COLUMN_DEFAULT:`'${F.COLUMN_DEFAULT}'`,F.EXTRA.indexOf("on update")!==-1&&(B.onUpdate=F.EXTRA.substring(F.EXTRA.indexOf("on update")+10)),F.GENERATION_EXPRESSION&&(B.asExpression=F.GENERATION_EXPRESSION,B.generatedType=F.EXTRA.indexOf("VIRTUAL")!==-1?"VIRTUAL":"STORED"),B.isUnique=se.length>0&&!Y&&!Q,B.isNullable=F.IS_NULLABLE==="YES",B.isPrimary=f.some(U=>U.TABLE_NAME===F.TABLE_NAME&&U.TABLE_SCHEMA===F.TABLE_SCHEMA&&U.COLUMN_NAME===F.COLUMN_NAME),B.zerofill=F.COLUMN_TYPE.indexOf("zerofill")!==-1,B.isGenerated=F.EXTRA.indexOf("auto_increment")!==-1,B.isGenerated&&(B.generationStrategy="increment"),B.comment=typeof F.COLUMN_COMMENT=="string"&&F.COLUMN_COMMENT.length===0?void 0:F.COLUMN_COMMENT,F.CHARACTER_SET_NAME&&(B.charset=F.CHARACTER_SET_NAME===G?void 0:F.CHARACTER_SET_NAME),F.COLLATION_NAME&&(B.collation=F.COLLATION_NAME===W?void 0:F.COLLATION_NAME),this.driver.withLengthColumnTypes.indexOf(B.type)!==-1&&F.CHARACTER_MAXIMUM_LENGTH){const U=F.CHARACTER_MAXIMUM_LENGTH.toString();B.length=this.isDefaultColumnLength(D,B,U)?"":U}if((B.type==="decimal"||B.type==="double"||B.type==="float")&&(F.NUMERIC_PRECISION!==null&&!this.isDefaultColumnPrecision(D,B,F.NUMERIC_PRECISION)&&(B.precision=parseInt(F.NUMERIC_PRECISION)),F.NUMERIC_SCALE!==null&&!this.isDefaultColumnScale(D,B,F.NUMERIC_SCALE)&&(B.scale=parseInt(F.NUMERIC_SCALE))),B.type==="enum"||B.type==="simple-enum"||B.type==="set"){const U=F.COLUMN_TYPE,k=U.substring(U.indexOf("(")+1,U.lastIndexOf(")")).split(",");B.enum=k.map(L=>L.substring(1,L.length-1)),B.length=""}return(B.type==="datetime"||B.type==="time"||B.type==="timestamp")&&F.DATETIME_PRECISION!==null&&F.DATETIME_PRECISION!==void 0&&!this.isDefaultColumnPrecision(D,B,parseInt(F.DATETIME_PRECISION))&&(B.precision=parseInt(F.DATETIME_PRECISION)),B});const ne=K.uniq(A.filter(F=>F.TABLE_NAME===P.TABLE_NAME&&F.TABLE_SCHEMA===P.TABLE_SCHEMA),F=>F.CONSTRAINT_NAME);D.foreignKeys=ne.map(F=>{const se=A.filter(Q=>Q.CONSTRAINT_NAME===F.CONSTRAINT_NAME),v=F.REFERENCED_TABLE_SCHEMA===n?void 0:F.REFERENCED_TABLE_SCHEMA,Y=this.driver.buildTableName(F.REFERENCED_TABLE_NAME,void 0,v);return new Je({name:F.CONSTRAINT_NAME,columnNames:se.map(Q=>Q.COLUMN_NAME),referencedDatabase:F.REFERENCED_TABLE_SCHEMA,referencedTableName:Y,referencedColumnNames:se.map(Q=>Q.REFERENCED_COLUMN_NAME),onDelete:F.ON_DELETE,onUpdate:F.ON_UPDATE})});const pe=K.uniq(b.filter(F=>F.TABLE_NAME===P.TABLE_NAME&&F.TABLE_SCHEMA===P.TABLE_SCHEMA),F=>F.INDEX_NAME);return D.indices=pe.map(F=>{const se=b.filter(Y=>Y.TABLE_SCHEMA===F.TABLE_SCHEMA&&Y.TABLE_NAME===F.TABLE_NAME&&Y.INDEX_NAME===F.INDEX_NAME),v=parseInt(F.NON_UNIQUE,10);return new Be({table:D,name:F.INDEX_NAME,columnNames:se.map(Y=>Y.COLUMN_NAME),isUnique:v===0,isSpatial:F.INDEX_TYPE==="SPATIAL",isFulltext:F.INDEX_TYPE==="FULLTEXT"})}),D})}createTableSql(e,t){const n=e.columns.map(i=>this.buildCreateColumnSql(i,!0)).join(", ");let r=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(i=>i.isUnique).forEach(i=>{const s=e.indices.some(o=>o.columnNames.length===1&&!!o.isUnique&&o.columnNames.indexOf(i.name)!==-1),a=e.uniques.some(o=>o.columnNames.length===1&&o.columnNames.indexOf(i.name)!==-1);!s&&!a&&e.indices.push(new Be({name:this.connection.namingStrategy.uniqueConstraintName(e,[i.name]),columnNames:[i.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(i=>{e.indices.some(a=>a.name===i.name)||e.indices.push(new Be({name:i.name,columnNames:i.columnNames,isUnique:!0}))}),e.indices.length>0){const i=e.indices.map(s=>{const a=s.columnNames.map(c=>`\`${c}\``).join(", ");s.name||(s.name=this.connection.namingStrategy.indexName(e,s.columnNames,s.where));let o="";return s.isUnique&&(o+="UNIQUE "),s.isSpatial&&(o+="SPATIAL "),s.isFulltext&&(o+="FULLTEXT "),`${o}INDEX \`${s.name}\` (${a})`}).join(", ");r+=`, ${i}`}if(e.foreignKeys.length>0&&t){const i=e.foreignKeys.map(s=>{const a=s.columnNames.map(u=>`\`${u}\``).join(", ");s.name||(s.name=this.connection.namingStrategy.foreignKeyName(e,s.columnNames));const o=s.referencedColumnNames.map(u=>`\`${u}\``).join(", ");let c=`CONSTRAINT \`${s.name}\` FOREIGN KEY (${a}) REFERENCES ${this.escapePath(this.getTablePath(s))} (${o})`;return s.onDelete&&(c+=` ON DELETE ${s.onDelete}`),s.onUpdate&&(c+=` ON UPDATE ${s.onUpdate}`),c}).join(", ");r+=`, ${i}`}if(e.primaryColumns.length>0){const i=e.primaryColumns.map(s=>`\`${s.name}\``).join(", ");r+=`, PRIMARY KEY (${i})`}return r+=`) ENGINE=${e.engine||"InnoDB"}`,new R(r)}dropTableSql(e){return new R(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){return typeof e.expression=="string"?new R(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression}`):new R(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){const t=await this.getCurrentDatabase(),n=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:de.VIEW,schema:t,name:e.name,value:n})}dropViewSql(e){return new R(`DROP VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const t=await this.getCurrentDatabase(),n=q.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:de.VIEW,schema:t,name:n})}createIndexSql(e,t){const n=t.columnNames.map(i=>`\`${i}\``).join(", ");let r="";return t.isUnique&&(r+="UNIQUE "),t.isSpatial&&(r+="SPATIAL "),t.isFulltext&&(r+="FULLTEXT "),new R(`CREATE ${r}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${n})`)}dropIndexSql(e,t){const n=q.isTableIndex(t)?t.name:t;return new R(`DROP INDEX \`${n}\` ON ${this.escapePath(e)}`)}createPrimaryKeySql(e,t){const n=t.map(r=>`\`${r}\``).join(", ");return new R(`ALTER TABLE ${this.escapePath(e)} ADD PRIMARY KEY (${n})`)}dropPrimaryKeySql(e){return new R(`ALTER TABLE ${this.escapePath(e)} DROP PRIMARY KEY`)}createForeignKeySql(e,t){const n=t.columnNames.map(s=>`\`${s}\``).join(", "),r=t.referencedColumnNames.map(s=>`\`${s}\``).join(",");let i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${r})`;return t.onDelete&&(i+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(i+=` ON UPDATE ${t.onUpdate}`),new R(i)}dropForeignKeySql(e,t){const n=q.isTableForeignKey(t)?t.name:t;return new R(`ALTER TABLE ${this.escapePath(e)} DROP FOREIGN KEY \`${n}\``)}escapeComment(e){return!e||e.length===0?"''":(e=e.replace(/\\/g,"\\\\").replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){const{database:t,tableName:n}=this.driver.parseTableName(e);return t&&t!==this.driver.database?`\`${t}\`.\`${n}\``:`\`${n}\``}buildCreateColumnSql(e,t,n=!1){let r="";return n?r=this.connection.driver.createFullType(e):r=`\`${e.name}\` ${this.connection.driver.createFullType(e)}`,e.asExpression&&(r+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`),e.zerofill?r+=" ZEROFILL":e.unsigned&&(r+=" UNSIGNED"),e.enum&&(r+=` (${e.enum.map(i=>"'"+i+"'").join(", ")})`),e.charset&&(r+=` CHARACTER SET "${e.charset}"`),e.collation&&(r+=` COLLATE "${e.collation}"`),e.isNullable||(r+=" NOT NULL"),e.isNullable&&(r+=" NULL"),e.isPrimary&&!t&&(r+=" PRIMARY KEY"),e.isGenerated&&e.generationStrategy==="increment"&&(r+=" AUTO_INCREMENT"),e.comment&&(r+=` COMMENT ${this.escapeComment(e.comment)}`),e.default!==void 0&&e.default!==null&&(r+=` DEFAULT ${e.default}`),e.onUpdate&&(r+=` ON UPDATE ${e.onUpdate}`),r}isDefaultColumnWidth(e,t,n){if(this.connection.hasMetadata(e.name)){const s=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(s&&s.width)return!1}const r=this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].width;if(r){const s=["int","tinyint","smallint","mediumint"].indexOf(t.type)!==-1;return t.unsigned&&s?r-1===n:r===n}return!1}changeTableComment(e,t){throw new M("aurora-mysql driver does not support change table comment.")}}class Mc{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["bit","int","integer","tinyint","smallint","mediumint","bigint","float","double","double precision","real","decimal","dec","numeric","fixed","bool","boolean","date","datetime","timestamp","time","year","char","nchar","national char","varchar","nvarchar","national varchar","blob","text","tinyblob","tinytext","mediumblob","mediumtext","longblob","longtext","enum","set","binary","varbinary","json","geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.supportedUpsertTypes=["on-duplicate-key-update"],this.spatialTypes=["geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.withLengthColumnTypes=["char","varchar","nvarchar","binary","varbinary"],this.unsignedColumnTypes=["tinyint","smallint","mediumint","int","integer","bigint"],this.withPrecisionColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real","time","datetime","timestamp"],this.withScaleColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real"],this.mappedDataTypes={createDate:"datetime",createDatePrecision:6,createDateDefault:"CURRENT_TIMESTAMP(6)",updateDate:"datetime",updateDatePrecision:6,updateDateDefault:"CURRENT_TIMESTAMP(6)",deleteDate:"datetime",deleteDatePrecision:6,deleteDateNullable:!0,version:"int",treeLevel:"int",migrationId:"int",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.dataTypeDefaults={varchar:{length:255},nvarchar:{length:255},"national varchar":{length:255},char:{length:1},binary:{length:1},varbinary:{length:255},decimal:{precision:10,scale:0},dec:{precision:10,scale:0},numeric:{precision:10,scale:0},fixed:{precision:10,scale:0},float:{precision:12},double:{precision:22},time:{precision:0},datetime:{precision:0},timestamp:{precision:0},bit:{width:1},int:{width:11},integer:{width:11},tinyint:{width:4},smallint:{width:6},mediumint:{width:9},bigint:{width:20}},this.maxAliasLength=63,this.cteCapabilities={enabled:!1},this.connection=e,this.options=e.options,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),this.database=J.buildDriverOptions(this.options).database}async connect(){if(!this.database){const e=this.createQueryRunner("master");this.database=await e.getCurrentDatabase(),await e.release()}}afterConnect(){return Promise.resolve()}async disconnect(){}createSchemaBuilder(){return new Zt(this.connection)}createQueryRunner(e){return new xc(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions))}escapeQueryWithParameters(e,t,n){const r=Object.keys(n).map(i=>n[i]);return!t||!Object.keys(t).length?[e,r]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,s,a)=>{if(!t.hasOwnProperty(a))return i;const o=t[a];return s?o.map(c=>(r.push(c),this.createParameter(a,r.length-1))).join(", "):typeof o=="function"?o():(r.push(o),this.createParameter(a,r.length-1))}),[e,r])}escape(e){return"`"+e+"`"}buildTableName(e,t,n){const r=[e];return n&&r.unshift(n),r.join(".")}parseTableName(e){const t=this.database,n=void 0;if(q.isTable(e)||q.isView(e)){const i=this.parseTableName(e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if(q.isTableForeignKey(e)){const i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if(q.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const r=e.split(".");return{database:(r.length>1?r[0]:void 0)||t,schema:n,tableName:r.length>1?r[1]:r[0]}}preparePersistentValue(e,t){return t.transformer&&(e=ke.transformTo(t.transformer,e)),!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.preparePersistentValue(e,t):e==null?e:t.type===Boolean?e===!0?1:0:t.type==="date"?he.mixedDateToDateString(e):t.type==="time"?he.mixedDateToTimeString(e):t.type==="json"?JSON.stringify(e):t.type==="timestamp"||t.type==="datetime"||t.type===Date?he.mixedDateToDate(e):t.type==="simple-array"||t.type==="set"?he.simpleArrayToString(e):t.type==="simple-json"?he.simpleJsonToString(e):t.type==="enum"||t.type==="simple-enum"?""+e:e}prepareHydratedValue(e,t){return e==null?t.transformer?ke.transformFrom(t.transformer,e):e:!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.prepareHydratedValue(e,t):(t.type===Boolean||t.type==="bool"||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?e=he.normalizeHydratedDate(e):t.type==="date"?e=he.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type==="time"?e=he.mixedTimeToString(e):t.type==="simple-array"||t.type==="set"?e=he.stringToSimpleArray(e):t.type==="simple-json"?e=he.stringToSimpleJson(e):(t.type==="enum"||t.type==="simple-enum")&&t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0?e=parseInt(e):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=ke.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number||e.type==="integer"?"int":e.type===String?"varchar":e.type===Date?"datetime":e.type===Buffer?"blob":e.type===Boolean?"tinyint":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"enum":e.type==="double precision"||e.type==="real"?"double":e.type==="dec"||e.type==="numeric"||e.type==="fixed"?"decimal":e.type==="bool"||e.type==="boolean"?"tinyint":e.type==="nvarchar"||e.type==="national varchar"?"varchar":e.type==="nchar"||e.type==="national char"?"char":e.type||""}normalizeDefault(e){const t=e.default;if(t!==null){if((e.type==="enum"||e.type==="simple-enum")&&t!==void 0)return`'${t}'`;if(e.type==="set"&&t!==void 0)return`'${he.simpleArrayToString(t)}'`;if(typeof t=="number")return`${t}`;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!==void 0)return`${t}`}}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"varchar":case"nvarchar":case"national varchar":return"255";case"varbinary":return"255";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t+=" array"),t}obtainMasterConnection(){return new Promise((e,t)=>{this.poolCluster?this.poolCluster.getConnection("MASTER",(n,r)=>{n?t(n):e(this.prepareDbConnection(r))}):this.pool?this.pool.getConnection((n,r)=>{n?t(n):e(this.prepareDbConnection(r))}):t(new M("Connection is not established with mysql database"))})}obtainSlaveConnection(){return this.poolCluster?new Promise((e,t)=>{this.poolCluster.getConnection("SLAVE*",(n,r)=>{n?t(n):e(this.prepareDbConnection(r))})}):this.obtainMasterConnection()}createGeneratedMap(e,t,n){const r=e.generatedColumns.reduce((i,s)=>{let a;return s.generationStrategy==="increment"&&t.insertId&&(a=t.insertId+n),K.mergeDeep(i,s.createValueMap(a))},{});return Object.keys(r).length>0?r:void 0}findChangedColumns(e,t){return t.filter(n=>{const r=e.find(s=>s.name===n.databaseName);if(!r)return!1;let i=n.length;return!i&&n.generationStrategy==="uuid"&&(i=this.getColumnLength(n)),r.name!==n.databaseName||r.type!==this.normalizeType(n)||r.length!==i||r.width!==n.width||r.precision!==n.precision||r.scale!==n.scale||r.zerofill!==n.zerofill||r.unsigned!==n.unsigned||r.asExpression!==n.asExpression||r.generatedType!==n.generatedType||r.comment!==this.escapeComment(n.comment)||!this.compareDefaultValues(this.normalizeDefault(n),r.default)||r.enum&&n.enum&&!K.isArraysEqual(r.enum,n.enum.map(s=>s+""))||r.onUpdate!==n.onUpdate||r.isPrimary!==n.isPrimary||r.isNullable!==n.isNullable||r.isUnique!==this.normalizeIsUnique(n)||n.generationStrategy!=="uuid"&&r.isGenerated!==n.isGenerated})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!0}createParameter(e,t){return"?"}loadDependencies(){const e=this.options.driver||ve.load("typeorm-aurora-data-api-driver");this.DataApiDriver=e,this.DataApiDriver=this.DataApiDriver.default||this.DataApiDriver}createConnectionOptions(e,t){return t=Object.assign({},t,J.buildDriverOptions(t)),Object.assign({},{resourceArn:e.resourceArn,secretArn:e.secretArn,database:e.database,region:e.region,type:e.type},{host:t.host,user:t.username,password:t.password,database:t.database,port:t.port,ssl:e.ssl},e.extra||{})}async createPool(e){return{}}prepareDbConnection(e){const{logger:t}=this.connection;return e.listeners("error").length===0&&e.on("error",n=>t.log("warn",`MySQL connection raised an error. ${n}`)),e}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}}class vc extends en{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new ct(this)}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;const n=r=>this.releasePostgresConnection(r);return this.releaseCallback=r=>{this.databaseConnection.removeListener("error",n),t(r)},this.databaseConnection.on("error",n),this.databaseConnection}):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;const n=r=>this.releasePostgresConnection(r);return this.releaseCallback=r=>{this.databaseConnection.removeListener("error",n),t(r)},this.databaseConnection.on("error",n),this.databaseConnection}),this.databaseConnectionPromise)}async releasePostgresConnection(e){if(this.isReleased)return;this.isReleased=!0,this.releaseCallback&&(this.releaseCallback(e),this.releaseCallback=void 0);const t=this.driver.connectedQueryRunners.indexOf(this);t!==-1&&this.driver.connectedQueryRunners.splice(t,1)}release(){return this.releasePostgresConnection()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(await this.query("START TRANSACTION"),e&&await this.query("SET TRANSACTION ISOLATION LEVEL "+e)):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new He;const r=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const i=new Xe;try{const s=Date.now(),a=await r.query(e,t),o=this.driver.options.maxQueryExecutionTime,u=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,u,a,void 0),o&&u>o&&this.driver.connection.logger.logQuerySlow(u,e,t,this);const l=new at;if(a){switch(a.hasOwnProperty("rows")&&(l.records=a.rows),a.hasOwnProperty("rowCount")&&(l.affected=a.rowCount),a.command){case"DELETE":case"UPDATE":l.raw=[a.rows,a.rowCount];break;default:l.raw=a.rows}if(!n)return l.raw}return l}catch(s){throw this.driver.connection.logger.logQueryError(s,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,s),new rt(e,t,s)}finally{await i.wait()}}async stream(e,t,n,r){const i=this.driver.loadStreamDependency();if(this.isReleased)throw new He;const s=await this.connect();this.driver.connection.logger.logQuery(e,t,this);const a=s.query(new i(e,t));return n&&a.on("end",n),r&&a.on("error",r),a}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return!!(await this.query(`SELECT * FROM pg_database WHERE datname='${e}';`)).length}async getCurrentDatabase(){return(await this.query("SELECT * FROM current_database()"))[0].current_database}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){return(await this.query("SELECT * FROM current_schema()"))[0].current_schema}async hasTable(e){const t=this.driver.parseTableName(e);t.schema||(t.schema=await this.getCurrentSchema());const n=`SELECT * FROM "information_schema"."tables" WHERE "table_schema" = '${t.schema}' AND "table_name" = '${t.tableName}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=this.driver.parseTableName(e);n.schema||(n.schema=await this.getCurrentSchema());const r=`SELECT * FROM "information_schema"."columns" WHERE "table_schema" = '${n.schema}' AND "table_name" = '${n.tableName}' AND "column_name" = '${t}'`;return!!(await this.query(r)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();const n=`CREATE DATABASE "${e}"`,r=`DROP DATABASE "${e}"`;await this.executeQueries(new R(n),new R(r))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,r=`CREATE DATABASE "${e}"`;await this.executeQueries(new R(n),new R(r))}async createSchema(e,t){const n=e.indexOf(".")===-1?e:e.split(".")[1],r=t?`CREATE SCHEMA IF NOT EXISTS "${n}"`:`CREATE SCHEMA "${n}"`,i=`DROP SCHEMA "${n}" CASCADE`;await this.executeQueries(new R(r),new R(i))}async dropSchema(e,t,n){const r=e.indexOf(".")===-1?e:e.split(".")[1],i=t?`DROP SCHEMA IF EXISTS "${r}" ${n?"CASCADE":""}`:`DROP SCHEMA "${r}" ${n?"CASCADE":""}`,s=`CREATE SCHEMA "${r}"`;await this.executeQueries(new R(i),new R(s))}async createTable(e,t=!1,n=!0,r=!0){if(t&&await this.hasTable(e))return Promise.resolve();const i=[],s=[],a=e.columns.filter(u=>u.type==="enum"||u.type==="simple-enum"),o=[];for(const u of a){const l=await this.hasEnumType(e,u),h=this.buildEnumName(e,u);!l&&o.indexOf(h)===-1&&(o.push(h),i.push(this.createEnumTypeSql(e,u,h)),s.push(this.dropEnumTypeSql(e,u,h)))}const c=e.columns.filter(u=>u.generatedType==="STORED"&&u.asExpression);for(const u of c){const l=(await this.getTableNameWithSchema(e.name)).split("."),h=l[1],f=l[0],E=this.insertTypeormMetadataSql({database:this.driver.database,schema:f,table:h,type:de.GENERATED_COLUMN,name:u.name,value:u.asExpression}),b=this.deleteTypeormMetadataSql({database:this.driver.database,schema:f,table:h,type:de.GENERATED_COLUMN,name:u.name});i.push(E),s.push(b)}i.push(this.createTableSql(e,n)),s.push(this.dropTableSql(e)),n&&e.foreignKeys.forEach(u=>s.push(this.dropForeignKeySql(e,u))),r&&e.indices.forEach(u=>{u.name||(u.name=this.connection.namingStrategy.indexName(e,u.columnNames,u.where)),i.push(this.createIndexSql(e,u)),s.push(this.dropIndexSql(e,u))}),e.comment&&(i.push(new R("COMMENT ON TABLE "+this.escapePath(e)+" IS '"+e.comment+"'")),s.push(new R("COMMENT ON TABLE "+this.escapePath(e)+" IS NULL"))),await this.executeQueries(i,s)}async dropTable(e,t,n=!0,r=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const i=n,s=this.getTablePath(e),a=await this.getCachedTable(s),o=[],c=[];r&&a.indices.forEach(l=>{o.push(this.dropIndexSql(a,l)),c.push(this.createIndexSql(a,l))}),n&&a.foreignKeys.forEach(l=>o.push(this.dropForeignKeySql(a,l))),o.push(this.dropTableSql(a)),c.push(this.createTableSql(a,i));const u=a.columns.filter(l=>l.generatedType&&l.asExpression);for(const l of u){const h=(await this.getTableNameWithSchema(a.name)).split("."),f=h[1],E=h[0],b=this.deleteTypeormMetadataSql({database:this.driver.database,schema:E,table:f,type:de.GENERATED_COLUMN,name:l.name}),A=this.insertTypeormMetadataSql({database:this.driver.database,schema:E,table:f,type:de.GENERATED_COLUMN,name:l.name,value:l.asExpression});o.push(b),c.push(A)}await this.executeQueries(o,c)}async createView(e,t=!1){const n=[],r=[];n.push(this.createViewSql(e)),t&&n.push(await this.insertViewDefinitionSql(e)),r.push(this.dropViewSql(e)),t&&r.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(n,r)}async dropView(e){const t=q.isView(e)?e.name:e,n=await this.getCachedView(t),r=[],i=[];r.push(await this.deleteViewDefinitionSql(n)),r.push(this.dropViewSql(n)),i.push(await this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(r,i)}async renameTable(e,t){const n=[],r=[],i=q.isTable(e)?e:await this.getCachedTable(e),s=i.clone(),{schema:a,tableName:o}=this.driver.parseTableName(i);if(s.name=a?`${a}.${t}`:t,n.push(new R(`ALTER TABLE ${this.escapePath(i)} RENAME TO "${t}"`)),r.push(new R(`ALTER TABLE ${this.escapePath(s)} RENAME TO "${o}"`)),s.primaryColumns.length>0&&!s.primaryColumns[0].primaryKeyConstraintName){const u=s.primaryColumns.map(f=>f.name),l=this.connection.namingStrategy.primaryKeyName(i,u),h=this.connection.namingStrategy.primaryKeyName(s,u);n.push(new R(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${l}" TO "${h}"`)),r.push(new R(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${h}" TO "${l}"`))}s.columns.map(u=>{if(u.isGenerated&&u.generationStrategy==="increment"){const l=this.buildSequencePath(i,u.name),h=this.buildSequenceName(i,u.name),f=this.buildSequencePath(s,u.name),E=this.buildSequenceName(s,u.name),b=`ALTER SEQUENCE ${this.escapePath(l)} RENAME TO "${E}"`,A=`ALTER SEQUENCE ${this.escapePath(f)} RENAME TO "${h}"`;n.push(new R(b)),r.push(new R(A))}}),s.uniques.forEach(u=>{const l=this.connection.namingStrategy.uniqueConstraintName(i,u.columnNames);if(u.name!==l)return;const h=this.connection.namingStrategy.uniqueConstraintName(s,u.columnNames);n.push(new R(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${u.name}" TO "${h}"`)),r.push(new R(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${h}" TO "${u.name}"`)),u.name=h}),s.indices.forEach(u=>{const l=this.connection.namingStrategy.indexName(i,u.columnNames,u.where);if(u.name!==l)return;const{schema:h}=this.driver.parseTableName(s),f=this.connection.namingStrategy.indexName(s,u.columnNames,u.where),E=h?`ALTER INDEX "${h}"."${u.name}" RENAME TO "${f}"`:`ALTER INDEX "${u.name}" RENAME TO "${f}"`,b=h?`ALTER INDEX "${h}"."${f}" RENAME TO "${u.name}"`:`ALTER INDEX "${f}" RENAME TO "${u.name}"`;n.push(new R(E)),r.push(new R(b)),u.name=f}),s.foreignKeys.forEach(u=>{const l=this.connection.namingStrategy.foreignKeyName(i,u.columnNames,this.getTablePath(u),u.referencedColumnNames);if(u.name!==l)return;const h=this.connection.namingStrategy.foreignKeyName(s,u.columnNames,this.getTablePath(u),u.referencedColumnNames);n.push(new R(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${u.name}" TO "${h}"`)),r.push(new R(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${h}" TO "${u.name}"`)),u.name=h});const c=s.columns.filter(u=>u.type==="enum"||u.type==="simple-enum");for(const u of c){if(u.enumName)continue;const l=await this.getUserDefinedTypeName(i,u);n.push(new R(`ALTER TYPE "${l.schema}"."${l.name}" RENAME TO ${this.buildEnumName(s,u,!1)}`)),r.push(new R(`ALTER TYPE ${this.buildEnumName(s,u)} RENAME TO "${l.name}"`))}await this.executeQueries(n,r)}async addColumn(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=[],s=[];if((t.type==="enum"||t.type==="simple-enum")&&(await this.hasEnumType(n,t)||(i.push(this.createEnumTypeSql(n,t)),s.push(this.dropEnumTypeSql(n,t)))),i.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,t)}`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${t.name}"`)),t.isPrimary){const o=r.primaryColumns;if(o.length>0){const l=o[0].primaryKeyConstraintName?o[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,o.map(f=>f.name)),h=o.map(f=>`"${f.name}"`).join(", ");i.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${l}"`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${l}" PRIMARY KEY (${h})`))}o.push(t);const c=o[0].primaryKeyConstraintName?o[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,o.map(l=>l.name)),u=o.map(l=>`"${l.name}"`).join(", ");i.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${c}" PRIMARY KEY (${u})`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${c}"`))}const a=r.indices.find(o=>o.columnNames.length===1&&o.columnNames[0]===t.name);if(a&&(i.push(this.createIndexSql(n,a)),s.push(this.dropIndexSql(n,a))),t.isUnique){const o=new We({name:this.connection.namingStrategy.uniqueConstraintName(n,[t.name]),columnNames:[t.name]});r.uniques.push(o),i.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${o.name}" UNIQUE ("${t.name}")`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${o.name}"`))}if(t.generatedType==="STORED"&&t.asExpression){const o=(await this.getTableNameWithSchema(n.name)).split("."),c=o[1],u=o[0],l=this.insertTypeormMetadataSql({database:this.driver.database,schema:u,table:c,type:de.GENERATED_COLUMN,name:t.name,value:t.asExpression}),h=this.deleteTypeormMetadataSql({database:this.driver.database,schema:u,table:c,type:de.GENERATED_COLUMN,name:t.name});i.push(l),s.push(h)}t.comment&&(i.push(new R(`COMMENT ON COLUMN ${this.escapePath(n)}."${t.name}" IS ${this.escapeComment(t.comment)}`)),s.push(new R(`COMMENT ON COLUMN ${this.escapePath(n)}."${t.name}" IS ${this.escapeComment(t.comment)}`))),await this.executeQueries(i,s),r.addColumn(t),this.replaceCachedTable(n,r)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const r=q.isTable(e)?e:await this.getCachedTable(e),i=q.isTableColumn(t)?t:r.columns.find(a=>a.name===t);if(!i)throw new M(`Column "${t}" was not found in the "${r.name}" table.`);let s;return q.isTableColumn(n)?s=n:(s=i.clone(),s.name=n),this.changeColumn(r,i,s)}async changeColumn(e,t,n){const r=q.isTable(e)?e:await this.getCachedTable(e);let i=r.clone();const s=[],a=[];let o=!1;const c=q.isTableColumn(t)?t:r.columns.find(u=>u.name===t);if(!c)throw new M(`Column "${t}" was not found in the "${r.name}" table.`);if(c.type!==n.type||c.length!==n.length||n.isArray!==c.isArray||!c.generatedType&&n.generatedType==="STORED"||c.asExpression!==n.asExpression&&n.generatedType==="STORED")await this.dropColumn(r,c),await this.addColumn(r,n),i=r.clone();else{if(c.name!==n.name){if(s.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME COLUMN "${c.name}" TO "${n.name}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME COLUMN "${n.name}" TO "${c.name}"`)),c.type==="enum"||c.type==="simple-enum"){const l=await this.getUserDefinedTypeName(r,c);s.push(new R(`ALTER TYPE "${l.schema}"."${l.name}" RENAME TO ${this.buildEnumName(r,n,!1)}`)),a.push(new R(`ALTER TYPE ${this.buildEnumName(r,n)} RENAME TO "${l.name}"`))}if(c.isPrimary===!0&&!c.primaryKeyConstraintName){const h=i.primaryColumns.map(b=>b.name),f=this.connection.namingStrategy.primaryKeyName(i,h);h.splice(h.indexOf(c.name),1),h.push(n.name);const E=this.connection.namingStrategy.primaryKeyName(i,h);s.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${f}" TO "${E}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${E}" TO "${f}"`))}if(c.isGenerated===!0&&n.generationStrategy==="increment"){const l=this.buildSequencePath(r,c.name),h=this.buildSequenceName(r,c.name),f=this.buildSequencePath(r,n.name),E=this.buildSequenceName(r,n.name),b=`ALTER SEQUENCE ${this.escapePath(l)} RENAME TO "${E}"`,A=`ALTER SEQUENCE ${this.escapePath(f)} RENAME TO "${h}"`;s.push(new R(b)),a.push(new R(A))}i.findColumnUniques(c).forEach(l=>{const h=this.connection.namingStrategy.uniqueConstraintName(i,l.columnNames);if(l.name!==h)return;l.columnNames.splice(l.columnNames.indexOf(c.name),1),l.columnNames.push(n.name);const f=this.connection.namingStrategy.uniqueConstraintName(i,l.columnNames);s.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${l.name}" TO "${f}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${f}" TO "${l.name}"`)),l.name=f}),i.findColumnIndices(c).forEach(l=>{const h=this.connection.namingStrategy.indexName(i,l.columnNames,l.where);if(l.name!==h)return;l.columnNames.splice(l.columnNames.indexOf(c.name),1),l.columnNames.push(n.name);const{schema:f}=this.driver.parseTableName(r),E=this.connection.namingStrategy.indexName(i,l.columnNames,l.where),b=f?`ALTER INDEX "${f}"."${l.name}" RENAME TO "${E}"`:`ALTER INDEX "${l.name}" RENAME TO "${E}"`,A=f?`ALTER INDEX "${f}"."${E}" RENAME TO "${l.name}"`:`ALTER INDEX "${E}" RENAME TO "${l.name}"`;s.push(new R(b)),a.push(new R(A)),l.name=E}),i.findColumnForeignKeys(c).forEach(l=>{const h=this.connection.namingStrategy.foreignKeyName(i,l.columnNames,this.getTablePath(l),l.referencedColumnNames);if(l.name!==h)return;l.columnNames.splice(l.columnNames.indexOf(c.name),1),l.columnNames.push(n.name);const f=this.connection.namingStrategy.foreignKeyName(i,l.columnNames,this.getTablePath(l),l.referencedColumnNames);s.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${l.name}" TO "${f}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${f}" TO "${l.name}"`)),l.name=f});const u=i.columns.find(l=>l.name===c.name);i.columns[i.columns.indexOf(u)].name=n.name,c.name=n.name}if((n.precision!==c.precision||n.scale!==c.scale)&&(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(c)}`))),(n.type==="enum"||n.type==="simple-enum")&&(c.type==="enum"||c.type==="simple-enum")&&(!K.isArraysEqual(n.enum,c.enum)||n.enumName!==c.enumName)){const u=n.isArray?"[]":"",l=this.buildEnumName(r,n),h=this.buildEnumName(r,c),f=this.buildEnumName(r,c,!1),E=this.buildEnumName(r,c,!0,!1,!0),b=this.buildEnumName(r,c,!1,!1,!0);s.push(new R(`ALTER TYPE ${h} RENAME TO ${b}`)),a.push(new R(`ALTER TYPE ${E} RENAME TO ${f}`)),s.push(this.createEnumTypeSql(r,n,l)),a.push(this.dropEnumTypeSql(r,n,l)),c.default!==null&&c.default!==void 0&&(o=!0,s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${c.name}" DROP DEFAULT`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${c.name}" SET DEFAULT ${c.default}`)));const A=`${l}${u} USING "${n.name}"::"text"::${l}${u}`,P=`${E}${u} USING "${n.name}"::"text"::${E}${u}`;s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${A}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${P}`)),n.default!==null&&n.default!==void 0&&(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${n.default}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`))),s.push(this.dropEnumTypeSql(r,c,E)),a.push(this.createEnumTypeSql(r,c,E))}if(c.isNullable!==n.isNullable&&(n.isNullable?(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${c.name}" DROP NOT NULL`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${c.name}" SET NOT NULL`))):(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${c.name}" SET NOT NULL`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${c.name}" DROP NOT NULL`)))),c.comment!==n.comment&&(s.push(new R(`COMMENT ON COLUMN ${this.escapePath(r)}."${c.name}" IS ${this.escapeComment(n.comment)}`)),a.push(new R(`COMMENT ON COLUMN ${this.escapePath(r)}."${n.name}" IS ${this.escapeComment(c.comment)}`))),n.isPrimary!==c.isPrimary){const u=i.primaryColumns;if(u.length>0){const l=u[0].primaryKeyConstraintName?u[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,u.map(f=>f.name)),h=u.map(f=>`"${f.name}"`).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${l}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${l}" PRIMARY KEY (${h})`))}if(n.isPrimary===!0){u.push(n);const l=i.columns.find(E=>E.name===n.name);l.isPrimary=!0;const h=u[0].primaryKeyConstraintName?u[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,u.map(E=>E.name)),f=u.map(E=>`"${E.name}"`).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${h}" PRIMARY KEY (${f})`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${h}"`))}else{const l=u.find(f=>f.name===n.name);u.splice(u.indexOf(l),1);const h=i.columns.find(f=>f.name===n.name);if(h.isPrimary=!1,u.length>0){const f=u[0].primaryKeyConstraintName?u[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,u.map(b=>b.name)),E=u.map(b=>`"${b.name}"`).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${f}" PRIMARY KEY (${E})`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${f}"`))}}}if(n.isUnique!==c.isUnique)if(n.isUnique===!0){const u=new We({name:this.connection.namingStrategy.uniqueConstraintName(r,[n.name]),columnNames:[n.name]});i.uniques.push(u),s.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${u.name}" UNIQUE ("${n.name}")`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${u.name}"`))}else{const u=i.uniques.find(l=>l.columnNames.length===1&&!!l.columnNames.find(h=>h===n.name));i.uniques.splice(i.uniques.indexOf(u),1),s.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${u.name}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${u.name}" UNIQUE ("${n.name}")`))}if(c.isGenerated!==n.isGenerated&&(c.isGenerated&&(c.generationStrategy==="uuid"?(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${c.name}" DROP DEFAULT`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${c.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):c.generationStrategy==="increment"&&(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(r,n))}')`)),s.push(new R(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(r,n))}`)),a.push(new R(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(r,n))} OWNED BY ${this.escapePath(r)}."${n.name}"`)))),n.generationStrategy==="uuid"?n.isGenerated===!0?(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${this.driver.uuidGenerator}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):n.generationStrategy==="increment"&&(n.isGenerated===!0?(s.push(new R(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(r,n))} OWNED BY ${this.escapePath(r)}."${n.name}"`)),a.push(new R(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(r,n))}`)),s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(r,n))}')`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(r,n))}')`)),s.push(new R(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(r,n))}`)),a.push(new R(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(r,n))} OWNED BY ${this.escapePath(r)}."${n.name}"`))))),n.default!==c.default&&!o&&(n.default!==null&&n.default!==void 0?(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${n.default}`)),c.default!==null&&c.default!==void 0?a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${c.default}`)):a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):c.default!==null&&c.default!==void 0&&(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${c.default}`)))),((n.spatialFeatureType||"").toLowerCase()!==(c.spatialFeatureType||"").toLowerCase()||n.srid!==c.srid)&&(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(c)}`))),n.collation!==c.collation){s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${n.type} COLLATE "${n.collation}"`));const u=c.collation?`"${c.collation}"`:'pg_catalog."default"';a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${n.type} COLLATE ${u}`))}if(n.generatedType!==c.generatedType&&(!n.generatedType||n.generatedType==="VIRTUAL")){const u=(await this.getTableNameWithSchema(r.name)).split("."),l=u[1],h=u[0];s.push(new R(`ALTER TABLE ${this.escapePath(r)} RENAME COLUMN "${c.name}" TO "TEMP_OLD_${c.name}"`)),s.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(r,n)}`)),s.push(new R(`UPDATE ${this.escapePath(r)} SET "${n.name}" = "TEMP_OLD_${c.name}"`)),s.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN "TEMP_OLD_${c.name}"`)),s.push(this.deleteTypeormMetadataSql({database:this.driver.database,schema:h,table:l,type:de.GENERATED_COLUMN,name:c.name})),a.push(this.insertTypeormMetadataSql({database:this.driver.database,schema:h,table:l,type:de.GENERATED_COLUMN,name:c.name,value:c.asExpression})),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(r,c)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN "${n.name}"`))}}await this.executeQueries(s,a),this.replaceCachedTable(r,i)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:r}of t)await this.changeColumn(e,n,r)}async dropColumn(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableColumn(t)?t:n.findColumnByName(t);if(!r)throw new M(`Column "${t}" was not found in table "${n.name}"`);const i=n.clone(),s=[],a=[];if(r.isPrimary){const l=r.primaryKeyConstraintName?r.primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,i.primaryColumns.map(E=>E.name)),h=i.primaryColumns.map(E=>`"${E.name}"`).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${l}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${l}" PRIMARY KEY (${h})`));const f=i.findColumnByName(r.name);if(f.isPrimary=!1,i.primaryColumns.length>0){const E=i.primaryColumns[0].primaryKeyConstraintName?i.primaryColumns[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,i.primaryColumns.map(A=>A.name)),b=i.primaryColumns.map(A=>`"${A.name}"`).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${E}" PRIMARY KEY (${b})`)),a.push(new R(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${E}"`))}}const o=i.indices.find(l=>l.columnNames.length===1&&l.columnNames[0]===r.name);o&&(i.indices.splice(i.indices.indexOf(o),1),s.push(this.dropIndexSql(n,o)),a.push(this.createIndexSql(n,o)));const c=i.checks.find(l=>!!l.columnNames&&l.columnNames.length===1&&l.columnNames[0]===r.name);c&&(i.checks.splice(i.checks.indexOf(c),1),s.push(this.dropCheckConstraintSql(n,c)),a.push(this.createCheckConstraintSql(n,c)));const u=i.uniques.find(l=>l.columnNames.length===1&&l.columnNames[0]===r.name);if(u&&(i.uniques.splice(i.uniques.indexOf(u),1),s.push(this.dropUniqueConstraintSql(n,u)),a.push(this.createUniqueConstraintSql(n,u))),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${r.name}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,r)}`)),(r.type==="enum"||r.type==="simple-enum")&&await this.hasEnumType(n,r)){const h=await this.getUserDefinedTypeName(n,r),f=`"${h.schema}"."${h.name}"`;s.push(this.dropEnumTypeSql(n,r,f)),a.push(this.createEnumTypeSql(n,r,f))}if(r.generatedType==="STORED"){const l=(await this.getTableNameWithSchema(n.name)).split("."),h=l[1],f=l[0],E=this.deleteTypeormMetadataSql({database:this.driver.database,schema:f,table:h,type:de.GENERATED_COLUMN,name:r.name}),b=this.insertTypeormMetadataSql({database:this.driver.database,schema:f,table:h,type:de.GENERATED_COLUMN,name:r.name,value:r.asExpression});s.push(E),a.push(b)}await this.executeQueries(s,a),i.removeColumn(r),this.replaceCachedTable(n,i)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t,n){const r=q.isTable(e)?e:await this.getCachedTable(e),i=r.clone(),s=this.createPrimaryKeySql(r,t,n);i.columns.forEach(o=>{t.find(c=>c===o.name)&&(o.isPrimary=!0)});const a=this.dropPrimaryKeySql(i);await this.executeQueries(s,a),this.replaceCachedTable(r,i)}async updatePrimaryKeys(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=t.map(l=>l.name),s=[],a=[],o=r.primaryColumns;if(o.length>0){const l=o[0].primaryKeyConstraintName?o[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,o.map(f=>f.name)),h=o.map(f=>`"${f.name}"`).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${l}"`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${l}" PRIMARY KEY (${h})`))}r.columns.filter(l=>i.indexOf(l.name)!==-1).forEach(l=>l.isPrimary=!0);const c=o[0]?.primaryKeyConstraintName?o[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,i),u=i.map(l=>`"${l}"`).join(", ");s.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${c}" PRIMARY KEY (${u})`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${c}"`)),await this.executeQueries(s,a),this.replaceCachedTable(n,r)}async dropPrimaryKey(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=this.dropPrimaryKeySql(n),i=this.createPrimaryKeySql(n,n.primaryColumns.map(s=>s.name),t);await this.executeQueries(r,i),n.primaryColumns.forEach(s=>{s.isPrimary=!1})}async createUniqueConstraint(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.uniqueConstraintName(n,t.columnNames));const r=this.createUniqueConstraintSql(n,t),i=this.dropUniqueConstraintSql(n,t);await this.executeQueries(r,i),n.addUniqueConstraint(t)}async createUniqueConstraints(e,t){for(const n of t)await this.createUniqueConstraint(e,n)}async dropUniqueConstraint(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableUnique(t)?t:n.uniques.find(a=>a.name===t);if(!r)throw new M(`Supplied unique constraint was not found in table ${n.name}`);const i=this.dropUniqueConstraintSql(n,r),s=this.createUniqueConstraintSql(n,r);await this.executeQueries(i,s),n.removeUniqueConstraint(r)}async dropUniqueConstraints(e,t){for(const n of[...t])await this.dropUniqueConstraint(e,n)}async createCheckConstraint(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(n,t.expression));const r=this.createCheckConstraintSql(n,t),i=this.dropCheckConstraintSql(n,t);await this.executeQueries(r,i),n.addCheckConstraint(t)}async createCheckConstraints(e,t){const n=t.map(r=>this.createCheckConstraint(e,r));await Promise.all(n)}async dropCheckConstraint(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableCheck(t)?t:n.checks.find(a=>a.name===t);if(!r)throw new M(`Supplied check constraint was not found in table ${n.name}`);const i=this.dropCheckConstraintSql(n,r),s=this.createCheckConstraintSql(n,r);await this.executeQueries(i,s),n.removeCheckConstraint(r)}async dropCheckConstraints(e,t){const n=t.map(r=>this.dropCheckConstraint(e,r));await Promise.all(n)}async createExclusionConstraint(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.exclusionConstraintName(n,t.expression));const r=this.createExclusionConstraintSql(n,t),i=this.dropExclusionConstraintSql(n,t);await this.executeQueries(r,i),n.addExclusionConstraint(t)}async createExclusionConstraints(e,t){const n=t.map(r=>this.createExclusionConstraint(e,r));await Promise.all(n)}async dropExclusionConstraint(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableExclusion(t)?t:n.exclusions.find(a=>a.name===t);if(!r)throw new M(`Supplied exclusion constraint was not found in table ${n.name}`);const i=this.dropExclusionConstraintSql(n,r),s=this.createExclusionConstraintSql(n,r);await this.executeQueries(i,s),n.removeExclusionConstraint(r)}async dropExclusionConstraints(e,t){const n=t.map(r=>this.dropExclusionConstraint(e,r));await Promise.all(n)}async createForeignKey(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames,this.getTablePath(t),t.referencedColumnNames));const r=this.createForeignKeySql(n,t),i=this.dropForeignKeySql(n,t);await this.executeQueries(r,i),n.addForeignKey(t)}async createForeignKeys(e,t){for(const n of t)await this.createForeignKey(e,n)}async dropForeignKey(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableForeignKey(t)?t:n.foreignKeys.find(a=>a.name===t);if(!r)throw new M(`Supplied foreign key was not found in table ${n.name}`);r.name||(r.name=this.connection.namingStrategy.foreignKeyName(n,r.columnNames,this.getTablePath(r),r.referencedColumnNames));const i=this.dropForeignKeySql(n,r),s=this.createForeignKeySql(n,r);await this.executeQueries(i,s),n.removeForeignKey(r)}async dropForeignKeys(e,t){for(const n of[...t])await this.dropForeignKey(e,n)}async createIndex(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createIndexSql(n,t),i=this.dropIndexSql(n,t);await this.executeQueries(r,i),n.addIndex(t)}async createViewIndex(e,t){const n=q.isView(e)?e:await this.getCachedView(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createViewIndexSql(n,t),i=this.dropIndexSql(n,t);await this.executeQueries(r,i),n.addIndex(t)}async createIndices(e,t){for(const n of t)await this.createIndex(e,n)}async createViewIndices(e,t){for(const n of t)await this.createViewIndex(e,n)}async dropIndex(e,t){const n=q.isTable(e)?e:await this.getCachedTable(e),r=q.isTableIndex(t)?t:n.indices.find(a=>a.name===t);if(!r)throw new M(`Supplied index ${t} was not found in table ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(n,r),s=this.createIndexSql(n,r);await this.executeQueries(i,s),n.removeIndex(r)}async dropViewIndex(e,t){const n=q.isView(e)?e:await this.getCachedView(e),r=q.isTableIndex(t)?t:n.indices.find(a=>a.name===t);if(!r)throw new M(`Supplied index ${t} was not found in view ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(n,r),s=this.createViewIndexSql(n,r);await this.executeQueries(i,s),n.removeIndex(r)}async dropIndices(e,t){for(const n of[...t])await this.dropIndex(e,n)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(){const e=[];this.connection.entityMetadatas.filter(r=>r.schema).forEach(r=>{e.find(s=>s===r.schema)||e.push(r.schema)}),e.push(this.driver.options.schema||"current_schema()");const t=e.map(r=>r==="current_schema()"?r:"'"+r+"'").join(", "),n=this.isTransactionActive;n||await this.startTransaction();try{const r=`SELECT 'DROP VIEW IF EXISTS "' || schemaname || '"."' || viewname || '" CASCADE;' as "query" FROM "pg_views" WHERE "schemaname" IN (${t}) AND "viewname" NOT IN ('geography_columns', 'geometry_columns', 'raster_columns', 'raster_overviews')`,i=await this.query(r);if(await Promise.all(i.map(o=>this.query(o.query))),J.isReleaseVersionOrGreater(this.driver,"9.3")){const o=`SELECT 'DROP MATERIALIZED VIEW IF EXISTS "' || schemaname || '"."' || matviewname || '" CASCADE;' as "query" FROM "pg_matviews" WHERE "schemaname" IN (${t})`,c=await this.query(o);await Promise.all(c.map(u=>this.query(u.query)))}const s=`SELECT 'DROP TABLE IF EXISTS "' || schemaname || '"."' || tablename || '" CASCADE;' as "query" FROM "pg_tables" WHERE "schemaname" IN (${t}) AND "tablename" NOT IN ('spatial_ref_sys')`,a=await this.query(s);await Promise.all(a.map(o=>this.query(o.query))),await this.dropEnumTypes(t),n||await this.commitTransaction()}catch(r){try{n||await this.rollbackTransaction()}catch{}throw r}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=await this.getCurrentDatabase(),r=await this.getCurrentSchema(),i=e.length===0?"1=1":e.map(l=>this.driver.parseTableName(l)).map(({schema:l,tableName:h})=>(l||(l=this.driver.options.schema||r),`("t"."schema" = '${l}' AND "t"."name" = '${h}')`)).join(" OR "),a=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('m') AND "cnst"."contype" IS NULL AND (${e.length===0?"1=1":e.map(l=>this.driver.parseTableName(l)).map(({schema:l,tableName:h})=>(l||(l=this.driver.options.schema||r),`("ns"."nspname" = '${l}' AND "t"."relname" = '${h}')`)).join(" OR ")})`,o=`SELECT "t".* FROM ${this.escapePath(this.getTypeormMetadataTableName())} "t" INNER JOIN "pg_catalog"."pg_class" "c" ON "c"."relname" = "t"."name" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "c"."relnamespace" AND "n"."nspname" = "t"."schema" WHERE "t"."type" IN ('${de.VIEW}', '${de.MATERIALIZED_VIEW}') ${i?`AND (${i})`:""}`,c=await this.query(o),u=await this.query(a);return c.map(l=>{const h=K.uniq(u.filter(b=>b.table_name===l.name&&b.table_schema===l.schema),b=>b.constraint_name),f=new ht,E=l.schema===r&&!this.driver.options.schema?void 0:l.schema;return f.database=n,f.schema=l.schema,f.name=this.driver.buildTableName(l.name,E),f.expression=l.value,f.materialized=l.type===de.MATERIALIZED_VIEW,f.indices=h.map(b=>{const A=u.filter(P=>P.table_schema===b.table_schema&&P.table_name===b.table_name&&P.constraint_name===b.constraint_name);return new Be({view:f,name:b.constraint_name,columnNames:A.map(P=>P.column_name),isUnique:b.is_unique==="TRUE",where:b.condition,isFulltext:!1})}),f})}async loadTables(e){if(e&&e.length===0)return[];const t=await this.getCurrentSchema(),n=await this.getCurrentDatabase(),r=[];if(!e)r.push(...await this.query(`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables"`));else{const I=`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables" WHERE `+e.map(W=>this.driver.parseTableName(W)).map(({schema:W,tableName:G})=>`("table_schema" = '${W||t}' AND "table_name" = '${G}')`).join(" OR ");r.push(...await this.query(I))}if(r.length===0)return[];const s=`SELECT columns.*, pg_catalog.col_description(('"' || table_catalog || '"."' || table_schema || '"."' || table_name || '"')::regclass::oid, ordinal_position) AS description, ('"' || "udt_schema" || '"."' || "udt_name" || '"')::"regtype"::text AS "regtype", pg_catalog.format_type("col_attr"."atttypid", "col_attr"."atttypmod") AS "format_type" FROM "information_schema"."columns" LEFT JOIN "pg_catalog"."pg_attribute" AS "col_attr" ON "col_attr"."attname" = "columns"."column_name" AND "col_attr"."attrelid" = ( SELECT "cls"."oid" FROM "pg_catalog"."pg_class" AS "cls" LEFT JOIN "pg_catalog"."pg_namespace" AS "ns" ON "ns"."oid" = "cls"."relnamespace" WHERE "cls"."relname" = "columns"."table_name" AND "ns"."nspname" = "columns"."table_schema" ) WHERE `+r.map(({table_schema:D,table_name:I})=>`("table_schema" = '${D}' AND "table_name" = '${I}')`).join(" OR "),a=r.map(({table_schema:D,table_name:I})=>`("ns"."nspname" = '${D}' AND "t"."relname" = '${I}')`).join(" OR "),o=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "cnst"."conname" AS "constraint_name", pg_get_constraintdef("cnst"."oid") AS "expression", CASE "cnst"."contype" WHEN 'p' THEN 'PRIMARY' WHEN 'u' THEN 'UNIQUE' WHEN 'c' THEN 'CHECK' WHEN 'x' THEN 'EXCLUDE' END AS "constraint_type", "a"."attname" AS "column_name" FROM "pg_constraint" "cnst" INNER JOIN "pg_class" "t" ON "t"."oid" = "cnst"."conrelid" INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "cnst"."connamespace" LEFT JOIN "pg_attribute" "a" ON "a"."attrelid" = "cnst"."conrelid" AND "a"."attnum" = ANY ("cnst"."conkey") WHERE "t"."relkind" IN ('r', 'p') AND (${a})`,c=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name", "am"."amname" AS "index_type" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" INNER JOIN "pg_am" "am" ON "i"."relam" = "am"."oid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('r', 'p') AND "cnst"."contype" IS NULL AND (${a})`,u=r.map(({table_schema:D,table_name:I})=>`("ns"."nspname" = '${D}' AND "cl"."relname" = '${I}')`).join(" OR "),h=await this.hasSupportForPartitionedTables()?` AND "cl"."relispartition" = 'f'`:"",f=`SELECT "con"."conname" AS "constraint_name", "con"."nspname" AS "table_schema", "con"."relname" AS "table_name", "att2"."attname" AS "column_name", "ns"."nspname" AS "referenced_table_schema", "cl"."relname" AS "referenced_table_name", "att"."attname" AS "referenced_column_name", "con"."confdeltype" AS "on_delete", "con"."confupdtype" AS "on_update", "con"."condeferrable" AS "deferrable", "con"."condeferred" AS "deferred" FROM ( SELECT UNNEST ("con1"."conkey") AS "parent", UNNEST ("con1"."confkey") AS "child", "con1"."confrelid", "con1"."conrelid", "con1"."conname", "con1"."contype", "ns"."nspname", "cl"."relname", "con1"."condeferrable", CASE WHEN "con1"."condeferred" THEN 'INITIALLY DEFERRED' ELSE 'INITIALLY IMMEDIATE' END as condeferred, CASE "con1"."confdeltype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confdeltype", CASE "con1"."confupdtype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confupdtype" FROM "pg_class" "cl" INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_constraint" "con1" ON "con1"."conrelid" = "cl"."oid" WHERE "con1"."contype" = 'f' AND (${u}) ) "con" INNER JOIN "pg_attribute" "att" ON "att"."attrelid" = "con"."confrelid" AND "att"."attnum" = "con"."child" INNER JOIN "pg_class" "cl" ON "cl"."oid" = "con"."confrelid" ${h}INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_attribute" "att2" ON "att2"."attrelid" = "con"."conrelid" AND "att2"."attnum" = "con"."parent"`,[E,b,A,P]=await Promise.all([this.query(s),this.query(o),this.query(c),this.query(f)]);return Promise.all(r.map(async D=>{const I=new $e,W=(v,Y)=>v[Y]===t&&(!this.driver.options.schema||this.driver.options.schema===t)?void 0:v[Y],G=W(D,"table_schema");I.database=n,I.schema=D.table_schema,I.comment=D.table_comment,I.name=this.driver.buildTableName(D.table_name,G),I.columns=await Promise.all(E.filter(v=>v.table_name===D.table_name&&v.table_schema===D.table_schema).map(async v=>{const Y=b.filter(L=>L.table_name===v.table_name&&L.table_schema===v.table_schema&&L.column_name===v.column_name),Q=new ze;if(Q.name=v.column_name,Q.type=v.regtype.toLowerCase(),Q.type==="vector"||Q.type==="halfvec"){const L=v.format_type.match(/^(?:vector|halfvec)\((\d+)\)$/);L&&L[1]&&(Q.length=L[1])}if(Q.type==="numeric"||Q.type==="numeric[]"||Q.type==="decimal"||Q.type==="float"){let L=v.numeric_precision,V=v.numeric_scale;if(v.data_type==="ARRAY"){const X=v.format_type.match(/^numeric\(([0-9]+),([0-9]+)\)\[\]$/);X&&(L=+X[1],V=+X[2])}L!==null&&!this.isDefaultColumnPrecision(I,Q,L)?Q.precision=L:V!==null&&!this.isDefaultColumnScale(I,Q,V)&&(Q.precision=void 0),V!==null&&!this.isDefaultColumnScale(I,Q,V)?Q.scale=V:L!==null&&!this.isDefaultColumnPrecision(I,Q,L)&&(Q.scale=void 0)}if((Q.type==="interval"||Q.type==="time without time zone"||Q.type==="time with time zone"||Q.type==="timestamp without time zone"||Q.type==="timestamp with time zone")&&(Q.precision=this.isDefaultColumnPrecision(I,Q,v.datetime_precision)?void 0:v.datetime_precision),v.data_type==="USER-DEFINED"||v.data_type==="ARRAY"){const{name:L}=await this.getUserDefinedTypeName(I,Q),X=this.buildEnumName(I,Q,!1,!0)!==L?L:void 0,oe=`SELECT "e"."enumlabel" AS "value" FROM "pg_enum" "e" INNER JOIN "pg_type" "t" ON "t"."oid" = "e"."enumtypid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${D.table_schema}' AND "t"."typname" = '${X||L}'`,ee=await this.query(oe);if(ee.length&&(Q.type="enum",Q.enum=ee.map(ce=>ce.value),Q.enumName=X),v.data_type==="ARRAY"){Q.isArray=!0;const ce=Q.type.replace("[]","");Q.type=this.connection.driver.normalizeType({type:ce})}}if(Q.type==="geometry"||Q.type==="geography"){const L=`SELECT * FROM (SELECT "f_table_schema" "table_schema", "f_table_name" "table_name", "f_${Q.type}_column" "column_name", "srid", "type" FROM "${Q.type}_columns") AS _ WHERE "column_name" = '${v.column_name}' AND "table_schema" = '${v.table_schema}' AND "table_name" = '${v.table_name}'`,V=await this.query(L);V.length>0&&(Q.spatialFeatureType=V[0].type,Q.srid=V[0].srid)}if(this.driver.withLengthColumnTypes.indexOf(Q.type)!==-1){let L;if(Q.isArray){const V=/\((\d+)\)/.exec(v.format_type);L=V?V[1]:void 0}else v.character_maximum_length&&(L=v.character_maximum_length.toString());L&&(Q.length=this.isDefaultColumnLength(I,Q,L)?"":L)}Q.isNullable=v.is_nullable==="YES";const B=Y.find(L=>L.constraint_type==="PRIMARY");if(B){Q.isPrimary=!0;const V=b.filter(oe=>oe.table_name===v.table_name&&oe.table_schema===v.table_schema&&oe.column_name!==v.column_name&&oe.constraint_type==="PRIMARY").map(oe=>oe.column_name);V.push(v.column_name);const X=this.connection.namingStrategy.primaryKeyName(I,V);B.constraint_name!==X&&(Q.primaryKeyConstraintName=B.constraint_name)}const U=Y.filter(L=>L.constraint_type==="UNIQUE"),k=U.every(L=>b.some(V=>V.constraint_type==="UNIQUE"&&V.constraint_name===L.constraint_name&&V.column_name!==v.column_name));if(Q.isUnique=U.length>0&&!k,v.is_identity==="YES")Q.isGenerated=!0,Q.generationStrategy="identity",Q.generatedIdentity=v.identity_generation;else if(v.column_default!==null&&v.column_default!==void 0){const L=`nextval('${this.buildSequenceName(I,v.column_name)}'::regclass)`,V=`nextval('${this.buildSequencePath(I,v.column_name)}'::regclass)`,X=v.column_default.replace(/"/g,"");X===L||X===V?(Q.isGenerated=!0,Q.generationStrategy="increment"):v.column_default==="gen_random_uuid()"||/^uuid_generate_v\d\(\)/.test(v.column_default)?Q.type==="uuid"?(Q.isGenerated=!0,Q.generationStrategy="uuid"):Q.default=v.column_default:v.column_default==="now()"||v.column_default.indexOf("'now'::text")!==-1?Q.default=v.column_default:(Q.default=v.column_default.replace(/::[\w\s.[\]\-"]+/g,""),Q.default=Q.default.replace(/^(-?\d+)$/,"'$1'"))}if(v.is_generated==="ALWAYS"&&v.generation_expression){Q.generatedType="STORED";const L=this.selectTypeormMetadataSql({database:n,schema:D.table_schema,table:D.table_name,type:de.GENERATED_COLUMN,name:Q.name}),V=await this.query(L.query,L.parameters);V[0]&&V[0].value?Q.asExpression=V[0].value:Q.asExpression=""}return Q.comment=v.description?v.description:void 0,v.character_set_name&&(Q.charset=v.character_set_name),v.collation_name&&(Q.collation=v.collation_name),Q}));const ie=K.uniq(b.filter(v=>v.table_name===D.table_name&&v.table_schema===D.table_schema&&v.constraint_type==="UNIQUE"),v=>v.constraint_name);I.uniques=ie.map(v=>{const Y=b.filter(Q=>Q.constraint_name===v.constraint_name);return new We({name:v.constraint_name,columnNames:Y.map(Q=>Q.column_name),deferrable:v.deferrable?v.deferred:void 0})});const ne=K.uniq(b.filter(v=>v.table_name===D.table_name&&v.table_schema===D.table_schema&&v.constraint_type==="CHECK"),v=>v.constraint_name);I.checks=ne.map(v=>{const Y=b.filter(Q=>Q.constraint_name===v.constraint_name);return new it({name:v.constraint_name,columnNames:Y.map(Q=>Q.column_name),expression:v.expression.replace(/^\s*CHECK\s*\((.*)\)\s*$/i,"$1")})});const pe=K.uniq(b.filter(v=>v.table_name===D.table_name&&v.table_schema===D.table_schema&&v.constraint_type==="EXCLUDE"),v=>v.constraint_name);I.exclusions=pe.map(v=>new yt({name:v.constraint_name,expression:v.expression.substring(8)}));const F=K.uniq(P.filter(v=>v.table_name===D.table_name&&v.table_schema===D.table_schema),v=>v.constraint_name);I.foreignKeys=F.map(v=>{const Y=P.filter(U=>U.constraint_name===v.constraint_name),Q=W(v,"referenced_table_schema"),B=this.driver.buildTableName(v.referenced_table_name,Q);return new Je({name:v.constraint_name,columnNames:Y.map(U=>U.column_name),referencedSchema:v.referenced_table_schema,referencedTableName:B,referencedColumnNames:Y.map(U=>U.referenced_column_name),onDelete:v.on_delete,onUpdate:v.on_update,deferrable:v.deferrable?v.deferred:void 0})});const se=K.uniq(A.filter(v=>v.table_name===D.table_name&&v.table_schema===D.table_schema),v=>v.constraint_name);return I.indices=se.map(v=>{const Y=A.filter(Q=>Q.table_schema===v.table_schema&&Q.table_name===v.table_name&&Q.constraint_name===v.constraint_name);return new Be({table:I,name:v.constraint_name,columnNames:Y.map(Q=>Q.column_name),isUnique:v.is_unique==="TRUE",where:v.condition,isSpatial:v.index_type==="gist",isFulltext:!1})}),I}))}createTableSql(e,t){const n=e.columns.map(s=>this.buildCreateColumnSql(e,s)).join(", ");let r=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(s=>s.isUnique).forEach(s=>{e.uniques.some(o=>o.columnNames.length===1&&o.columnNames[0]===s.name)||e.uniques.push(new We({name:this.connection.namingStrategy.uniqueConstraintName(e,[s.name]),columnNames:[s.name]}))}),e.uniques.length>0){const s=e.uniques.map(a=>{const o=a.name?a.name:this.connection.namingStrategy.uniqueConstraintName(e,a.columnNames),c=a.columnNames.map(l=>`"${l}"`).join(", ");let u=`CONSTRAINT "${o}" UNIQUE (${c})`;return a.deferrable&&(u+=` DEFERRABLE ${a.deferrable}`),u}).join(", ");r+=`, ${s}`}if(e.checks.length>0){const s=e.checks.map(a=>`CONSTRAINT "${a.name?a.name:this.connection.namingStrategy.checkConstraintName(e,a.expression)}" CHECK (${a.expression})`).join(", ");r+=`, ${s}`}if(e.exclusions.length>0){const s=e.exclusions.map(a=>`CONSTRAINT "${a.name?a.name:this.connection.namingStrategy.exclusionConstraintName(e,a.expression)}" EXCLUDE ${a.expression}`).join(", ");r+=`, ${s}`}if(e.foreignKeys.length>0&&t){const s=e.foreignKeys.map(a=>{const o=a.columnNames.map(l=>`"${l}"`).join(", ");a.name||(a.name=this.connection.namingStrategy.foreignKeyName(e,a.columnNames,this.getTablePath(a),a.referencedColumnNames));const c=a.referencedColumnNames.map(l=>`"${l}"`).join(", ");let u=`CONSTRAINT "${a.name}" FOREIGN KEY (${o}) REFERENCES ${this.escapePath(this.getTablePath(a))} (${c})`;return a.onDelete&&(u+=` ON DELETE ${a.onDelete}`),a.onUpdate&&(u+=` ON UPDATE ${a.onUpdate}`),a.deferrable&&(u+=` DEFERRABLE ${a.deferrable}`),u}).join(", ");r+=`, ${s}`}const i=e.columns.filter(s=>s.isPrimary);if(i.length>0){const s=i[0].primaryKeyConstraintName?i[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(e,i.map(o=>o.name)),a=i.map(o=>`"${o.name}"`).join(", ");r+=`, CONSTRAINT "${s}" PRIMARY KEY (${a})`}return r+=")",e.columns.filter(s=>s.comment).forEach(s=>r+=`; COMMENT ON COLUMN ${this.escapePath(e)}."${s.name}" IS ${this.escapeComment(s.comment)}`),new R(r)}async getVersion(){return(await this.query("SELECT version()"))[0].version.replace(/^PostgreSQL ([\d.]+).*$/,"$1")}dropTableSql(e){return new R(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){const t=e.materialized?"MATERIALIZED ":"",n=this.escapePath(e);return typeof e.expression=="string"?new R(`CREATE ${t}VIEW ${n} AS ${e.expression}`):new R(`CREATE ${t}VIEW ${n} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){const t=await this.getCurrentSchema();let{schema:n,tableName:r}=this.driver.parseTableName(e);n||(n=t);const i=e.materialized?de.MATERIALIZED_VIEW:de.VIEW,s=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:i,schema:n,name:r,value:s})}dropViewSql(e){const t=e.materialized?"MATERIALIZED ":"";return new R(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const t=await this.getCurrentSchema();let{schema:n,tableName:r}=this.driver.parseTableName(e);n||(n=t);const i=e.materialized?de.MATERIALIZED_VIEW:de.VIEW;return this.deleteTypeormMetadataSql({type:i,schema:n,name:r})}async dropEnumTypes(e){const t=`SELECT 'DROP TYPE IF EXISTS "' || n.nspname || '"."' || t.typname || '" CASCADE;' as "query" FROM "pg_type" "t" INNER JOIN "pg_enum" "e" ON "e"."enumtypid" = "t"."oid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" IN (${e}) GROUP BY "n"."nspname", "t"."typname"`,n=await this.query(t);await Promise.all(n.map(r=>this.query(r.query)))}async hasEnumType(e,t){let{schema:n}=this.driver.parseTableName(e);n||(n=await this.getCurrentSchema());const r=this.buildEnumName(e,t,!1,!0),i=`SELECT "n"."nspname", "t"."typname" FROM "pg_type" "t" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${n}' AND "t"."typname" = '${r}'`;return!!(await this.query(i)).length}createEnumTypeSql(e,t,n){n||(n=this.buildEnumName(e,t));const r=t.enum.map(i=>`'${i.replaceAll("'","''")}'`).join(", ");return new R(`CREATE TYPE ${n} AS ENUM(${r})`)}dropEnumTypeSql(e,t,n){return n||(n=this.buildEnumName(e,t)),new R(`DROP TYPE ${n}`)}createIndexSql(e,t){const n=t.columnNames.map(r=>`"${r}"`).join(", ");return new R(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX${t.isConcurrent?" CONCURRENTLY":""} "${t.name}" ON ${this.escapePath(e)} ${t.isSpatial?"USING GiST ":""}(${n}) ${t.where?"WHERE "+t.where:""}`)}createViewIndexSql(e,t){const n=t.columnNames.map(r=>`"${r}"`).join(", ");return new R(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX "${t.name}" ON ${this.escapePath(e)} (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e,t){const n=q.isTableIndex(t)?t.name:t,r=q.isTableIndex(t)?t.isConcurrent:!1,{schema:i}=this.driver.parseTableName(e);return i?new R(`DROP INDEX ${r?"CONCURRENTLY ":""}"${i}"."${n}"`):new R(`DROP INDEX ${r?"CONCURRENTLY ":""}"${n}"`)}createPrimaryKeySql(e,t,n){const r=n||this.connection.namingStrategy.primaryKeyName(e,t),i=t.map(s=>`"${s}"`).join(", ");return new R(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${r}" PRIMARY KEY (${i})`)}dropPrimaryKeySql(e){if(!e.primaryColumns.length)throw new M(`Table ${e} has no primary keys.`);const t=e.primaryColumns.map(i=>i.name),n=e.primaryColumns[0].primaryKeyConstraintName,r=n||this.connection.namingStrategy.primaryKeyName(e,t);return new R(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${r}"`)}createUniqueConstraintSql(e,t){const n=t.columnNames.map(i=>'"'+i+'"').join(", ");let r=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" UNIQUE (${n})`;return t.deferrable&&(r+=` DEFERRABLE ${t.deferrable}`),new R(r)}dropUniqueConstraintSql(e,t){const n=q.isTableUnique(t)?t.name:t;return new R(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createCheckConstraintSql(e,t){return new R(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){const n=q.isTableCheck(t)?t.name:t;return new R(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createExclusionConstraintSql(e,t){return new R(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" EXCLUDE ${t.expression}`)}dropExclusionConstraintSql(e,t){const n=q.isTableExclusion(t)?t.name:t;return new R(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createForeignKeySql(e,t){const n=t.columnNames.map(s=>'"'+s+'"').join(", "),r=t.referencedColumnNames.map(s=>'"'+s+'"').join(",");let i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${r})`;return t.onDelete&&(i+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(i+=` ON UPDATE ${t.onUpdate}`),t.deferrable&&(i+=` DEFERRABLE ${t.deferrable}`),new R(i)}dropForeignKeySql(e,t){const n=q.isTableForeignKey(t)?t.name:t;return new R(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}buildSequenceName(e,t){const{tableName:n}=this.driver.parseTableName(e),r=q.isTableColumn(t)?t.name:t;let i=`${n}_${r}_seq`;return i.length>this.connection.driver.maxAliasLength&&(i=`${n.substring(0,29)}_${r.substring(0,Math.max(29,63-e.name.length-5))}_seq`),i}buildSequencePath(e,t){const{schema:n}=this.driver.parseTableName(e);return n?`${n}.${this.buildSequenceName(e,t)}`:this.buildSequenceName(e,t)}buildEnumName(e,t,n=!0,r,i){const{schema:s,tableName:a}=this.driver.parseTableName(e);let o=t.enumName?t.enumName:`${a}_${t.name.toLowerCase()}_enum`;return s&&n&&(o=`${s}.${o}`),i&&(o=o+"_old"),o.split(".").map(c=>r?c:`"${c}"`).join(".")}async getUserDefinedTypeName(e,t){let{schema:n,tableName:r}=this.driver.parseTableName(e);n||(n=await this.getCurrentSchema());const i=await this.query(`SELECT "udt_schema", "udt_name" FROM "information_schema"."columns" WHERE "table_schema" = '${n}' AND "table_name" = '${r}' AND "column_name"='${t.name}'`);let s=i[0].udt_name;return s.indexOf("_")===0&&(s=s.substr(1,s.length)),{schema:i[0].udt_schema,name:s}}escapeComment(e){return!e||e.length===0?"NULL":(e=e.replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){const{schema:t,tableName:n}=this.driver.parseTableName(e);return t&&t!==this.driver.searchSchema?`"${t}"."${n}"`:`"${n}"`}async getTableNameWithSchema(e){const t=q.isTable(e)?e.name:e;return t.indexOf(".")===-1?`${(await this.query("SELECT current_schema()"))[0].current_schema}.${t}`:`${t.split(".")[0]}.${t.split(".")[1]}`}buildCreateColumnSql(e,t){let n='"'+t.name+'"';if(t.isGenerated===!0&&t.generationStrategy!=="uuid")if(t.generationStrategy==="identity"){const r=t.generatedIdentity||"BY DEFAULT";n+=` ${t.type} GENERATED ${r} AS IDENTITY`}else(t.type==="integer"||t.type==="int"||t.type==="int4")&&(n+=" SERIAL"),(t.type==="smallint"||t.type==="int2")&&(n+=" SMALLSERIAL"),(t.type==="bigint"||t.type==="int8")&&(n+=" BIGSERIAL");return t.type==="enum"||t.type==="simple-enum"?(n+=" "+this.buildEnumName(e,t),t.isArray&&(n+=" array")):(!t.isGenerated||t.type==="uuid")&&(n+=" "+this.connection.driver.createFullType(t)),t.generatedType==="STORED"&&t.asExpression&&(n+=` GENERATED ALWAYS AS (${t.asExpression}) STORED`),t.charset&&(n+=' CHARACTER SET "'+t.charset+'"'),t.collation&&(n+=' COLLATE "'+t.collation+'"'),t.isNullable!==!0&&(n+=" NOT NULL"),t.default!==void 0&&t.default!==null&&(n+=" DEFAULT "+t.default),t.isGenerated&&t.generationStrategy==="uuid"&&!t.default&&(n+=` DEFAULT ${this.driver.uuidGenerator}`),n}async hasSupportForPartitionedTables(){return!!(await this.query("SELECT TRUE FROM information_schema.columns WHERE table_name = 'pg_class' and column_name = 'relispartition'")).length}async changeTableComment(e,t){const n=[],r=[],i=q.isTable(e)?e:await this.getCachedTable(e);t=this.escapeComment(t);const s=this.escapeComment(i.comment);if(t===s)return;const a=i.clone();n.push(new R(`COMMENT ON TABLE ${this.escapePath(a)} IS ${t}`)),r.push(new R(`COMMENT ON TABLE ${this.escapePath(i)} IS ${s}`)),await this.executeQueries(n,r),i.comment=a.comment,this.replaceCachedTable(i,a)}}class Pc extends vc{constructor(e,t){super(e,t)}}class Ic extends Pc{constructor(e,t,n){super(e,n),this.client=t}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)),this.databaseConnectionPromise)}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new He;const r=await this.client.query(e,t),i=new at;return i.raw=r,r?.hasOwnProperty("records")&&Array.isArray(r.records)&&(i.records=r.records),r?.hasOwnProperty("numberOfRecordsUpdated")&&(i.affected=r.numberOfRecordsUpdated),n?i:i.raw}changeTableComment(e,t){throw new M("aurora-postgres driver does not support change comment.")}}class Oc extends js{}class Dc extends Oc{constructor(e){super(),this.transactionSupport="nested",this.connection=e,this.options=e.options,this.isReplicated=!1,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),this.database=J.buildDriverOptions(this.options).database}async connect(){}async disconnect(){}createQueryRunner(e){return new Ic(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),e)}preparePersistentValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.preparePersistentValue(e,t):(t.transformer&&(e=ke.transformTo(t.transformer,e)),this.client.preparePersistentValue(e,t))}prepareHydratedValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.prepareHydratedValue(e,t):(t.transformer&&(e=ke.transformFrom(t.transformer,e)),this.client.prepareHydratedValue(e,t))}loadDependencies(){const e=this.options.driver||ve.load("typeorm-aurora-data-api-driver"),{pg:t}=e;this.DataApiDriver=t}executeQuery(e,t){return this.connection.query(t)}async afterConnect(){const e=await this.checkMetadataForExtensions();return e.hasExtensions&&await this.enableExtensions(e,this.connection),Promise.resolve()}}class qc extends gt{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ct(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async executeSet(e){if(this.isReleased)throw new He;return(await this.connect()).executeSet(e,!1)}async query(e,t,n=!1){if(this.isReleased)throw new He;const r=await this.connect();this.driver.connection.logger.logQuery(e,t,this);const i=e.substring(0,e.indexOf(" ")!==-1?e.indexOf(" "):void 0);try{let s;["BEGIN","ROLLBACK","COMMIT","CREATE","ALTER","DROP"].indexOf(i)!==-1?s=await r.execute(e,!1):["INSERT","UPDATE","DELETE"].indexOf(i)!==-1?s=await r.run(e,t,!1):s=await r.query(e,t||[]);const a=new at;return s?.hasOwnProperty("values")&&(a.raw=s.values,a.records=s.values),s?.hasOwnProperty("changes")&&(a.affected=s.changes.changes,a.raw=s.changes.lastId||s.changes.changes),n?a:a.raw}catch(s){throw this.driver.connection.logger.logQueryError(s,e,t,this),new rt(e,t,s)}}parametrize(e){return Object.keys(e).map(t=>`"${t}"=?`)}}class $c extends At{constructor(e){super(e),this.database=this.options.database,this.driver=this.options.driver,this.sqlite=this.options.driver}async connect(){this.databaseConnection=this.createDatabaseConnection(),await this.databaseConnection}async disconnect(){return this.queryRunner=void 0,(await this.databaseConnection).close().then(()=>{this.databaseConnection=void 0})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new qc(this)),this.queryRunner}async createDatabaseConnection(){const e=this.options.mode||"no-encryption",t=e!=="no-encryption",n=typeof this.options.version>"u"?1:this.options.version,r=await this.sqlite.createConnection(this.options.database,t,e,n);return await r.open(),await r.execute("PRAGMA foreign_keys = ON"),this.options.journalMode&&["DELETE","TRUNCATE","PERSIST","MEMORY","WAL","OFF"].indexOf(this.options.journalMode)!==-1&&await r.execute(`PRAGMA journal_mode = ${this.options.journalMode}`),r}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new bt("Capacitor","@capacitor-community/sqlite")}}class _c extends en{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new ct(this)}async connect(){if(this.session)return Promise.resolve(this.session);const[e]=await this.driver.instanceDatabase.createSession({});return this.session=e,this.sessionTransaction=await e.transaction(),this.session}async release(){return this.isReleased=!0,this.session&&await this.session.delete(),this.session=void 0,Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}await this.connect(),await this.sessionTransaction.begin(),this.connection.logger.logQuery("START TRANSACTION"),await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionCommit"),await this.sessionTransaction.commit(),this.connection.logger.logQuery("COMMIT"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new Ye;await this.broadcaster.broadcast("BeforeTransactionRollback"),await this.sessionTransaction.rollback(),this.connection.logger.logQuery("ROLLBACK"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new He;await this.connect(),this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const r=new Xe;try{const i=Date.now();let s;const a=e.startsWith("SELECT"),o=a&&!this.isTransactionActive?this.driver.instanceDatabase:this.sessionTransaction;!this.isTransactionActive&&!a&&await this.sessionTransaction.begin();try{s=await o.run({sql:e,params:t?t.reduce((f,E,b)=>(f["param"+b]=E,f),{}):void 0,json:!0}),!this.isTransactionActive&&!a&&await this.sessionTransaction.commit()}catch(f){try{!this.isTransactionActive&&!a&&await this.sessionTransaction.rollback()}catch{}throw f}const c=this.driver.options.maxQueryExecutionTime,l=Date.now()-i;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,l,s,void 0),c&&l>c&&this.driver.connection.logger.logQuerySlow(l,e,t,this);const h=new at;return h.raw=s,h.records=s?s[0]:[],s&&s[1]&&s[1].rowCountExact&&(h.affected=parseInt(s[1].rowCountExact)),n?h:h.records}catch(i){throw this.driver.connection.logger.logQueryError(i,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,void 0,void 0,i),new rt(e,t,i)}finally{await r.wait()}}async updateDDL(e,t){if(this.isReleased)throw new He;this.driver.connection.logger.logQuery(e,t,this);try{const n=Date.now(),[r]=await this.driver.instanceDatabase.updateSchema(e);await r.promise();const i=this.driver.options.maxQueryExecutionTime,a=Date.now()-n;i&&a>i&&this.driver.connection.logger.logQuerySlow(a,e,t,this)}catch(n){throw this.driver.connection.logger.logQueryError(n,e,t,this),new rt(e,t,n)}}async stream(e,t,n,r){if(this.isReleased)throw new He;try{this.driver.connection.logger.logQuery(e,t,this);const i={sql:e,params:t?t.reduce((a,o,c)=>(a["param"+c]=o,a),{}):void 0,json:!0},s=this.driver.instanceDatabase.runStream(i);return n&&s.on("end",n),r&&s.on("error",r),s}catch(i){throw this.driver.connection.logger.logQueryError(i,e,t,this),new rt(e,t,i)}}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){throw new M("Check database queries are not supported by Spanner driver.")}async getCurrentDatabase(){throw new M("Check database queries are not supported by Spanner driver.")}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){throw new M("Check schema queries are not supported by Spanner driver.")}async hasTable(e){const n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` = '${e instanceof $e?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const r=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` = '${e instanceof $e?e.name:e}' AND \`COLUMN_NAME\` = '${t}'`;return!!(await this.query(r)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();const n=`CREATE DATABASE "${e}"`,r=`DROP DATABASE "${e}"`;await this.executeQueries(new R(n),new R(r))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,r=`CREATE DATABASE "${e}"`;await this.executeQueries(new R(n),new R(r))}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t,n){return Promise.resolve()}async createTable(e,t=!1,n=!0,r=!0){if(t&&await this.hasTable(e))return Promise.resolve();const i=[],s=[];i.push(this.createTableSql(e,n)),s.push(this.dropTableSql(e)),n&&e.foreignKeys.forEach(o=>s.push(this.dropForeignKeySql(e,o))),r&&e.indices.forEach(o=>{o.name||(o.name=this.connection.namingStrategy.indexName(e,o.columnNames,o.where)),i.push(this.createIndexSql(e,o)),s.push(this.dropIndexSql(e,o))});const a=e.columns.filter(o=>o.generatedType&&o.asExpression);for(const o of a){const c=this.insertTypeormMetadataSql({table:e.name,type:de.GENERATED_COLUMN,name:o.name,value:o.asExpression}),u=this.deleteTypeormMetadataSql({table:e.name,type:de.GENERATED_COLUMN,name:o.name});i.push(c),s.push(u)}await this.executeQueries(i,s)}async dropTable(e,t,n=!0,r=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const i=n,s=this.getTablePath(e),a=await this.getCachedTable(s),o=[],c=[];r&&a.indices.forEach(l=>{o.push(this.dropIndexSql(a,l)),c.push(this.createIndexSql(a,l))}),n&&a.foreignKeys.forEach(l=>o.push(this.dropForeignKeySql(a,l))),o.push(this.dropTableSql(a)),c.push(this.createTableSql(a,i));const u=a.columns.filter(l=>l.generatedType&&l.asExpression);for(const l of u){const h=this.deleteTypeormMetadataSql({table:a.name,type:de.GENERATED_COLUMN,name:l.name}),f=this.insertTypeormMetadataSql({table:a.name,type:de.GENERATED_COLUMN,name:l.name,value:l.asExpression});o.push(h),c.push(f)}await this.executeQueries(o,c)}async createView(e){const t=[],n=[];t.push(this.createViewSql(e)),t.push(await this.insertViewDefinitionSql(e)),n.push(this.dropViewSql(e)),n.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(t,n)}async dropView(e){const t=e instanceof ht?e.name:e,n=await this.getCachedView(t),r=[],i=[];r.push(await this.deleteViewDefinitionSql(n)),r.push(this.dropViewSql(n)),i.push(await this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(r,i)}async renameTable(e,t){throw new M("Rename table queries are not supported by Spanner driver.")}async addColumn(e,t){const n=e instanceof $e?e:await this.getCachedTable(e),r=n.clone(),i=[],s=[];i.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(t)}`)),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN ${this.driver.escape(t.name)}`));const a=r.indices.find(o=>o.columnNames.length===1&&o.columnNames[0]===t.name);if(a)i.push(this.createIndexSql(n,a)),s.push(this.dropIndexSql(n,a));else if(t.isUnique){const o=new Be({name:this.connection.namingStrategy.indexName(n,[t.name]),columnNames:[t.name],isUnique:!0});r.indices.push(o),r.uniques.push(new We({name:o.name,columnNames:o.columnNames})),i.push(this.createIndexSql(n,o)),s.push(this.dropIndexSql(n,o))}if(t.generatedType&&t.asExpression){const o=this.insertTypeormMetadataSql({table:n.name,type:de.GENERATED_COLUMN,name:t.name,value:t.asExpression}),c=this.deleteTypeormMetadataSql({table:n.name,type:de.GENERATED_COLUMN,name:t.name});i.push(o),s.push(c)}await this.executeQueries(i,s),r.addColumn(t),this.replaceCachedTable(n,r)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const r=e instanceof $e?e:await this.getCachedTable(e),i=t instanceof ze?t:r.columns.find(a=>a.name===t);if(!i)throw new M(`Column "${t}" was not found in the "${r.name}" table.`);let s;return n instanceof ze?s=n:(s=i.clone(),s.name=n),this.changeColumn(r,i,s)}async changeColumn(e,t,n){const r=e instanceof $e?e:await this.getCachedTable(e);let i=r.clone();const s=[],a=[],o=t instanceof ze?t:r.columns.find(c=>c.name===t);if(!o)throw new M(`Column "${t}" was not found in the "${r.name}" table.`);if(o.name!==n.name||o.type!==n.type||o.length!==n.length||o.isArray!==n.isArray||o.generatedType!==n.generatedType||o.asExpression!==n.asExpression)await this.dropColumn(r,o),await this.addColumn(r,n),i=r.clone();else if((n.precision!==o.precision||n.scale!==o.scale)&&(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(o)}`))),o.isNullable!==n.isNullable&&(n.isNullable?(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${o.name}" DROP NOT NULL`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${o.name}" SET NOT NULL`))):(s.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${o.name}" SET NOT NULL`)),a.push(new R(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${o.name}" DROP NOT NULL`)))),n.isUnique!==o.isUnique)if(n.isUnique===!0){const c=new Be({name:this.connection.namingStrategy.indexName(r,[n.name]),columnNames:[n.name],isUnique:!0});i.indices.push(c),i.uniques.push(new We({name:c.name,columnNames:c.columnNames})),s.push(this.createIndexSql(r,c)),a.push(this.dropIndexSql(r,c))}else{const c=i.indices.find(l=>l.columnNames.length===1&&l.isUnique===!0&&!!l.columnNames.find(h=>h===n.name));i.indices.splice(i.indices.indexOf(c),1);const u=i.uniques.find(l=>l.name===c.name);i.uniques.splice(i.uniques.indexOf(u),1),s.push(this.dropIndexSql(r,c)),a.push(this.createIndexSql(r,c))}await this.executeQueries(s,a),this.replaceCachedTable(r,i)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:r}of t)await this.changeColumn(e,n,r)}async dropColumn(e,t){const n=e instanceof $e?e:await this.getCachedTable(e),r=t instanceof ze?t:n.findColumnByName(t);if(!r)throw new M(`Column "${t}" was not found in table "${n.name}"`);const i=n.clone(),s=[],a=[],o=i.indices.find(u=>u.columnNames.length===1&&u.columnNames[0]===r.name);o&&(i.indices.splice(i.indices.indexOf(o),1),s.push(this.dropIndexSql(n,o)),a.push(this.createIndexSql(n,o)));const c=i.checks.find(u=>!!u.columnNames&&u.columnNames.length===1&&u.columnNames[0]===r.name);if(c&&(i.checks.splice(i.checks.indexOf(c),1),s.push(this.dropCheckConstraintSql(n,c)),a.push(this.createCheckConstraintSql(n,c))),s.push(new R(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN ${this.driver.escape(r.name)}`)),a.push(new R(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(r)}`)),r.generatedType&&r.asExpression){const u=this.deleteTypeormMetadataSql({table:n.name,type:de.GENERATED_COLUMN,name:r.name}),l=this.insertTypeormMetadataSql({table:n.name,type:de.GENERATED_COLUMN,name:r.name,value:r.asExpression});s.push(u),a.push(l)}await this.executeQueries(s,a),i.removeColumn(r),this.replaceCachedTable(n,i)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async updatePrimaryKeys(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async dropPrimaryKey(e){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async createUniqueConstraint(e,t){throw new M("Spanner does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new M("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new M("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new M("Spanner does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){const n=e instanceof $e?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(n,t.expression));const r=this.createCheckConstraintSql(n,t),i=this.dropCheckConstraintSql(n,t);await this.executeQueries(r,i),n.addCheckConstraint(t)}async createCheckConstraints(e,t){const n=t.map(r=>this.createCheckConstraint(e,r));await Promise.all(n)}async dropCheckConstraint(e,t){const n=e instanceof $e?e:await this.getCachedTable(e),r=t instanceof it?t:n.checks.find(a=>a.name===t);if(!r)throw new M(`Supplied check constraint was not found in table ${n.name}`);const i=this.dropCheckConstraintSql(n,r),s=this.createCheckConstraintSql(n,r);await this.executeQueries(i,s),n.removeCheckConstraint(r)}async dropCheckConstraints(e,t){const n=t.map(r=>this.dropCheckConstraint(e,r));await Promise.all(n)}async createExclusionConstraint(e,t){throw new M("Spanner does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new M("Spanner does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new M("Spanner does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new M("Spanner does not support exclusion constraints.")}async createForeignKey(e,t){const n=e instanceof $e?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames,this.getTablePath(t),t.referencedColumnNames));const r=this.createForeignKeySql(n,t),i=this.dropForeignKeySql(n,t);await this.executeQueries(r,i),n.addForeignKey(t)}async createForeignKeys(e,t){for(const n of t)await this.createForeignKey(e,n)}async dropForeignKey(e,t){const n=e instanceof $e?e:await this.getCachedTable(e),r=t instanceof Je?t:n.foreignKeys.find(a=>a.name===t);if(!r)throw new M(`Supplied foreign key was not found in table ${n.name}`);const i=this.dropForeignKeySql(n,r),s=this.createForeignKeySql(n,r);await this.executeQueries(i,s),n.removeForeignKey(r)}async dropForeignKeys(e,t){for(const n of[...t])await this.dropForeignKey(e,n)}async createIndex(e,t){const n=e instanceof $e?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createIndexSql(n,t),i=this.dropIndexSql(n,t);await this.executeQueries(r,i),n.addIndex(t)}async createIndices(e,t){for(const n of t)await this.createIndex(e,n)}async dropIndex(e,t){const n=e instanceof $e?e:await this.getCachedTable(e),r=t instanceof Be?t:n.indices.find(a=>a.name===t);if(!r)throw new M(`Supplied index ${t} was not found in table ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(n,r),s=this.createIndexSql(n,r);await this.executeQueries(i,s),n.removeIndex(r)}async dropIndices(e,t){for(const n of[...t])await this.dropIndex(e,n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)} WHERE true`)}async clearDatabase(){const t=await this.query("SELECT concat('DROP INDEX `', INDEX_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`INDEXES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `INDEX_TYPE` = 'INDEX' AND `SPANNER_IS_MANAGED` = false"),r=await this.query("SELECT concat('ALTER TABLE `', TABLE_NAME, '`', ' DROP CONSTRAINT `', CONSTRAINT_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLE_CONSTRAINTS` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `CONSTRAINT_TYPE` = 'FOREIGN KEY'"),s=await this.query("SELECT concat('DROP TABLE `', TABLE_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'");if(!t.length&&!r.length&&!s.length)return;const a=this.isTransactionActive;a||await this.startTransaction();try{for(const o of t)await this.updateDDL(o.query);for(const o of r)await this.updateDDL(o.query);for(const o of s)await this.updateDDL(o.query);await this.commitTransaction()}catch(o){try{a||await this.rollbackTransaction()}catch{}throw o}}async executeMemoryUpSql(){for(const{query:e,parameters:t}of this.sqlInMemory.upQueries)this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async executeMemoryDownSql(){for(const{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async loadViews(e){return Promise.resolve([])}async loadTables(e){if(e&&e.length===0)return[];const t=[];if(!e||!e.length)t.push(...await this.query("SELECT `TABLE_NAME` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'"));else{const E=`SELECT \`TABLE_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` IN (${e.map(b=>`'${b}'`).join(", ")})`;t.push(...await this.query(E))}if(!t.length)return[];const n=t.map(E=>`'${E.TABLE_NAME}'`).join(", "),r=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` IN (${n})`,i=`SELECT \`KCU\`.\`TABLE_NAME\`, \`KCU\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'PRIMARY KEY' AND \`TC\`.\`TABLE_NAME\` IN (${n})`,s=`SELECT \`I\`.\`TABLE_NAME\`, \`I\`.\`INDEX_NAME\`, \`I\`.\`IS_UNIQUE\`, \`I\`.\`IS_NULL_FILTERED\`, \`IC\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`INDEXES\` \`I\` INNER JOIN \`INFORMATION_SCHEMA\`.\`INDEX_COLUMNS\` \`IC\` ON \`IC\`.\`INDEX_NAME\` = \`I\`.\`INDEX_NAME\` AND \`IC\`.\`TABLE_NAME\` = \`I\`.\`TABLE_NAME\` WHERE \`I\`.\`TABLE_CATALOG\` = '' AND \`I\`.\`TABLE_SCHEMA\` = '' AND \`I\`.\`TABLE_NAME\` IN (${n}) AND \`I\`.\`INDEX_TYPE\` = 'INDEX' AND \`I\`.\`SPANNER_IS_MANAGED\` = false`,a=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`CC\`.\`CHECK_CLAUSE\`, \`CCU\`.\`COLUMN_NAME\`FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CHECK_CONSTRAINTS\` \`CC\` ON \`CC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'CHECK' AND \`TC\`.\`TABLE_NAME\` IN (${n}) AND \`TC\`.\`CONSTRAINT_NAME\` NOT LIKE 'CK_IS_NOT_NULL%'`,o=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`KCU\`.\`COLUMN_NAME\`, \`CTU\`.\`TABLE_NAME\` AS \`REFERENCED_TABLE_NAME\`, \`CCU\`.\`COLUMN_NAME\` AS \`REFERENCED_COLUMN_NAME\`, \`RC\`.\`UPDATE_RULE\`, \`RC\`.\`DELETE_RULE\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_TABLE_USAGE\` \`CTU\` ON \`CTU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`RC\` ON \`RC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'FOREIGN KEY' AND \`TC\`.\`TABLE_NAME\` IN (${n})`,[c,u,l,h,f]=await Promise.all([this.query(r),this.query(i),this.query(s),this.query(a),this.query(o)]);return Promise.all(t.map(async E=>{const b=new $e;b.name=this.driver.buildTableName(E.TABLE_NAME),b.columns=await Promise.all(c.filter(I=>I.TABLE_NAME===E.TABLE_NAME).map(async I=>{const W=l.filter(se=>se.TABLE_NAME===E.TABLE_NAME&&se.COLUMN_NAME===I.COLUMN_NAME&&se.IS_UNIQUE===!0),G=this.connection.entityMetadatas.find(se=>this.getTablePath(b)===this.getTablePath(se)),ie=W.length>0&&G&&G.indices.some(se=>W.some(v=>se.name===v.INDEX_NAME&&se.synchronize===!1)),ne=W.every(se=>l.some(v=>v.INDEX_NAME===se.INDEX_NAME&&v.COLUMN_NAME!==I.COLUMN_NAME)),pe=new ze;pe.name=I.COLUMN_NAME;let F=I.SPANNER_TYPE.toLowerCase();if(F.indexOf("array")!==-1&&(pe.isArray=!0,F=F.substring(F.indexOf("<")+1,F.indexOf(">"))),F.indexOf("(")!==-1?pe.type=F.substring(0,F.indexOf("(")):pe.type=F,this.driver.withLengthColumnTypes.indexOf(pe.type)!==-1&&(pe.length=F.substring(F.indexOf("(")+1,F.indexOf(")"))),I.IS_GENERATED==="ALWAYS"){pe.asExpression=I.GENERATION_EXPRESSION,pe.generatedType="STORED";const se=this.selectTypeormMetadataSql({table:E.TABLE_NAME,type:de.GENERATED_COLUMN,name:pe.name}),v=await this.query(se.query,se.parameters);v[0]&&v[0].value?pe.asExpression=v[0].value:pe.asExpression=""}return pe.isUnique=W.length>0&&!ie&&!ne,pe.isNullable=I.IS_NULLABLE==="YES",pe.isPrimary=u.some(se=>se.TABLE_NAME===I.TABLE_NAME&&se.COLUMN_NAME===I.COLUMN_NAME),pe}));const A=f.filter(I=>I.TABLE_NAME===E.TABLE_NAME);b.foreignKeys=K.uniq(A,I=>I.CONSTRAINT_NAME).map(I=>{const W=A.filter(G=>G.CONSTRAINT_NAME===I.CONSTRAINT_NAME);return new Je({name:I.CONSTRAINT_NAME,columnNames:K.uniq(W.map(G=>G.COLUMN_NAME)),referencedDatabase:I.REFERENCED_TABLE_SCHEMA,referencedTableName:I.REFERENCED_TABLE_NAME,referencedColumnNames:K.uniq(W.map(G=>G.REFERENCED_COLUMN_NAME)),onDelete:I.DELETE_RULE,onUpdate:I.UPDATE_RULE})});const P=l.filter(I=>I.TABLE_NAME===E.TABLE_NAME);b.indices=K.uniq(P,I=>I.INDEX_NAME).map(I=>{const W=P.filter(G=>G.INDEX_NAME===I.INDEX_NAME);return new Be({table:b,name:I.INDEX_NAME,columnNames:W.map(G=>G.COLUMN_NAME),isUnique:I.IS_UNIQUE,isNullFiltered:I.IS_NULL_FILTERED})});const D=h.filter(I=>I.TABLE_NAME===E.TABLE_NAME);return b.checks=K.uniq(D,I=>I.CONSTRAINT_NAME).map(I=>{const W=D.filter(G=>G.CONSTRAINT_NAME===I.CONSTRAINT_NAME);return new it({name:I.CONSTRAINT_NAME,columnNames:W.map(G=>G.COLUMN_NAME),expression:I.CHECK_CLAUSE})}),b}))}createTableSql(e,t){const n=e.columns.map(s=>this.buildCreateColumnSql(s)).join(", ");let r=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(s=>s.isUnique).forEach(s=>{const a=e.indices.some(c=>c.columnNames.length===1&&!!c.isUnique&&c.columnNames.indexOf(s.name)!==-1),o=e.uniques.some(c=>c.columnNames.length===1&&c.columnNames.indexOf(s.name)!==-1);!a&&!o&&e.indices.push(new Be({name:this.connection.namingStrategy.uniqueConstraintName(e,[s.name]),columnNames:[s.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(s=>{e.indices.some(o=>o.name===s.name)||e.indices.push(new Be({name:s.name,columnNames:s.columnNames,isUnique:!0}))}),e.checks.length>0){const s=e.checks.map(a=>`CONSTRAINT \`${a.name?a.name:this.connection.namingStrategy.checkConstraintName(e,a.expression)}\` CHECK (${a.expression})`).join(", ");r+=`, ${s}`}if(e.foreignKeys.length>0&&t){const s=e.foreignKeys.map(a=>{const o=a.columnNames.map(u=>`\`${u}\``).join(", ");a.name||(a.name=this.connection.namingStrategy.foreignKeyName(e,a.columnNames,this.getTablePath(a),a.referencedColumnNames));const c=a.referencedColumnNames.map(u=>`\`${u}\``).join(", ");return`CONSTRAINT \`${a.name}\` FOREIGN KEY (${o}) REFERENCES ${this.escapePath(this.getTablePath(a))} (${c})`}).join(", ");r+=`, ${s}`}r+=")";const i=e.columns.filter(s=>s.isPrimary);if(i.length>0){const s=i.map(a=>this.driver.escape(a.name)).join(", ");r+=` PRIMARY KEY (${s})`}return new R(r)}dropTableSql(e){return new R(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){const t=e.materialized?"MATERIALIZED ":"",n=this.escapePath(e),r=typeof e.expression=="string"?e.expression:e.expression(this.connection).getQuery();return new R(`CREATE ${t}VIEW ${n} SQL SECURITY INVOKER AS ${r}`)}async insertViewDefinitionSql(e){const{schema:t,tableName:n}=this.driver.parseTableName(e),r=e.materialized?de.MATERIALIZED_VIEW:de.VIEW,i=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:r,schema:t,name:n,value:i})}dropViewSql(e){const t=e.materialized?"MATERIALIZED ":"";return new R(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const{schema:t,tableName:n}=this.driver.parseTableName(e),r=e.materialized?de.MATERIALIZED_VIEW:de.VIEW;return this.deleteTypeormMetadataSql({type:r,schema:t,name:n})}createIndexSql(e,t){const n=t.columnNames.map(i=>this.driver.escape(i)).join(", ");let r="";return t.isUnique&&(r+="UNIQUE "),t.isNullFiltered&&(r+="NULL_FILTERED "),new R(`CREATE ${r}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${n})`)}dropIndexSql(e,t){const n=t instanceof Be?t.name:t;return new R(`DROP INDEX \`${n}\``)}createCheckConstraintSql(e,t){return new R(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){const n=t instanceof it?t.name:t;return new R(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${n}\``)}createForeignKeySql(e,t){const n=t.columnNames.map(s=>this.driver.escape(s)).join(", "),r=t.referencedColumnNames.map(s=>this.driver.escape(s)).join(","),i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))} (${r})`;return new R(i)}dropForeignKeySql(e,t){const n=t instanceof Je?t.name:t;return new R(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${n}\``)}escapePath(e){const{tableName:t}=this.driver.parseTableName(e);return`\`${t}\``}buildCreateColumnSql(e){let t=`${this.driver.escape(e.name)} ${this.connection.driver.createFullType(e)}`;return e.generatedType==="STORED"&&e.asExpression?t+=` AS (${e.asExpression}) STORED`:e.isNullable||(t+=" NOT NULL"),t}async executeQueries(e,t){if(e instanceof R&&(e=[e]),t instanceof R&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(const{query:n,parameters:r}of e)this.isDMLQuery(n)?await this.query(n,r):await this.updateDDL(n,r)}isDMLQuery(e){return e.startsWith("INSERT")||e.startsWith("UPDATE")||e.startsWith("DELETE")}changeTableComment(e,t){throw new M("spanner driver does not support change table comment.")}}class Lc{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="none",this.supportedDataTypes=["bool","int64","float64","numeric","string","json","bytes","date","timestamp","array"],this.supportedUpsertTypes=[],this.spatialTypes=[],this.withLengthColumnTypes=["string","bytes"],this.withPrecisionColumnTypes=[],this.withScaleColumnTypes=[],this.mappedDataTypes={createDate:"timestamp",createDateDefault:"",updateDate:"timestamp",updateDateDefault:"",deleteDate:"timestamp",deleteDateNullable:!0,version:"int64",treeLevel:"int64",migrationId:"int64",migrationName:"string",migrationTimestamp:"int64",cacheId:"string",cacheIdentifier:"string",cacheTime:"int64",cacheDuration:"int64",cacheQuery:"string",cacheResult:"string",metadataType:"string",metadataDatabase:"string",metadataSchema:"string",metadataTable:"string",metadataName:"string",metadataValue:"string"},this.parametersPrefix="@param",this.dataTypeDefaults={},this.maxAliasLength=63,this.cteCapabilities={enabled:!0},this.connection=e,this.options=e.options,this.isReplicated=!!this.options.replication,this.loadDependencies()}async connect(){this.instance=this.spanner.instance(this.options.instanceId),this.instanceDatabase=this.instance.database(this.options.databaseId)}afterConnect(){return Promise.resolve()}async disconnect(){this.instanceDatabase.close()}createSchemaBuilder(){return new Zt(this.connection)}createQueryRunner(e){return new _c(this,e)}escapeQueryWithParameters(e,t,n){const r=Object.keys(n).map(s=>n[s]);if(!t||!Object.keys(t).length)return[e,r];const i=new Map;return e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(s,a,o)=>{if(!t.hasOwnProperty(o))return s;if(i.has(o))return this.parametersPrefix+i.get(o);const c=t[o];return c===null?s:a?c.map(u=>(r.push(u),this.createParameter(o,r.length-1))).join(", "):c instanceof Function?c():(r.push(c),i.set(o,r.length-1),this.createParameter(o,r.length-1))}),e=e.replace(/([ ]+)?=([ ]+)?:(\.\.\.)?([A-Za-z0-9_.]+)/g,(s,a,o,c,u)=>t.hasOwnProperty(u)&&t[u]===null?" IS NULL":s),[e,r]}escape(e){return`\`${e}\``}buildTableName(e,t,n){const r=[e];return n&&r.unshift(n),r.join(".")}parseTableName(e){const t=this.database,n=void 0;if(e instanceof $e||e instanceof ht){const i=this.parseTableName(e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if(e instanceof Je){const i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if(e instanceof st)return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const r=e.split(".");return{database:(r.length>1?r[0]:void 0)||t,schema:n,tableName:r.length>1?r[1]:r[0]}}preparePersistentValue(e,t){return t.transformer&&(e=ke.transformTo(t.transformer,e)),e==null?e:t.type==="numeric"?(this.options.driver||ve.load("spanner")).Spanner.numeric(e.toString()):t.type==="date"?he.mixedDateToDateString(e):t.type==="json"?e:t.type==="timestamp"||t.type===Date?he.mixedDateToDate(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?ke.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="bool"?e=!!e:t.type==="timestamp"||t.type===Date?e=new Date(e):t.type==="numeric"?e=e.value:t.type==="date"?e=he.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=ke.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number?"int64":e.type===String||e.type==="uuid"?"string":e.type===Date?"timestamp":e.type===Buffer?"bytes":e.type===Boolean?"bool":e.type||""}normalizeDefault(e){return e.default===""?`"${e.default}"`:`${e.default}`}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"string":case"bytes":return"max";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t=`array<${t}>`),t}obtainMasterConnection(){return this.instanceDatabase}obtainSlaveConnection(){return this.instanceDatabase}createGeneratedMap(e,t,n){if(!t)return;if(t.insertId===void 0)return Object.keys(t).reduce((i,s)=>{const a=e.findColumnWithDatabaseName(s);return a&&K.mergeDeep(i,a.createValueMap(t[s])),i},{});const r=e.generatedColumns.reduce((i,s)=>{let a;return s.generationStrategy==="increment"&&t.insertId&&(a=t.insertId+n),K.mergeDeep(i,s.createValueMap(a))},{});return Object.keys(r).length>0?r:void 0}findChangedColumns(e,t){return t.filter(n=>{const r=e.find(s=>s.name===n.databaseName);return r?r.name!==n.databaseName||r.type!==this.normalizeType(n)||r.length!==this.getColumnLength(n)||r.asExpression!==n.asExpression||r.generatedType!==n.generatedType||r.isPrimary!==n.isPrimary||!this.compareNullableValues(n,r)||r.isUnique!==this.normalizeIsUnique(n):!1})}isReturningSqlSupported(){return!0}isUUIDGenerationSupported(){return!0}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return this.parametersPrefix+t}loadDependencies(){try{const e=this.options.driver||ve.load("spanner");if(this.options.credentials){this.spanner=new e.Spanner({projectId:this.options.projectId,credentials:this.options.credentials});return}this.spanner=new e.Spanner({projectId:this.options.projectId})}catch(e){throw console.error(e),new bt("Spanner","@google-cloud/spanner")}}compareNullableValues(e,t){return e.generatedType?!0:e.isNullable===t.isNullable}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}normalizeDatetimeFunction(e){if(!e)return e;if(e.toUpperCase().indexOf("CURRENT_TIMESTAMP")!==-1||e.toUpperCase().indexOf("NOW")!==-1){const n=e.match(/\(\d+\)/);return n?`CURRENT_TIMESTAMP${n[0]}`:"CURRENT_TIMESTAMP"}else return e}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}}class Bc{create(e){const{type:t}=e.options;switch(t){case"mysql":return new Ki(e);case"postgres":return new js(e);case"cockroachdb":return new Uo(e);case"sap":return new jo(e);case"mariadb":return new Ki(e);case"sqlite":return new Qo(e);case"better-sqlite3":return new Vo(e);case"cordova":return new mc(e);case"nativescript":return new Tc(e);case"react-native":return new gc(e);case"sqljs":return new wc(e);case"oracle":return new ko(e);case"mssql":return new Fo(e);case"mongodb":return new _o(e);case"expo":return new Rc(e).create();case"aurora-mysql":return new Mc(e);case"aurora-postgres":return new Dc(e);case"capacitor":return new $c(e);case"spanner":return new Lc(e);default:throw new ua(t,["aurora-mysql","aurora-postgres","better-sqlite3","capacitor","cockroachdb","cordova","expo","mariadb","mongodb","mssql","mysql","nativescript","oracle","postgres","react-native","sap","sqlite","sqljs","spanner"])}}}function mr(d,e,t=[".js",".cjs",".ts"]){return[]}const Uc=new class{constructor(){this.instances=[]}get(d){let e=this.instances.find(t=>t.type===d);return e||(e={type:d,object:new d},this.instances.push(e)),e.object}};function is(d){return Uc.get(d)}class Ke{constructor(e){this["@instanceof"]=Symbol.for("ColumnMetadata"),this.length="",this.isPrimary=!1,this.isGenerated=!1,this.isNullable=!1,this.isSelect=!0,this.isInsert=!0,this.isUpdate=!0,this.zerofill=!1,this.unsigned=!1,this.isArray=!1,this.isVirtual=!1,this.isVirtualProperty=!1,this.isDiscriminator=!1,this.isTreeLevel=!1,this.isCreateDate=!1,this.isUpdateDate=!1,this.isDeleteDate=!1,this.isVersion=!1,this.isObjectId=!1,this.isNestedSetLeft=!1,this.isNestedSetRight=!1,this.isMaterializedPath=!1,this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.referencedColumn=e.referencedColumn,e.args.target&&(this.target=e.args.target),e.args.propertyName&&(this.propertyName=e.args.propertyName),e.args.options.name&&(this.givenDatabaseName=e.args.options.name),e.args.options.type&&(this.type=e.args.options.type),e.args.options.length&&(this.length=e.args.options.length?e.args.options.length.toString():""),e.args.options.width&&(this.width=e.args.options.width),e.args.options.charset&&(this.charset=e.args.options.charset),e.args.options.collation&&(this.collation=e.args.options.collation),e.args.options.primary&&(this.isPrimary=e.args.options.primary),e.args.options.default===null&&(this.isNullable=!0),e.args.options.nullable!==void 0&&(this.isNullable=e.args.options.nullable),e.args.options.select!==void 0&&(this.isSelect=e.args.options.select),e.args.options.insert!==void 0&&(this.isInsert=e.args.options.insert),e.args.options.update!==void 0&&(this.isUpdate=e.args.options.update),e.args.options.readonly!==void 0&&(this.isUpdate=!e.args.options.readonly),e.args.options.comment&&(this.comment=e.args.options.comment),e.args.options.default!==void 0&&(this.default=e.args.options.default),e.args.options.onUpdate&&(this.onUpdate=e.args.options.onUpdate),e.args.options.generatedIdentity&&(this.generatedIdentity=e.args.options.generatedIdentity),e.args.options.scale!==null&&e.args.options.scale!==void 0&&(this.scale=e.args.options.scale),e.args.options.zerofill&&(this.zerofill=e.args.options.zerofill,this.unsigned=!0),e.args.options.unsigned&&(this.unsigned=e.args.options.unsigned),e.args.options.precision!==null&&(this.precision=e.args.options.precision),e.args.options.enum&&(me.isObject(e.args.options.enum)&&!Array.isArray(e.args.options.enum)?this.enum=Object.keys(e.args.options.enum).filter(t=>isNaN(+t)&&typeof e.args.options.enum[t]!="function").map(t=>e.args.options.enum[t]):this.enum=e.args.options.enum),e.args.options.enumName&&(this.enumName=e.args.options.enumName),e.args.options.primaryKeyConstraintName&&(this.primaryKeyConstraintName=e.args.options.primaryKeyConstraintName),e.args.options.foreignKeyConstraintName&&(this.foreignKeyConstraintName=e.args.options.foreignKeyConstraintName),e.args.options.asExpression&&(this.asExpression=e.args.options.asExpression,this.generatedType=e.args.options.generatedType?e.args.options.generatedType:"VIRTUAL"),e.args.options.hstoreType&&(this.hstoreType=e.args.options.hstoreType),e.args.options.array&&(this.isArray=e.args.options.array),e.args.mode&&(this.isVirtualProperty=e.args.mode==="virtual-property",this.isVirtual=e.args.mode==="virtual",this.isTreeLevel=e.args.mode==="treeLevel",this.isCreateDate=e.args.mode==="createDate",this.isUpdateDate=e.args.mode==="updateDate",this.isDeleteDate=e.args.mode==="deleteDate",this.isVersion=e.args.mode==="version",this.isObjectId=e.args.mode==="objectId"),this.isVirtualProperty&&(this.isInsert=!1,this.isUpdate=!1),e.args.options.transformer&&(this.transformer=e.args.options.transformer),e.args.options.spatialFeatureType&&(this.spatialFeatureType=e.args.options.spatialFeatureType),e.args.options.srid!==void 0&&(this.srid=e.args.options.srid),e.args.options.query&&(this.query=e.args.options.query),this.isTreeLevel&&(this.type=e.connection.driver.mappedDataTypes.treeLevel),this.isCreateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.createDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.createDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.createDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.createDatePrecision)),this.isUpdateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.updateDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.updateDateDefault),this.onUpdate||(this.onUpdate=e.connection.driver.mappedDataTypes.updateDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.updateDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.updateDatePrecision)),this.isDeleteDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.deleteDate),this.isNullable||(this.isNullable=e.connection.driver.mappedDataTypes.deleteDateNullable),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.deleteDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.deleteDatePrecision)),this.isVersion&&(this.type=e.connection.driver.mappedDataTypes.version),e.closureType&&(this.closureType=e.closureType),e.nestedSetLeft&&(this.isNestedSetLeft=e.nestedSetLeft),e.nestedSetRight&&(this.isNestedSetRight=e.nestedSetRight),e.materializedPath&&(this.isMaterializedPath=e.materializedPath)}createValueMap(e,t=!1){if(this.embeddedMetadata){const n=[...this.embeddedMetadata.parentPropertyNames],r=(i,s)=>{const a=i.shift();return a?(s[a]={},r(i,s[a]),s):((this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),s[t?this.databaseName:this.propertyName]=e,s)};return r(n,{})}else return(this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),{[t?this.databaseName:this.propertyName]:e}}getEntityValueMap(e,t){if(this.embeddedMetadata){const r=[...this.embeddedMetadata.parentPropertyNames],i=this.embeddedMetadata.isArray,s=(o,c)=>{if(c===void 0)return{};const u=o.shift();if(u){const l=s(o,c[u]);return Object.keys(l).length>0?{[u]:l}:{}}return i&&Array.isArray(c)?c.map(l=>({[this.propertyName]:l[this.propertyName]})):c[this.propertyName]!==void 0?{[this.propertyName]:c[this.propertyName]}:{}},a=s(r,e);return Object.keys(a).length>0?a:void 0}else if(this.relationMetadata&&!Object.getOwnPropertyDescriptor(e,this.relationMetadata.propertyName)?.get&&e[this.relationMetadata.propertyName]&&me.isObject(e[this.relationMetadata.propertyName])){if(this.relationMetadata.joinColumns.length>1){const r=this.relationMetadata.joinColumns.reduce((i,s)=>{const a=s.referencedColumn.getEntityValueMap(e[this.relationMetadata.propertyName]);return a===void 0?i:K.mergeDeep(i,a)},{});if(Object.keys(r).length>0)return{[this.propertyName]:r}}else{const r=this.relationMetadata.joinColumns[0].referencedColumn.getEntityValue(e[this.relationMetadata.propertyName]);if(r)return{[this.propertyName]:r}}return}else return e[this.propertyName]!==void 0?{[this.propertyName]:e[this.propertyName]}:void 0}getEntityValue(e,t=!1){if(e==null)return;let n;if(this.embeddedMetadata){const r=[...this.embeddedMetadata.parentPropertyNames],i=this.embeddedMetadata.isArray,s=(o,c)=>{const u=o.shift();return u&&c?s(o,c[u]):c},a=s(r,e);if(a)if(this.relationMetadata&&this.referencedColumn){const o=this.relationMetadata.getEntityValue(a);o&&me.isObject(o)&&!q.isFindOperator(o)&&!Buffer.isBuffer(o)?n=this.referencedColumn.getEntityValue(o):a[this.propertyName]&&me.isObject(a[this.propertyName])&&!q.isFindOperator(a[this.propertyName])&&!Buffer.isBuffer(a[this.propertyName])&&!(a[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(a[this.propertyName]):n=a[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(a[this.propertyName]):i&&Array.isArray(a)?n=a.map(o=>o[this.propertyName]):n=a[this.propertyName]}else if(this.relationMetadata&&this.referencedColumn){const r=this.relationMetadata.getEntityValue(e);r&&me.isObject(r)&&!q.isFindOperator(r)&&typeof r!="function"&&!Buffer.isBuffer(r)?n=this.referencedColumn.getEntityValue(r):e[this.propertyName]&&me.isObject(e[this.propertyName])&&!q.isFindOperator(e[this.propertyName])&&typeof e[this.propertyName]!="function"&&!Buffer.isBuffer(e[this.propertyName])&&!(e[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName];return t&&this.transformer&&(n=ke.transformTo(this.transformer,n)),n}setEntityValue(e,t){if(this.embeddedMetadata){const n=(r,i)=>{const s=r.shift();return s?(i[s.propertyName]||(i[s.propertyName]=s.create()),n(r,i[s.propertyName]),i):(i[this.propertyName]=t,i)};return n([...this.embeddedMetadata.embeddedMetadataTree],e)}else!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName?(this.propertyName in e||(e[this.propertyName]={}),e[this.propertyName][this.referencedColumn.propertyName]=t):e[this.propertyName]=t}compareEntityValue(e,t){const n=this.getEntityValue(e);return typeof n?.equals=="function"?n.equals(t):n===t}build(e){return this.propertyPath=this.buildPropertyPath(),this.propertyAliasName=this.propertyPath.replace(".","_"),this.databaseName=this.buildDatabaseName(e),this.databasePath=this.buildDatabasePath(),this.databaseNameWithoutPrefixes=e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,[]),this}buildPropertyPath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.propertyName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName&&(e+="."+this.referencedColumn.propertyName),e}buildDatabasePath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.databaseName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.databaseName!==this.databaseName&&(e+="."+this.referencedColumn.databaseName),e}buildDatabaseName(e){let t=this.embeddedMetadata?this.embeddedMetadata.parentPrefixes:[];return e.driver.options.type==="mongodb"&&(t=[]),e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,t)}}class tt{constructor(e){this.isUnique=!1,this.isSpatial=!1,this.isFulltext=!1,this.isNullFiltered=!1,this.synchronize=!0,this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,e.args.synchronize!==null&&e.args.synchronize!==void 0&&(this.synchronize=e.args.synchronize),this.isUnique=!!e.args.unique,this.isSpatial=!!e.args.spatial,this.isFulltext=!!e.args.fulltext,this.isNullFiltered=!!e.args.nullFiltered,this.parser=e.args.parser,this.where=e.args.where,this.isSparse=e.args.sparse,this.isBackground=e.args.background,this.isConcurrent=e.args.concurrent,this.expireAfterSeconds=e.args.expireAfterSeconds,this.givenName=e.args.name,this.givenColumnNames=e.args.columns)}build(e){if(this.synchronize===!1)return this.name=this.givenName,this;const t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(r=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+r:r.trim()),n.forEach(r=>t[r]=1);else{const r=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(r)?(n=r.map(i=>String(i)),n.forEach(i=>t[i]=1)):(n=Object.keys(r).map(i=>String(i)),Object.keys(r).forEach(i=>t[i]=r[i]))}this.columns=n.map(r=>{const i=this.entityMetadata.columns.find(c=>c.propertyPath===r);if(i)return[i];const s=this.entityMetadata.relations.find(c=>c.isWithJoinColumn&&c.propertyName===r);if(s)return s.joinColumns;const a=this.givenName?'"'+this.givenName+'" ':"",o=this.entityMetadata.targetName;throw new M(`Index ${a}contains column that is missing in the entity (${o}): `+r)}).reduce((r,i)=>r.concat(i))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,r)=>{const i=this.entityMetadata.columns.find(s=>s.propertyPath===r);return i&&(n[i.databasePath]=t[r]),n},{}),this.name=this.givenName?this.givenName:e.indexName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName),this.where),this}}class ss{constructor(e){this.isTreeParent=!1,this.isTreeChildren=!1,this.isPrimary=!1,this.isLazy=!1,this.isEager=!1,this.persistenceEnabled=!0,this.isCascadeInsert=!1,this.isCascadeUpdate=!1,this.isCascadeRemove=!1,this.isCascadeSoftRemove=!1,this.isCascadeRecover=!1,this.isNullable=!0,this.createForeignKeyConstraints=!0,this.isOwning=!1,this.isOneToOne=!1,this.isOneToOneOwner=!1,this.isWithJoinColumn=!1,this.isOneToOneNotOwner=!1,this.isOneToMany=!1,this.isManyToOne=!1,this.isManyToMany=!1,this.isManyToManyOwner=!1,this.isManyToManyNotOwner=!1,this.foreignKeys=[],this.joinColumns=[],this.inverseJoinColumns=[],this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata;const t=e.args;this.target=t.target,this.propertyName=t.propertyName,this.relationType=t.relationType,t.inverseSideProperty&&(this.givenInverseSidePropertyFactory=t.inverseSideProperty),this.isLazy=t.isLazy||!1,this.isCascadeInsert=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("insert")!==-1,this.isCascadeUpdate=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("update")!==-1,this.isCascadeRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("remove")!==-1,this.isCascadeSoftRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("soft-remove")!==-1,this.isCascadeRecover=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("recover")!==-1,this.isNullable=!(t.options.nullable===!1||this.isPrimary),this.onDelete=t.options.onDelete,this.onUpdate=t.options.onUpdate,this.deferrable=t.options.deferrable,this.createForeignKeyConstraints=t.options.createForeignKeyConstraints!==!1,this.isEager=t.options.eager||!1,this.persistenceEnabled=t.options.persistence!==!1,this.orphanedRowAction=t.options.orphanedRowAction||"nullify",this.isTreeParent=t.isTreeParent||!1,this.isTreeChildren=t.isTreeChildren||!1,typeof t.type=="function"?this.type=typeof t.type=="function"?t.type():t.type:q.isEntitySchema(t.type)?this.type=t.type.options.name:me.isObject(t.type)&&typeof t.type.name=="string"?this.type=t.type.name:this.type=t.type,this.isOneToOne=this.relationType==="one-to-one",this.isOneToMany=this.relationType==="one-to-many",this.isManyToOne=this.relationType==="many-to-one",this.isManyToMany=this.relationType==="many-to-many",this.isOneToOneNotOwner=!!this.isOneToOne,this.isManyToManyNotOwner=!!this.isManyToMany}getRelationIdMap(e){const n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(r=>r.referencedColumn);return st.getValueMap(e,n)}ensureRelationIdMap(e){if(me.isObject(e))return e;const n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(r=>r.referencedColumn);if(n.length>1)throw new M("Cannot create relation id map for a single value because relation contains multiple referenced columns.");return n[0].createValueMap(e)}getEntityValue(e,t=!1){if(e!=null)if(this.embeddedMetadata){const n=[...this.embeddedMetadata.parentPropertyNames],r=(s,a)=>{const o=s.shift();return o?a[o]?r(s,a[o]):void 0:a},i=r(n,e);return this.isLazy?i["__"+this.propertyName+"__"]!==void 0?i["__"+this.propertyName+"__"]:t===!0?i[this.propertyName]:void 0:i?i[this.isLazy?"__"+this.propertyName+"__":this.propertyName]:void 0}else return this.isLazy?e["__"+this.propertyName+"__"]!==void 0?e["__"+this.propertyName+"__"]:t===!0?e[this.propertyName]:void 0:e[this.propertyName]}setEntityValue(e,t){const n=this.isLazy?"__"+this.propertyName+"__":this.propertyName;if(this.embeddedMetadata){const r=(i,s)=>{const a=i.shift();return a?(s[a.propertyName]||(s[a.propertyName]=a.create()),r(i,s[a.propertyName]),s):(s[n]=t,s)};return r([...this.embeddedMetadata.embeddedMetadataTree],e)}else e[n]=t}createValueMap(e){if(this.embeddedMetadata){const t=[...this.embeddedMetadata.parentPropertyNames],n=(r,i)=>{const s=r.shift();return s?(i[s]={},n(r,i[s]),i):(i[this.propertyName]=e,i)};return n(t,{})}else return{[this.propertyName]:e}}build(){this.propertyPath=this.buildPropertyPath()}registerForeignKeys(...e){this.foreignKeys.push(...e)}registerJoinColumns(e=[],t=[]){this.joinColumns=e,this.inverseJoinColumns=t,this.isOwning=this.isManyToOne||(this.isManyToMany||this.isOneToOne)&&this.joinColumns.length>0,this.isOneToOneOwner=this.isOneToOne&&this.isOwning,this.isOneToOneNotOwner=this.isOneToOne&&!this.isOwning,this.isManyToManyOwner=this.isManyToMany&&this.isOwning,this.isManyToManyNotOwner=this.isManyToMany&&!this.isOwning,this.isWithJoinColumn=this.isManyToOne||this.isOneToOneOwner}registerJunctionEntityMetadata(e){this.junctionEntityMetadata=e,this.joinTableName=e.tableName,this.inverseRelation&&(this.inverseRelation.junctionEntityMetadata=e,this.joinTableName=e.tableName)}buildInverseSidePropertyPath(){if(this.givenInverseSidePropertyFactory){const e=this.inverseEntityMetadata.propertiesMap;if(typeof this.givenInverseSidePropertyFactory=="function")return this.givenInverseSidePropertyFactory(e);if(typeof this.givenInverseSidePropertyFactory=="string")return this.givenInverseSidePropertyFactory}else{if(this.isTreeParent&&this.entityMetadata.treeChildrenRelation)return this.entityMetadata.treeChildrenRelation.propertyName;if(this.isTreeChildren&&this.entityMetadata.treeParentRelation)return this.entityMetadata.treeParentRelation.propertyName}return""}buildPropertyPath(){return!this.embeddedMetadata||!this.embeddedMetadata.parentPropertyNames.length?this.propertyName:this.embeddedMetadata.parentPropertyNames.join(".")+"."+this.propertyName}}class Fc{constructor(e){this.columns=[],this.relations=[],this.listeners=[],this.indices=[],this.uniques=[],this.relationIds=[],this.relationCounts=[],this.embeddeds=[],this.isAlwaysUsingConstructor=!0,this.isArray=!1,this.parentPropertyNames=[],this.parentPrefixes=[],this.embeddedMetadataTree=[],this.columnsFromTree=[],this.relationsFromTree=[],this.listenersFromTree=[],this.indicesFromTree=[],this.uniquesFromTree=[],this.relationIdsFromTree=[],this.relationCountsFromTree=[],this.entityMetadata=e.entityMetadata,this.type=e.args.type(),this.propertyName=e.args.propertyName,this.customPrefix=e.args.prefix,this.isArray=e.args.isArray}create(e){return typeof this.type!="function"?{}:e?.fromDeserializer||!this.isAlwaysUsingConstructor?Object.create(this.type.prototype):new this.type}build(e){return this.embeddeds.forEach(t=>t.build(e)),this.prefix=this.buildPrefix(e),this.parentPropertyNames=this.buildParentPropertyNames(),this.parentPrefixes=this.buildParentPrefixes(),this.propertyPath=this.parentPropertyNames.join("."),this.embeddedMetadataTree=this.buildEmbeddedMetadataTree(),this.columnsFromTree=this.buildColumnsFromTree(),this.relationsFromTree=this.buildRelationsFromTree(),this.listenersFromTree=this.buildListenersFromTree(),this.indicesFromTree=this.buildIndicesFromTree(),this.uniquesFromTree=this.buildUniquesFromTree(),this.relationIdsFromTree=this.buildRelationIdsFromTree(),this.relationCountsFromTree=this.buildRelationCountsFromTree(),e.options.entitySkipConstructor&&(this.isAlwaysUsingConstructor=!e.options.entitySkipConstructor),this}buildPartialPrefix(){if(this.customPrefix===void 0||this.customPrefix===!0)return[this.propertyName];if(this.customPrefix===""||this.customPrefix===!1)return[];if(typeof this.customPrefix=="string")return[this.customPrefix];throw new M(`Invalid prefix option given for ${this.entityMetadata.targetName}#${this.propertyName}`)}buildPrefix(e){if(e.driver.options.type==="mongodb")return this.propertyName;const t=[];return this.parentEmbeddedMetadata&&t.push(this.parentEmbeddedMetadata.buildPrefix(e)),t.push(...this.buildPartialPrefix()),t.join("_")}buildParentPropertyNames(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPropertyNames().concat(this.propertyName):[this.propertyName]}buildParentPrefixes(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPrefixes().concat(this.buildPartialPrefix()):this.buildPartialPrefix()}buildEmbeddedMetadataTree(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildEmbeddedMetadataTree().concat(this):[this]}buildColumnsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildColumnsFromTree()),this.columns)}buildRelationsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationsFromTree()),this.relations)}buildListenersFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildListenersFromTree()),this.listeners)}buildIndicesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildIndicesFromTree()),this.indices)}buildUniquesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildUniquesFromTree()),this.uniques)}buildRelationIdsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationIdsFromTree()),this.relationIds)}buildRelationCountsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationCountsFromTree()),this.relationCounts)}}class as{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}setValue(e){const t=this.relation.getEntityValue(e);if(Array.isArray(t))e[this.propertyName]=t.map(n=>this.relation.inverseEntityMetadata.getEntityIdMixedMap(n)).filter(n=>n!=null);else{const n=this.relation.inverseEntityMetadata.getEntityIdMixedMap(t);n!==void 0&&(e[this.propertyName]=n)}}build(){const e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new M(`Cannot find relation ${e}. Wrong relation specified for @RelationId decorator.`);this.relation=t}}class os{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}build(){const e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new M(`Cannot find relation ${e}. Wrong relation specified for @RelationCount decorator.`);this.relation=t}}class _e{}_e.AFTER_LOAD="after-load";_e.BEFORE_INSERT="before-insert";_e.AFTER_INSERT="after-insert";_e.BEFORE_UPDATE="before-update";_e.AFTER_UPDATE="after-update";_e.BEFORE_REMOVE="before-remove";_e.AFTER_REMOVE="after-remove";_e.BEFORE_SOFT_REMOVE="before-soft-remove";_e.AFTER_SOFT_REMOVE="after-soft-remove";_e.BEFORE_RECOVER="before-recover";_e.AFTER_RECOVER="after-recover";class Tt{constructor(e){this.columns=[],this.referencedColumns=[],this.columnNames=[],this.referencedColumnNames=[],this.entityMetadata=e.entityMetadata,this.referencedEntityMetadata=e.referencedEntityMetadata,this.columns=e.columns,this.referencedColumns=e.referencedColumns,this.onDelete=e.onDelete||"NO ACTION",this.onUpdate=e.onUpdate||"NO ACTION",this.deferrable=e.deferrable,this.givenName=e.name,e.namingStrategy&&this.build(e.namingStrategy)}build(e){this.columnNames=this.columns.map(t=>t.databaseName),this.referencedColumnNames=this.referencedColumns.map(t=>t.databaseName),this.referencedTablePath=this.referencedEntityMetadata.tablePath,this.name=this.givenName?this.givenName:e.foreignKeyName(this.entityMetadata.tableName,this.columnNames,this.referencedEntityMetadata.tableName,this.referencedColumnNames)}}class jc{constructor(e){this.connection=e}build(e,t){const n=this.collectReferencedColumns(e,t),r=this.collectInverseReferencedColumns(e,t),i=t.name||this.connection.namingStrategy.joinTableName(e.entityMetadata.tableNameWithoutPrefix,e.inverseEntityMetadata.tableNameWithoutPrefix,e.propertyPath,e.inverseRelation?e.inverseRelation.propertyName:""),s=new st({connection:this.connection,args:{target:"",name:i,type:"junction",database:t.database||e.entityMetadata.database,schema:t.schema||e.entityMetadata.schema,synchronize:t.synchronize}});s.build();const a=n.map(c=>{const u=t.joinColumns?t.joinColumns.find(h=>(!h.referencedColumnName||h.referencedColumnName===c.propertyName)&&!!h.name):void 0,l=u&&u.name?u.name:this.connection.namingStrategy.joinTableColumnName(e.entityMetadata.tableNameWithoutPrefix,c.propertyName,c.databaseName);return new Ke({connection:this.connection,entityMetadata:s,referencedColumn:c,args:{target:"",mode:"virtual",propertyName:l,options:{name:l,length:!c.length&&(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(c)!=="uuid"&&(c.generationStrategy==="uuid"||c.type==="uuid")?"36":c.length,width:c.width,type:c.type,precision:c.precision,scale:c.scale,charset:c.charset,collation:c.collation,zerofill:c.zerofill,unsigned:c.zerofill?!0:c.unsigned,enum:c.enum,enumName:c.enumName,foreignKeyConstraintName:u?.foreignKeyConstraintName,nullable:!1,primary:!0}}})}),o=r.map(c=>{const u=t.inverseJoinColumns?t.inverseJoinColumns.find(h=>(!h.referencedColumnName||h.referencedColumnName===c.propertyName)&&!!h.name):void 0,l=u&&u.name?u.name:this.connection.namingStrategy.joinTableInverseColumnName(e.inverseEntityMetadata.tableNameWithoutPrefix,c.propertyName,c.databaseName);return new Ke({connection:this.connection,entityMetadata:s,referencedColumn:c,args:{target:"",mode:"virtual",propertyName:l,options:{length:!c.length&&(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(c)!=="uuid"&&(c.generationStrategy==="uuid"||c.type==="uuid")?"36":c.length,width:c.width,type:c.type,precision:c.precision,scale:c.scale,charset:c.charset,collation:c.collation,zerofill:c.zerofill,unsigned:c.zerofill?!0:c.unsigned,enum:c.enum,enumName:c.enumName,foreignKeyConstraintName:u?.foreignKeyConstraintName,name:l,nullable:!1,primary:!0}}})});return this.changeDuplicatedColumnNames(a,o),s.ownerColumns=a,s.inverseColumns=o,s.ownColumns=[...a,...o],s.ownColumns.forEach(c=>c.relationMetadata=e),s.foreignKeys=e.createForeignKeyConstraints?[new Tt({entityMetadata:s,referencedEntityMetadata:e.entityMetadata,columns:a,referencedColumns:n,name:a[0]?.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.onDelete||"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.onUpdate||"CASCADE"}),new Tt({entityMetadata:s,referencedEntityMetadata:e.inverseEntityMetadata,columns:o,referencedColumns:r,name:o[0]?.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onDelete:"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onUpdate:"CASCADE"})]:[],s.ownIndices=[new tt({entityMetadata:s,columns:a,args:{target:s.target,synchronize:!0}}),new tt({entityMetadata:s,columns:o,args:{target:s.target,synchronize:!0}})],s}collectReferencedColumns(e,t){const n=t.joinColumns?t.joinColumns.find(r=>!!r.referencedColumnName):!1;return!t.joinColumns||t.joinColumns&&!n?e.entityMetadata.columns.filter(r=>r.isPrimary):t.joinColumns.map(r=>{const i=e.entityMetadata.columns.find(s=>s.propertyName===r.referencedColumnName);if(!i)throw new M(`Referenced column ${r.referencedColumnName} was not found in entity ${e.entityMetadata.name}`);return i})}collectInverseReferencedColumns(e,t){const n=!!t.inverseJoinColumns,r=n?t.inverseJoinColumns.find(i=>!!i.referencedColumnName):!1;return!n||n&&!r?e.inverseEntityMetadata.primaryColumns:t.inverseJoinColumns.map(i=>{const s=e.inverseEntityMetadata.ownColumns.find(a=>a.propertyName===i.referencedColumnName);if(!s)throw new M(`Referenced column ${i.referencedColumnName} was not found in entity ${e.inverseEntityMetadata.name}`);return s})}changeDuplicatedColumnNames(e,t){e.forEach(n=>{t.forEach(r=>{if(n.givenDatabaseName===r.givenDatabaseName){const i=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(n.propertyName,1);n.propertyName=i,n.givenDatabaseName=i;const s=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(r.propertyName,2);r.propertyName=s,r.givenDatabaseName=s}})})}}class kc{constructor(e){this.connection=e}build(e){const t=new st({parentClosureEntityMetadata:e,connection:this.connection,args:{target:"",name:e.treeOptions&&e.treeOptions.closureTableName?e.treeOptions.closureTableName:e.tableNameWithoutPrefix,type:"closure-junction"}});return t.build(),e.primaryColumns.forEach(n=>{t.ownColumns.push(new Ke({connection:this.connection,entityMetadata:t,closureType:"ancestor",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.ancestorColumnName?e.treeOptions.ancestorColumnName(n):n.propertyName+"_ancestor",options:{primary:!0,length:n.length,type:n.type,unsigned:n.unsigned,width:n.width,precision:n.precision,scale:n.scale,zerofill:n.zerofill,charset:n.charset,collation:n.collation}}})),t.ownColumns.push(new Ke({connection:this.connection,entityMetadata:t,closureType:"descendant",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.descendantColumnName?e.treeOptions.descendantColumnName(n):n.propertyName+"_descendant",options:{primary:!0,length:n.length,type:n.type,unsigned:n.unsigned,width:n.width,precision:n.precision,scale:n.scale,zerofill:n.zerofill,charset:n.charset,collation:n.collation}}}))}),t.ownIndices=[new tt({entityMetadata:t,columns:[t.ownColumns[0]],args:{target:t.target,synchronize:!0}}),new tt({entityMetadata:t,columns:[t.ownColumns[1]],args:{target:t.target,synchronize:!0}})],e.treeLevelColumn&&t.ownColumns.push(new Ke({connection:this.connection,entityMetadata:t,args:{target:"",mode:"virtual",propertyName:"level",options:{type:this.connection.driver.mappedDataTypes.treeLevel}}})),t.foreignKeys=[new Tt({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[0]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"}),new Tt({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[1]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"})],t}}class Vt{constructor(e){this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,this.givenName=e.args.name,this.givenColumnNames=e.args.columns,this.deferrable=e.args.deferrable)}build(e){const t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(r=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+r:r.trim()),n.forEach(r=>t[r]=1);else{const r=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(r)?(n=r.map(i=>String(i)),n.forEach(i=>t[i]=1)):(n=Object.keys(r).map(i=>String(i)),Object.keys(r).forEach(i=>t[i]=r[i]))}this.columns=n.map(r=>{const i=this.entityMetadata.columns.find(c=>c.propertyPath===r);if(i)return[i];const s=this.entityMetadata.relations.find(c=>c.isWithJoinColumn&&c.propertyName===r);if(s)return s.joinColumns;const a=this.givenName?'"'+this.givenName+'" ':"",o=this.entityMetadata.targetName;throw new M(`Unique constraint ${a}contains column that is missing in the entity (${o}): `+r)}).reduce((r,i)=>r.concat(i))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,r)=>{const i=this.entityMetadata.columns.find(s=>s.propertyPath===r);return i&&(n[i.databasePath]=t[r]),n},{}),this.name=this.givenName?this.givenName:e.uniqueConstraintName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName)),this}}class Qc{constructor(e){this.connection=e}build(e,t){const n=this.collectReferencedColumns(e,t),r=this.collectColumns(e,t,n);if(!n.length||!t.createForeignKeyConstraints)return{foreignKey:void 0,columns:r,uniqueConstraint:void 0};const i=new Tt({name:e[0]?.foreignKeyConstraintName,entityMetadata:t.entityMetadata,referencedEntityMetadata:t.inverseEntityMetadata,namingStrategy:this.connection.namingStrategy,columns:r,referencedColumns:n,onDelete:t.onDelete,onUpdate:t.onUpdate,deferrable:t.deferrable});if(r.every(a=>a.isPrimary)||!t.isOneToOne)return{foreignKey:i,columns:r,uniqueConstraint:void 0};const s=new Vt({entityMetadata:t.entityMetadata,columns:i.columns,args:{name:this.connection.namingStrategy.relationConstraintName(t.entityMetadata.tableName,i.columns.map(a=>a.databaseName)),target:t.entityMetadata.target}});return s.build(this.connection.namingStrategy),{foreignKey:i,columns:r,uniqueConstraint:s}}collectReferencedColumns(e,t){const n=e.find(s=>!!s.referencedColumnName),r=e.length===0&&t.isManyToOne,i=e.length>0&&!n;return r||i?t.inverseEntityMetadata.primaryColumns:e.map(s=>{const a=t.inverseEntityMetadata.ownColumns.find(o=>o.propertyName===s.referencedColumnName);if(!a)throw new M(`Referenced column ${s.referencedColumnName} was not found in entity ${t.inverseEntityMetadata.name}`);return a})}collectColumns(e,t,n){return n.map(r=>{const i=e.find(c=>(!c.referencedColumnName||c.referencedColumnName===r.propertyName)&&!!c.name),s=i?i.name:this.connection.namingStrategy.joinColumnName(t.propertyName,r.propertyName);let o=(t.embeddedMetadata?t.embeddedMetadata.columns:t.entityMetadata.ownColumns).find(c=>c.databaseNameWithoutPrefixes===s);return o?o.referencedColumn&&(o=K.cloneObject(o)):(o=new Ke({connection:this.connection,entityMetadata:t.entityMetadata,embeddedMetadata:t.embeddedMetadata,args:{target:"",mode:"virtual",propertyName:t.propertyName,options:{name:s,type:r.type,length:!r.length&&(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(r)!=="uuid"&&(r.generationStrategy==="uuid"||r.type==="uuid")?"36":r.length,width:r.width,charset:r.charset,collation:r.collation,precision:r.precision,scale:r.scale,zerofill:r.zerofill,unsigned:r.unsigned,comment:r.comment,enum:r.enum,enumName:r.enumName,primary:t.isPrimary,nullable:t.isNullable}}}),t.entityMetadata.registerColumn(o)),o.referencedColumn=r,o.type=r.type,o.relationMetadata=t,o.build(this.connection),o})}}class cs{constructor(e){this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.type=e.args.type}isAllowed(e){return this.entityMetadata.target===e.constructor||typeof this.entityMetadata.target=="function"&&e.constructor.prototype instanceof this.entityMetadata.target}execute(e){if(!this.embeddedMetadata){const t=e[this.propertyName];if(!t)throw new Error(`Entity listener method "${this.propertyName}" does not exist in entity "${e.constructor.name}".`);if(typeof t!="function")throw new Error(`Entity listener method "${this.propertyName}" in entity "${e.constructor.name}" must be a function but got "${typeof t}".`);return t.call(e)}this.callEntityEmbeddedMethod(e,this.embeddedMetadata.propertyPath.split("."))}callEntityEmbeddedMethod(e,t){const n=t.shift();!n||!e[n]||(t.length===0?Array.isArray(e[n])?e[n].map(r=>r[this.propertyName]()):e[n][this.propertyName]():e[n]&&this.callEntityEmbeddedMethod(e[n],t))}}class Vc{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.checkConstraintName(this.entityMetadata.tableName,this.expression),this}}class Wc{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.exclusionConstraintName(this.entityMetadata.tableName,this.expression),this}}class us{constructor(e,t){this.connection=e,this.metadataArgsStorage=t,this.junctionEntityMetadataBuilder=new jc(e),this.closureJunctionEntityMetadataBuilder=new kc(e),this.relationJoinColumnBuilder=new Qc(e)}build(e){const r=(e?this.metadataArgsStorage.filterTables(e):this.metadataArgsStorage.tables).filter(i=>i.type==="regular"||i.type==="closure"||i.type==="entity-child"||i.type==="view").map(i=>this.createEntityMetadata(i));return r.forEach(i=>this.computeParentEntityMetadata(r,i)),r.forEach(i=>{i.childEntityMetadatas=r.filter(s=>typeof i.target=="function"&&typeof s.target=="function"&&jt.isInherited(s.target,i.target))}),r.filter(i=>i.tableType!=="entity-child").forEach(i=>i.build()),r.filter(i=>i.tableType==="entity-child").forEach(i=>i.build()),r.filter(i=>i.tableType!=="entity-child").forEach(i=>this.computeEntityMetadataStep1(r,i)),r.filter(i=>i.tableType==="entity-child").forEach(i=>this.computeEntityMetadataStep1(r,i)),r.forEach(i=>this.computeEntityMetadataStep2(i)),r.forEach(i=>this.computeInverseProperties(i,r)),r.filter(i=>i.tableType!=="entity-child").forEach(i=>{i.relations.filter(s=>s.isOneToOne||s.isManyToOne).forEach(s=>{const a=this.metadataArgsStorage.filterJoinColumns(s.target,s.propertyName),{foreignKey:o,columns:c,uniqueConstraint:u}=this.relationJoinColumnBuilder.build(a,s);if(o&&(s.registerForeignKeys(o),i.foreignKeys.push(o)),c&&s.registerJoinColumns(c),u)if(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){const l=new tt({entityMetadata:u.entityMetadata,columns:u.columns,args:{target:u.target,name:u.name,unique:!0,synchronize:!0}});this.connection.driver.options.type==="mssql"&&(l.where=l.columns.map(h=>`${this.connection.driver.escape(h.databaseName)} IS NOT NULL`).join(" AND ")),this.connection.driver.options.type==="spanner"&&(l.isNullFiltered=!0),s.embeddedMetadata?s.embeddedMetadata.indices.push(l):s.entityMetadata.ownIndices.push(l),this.computeEntityMetadataStep2(i)}else s.embeddedMetadata?s.embeddedMetadata.uniques.push(u):s.entityMetadata.ownUniques.push(u),this.computeEntityMetadataStep2(i);if(o&&this.connection.driver.options.type==="cockroachdb"){const l=new tt({entityMetadata:s.entityMetadata,columns:o.columns,args:{target:s.entityMetadata.target,synchronize:!0}});s.embeddedMetadata?s.embeddedMetadata.indices.push(l):s.entityMetadata.ownIndices.push(l),this.computeEntityMetadataStep2(i)}}),i.relations.filter(s=>s.isManyToMany).forEach(s=>{const a=this.metadataArgsStorage.findJoinTable(s.target,s.propertyName);if(!a)return;const o=this.junctionEntityMetadataBuilder.build(s,a);s.registerForeignKeys(...o.foreignKeys),s.registerJoinColumns(o.ownIndices[0].columns,o.ownIndices[1].columns),s.registerJunctionEntityMetadata(o),this.computeEntityMetadataStep2(o),this.computeInverseProperties(o,r),r.push(o)})}),r.forEach(i=>{i.relationsWithJoinColumns=i.relations.filter(s=>s.isWithJoinColumn),i.hasNonNullableRelations=i.relationsWithJoinColumns.some(s=>!s.isNullable||s.isPrimary)}),r.filter(i=>i.treeType==="closure-table").forEach(i=>{const s=this.closureJunctionEntityMetadataBuilder.build(i);i.closureJunctionTable=s,this.computeEntityMetadataStep2(s),this.computeInverseProperties(s,r),r.push(s)}),r.filter(i=>i.inheritancePattern==="STI"&&i.discriminatorColumn).forEach(i=>this.createKeysForTableInheritance(i)),r.forEach(i=>{i.indices.forEach(s=>s.build(this.connection.namingStrategy))}),r.forEach(i=>{i.uniques.forEach(s=>s.build(this.connection.namingStrategy))}),r.forEach(i=>{i.checks.forEach(s=>s.build(this.connection.namingStrategy))}),r.forEach(i=>{i.exclusions.forEach(s=>s.build(this.connection.namingStrategy))}),r.forEach(i=>this.createForeignKeys(i,r)),r.filter(i=>typeof i.target=="function").forEach(i=>{i.relations.filter(s=>s.isLazy).forEach(s=>{this.connection.relationLoader.enableLazyLoad(s,i.target.prototype)})}),r.forEach(i=>{i.columns.forEach(s=>{const a=this.metadataArgsStorage.findGenerated(s.target,s.propertyName);a&&(s.isGenerated=!0,s.generationStrategy=a.strategy,a.strategy==="uuid"?s.type="uuid":a.strategy==="rowid"?s.type="int":s.type=s.type||Number,s.build(this.connection),this.computeEntityMetadataStep2(i))})}),r}createEntityMetadata(e){const t=typeof e.target=="function"?jt.getInheritanceTree(e.target):[e.target],n=this.metadataArgsStorage.findInheritanceType(e.target),r=this.metadataArgsStorage.findTree(e.target);let i;return(n&&n.pattern==="STI"||e.type==="entity-child")&&(i=this.metadataArgsStorage.filterSingleTableChildren(e.target).map(s=>s.target).filter(s=>typeof s=="function"),t.push(...i)),new st({connection:this.connection,args:e,inheritanceTree:t,tableTree:r,inheritancePattern:n?n.pattern:void 0})}computeParentEntityMetadata(e,t){t.tableType==="entity-child"&&(t.parentEntityMetadata=e.find(n=>n.inheritanceTree.indexOf(t.target)!==-1&&n.inheritancePattern==="STI"))}computeEntityMetadataStep1(e,t){const n=this.metadataArgsStorage.findInheritanceType(t.target),r=this.metadataArgsStorage.findDiscriminatorValue(t.target);if(typeof r<"u"?t.discriminatorValue=r.value:t.discriminatorValue=t.target.name,t.embeddeds=this.createEmbeddedsRecursively(t,this.metadataArgsStorage.filterEmbeddeds(t.inheritanceTree)).map(s=>(t.inheritancePattern==="STI"&&(s.columns=s.columns.map(a=>(a.isNullable=!0,a))),s)),t.ownColumns=this.metadataArgsStorage.filterColumns(t.inheritanceTree).map(s=>{if(t.tableType==="entity-child")return t.parentEntityMetadata.ownColumns.find(c=>c.propertyName===s.propertyName);if(t.tableType==="regular"&&s.target!==t.target){const c=this.metadataArgsStorage.columns.find(u=>u.propertyName===s.propertyName&&u.target===t.target);c&&c.options.default&&(s.options.default=c.options.default)}const a=new Ke({connection:this.connection,entityMetadata:t,args:s});return e.find(c=>c.tableType==="entity-child"&&c.target===s.target)&&(a.isNullable=!0),a}),n&&n.column){const s=n.column&&n.column.name?n.column.name:"type";let a=t.ownColumns.find(o=>o.propertyName===s);a?a.isDiscriminator=!0:(a=new Ke({connection:this.connection,entityMetadata:t,args:{target:t.target,mode:"virtual",propertyName:s,options:n.column||{name:s,type:"varchar",nullable:!1}}}),a.isVirtual=!0,a.isDiscriminator=!0,t.ownColumns.push(a))}if(t.tableType==="entity-child"){const s=t.parentEntityMetadata.ownColumns.find(a=>a.isDiscriminator);s&&!t.ownColumns.find(a=>a===s)&&t.ownColumns.push(s),t.inheritancePattern=t.parentEntityMetadata.inheritancePattern,!t.treeType&&t.parentEntityMetadata.treeType&&(t.treeType=t.parentEntityMetadata.treeType,t.treeOptions=t.parentEntityMetadata.treeOptions,t.treeParentRelation=t.parentEntityMetadata.treeParentRelation,t.treeLevelColumn=t.parentEntityMetadata.treeLevelColumn)}const{namingStrategy:i}=this.connection;if(t.treeType==="materialized-path")t.ownColumns.push(new Ke({connection:this.connection,entityMetadata:t,materializedPath:!0,args:{target:t.target,mode:"virtual",propertyName:"mpath",options:{name:i.materializedPathColumnName,type:String,nullable:!0,default:""}}}));else if(t.treeType==="nested-set"){const{left:s,right:a}=i.nestedSetColumnNames;t.ownColumns.push(new Ke({connection:this.connection,entityMetadata:t,nestedSetLeft:!0,args:{target:t.target,mode:"virtual",propertyName:s,options:{name:s,type:Number,nullable:!1,default:1}}})),t.ownColumns.push(new Ke({connection:this.connection,entityMetadata:t,nestedSetRight:!0,args:{target:t.target,mode:"virtual",propertyName:a,options:{name:a,type:Number,nullable:!1,default:2}}}))}if(t.ownRelations=this.metadataArgsStorage.filterRelations(t.inheritanceTree).map(s=>{if(t.tableType==="entity-child"){const a=t.parentEntityMetadata.ownRelations.find(c=>c.propertyName===s.propertyName),o=typeof s.type=="function"?s.type():s.type;if(a.type!==o){const c=Object.create(a);return c.type=o,c}return a}return new ss({entityMetadata:t,args:s})}),t.relationIds=this.metadataArgsStorage.filterRelationIds(t.inheritanceTree).map(s=>t.tableType==="entity-child"?t.parentEntityMetadata.relationIds.find(a=>a.propertyName===s.propertyName):new as({entityMetadata:t,args:s})),t.relationCounts=this.metadataArgsStorage.filterRelationCounts(t.inheritanceTree).map(s=>t.tableType==="entity-child"?t.parentEntityMetadata.relationCounts.find(a=>a.propertyName===s.propertyName):new os({entityMetadata:t,args:s})),t.ownListeners=this.metadataArgsStorage.filterListeners(t.inheritanceTree).map(s=>new cs({entityMetadata:t,args:s})),t.checks=this.metadataArgsStorage.filterChecks(t.inheritanceTree).map(s=>new Vc({entityMetadata:t,args:s})),this.connection.driver.options.type==="postgres"&&(t.exclusions=this.metadataArgsStorage.filterExclusions(t.inheritanceTree).map(s=>new Wc({entityMetadata:t,args:s}))),this.connection.driver.options.type==="cockroachdb"){t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(a=>!a.unique).map(a=>new tt({entityMetadata:t,args:a}));const s=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(a=>a.unique).map(a=>new Vt({entityMetadata:t,args:{target:a.target,name:a.name,columns:a.columns}}));t.ownUniques.push(...s)}else t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).map(s=>new tt({entityMetadata:t,args:s}));if(J.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){const s=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(a=>new tt({entityMetadata:t,args:{target:a.target,name:a.name,columns:a.columns,unique:!0,synchronize:!0}}));t.ownIndices.push(...s)}else{const s=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(a=>new Vt({entityMetadata:t,args:a}));t.ownUniques.push(...s)}}createEmbeddedsRecursively(e,t){return t.map(n=>{const r=new Fc({entityMetadata:e,args:n}),i=typeof r.type=="function"?jt.getInheritanceTree(r.type):[r.type];return r.columns=this.metadataArgsStorage.filterColumns(i).map(s=>new Ke({connection:this.connection,entityMetadata:e,embeddedMetadata:r,args:s})),r.relations=this.metadataArgsStorage.filterRelations(i).map(s=>new ss({entityMetadata:e,embeddedMetadata:r,args:s})),r.listeners=this.metadataArgsStorage.filterListeners(i).map(s=>new cs({entityMetadata:e,embeddedMetadata:r,args:s})),r.indices=this.metadataArgsStorage.filterIndices(i).map(s=>new tt({entityMetadata:e,embeddedMetadata:r,args:s})),r.uniques=this.metadataArgsStorage.filterUniques(i).map(s=>new Vt({entityMetadata:e,embeddedMetadata:r,args:s})),r.relationIds=this.metadataArgsStorage.filterRelationIds(i).map(s=>new as({entityMetadata:e,args:s})),r.relationCounts=this.metadataArgsStorage.filterRelationCounts(i).map(s=>new os({entityMetadata:e,args:s})),r.embeddeds=this.createEmbeddedsRecursively(e,this.metadataArgsStorage.filterEmbeddeds(i)),r.embeddeds.forEach(s=>s.parentEmbeddedMetadata=r),e.allEmbeddeds.push(r),r})}computeEntityMetadataStep2(e){e.embeddeds.forEach(t=>t.build(this.connection)),e.embeddeds.forEach(t=>{t.columnsFromTree.forEach(n=>n.build(this.connection)),t.relationsFromTree.forEach(n=>n.build())}),e.ownColumns.forEach(t=>t.build(this.connection)),e.ownRelations.forEach(t=>t.build()),e.relations=e.embeddeds.reduce((t,n)=>t.concat(n.relationsFromTree),e.ownRelations),e.eagerRelations=e.relations.filter(t=>t.isEager),e.lazyRelations=e.relations.filter(t=>t.isLazy),e.oneToOneRelations=e.relations.filter(t=>t.isOneToOne),e.oneToManyRelations=e.relations.filter(t=>t.isOneToMany),e.manyToOneRelations=e.relations.filter(t=>t.isManyToOne),e.manyToManyRelations=e.relations.filter(t=>t.isManyToMany),e.ownerOneToOneRelations=e.relations.filter(t=>t.isOneToOneOwner),e.ownerManyToManyRelations=e.relations.filter(t=>t.isManyToManyOwner),e.treeParentRelation=e.relations.find(t=>t.isTreeParent),e.treeChildrenRelation=e.relations.find(t=>t.isTreeChildren),e.columns=e.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),e.ownColumns),e.listeners=e.embeddeds.reduce((t,n)=>t.concat(n.listenersFromTree),e.ownListeners),e.afterLoadListeners=e.listeners.filter(t=>t.type===_e.AFTER_LOAD),e.afterInsertListeners=e.listeners.filter(t=>t.type===_e.AFTER_INSERT),e.afterUpdateListeners=e.listeners.filter(t=>t.type===_e.AFTER_UPDATE),e.afterRemoveListeners=e.listeners.filter(t=>t.type===_e.AFTER_REMOVE),e.afterSoftRemoveListeners=e.listeners.filter(t=>t.type===_e.AFTER_SOFT_REMOVE),e.afterRecoverListeners=e.listeners.filter(t=>t.type===_e.AFTER_RECOVER),e.beforeInsertListeners=e.listeners.filter(t=>t.type===_e.BEFORE_INSERT),e.beforeUpdateListeners=e.listeners.filter(t=>t.type===_e.BEFORE_UPDATE),e.beforeRemoveListeners=e.listeners.filter(t=>t.type===_e.BEFORE_REMOVE),e.beforeSoftRemoveListeners=e.listeners.filter(t=>t.type===_e.BEFORE_SOFT_REMOVE),e.beforeRecoverListeners=e.listeners.filter(t=>t.type===_e.BEFORE_RECOVER),e.indices=e.embeddeds.reduce((t,n)=>t.concat(n.indicesFromTree),e.ownIndices),e.uniques=e.embeddeds.reduce((t,n)=>t.concat(n.uniquesFromTree),e.ownUniques),e.primaryColumns=e.columns.filter(t=>t.isPrimary),e.nonVirtualColumns=e.columns.filter(t=>!t.isVirtual),e.ancestorColumns=e.columns.filter(t=>t.closureType==="ancestor"),e.descendantColumns=e.columns.filter(t=>t.closureType==="descendant"),e.hasMultiplePrimaryKeys=e.primaryColumns.length>1,e.generatedColumns=e.columns.filter(t=>t.isGenerated||t.isObjectId),e.hasUUIDGeneratedColumns=e.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,e.createDateColumn=e.columns.find(t=>t.isCreateDate),e.updateDateColumn=e.columns.find(t=>t.isUpdateDate),e.deleteDateColumn=e.columns.find(t=>t.isDeleteDate),e.versionColumn=e.columns.find(t=>t.isVersion),e.discriminatorColumn=e.columns.find(t=>t.isDiscriminator),e.treeLevelColumn=e.columns.find(t=>t.isTreeLevel),e.nestedSetLeftColumn=e.columns.find(t=>t.isNestedSetLeft),e.nestedSetRightColumn=e.columns.find(t=>t.isNestedSetRight),e.materializedPathColumn=e.columns.find(t=>t.isMaterializedPath),e.objectIdColumn=e.columns.find(t=>t.isObjectId),e.foreignKeys.forEach(t=>t.build(this.connection.namingStrategy)),e.propertiesMap=e.createPropertiesMap(),e.relationIds.forEach(t=>t.build()),e.relationCounts.forEach(t=>t.build()),e.embeddeds.forEach(t=>{t.relationIdsFromTree.forEach(n=>n.build()),t.relationCountsFromTree.forEach(n=>n.build())})}computeInverseProperties(e,t){e.relations.forEach(n=>{const r=t.find(i=>i.target===n.type||typeof n.type=="string"&&(i.targetName===n.type||i.givenTableName===n.type));if(!r)throw new M("Entity metadata for "+e.name+"#"+n.propertyPath+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");n.inverseEntityMetadata=r,n.inverseSidePropertyPath=n.buildInverseSidePropertyPath(),n.inverseRelation=r.relations.find(i=>i.propertyPath===n.inverseSidePropertyPath)})}createKeysForTableInheritance(e){e.indices.some(({givenColumnNames:n})=>!!n&&Array.isArray(n)&&n.length===1&&n[0]===e.discriminatorColumn?.databaseName)||e.indices.push(new tt({entityMetadata:e,columns:[e.discriminatorColumn],args:{target:e.target,unique:!1}}))}createForeignKeys(e,t){this.metadataArgsStorage.filterForeignKeys(e.inheritanceTree).forEach(n=>{const r=typeof n.type=="function"?n.type():n.type,i=t.find(l=>typeof r=="string"?l.targetName===r||l.givenTableName===r:q.isEntitySchema(r)?l.target===r.options.name||l.target===r.options.target:l.target===r);if(!i)throw new M("Entity metadata for "+e.name+(n.propertyName?"#"+n.propertyName:"")+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");const s=n.columnNames??[],a=n.referencedColumnNames??[],o=[],c=[];n.propertyName&&(s.push(n.propertyName),n.inverseSide&&(typeof n.inverseSide=="function"?a.push(n.inverseSide(i.propertiesMap)):a.push(n.inverseSide))),a.length||c.push(...i.primaryColumns);const u=(l,h)=>{const f=h.columns.find(A=>A.propertyName===l||A.databaseName===l);if(f)return f;const E=n.name?'"'+n.name+'" ':"",b=h.targetName;throw new M(`Foreign key constraint ${E}contains column that is missing in the entity (${b}): ${l}`)};o.push(...s.map(l=>u(l,e))),c.push(...a.map(l=>u(l,i))),e.foreignKeys.push(new Tt({entityMetadata:e,referencedEntityMetadata:i,namingStrategy:this.connection.namingStrategy,columns:o,referencedColumns:c,...n}))})}}class Gt extends M{static createEntitySchemaIsRequiredException(e){return new Gt(`EntitySchema is required for ${e} embedded field`)}static createTargetIsRequired(e){return new Gt(`Target field is required for ${e} embedded EntitySchema`)}constructor(e){super(e)}}class Hc{transform(e){const t=new gs;return e.forEach(n=>{const r=n.options,i={target:r.target||r.name,name:r.tableName,database:r.database,schema:r.schema,type:r.type||"regular",orderBy:r.orderBy,synchronize:r.synchronize,withoutRowid:!!r.withoutRowid,expression:r.expression};t.tables.push(i);const{inheritance:s}=r;s&&t.inheritances.push({target:r.target,pattern:s.pattern??"STI",column:s.column?typeof s.column=="string"?{name:s.column}:s.column:void 0});const{discriminatorValue:a}=r;a&&t.discriminatorValues.push({target:r.target||r.name,value:a}),this.transformColumnsRecursive(r,t)}),t}transformColumnsRecursive(e,t){Object.keys(e.columns).forEach(n=>{const i=e.columns[n];let s="regular";i.createDate&&(s="createDate"),i.updateDate&&(s="updateDate"),i.deleteDate&&(s="deleteDate"),i.version&&(s="version"),i.treeChildrenCount&&(s="treeChildrenCount"),i.treeLevel&&(s="treeLevel"),i.objectId&&(s="objectId"),i.virtualProperty&&(s="virtual-property");const a={target:e.target||e.name,mode:s,propertyName:n,options:{type:i.type,name:i.objectId?"_id":i.name,primaryKeyConstraintName:i.primaryKeyConstraintName,length:i.length,width:i.width,nullable:i.nullable,readonly:i.readonly,update:i.update,select:i.select,insert:i.insert,primary:i.primary,unique:i.unique,comment:i.comment,default:i.default,onUpdate:i.onUpdate,precision:i.precision,scale:i.scale,zerofill:i.zerofill,unsigned:i.unsigned,charset:i.charset,collation:i.collation,enum:i.enum,enumName:i.enumName,asExpression:i.asExpression,generatedType:i.generatedType,hstoreType:i.hstoreType,array:i.array,transformer:i.transformer,spatialFeatureType:i.spatialFeatureType,srid:i.srid,query:i.query}};if(t.columns.push(a),i.generated){const o={target:e.target||e.name,propertyName:n,strategy:typeof i.generated=="string"?i.generated:"increment"};t.generations.push(o)}if(i.unique&&t.uniques.push({target:e.target||e.name,columns:[n]}),i.foreignKey){const o=i.foreignKey,c={target:e.target||e.name,type:o.target,propertyName:n,inverseSide:o.inverseSide,name:o.name,onDelete:o.onDelete,onUpdate:o.onUpdate,deferrable:o.deferrable};t.foreignKeys.push(c)}}),e.relations&&Object.keys(e.relations).forEach(n=>{const r=e.relations[n],i={target:e.target||e.name,propertyName:n,relationType:r.type,isLazy:r.lazy||!1,type:r.target,inverseSideProperty:r.inverseSide,isTreeParent:r.treeParent,isTreeChildren:r.treeChildren,options:{eager:r.eager||!1,cascade:r.cascade,nullable:r.nullable,onDelete:r.onDelete,onUpdate:r.onUpdate,deferrable:r.deferrable,createForeignKeyConstraints:r.createForeignKeyConstraints,persistence:r.persistence,orphanedRowAction:r.orphanedRowAction}};if(t.relations.push(i),r.joinColumn)if(typeof r.joinColumn=="boolean"){const s={target:e.target||e.name,propertyName:n};t.joinColumns.push(s)}else{const s=Array.isArray(r.joinColumn)?r.joinColumn:[r.joinColumn];for(const a of s){const o={target:e.target||e.name,propertyName:n,name:a.name,referencedColumnName:a.referencedColumnName,foreignKeyConstraintName:a.foreignKeyConstraintName};t.joinColumns.push(o)}}if(r.joinTable)if(typeof r.joinTable=="boolean"){const s={target:e.target||e.name,propertyName:n};t.joinTables.push(s)}else{const s={target:e.target||e.name,propertyName:n,name:r.joinTable.name,database:r.joinTable.database,schema:r.joinTable.schema,joinColumns:r.joinTable.joinColumn?[r.joinTable.joinColumn]:r.joinTable.joinColumns,inverseJoinColumns:r.joinTable.inverseJoinColumn?[r.joinTable.inverseJoinColumn]:r.joinTable.inverseJoinColumns};t.joinTables.push(s)}}),e.relationIds&&Object.keys(e.relationIds).forEach(n=>{const r=e.relationIds[n],i={propertyName:n,relation:r.relationName,target:e.target||e.name,alias:r.alias,queryBuilderFactory:r.queryBuilderFactory};t.relationIds.push(i)}),e.indices&&e.indices.forEach(n=>{const r={target:e.target||e.name,name:n.name,unique:n.unique===!0,spatial:n.spatial===!0,fulltext:n.fulltext===!0,nullFiltered:n.nullFiltered===!0,parser:n.parser,synchronize:n.synchronize!==!1,where:n.where,sparse:n.sparse,columns:n.columns};t.indices.push(r)}),e.foreignKeys&&e.foreignKeys.forEach(n=>{const r={target:e.target||e.name,type:n.target,columnNames:n.columnNames,referencedColumnNames:n.referencedColumnNames,name:n.name,onDelete:n.onDelete,onUpdate:n.onUpdate,deferrable:n.deferrable};t.foreignKeys.push(r)}),e.uniques&&e.uniques.forEach(n=>{const r={target:e.target||e.name,name:n.name,columns:n.columns,deferrable:n.deferrable};t.uniques.push(r)}),e.checks&&e.checks.forEach(n=>{const r={target:e.target||e.name,name:n.name,expression:n.expression};t.checks.push(r)}),e.exclusions&&e.exclusions.forEach(n=>{const r={target:e.target||e.name,name:n.name,expression:n.expression};t.exclusions.push(r)}),e.embeddeds&&Object.keys(e.embeddeds).forEach(n=>{const r=e.embeddeds[n];if(!r.schema)throw Gt.createEntitySchemaIsRequiredException(n);const i=r.schema.options;t.embeddeds.push({target:e.target||e.name,propertyName:n,isArray:r.array===!0,prefix:r.prefix!==void 0?r.prefix:void 0,type:()=>i?.target||i.name}),this.transformColumnsRecursive(i,t)})}}class Gc{constructor(e){this.connection=e}async buildMigrations(e){const[t]=K.splitClassesAndStrings(e);return[...t,...await mr(this.connection.logger)].map(r=>is(r))}async buildSubscribers(e){const[t]=K.splitClassesAndStrings(e||[]),n=[...t,...await mr(this.connection.logger)];return zt().filterSubscribers(n).map(r=>is(r.target))}async buildEntityMetadatas(e){const[t]=K.splitClassesAndStrings(e||[]),n=t.filter(c=>!q.isEntitySchema(c)),r=t.filter(c=>q.isEntitySchema(c)),i=[...n,...await mr(this.connection.logger)];i.forEach(c=>{q.isEntitySchema(c)&&r.push(c)});const s=new us(this.connection,zt()).build(i),a=new Hc().transform(r),o=new us(this.connection,a).build();return[...s,...o]}}class tn{constructor(e){this.options=e}logQuery(e,t,n){this.isLogEnabledFor("query")&&this.writeLog("query",{type:"query",prefix:"query",message:e,format:"sql",parameters:t},n)}logQueryError(e,t,n,r){this.isLogEnabledFor("query-error")&&this.writeLog("warn",[{type:"query-error",prefix:"query failed",message:t,format:"sql",parameters:n},{type:"query-error",prefix:"error",message:e}],r)}logQuerySlow(e,t,n,r){this.isLogEnabledFor("query-slow")&&this.writeLog("warn",[{type:"query-slow",prefix:"query is slow",message:t,format:"sql",parameters:n,additionalInfo:{time:e}},{type:"query-slow",prefix:"execution time",message:e}],r)}logSchemaBuild(e,t){this.isLogEnabledFor("schema-build")&&this.writeLog("schema",{type:"schema-build",message:e},t)}logMigration(e,t){this.isLogEnabledFor("migration")&&this.writeLog("log",{type:"migration",message:e},t)}log(e,t,n){switch(e){case"log":if(!this.isLogEnabledFor("log"))return;this.writeLog("log",{type:"log",message:t},n);break;case"info":if(!this.isLogEnabledFor("info"))return;this.writeLog("info",{type:"info",prefix:"info",message:t},n);break;case"warn":if(!this.isLogEnabledFor("warn"))return;this.writeLog("warn",{type:"warn",message:t},n);break}}isLogEnabledFor(e){switch(e){case"query":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("query")!==-1;case"error":case"query-error":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("error")!==-1;case"query-slow":return!0;case"schema":case"schema-build":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("schema")!==-1;case"migration":return!0;case"log":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("log")!==-1;case"info":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("info")!==-1;case"warn":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("warn")!==-1;default:return!1}}prepareLogMessages(e,t,n){t={addColonToPrefix:!0,appendParameterAsComment:!0,highlightSql:!0,formatSql:!1,...t};const r=Array.isArray(e)?e:[e];for(let i of r){if(typeof i!="object"&&(i={message:i}),i.format==="sql"){let s=String(i.message);t.formatSql&&(s=ve.formatSql(s,n?.connection?.options.type)),t.appendParameterAsComment&&i.parameters&&i.parameters.length&&(s+=` -- PARAMETERS: ${this.stringifyParams(i.parameters)}`),t.highlightSql&&(s=ve.highlightSql(s)),i.message=s}t.addColonToPrefix&&i.prefix&&(i.prefix+=":")}return r}stringifyParams(e){try{return JSON.stringify(e)}catch{return e}}}class zc extends tn{writeLog(e,t,n){const r=this.prepareLogMessages(t,{highlightSql:!1});for(const i of r)switch(i.type??e){case"log":case"schema-build":case"migration":console.log(i.message);break;case"info":case"query":i.prefix?console.info(i.prefix,i.message):console.info(i.message);break;case"warn":case"query-slow":i.prefix?console.warn(i.prefix,i.message):console.warn(i.message);break;case"error":case"query-error":i.prefix?console.error(i.prefix,i.message):console.error(i.message);break}}}class ls extends tn{writeLog(e,t,n){const r=this.prepareLogMessages(t);for(const i of r)switch(i.type??e){case"log":case"schema-build":case"migration":ve.log(String(i.message));break;case"info":case"query":i.prefix?ve.logInfo(i.prefix,i.message):ve.log(String(i.message));break;case"warn":case"query-slow":i.prefix?ve.logWarn(i.prefix,i.message):console.warn(ve.warn(String(i.message)));break;case"error":case"query-error":i.prefix?ve.logError(i.prefix,String(i.message)):console.error(ve.error(String(i.message)));break}}}class Kc{logQuery(){throw new Error("This logger is not applicable in a browser context")}logQueryError(){throw new Error("This logger is not applicable in a browser context")}logQuerySlow(){throw new Error("This logger is not applicable in a browser context")}logSchemaBuild(){throw new Error("This logger is not applicable in a browser context")}logMigration(){throw new Error("This logger is not applicable in a browser context")}log(){throw new Error("This logger is not applicable in a browser context")}}class Jc extends Kc{}var Ft={exports:{}},yr,hs;function Yc(){if(hs)return yr;hs=1;var d=1e3,e=d*60,t=e*60,n=t*24,r=n*7,i=n*365.25;yr=function(u,l){l=l||{};var h=typeof u;if(h==="string"&&u.length>0)return s(u);if(h==="number"&&isFinite(u))return l.long?o(u):a(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function s(u){if(u=String(u),!(u.length>100)){var l=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(l){var h=parseFloat(l[1]),f=(l[2]||"ms").toLowerCase();switch(f){case"years":case"year":case"yrs":case"yr":case"y":return h*i;case"weeks":case"week":case"w":return h*r;case"days":case"day":case"d":return h*n;case"hours":case"hour":case"hrs":case"hr":case"h":return h*t;case"minutes":case"minute":case"mins":case"min":case"m":return h*e;case"seconds":case"second":case"secs":case"sec":case"s":return h*d;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}}}function a(u){var l=Math.abs(u);return l>=n?Math.round(u/n)+"d":l>=t?Math.round(u/t)+"h":l>=e?Math.round(u/e)+"m":l>=d?Math.round(u/d)+"s":u+"ms"}function o(u){var l=Math.abs(u);return l>=n?c(u,l,n,"day"):l>=t?c(u,l,t,"hour"):l>=e?c(u,l,e,"minute"):l>=d?c(u,l,d,"second"):u+" ms"}function c(u,l,h,f){var E=l>=h*1.5;return Math.round(u/h)+" "+f+(E?"s":"")}return yr}var gr,ps;function Xc(){if(ps)return gr;ps=1;function d(e){n.debug=n,n.default=n,n.coerce=c,n.disable=a,n.enable=i,n.enabled=o,n.humanize=Yc(),n.destroy=u,Object.keys(e).forEach(l=>{n[l]=e[l]}),n.names=[],n.skips=[],n.formatters={};function t(l){let h=0;for(let f=0;f<l.length;f++)h=(h<<5)-h+l.charCodeAt(f),h|=0;return n.colors[Math.abs(h)%n.colors.length]}n.selectColor=t;function n(l){let h,f=null,E,b;function A(...P){if(!A.enabled)return;const D=A,I=Number(new Date),W=I-(h||I);D.diff=W,D.prev=h,D.curr=I,h=I,P[0]=n.coerce(P[0]),typeof P[0]!="string"&&P.unshift("%O");let G=0;P[0]=P[0].replace(/%([a-zA-Z%])/g,(ne,pe)=>{if(ne==="%%")return"%";G++;const F=n.formatters[pe];if(typeof F=="function"){const se=P[G];ne=F.call(D,se),P.splice(G,1),G--}return ne}),n.formatArgs.call(D,P),(D.log||n.log).apply(D,P)}return A.namespace=l,A.useColors=n.useColors(),A.color=n.selectColor(l),A.extend=r,A.destroy=n.destroy,Object.defineProperty(A,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(E!==n.namespaces&&(E=n.namespaces,b=n.enabled(l)),b),set:P=>{f=P}}),typeof n.init=="function"&&n.init(A),A}function r(l,h){const f=n(this.namespace+(typeof h>"u"?":":h)+l);return f.log=this.log,f}function i(l){n.save(l),n.namespaces=l,n.names=[],n.skips=[];const h=(typeof l=="string"?l:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const f of h)f[0]==="-"?n.skips.push(f.slice(1)):n.names.push(f)}function s(l,h){let f=0,E=0,b=-1,A=0;for(;f<l.length;)if(E<h.length&&(h[E]===l[f]||h[E]==="*"))h[E]==="*"?(b=E,A=f,E++):(f++,E++);else if(b!==-1)E=b+1,A++,f=A;else return!1;for(;E<h.length&&h[E]==="*";)E++;return E===h.length}function a(){const l=[...n.names,...n.skips.map(h=>"-"+h)].join(",");return n.enable(""),l}function o(l){for(const h of n.skips)if(s(l,h))return!1;for(const h of n.names)if(s(l,h))return!0;return!1}function c(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}return gr=d,gr}var ds;function Zc(){return ds||(ds=1,(function(d,e){var t={};e.formatArgs=r,e.save=i,e.load=s,e.useColors=n,e.storage=a(),e.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let c;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(c=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(c[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function r(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+d.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;c.splice(1,0,u,"color: inherit");let l=0,h=0;c[0].replace(/%[a-zA-Z%]/g,f=>{f!=="%%"&&(l++,f==="%c"&&(h=l))}),c.splice(h,0,u)}e.log=console.debug||console.log||(()=>{});function i(c){try{c?e.storage.setItem("debug",c):e.storage.removeItem("debug")}catch{}}function s(){let c;try{c=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!c&&typeof process<"u"&&"env"in process&&(c=t.DEBUG),c}function a(){try{return localStorage}catch{}}d.exports=Xc()(e);const{formatters:o}=d.exports;o.j=function(c){try{return JSON.stringify(c)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(Ft,Ft.exports)),Ft.exports}var ut=Zc();class eu extends tn{constructor(){super(...arguments),this.logger={log:ut.debug("typeorm:log"),info:ut.debug("typeorm:info"),warn:ut.debug("typeorm:warn"),error:ut.debug("typeorm:error"),query:ut.debug("typeorm:query:log"),"query-error":ut.debug("typeorm:query:error"),"query-slow":ut.debug("typeorm:query:slow"),"schema-build":ut.debug("typeorm:schema"),migration:ut.debug("typeorm:migration")}}isLogEnabledFor(e){switch(e){case"query":return this.logger.query.enabled;case"query-error":return this.logger["query-error"].enabled;case"query-slow":return!0;case"schema":case"schema-build":return this.logger["schema-build"].enabled;case"migration":return this.logger.migration.enabled;case"log":return this.logger.log.enabled;case"info":return this.logger.info.enabled;case"warn":return this.logger.warn.enabled;default:return!1}}writeLog(e,t,n){const r=this.prepareLogMessages(t,{appendParameterAsComment:!1});for(const i of r){const s=i.type??e;s in this.logger&&(i.prefix?this.logger[s](i.prefix,i.message):this.logger[s](i.message),i.parameters&&i.parameters.length&&this.logger[s]("parameters:",i.parameters))}}}class tu extends tn{writeLog(e,t,n){const r=this.prepareLogMessages(t,{highlightSql:!0,formatSql:!0},n);for(const i of r)switch(i.type??e){case"log":case"schema-build":case"migration":ve.log(String(i.message));break;case"info":case"query":i.prefix?ve.logInfo(i.prefix,i.message):ve.log(String(i.message));break;case"warn":case"query-slow":i.prefix?ve.logWarn(i.prefix,i.message):console.warn(ve.warn(String(i.message)));break;case"error":case"query-error":i.prefix?ve.logError(i.prefix,String(i.message)):console.error(ve.error(String(i.message)));break}}}class fs{create(e,t){if(me.isObject(e))return e;if(e)switch(e){case"simple-console":return new zc(t);case"file":return new Jc(t);case"advanced-console":return new ls(t);case"formatted-console":return new tu(t);case"debug":return new eu}return new ls(t)}}class nu{constructor(e,t){this.connection=e,this.clientType=t,this.redis=this.loadRedis()}async connect(){const e=this.connection.options.cache;if(this.clientType==="redis"){const t={...e?.options};let n=this.redis.createClient(t);typeof n.connect=="function"&&(t.legacyMode=!0,n=this.redis.createClient(t)),this.client=n,typeof this.connection.options.cache=="object"&&this.connection.options.cache.ignoreErrors&&this.client.on("error",i=>{this.connection.logger.log("warn",i)}),typeof this.client.connect=="function"&&await this.client.connect(),this.detectRedisVersion()}else if(this.clientType==="ioredis")e&&e.port?e.options?this.client=new this.redis(e.port,e.options):this.client=new this.redis(e.port):e&&e.options?this.client=new this.redis(e.options):this.client=new this.redis;else if(this.clientType==="ioredis/cluster")if(e&&e.options&&Array.isArray(e.options))this.client=new this.redis.Cluster(e.options);else if(e&&e.options&&e.options.startupNodes)this.client=new this.redis.Cluster(e.options.startupNodes,e.options.options);else throw new M(`options.startupNodes required for ${this.clientType}.`)}async disconnect(){if(this.isRedis5OrHigher()){await this.client.quit(),this.client=void 0;return}return new Promise((e,t)=>{this.client.quit((n,r)=>{if(n)return t(n);e(),this.client=void 0})})}async synchronize(e){}getFromCache(e,t){const n=e.identifier||e.query;return n?this.isRedis5OrHigher()?this.client.get(n).then(r=>r?JSON.parse(r):void 0):new Promise((r,i)=>{this.client.get(n,(s,a)=>{if(s)return i(s);r(a?JSON.parse(a):void 0)})}):Promise.resolve(void 0)}isExpired(e){return e.time+e.duration<Date.now()}async storeInCache(e,t,n){const r=e.identifier||e.query;if(!r)return;const i=JSON.stringify(e),s=e.duration;if(this.isRedis5OrHigher()){await this.client.set(r,i,{PX:s});return}return new Promise((a,o)=>{this.client.set(r,i,"PX",s,(c,u)=>{if(c)return o(c);a()})})}async clear(e){if(this.isRedis5OrHigher()){await this.client.flushDb();return}return new Promise((t,n)=>{this.client.flushdb((r,i)=>{if(r)return n(r);t()})})}async remove(e,t){await Promise.all(e.map(n=>this.deleteKey(n)))}async deleteKey(e){if(this.isRedis5OrHigher()){await this.client.del(e);return}return new Promise((t,n)=>{this.client.del(e,(r,i)=>{if(r)return n(r);t()})})}loadRedis(){try{return this.clientType==="ioredis/cluster"?ve.load("ioredis"):ve.load(this.clientType)}catch{throw new M(`Cannot use cache because ${this.clientType} is not installed. Please run "npm i ${this.clientType}".`)}}detectRedisVersion(){if(this.clientType==="redis")try{const e=this.client.set;e&&e.length<=3?this.redisMajorVersion=5:this.redisMajorVersion=3}catch{this.redisMajorVersion=3}}isRedis5OrHigher(){return this.clientType!=="redis"?!1:this.redisMajorVersion!==void 0&&this.redisMajorVersion>=5}}class ru{constructor(e){this.connection=e;const{schema:t}=this.connection.driver.options,n=this.connection.driver.database,i=(typeof this.connection.options.cache=="object"?this.connection.options.cache:{}).tableName||"query-result-cache";this.queryResultCacheDatabase=n,this.queryResultCacheSchema=t,this.queryResultCacheTable=this.connection.driver.buildTableName(i,t,n)}async connect(){}async disconnect(){}async synchronize(e){e=this.getQueryRunner(e);const t=this.connection.driver;await e.hasTable(this.queryResultCacheTable)||await e.createTable(new $e({database:this.queryResultCacheDatabase,schema:this.queryResultCacheSchema,name:this.queryResultCacheTable,columns:[{name:"id",isPrimary:!0,isNullable:!1,type:t.normalizeType({type:t.mappedDataTypes.cacheId}),generationStrategy:t.options.type==="spanner"?"uuid":"increment",isGenerated:!0},{name:"identifier",type:t.normalizeType({type:t.mappedDataTypes.cacheIdentifier}),isNullable:!0},{name:"time",type:t.normalizeType({type:t.mappedDataTypes.cacheTime}),isPrimary:!1,isNullable:!1},{name:"duration",type:t.normalizeType({type:t.mappedDataTypes.cacheDuration}),isPrimary:!1,isNullable:!1},{name:"query",type:t.normalizeType({type:t.mappedDataTypes.cacheQuery}),isPrimary:!1,isNullable:!1},{name:"result",type:t.normalizeType({type:t.mappedDataTypes.cacheResult}),isNullable:!1}]}))}getFromCache(e,t){t=this.getQueryRunner(t);const n=this.connection.createQueryBuilder(t).select().from(this.queryResultCacheTable,"cache");return e.identifier?n.where(`${n.escape("cache")}.${n.escape("identifier")} = :identifier`).setParameters({identifier:this.connection.driver.options.type==="mssql"?new et(e.identifier,"nvarchar"):e.identifier}).cache(!1).getRawOne():e.query?this.connection.driver.options.type==="oracle"?n.where(`dbms_lob.compare(${n.escape("cache")}.${n.escape("query")}, :query) = 0`,{query:e.query}).cache(!1).getRawOne():n.where(`${n.escape("cache")}.${n.escape("query")} = :query`).setParameters({query:this.connection.driver.options.type==="mssql"?new et(e.query,"nvarchar"):e.query}).cache(!1).getRawOne():Promise.resolve(void 0)}isExpired(e){const t=typeof e.duration=="string"?parseInt(e.duration):e.duration;return(typeof e.time=="string"?parseInt(e.time):e.time)+t<Date.now()}async storeInCache(e,t,n){const r=n===void 0||n?.getReplicationMode()==="slave";(n===void 0||r)&&(n=this.connection.createQueryRunner("master"));let i=e;if(this.connection.driver.options.type==="mssql"&&(i={identifier:new et(e.identifier,"nvarchar"),time:new et(e.time,"bigint"),duration:new et(e.duration,"int"),query:new et(e.query,"nvarchar"),result:new et(e.result,"nvarchar")}),t&&t.identifier){const s=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(i);s.where(`${s.escape("identifier")} = :condition`,{condition:i.identifier}),await s.execute()}else if(t&&t.query){const s=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(i);this.connection.driver.options.type==="oracle"?s.where('dbms_lob.compare("query", :condition) = 0',{condition:i.query}):s.where(`${s.escape("query")} = :condition`,{condition:i.query}),await s.execute()}else this.connection.driver.options.type==="spanner"&&!i.id&&(i.id=Ls()),await n.manager.createQueryBuilder().insert().into(this.queryResultCacheTable).values(i).execute();r&&await n.release()}async clear(e){return this.getQueryRunner(e).clearTable(this.queryResultCacheTable)}async remove(e,t){const n=t||this.getQueryRunner();await Promise.all(e.map(r=>{const i=n.manager.createQueryBuilder();return i.delete().from(this.queryResultCacheTable).where(`${i.escape("identifier")} = :identifier`,{identifier:r}).execute()})),t||await n.release()}getQueryRunner(e){return e||this.connection.createQueryRunner()}}class ms{constructor(e){this.connection=e}create(){if(!this.connection.options.cache)throw new M("To use cache you need to enable it in connection options by setting cache: true or providing some caching options. Example: { host: ..., username: ..., cache: true }");const e=this.connection.options.cache;return e.provider&&typeof e.provider=="function"?e.provider(this.connection):e.type==="redis"||e.type==="ioredis"||e.type==="ioredis/cluster"?new nu(this.connection,e.type):new ru(this.connection)}}class iu{constructor(e){this.connection=e}load(e,t,n,r){return n&&n.isReleased&&(n=void 0),e.isManyToOne||e.isOneToOneOwner?this.loadManyToOneOrOneToOneOwner(e,t,n,r):e.isOneToMany||e.isOneToOneNotOwner?this.loadOneToManyOrOneToOneNotOwner(e,t,n,r):e.isManyToManyOwner?this.loadManyToManyOwner(e,t,n,r):this.loadManyToManyNotOwner(e,t,n,r)}loadManyToOneOrOneToOneOwner(e,t,n,r){const i=Array.isArray(t)?t:[t],s=e.entityMetadata.name,a=r||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),o=a.expressionMap.mainAlias.name,c=e.entityMetadata.primaryColumns,l=(e.isOwning?e.joinColumns:e.inverseRelation.joinColumns).map(h=>`${e.entityMetadata.name}.${h.propertyName} = ${o}.${h.referencedColumn.propertyName}`).join(" AND ");if(a.innerJoin(e.entityMetadata.target,s,l),c.length===1)a.where(`${s}.${c[0].propertyPath} IN (:...${s+"_"+c[0].propertyName})`),a.setParameter(s+"_"+c[0].propertyName,i.map(h=>c[0].getEntityValue(h,!0)));else{const h=i.map((f,E)=>c.map((b,A)=>{const P=s+"_entity_"+E+"_"+A;return a.setParameter(P,b.getEntityValue(f,!0)),s+"."+b.propertyPath+" = :"+P}).join(" AND ")).map(f=>"("+f+")").join(" OR ");a.where(h)}return Ve.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadOneToManyOrOneToOneNotOwner(e,t,n,r){const i=Array.isArray(t)?t:[t],s=e.inverseRelation.joinColumns,a=r||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.inverseRelation.entityMetadata.target,e.propertyName),o=a.expressionMap.mainAlias.name;if(s.length===1)a.where(`${o}.${s[0].propertyPath} IN (:...${o+"_"+s[0].propertyName})`),a.setParameter(o+"_"+s[0].propertyName,i.map(c=>s[0].referencedColumn.getEntityValue(c,!0)));else{const c=i.map((u,l)=>s.map((h,f)=>{const E=o+"_entity_"+l+"_"+f;return a.setParameter(E,h.referencedColumn.getEntityValue(u,!0)),o+"."+h.propertyPath+" = :"+E}).join(" AND ")).map(u=>"("+u+")").join(" OR ");a.where(c)}return Ve.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadManyToManyOwner(e,t,n,r){const i=Array.isArray(t)?t:[t],s=e.joinColumns.reduce((h,f)=>(h[f.propertyName]=i.map(E=>f.referencedColumn.getEntityValue(E,!0)),h),{}),a=r||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),o=a.expressionMap.mainAlias.name,c=e.junctionEntityMetadata.tableName,u=e.joinColumns.map(h=>`${c}.${h.propertyName} IN (:...${h.propertyName})`),l=e.inverseJoinColumns.map(h=>`${c}.${h.propertyName}=${o}.${h.referencedColumn.propertyName}`);return a.innerJoin(c,c,[...u,...l].join(" AND ")).setParameters(s),Ve.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadManyToManyNotOwner(e,t,n,r){const i=Array.isArray(t)?t:[t],s=r||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),a=s.expressionMap.mainAlias.name,o=e.junctionEntityMetadata.tableName,c=e.inverseRelation.joinColumns.map(h=>`${o}.${h.propertyName} = ${a}.${h.referencedColumn.propertyName}`),u=e.inverseRelation.inverseJoinColumns.map(h=>`${o}.${h.propertyName} IN (:...${h.propertyName})`),l=e.inverseRelation.inverseJoinColumns.reduce((h,f)=>(h[f.propertyName]=i.map(E=>f.referencedColumn.getEntityValue(E,!0)),h),{});return s.innerJoin(o,o,[...c,...u].join(" AND ")).setParameters(l),Ve.joinEagerRelations(s,s.alias,s.expressionMap.mainAlias.metadata),s.getMany()}enableLazyLoad(e,t,n){const r=this,i="__"+e.propertyName+"__",s="__promise_"+e.propertyName+"__",a="__has_"+e.propertyName+"__",o=(u,l)=>(u[i]=l,u[a]=!0,delete u[s],l),c=(u,l)=>(delete u[a],delete u[i],u[s]=l,l.then(h=>u[s]===l?o(u,h):h),l);Object.defineProperty(t,e.propertyName,{get:function(){if(this[a]===!0||this[i]!==void 0)return Promise.resolve(this[i]);if(this[s])return this[s];const u=r.load(e,this,n).then(l=>e.isOneToOne||e.isManyToOne?l.length===0?null:l[0]:l);return c(this,u)},set:function(u){u instanceof Promise?c(this,u):o(this,u)},configurable:!0,enumerable:!1})}}Fs();class su{constructor(e){this["@instanceof"]=Symbol.for("DataSource"),this.migrations=[],this.subscribers=[],this.entityMetadatas=[],this.entityMetadatasMap=new Map,Fs(),this.name=e.name||"default",this.options=e,this.logger=new fs().create(this.options.logger,this.options.logging),this.driver=new Bc().create(this),this.manager=this.createEntityManager(),this.namingStrategy=e.namingStrategy||new Do,this.metadataTableName=e.metadataTableName||"typeorm_metadata",this.queryResultCache=e.cache?new ms(this).create():void 0,this.relationLoader=new iu(this),this.relationIdLoader=new Bs(this),this.isInitialized=!1}get isConnected(){return this.isInitialized}get mongoManager(){if(!q.isMongoEntityManager(this.manager))throw new M("MongoEntityManager is only available for MongoDB databases.");return this.manager}get sqljsManager(){if(!q.isSqljsEntityManager(this.manager))throw new M("SqljsEntityManager is only available for Sqljs databases.");return this.manager}setOptions(e){return Object.assign(this.options,e),(e.logger||e.logging)&&(this.logger=new fs().create(e.logger||this.options.logger,e.logging||this.options.logging)),e.namingStrategy&&(this.namingStrategy=e.namingStrategy),e.cache&&(this.queryResultCache=new ms(this).create()),e.database&&(this.driver.database=J.buildDriverOptions(this.options).database),this}async initialize(){if(this.isInitialized)throw new Xs(this.name);await this.driver.connect(),this.queryResultCache&&await this.queryResultCache.connect(),me.assign(this,{isInitialized:!0});try{await this.buildMetadatas(),await this.driver.afterConnect(),this.options.dropSchema&&await this.dropDatabase(),this.options.migrationsRun&&await this.runMigrations({transaction:this.options.migrationsTransactionMode}),this.options.synchronize&&await this.synchronize()}catch(e){throw await this.destroy(),e}return this}async connect(){return this.initialize()}async destroy(){if(!this.isInitialized)throw new Rt(this.name);await this.driver.disconnect(),this.queryResultCache&&await this.queryResultCache.disconnect(),me.assign(this,{isInitialized:!1})}async close(){return this.destroy()}async synchronize(e=!1){if(!this.isInitialized)throw new Rt(this.name);e&&await this.dropDatabase(),await this.driver.createSchemaBuilder().build()}async dropDatabase(){const e=this.createQueryRunner();try{if(this.driver.options.type==="mssql"||J.isMySQLFamily(this.driver)||this.driver.options.type==="aurora-mysql"||J.isSQLiteFamily(this.driver)){const t=[];if(this.entityMetadatas.forEach(n=>{n.database&&t.indexOf(n.database)===-1&&t.push(n.database)}),t.length===0&&this.driver.database&&t.push(this.driver.database),t.length===0)await e.clearDatabase();else for(const n of t)await e.clearDatabase(n)}else await e.clearDatabase()}finally{await e.release()}}async runMigrations(e){if(!this.isInitialized)throw new Rt(this.name);const t=new pr(this);return t.transaction=e?.transaction||this.options?.migrationsTransactionMode||"all",t.fake=e&&e.fake||!1,await t.executePendingMigrations()}async undoLastMigration(e){if(!this.isInitialized)throw new Rt(this.name);const t=new pr(this);t.transaction=e&&e.transaction||"all",t.fake=e&&e.fake||!1,await t.undoLastMigration()}async showMigrations(){if(!this.isInitialized)throw new Rt(this.name);return await new pr(this).showMigrations()}hasMetadata(e){return!!this.findMetadata(e)}getMetadata(e){const t=this.findMetadata(e);if(!t)throw new ra(e);return t}getRepository(e){return this.manager.getRepository(e)}getTreeRepository(e){return this.manager.getTreeRepository(e)}getMongoRepository(e){if(this.driver.options.type!=="mongodb")throw new M("You can use getMongoRepository only for MongoDB connections.");return this.manager.getRepository(e)}getCustomRepository(e){return this.manager.getCustomRepository(e)}async transaction(e,t){return this.manager.transaction(e,t)}async query(e,t,n){if(q.isMongoEntityManager(this.manager))throw new M("Queries aren't supported by MongoDB.");if(n&&n.isReleased)throw new As;const r=n||this.createQueryRunner();try{return await r.query(e,t)}finally{n||await r.release()}}async sql(e,...t){const{query:n,parameters:r}=Xt({driver:this.driver,strings:e,expressions:t});return await this.query(n,r)}createQueryBuilder(e,t,n){if(q.isMongoEntityManager(this.manager))throw new M("Query Builder is not supported by MongoDB.");if(t){t=J.buildAlias(this.driver,void 0,t);const r=this.getMetadata(e);return new xt(this,n).select(t).from(r.target,t)}else return new xt(this,e)}createQueryRunner(e="master"){const t=this.driver.createQueryRunner(e),n=this.createEntityManager(t);return Object.assign(t,{manager:n}),t}getManyToManyMetadata(e,t){const n=this.getMetadata(e).findRelationWithPropertyPath(t);if(!n)throw new M(`Relation "${t}" was not found in ${e} entity.`);if(!n.isManyToMany)throw new M(`Relation "${e}#${t}" does not have a many-to-many relationship.You can use this method only on many-to-many relations.`);return n.junctionEntityMetadata}createEntityManager(e){return new dc().create(this,e)}findMetadata(e){const t=this.entityMetadatasMap.get(e);if(t)return t;for(const[n,r]of this.entityMetadatasMap){if(q.isEntitySchema(e)&&r.name===e.options.name)return r;if(typeof e=="string"){if(e.indexOf(".")!==-1){if(r.tablePath===e)return r}else if(r.name===e||r.tableName===e)return r}if(me.isObjectWithName(e)&&typeof e.name=="string"){if(e.name.indexOf(".")!==-1){if(r.tablePath===e.name)return r}else if(r.name===e.name||r.tableName===e.name)return r}}}async buildMetadatas(){const e=new Gc(this),t=new $o,n=me.mixedListToArray(this.options.subscribers||[]),r=await e.buildSubscribers(n);me.assign(this,{subscribers:r});const i=me.mixedListToArray(this.options.entities||[]),s=await e.buildEntityMetadatas(i);me.assign(this,{entityMetadatas:s,entityMetadatasMap:new Map(s.map(c=>[c.target,c]))});const a=me.mixedListToArray(this.options.migrations||[]),o=await e.buildMigrations(a);me.assign(this,{migrations:o}),t.validateMany(this.entityMetadatas.filter(c=>c.tableType!=="view"),this.driver);for(const c of s)q.isBaseEntityConstructor(c.target)&&c.target.useDataSource(this)}defaultReplicationModeForReads(){if("replication"in this.driver.options&&this.driver.options.replication){const e=this.driver.options.replication.defaultMode;if(e)return e}return"slave"}}function zt(){const d=ve.getGlobalVariable();return d.typeormMetadataArgsStorage||(d.typeormMetadataArgsStorage=new gs),d.typeormMetadataArgsStorage}class Ws{configPath=(void 0)(process.cwd(),"data","connections.json");activeConnections=new Map;async init(){const e=(void 0)(this.configPath);(void 0)(e)||(void 0)(e,{recursive:!0})}async getAllConnections(){try{if(!(void 0)(this.configPath))return[];const e=(void 0)(this.configPath,"utf8");return JSON.parse(e)}catch(e){return console.error(":",e),[]}}async getConnectionById(e){return(await this.getAllConnections()).find(n=>n.id===e)||null}async addConnection(e){const t=await this.getAllConnections();if(t.find(n=>n.name===e.name))throw new Error("");return e.id=this.generateId(),e.createdAt=new Date,e.updatedAt=new Date,e.enabled=e.enabled!==void 0?e.enabled:!0,t.push(e),await this.saveConnections(t),e}async updateConnection(e,t){const n=await this.getAllConnections(),r=n.findIndex(i=>i.id===e);if(r===-1)throw new Error("");if(t.name&&n.find((i,s)=>i.name===t.name&&s!==r))throw new Error("");return n[r]={...n[r],...t,updatedAt:new Date},await this.saveConnections(n),n[r]}async deleteConnection(e){const t=await this.getAllConnections(),n=t.filter(r=>r.id!==e);if(n.length===t.length)throw new Error("");this.activeConnections.has(e)&&(await this.activeConnections.get(e)?.destroy(),this.activeConnections.delete(e)),await this.saveConnections(n)}async testConnection(e){try{console.log("test",e);const t=await this.createTypeORMDataSource(e);return await t.query("SELECT 1"),await t.destroy(),!0}catch(t){return console.error(t),!1}}async getActiveConnection(e,t){const n=t?`${e}_${t}`:e;if(this.activeConnections.has(n)){const a=this.activeConnections.get(n);if(a?.isInitialized)return a;this.activeConnections.delete(n)}if(this.activeConnections.size>=10){const a=this.activeConnections.keys().next().value||"",o=this.activeConnections.get(a);try{await o?.destroy()}catch(c){console.error(` ${a} :`,c)}this.activeConnections.delete(a)}const r=await this.getConnectionById(e);if(!r)throw new Error("");const i={...r,database:t||r.database},s=await this.createTypeORMDataSource(i);return this.activeConnections.set(n,s),s}async closeConnection(e,t){const n=t?`${e}_${t}`:e;this.activeConnections.has(n)&&(await this.activeConnections.get(n)?.destroy(),this.activeConnections.delete(n)),t&&this.activeConnections.has(e)&&(await this.activeConnections.get(e)?.destroy(),this.activeConnections.delete(e))}async closeAllConnectionsForId(e){const t=[];for(const[n,r]of this.activeConnections)if(n.startsWith(e+"_")||n===e)try{await r.destroy(),t.push(n)}catch(i){console.error(` ${n} :`,i)}t.forEach(n=>this.activeConnections.delete(n))}async closeAllConnections(){for(const[e,t]of this.activeConnections)try{await t.destroy()}catch(n){console.error(` ${e} :`,n)}this.activeConnections.clear()}async createTypeORMDataSource(e){const t=this.getTypeORMOptions(e);return new su(t).initialize()}getTypeORMOptions(e){const t={type:e.type,host:e.host,port:e.port,username:e.username,password:e.password,database:e.database,synchronize:!1,logging:!1,...e.options};switch(e.type.toLowerCase()){case"sqlite":return{...t,type:"sqlite",database:e.database,host:void 0,port:void 0,username:void 0,password:void 0};case"postgres":case"postgresql":return{...t,type:"postgres",ssl:e.options?.ssl||!1};case"oracle":return{...t,type:"oracle",connectString:`${e.host}:${e.port}/${e.database}`,host:void 0,port:void 0,database:void 0,extra:{connectionTimeout:6e4,poolMax:10,poolMin:1,poolIncrement:1}};case"mssql":case"sqlserver":return{...t,type:"mssql",options:{encrypt:e.options?.encrypt||!1,trustServerCertificate:!0},extra:{connectionTimeout:6e4,requestTimeout:15e3}};default:return t}}async saveConnections(e){try{(void 0)(this.configPath,JSON.stringify(e,null,2),"utf8")}catch(t){throw console.error(":",t),t}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}}class Ot{async getDatabaseInfo(e,t){const n=await this.getTables(e,t);return{name:t,tableCount:n.length,size:await this.getDatabaseSize(e,t),tables:n}}async getTableInfo(e,t,n){const i=(await this.getTables(e,t)).find(s=>s.name===n);if(!i)throw new Error(` ${n} `);return i.columns=await this.getColumns(e,t,n),i.indexes=await this.getIndexes(e,t,n),i.foreignKeys=await this.getForeignKeys(e,t,n),i}async getTableData(e,t,n,r=1,i=100,s,a){let o=`SELECT * FROM ${this.quoteIdentifier(n)}`;s&&(o+=` WHERE ${s}`),a&&(o+=` ORDER BY ${a}`);const c=(r-1)*i;o+=` LIMIT ${i} OFFSET ${c}`;const u=await e.query(o);let l=`SELECT COUNT(*) as total FROM ${this.quoteIdentifier(n)}`;s&&(l+=` WHERE ${s}`);const f=(await e.query(l))[0]?.total||0;return{data:u,total:f}}async executeQuery(e,t){return await e.query(t)}async testConnection(e){try{return await e.query("SELECT 1"),!0}catch(t){return console.error(t),!1}}quoteIdentifier(e){return`"${e}"`}buildPaginationQuery(e,t,n){const r=(t-1)*n;return`${e} LIMIT ${n} OFFSET ${r}`}buildCountQuery(e){return`SELECT COUNT(*) as total FROM (${e}) as count_query`}async getViews(e,t){throw new Error(` ${this.getDatabaseType()} `)}async getViewDefinition(e,t,n){throw new Error(` ${this.getDatabaseType()} `)}async getProcedures(e,t){throw new Error(` ${this.getDatabaseType()} `)}async getProcedureDefinition(e,t,n){throw new Error(` ${this.getDatabaseType()} `)}async createDatabase(e,t,n){throw new Error(` ${this.getDatabaseType()} `)}async dropDatabase(e,t){throw new Error(` ${this.getDatabaseType()} `)}}class au extends Ot{getDatabaseType(){return"mysql"}async getDatabases(e){return(await e.query("SHOW DATABASES")).map(n=>n.Database)}async getTables(e,t){return(await e.query(`
      SELECT 
        TABLE_NAME as name,
        TABLE_TYPE as type,
        ENGINE as engine,
        TABLE_ROWS as rowCount,
        DATA_LENGTH as dataSize,
        INDEX_LENGTH as indexSize,
        TABLE_COLLATION as collation,
        CREATE_TIME as createdAt,
        UPDATE_TIME as updatedAt,
        TABLE_COMMENT as comment
      FROM information_schema.TABLES 
      WHERE TABLE_SCHEMA = ?
    `,[t])).map(r=>({name:r.name,type:r.type,engine:r.engine,rowCount:r.rowCount||0,dataSize:r.dataSize||0,indexSize:r.indexSize||0,collation:r.collation,createdAt:r.createdAt,updatedAt:r.updatedAt,comment:r.comment}))}async getColumns(e,t,n){return(await e.query(`
      SELECT 
        COLUMN_NAME as name,
        COLUMN_TYPE as type,
        IS_NULLABLE as nullable,
        COLUMN_DEFAULT as defaultValue,
        COLUMN_KEY as columnKey,
        EXTRA as extra,
        CHARACTER_MAXIMUM_LENGTH as length,
        CHARACTER_SET_NAME as charset,
        COLLATION_NAME as collation,
        COLUMN_COMMENT as comment
      FROM information_schema.COLUMNS 
      WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ?
    `,[t,n])).map(i=>{const s=i.type||"";let a,o;const c=s.match(/(DECIMAL|NUMERIC)\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/i);return c&&(a=parseInt(c[2]),o=parseInt(c[3])),{name:i.name,type:i.type,nullable:i.nullable==="YES",defaultValue:i.defaultValue,isPrimary:i.columnKey==="PRI",isAutoIncrement:i.extra?.includes("auto_increment")||!1,length:i.length,precision:a,scale:o,charset:i.charset,collation:i.collation,comment:i.comment}})}async getIndexes(e,t,n){const r=await e.query(`
      SELECT 
        INDEX_NAME as name,
        INDEX_TYPE as type,
        COLUMN_NAME as columnName
      FROM information_schema.STATISTICS 
      WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ?
      ORDER BY INDEX_NAME, SEQ_IN_INDEX
    `,[t,n]),i=new Map;return r.forEach(s=>{if(!i.has(s.name)){let a=!1;s.name==="PRIMARY"?a=!0:a=s.name.toUpperCase().includes("UNIQUE")||s.type==="UNIQUE",i.set(s.name,{name:s.name,type:s.type,columns:[],unique:a})}i.get(s.name).columns.push(s.columnName)}),Array.from(i.values())}async getForeignKeys(e,t,n){return(await e.query(`
      SELECT 
        kcu.CONSTRAINT_NAME as name,
        kcu.COLUMN_NAME as columnName,
        kcu.REFERENCED_TABLE_NAME as referencedTable,
        kcu.REFERENCED_COLUMN_NAME as referencedColumn,
        rc.DELETE_RULE as onDelete,
        rc.UPDATE_RULE as onUpdate
      FROM information_schema.KEY_COLUMN_USAGE kcu
      LEFT JOIN information_schema.REFERENTIAL_CONSTRAINTS rc 
        ON kcu.CONSTRAINT_NAME = rc.CONSTRAINT_NAME 
        AND kcu.CONSTRAINT_SCHEMA = rc.CONSTRAINT_SCHEMA
      WHERE kcu.TABLE_SCHEMA = ? 
        AND kcu.TABLE_NAME = ?
        AND kcu.REFERENCED_TABLE_NAME IS NOT NULL
    `,[t,n])).map(i=>({name:i.name,column:i.columnName,referencedTable:i.referencedTable,referencedColumn:i.referencedColumn,onDelete:i.onDelete||"NO ACTION",onUpdate:i.onUpdate||"NO ACTION"}))}async getDatabaseSize(e,t){return(await e.query(`
      SELECT SUM(data_length + index_length) as size
      FROM information_schema.tables 
      WHERE table_schema = ?
    `,[t]))[0]?.size||0}quoteIdentifier(e){return`\`${e}\``}async getViews(e,t){return(await e.query(`
      SELECT 
        TABLE_NAME as name,
        TABLE_SCHEMA as schemaName
      FROM information_schema.VIEWS 
      WHERE TABLE_SCHEMA = ?
      ORDER BY TABLE_NAME
    `,[t])).map(r=>({name:r.name,comment:"",schemaName:r.schemaName}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT VIEW_DEFINITION as definition
      FROM information_schema.VIEWS 
      WHERE TABLE_SCHEMA = ? 
      AND TABLE_NAME = ?
    `,[t,n]))[0]?.definition||""}async getProcedures(e,t){return(await e.query(`
      SELECT 
        ROUTINE_NAME as name,
        ROUTINE_TYPE as type,
        ROUTINE_COMMENT as comment
      FROM information_schema.ROUTINES 
      WHERE ROUTINE_SCHEMA = ?
      ORDER BY ROUTINE_NAME
    `,[t])).map(r=>({name:r.name,comment:r.comment||"",type:r.type,returnType:"",language:"SQL"}))}async getProcedureDefinition(e,t,n){return(await e.query(`
      SELECT ROUTINE_DEFINITION as definition
      FROM information_schema.ROUTINES 
      WHERE ROUTINE_SCHEMA = ? 
      AND ROUTINE_NAME = ?
    `,[t,n]))[0]?.definition||""}async createDatabase(e,t,n){let r=`CREATE DATABASE ${this.quoteIdentifier(t)}`;if(n){const i=[];n.charset&&i.push(`CHARACTER SET ${n.charset}`),n.collation&&i.push(`COLLATE ${n.collation}`),i.length>0&&(r+=" "+i.join(" "))}await e.query(r)}async dropDatabase(e,t){const n=`DROP DATABASE ${this.quoteIdentifier(t)}`;await e.query(n)}}class ou extends Ot{getDatabaseType(){return"postgres"}async getDatabases(e){return(await e.query(`
      SELECT datname as name 
      FROM pg_database 
      WHERE datistemplate = false
    `)).map(n=>n.name)}async getTables(e,t){return(await e.query(`
      SELECT 
        t.table_name as name,
        'BASE TABLE' as type,
        (SELECT COUNT(*) FROM information_schema.columns WHERE table_name = t.table_name) as rowCount,
        0 as dataSize,
        0 as indexSize,
        '' as collation,
        obj_description(c.oid) as comment
      FROM information_schema.tables t
      LEFT JOIN pg_class c ON c.relname = t.table_name
      WHERE t.table_schema NOT IN ('information_schema', 'pg_catalog')
        AND t.table_type = 'BASE TABLE'
    `)).map(r=>({name:r.name,type:r.type,rowCount:r.rowcount||0,dataSize:r.datasize||0,indexSize:r.indexsize||0,collation:r.collation,comment:r.comment}))}async getColumns(e,t,n){const r=await e.query(`
      SELECT 
        column_name as name,
        data_type as type,
        is_nullable as nullable,
        column_default as defaultValue,
        character_maximum_length as length
      FROM information_schema.columns 
      WHERE table_name = $1
    `,[n]),i=await this.getPrimaryKeys(e,n);return r.map(s=>{const a=s.type||"";let o,c;const u=a.match(/(DECIMAL|NUMERIC)\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/i);return u&&(o=parseInt(u[2]),c=parseInt(u[3])),{name:s.name,type:s.type,nullable:s.nullable==="YES",defaultValue:s.defaultValue,isPrimary:i.includes(s.name),isAutoIncrement:s.defaultValue?.includes("nextval")||!1,length:s.length,precision:o,scale:c}})}async getIndexes(e,t,n){return(await e.query(`
      SELECT 
        indexname as name,
        indexdef as definition
      FROM pg_indexes 
      WHERE tablename = $1
    `,[n])).map(i=>({name:i.name,type:"INDEX",columns:[],unique:i.definition.toLowerCase().includes("unique")}))}async getForeignKeys(e,t,n){return(await e.query(`
      SELECT 
        tc.constraint_name as name,
        kcu.column_name as column,
        ccu.table_name as referencedTable,
        ccu.column_name as referencedColumn,
        rc.delete_rule as onDelete
      FROM information_schema.table_constraints tc
      JOIN information_schema.key_column_usage kcu
        ON tc.constraint_name = kcu.constraint_name
      JOIN information_schema.constraint_column_usage ccu
        ON ccu.constraint_name = tc.constraint_name
      JOIN information_schema.referential_constraints rc
        ON tc.constraint_name = rc.constraint_name
      WHERE tc.constraint_type = 'FOREIGN KEY' 
        AND tc.table_name = $1
    `,[n])).map(i=>({name:i.name,column:i.column,referencedTable:i.referencedtable,referencedColumn:i.referencedcolumn,onDelete:i.ondelete,onUpdate:"NO ACTION"}))}async getDatabaseSize(e,t){return(await e.query(`
      SELECT pg_database_size($1) as size
    `,[t]))[0]?.size||0}async getPrimaryKeys(e,t){return(await e.query(`
      SELECT column_name 
      FROM information_schema.table_constraints tc
      JOIN information_schema.key_column_usage kcu
        ON tc.constraint_name = kcu.constraint_name
      WHERE tc.constraint_type = 'PRIMARY KEY' 
        AND tc.table_name = $1
    `,[t])).map(r=>r.column_name)}quoteIdentifier(e){return`"${e}"`}async getViews(e,t){return(await e.query(`
      SELECT 
        table_name as name,
        COALESCE(obj_description(c.oid), '') as comment,
        table_schema as schemaName
      FROM information_schema.views v
      LEFT JOIN pg_class c ON c.relname = v.table_name
      WHERE v.table_schema NOT IN ('information_schema', 'pg_catalog')
      ORDER BY v.table_name
    `)).map(r=>({name:r.name,comment:r.comment||"",schemaName:r.schemaname}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT view_definition as definition
      FROM information_schema.views 
      WHERE table_name = $1
        AND table_schema NOT IN ('information_schema', 'pg_catalog')
    `,[n]))[0]?.definition||""}async getProcedures(e,t){return(await e.query(`
      SELECT 
        routine_name as name,
        COALESCE(routine_comment, '') as comment,
        routine_type as type,
        COALESCE(data_type, '') as returnType,
        external_language as language
      FROM information_schema.routines 
      WHERE routine_schema NOT IN ('information_schema', 'pg_catalog')
      ORDER BY routine_name
    `)).map(r=>({name:r.name,comment:r.comment||"",type:r.type,returnType:r.returntype||"",language:r.language||"SQL"}))}async getProcedureDefinition(e,t,n){return(await e.query(`
      SELECT routine_definition as definition
      FROM information_schema.routines 
      WHERE routine_name = $1
        AND routine_schema NOT IN ('information_schema', 'pg_catalog')
    `,[n]))[0]?.definition||""}async createDatabase(e,t,n){let r=`CREATE DATABASE ${this.quoteIdentifier(t)}`;if(n){const i=[];n.owner&&i.push(`OWNER ${n.owner}`),n.template&&i.push(`TEMPLATE ${n.template}`),n.encoding&&i.push(`ENCODING '${n.encoding}'`),n.lcCollate&&i.push(`LC_COLLATE '${n.lcCollate}'`),n.lcCtype&&i.push(`LC_CTYPE '${n.lcCtype}'`),n.tablespace&&i.push(`TABLESPACE ${n.tablespace}`),n.allowConnections!==void 0&&i.push(`ALLOW_CONNECTIONS ${n.allowConnections}`),n.connectionLimit!==void 0&&i.push(`CONNECTION LIMIT ${n.connectionLimit}`),i.length>0&&(r+=" "+i.join(" "))}await e.query(r)}async dropDatabase(e,t){const n=`DROP DATABASE ${this.quoteIdentifier(t)}`;await e.query(n)}}class cu extends Ot{getDatabaseType(){return"sqlite"}async getDatabases(e){return["main"]}async getTables(e,t){return(await e.query(`
      SELECT 
        tbl_name as name,
        'table' as type,
        sql as definition
      FROM sqlite_master 
      WHERE type = 'table' AND tbl_name NOT LIKE 'sqlite_%'
    `)).map(r=>({name:r.name,type:r.type,rowCount:0,dataSize:0,indexSize:0}))}async getColumns(e,t,n){return(await e.query(`PRAGMA table_info(${n})`)).map(i=>({name:i.name,type:i.type,nullable:i.notnull===0,defaultValue:i.dflt_value,isPrimary:i.pk===1,isAutoIncrement:!1}))}async getIndexes(e,t,n){return(await e.query(`PRAGMA index_list(${n})`)).map(i=>({name:i.name,type:i.unique?"UNIQUE":"INDEX",columns:[],unique:i.unique===1}))}async getForeignKeys(e,t,n){return(await e.query(`PRAGMA foreign_key_list(${n})`)).map(i=>({name:`fk_${n}_${i.table}`,column:i.from,referencedTable:i.table,referencedColumn:i.to,onDelete:i.on_delete||"NO ACTION",onUpdate:i.on_update||"NO ACTION"}))}async getDatabaseSize(e,t){return 0}async getViews(e,t){return(await e.query(`
      SELECT 
        name,
        sql as definition
      FROM sqlite_master 
      WHERE type = 'view' AND name NOT LIKE 'sqlite_%'
      ORDER BY name
    `)).map(r=>({name:r.name,comment:"",schemaName:"main",definition:r.definition}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT sql as definition
      FROM sqlite_master 
      WHERE type = 'view' AND name = $1
    `,[n]))[0]?.definition||""}async getProcedures(e,t){return[]}async getProcedureDefinition(e,t,n){throw new Error("SQLite")}async createDatabase(e,t,n){throw new Error("SQLite")}async dropDatabase(e,t){throw new Error("SQLite")}}class uu extends Ot{getDatabaseType(){return"oracle"}async getDatabases(e){return(await e.query(`
      SELECT username as name 
      FROM all_users 
      WHERE username NOT IN ('SYS', 'SYSTEM', 'XDB', 'OUTLN')
      ORDER BY username
    `)).map(n=>n.name)}async getTables(e,t){const n=await e.query(`
      SELECT 
        table_name as name,
        'TABLE' as type
      FROM all_tables 
      WHERE owner = ? 
        AND table_name NOT LIKE 'BIN$%'
        AND temporary = 'N'
      ORDER BY table_name
    `,[t.toUpperCase()]),r=[];for(const i of n){const s=await this.getTableStats(e,t,i.name);r.push({name:i.name,type:i.type,rowCount:s.rowCount,dataSize:s.dataSize,indexSize:s.indexSize})}return r}async getColumns(e,t,n){const r=await e.query(`
      SELECT 
        column_name as name,
        data_type as type,
        data_length as length,
        nullable as nullable,
        data_default as defaultValue
      FROM all_tab_columns 
      WHERE owner = ? 
        AND table_name = ?
      ORDER BY column_id
    `,[t.toUpperCase(),n.toUpperCase()]),i=await this.getPrimaryKeys(e,t,n);return r.map(s=>{const a=s.type||"";let o,c;const u=a.match(/(DECIMAL|NUMBER)\s*\(\s*(\d+)\s*(,\s*(\d+)\s*)?\s*\)/i);return u&&(o=parseInt(u[2]),u[3]&&(c=parseInt(u[3].replace(/\D/g,"")))),{name:s.name,type:s.type+(s.length?`(${s.length})`:""),nullable:s.nullable==="Y",defaultValue:s.defaultValue,isPrimary:i.includes(s.name),isAutoIncrement:!1,length:s.length,precision:o,scale:c}})}async getIndexes(e,t,n){const r=await e.query(`
      SELECT DISTINCT 
        i.index_name as name,
        DECODE(i.uniqueness, 'UNIQUE', 'UNIQUE INDEX', 'INDEX') as type,
        ic.column_name as column
      FROM all_indexes i
      JOIN all_ind_columns ic ON i.index_name = ic.index_name
      WHERE i.table_owner = ? 
        AND i.table_name = ?
        AND i.index_name NOT IN (SELECT constraint_name 
                               FROM all_constraints 
                               WHERE constraint_type = 'P' 
                               AND table_owner = ?)
      ORDER BY i.index_name, ic.column_position
    `,[t.toUpperCase(),n.toUpperCase(),t.toUpperCase()]),i=new Map;return r.forEach(s=>{i.has(s.name)||i.set(s.name,{name:s.name,type:s.type,columns:[],unique:s.type.includes("UNIQUE")}),i.get(s.name).columns.push(s.column)}),Array.from(i.values())}async getForeignKeys(e,t,n){return(await e.query(`
      SELECT 
        c.constraint_name as name,
        cc.column_name as column,
        r.table_name as referencedTable,
        rc.column_name as referencedColumn,
        c.delete_rule as onDelete
      FROM all_constraints c
      JOIN all_cons_columns cc ON c.constraint_name = cc.constraint_name
      JOIN all_constraints r ON c.r_constraint_name = r.constraint_name
      JOIN all_cons_columns rc ON r.constraint_name = rc.constraint_name AND cc.position = rc.position
      WHERE c.constraint_type = 'R'
        AND c.owner = ? 
        AND c.table_name = ?
    `,[t.toUpperCase(),n.toUpperCase()])).map(i=>({name:i.name,column:i.column,referencedTable:i.referencedTable,referencedColumn:i.referencedColumn,onDelete:i.onDelete||"NO ACTION",onUpdate:"NO ACTION"}))}async getDatabaseSize(e,t){return(await e.query(`
      SELECT SUM(bytes) as size
      FROM user_segments
    `))[0]?.size||0}async getTableStats(e,t,n){try{const r=await e.query(`
        SELECT 
          num_rows as rowCount,
          (SELECT SUM(bytes) FROM user_segments WHERE segment_name = ?) as dataSize
        FROM all_tables
        WHERE owner = ? AND table_name = ?
      `,[n.toUpperCase(),t.toUpperCase(),n.toUpperCase()]);return{rowCount:r[0]?.rowCount||0,dataSize:r[0]?.dataSize||0,indexSize:0}}catch{return{rowCount:0,dataSize:0,indexSize:0}}}async getPrimaryKeys(e,t,n){return(await e.query(`
      SELECT column_name
      FROM all_cons_columns cc
      JOIN all_constraints c ON cc.constraint_name = c.constraint_name
      WHERE c.constraint_type = 'P'
        AND c.owner = ? 
        AND c.table_name = ?
      ORDER BY cc.position
    `,[t.toUpperCase(),n.toUpperCase()])).map(i=>i.column_name)}quoteIdentifier(e){return`"${e.toUpperCase()}"`}async getViews(e,t){return(await e.query(`
      SELECT 
        view_name as name,
        '' as comment
      FROM all_views 
      WHERE owner = ?
      ORDER BY view_name
    `,[t.toUpperCase()])).map(r=>({name:r.name,comment:r.comment||"",schemaName:t}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT text as definition
      FROM all_views 
      WHERE owner = ? 
        AND view_name = ?
    `,[t.toUpperCase(),n.toUpperCase()]))[0]?.definition||""}async getProcedures(e,t){return(await e.query(`
      SELECT 
        object_name as name,
        '' as comment,
        'PROCEDURE' as type,
        '' as returnType,
        'PL/SQL' as language
      FROM all_objects 
      WHERE owner = ? 
        AND object_type IN ('PROCEDURE', 'FUNCTION')
        AND status = 'VALID'
      ORDER BY object_name
    `,[t.toUpperCase()])).map(r=>({name:r.name,comment:r.comment||"",type:r.type,returnType:r.returnType||"",language:r.language||"PL/SQL"}))}async getProcedureDefinition(e,t,n){return(await e.query(`
      SELECT text as definition
      FROM all_source 
      WHERE owner = ? 
        AND name = ?
      ORDER BY line
    `,[t.toUpperCase(),n.toUpperCase()])).map(i=>i.definition).join(`
`)||""}async createDatabase(e,t,n){let r=`CREATE DATABASE ${this.quoteIdentifier(t)}`;if(n){const i=[];n.user&&i.push(`USER ${n.user}`),n.password&&i.push(`IDENTIFIED BY ${n.password}`),n.defaultTablespace&&i.push(`DEFAULT TABLESPACE ${n.defaultTablespace}`),n.tempTablespace&&i.push(`TEMPORARY TABLESPACE ${n.tempTablespace}`),n.datafile&&i.push(`DATAFILE '${n.datafile}'`),n.size&&i.push(`SIZE ${n.size}`),n.autoExtend&&i.push("AUTOEXTEND ON"),i.length>0&&(r+=" "+i.join(" "))}await e.query(r)}async dropDatabase(e,t){const n=`DROP DATABASE ${this.quoteIdentifier(t)}`;await e.query(n)}}class lu extends Ot{getDatabaseType(){return"mssql"}async getDatabases(e){return(await e.query(`
      SELECT name 
      FROM sys.databases 
      WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb')
        AND state = 0
      ORDER BY name
    `)).map(n=>n.name)}async getTables(e,t){return(await e.query(`
      SELECT 
        t.name,
        'BASE TABLE' as type,
        p.rows as rowCount,
        SUM(a.total_pages) * 8 * 1024 as dataSize
      FROM ${this.quoteIdentifier(t)}.sys.tables t
      INNER JOIN ${this.quoteIdentifier(t)}.sys.partitions p ON t.object_id = p.object_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.allocation_units a ON p.partition_id = a.container_id
      WHERE t.is_ms_shipped = 0
        AND p.index_id IN (0, 1)
      GROUP BY t.name, p.rows
      ORDER BY t.name
    `)).map(r=>({name:r.name,type:r.type,rowCount:r.rowCount||0,dataSize:r.dataSize||0,indexSize:0}))}async getColumns(e,t,n){const r=await e.query(`
      SELECT 
        c.name,
        t.name as type,
        c.max_length as length,
        c.precision,
        c.scale,
        c.is_nullable as nullable,
        c.default_object_id,
        COLUMNPROPERTY(c.object_id, c.name, 'IsIdentity') as isIdentity
      FROM ${this.quoteIdentifier(t)}.sys.columns c
      INNER JOIN ${this.quoteIdentifier(t)}.sys.types t ON c.user_type_id = t.user_type_id
      WHERE c.object_id = OBJECT_ID(?)
      ORDER BY c.column_id
    `,[`${t}.${n}`]),i=await this.getPrimaryKeys(e,t,n);return r.map(s=>({name:s.name,type:s.type,nullable:s.nullable,defaultValue:s.default_object_id?"DEFAULT":null,isPrimary:i.includes(s.name),isAutoIncrement:s.isIdentity===1,length:s.length,precision:s.precision,scale:s.scale}))}async getIndexes(e,t,n){const r=await e.query(`
      SELECT 
        i.name,
        i.type_desc as type,
        c.name as column,
        i.is_unique as isUnique
      FROM ${this.quoteIdentifier(t)}.sys.indexes i
      INNER JOIN ${this.quoteIdentifier(t)}.sys.index_columns ic ON i.object_id = ic.object_id AND i.index_id = ic.index_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id
      WHERE i.object_id = OBJECT_ID(?)
        AND i.is_primary_key = 0
      ORDER BY i.name, ic.key_ordinal
    `,[`${t}.${n}`]),i=new Map;return r.forEach(s=>{i.has(s.name)||i.set(s.name,{name:s.name,type:s.type,columns:[],unique:s.isUnique}),i.get(s.name).columns.push(s.column)}),Array.from(i.values())}async getForeignKeys(e,t,n){return(await e.query(`
      SELECT 
        fk.name as name,
        c.name as column,
        rt.name as referencedTable,
        rc.name as referencedColumn,
        fk.delete_action_desc as onDelete,
        fk.update_action_desc as onUpdate
      FROM ${this.quoteIdentifier(t)}.sys.foreign_keys fk
      INNER JOIN ${this.quoteIdentifier(t)}.sys.foreign_key_columns fkc ON fk.object_id = fkc.constraint_object_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.columns c ON fkc.parent_object_id = c.object_id AND fkc.parent_column_id = c.column_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.columns rc ON fkc.referenced_object_id = rc.object_id AND fkc.referenced_column_id = rc.column_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.tables rt ON fkc.referenced_object_id = rt.object_id
      WHERE fkc.parent_object_id = OBJECT_ID(?)
    `,[`${t}.${n}`])).map(i=>({name:i.name,column:i.column,referencedTable:i.referencedTable,referencedColumn:i.referencedColumn,onDelete:i.onDelete,onUpdate:i.onUpdate}))}async getDatabaseSize(e,t){return(await e.query(`
      SELECT SUM(size * 8 * 1024) as size
      FROM sys.master_files
      WHERE database_id = DB_ID(?)
    `,[t]))[0]?.size||0}async getPrimaryKeys(e,t,n){return(await e.query(`
      SELECT c.name
      FROM ${this.quoteIdentifier(t)}.sys.key_constraints k
      INNER JOIN ${this.quoteIdentifier(t)}.sys.index_columns ic ON k.parent_object_id = ic.object_id AND k.unique_index_id = ic.index_id
      INNER JOIN ${this.quoteIdentifier(t)}.sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id
      WHERE k.type = 'PK'
        AND k.parent_object_id = OBJECT_ID(?)
      ORDER BY ic.key_ordinal
    `,[`${t}.${n}`])).map(i=>i.name)}quoteIdentifier(e){return`[${e}]`}async getViews(e,t){return(await e.query(`
      SELECT 
        TABLE_NAME as name,
        '' as comment,
        TABLE_SCHEMA as schemaName
      FROM ${this.quoteIdentifier(t)}.INFORMATION_SCHEMA.VIEWS
      ORDER BY TABLE_NAME
    `)).map(r=>({name:r.name,comment:r.comment||"",schemaName:r.schemaname}))}async getViewDefinition(e,t,n){return(await e.query(`
      SELECT VIEW_DEFINITION as definition
      FROM ${this.quoteIdentifier(t)}.INFORMATION_SCHEMA.VIEWS 
      WHERE TABLE_NAME = ?
    `,[n]))[0]?.definition||""}async getProcedures(e,t){return(await e.query(`
      SELECT 
        ROUTINE_NAME as name,
        '' as comment,
        ROUTINE_TYPE as type,
        '' as returnType,
        'SQL' as language
      FROM ${this.quoteIdentifier(t)}.INFORMATION_SCHEMA.ROUTINES 
      WHERE ROUTINE_SCHEMA NOT IN ('sys', 'INFORMATION_SCHEMA')
      ORDER BY ROUTINE_NAME
    `)).map(r=>({name:r.name,comment:r.comment||"",type:r.type,returnType:r.returnType||"",language:r.language||"SQL"}))}async getProcedureDefinition(e,t,n){return(await e.query(`
      SELECT ROUTINE_DEFINITION as definition
      FROM ${this.quoteIdentifier(t)}.INFORMATION_SCHEMA.ROUTINES 
      WHERE ROUTINE_NAME = ?
    `,[n]))[0]?.definition||""}async createDatabase(e,t,n){let r=`CREATE DATABASE ${this.quoteIdentifier(t)}`;if(n){const i=[];if(n.collation&&i.push(`COLLATE ${n.collation}`),n.containment&&i.push(`CONTAINMENT = ${n.containment}`),n.compatibilityLevel&&i.push(`COMPATIBILITY_LEVEL = ${n.compatibilityLevel}`),n.dataFiles){const s=n.dataFiles.map(a=>{let o=`(NAME = '${a.name}', FILENAME = '${a.filename}'`;return a.size&&(o+=`, SIZE = ${a.size}`),a.maxSize&&(o+=`, MAXSIZE = ${a.maxSize}`),a.growth&&(o+=`, FILEGROWTH = ${a.growth}`),o+=")",o});i.push(`ON ${s.join(", ")}`)}if(n.logFiles){const s=n.logFiles.map(a=>{let o=`(NAME = '${a.name}', FILENAME = '${a.filename}'`;return a.size&&(o+=`, SIZE = ${a.size}`),a.maxSize&&(o+=`, MAXSIZE = ${a.maxSize}`),a.growth&&(o+=`, FILEGROWTH = ${a.growth}`),o+=")",o});i.push(`LOG ON ${s.join(", ")}`)}i.length>0&&(r+=" "+i.join(" "))}await e.query(r)}async dropDatabase(e,t){const n=`DROP DATABASE ${this.quoteIdentifier(t)}`;await e.query(n)}}class hu{connectionService;mysqlService;postgreSQLService;sqliteService;oracleService;sqlServerService;constructor(){this.connectionService=new Ws,this.mysqlService=new au,this.postgreSQLService=new ou,this.sqliteService=new cu,this.oracleService=new uu,this.sqlServerService=new lu}getDatabaseService(e){switch(e.toLowerCase()){case"mysql":return this.mysqlService;case"postgres":case"postgresql":return this.postgreSQLService;case"sqlite":return this.sqliteService;case"oracle":return this.oracleService;case"mssql":case"sqlserver":return this.sqlServerService;default:throw new Error(`: ${e}`)}}async getDatabases(e){const t=await this.connectionService.getActiveConnection(e);return this.getDatabaseService(t.options.type).getDatabases(t)}async getDatabaseInfo(e,t){const n=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(n.options.type).getDatabaseInfo(n,t)}async getTables(e,t){const n=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(n.options.type).getTables(n,t)}async getTableInfo(e,t,n){const r=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(r.options.type).getTableInfo(r,t,n)}async getTableData(e,t,n,r=1,i=100,s,a){const o=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(o.options.type).getTableData(o,t,n,r,i,s,a)}async executeQuery(e,t,n){const r=await this.connectionService.getActiveConnection(e,n);return this.getDatabaseService(r.options.type).executeQuery(r,t)}async getViews(e,t){const n=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(n.options.type).getViews(n,t)}async getViewDefinition(e,t,n){const r=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(r.options.type).getViewDefinition(r,t,n)}async getProcedures(e,t){const n=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(n.options.type).getProcedures(n,t)}async getProcedureDefinition(e,t,n){const r=await this.connectionService.getActiveConnection(e,t);return this.getDatabaseService(r.options.type).getProcedureDefinition(r,t,n)}async testConnection(e){const t=await this.connectionService.getActiveConnection(e);return this.getDatabaseService(t.options.type).testConnection(t)}getSupportedDatabaseTypes(){return[{value:"mysql",label:"MySQL",icon:"bi-database",defaultPort:3306,description:"MySQL",features:{supportSchemas:!1,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0}},{value:"postgres",label:"PostgreSQL",icon:"bi-database",defaultPort:5432,description:"PostgreSQL",features:{supportSchemas:!0,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0,supportArrays:!0,supportEnum:!0}},{value:"sqlite",label:"SQLite",icon:"bi-database",defaultPort:null,description:"SQLite",features:{supportSchemas:!1,supportProcedures:!1,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!1,supportArrays:!1}},{value:"oracle",label:"Oracle",icon:"bi-database",defaultPort:1521,description:"Oracle",features:{supportSchemas:!0,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!1,supportArrays:!1,supportSequences:!0,supportSynonyms:!0}},{value:"mssql",label:"SQL Server",icon:"bi-database",defaultPort:1433,description:"Microsoft SQL Server",features:{supportSchemas:!1,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0,supportArrays:!1,supportStoredProcedures:!0}}]}async createDatabase(e,t,n){const r=await this.connectionService.getActiveConnection(e);return this.getDatabaseService(r.options.type).createDatabase(r,t,n)}async dropDatabase(e,t){const n=await this.connectionService.getActiveConnection(e);return this.getDatabaseService(n.options.type).dropDatabase(n,t)}getDatabaseTypeSpecificConfig(e){return{type:this.getDatabaseService(e).getDatabaseType(),features:this.getDatabaseFeatures(e)}}getDatabaseFeatures(e){switch(e.toLowerCase()){case"mysql":return{supportSchemas:!1,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0};case"postgres":case"postgresql":return{supportSchemas:!0,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0,supportArrays:!0,supportEnum:!0};case"sqlite":return{supportSchemas:!1,supportProcedures:!1,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!1,supportArrays:!1};case"oracle":return{supportSchemas:!0,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!1,supportArrays:!1,supportSequences:!0,supportSynonyms:!0};case"mssql":case"sqlserver":return{supportSchemas:!1,supportProcedures:!0,supportTriggers:!0,supportViews:!0,supportFullTextSearch:!0,supportJson:!0,supportArrays:!1,supportStoredProcedures:!0};default:return{}}}}const dt=new Ws,Ie=new hu;async function Cu(d,e){if(d==="/api/database/getConnections")return await dt.getAllConnections();if(d==="/api/database/getConnection"){const{id:t}=e;return await dt.getConnectionById(t)}if(d==="/api/database/addConnection")return await dt.addConnection(e);if(d==="/api/database/updateConnection"){const{id:t,...n}=e;if(!t)throw Error("Missing parameter: id");return await dt.updateConnection(t,n)}if(d==="/api/database/deleteConnection"){const{id:t}=e;if(!t)throw Error("Missing parameter: id");return await dt.deleteConnection(t),!0}if(d==="/api/database/testConnection")return await dt.testConnection(e);if(d==="/api/database/getDatabases"){const{id:t}=e;if(!t)throw Error("Missing parameter: id");return await Ie.getDatabases(t)}if(d==="/api/database/getDatabaseInfo"){const{id:t,database:n}=e;if(!t||!n)throw Error("Missing parameters: id, database");return await Ie.getDatabaseInfo(t,n)}if(d==="/api/database/getTables"){const{id:t,database:n}=e;if(!t||!n)throw Error("Missing parameters: id, database");return await Ie.getTables(t,n)}if(d==="/api/database/getTableInfo"){const{id:t,database:n,table:r}=e;if(!t||!n||!r)throw Error("Missing parameters: id, database, table");return await Ie.getTableInfo(t,n,r)}if(d==="/api/database/getTableData"){const{id:t,database:n,table:r,page:i=1,pageSize:s=100,where:a,orderBy:o}=e;if(!t||!n||!r)throw Error("Missing parameters: id, database, table");return await Ie.getTableData(t,n,r,i,s,a,o)}if(d==="/api/database/executeQuery"){const{id:t,sql:n,database:r}=e;if(!t||!n)throw Error("Missing parameters: id, sql");if(!n.trim())throw Error("SQL");return await Ie.executeQuery(t,n,r)}if(d==="/api/database/closeConnection"){const{id:t}=e;if(!t)throw Error("Missing parameter: id");return await dt.closeConnection(t),await dt.closeAllConnectionsForId(t),!0}if(d==="/api/database/getSupportedDatabaseTypes")return Ie.getSupportedDatabaseTypes();if(d==="/api/database/createDatabase"){const{id:t,databaseName:n,options:r}=e;if(!t||!n)throw Error("Missing parameters: id, databaseName");return await Ie.createDatabase(t,n,r),{success:!0}}if(d==="/api/database/dropDatabase"){const{id:t,databaseName:n}=e;if(!t||!n)throw Error("Missing parameters: id, databaseName");return await Ie.dropDatabase(t,n),{success:!0}}if(d==="/api/database/exportTableData"){const{id:t,database:n,table:r,format:i="json",where:s}=e;if(!t||!n||!r)throw Error("Missing parameters: id, database, table");return await Ie.getTableData(t,n,r,1,1e4,s)}if(d==="/api/database/saveTableStructure"){const{id:t,database:n,table:r,columns:i}=e;if(!t||!n||!r||!i)throw Error("Missing parameters");const s=pu(r.name,i,r),a=await Ie.executeQuery(t,s,n);return{success:!0,sql:s,result:a}}if(d==="/api/database/alterTable"){const{id:t,database:n,tableName:r,columns:i,oldColumns:s}=e;if(!t||!n||!r||!i)throw Error("Missing parameters");const a=du(r,i,s),o=[];for(const c of a){const u=await Ie.executeQuery(t,c,n);o.push({sql:c,result:u})}return{success:!0,statements:a,results:o}}if(d==="/api/database/insertData"){const{id:t,database:n,table:r,data:i}=e;if(!t||!n||!r||!i)throw Error("Missing parameters");const s=fu(r,i),a=await Ie.executeQuery(t,s,n);return{sql:s,result:a}}if(d==="/api/database/updateData"){const{id:t,database:n,table:r,data:i,where:s}=e;if(!t||!n||!r||!i||!s)throw Error("Missing parameters");const a=mu(r,i,s),o=await Ie.executeQuery(t,a,n);return{sql:a,result:o}}if(d==="/api/database/deleteData"){const{id:t,database:n,table:r,where:i}=e;if(!t||!n||!r||!i)throw Error("Missing parameters");const s=yu(r,i),a=await Ie.executeQuery(t,s,n);return{success:!0,sql:s,result:a}}if(d.startsWith("/api/database/truncateTable/")){const t=d.split("/").filter(Boolean);if(t.length<5)throw Error("Invalid URL format");const n=t[3],r=t[4],i=t[5];if(!n||!r||!i)throw Error("Missing parameters");const s=await Ie.connectionService.getActiveConnection(n,r),o=`TRUNCATE TABLE ${Ie.getDatabaseService(s.options.type).quoteIdentifier(i)}`,c=await Ie.executeQuery(n,o,r);return{success:!0,sql:o,result:c}}if(d.startsWith("/api/database/dropTable/")){const t=d.split("/").filter(Boolean);if(t.length<5)throw Error("Invalid URL format");const n=t[3],r=t[4],i=t[5];if(!n||!r||!i)throw Error("Missing parameters");const s=await Ie.connectionService.getActiveConnection(n,r),o=`DROP TABLE ${Ie.getDatabaseService(s.options.type).quoteIdentifier(i)}`,c=await Ie.executeQuery(n,o,r);return{success:!0,sql:o,result:c}}if(d==="/api/database/getViews"){const{id:t,database:n}=e;if(!t||!n)throw Error("Missing parameters: id, database");return await Ie.getViews(t,n)}if(d==="/api/database/getViewDefinition"){const{id:t,database:n,viewName:r}=e;if(!t||!n||!r)throw Error("Missing parameters: id, database, viewName");return await Ie.getViewDefinition(t,n,r)}if(d==="/api/database/createView"){const{id:t,database:n,viewName:r,definition:i}=e;if(!t||!n||!r||!i)throw Error("Missing parameters: id, database, viewName, definition");const s=await Ie.connectionService.getActiveConnection(t,n),o=`CREATE VIEW ${Ie.getDatabaseService(s.options.type).quoteIdentifier(r)} AS ${i}`,c=await Ie.executeQuery(t,o,n);return{success:!0,sql:o,result:c}}if(d==="/api/database/dropView"){const{id:t,database:n,viewName:r}=e;if(!t||!n||!r)throw Error("Missing parameters: id, database, viewName");const i=await Ie.connectionService.getActiveConnection(t,n),a=`DROP VIEW ${Ie.getDatabaseService(i.options.type).quoteIdentifier(r)}`,o=await Ie.executeQuery(t,a,n);return{success:!0,sql:a,result:o}}if(d==="/api/database/getProcedures"){const{id:t,database:n}=e;if(!t||!n)throw Error("Missing parameters: id, database");return await Ie.getProcedures(t,n)}if(d==="/api/database/getProcedureDefinition"){const{id:t,database:n,procedureName:r}=e;if(!t||!n||!r)throw Error("Missing parameters: id, database, procedureName");return await Ie.getProcedureDefinition(t,n,r)}throw Error("API endpoint not found")}function pu(d,e,t){let n=`CREATE TABLE \`${d}\` (
`;const r=[];return e.forEach((i,s)=>{const a=[];a.push(`  \`${i.name}\``),a.push(Hs(i)),i.nullable||a.push("NOT NULL"),i.defaultValue!==null&&i.defaultValue!==""&&a.push(`DEFAULT ${Gs(i.defaultValue,i.type)}`),i.isAutoIncrement&&a.push("AUTO_INCREMENT"),i.comment&&a.push(`COMMENT '${i.comment}'`),n+=a.join(" "),s<e.length-1&&(n+=`,
`),i.isPrimary&&r.push(i.name)}),r.length>0&&(n+=`,
  PRIMARY KEY (\`${r.join("`, `")}\`)`),n+=`
) ENGINE=${t.engine} DEFAULT CHARSET=${t.charset} COLLATE=${t.collation}`,t.comment&&(n+=` COMMENT='${t.comment}'`),n+=";",n}function du(d,e,t=[]){const n=[];n.push(`DROP TABLE IF EXISTS \`${d}_temp\`;`);let r=`CREATE TABLE \`${d}_temp\` (
`;const i=[];return e.forEach((s,a)=>{const o=[];o.push(`  \`${s.name}\``),o.push(Hs(s)),s.nullable||o.push("NOT NULL"),s.defaultValue!==null&&s.defaultValue!==""&&o.push(`DEFAULT ${Gs(s.defaultValue,s.type)}`),s.isAutoIncrement&&o.push("AUTO_INCREMENT"),s.comment&&o.push(`COMMENT '${s.comment}'`),r+=o.join(" "),a<e.length-1&&(r+=`,
`),s.isPrimary&&i.push(s.name)}),i.length>0&&(r+=`,
  PRIMARY KEY (\`${i.join("`, `")}\`)`),r+=`
);`,n.push(r),n.push(`INSERT INTO \`${d}_temp\` SELECT * FROM \`${d}\`;`),n.push(`DROP TABLE \`${d}\`;`),n.push(`RENAME TABLE \`${d}_temp\` TO \`${d}\`;`),n}function fu(d,e){const t=Object.keys(e),n=Object.values(e),r=t.map(s=>`\`${s}\``).join(", "),i=n.map(s=>Kt(s)).join(", ");return`INSERT INTO \`${d}\` (${r}) VALUES (${i});`}function mu(d,e,t){const n=Object.entries(e).map(([i,s])=>`\`${i}\` = ${Kt(s)}`).join(", "),r=Object.entries(t).map(([i,s])=>`\`${i}\` = ${Kt(s)}`).join(" AND ");return`UPDATE \`${d}\` SET ${n} WHERE ${r};`}function yu(d,e){const t=Object.entries(e).map(([n,r])=>`\`${n}\` = ${Kt(r)}`).join(" AND ");return`DELETE FROM \`${d}\` WHERE ${t};`}function Hs(d){let e=d.type.toUpperCase();return gu(d.type)&&d.length&&(e+=`(${d.length})`),e}function gu(d){return["varchar","char","decimal","float","double"].some(t=>d.startsWith(t))}function Gs(d,e){return d===""||d===null||d===void 0?"NULL":Eu(e)||["float","double","decimal"].includes(e)?d:`'${d.replace(/'/g,"''")}'`}function Kt(d){if(d==null)return"NULL";if(typeof d=="number"||typeof d=="boolean")return String(d);if(d instanceof Date)return`'${d.toISOString().slice(0,19).replace("T"," ")}'`;if(typeof d=="object"&&d!==null)try{return`'${JSON.stringify(d).replace(/'/g,"''")}'`}catch{return`'${String(d).replace(/'/g,"''")}'`}return`'${String(d).replace(/'/g,"''")}'`}function Eu(d){return["int","bigint","tinyint","smallint","mediumint"].includes(d)}export{Cu as handleDatabaseRoutes};
